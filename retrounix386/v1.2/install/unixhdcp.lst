Microsoft (R) Macro Assembler Version 6.14.8444		    07/20/22 01:12:18
unixhdcp.asm						     Page 1 - 1


				; ****************************************************************************
				; UNIXHDCP.ASM (File copy utility for Retro UNIX 386 v2 Hard Disk FS)
				; ----------------------------------------------------------------------------
				; Retro UNIX 386 v2.0 - Modified UNIX v7 inode model - 10/09/2019
				; Retro UNIX Operating System Project - Kernel v0.3 by ERDOGAN TAN 
				; ----------------------------------------------------------------------------
				; Retro UNIX 386 v1.1 - 14 byte file names (04/12/2015)
				;
				; RETRO UNIX 8086 (Retro Unix == Turkish Rational Unix)
				; Operating System Project (v0.1) by ERDOGAN TAN (Beginning: 11/07/2012) 
				; 1.44 MB Floppy Disk 
				; Bootable Unix (RUFS) File System - DOS & UNIX FS file export/import Utility
				; (08/12/2012)
				;
				; [ Last Modification: 20/07/2022 ] - Retro UNIX 386 v2 Bootable Hard Disk FS
				; (Previous Modification: 25/01/2020 - (bootable harddisk file system, RUFS))
				; UNIXCOPY.ASM -> Last Modification: 02/10/2019 (bootable floppy disk)
				;
				; Retro UNIX has been derived from UNIX Operating System (v1.0 for PDP-11) 
				; (Original) Source Code by Ken Thompson (1971-1972)
				; <Bell Laboratories (17/3/1972)>
				; <Preliminary Release of UNIX Implementation Document>
				;
				; ----------------------------------------------------------------------------
				; masm unixhdcp.asm unixhdcp.obj unixhdcp.lst
				; link /t unixhdcp
				; ****************************************************************************
				; 20/07/2022 - LBA ready (read/write) flag bugfix
				; 15/04/2022 - mkdir/rmdir link count bugfix
				; 28/03/2022 - Improved First Free Inode & First Free Block calculation
				; 27/03/2022 - Retro UNIX 386 v2 Hard Disk FS (Free Inode Count bugfix)
				; 23/03/2022 - Retro UNIX 386 v2 Hard Disk FS (BugFix) ((Retro UNIX 386 v1.2))
				; 25/01/2020 - Retro UNIX 386 v2 Hard Disk FS (unlink/rm,'free' proc bug)
				; 17/12/2019 - Retro UNIX 386 v2 Hard Disk FS (RUFS for 71h partitions)
				; 02/10/2019 - Retro UNIX 386 v2 UNIXCOPY utility for Retro UNIX Floppy Disks

				; Some new code of procedures, buffers (method) and structures (construction)
				; are copied from UNIXHDFS.ASM, 14/12/2019.

				; (Retro Unix File System) Hard Disk Boot Sector Parameters (03/10/2019)
				;
				;jmp short @f 	       ; db EBh, 13h ; db 0EBh, 18h ; 19/12/2019
				; 03/12/2019
				;bsFSystemID	equ 2  ; db 'RUFS'
				;bsVolumeSerial	equ 6  ; dd 0
				;		       ; db 'hd'
				;bsDriveNumber	equ 12 ; db 0
				;bsReserved	equ 13 ; db 0 ; 512 bytes per sector
				;bsSecPerTrack	equ 14 ; db 63 (17)
				;bsHeads	equ 15 ; db 16 (2,4,8,16,32,64,128,255)
				;bsTracks	equ 16 ; dw 1023 (1 to 1023) ; bsCylinders
				;bs_BF_I_number	equ 18 ; dw 0
				;bsMagic	equ 20 ; db '@'
				;bsPartitionID  equ 21 ; db 71h
				;bsHiddenSects  equ 22 ; dd 0 ; Hidden sectors (Boot Sector LBA)
				; @@:	 

				; 04/12/2019
 001A				RUFS struc
 0000  0000			bsJumpCode     dw ? ; 0EBh,18h ; jmp short @f  	
 0002  0004 [			bsFSystemID    db 4 dup(?) ;'RUFS'
        00
       ]
 0006  00000000			bsVolumeSerial dd ?
 000A  0000			bsDriveID      dw ? ; 'hd'
 000C  00			bsDriveNumber  db ? ; 80h
 000D  00			bsReserved     db ? ; 0 = 512 bytes/sector CHS, 1 = LBA
 000E  00			bsSecPerTrack  db ? ; 63,17
 000F  00			bsHeads        db ? ; 8 to 255 (may be 2 to 255) 
 0010  0000			bsCylinders    dw ? ; 1 to 1024 (bsTracks)
 0012  0000			bs_BF_I_number dw 0 ; startup (boot) file inode number
 0014  00			bsMagic        db ? ; '@' ; magic byte !
 0015  00			bsPartitionID  db ? ; 71h, Retro UNIX 386 partition/volume ; 19/12/2019
 0016  00000000			bsHiddenSects  dd 0 ; Hidden sectors (Boot Sector LBA) ; 19/12/2019
				;;@@:
				RUFS ends

				; 14/01/2020 - Super Block modification :
				;	     - Extended sections/divisions (consequental sectors)
				;	     - (for swapping, configuration, boot space etc.)	
				; 21/12/2019
				; 19/12/2019 (UNIXHDFS.COM, RUFSHDI.ASM)
				; 01/09/2019 - Retro UNIX 386 v2 SuperBlock

 0200				SuperBlock struc

 0000  00000000			sb_Header	dd ?
 0004  00000000			sb_BootSectAddr dd ?  ; Hidden Sectors
 0008  00000000			sb_VolumeSize	dd ?  ; Entire Volume/Partition Size (includes ext. volume)	
 000C  00000000			sb_Version	dd ?
 0010  00000000			sb_BlockSize	dd ?
 0014  00000000			sb_InodeCount	dd ? 	
 0018  00000000			sb_FreeMapAddr	dd ?
 001C  00000000			sb_FreeMapSize  dd ?
 0020  00000000			sb_InodeMapAddr	dd ?
 0024  00000000			sb_InodeMapSize dd ?
 0028  00000000			sb_InodeTblAddr dd ?
 002C  00000000			sb_InodeTblSize dd ?
 0030  00000000			sb_FreeInodes	dd ?
 0034  00000000			sb_FirstFreeIno dd ?
 0038  00000000			sb_FreeBlocks	dd ?
 003C  00000000			sb_FirstFreeBlk dd ?
 0040  0013 [			sb_BootSecParms db 19 dup(?) ; v1 ; 19/12/2019
        00
       ]
 0053  0005 [			sb_BSExtension	db 5 dup(?) ; v2 HDFS ; 19/12/2019
        00
       ]
 0058  00000000			sb_Status	dd ? ; 19/12/2019
 005C  00000000			sb_ModifTime	dd ?
 0060  00000000			sb_ExtdVolTbl	dd 0 ; 14/01/2020 ; Extended Volume Start/Table Address
 0064  00000000			sb_ExtdVolSize	dd 0 ; 14/01/2020 ; Extended Volume (swap section etc.) Size	
 0068  00			sb_LBA_rw	db 0 ; 03/10/2019
 0069  00			sb_ClusterSize	db 0 ; 03/10/2019
 006A  00			sb_ReadOnly	db 0 ; 03/10/2019
 006B  00			sb_Mounted	db 0 ; 03/10/2019
 006C  00000000			sb_MountInode	dd 0 ; 03/10/2019
 0070  00			sb_DevMajor db 0 ; 03/10/2019
 0071  00			sb_DevMinor db 0 ; 03/10/2019
 0072  00			sb_LongName	db 0 ; 03/10/2019
 0073  00			sb_Direntry32	db 0 ; 03/10/2019
 0074  0188 [			sb_Reserved	db 508-116 dup(?) ; Must be 0 for current RUFS version
        00
       ]
 01FC  00000000			sb_Footer	dd ?

				SuperBlock ends

				; 14/01/2020
 = sb_BootSecAddr		sb_HiddenSects equ sb_BootSecAddr
 = sb_VolumeSize		sb_TotalSects  equ sb_VolumeSize

				; 14/01/2020
				; 'Hidden Sectors' value in super block is 'sb_BootSectAddr'.	 	
				; (Absolute start address of the RUNIX partition and boot sector)
				; Note: 'systm.sb_HiddenSect' area (in SB) has been changed to
				; 	'systm.ExtdVolTbl' -it will not be used for now-
				;	 and 'systm.sb_TotalSects' are has been changed to
				;	'systm.sb_ExtdVolSize' -it wil not be used for now-

				; *****************

				; UNIX v1 I-node Flags: 
				; 1000000000000000b 	i-node is allocated (8000h)
				; 0100000000000000b	directory (4000h)
				; 0010000000000000b	file has been modified (2000h)	 	
				; 0001000000000000b	large file (1000h)
				; 0000000000100000b	set user id on execution (20h)
				; 0000000000010000b	executable (10h)
				; 0000000000001000b	read, owner (8)
				; 0000000000000100b	write, owner (4)
				; 0000000000000010b	read, non-owner (2)
				; 0000000000000001b	write, non-owner (1)

				; UNIX v7 I-node Flags: 
				; 1000000000000000b 	IFREG - regular file (8000h)
				; 0100000000000000b	IFDIR - directory (4000h)
				; 0010000000000000b	IFCHR - character special (2000h)
				; 0001000000000000b	reserved (1000h)
				; 0000100000000000b	ISUID - set user id on exec (800h)	 	
				; 0000010000000000b	ISGID - set group id on exec (400h)
				; 0000001000000000b	ISVTX - save swapped text (200h)
				; 0000000100000000b	IREAD - read, owner (100h)
				; 0000000010000000b	IWRITE - write,owner (80h)
				; 0000000001000000b	IEXEC - execute, owner (40h)
				; 0000000000100000b	read, group (20h)
				; 0000000000010000b	write, group (10h)
				; 0000000000001000b	execute, group (08h)
				; 0000000000000100b	read, others (04h)
				; 0000000000000010b	write, others (02h)
				; 0000000000000001b	execute, others (01h)

				; UNIX SysV I-node Flags: (di_mode)
				; 1000000000000000b 	IFREG - regular file (8000h)
				; 0100000000000000b	IFDIR - directory (4000h)
				; 0010000000000000b	IFCHR - character special (2000h)
				; 0001000000000000b	IFIFO - fifo special (1000h)
				; 0000100000000000b	ISUID - set user id on exec (800h)	 	
				; 0000010000000000b	ISGID - set group id on exec (400h)
				; 0000001000000000b	ISVTX - save swapped text (200h)
				; 0000000100000000b	IREAD - read, owner (100h)
				; 0000000010000000b	IWRITE - write,owner (80h)
				; 0000000001000000b	IEXEC - execute, owner (40h)
				; 0000000000100000b	read, group (20h)
				; 0000000000010000b	write, group (10h)
				; 0000000000001000b	execute, group (08h)
				; 0000000000000100b	read, others (04h)
				; 0000000000000010b	write, others (02h)
				; 0000000000000001b	execute, others (01h)

				; IFREG	equ 8000h	; /* regular */
				; IFMPB	equ 7000h	; /* multiplexed block special */
				; IFBLK	equ 6000h	; /* block special */
				; IFNAM	equ 5000h	; /* special named file - subtype in r_dev *
				; IFDIR	equ 4000h	; /* directory */
				; IFMPC	equ 3000h	; /* multiplexed char special */
				; IFCHR	equ 2000h	; /* character special */
				; IFIFO	equ 1000h	; /* fifo special */
				; ISUID	equ 0800h	; /* set user id on execution */
				; ISGID	equ 0400h	; /* set group id on execution */
				; ISVTX	equ 0200h	; /* save swapped text even after use */
				; IREAD equ 0100h	; /* read permission */
				; IWRITE equ 0080h	; /* write permission */
				; IEXEC	equ 0040h	; /* execute permission */

				; Retro UNIX 386 v2 I-node Flags: (di_mode) ;; FIRST DRAFT - 01/09/2019
				; 1000000000000000b 	IFREG - regular file (8000h)
				; 0100000000000000b	IFDIR - directory (4000h)
				; 0010000000000000b	IFCHR - character special (2000h)
				; 0001000000000000b	IFIFO - fifo special (1000h)
				; 0000100000000000b	ISUID - set user id on exec (800h)	 	
				; 0000010000000000b	ISGID - set group id on exec (400h)
				; 0000001000000000b	IEXTD - use extents (200h)
				; 0000000100000000b	IREAD - read, owner (100h)
				; 0000000010000000b	IWRITE - write,owner (80h)
				; 0000000001000000b	IEXEC - execute, owner (40h)
				; 0000000000100000b	read, group (20h)
				; 0000000000010000b	write, group (10h)
				; 0000000000001000b	execute, group (08h)
				; 0000000000000100b	read, others (04hq	)
				; 0000000000000010b	write, others (02h)
				; 0000000000000001b	execute, others (01h)

				;; SECOND DRAFT - 03/09/2019

				; Retro UNIX 386 v2 I-node Flags: (di_mode) for files
				; 1000000000000000b 	IFREG - 1 = regular file (8000h)
				; 0100000000000000b	IFDIR - 1 = directory (4000h)
				; 0010000000000000b	ISIZ2 - sizing higher bit (2000h)
				; 0001000000000000b	ISIZ1 - sizing lower bit (1000h)
				; 0000100000000000b	ISUID - set user id on exec (800h)	 	
				; 0000010000000000b	ISGID - set group id on exec (400h)
				; 0000001000000000b	IEXTT - 1 = use extents (200h)
				; 0000000100000000b	IREAD - read, owner (100h)
				; 0000000010000000b	IWRITE - write,owner (80h)
				; 0000000001000000b	IEXEC - execute, owner (40h)
				; 0000000000100000b	read, group (20h)
				; 0000000000010000b	write, group (10h)
				; 0000000000001000b	execute, group (08h)
				; 0000000000000100b	read, others (04h)
				; 0000000000000010b	write, others (02h)
				; 0000000000000001b	execute, others (01h)

				;; THIRD DRAFT - 15/09/2019
				; 18/12/2019 - Mounted flag - IFMNT (2000h)

				; Retro UNIX 386 v2 I-node Flags: (di_mode) for files
				; 1000000000000000b 	IFREG - 1 = regular file (8000h)
				; 0100000000000000b	IFDIR - 1 = directory (4000h)
				; 0010000000000000b	IRSVD - 0 = reserved bit (2000h) ; Mounted flag
				; 0001000000000000b	ILARG - Large file addressing bit (1000h)
				; 0000100000000000b	ISUID - set user id on exec (800h)
				; 0000010000000000b	ISGID - set group id on exec (400h)
				; 0000001000000000b	IEXTT - 1 = use extents (200h)
				; 0000000100000000b	IREAD - read, owner (100h)
				; 0000000010000000b	IWRITE - write, owner (80h)
				; 0000000001000000b	IEXEC - execute, owner (40h)
				; 0000000000100000b	read, group (20h)
				; 0000000000010000b	write, group (10h)
				; 0000000000001000b	execute, group (08h)
				; 0000000000000100b	read, others (04h)
				; 0000000000000010b	write, others (02h)
				; 0000000000000001b	execute, others (01h)

				; Retro UNIX 386 v2 I-node Flags: (di_mode) for devices
				; 1000000000000000b 	IFREG - 0 = device file (8000h)
				; 0100000000000000b	IFBLK - 1 = block device (4000h)
				; 0010000000000000b	IFCHR - character special (2000h) -always 1-
				; 0001000000000000b	IFIFO - fifo special (1000h)
				; 0000100000000000b	ISUID - set user id on exec (800h)	 	
				; 0000010000000000b	ISGID - set group id on exec (400h)
				; 0000001000000000b	IEXTR - 1 = external device driver (200h)
				; 0000000100000000b	IREAD - read, owner (100h)
				; 0000000010000000b	IWRITE - write, owner (80h)
				; 0000000001000000b	IEXEC - execute, owner (40h) 
				; 0000000000100000b	read, group (20h)
				; 0000000000010000b	write, group (10h)
				; 0000000000001000b	execute, group (08h)
				; 0000000000000100b	read, others (04h)
				; 0000000000000010b	write, others (02h)
				; 0000000000000001b	execute, others (01h)

				; 15/09/2019
				; Flag bit 12 is 0 for small file addressing
				; ------------------------------------------
				; Disk Block Pointers
				;
				; di_addr[0] = direct block 0 address
				; di_addr[4] = direct block 1 address
				; di_addr[8] = direct block 2 address
				; di_addr[12] = direct block 3 address
				; di_addr[16] = direct block 4 address
				; di_addr[20] = direct block 5 address
				; di_addr[24] = direct block 6 address
				; di_addr[28] = direct block 7 address
				; di_addr[32] = direct block 8 address
				; di_addr[36] = direct block 9 address

				; Flag bit 12 is 1 for large file addressing
				; ------------------------------------------
				; Disk Block Pointers
				;
				; di_addr[0] = indirect block 0 address
				; di_addr[4] = indirect block 1 address
				; di_addr[8] = indirect block 2 address
				; di_addr[12] = indirect block 3 address
				; di_addr[16] = indirect block 4 address
; di_addr[20] = indirect block 5 address
				; di_addr[24] = indirect block 6 address
				; di_addr[28] = indirect block 7 address
				; di_addr[32] = double indirect block (0) address
				; di_addr[36] = triple indirect block (0) address

				; 15/09/2019
				; Flag bit 8 (if it is set)
				; -----------------------------------
				; Use extents (contiguous blocks)
				;
				; di_addr[0] = extent 0 start address (or indirect 0)
				; di_addr[4] = extent 0 block count (or indirect 0 bc)
				; di_addr[8] = extent 1 start address (or indirect 1)
				; di_addr[12] = extent 1 block count (or indirect 1 bc)
				; di_addr[16] = extent 2 start address (or indirect 2)
				; di_addr[20] = extent 2 block count (or indirect 2 bc)
				; di_addr[24] = extent 3 start address (or double indirect)
				; di_addr[28] = extent 3 block count (or double indirect bc)
				; di_addr[32] = extent 4 start address (or triple indirect)
				; di_addr[36] = extent 4 block count (or triple indirect bc)

				; UNIX v7 I-node (on disk) : 
				;
				;struc dinode
				;  .di_mode:  resw 1	; /* mode and type of file */
				;  .di_nlink: resw 1	; /* number of links to file */
				;  .di_uid:   resw 1 	; /* owner's user id */
				;  .di_gid:   resw 1	; /* owner's group id */
				;  .dinode_size: resd 1 ; /* number of bytes in file */
				;  .di_addr:  resb 40 ; (3*13)+1 ; /* disk block addresses */
				;  .di_atime: resd 1	; /* time last accessed */
				;  .di_mtime: resd 1	; /* time last modified */
				;  .di_ctime: resd 1	; /* time created */
				;endstruc

				; (first draft)
				; Retro UNIX 386 v2 I-node (on disk) : 
				;
				;struc dinode
				;  .di_mode:  resw 1	; /* mode and type of file */
				;  .di_nlink: resw 1	; /* number of links to file */
				;  .di_uid:   resw 1	; /* owner's user id */
				;  .di_gid:   resw 1	; /* owner's group id */
				;  .dinode_size:   resd 1 ; /* number of bytes in file */
				;  .dinode_size_h: resw 1 ; /* number of bytes in file */
				;  .di_cssc: resb 1	; Cluster/Block size shift count - 1 ; 04/09/2019	
				;  .di_bssc: resb 1	; Block/Sector size shift count - 1 ; 04/09/2019	
				;  .di_addr:  resd 8 ; resb 32 ; /* disk block addresses */
				;  .di_atime: resd 1	; /* time last accessed */
				;  .di_mtime: resd 1	; /* time last modified */
				;  .di_ctime: resd 1	; /* time created */
				;  .di_reserved2: resd 1 ; reserved (zero)
				;endstruc

				; 17/12/2019
				; 15/09/2019 (second draft)
				; Retro UNIX 386 v2 I-node (on disk) : 

				;struc dinode
				;  .di_mode:  resw 1	; /* mode and type of file */
				;  .di_nlink: resw 1	; /* number of links to file */
				;  .di_uid:   resw 1	; /* owner's user id */  - 0 to 655535 -
				;  .di_gid:   resb 1	; /* owner's group id */ - o to 255 -
				;  .dinode_size_h: resb 1 ; /* number of bytes in file */ ; - byte 5 -
				;  .dinode_size:   resd 1 ; /* number of bytes in file */
				;  .di_addr:  resd 10 ; resb 40 ; /* disk block addresses */
				;  .di_atime: resd 1	; /* time last accessed */
				;  .di_mtime: resd 1	; /* time last modified */
				;  .di_ctime: resd 1	; /* time created */
				;endstruc

				; 24/12/2019
				; 17/12/2019
 0040				dinode struc
 0000  0000			  di_mode    dw 0	; /* mode and type of file */
 0002  0000			  di_nlink   dw 0	; /* number of links to file */
 0004  0000			  di_uid     dw 0	; /* owner's user id */  - 0 to 655535 -
 0006  00			  di_gid     db 0	; /* owner's group id */ - o to 255 -
 0007  00			  dinode_size_h db 0	; /* number of bytes in file */ ; - byte 5 -
 0008  00000000			  dinode_size   dd 0	; /* number of bytes in file */
 000C  000A [			  di_addr    dd 10 dup(0) ; db 40 dup(0) ; /* disk block addresses */
        00000000
       ]
 0034  00000000			  di_atime   dd 0	; /* time last accessed */
 0038  00000000			  di_mtime   dd 0	; /* time last modified */
 003C  00000000			  di_ctime   dd 0	; /* time created */
				dinode ends

				; 04/09/2019 - Retro UNIX 386 v2

				;BLOCK SIZE SHIFT COUNTS or STORAGE/DISK (SECTor SIZE) TYPE
				;----------------------------------------------------------
				;0 = 512 bytes per sector floppy drive or hard disk
				;1 = 1024 bytes per sector, tape drive
				;2 = 2048 bytes per sector DVD, CDROM, new (2TB) hard disks

				;CLUSTER SIZE SHIFT COUNTS or FILE SYSTEM BLOCK SIZE
				;----------------------------------------------------------
				;0 = 1 block (1 sector)
				;1 = 2 blocks
				;2 = 4 blocks
				;3 = 8 blocks
				;4 = 16 blocks
				;5 = 32 blocks
				;6 = 64 blocks
				;7 = 128 blocks
				;8 = 256 blocks

				;SIZING LIMITS (as CLUSTER/BLOCK size) - cluster size = 1
				;----------------------------------------------------------
				; small - direct block addresses - 10 blocks (5120 bytes) 
				; normal - indirect block addresses - 8*128 blocks (512KB) 
				; large - double indirect blocks - 128*128 blks + norm (8MB+512KB)
				; huge - triple indirect blocks - 128*128*128 blks (1GB+8MB+512KB)

				;SIZING LIMITS (as CLUSTER/BLOCK size) - cluster size = 8
				;----------------------------------------------------------
				; small - direct block addresses - 10*8 blocks (40960 bytes)  
				; normal - indirect block addresses - 8*1024 blocks (4MB) 
				; large - double indirect blocks - 1024*1024 blks + norm (512MB+4MB)
				; huge - triple indirect blocks - 1024*1024*1024 blks (512GB+516MB)

				;15/09/2019
				;NOTE: Addresses are in sector unit (512 bytes or 2048 bytes).
				;      But, block (cluster) size is 1 or 8 sectors, default is 1 sector 	
				;      (Cluster size for 2048 bytes/sector disks may be 2,4,8 sectors)
				 
				;DISK ADDR AND FILE SIZE LIMITS For EXTENTS !!! LIMITS !!!
				;----------------------------------------------------------
				; (depending on free contiguous blocks/sectors on disk fs)
				; direct - 5 extents - 2 terabytes (avr. 400GB per extent)  
				; indirect - 3*64 extents - 2TB (average 10GB per extent)
				; double ind. - 64*64 extents - 2TB (avr. 512MB per ext.)
				; triple ind. - 262144 extents - 2TB (avr. 8MB per extent)

				; EXTENT SIZING For 8GB FILE !!! SAMPLE !!!
				;----------------------------------------------------------
				; direct - 5 extents - 8GB (average 1.6GB per extent)  
				; indirect - 192 extents - 8GB (average 42.7MB per extent)
				; double ind. - 4288 extents - 8GB (avr. 1.9MB per extent)
				; triple ind. - 266432 extents - 8GB (avr. 31.5KB per extent)

				; ***************************

				;ROOT_DIR_INODE_NUMBER equ 41
 = 0001				ROOT_DIR_INODE_NUMBER equ 1 ; Retro UNIX 386 v2 - 18/09/2019

				; DTA (PSP+80h= Offset 128)
 = 0095				DTA_Attrib equ 149 ; PDP+21 ;05/01/2013	
 = 0096				DTA_Time equ 150 ; PSP+22
 = 0098				DTA_Date equ 152 ; PSP 24
 = 009A				DTA_FileSize equ 154 ; PSP + 26
 = 009E				DTA_FileName equ 158 ; PSP + 30

				;err_INVALIDDATA equ 100h
				;err_NOFREEBLOCK equ 200h

				;;i_flags    equ 001Eh  ; Retro UNIX v1 (00011110b)
				;i_flags     equ 01EDh  ; Retro UNIX v2 (0000000111101101b)	

				.8086

 0000				UNIXCOPY  SEGMENT PUBLIC 'CODE'
					assume cs:UNIXCOPY,ds:UNIXCOPY,es:UNIXCOPY,ss:UNIXCOPY

					org 100h

 0100				START_CODE:

 0100				proc_start  proc near
					; 23/01/2020
					; 01/01/2020
					; 17/12/2019 - Retro UNIX 386 v2 (RUFS for hard disks)
					;
					; 08/12/2012 (UNIXCOPY)
					;
					; 30/11/2012 (UNIXBOOT)
					;
 0100  BB 4EB0 R			mov	bx, SizeOfFile+100
 0103  83 C3 0F				add	bx, 15
 0106  D1 EB				shr	bx, 1
 0108  D1 EB				shr	bx, 1
 010A  D1 EB				shr	bx, 1
 010C  D1 EB				shr	bx, 1
 010E  B4 4A				mov	ah, 4Ah ; modify memory allocation
				        ;push	cs
				        ;pop	es
 0110  CD 21				int	21h 
						  
				;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
				; see if drive specified
				;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
				              
 0112  BE 0080				mov	si, offset 80h             ; PSP command tail
 0115  AC				lodsb
 0116  8A C8				mov	cl, al
 0118  0A C9				or	cl, cl
 011A  75 04				jnz	short loc_get_args
 011C  FE C9				dec	cl
 011E  EB 5F				jmp	short loc_hd_copy_7 ; loc_unix_welcome ; 24/12/2019         
 0120				loc_get_args:
 0120  AC				lodsb
 0121  3C 20				cmp	al, ' '	      
 0123  75 02				jne	short loc_hd_copy_1

					;dec	cl		  
					;jz	short loc_unix_welcome

 0125  EB F9				jmp	short loc_get_args

 0127				loc_hd_copy_1:
 0127  3C 2D				cmp	al, '-'
 0129  75 02				jne	short loc_hd_copy_2
 012B  EB 59				jmp	check_hdi_option
					
 012D				loc_hd_copy_2:
 012D  3C 68				cmp	al, 'h'
 012F  75 17				jne	short loc_hd_copy_3
					;inc	si
					;mov	al, byte ptr [si]
 0131  AC				lodsb
 0132  3C 64				cmp	al, 'd'
 0134  75 49				jne	short loc_hd_copy_7
					;inc	si
					;mov	ax, word ptr [si]
 0136  AD				lodsw
 0137  3C 30				cmp	al, '0'	            
 0139  72 44				jb	short loc_hd_copy_7
 013B  3C 33				cmp	al, '3'
 013D  77 40				ja	short loc_hd_copy_7
 013F  80 FC 20				cmp	ah, 20h
 0142  77 3B				ja	short loc_hd_copy_7
					;mov	byte ptr [RUFS_DRIVE], al
 0144  2C 30				sub	al, '0'
 0146  EB 1F				jmp	short loc_hd_copy_5
 0148				loc_hd_copy_3:
					; 23/01/2020
 0148  80 3C 3A				cmp	byte ptr [si], ':'		; C:, D:, E:, F:
 014B  75 32				jne	short loc_hd_copy_7
 014D  46				inc	si
 014E  80 3C 20				cmp	byte ptr [si],20h
 0151  77 2C				ja	short loc_hd_copy_7
					
 0153  3C 43				cmp	al, 'C'
 0155  72 28				jb	short loc_hd_copy_7
 0157  3C 46				cmp	al, 'F'	             ; A - Z
 0159  76 0A				jna	short loc_hd_copy_4	    
 015B  3C 63				cmp	al, 'c'	             ; a - z 
 015D  72 20				jb	short loc_hd_copy_7	 
 015F  3C 66				cmp	al, 'f'	           
 0161  77 1C				ja	short loc_hd_copy_7	 

 0163  2C 20				sub	al, 'a'-'A'	         ; to upper case
 0165				loc_hd_copy_4:
					;mov	byte ptr [RUFS_DRIVE], al
 0165  2C 43				sub	al, 'C'	             ; make it zero based 
 0167				loc_hd_copy_5:
 0167  04 80				add	al, 80h
 0169  8A D0				mov	dl, al
					; 01/01/2020
					;mov	byte ptr [buff_d], al
					;mov	byte ptr [PhysicalDriveNumber], al
 016B  A2 3A45 R			mov	byte ptr [Drive], al

					; Read masterboot sector to understand drive is ready or not?
 016E  E8 0398				call	drive_check
					; (we will not return here if cf = 1)
					; If cf = 0, we will return here

					;mov	dl, byte ptr [buff_d]
					; 01/01/2020
					;mov	dl, byte ptr [PhysicalDriveNumber]

 0171  B4 08				mov	ah, 08h
 0173  CD 13				int	13h	; return disk parameters
 0175  0E				push	cs
 0176  07				pop	es	; restore es
 0177  72 47				jc	short loc_hd_copy_6

 0179  E8 01C5				call	set_hd_parms

					; 17/12/2019
 017C  E9 0120				jmp	loc_hd_copy_9

 017F				loc_hd_copy_7:
					; 24/12/2019
 017F  EB 6A				jmp	loc_unix_welcome

 0181				runix_partition_error:
					; 24/12/2019
 0181  BE 2E03 R			mov	si, offset msg_inv_partition
 0184  EB 4C				jmp	short @f

 0186				check_hdi_option:
 0186  AC				lodsb
 0187  3C 69				cmp	al, 'i'
 0189  75 F4				jne	short loc_hd_copy_7
 018B  FE C9				dec	cl
 018D  74 F0				jz	short loc_hd_copy_7
 018F  AC				lodsb
 0190  3C 20				cmp	al, ' '
 0192  75 EB				jne	short loc_hd_copy_7
 0194  FE C9				dec	cl
 0196  74 E7				jz	short loc_hd_copy_7
 0198				check_hdi_opt_loop:
 0198  AC				lodsb
 0199  3C 20				cmp	al, 20h
 019B  77 08				ja	short get_hdi_name
 019D  72 E0				jb	short loc_hd_copy_7
 019F  FE C9				dec	cl
 01A1  74 DC				jz	short loc_hd_copy_7
 01A3  EB F3				jmp	short check_hdi_opt_loop

 01A5				get_hdi_name:
 01A5  BF 3014 R			mov	di, offset img_file_name
 01A8				get_hdi_name_nxt_chr:
 01A8  AA				stosb
 01A9  FE C9				dec	cl
 01AB  74 0E				jz	short get_hdi_name_ok	
 01AD  AC				lodsb
 01AE  3C 20				cmp	al, 20h
 01B0  76 09				jna	short get_hdi_name_ok	
 01B2  81 FF 3020 R			cmp	di, offset img_file_name + 12	
 01B6  72 F0				jb	short get_hdi_name_nxt_chr

 01B8  E9 00DA				jmp	invalid_file_name

 01BB				get_hdi_name_ok:
 01BB  2A C0				sub	al, al
 01BD  AA				stosb 

					; 03/10/2019	
 01BE  EB 36				jmp	short cap_file_name
					
 01C0				loc_hd_copy_6: 
 01C0  A0 3A56 R			mov	al, byte ptr [Error]
 01C3  E8 032D				call	proc_hex
 01C6  A3 2EF2 R			mov	word ptr [str_Err], ax
 01C9  BE 2EC8 R			mov	si, offset Msg_Disk_RW_Error
 01CC  E8 0315				call	PRINT_MSG
 01CF  BE 2EE6 R			mov	si, Offset Msg_Error_Number
 01D2				@@:
 01D2  E8 030F				call	PRINT_MSG

 01D5				close_file_then_terminate:	
 01D5  8B 1E 3022 R			mov	bx, word ptr [img_file_handle]
 01D9  23 DB				and	bx, bx
 01DB  74 04				jz	short terminate
 01DD				close_img_file:
 01DD  B4 3E				mov	ah, 3Eh ; close (floppy disk image) file
 01DF  CD 21				int	21h	 
 01E1				terminate:
 01E1  BE 2EE3 R			mov	si, offset UNIX_CRLF
 01E4				loc_hd_copy_8:
 01E4  E8 02FD				call	PRINT_MSG

 01E7  CD 20				int	20h

 01E9				infinive_loop:
 01E9  EB FE				jmp	short infinive_loop

 01EB				loc_unix_welcome:
					; 24/12/2019
 01EB  BE 2A86 R			mov	si, offset UNIX_Welcome
 01EE  E8 02F3				call	PRINT_MSG
					
 01F1  BE 2B1F R			mov	si, offset usage
 01F4  EB EE				jmp	short loc_hd_copy_8

 01F6				cap_file_name:
					; file name capitalization
 01F6  BE 3014 R			mov	si, offset img_file_name
 01F9  8B FE				mov	di, si
 01FB  8B DE				mov	bx, si
 01FD				cap_file_name0:
 01FD  AC				lodsb
 01FE  3C 61				cmp	al, 'a'
 0200  73 0D				jnb	short cap_file_name2
 0202  22 C0				and	al, al
 0204  74 12				jz	short cap_file_name3
 0206  3C 2E				cmp	al, '.'
 0208  75 02				jne	short cap_file_name1
 020A  8B DF				mov	bx, di ; dot position	
 020C				cap_file_name1:
					;stosd
 020C  47				inc	di ; 06/09/2019
 020D  EB EE				jmp	short cap_file_name0 
 020F				cap_file_name2:
 020F  3C 7A				cmp	al, 'z'
 0211  77 F9				ja	short cap_file_name1
 0213  24 DF				and	al, 0DFh ; NOT 32
 0215  AA				stosb
 0216  EB E5				jmp	short cap_file_name0
 0218				cap_file_name3:
 0218  88 05				mov	[di], al
 021A  4F				dec	di
 021B  3B DF				cmp	bx, di
 021D  73 76				jnb	short invalid_file_name
 021F  2B FB				sub	di, bx
 0221  81 EB 3014 R			sub	bx, offset img_file_name
 0225  83 FF 03				cmp	di, 3
 0228  76 0B				jna	short cap_file_name4
 022A  23 DB				and	bx, bx
 022C  75 67				jnz	short invalid_file_name
 022E  EB 0A				jmp	short open_image_file ; 03/10/2019	

 0230				file_error:
 0230  BE 2A75 R			mov	si, offset file_error_msg
 0233				jump_back: ; 24/12/2019
 0233  EB 9D				jmp	short @b

 0235				cap_file_name4:
 0235  83 FB 08				cmp	bx, 8
 0238  77 5B				ja	short invalid_file_name

					; 03/10/2019
 023A				open_image_file:
					; 05/09/2019 - Retro UNIX 386 v2
					; 07/07/2015 (UNIXCOPY.ASM)
 023A  BA 3014 R			mov	dx, offset img_file_name
 023D  B9 003F				mov	cx, 3Fh ; File Attributes
					;xor	cx, cx ; 06/09/2019
 0240  B4 4E				mov	ah, 4Eh ; MS DOs Function = Find First File
 0242  CD 21				int	21h
 0244  72 45				jc	short file_not_found_error

				;; DTA (PSP+80h= Offset 128)
				;DTA_Attrib equ 149 ; PDP+21 ;05/01/2013	
				;DTA_Time equ 150 ; PSP+22
				;DTA_Date equ 152 ; PSP 24
				;DTA_FileSize equ 154 ; PSP + 26
				;DTA_FileName equ 158 ; PSP + 30

 0246				chk_image_file_features:
 0246  BE 0095				mov	si, DTA_Attrib
 0249  8A 04				mov	al, byte ptr [si]
 024B  24 1F				and	al, 1Fh ; directory, volume label, system, hidden, read only
 024D  75 41				jnz	short file_attr_error       
 024F  BE 009A				mov	si, DTA_FileSize
					; 03/10/2019
 0252  AD				lodsw
 0253  8B D0				mov	dx, ax
 0255  AD				lodsw
 0256  92				xchg	ax, dx

					; 23/12/2019
 0257  A9 01FF				test	ax, 511
 025A  75 2A				jnz	short invalid_image_file
						 ; end of file is not on sector boundary!

 025C  A3 3A96 R			mov	word ptr [file_size], ax
 025F  89 16 3A98 R			mov	word ptr [file_size+2], dx

 0263  B0 02				mov	al, 2 ; open for reading and writing
 0265  BA 3014 R			mov	dx, offset img_file_name
 0268  B4 3D				mov	ah, 3Dh ; open file
 026A  CD 21				int	21h
 026C  72 1D				jc	short file_not_found_error

 026E  A3 3022 R			mov	word ptr [img_file_handle], ax

 0271  B4 3F				mov	ah, 3Fh ; read file
 0273  8B 1E 3022 R			mov	bx, word ptr [img_file_handle]
 0277  B9 0200				mov	cx, 512
 027A  BA 3EB0 R			mov	dx, offset Buffer
 027D  CD 21				int	21h
 027F  72 AF				jc	short file_error

 0281  E8 0148				call	check_hd_image_size
 0284  73 14				jnc	short valid_hd_image

 0286				invalid_image_file:
 0286  BE 2DA9 R			mov	si, offset msg_inv_image_file
					;jmp	short @b
 0289  EB A8				jmp	short jump_back ; 24/12/2019
 028B				file_not_found_error:
 028B  BE 2D6D R			mov	si, offset msg_file_not_found
					;jmp	short @b
 028E  EB A3				jmp	short jump_back ; 24/12/2019
 0290				file_attr_error:
 0290  BE 2D0F R			mov	si, offset msg_file_attr_error
					;jmp	short @b
 0293  EB 9E				jmp	short jump_back ; 24/12/2019
 0295				invalid_file_name:
 0295  BE 2CCC R			mov	si, offset msg_inv_file_name
					;jmp	short @b
 0298  EB 99				jmp	short jump_back ; 24/12/2019

 029A				valid_hd_image:
					; 23/12/2019
					; 06/09/2019
					; set (buffer) disk drive number for image file
					;mov	byte ptr [buff_d], 90h ; floppy disk image sign
					; 03/12/2019
 029A  C6 06 3A45 R 90			mov	byte ptr [Drive], 90h ; hard disk image sign
					; 01/01/2020
					;mov	byte ptr [PhysicalDriveNumber], 90h

					; 17/12/2019
					;jmp	short loc_hd_copy_9
 029F				loc_hd_copy_9:
					; 17/12/2019
					
 029F  E8 00BE				call	get_runix_partition
					;jc	runix_partition_error ; 24/12/2019
					; 27/03/2022
 02A2  73 03				jnc	short loc_hd_copy_12
 02A4  E9 FEDA				jmp	runix_partition_error
 02A7				loc_hd_copy_12:
					; 30/12/2019
					;mov	ax, word ptr [hidden_sectors] ; = start sector
					;mov	dx, word ptr [hidden_sectors+2] ; = start sector + 2
					;mov	word ptr [systm.sb_HiddenSects], ax
					;mov	word ptr [systm.sb_HiddenSects+2], dx
					; 14/01/2020
					; mov	word ptr [systm.sb_BootSectAddr], ax
					; mov	word ptr [systm.sb_BootSectAddr+2], dx 

					; read runix (RUFS) boot sector
 02A7  33 C0				xor	ax, ax
 02A9  33 D2				xor	dx, dx	
					; dx:ax = 0 = boot sector address (in runix partition)
 02AB  BB 3AB0 R			mov	bx, offset boot_sector ; offset BSBUFFER
 02AE  E8 1A1C				call	dskrd
					;jc	loc_hd_copy_6  ; Drive not ready or read error
						  	       ; or Disk r/w error
					; 27/03/2022
 02B1  72 28				jc	short loc_hd_copy_err

					; 25/12/2019
					; check runix fs boot sector is valid or not!
 02B3  81 3E 3AB2 R 5552		cmp	word ptr [boot_sector.bsFSystemID], 'UR'  ; 'RUFS'
 02B9  75 42				jne	short loc_hd_copy_10 ; Not a valid RUFS	
 02BB  81 3E 3AB4 R 5346		cmp	word ptr [boot_sector.bsFSystemID+2], 'SF'
 02C1  75 3A				jne	short loc_hd_copy_10
 02C3  81 3E 3ABA R 6468		cmp	word ptr [boot_sector.bsDriveID], 'dh' ; 'hd'
 02C9  75 32				jne	short loc_hd_copy_10		
 02CB  80 3E 3AC4 R 40			cmp	byte ptr [boot_sector.bsMagic], '@' ; ! magic byte !
 02D0  75 2B				jne	short loc_hd_copy_10
					;cmp	byte ptr [boot_sector.bsPartitionID], 71h ; Runix HDFS ?
					;jne	short loc_hd_copy_10

					; valid runix boot sector, lets read Super Block	

					;add	ax,1
					;adc	dx,0
					; 30/12/2019
					; dx:ax = 0
					;mov	ax,1
					;xor	dx,dx
 02D2  40				inc	ax

 02D3  BB 3CB0 R			mov	bx,offset super_block ; offset systm
 02D6  E8 19F4				call	dskrd
					;jc	loc_hd_copy_6  ; Drive not ready or read error
						  	       ; or Disk r/w error
					; 27/03/2022
 02D9  73 03				jnc	short loc_hd_copy_14
 02DB				loc_hd_copy_err:
 02DB  E9 FEE2				jmp	loc_hd_copy_6
 02DE				loc_hd_copy_14:
					; Check super block is valid or not
 02DE  81 3E 3CB0 R 0171		cmp	word ptr [systm.sb_Header], 0171h
 02E4  75 17				jne	short loc_hd_copy_10
 02E6  80 3E 3CB2 R A1			cmp	byte ptr [systm.sb_Header+2], 0A1h
 02EB  75 10				jne	short loc_hd_copy_10
 02ED  81 3E 3EAC R A100		cmp	word ptr [systm.sb_Footer], 0A100h
 02F3  75 08				jne	short loc_hd_copy_10
 02F5  81 3E 3EAE R 7101		cmp	word ptr [systm.sb_Footer+2], 7101h
					;jne	loc_hd_copy_10 ; Not a valid RUFS
 02FB  74 06				je	short loc_hd_copy_11
					; 24/12/2019
 02FD				loc_hd_copy_10:
 02FD  BE 2E33 R			mov	si, offset msg_not_runix_fs ; Not a valid RUFS
 0300  E9 FECF				jmp	@b
					; 23/12/2019
 0303				loc_hd_copy_11:
					; Initialize basic RUFS buffers

					; Inode map buffer
					; 30/12/2019
 0303  A1 3CD0 R			mov	ax, word ptr [systm.sb_InodeMapAddr]
 0306  8B 16 3CD2 R			mov	dx, word ptr [systm.sb_InodeMapAddr+2]
 030A  BB 46B0 R			mov	bx, offset im_buffer
 030D  E8 19BD				call	dskrd
					;jc	loc_hd_copy_6  ; Drive not ready or read error
						  	       ; or Disk r/w error
					; 27/03/2022
 0310  72 C9				jc	short loc_hd_copy_err

					;xor	ax, ax
					;mov	word ptr [im_sector],ax ; 0

					; Free blocks map buffer
					; 30/12/2019
 0312  A1 3CC8 R			mov	ax, word ptr [systm.sb_FreeMapAddr]
 0315  8B 16 3CCA R			mov	dx, word ptr [systm.sb_FreeMapAddr+2]
 0319  BB 48B0 R			mov	bx, offset fbm_buffer
 031C  E8 19AE				call	dskrd
					;jc	loc_hd_copy_6  ; Drive not ready or read error
						  	       ; or Disk r/w error
					; 27/03/2022
 031F  72 BA				jc	short loc_hd_copy_err

					;xor	ax, ax
					;mov	word ptr [fbm_sector],ax ; 0
					;mov	word ptr [fbm_sector+2],ax ; 0

					; Inode table buffer (read the first 8 inodes to the buffer)
					; 30/12/2019
 0321  A1 3CD8 R			mov	ax, word ptr [systm.sb_InodeTblAddr]
 0324  8B 16 3CDA R			mov	dx, word ptr [systm.sb_InodeTblAddr+2]
 0328  BB 40B0 R			mov	bx, offset I_buffer ; 24/12/2019
 032B  E8 199F				call	dskrd
					;jc	loc_hd_copy_6  ; Drive not ready or read error
						  	       ; or Disk r/w error
					; 27/03/2022
 032E  72 AB				jc	short loc_hd_copy_err

					; 24/12/2019
					;;xor	ax, ax
					;;mov	word ptr [I_sector], ax ; 0
					;mov	word ptr [I_sector], 0
 0330  C6 06 3A6D R 01			mov	byte ptr [I_valid], 1 ; inode sector validation, valid

					; 17/12/2019	
					; OK! Lets go to command interpreter (prompt) stage
					
					;jmp	loc_call_unix_prompt

				;	int	20h
				;
				;	; 06/09/2019
				;hang:
				;	jmp	short hang

				;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
				; call	command interpreter
				;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

 0335				loc_call_unix_prompt:
					; 25/09/2019
 0335  BE 2AFA R			mov	si, offset type_27h
 0338  E8 01A9				call	PRINT_MSG

 033B  E8 01F7				call	unix_prompt

					; 07/07/2015
 033E  E9 FE94				jmp	close_file_then_terminate ; 24/12/2019

 0341				proc_start endp

				; 17/12/2019 - UNIXHDFS.ASM (14/12/2019)

 0341				set_hd_parms	proc near
					; 02/10/2019 - Retro UNIX 386 v2
					; Input:
					;  (output of INT 13h, AH=08h Read Drive Parameters)
					;   DL = number of hard disk drives 
					;   DH = logical last index of heads
					;      = number_of - 1 (because index starts with 0)
					;   CX = [7:6][15:8] = logical last index of cylinders
					;	 = number_of - 1 (because index starts with 0)
					;        [5:0] = logical last index of sectors per track
					;	 = number_of (because index starts with 1)
					; Output:
					;	CHS parameters are set
					;
					; Modified registers: ax,(bx),cx,dx,(es),(di)

 0341  32 E4				xor	ah,ah
 0343  8A C6				mov	al,dh
 0345  40				inc	ax
 0346  A3 3A88 R			mov	word ptr [heads],ax
 0349  8B C1				mov	ax,cx
 034B  83 E1 3F				and	cx,63
 034E  89 0E 3A8A R			mov	word ptr [sectors],cx	
 0352  86 E0				xchg	ah,al
 0354  80 E4 C0				and	ah,0C0h
 0357  D0 C4			 	rol	ah,1 	
 0359  D0 C4				rol	ah,1
 035B  40				inc	ax
 035C  A3 3A8C R			mov	word ptr [cylinders],ax	

					;push	ds
					;pop	es

 035F  C3				retn

 0360				set_hd_parms	endp

 0360				get_runix_partition proc near
					; 01/12/2019
					; 03/10/2019
					; 02/10/2019 - Retro UNIX 386 v2
					; Check Retro UNIX v2 (71h) partition on MasterBoot
					; sector if it is valid, set 'hidden sectors',
					; and 'total sectors'
					
					; DL = Drive number (80h .. 83h)

					; Modified registers: ax,(bx),cx,dx,(es),(di)

					;mov	dl,byte ptr [buff_d]
					; 01/01/2020
					;mov	dl,byte ptr [PhysicalDriveNumber]

					;xor	ah,ah
					;int	13h
					;jnc	short reset_ok
				;harddisk_error:
					;retn
				;reset_ok:
					;mov	bx,offset Buffer
					;mov	ax,0201h
					;mov	cx,1
					;;mov	dl,byte ptr [buff_d]
					;;mov	dl,byte ptr [drive] ; 03/12/2019
					;xor	dh,dh
					;;push	ds
					;;pop	es
					;int	13h
					;jc	short harddisk_error

				; Here is the entry point for hard disk image (no int13h!)

 0360  81 3E 40AE R AA55		cmp	word ptr [Buffer+510],0AA55h
 0366  74 02				je	short valid_masterboot
 0368				not_masterboot:
 0368  F9				stc
 0369  C3				retn
 036A				valid_masterboot:
					; 03/10/2019
 036A  BE 4072 R			mov	si,offset Buffer+01BEh+4 
						; partition type byte in partition table
 036D				check_runix_partition:
 036D  80 3C 71				cmp	byte ptr [si],71h
 0370  74 0D				je	short runix_partition_ok
 0372  81 FE 40A2 R			cmp	si,offset Buffer+01BEh+48+4
 0376  73 05				jnb	short not_runix_partition
 0378  83 C6 10				add	si,16
 037B  EB F0				jmp	short check_runix_partition
 037D				not_runix_partition:
 037D  F9				stc
 037E  C3				retn	
 037F				runix_partition_ok:
 037F  83 C6 04				add	si,4
					
					;mov	ax,word ptr [si] ; start sector (of the runix partition)
					;mov	word ptr [hidden_Sectors],ax
					;mov	dx,word ptr [si+2]
					;mov	word ptr [hidden_Sectors+2],dx
					;add	si,4
					
 0382  AD				lodsw
 0383  8B D0				mov	dx,ax
 0385  AD				lodsw
 0386  92				xchg	ax,dx
 0387  A3 3A8E R			mov	word ptr [hidden_Sectors],ax
 038A  89 16 3A90 R			mov	word ptr [hidden_Sectors+2],dx
					  	  
 038E  8B 1C				mov	bx,word ptr [si] ; total sectors (volume size)
 0390  89 1E 3A92 R			mov	word ptr [total_Sectors],bx
 0394  8B 4C 02				mov	cx,word ptr [si+2]
 0397  89 0E 3A94 R			mov	word ptr [total_Sectors+2],cx

					; 03/10/2019
 039B  03 C8				add	cx,ax
 039D  13 DA				adc	bx,dx
						
 039F  A1 3A8A R			mov	ax, word ptr [sectors]
 03A2  8B 16 3A88 R			mov	dx, word ptr [heads]
 03A6  F7 E2				mul	dx  ; max. possible value 255*63 = 16065
						; dx = 0
 03A8  8B 16 3A8C R			mov	dx, word ptr [cylinders]
 03AC  F7 E2				mul	dx
 03AE  83 E8 01				sub	ax, 1
 03B1  83 DA 00				sbb	dx, 0
					     ; dx:ax = CHS limit (max. = 16065*1024-1 = 16450559)

					; 01/12/2019
 03B4  A3 3AA2 R			mov	word ptr [CHS_limit], ax
 03B7  89 16 3AA4 R			mov	word ptr [CHS_limit+2], dx
					
 03BB  3B D3				cmp	dx, bx
 03BD  77 0C				ja	short chs_ok
 03BF  72 04				jb	short lba_ok
 03C1  3B C1				cmp	ax, cx
 03C3  73 06				jnb	short chs_ok
 03C5				lba_ok:
 03C5  C6 06 3AA0 R 01			mov	byte ptr [lba_rw], 1
 03CA  F8				clc	
 03CB				chs_ok:
 03CB  C3				retn

 03CC				get_runix_partition endp

 03CC				check_hd_image_size proc near
					; 23/12/2019
					; 03/10/2019 - Retro UNIX 386 v2
					; DX:AX = image file size (in bytes)

					; Source code (derived) from
					; hdimage.s - 06/03/2019
					; (TRDOS 386 Hard Disk Image Formatting Utility)

					;test 	ax, 511
					;jnz	short B_04 ; end of file is not on sector boundary!

					;mov	word ptr [file_size], ax
					;mov	word ptr [file_size+2], dx

					; 23/12/2019
 03CC  A1 3A96 R			mov	ax, word ptr [file_size]
 03CF  8B 16 3A98 R			mov	dx, word ptr [file_size+2]

					; Check for Singlix Master Boot code
 03D3  81 3E 406C R 07BE		cmp	word ptr [Buffer+444], 7BEh
 03D9  75 48				jne	short A_15 ; no ..

					; It is seen as singlix MBR
					; Let's check for disk size words (CHS record)

					; convert (disk image) file size to sector count (disk size)
					; (dx:ax)/512
					
 03DB  B9 0200				mov	cx, 512
 03DE  E8 1BBA				call	div32

					; 12/02/2019
 03E1  A3 3A92 R			mov	word ptr [total_sectors], ax
 03E4  89 16 3A94 R			mov	word ptr [total_sectors+2], dx

 03E8  8B 0E 4054 R			mov	cx, word ptr [Buffer+420] ; cylinders
 03EC  83 F9 10				cmp	cx, 16
 03EF  72 32				jb	short A_15 ; invalid
 03F1  A1 4056 R			mov	ax, word ptr [Buffer+422] ; heads
 03F4  83 F8 02				cmp	ax, 2
 03F7  72 2A				jb	short A_15 ; invalid
 03F9  8B 16 4058 R			mov	dx, word ptr [Buffer+424] ; sectors
 03FD  83 FA 11				cmp	dx, 17
 0400  72 21				jb	short A_15 ; invalid
 0402  89 0E 3A8C R			mov	word ptr [cylinders], cx
 0406  A3 3A88 R			mov	word ptr [heads], ax
 0409  89 16 3A8A R			mov	word ptr [sectors], dx
 040D  F7 E2				mul	dx
 040F  E8 1B75				call	mul32
 0412  0B DB				or	bx, bx
 0414  75 0D				jnz	short A_15 ; invalid
 0416  3B 16 3A94 R			cmp	dx, word ptr [total_sectors+2]
 041A  75 07				jne	short A_15
 041C  3B 06 3A92 R			cmp	ax, word ptr [total_sectors]
 0420  75 01				jne	short A_15 ; invalid 

					; valid singlix MBR & disk image file

 0422  C3				retn
 0423				A_15:
					; cylinders*63sectors*16heads (<=528MB)
 0423  81 FA 1F80			cmp	dx, 1F80h ; 1024*16*63 (1F800000h)
 0427  77 4B				ja	short A_21
 0429  72 06				jb	short A_16
 042B  23 C0				and	ax, ax
 042D  75 5C				jnz	short A_22

					; = 528MB (1024*16*63*512)
					;mov	word ptr [heads], 16
					;mov	ax, 1024
					;jmp	short A_25
					; 04/12/2019
 042F  EB 4F				jmp	short A_27
 0431				A_16:
					; < 528MB
 0431  B9 03F0				mov	cx, 63*16 ; 1008
 0434  F7 F1				div	cx
 0436  23 D2				and	dx, dx
 0438  75 04				jnz	short A_17 ; 17 spt disk image check
					;mov	word ptr [heads], 16
					;jmp	short A_25
 043A  EB 47				jmp	short A_28 ; 04/12/2019
 043C				B_04:
 043C  F9				stc
 043D  C3				retn
 043E				A_17:
					; 12/02/2019
 043E  A1 3A96 R			mov	ax, word ptr [file_size]
 0441  8B 16 3A98 R			mov	dx, word ptr [file_size+2]

					;; 10/02/2019
					;; Check 17 spt disk image
					;mov	si, DTA_FileSize
					;lodsw
					;; max. size of hard disk image = 17sectors*16heads*1024cylinders
					;mov	dx, word ptr [si]
					
					; 04/12/2019
 0445  81 FA 0880			cmp	dx, 880h ; 136MB upper limit (8800000h) for 17spt
 0449  77 F1				ja	short B_04

 044B  B9 0200				mov	cx, 512
 044E  E8 1B4A				call	div32

 0451  A3 3A9A R			mov	word ptr [pp_Sectors], ax
 0454  89 16 3A9C R			mov	word ptr [pp_Sectors+2], dx
					
					; Calculate with increased heads (count) order
					; (For example cyls = 1024 & heads = 8 is better than
					;      cyls = 512 & heads = 16, for 17 SPT.v)

 0458  B9 0022				mov	cx, 17*2 ; 34 ; heads = 2
 045B				A_18:
 045B  E8 1B3D				call	div32
						; Ýf remainder = 0 it is 17spt hard disk image file
 045E  23 DB				and	bx, bx
 0460  74 6B				jz	short A_20
 0462				A_19:	
 0462  83 C1 11				add	cx, 17
 0465  81 F9 0110			cmp	cx, 17*16 ; 272 ; heads = 16
 0469  77 D1				ja	short B_04 ; invalid image file !

 046B  A1 3A9A R			mov	ax, word ptr [pp_Sectors]
 046E  8B 16 3A9C R			mov	dx, word ptr [pp_Sectors+2]
					 	
 0472  EB E7				jmp	short A_18
 0474				A_21:
					; cylinders*63sectors*32heads (>528MB, <=1GB)
 0474  81 FA 3F00			cmp	dx, 3F00h ; 1024*32*63 (3F000000h)
 0478  77 22				ja	short A_23
 047A  72 0F				jb	short A_22
 047C  23 C0				and	ax, ax
 047E  75 1C				jnz	short A_23
					; = 1GB (1024*32*63*512)
 0480				A_27:
 0480  B8 0400				mov	ax, 1024
 0483				A_28:
 0483  C7 06 3A88 R 0010		mov	word ptr [heads], 16
 0489  EB 20				jmp	short A_25	
 048B				A_22:
 048B  B9 07E0				mov	cx, 63*32
 048E  F7 F1				div	cx
 0490  23 D2				and	dx, dx
 0492  75 A8				jnz	short B_04
 0494  C7 06 3A88 R 0020		mov	word ptr [heads], 32
 049A  EB 0F				jmp	short A_25
 049C				A_23:
					; cylinders*63sectors*64heads (>1GB, <=2GB)
 049C  B9 0FC0				mov	cx, 63*64
 049F  F7 F1				div	cx
 04A1  23 D2				and	dx, dx
 04A3  75 97				jnz	short B_04
 04A5				A_24:
 04A5  C7 06 3A88 R 0040		mov	word ptr [heads], 64
 04AB				A_25:
 04AB  C7 06 3A8A R 003F		mov	word ptr [sectors], 63
 04B1  A3 3A8C R			mov	word ptr [cylinders], ax
 04B4				A_26:
					; 08/02/2019

					; calculate total sectors (by using CHS values)
 04B4  A1 3A8A R			mov	ax, word ptr [sectors]
 04B7  F7 26 3A88 R			mul	word ptr [heads]
 04BB  A3 3A9E R			mov	word ptr [min_sectors], ax ; Minimum sectors
 04BE  8B 16 3A8C R			mov	dx, word ptr [cylinders]
 04C2  F7 E2				mul	dx
 04C4  A3 3A92 R			mov	word ptr [total_sectors], ax
 04C7  89 16 3A94 R			mov	word ptr [total_sectors+2], dx
					
 04CB  F8				clc
 04CC  C3				retn
 04CD				A_20:
 04CD  3D 0400				cmp	ax, 1024
 04D0  77 90				ja	short A_19

 04D2  B3 11				mov	bl, 17
 04D4  88 1E 3A8A R			mov	byte ptr [sectors], bl ; 17
 04D8  A3 3A8C R			mov	word ptr [cylinders], ax

 04DB  8B C1				mov	ax, cx
 04DD  F6 F3				div	bl
					;xor	ah, ah
 04DF  A3 3A88 R			mov	word ptr [heads], ax

 04E2  EB D0				jmp	short A_26

 04E4				check_hd_image_size endp

 04E4				PRINT_MSG	proc near
 04E4  BB 0007				mov	bx,07h  
 04E7  B4 0E				mov	ah,0Eh  
 04E9				PRINT_MSG_LOOP:
 04E9  AC				lodsb		; Load byte at DS:SI to AL
 04EA  22 C0				and	al,al            
 04EC  74 04				jz	short PRINT_MSG_OK       
					
 04EE  CD 10				int	10h	; BIOS Service func (ah) = 0Eh
							; Write char as TTY
							;AL-char BH-page BL-color
 04F0  EB F7				jmp	short PRINT_MSG_LOOP           
 04F2				PRINT_MSG_OK:
 04F2  C3				retn

 04F3				PRINT_MSG	endp

 04F3				proc_hex	proc near

 04F3  D4 10				db 0D4h,10h	; Undocumented inst. AAM
							; AH = AL / 10h
							; AL = AL MOD 10h
 04F5  0D 3030				or	ax,'00'	; Make it ZERO (ASCII) based

 04F8  86 E0				xchg	ah,al 
				; 1999
 04FA  3C 39				cmp	al,'9'
 04FC  76 02				jna	short pass_cc_al
 04FE  04 07				add	al,7
 0500				pass_cc_al:
 0500  80 FC 39				cmp	ah,'9'
 0503  76 03				jna	short pass_cc_ah
 0505  80 C4 07				add	ah,7
 0508				pass_cc_ah:

				; 1998
 0508  C3				retn

 0509				proc_hex	endp

 0509				drive_check:
					; 03/12/2019
					; 03/10/2019
					; 09/09/2019 - Retro UNIX 386 v2
					
					; DL = Hard disk drive number 
					
					;;xor	bx, bx ; sector 0
					;;mov	word ptr [buff_s], bx
					;;mov	word ptr [buff_o], offset Buffer
					;;call	dskrd

					; 03/10/2019

					;xor	ah,ah
					;int	13h
					;jc	short drive_not_ready
 0509				reset_ok:
 0509  BB 3EB0 R			mov	bx,offset Buffer
 050C  B8 0201				mov	ax,0201h
 050F  B9 0001				mov	cx,1
					;mov	dl,byte ptr [buff_d]
					;mov	dl,byte ptr [Drive] ; 03/12/2019
					; 01/01/2020
					;mov	dl,byte ptr [PhysicalDriveNumber]

 0512  32 F6				xor	dh,dh
					;push	ds
					;pop	es
 0514  CD 13				int	13h
 0516  73 0A				jnc	short drive_check_ok
 0518				drive_not_ready:
					; 09/09/2019
 0518  58				pop	ax ; near call	return address
 0519  BE 2CA9 R			mov	si, offset msg_drive_not_ready
 051C  E8 FFC5				call	PRINT_MSG
					; 24/12/2019
 051F  E9 FCBF				jmp	terminate
 0522				drive_check_ok:
 0522  C3				retn

 0523				shl32:
					; 23/01/2020
					; 16/10/2019
					; 18/09/2019 (UNIXCOPY.ASM)
					; INPUT:
					;   CL = shift count
					;xor	ch,ch
 0523  E3 06				jcxz	norotal
 0525				rotashftl:
					; 23/01/2020
 0525  D1 E0				shl	ax,1
 0527  D1 D2				rcl	dx,1
 0529  E2 FA				loop	rotashftl
 052B				norotal:
 052B  C3				retn

 052C				shr32:
					; 16/10/2019
					; INPUT:
					;   CL = shift count
					;xor	ch,ch
 052C  E3 06				jcxz	norotar
 052E				rotashftr:
 052E  D1 EA				shr	dx,1
 0530  D1 D8				rcr	ax,1
 0532  E2 FA				loop	rotashftr
 0534				norotar:
 0534  C3				retn

				; ***

 0535				unix_prompt proc near
					; 01/01/2020
					; 07/07/2015
					; 8/12/2012
					; Derived from
					; proc_dos_prompt procedure of TRDOS, 
					; MAINPROG.ASM (1/1/2012). 
					;
					; proc_dos_prompt (15/09/2011)
					;

					;push	ds
					;pop	es
 0535				unix_prompt_0:	
					; 07/07/2015
					;cmp	byte ptr [PhysicalDriveNumber],90h
					; 01/01/2020
 0535  80 3E 3A45 R 90			cmp	byte ptr [Drive],90h
 053A  72 17				jb	short unix_prompt_1

					; 25/09/2019
 053C				@@:
 053C  B4 01				mov	ah,1 ; clear keyboard buffer
 053E  CD 16				int	16h
 0540  74 06				jz	short @f ; keyboard buffer is empty
 0542  32 E4				xor	ah,ah ; get character
 0544  CD 16				int	16h
 0546  EB F4				jmp	short @b ; loop till keyboard buffer becomes empty
 0548				@@:
 0548  BE 3014 R			mov	si,offset img_file_name
 054B  E8 FF96				call	PRINT_MSG
 054E  BE 2C1F R			mov	si,offset unix_img_cdir
 0551  EB 09				jmp	short unix_prompt_15
 0553				unix_prompt_1:
 0553  BE 2C1A R			mov	si,offset unix_cdrv
 0556  E8 FF8B				call	PRINT_MSG
 0559				unix_prompt_2:
 0559  BE 2C20 R			mov	si,offset unix_cdir
 055C				unix_prompt_15:
 055C  E8 FF85				call	PRINT_MSG
 055F				unix_prompt_3:
 055F  A0 2C48 R			mov	al,byte ptr [unix_prompt_char]
				 	;mov	ah,0Eh	  
					;mov	bx,07h             
 0562  CD 10				int	10h         
 0564				unix_prompt_4:     
 0564  B4 03				mov	ah,03h
					;mov	bx,07h	  
 0566  CD 10				int	10h
 0568  88 16 2C49 R			mov	byte ptr [CursorColumn],dl
 056C				unix_prompt_5:
 056C  BE 2C4B R			mov	si,offset CommandBuffer
 056F  E8 0061				call	proc_rw_char
					;mov	byte ptr [CommandBuffer]+75,0

					;mov	si,offset CommandBuffer
 0572  8B FE				mov	di,si
 0574  33 DB				xor	bx,bx
 0576  33 C9				xor	cx,cx
 0578				unix_prompt_6:
 0578  8A 00				mov	al,byte ptr [si][bx]
 057A  FE C3				inc	bl 
 057C  3C 20				cmp	al,20h
 057E  77 11				ja      short unix_prompt_8
 0580  72 40				jb      short unix_prompt_13
 0582  80 FB 4A				cmp	bl,74 ; 75 ?
 0585  72 F1				jb      short unix_prompt_6
 0587  EB 39				jmp	short unix_prompt_13
 0589				unix_prompt_7:
 0589  8A 00				mov	al,byte ptr [si][bx]
 058B  FE C3				inc	bl
 058D  3C 20				cmp	al,20h
 058F  76 08				jna     short unix_prompt_9
 0591				unix_prompt_8:
 0591  AA				stosb   
 0592  FE C1				inc	cl
 0594  80 FB 4A				cmp	bl,74 ; 75 ?
 0597  72 F0				jb      short unix_prompt_7
					;jmp	short unix_prompt_12
 0599				unix_prompt_9:
 0599  32 C0				xor	al,al ; 0
 059B				unix_prompt_10:
 059B  88 05				mov	byte ptr [di],al
 059D  47				inc	di
 059E  80 FB 4A				cmp	bl,74 ; 75 ?
 05A1  73 0B				jnb	short unix_prompt_12
 05A3  8A 00				mov	al,byte ptr [si][bx]
 05A5  FE C3				inc	bl
 05A7  3C 20				cmp	al,20h
 05A9  73 F0				jnb 	short unix_prompt_10
 05AB				unix_prompt_11:
 05AB  C6 05 00				mov	byte ptr [di],0
 05AE				unix_prompt_12:
 05AE  E8 00A9				call	command_interpreter

 05B1  80 3E 2C95 R 01			cmp	byte ptr [program_exit],1
 05B6  73 1A				jnb	short unix_prompt_14

 05B8  B9 004A				mov	cx,74 ; 75 ?
 05BB  BF 2C4B R			mov	di,offset CommandBuffer
 05BE  32 C0				xor	al,al
 05C0  F3/ AA				rep	stosb
 05C2				unix_prompt_13:
 05C2  BB 0007				mov	bx,07h 
 05C5  B0 0D				mov	al,0Dh
 05C7  B4 0E				mov	ah,0Eh
 05C9  CD 10				int	10h
 05CB  B0 0A				mov	al,0Ah
 05CD  CD 10				int	10h
					
 05CF  E9 FF63				jmp	unix_prompt_0 ; loop

 05D2				unix_prompt_14:
 05D2  C3				retn

 05D3				unix_prompt	endp

 05D3				proc_rw_char proc near
					       ; 8/12/2012 (modification for UNIXCOPY.ASM)
					       ; OUTPUT -> DS:SI = Entered String (ASCIIZ)
 05D3				read_next_char:
 05D3  32 E4				xor	ah,ah
 05D5  CD 16				int	16h
 05D7  22 C0				and	al,al
 05D9  74 3B				jz	short loc_arrow    
 05DB  3C E0				cmp	al,0E0h          
 05DD  74 37				je	short loc_arrow
 05DF  3C 08				cmp	al,08h
 05E1  75 3F				jne	short char_return
 05E3				loc_back:
 05E3  B3 07				mov	bl,7
 05E5  B4 03				mov	ah,3
 05E7  CD 10				int	10h
 05E9  3A 16 2C49 R			cmp	dl,byte ptr [CursorColumn]
 05ED  77 08				ja	short prev_column
 05EF				loc_beep:
 05EF  B4 0E				mov	ah,0Eh
 05F1  B0 07				mov	al,7
 05F3  CD 10				int	10h
 05F5  EB DC				jmp	short read_next_char
 05F7				prev_column:
 05F7  FE CA				dec	dl
 05F9				set_cursor_pos:
 05F9  B4 02				mov	ah,02h
 05FB  CD 10				int	10h
 05FD  8A DA				mov	bl,dl
 05FF  2A 1E 2C49 R			sub	bl,byte ptr [CursorColumn] 
 0603  B9 0001				mov	cx,1
 0606  B4 09				mov	ah,09h
 0608  B0 20				mov	al,20h
 060A  88 00				mov	byte ptr [si][bx],al
 060C				loc_writeit:
 060C  B3 07				mov	bl,7
 060E  CD 10				int	10h
 0610  8B 16 2C49 R			mov	dx,word ptr [CursorColumn]
 0614  EB BD				jmp	short read_next_char
 0616				loc_arrow:    
 0616  80 FC 4B				cmp	AH,4Bh
 0619  74 C8				je	short loc_back
 061B  80 FC 53				cmp	AH,53h
 061E  74 C3				je	short loc_back
 0620  EB B1				jmp	short read_next_char
 0622				char_return:
 0622  B3 07				mov	bl,7
 0624  B4 03				mov	ah,3
 0626  CD 10				int	10h

 0628  8A E2				mov	ah,dl	
 062A  2A 26 2C49 R			sub	ah,byte ptr [CursorColumn] 
 062E  3C 20				cmp	al,20h
 0630  72 22				jb	short loc_escape
 0632  80 FC 48				cmp	ah,72 ; limit
 0635  77 B8				ja	short loc_beep

 0637  8A DC				mov	bl,ah
 0639  32 E4				       xor	ah,ah
 063B  89 00				mov	word ptr [si][bx],ax
 063D  B4 0E				mov	ah,0Eh
 063F  B3 07				mov	bl,7
 0641  CD 10				int	10h
 0643  EB 8E				jmp	short read_next_char
 0645				pass_escape:
 0645  3C 0D				cmp	al,0Dh
 0647  75 8A				jne	short read_next_char
 0649  B4 0E				       mov	ah,0Eh	
 064B  B3 07				mov	bl,7
 064D  CD 10				int	10h
 064F  B0 0A				mov	al,0Ah
 0651  CD 10				int	10h
 0653  C3				retn
 0654				loc_escape:
 0654  3C 1B				cmp	al,1Bh
 0656  75 ED				jne	short pass_escape
 0658  F9				stc
 0659  C3				retn

 065A				proc_rw_char endp

 065A				command_interpreter proc near
					; 22/01/2020
					; 15/01/2020
					; 05/01/2020
					; 04/01/2020
					; 20/09/2019 - Retro UNIX 386 v2 (modified unix v7 inode structure)
					; 01/03/2013
					; 25/02/2013
					; 23/02/2013 ?/help
					; 17/02/2013 namei, inode, iget
					; 16/02/2013 fs, volume 
					; 21/01/2013 'ls -l'
					; 20/01/2013 ls (dir modifications)
					; 13/01/2013 chmod, chown, link
					; 07/01/2013 show tabspace (div) modif.
					; 06/01/2013 show
					; 06/01/2013 rm, mkdir, rmdir modifications
					; 05/01/2013 check file attributes
					; 30/12/2012
					        ; 24/12/2012 todos
					; 16/12/2012
					; 08/12/2012
					;
 065A  AD				lodsw   ; 25/02/2013
 065B				cl4:
 065B  80 F9 04				cmp	cl, 4
					;ja	cl5
					;jb	cl3
					; 27/03/2022
 065E  77 1B				ja	short cl5_or_above
 0660  74 03				je	short loc_cmd_exit
 0662  E9 046A				jmp	cl3
				; EXIT	
 0665				loc_cmd_exit:
 0665  3D 7865				cmp	ax, 'xe'
 0668  75 14				jne	short loc_cmd_show
 066A  AD				lodsw
 066B  3D 7469				cmp	ax, 'ti'
 066E  75 0A				jne	short @f
 0670  AC				lodsb
 0671  0A C0				or	al, al
 0673  75 05				jnz	short @f	

 0675  C6 06 2C95 R 01			mov	byte ptr [program_exit], 1
 067A				@@:
 067A  C3				retn

					; 27/03/2022
 067B				cl5_or_above:
 067B  E9 00ED				jmp	cl5

				; SHOW
 067E				loc_cmd_show:
					; 06/01/2013
 067E  3D 6873				cmp	ax, 'hs'
 0681  75 29				jne	short loc_cmd_link
 0683  AD				lodsw
 0684  3D 776F				cmp	ax, 'wo'
 0687  75 F1				jne	short @b
 0689  AC				lodsb
 068A  0A C0				or	al, al
 068C  75 EC				jnz	short @b
 068E				show_uf1:
 068E  89 36 3080 R			mov	word ptr [u_namep], si
 0692  AC				lodsb
 0693  3C 20				cmp	al, 20h
 0695  74 F7				je	short show_uf1
 0697  72 12				jb	short @f
 0699				show_uf2:
 0699  AC				lodsb
 069A  3C 20				cmp	al, 20h
 069C  77 FB				ja	short show_uf2
 069E  32 C0				xor	al, al
 06A0  88 44 FF				mov	byte ptr [SI]-1, al
 06A3				show_uf3:
 06A3  E8 0D37				call	show_file
					;jc	ci_error
					; 27/03/2022
 06A6  73 03				jnc	short @f
 06A8				show_uf_err:
 06A8  E9 0457				jmp	ci_error
 06AB				@@:
 06AB  C3				retn
				; LINK
 06AC				loc_cmd_link:
 06AC  3D 696C				cmp	ax, 'il'
					;jne	loc_cmd_iget ; 17/02/2013
					; 27/03/2022
 06AF  74 03				je	short link_sf0
 06B1  E9 0085				jmp	loc_cmd_iget
 06B4				link_sf0:
 06B4  AD				lodsw
 06B5  3D 6B6E				cmp	ax, 'kn'
 06B8  75 F1				jne	short @b
 06BA  AC				lodsb
 06BB  0A C0				or	al, al
 06BD  75 EC				jnz	short @b
 06BF				link_sf1:
 06BF  89 36 3080 R			mov	word ptr [u_namep], si
 06C3  AC				lodsb
 06C4  3C 20				cmp	al, 20h
 06C6  74 F7				je	short link_sf1
 06C8  72 E1				jb	short @b
 06CA				link_sf2:
 06CA  AC				lodsb
 06CB  3C 20				cmp	al, 20h
 06CD  77 FB				ja	short link_sf2
 06CF  32 C0				xor	al, al
 06D1  88 44 FF				mov	byte ptr [SI]-1, al
 06D4				link_df1:
 06D4  89 36 2C9A R			mov	word ptr [arg], si
 06D8  AC				lodsb
 06D9  3C 20				cmp	al, 20h
 06DB  74 F7				je	short link_df1
 06DD  72 CC				jb	short @b
 06DF				link_df2:
 06DF  AC				lodsb
 06E0  3C 20				cmp	al, 20h
 06E2  77 FB				ja	short link_df2
 06E4  4E				dec	si
 06E5  32 C0				xor	al, al
 06E7  88 04				mov	byte ptr [SI], al
 06E9				link_fsf:
 06E9  E8 0DAD				call	namei
					;jc	ci_error
					; 27/03/2022
 06EC  73 03				jnc	short @f
 06EE				link_err:
 06EE  E9 0411				jmp	ci_error
 06F1				@@:
					;mov	word ptr [uf_i_number], ax
					; 29/12/2019
 06F1  89 1E 3038 R			mov	word ptr [uf_i_number], bx
 06F5				link_fdf:
 06F5  8B 36 2C9A R			mov	si, word ptr [arg]
 06F9  89 36 3080 R			mov	word ptr [u_namep], si

					;call	namei
 06FD  E8 0D9D				call	namei_x ; 02/10/2019
					;jnc	ci_error
					; 27/03/2022
 0700  73 EC				jnc	short link_err

 0702  80 FC FF				cmp	ah, 0FFh
					;jne	ci_error
					; 27/03/2022
 0705  75 E7				jne	short link_err

					; [u_dirp] = empty directory entry slot

 0707  A1 3A5E R			mov	ax, word ptr [ii]
 070A  A3 2C96 R			mov	word ptr [pdir], ax
					
					;mov	ax, word ptr [uf_i_number]
					; 26/12/2019
 070D  8B 1E 3038 R			mov	bx, word ptr [uf_i_number]	
 0711  E8 0ED8				call	iget
					;jc	ci_error
					; 27/03/2022
 0714  72 D8				jc	short link_err

					; 19/09/2019
 0716  C6 06 3A5B R 01			mov	byte ptr [imodx], 1 ; 19/09/2019 - Retro UNIX 386 v2
						; (flag means file data is same
						;  but inode's itself is modified)

 071B  FE 06 303E R			inc	byte ptr [inode_nlks] ; link count

 071F  E8 13DB			        call	setimod ; jsr r0,setimod / set modified flag

					;inc	byte ptr [inode_nlks] ; link count

					;mov	ax, word ptr [pdir]
					; 26/12/2019
 0722  8B 1E 2C96 R			mov	bx, word ptr [pdir]
 0726  E8 0EC3				call	iget
					;jc	ci_error
					; 27/03/2022
 0729  72 C3				jc	short link_err

					; namei -> u_namep points filename 
					;          after the last '/' of the path
					
 072B  A1 3038 R			mov	ax, word ptr [uf_i_number]
 072E  A3 3086 R	mov	word ptr [u_dirbuf], ax

 0731  E8 1475				call	mk_dir ; make directory entry
					;jc	ci_error
					; 27/03/2022
 0734  72 B8				jc	short link_err

 0736  E9 06D5				jmp	ci_sync_exit
				; IGET
 0739				loc_cmd_iget:   ; 17/02/2013, inode/iget
 0739  3D 6769				cmp	ax, 'gi'
 073C  75 17				jne	short loc_cmd_help ; 23/02/2013
 073E  AD				lodsw
 073F  3D 7465				cmp	ax, 'te'
 0742  75 64				jne	short @f
 0744  AC				lodsb
 0745  0A C0				or	al, al
 0747  75 5F				jnz	short @f	
 0749				ci_iget_getarg:
 0749  8B DE				mov	bx, si
 074B  AC				lodsb
 074C  3C 20				cmp	al, 20h
					;ja	inode_getarg2
 074E  74 F9				je	short ci_iget_getarg
					; 27/03/2022
 0750  72 03				jb	short loc_cmd_help
 0752  E9 0366				jmp	inode_getarg2		
				; HELP
 0755				loc_cmd_help:	; 23/02/2013
 0755  3D 6568				cmp	ax, 'eh'
 0758  75 4E				jne	short @f
 075A  AD				lodsw
 075B  3D 706C				cmp	ax, 'pl'
 075E  75 48				jne	short @f
 0760  AC				lodsb
 0761  22 C0				and	al, al
 0763  75 43				jnz	short @f
 0765				ci_?:
 0765  BE 347E R			mov	si, offset UNIXCOPY_Commands
					;call	PRINT_MSG
					; 22/01/2020
 0768  E9 FD79				jmp	PRINT_MSG
				;@@:
				;	retn  
 076B				cl5:
 076B  80 F9 05				cmp	cl, 5
					;ja	cl7
					;;jb	short @f
					; 27/03/2022
 076E  76 03				jna	short loc_cmd_chdir
 0770  E9 04E4				jmp	cl7
				; CHDIR
 0773				loc_cmd_chdir:
 0773  3D 6863				cmp	ax, 'hc'
					;jne	loc_cmd_todos
					; 27/03/2022
 0776  74 03				je	short ci_chdir_chk
 0778  E9 0098				jmp	loc_cmd_todos
 077B				ci_chdir_chk:
 077B  AD				lodsw
 077C  3D 6964				cmp	ax, 'id'
 077F  75 28				jne	short loc_cmd_chmod
 0781  AC				lodsb
 0782  3C 72				cmp	al, 'r'
 0784  75 22				jne	short @f
 0786  AC				lodsb
 0787  0A C0				or	al, al
 0789  75 1D				jnz	short @f
 078B				ci_cd_getarg:
 078B  89 36 3080 R			mov	word ptr [u_namep], si
 078F  AC				lodsb
 0790  3C 20				cmp	al, 20h
 0792  74 F7				je	short ci_cd_getarg
 0794  72 12				jb	short @f
					;dec	si

 0796  A1 3080 R			mov	ax, word ptr [u_namep]
 0799  A3 2C9A R			mov	word ptr [arg], ax

 079C  E8 09F2				call	sys_chdir
					;jc	ci_error
					; 27/03/2022
 079F  72 24				jc	short chdir_err
					
 07A1  8B 36 2C9A R			mov	si, word ptr [arg]
 07A5  E8 074B				call	update_cdir_string
 07A8				@@:
 07A8  C3				retn

				; CHMOD
 07A9				loc_cmd_chmod: ; 13/01/2013
					;cmp	ax, 'hc'
					;jne	short loc_cmd_todos
					;lodsw
 07A9  3D 6F6D				cmp	ax, 'om'
 07AC  75 23				jne	short loc_cmd_chown
 07AE  AC				lodsb	
 07AF  3C 64				cmp	al, 'd'	
 07B1  75 F5				jne	short @b
 07B3  AC				lodsb
 07B4  0A C0				or	al, al
 07B6  75 F0				jnz	short @b
 07B8				ci_chmod_getarg:
 07B8  AC				lodsb
 07B9  3C 20				cmp	al, 20h
 07BB  74 FB				je	short ci_chmod_getarg
 07BD  72 E9				jb	short @b
 07BF  4E				dec	si
 07C0  E8 1DEC				call	chmode
					;jc	ci_error
					; 27/03/2022
 07C3  73 03				jnc	short ci_chmod_print
 07C5				chmod_err:
 07C5				chdir_err:
 07C5				chown_err:
 07C5				chgrp_err:
 07C5  E9 033A				jmp	ci_error

					; 27/03/2022
 07C8				ci_chmod_print:
					; 01/10/2019 - Retro UNIX 386 v2
 07C8				ci_chown_print:
 07C8				ci_chgrp_print: ; 01/10/2019
 07C8  BE 2C98 R			mov	si, offset msg_arg
 07CB  E8 FD16				call	PRINT_MSG
 07CE  E9 063D				jmp	ci_sync_exit

				; CHOWN
 07D1				loc_cmd_chown: ; 13/01/2013
					;cmp	ax, 'hc'
					;jne	short loc_cmd_todos
					;lodsw
 07D1  3D 776F				cmp	ax, 'wo'
					;jne	short @b
 07D4  75 1C				jne	short loc_cmd_chgrp ; 01/10/2019
 07D6  AC				lodsb	
 07D7  3C 6E				cmp	al, 'n'	
 07D9  75 CD				jne	short @b
 07DB  AC				lodsb
 07DC  0A C0				or	al, al
 07DE  75 C8				jnz	short @b
 07E0				ci_chown_getarg:
 07E0  AC				lodsb
 07E1  3C 20				cmp	al, 20h
 07E3  74 FB				je	short ci_chown_getarg
 07E5  72 C1				jb	short @b
 07E7  4E				dec	si
 07E8  E8 1E57				call	chowner
					;jc	ci_error
					; 27/03/2022
 07EB  72 D8				jc	short chown_err
 07ED  23 DB				and	bx, bx
 07EF  75 D7				jnz	short ci_chown_print
 07F1				@@:
 07F1  C3				retn

				; CHGRP
 07F2				loc_cmd_chgrp: ; 01/10/2019 - Retro UNIX 386 v2
					;cmp	ax, 'hc'
					;jne	short loc_cmd_todos
					;lodsw
 07F2  3D 7267				cmp	ax, 'rg'
 07F5  75 FA				jne	short @b
 07F7  AC				lodsb	
 07F8  3C 70				cmp	al, 'p'	
 07FA  75 F5				jne	short @b
 07FC  AC				lodsb
 07FD  0A C0				or	al, al
 07FF  75 F0				jnz	short @b
 0801				ci_chgrp_getarg:
 0801  AC				lodsb
 0802  3C 20				cmp	al, 20h
 0804  74 FB				je	short ci_chgrp_getarg
 0806  72 E9				jb	short @b
 0808  4E				dec	si
 0809  E8 1E2E				call	chgroup
					;jc	ci_error
					; 27/03/2022
 080C  72 B7				jc	short chgrp_err

 080E  23 DB				and	bx, bx
 0810  75 B6				jnz	short ci_chgrp_print
 0812				@@:
 0812  C3				retn
				; TODOS
 0813				loc_cmd_todos:
					; 24/12/2012
 0813  3D 6F74				cmp	ax, 'ot'
					;jne	loc_cmd_mkdir ; 30/12/2012
					; 27/03/2022
 0816  74 03				je	short todos_uf0
 0818  E9 0189				jmp	loc_cmd_mkdir
 081B				todos_uf0:
 081B  AD				lodsw
 081C  3D 6F64				cmp	ax, 'od'
 081F  75 F1				jne	short @b
 0821  AC				lodsb	
 0822  3C 73				cmp	al, 's'	
 0824  75 EC				jne	short @b
 0826  AC				lodsb
 0827  0A C0				or	al, al
 0829  75 E7				jnz	short @b
 082B				todos_uf1:
 082B  89 36 3080 R			mov	word ptr [u_namep], si
 082F  AC				lodsb
 0830  3C 20				cmp	al, 20h
 0832  74 F7				je	short todos_uf1
 0834  72 DC				jb	short @b
 0836				todos_uf2:
 0836  AC				lodsb
 0837  3C 20				cmp	al, 20h
 0839  77 FB				ja	short todos_uf2
 083B  32 C0				xor	al, al
 083D  88 44 FF				mov	byte ptr [SI]-1, al
 0840				todos_df1:
 0840  89 36 2C9A R			mov	word ptr [arg], si
 0844  AC				lodsb
 0845  3C 20				cmp	al, 20h
 0847  74 F7				je	short todos_df1
 0849  72 C7				jb	short @b
 084B				todos_df2:
 084B  AC				lodsb
 084C  3C 20				cmp	al, 20h
 084E  77 FB				ja	short todos_df2
 0850  4E				dec	si
 0851  32 C0				xor	al, al
 0853  88 04				mov	byte ptr [SI], al
 0855				todos_fuf:
 0855  E8 0C41				call	namei
					;;jnc	short @f ; *
					;jc	ci_error
					; 27/03/2022
 0858  73 03				jnc	short @f
 085A				todos_err1:
 085A  E9 02A5				jmp	ci_error
 085D				@@:
					;cmp	ah, 0FFh
					;jne	ci_error
					;jmp	ci_error ; 'file not found' error
 085D				@@: ; *
					;mov	word ptr [uf_i_number], ax
					; 29/12/2019
 085D  89 1E 3038 R			mov	word ptr [uf_i_number], bx
 0861				todos_fdf:
 0861  8B 16 2C9A R			mov	dx, word ptr [arg]
 0865  B9 003F				mov	cx, 3Fh ; File Attributes ; 05/01/2013 (3Fh)
 0868  B4 4E				mov	ah, 4Eh ; MS Dos Function = Find First File
 086A  CD 21				int	21h
					;jnc	short todos_afow
 086C  73 07				jnc	short @f ; 05/01/2013
 086E				todos_chk_err:
 086E  80 FC 03				cmp	ah,03h  ; dos error number > 3
					;ja	ci_error
					; 27/03/2022
 0871  77 E7				ja	short todos_err1

 0873  EB 50				jmp	short todos_crdf

 0875				@@:	; 05/01/2013
 0875  BE 0095				mov	si, DTA_Attrib
 0878  8A 04				mov	al, byte ptr [SI]
 087A  24 1F				and	al, 1Fh ; directory, volume label, system, hidden, read only
					;jnz	ci_error
					; 27/03/2022
 087C  75 DC				jnz	short todos_err1
 087E				todos_afow:	; overwrite question
 087E  BE 2FCA R			mov	si, offset msg_overwrite_question1
 0881  E8 FC60				call	PRINT_MSG
 0884  BE 009E				mov	si, DTA_FileName
 0887  E8 FC5A				call	PRINT_MSG
 088A  BE 2FE7 R			mov	si, offset msg_overwrite_question2
 088D  E8 FC54				call	PRINT_MSG
 0890  BE 2C9E R			mov	si, offset msg_yes_no
 0893  E8 FC4E				call	PRINT_MSG
 0896				todos_afow_input:	; ask for overwrite
 0896  33 C0				xor	ax, ax
 0898  CD 16				int	16h	; wait for keyboard command
 089A  3C 03				cmp	al, 'C'-40h
 089C  74 1A				je	short @f	   
 089E  3C 1B				cmp	al, 27
 08A0  74 16				je	short @f
 08A2  24 DF				and	al, 0DFh
 08A4  3C 59				cmp	al, 'Y'	; Yes?
 08A6  74 11				je	short todos_afow_yes ; overwrite
 08A8  3C 4E				cmp	al, 'N'	; No?
 08AA  75 EA				jne	short todos_afow_input         
 08AC				todos_afow_no:
 08AC  BE 2EC4 R			mov	si, offset msg_No
 08AF  E8 FC32				call	PRINT_MSG
 08B2  BE 2EE3 R			mov	si, offset UNIX_CRLF
					;call	PRINT_MSG
					; 22/01/2020
 08B5  E9 FC2C				jmp	PRINT_MSG
 08B8				@@:
 08B8  C3				retn
 08B9				todos_afow_yes:
 08B9  BE 2EBF R			mov	si, offset msg_YES
 08BC  E8 FC25				call	PRINT_MSG
 08BF  BE 2EE3 R			mov	si, offset UNIX_CRLF
 08C2  E8 FC1F				call	PRINT_MSG
 08C5				todos_crdf:
					;mov	dx, word ptr [arg]
 08C5  33 C9				xor	cx, cx ; File Attributes = 0
 08C7  B4 3C				mov	ah, 3Ch ; MS Dos Function = Create File
 08C9  CD 21				int	21h
					;jc	ci_error
					; 27/03/2022
 08CB  72 0F				jc	short todos_err2

 08CD  A3 2A73 R			mov	word ptr [FileHandle], ax
 08D0				todos_odf:
 08D0  8B 16 2C9A R			mov	dx, word ptr [arg]
 08D4  B4 3D				mov	ah, 3Dh ; MS Dos Function = Open File
 08D6  32 C0				xor	al, al  
 08D8  CD 21				int	21h
					;jc	ci_error
					; 27/03/2022
 08DA  73 03				jnc	short todos_ruf_wdf
 08DC				todos_err2:
 08DC  E9 0223				jmp	ci_error

 08DF				todos_ruf_wdf:
 08DF  33 C0				xor	ax, ax ; 0 
 08E1  A3 3A4C R			mov	word ptr [u_off], ax
					        ; 15/01/2020
 08E4  A3 3A4E R			mov	word ptr [u_off+2], ax ; 29/12/2019
 08E7				todos_wf_msg:
 08E7  BE 2E66 R			mov	si, offset Msg_writing_file
 08EA  E8 FBF7				call	PRINT_MSG
 08ED				todos_iget:	
					;mov	ax, word ptr [uf_i_number]
					; 26/12/2019
 08ED  8B 1E 3038 R			mov	bx, word ptr [uf_i_number]
 08F1  E8 0CF8				call	iget
 08F4  72 49				jc	short todos_cdf

					; 15/01/2020
 08F6  B9 0200				mov	cx, 512
 08F9				todos_read_unix_sf_1:
 08F9  A1 3044 R		       	mov	ax, word ptr [inode_size]
 08FC  8B 16 3046 R			mov	dx, word ptr [inode_size+2] 
 0900  2B 06 3A4C R			sub	ax, word ptr [u_off]
 0904  1B 16 3A4E R			sbb	dx, word ptr [u_off+2] 
 0908  75 08				jnz	short @f

 090A  23 C0				and	ax, ax
 090C  74 31				jz	short todos_cdf

 090E  3B C1				cmp	ax, cx ; 512
 0910  76 02				jna	short todos_read_unix_sf_2
 0912				@@:	
 0912  8B C1				mov	ax, cx ; 512
				;loc_read_unix_sf:
 0914				todos_read_unix_sf_2:	
 0914  A3 3A50 R			mov	word ptr [u_count], ax

 0917  C7 06 3A52 R 42B0 R		mov	word ptr [u_base], offset ReadBuffer

					;mov	ax, word ptr [uf_i_number] ; word ptr [u_dirbuf]
					; 26/12/2019
 091D  8B 1E 3038 R			mov	bx, word ptr [uf_i_number] ; word ptr [u_dirbuf]
 0921  E8 0C24				call	readi
 0924  72 19				jc	short todos_cdf
 0926				@@:
				;loc_write_dos_df:	
 0926  B4 40				mov	ah, 40h ; Write File
 0928  8B 0E 3A54 R			mov	cx, word ptr [u_nread] ; 0 -> eof
 092C  BA 42B0 R			mov	dx, offset ReadBuffer
 092F  8B 1E 2A73 R			mov	bx, word ptr [FileHandle]
 0933  CD 21				int	21h
 0935  72 08				jc	short todos_cdf

					;cmp	ax, cx ; write count = read count ? 
					;jne	short todos_cdf ; jb short todos_cdf

					;or	ax, ax  ; or cx, cx
					;;jnz	short loc_read_unix_sf ; ax = 512
					;; 15/01/2020
					;jnz	short todos_read_unix_sf_1

					; 15/01/2020
					;cmp	ax, 512
 0937  81 F9 0200			cmp	cx, 512 ; no..
 093B  74 BC				je	short todos_read_unix_sf_1 
							; there may be next sector to read

 093D  3B C1				cmp	ax, cx	; write count <= read count ? 
					;jb	short todos_cdf
					
					; If we are here (ax,cx < 512) 
					; it is end of file or there is a write error 
 093F				todos_cdf:
 093F  9C				pushf
 0940  72 47				jc	short @f
 0942				todos_set_dfdt:
 0942  A1 3078 R			mov	ax, word ptr [inode_ctim]   ; fromdos command ->
 0945  8B 16 307A R			mov	dx, word ptr [inode_ctim]+2 ; dos lmdt -> unix ctim

 0949  E8 15BF				call	convert_from_epoch

 094C  8B 16 309C R			mov	dx, word ptr [hour]
 0950  B1 0B				mov	cl, 11
 0952  D3 E2				shl	dx, cl   
 0954  A1 309E R			mov	ax, word ptr [minute]
 0957  B1 05				mov	cl, 5
 0959  D3 E0				shl	ax, cl
 095B  0B D0				or	dx, ax
 095D  A1 30A0 R			mov	ax, word ptr [second]
 0960  D1 E8				shr	ax, 1
 0962  0B C2				or	ax, dx
 0964  50				push	ax ; time
 0965  8B 16 3096 R			mov	dx, word ptr [year]
 0969  81 EA 07BC			sub	dx, 1980
 096D  B1 09				mov	cl, 9
 096F  D3 E2				shl	dx, cl   
 0971  A1 3098 R			mov	ax, word ptr [month]
 0974  B1 05				mov	cl, 5
 0976  D3 E0				shl	ax, cl
 0978  0B D0				or	dx, ax
 097A  A1 309A R			mov	ax, word ptr [day]
 097D  0B D0				or	dx, ax
 097F  59				pop	cx ; time

 0980  B8 5701				mov	ax, 5701h ; set lm date&time
 0983  8B 1E 2A73 R			mov	bx, word ptr [FileHandle]

 0987  CD 21				int	21h
 0989				@@:
 0989  B4 3E				mov	ah, 3Eh ; Close File
 098B  8B 1E 2A73 R			mov	bx, word ptr [FileHandle]
 098F  CD 21				int	21h
 0991  9D				popf
					;jc	ci_error
					; 27/03/2022
 0992  73 03				jnc	short todos_retn
 0994  E9 016B				jmp	ci_error
 0997				todos_retn:
 0997  BE 2EB8 R			mov	si, offset Msg_OK
 099A  E8 FB47				call	PRINT_MSG

 099D  BE 2EE3 R			mov	si, offset UNIX_CRLF
					;call	PRINT_MSG
					; 22/01/2020
 09A0  E9 FB41				jmp	PRINT_MSG	
 09A3				@@:	
 09A3  C3				retn
				; MKDIR
 09A4				loc_cmd_mkdir:
					; 30/12/2012
 09A4  3D 6B6D				cmp	ax, 'km'
 09A7  75 33				jne	short loc_cmd_rmdir
 09A9  AD				lodsw
 09AA  3D 6964				cmp	ax, 'id'
 09AD  75 F4				jne	short @b
 09AF  AC				lodsb	
 09B0  3C 72				cmp	al, 'r'	
 09B2  75 EF				jne	short @b
 09B4  AC				lodsb
 09B5  0A C0				or	al, al
 09B7  75 EA				jnz	short @b
 09B9				ci_mkdir_getarg1:
 09B9  89 36 3080 R			mov	word ptr [u_namep], si
 09BD  AC				lodsb
 09BE  3C 20				cmp	al, 20h
 09C0  74 F7				je	short ci_mkdir_getarg1
 09C2  72 DF				jb	short @b
 09C4				ci_mkdir_getarg2: ; 06/01/2013
 09C4  AC				lodsb
 09C5  3C 20				cmp	al, 20h
 09C7  77 FB				ja	short ci_mkdir_getarg2
 09C9  4E				dec	si
 09CA  32 C0				xor	al, al
 09CC  88 04				mov	byte ptr [SI], al
					
 09CE  BE 2EF8 R			mov	si, offset Msg_Making_Directory
 09D1  E8 FB10				call	PRINT_MSG

 09D4  E8 118A				call	make_directory
					;jc	ci_error
					; 27/03/2022
 09D7  72 46				jc	short ci_mkdir_err

 09D9  E9 0432				jmp	ci_sync_exit
				; RMDIR
 09DC				loc_cmd_rmdir:
					; 05/01/2013
 09DC  3D 6D72				cmp	ax, 'mr'
 09DF  75 61				jne	short loc_cmd_namei ; 17/02/2013
 09E1  AD				lodsw
 09E2  3D 6964				cmp	ax, 'id'
 09E5  75 BC				jne	short @b
 09E7  AC				lodsb	
 09E8  3C 72				cmp	al, 'r'	
 09EA  75 B7				jne	short @b
 09EC  AC				lodsb
 09ED  0A C0				or	al, al
 09EF  75 B2				jnz	short @b
 09F1				ci_rmdir_getarg1:
 09F1  89 36 3080 R			mov	word ptr [u_namep], si
 09F5  AC				lodsb
 09F6  3C 20				cmp	al, 20h
 09F8  74 F7				je	short ci_rmdir_getarg1
 09FA  72 A7				jb	short @b
					; 06/01/2013
 09FC  8A E0				mov	ah, al
 09FE				ci_rmdir_getarg2: 
 09FE  AC				lodsb
 09FF  3C 20				cmp	al, 20h
 0A01  77 FB				ja	short ci_rmdir_getarg2
 0A03  4E				dec	si
 0A04  32 C0				xor	al, al
 0A06  88 04				mov	byte ptr [SI], al
					
 0A08  B0 2E				mov	al, '.'
 0A0A  38 C4				cmp	ah, al ; dot
 0A0C  75 14				jne	short @f

 0A0E  8A 24				mov	ah, byte ptr [SI]
 0A10  80 FC 21				cmp	ah, 21h
					;jb	ci_error
					; 27/03/2022
 0A13  72 0A				jb	short ci_rmdir_err

 0A15  38 C4				cmp	ah, al ;'.' ; dotdot (parent dir)
 0A17  75 09				jne	short @f

 0A19  46				inc	si
 0A1A  80 3C 21				cmp	byte ptr [SI], 21h
					;jb	ci_error
 0A1D  73 03				jnb	short @f
 0A1F				ci_mkdir_err:
 0A1F				ci_rmdir_err:
 0A1F				namei_err:
 0A1F  E9 00E0			 	jmp	ci_error
 0A22				@@:
					; u_namep = pointer to directory path name

 0A22  E8 0A74				call	namei
					;jc	ci_error
					; 27/03/2022
 0A25  72 F8				jc	short ci_rmdir_err

					;cmp	ax, ROOT_DIR_INODE_NUMBER
 0A27  83 FB 01				cmp	bx, ROOT_DIR_INODE_NUMBER ; 29/12/2019
					;je	ci_error
					; 27/03/2022
 0A2A  74 F3				je	short ci_rmdir_err

					;cmp	ax, word ptr [u_cdir]
 0A2C  3B 1E 307E R			cmp	bx, word ptr [u_cdir] ; 29/12/2019
					;je	ci_error
					; 27/03/2022
 0A30  74 ED				je	short ci_rmdir_err

					;push ax
 0A32  53				push	bx ; 29/12/2019
 0A33  BE 2F0E R			mov	si, offset Msg_Removing_Directory
 0A36  E8 FAAB				call	PRINT_MSG
 0A39  58				pop	ax

 0A3A  E8 0883				call	remove_directory
					;jc	ci_error
					; 27/03/2022
 0A3D  72 E0				jc	short ci_rmdir_err

 0A3F  E9 03CC				jmp	ci_sync_exit

				; NAMEI	; 17/02/2013, print i-number of file/directory
 0A42				loc_cmd_namei:
 0A42  3D 616E				cmp	ax, 'an'
 0A45  75 51				jne	short loc_cmd_inode
 0A47  AD				lodsw
 0A48  3D 656D				cmp	ax, 'em'
 0A4B  75 2F				jne	short @f
 0A4D  AC				lodsb	
 0A4E  3C 69				cmp	al, 'i'	
 0A50  75 2A				jne	short @f
 0A52  AC				lodsb
 0A53  0A C0				or	al, al
 0A55  75 25				jnz	short @f
 0A57				namei_sf1:
 0A57  89 36 3080 R			mov	word ptr [u_namep], si
 0A5B  AC				lodsb
 0A5C  3C 20				cmp	al, 20h
 0A5E  74 F7				je	short namei_sf1
 0A60  72 1A				jb	short @f
 0A62				namei_sf2:
 0A62  AC				lodsb
 0A63  3C 20				cmp	al, 20h
 0A65  77 FB				ja	short namei_sf2
 0A67  4E				dec	si
 0A68  32 C0				xor	al, al
 0A6A  88 04				mov	byte ptr [SI], al
 0A6C				namei_fsf:
 0A6C  E8 0A2A				call	namei
 0A6F  73 0C				jnc	short namei_iget
 0A71  80 FC FF				cmp	ah, 0FFh
					;jb	ci_error
					; 27/03/2022
 0A74  72 A9				jb	short namei_err

 0A76  BE 325E R			mov	si, offset NotFound_msg
					;call	PRINT_MSG
					; 22/01/2020
 0A79  E9 FA68				jmp	PRINT_MSG
 0A7C				@@:
 0A7C  C3				retn
 0A7D				namei_iget:
					; 26/12/2019
					;mov	bx, ax
					; bx = inode number
 0A7D  E8 0B6C				call	iget
 0A80				namei_print_inum:
					;jc	ci_error
					; 27/03/2022
 0A80  72 9D				jc	short namei_err

					;mov	cx, ax
 0A82  8B CB				mov	cx, bx ; 29/12/2019
 0A84  BE 326E R			mov	si, offset msgINumber
 0A87  E8 FA5A				call	PRINT_MSG	
 0A8A  8B C1				mov	ax, cx
 0A8C  B9 0003				mov	cx, 3
 0A8F  E8 1C49				call	print_decimal_number
 0A92  BE 2EE3 R			mov	si, offset UNIX_CRLF
					;call	PRINT_MSG	
					;retn
					; 27/03/2022
 0A95  E9 FA4C				jmp	PRINT_MSG

				; INODE	; 17/02/2013, print inode structure/details
 0A98				loc_cmd_inode:
 0A98  3D 6E69				cmp	ax, 'ni'
 0A9B  75 DF				jne	short @b
 0A9D  AD				lodsw
 0A9E  3D 646F				cmp	ax, 'do'
 0AA1  75 D9				jne	short @b
 0AA3  AC				lodsb	
 0AA4  3C 65				cmp	al, 'e'	
 0AA6  75 D4				jne	short @b
 0AA8  AC				lodsb
 0AA9  0A C0				or	al, al
 0AAB  75 CF				jnz	short @b
 0AAD				inode_getarg1:
 0AAD  8B DE				mov	bx, si
 0AAF  AC				lodsb
 0AB0  3C 20				cmp	al, 20h
 0AB2  74 F9				je	short inode_getarg1
 0AB4  77 05				ja	short inode_getarg2
 0AB6  A1 3A5E R			mov	ax, word ptr [ii]
 0AB9  EB 0C				jmp	short @f
 0ABB				inode_getarg2:
 0ABB  AC				lodsb
 0ABC  3C 20				cmp	al, 20h
 0ABE  77 FB				ja	short inode_getarg2
 0AC0  4E				dec	si
 0AC1  33 C0				xor	ax, ax
 0AC3  88 04				mov	byte ptr [SI], al
 0AC5  8B F3				mov	si, bx
 0AC7				@@:
 0AC7  E8 1D69				call	show_inode
					;jc	ci_error
					; 27/03/2022
 0ACA  73 02				jnc	short @f
 0ACC				inode_err:
 0ACC  EB 34				jmp	ci_error
 0ACE				@@:	
 0ACE  C3				retn

 0ACF				cl3:
 0ACF  80 F9 03				cmp	cl, 3
 0AD2  72 56				jb	short cl2
				; DIR
 0AD4				loc_cmd_dir:	; 05/01/2013 @b->@f, dir_print modifications
 0AD4  3D 6964				cmp	ax, 'id'
					;jne	short @f
 0AD7  75 3C				jne	short cls
 0AD9  AC				lodsb
 0ADA  3C 72				cmp	al, 'r'
 0ADC  75 2A				jne	short @f
 0ADE  AC				lodsb
 0ADF  0A C0				or	al, al
 0AE1  75 25				jnz	short @f
 0AE3  A2 3192 R			mov	byte ptr [ls_option], al ; 20/01/2013
 0AE6				dir_getarg:	; 30/12/2012
 0AE6  AC				lodsb
 0AE7  3C 20				cmp	al, 20h
 0AE9  74 FB				je	short dir_getarg
 0AEB  73 04				jnb	short dir_namei
 0AED				ls_getarg3:
 0AED  33 C0				xor	ax, ax
 0AEF  EB 0C				jmp	short dir_print
 0AF1				dir_namei:      ; 30/12/2012
 0AF1  4E				dec	si
 0AF2  89 36 3080 R			mov	word ptr [u_namep], si
					;call	namei
 0AF6  E8 09A4				call	namei_x ; 02/10/2019	
 0AF9  72 07				jc	short ci_error
 0AFB  8B C3				mov	ax, bx ; 29/12/2019
					; ax = i-number
 0AFD				dir_print:
 0AFD  E8 046F				call	print_directory_list
 0B00  73 06				jnc	short @f
 0B02				ci_error:
 0B02  BE 2EDA R			mov	si, offset error_msg
					;call	PRINT_MSG
					; 22/01/2020
 0B05  E9 F9DC				jmp	PRINT_MSG
 0B08				@@:	
 0B08  C3				retn
				; 23/02/2013
 0B09				cl1:
 0B09  3C 3F				cmp	al, '?'
 0B0B  75 FB				jne	short @b
 0B0D  80 FC 00				cmp	ah, 0
					;je	ci_?
					; 27/03/2022
 0B10  75 F6				jne	short @b
 0B12  E9 FC50				jmp	ci_?
				;@@:	
				;	retn
 0B15				cls:
				; 25/09/2019 - Retro UNIX 386 v2 ('cls' command)
 0B15  3D 6C63				cmp	ax,'lc'
 0B18  75 EE				jne	short @b
 0B1A  AC				lodsb
 0B1B  3C 73				cmp	al,'s'
 0B1D  75 E9				jne	short @b
 0B1F  AC				lodsb
 0B20  22 C0				and	al, al
 0B22  75 E4				jnz	short @b

					; clear screen.. (by setting video mode to 3 again) 		 
 0B24  B8 0003				mov	ax,3
 0B27  CD 10				int	10h
 0B29				@@:
 0B29  C3				retn
				; 16/12/2012
 0B2A				cl2:
 0B2A  80 F9 02				cmp	cl, 2
 0B2D  72 DA				jb	short cl1 ; 23/02/2013
					;jb	@b
				; CD (CHDIR)
 0B2F				loc_cmd_cd:
 0B2F  3D 6463				cmp	ax, 'dc'
 0B32  75 08				jne	short loc_cmd_ls
 0B34  AC				lodsb
 0B35  0A C0				or	al, al
 0B37  75 F0				jnz	short @b
 0B39  E9 FC4F				jmp	ci_cd_getarg
				; LS (DIR)
 0B3C				loc_cmd_ls:	; 20/01/2013
 0B3C  3D 736C				cmp	ax, 'sl'
 0B3F  75 2B				jne	short loc_cmd_rm
 0B41  AC				lodsb
 0B42  0A C0				or	al, al
 0B44  75 E3				jnz	short @b
 0B46  C6 06 3192 R 01			mov	byte ptr [ls_option], 1
 0B4B				ls_getarg1:	; 21/01/2013
 0B4B  AC				lodsb
 0B4C  3C 20				cmp	al, 20h
 0B4E  74 FB				je	short ls_getarg1
 0B50  72 9B				jb	short ls_getarg3
 0B52				ls_getarg2:
 0B52  3C 2D				cmp	al,'-'
 0B54  75 9B				jne	short dir_namei
 0B56  AC				lodsb
 0B57  3C 6C				cmp	al, 'l'
 0B59  75 92				jne	short ls_getarg3
 0B5B				ls_getarg4:
 0B5B  AC				lodsb
 0B5C  FE 06 3192 R			inc	byte ptr [ls_option]
 0B60  3C 20				cmp	al, 20h
 0B62  74 82				je	short dir_getarg
 0B64  72 87				jb	short ls_getarg3
 0B66  FE 0E 3192 R			dec	byte ptr [ls_option]
 0B6A  EB 81				jmp	short ls_getarg3
				; RM
 0B6C				loc_cmd_rm:	
 0B6C  3D 6D72				cmp	ax, 'mr'
					;jne	loc_cmd_fs ; 16/02/2013
					; 27/03/2022
 0B6F  74 03				je	short rm_chr3
 0B71  E9 00B9				jmp	loc_cmd_fs
 0B74				rm_chr3:
 0B74  AC				lodsb
 0B75  0A C0				or	al, al
 0B77  75 B0				jnz	short @b
 0B79				rm_getarg:
 0B79  89 36 3080 R			mov	word ptr [u_namep], si
 0B7D  AC				lodsb
 0B7E  3C 20				cmp	al, 20h
 0B80  74 F7				je	short rm_getarg
 0B82  72 A5				jb	short @b
 0B84				rm_namei:
 0B84  E8 0912				call	namei
 0B87  72 34				jc	short rm_err
 0B89				@@:
					;cmp	word ptr [ii], 41	; i-number of the directory
					;jne	short @f

 0B89  BE 3AC2 R			mov	si, offset BSBuffer.bs_BF_I_number
					;cmp	ax, word ptr [si]	; is it i-number of the boot file
 0B8C  3B 1C				cmp	bx, word ptr [si] ; 29/12/2019
					;je	short ci_error
 0B8E  75 0B				jne	short @f

					;cmp	word ptr [ii], 41	; i-number of root directory
 0B90  83 3E 3A5E R 01			cmp	word ptr [ii], 1	; 25/09/2019 - Retro UNIX 386 v2
					;je	ci_error
					; 27/03/2022
 0B95  74 26				je	short rm_err

 0B97  C7 04 0000			mov	word ptr [si], 0  ; reset wrong boot file configuration
 0B9B				@@:	
					;mov	word ptr [uf_i_number], ax ; word ptr [u_dirbuf]
					; 29/12/2019
 0B9B  89 1E 3038 R			mov	word ptr [uf_i_number], bx	

					; 05/01/2013
 0B9F  8B 16 3A5E R			mov	dx, word ptr [ii]
 0BA3  89 16 2C96 R			mov	word ptr [pdir], dx
					; 26/12/2019
					;mov	bx, ax ; inode number
 0BA7  E8 0A42				call	iget
					;jc	ci_error
					; 27/03/2022
 0BAA  72 11				jc	short rm_err
				;@@:
 0BAC  A1 303C R			mov	ax, word ptr [inode_flgs]
					; 25/09/2019 - Retro UNIX 386 v2
					;	(modified unix v7 inode format)
 0BAF  F6 C4 80				test 	ah, 80h
					;jz	ci_error  ; not regular file or directory
					; 27/03/2022
 0BB2  74 09				jz	short rm_err
					
 0BB4  F6 C4 40				test 	ah, 40h ; 'directory' flag
					;jnz	ci_error
					; 27/03/2022
 0BB7  75 04				jnz	short rm_err

 0BB9  A8 80				test 	al, 80h ; owner's write permission
					;jz	ci_error  ; read only file !
					; 27/03/2022
 0BBB  75 03				jnz	short rm_move_fn
 0BBD				rm_err:
 0BBD  E9 FF42				jmp	ci_error

 0BC0				rm_move_fn:
 0BC0  BE 3088 R			mov	si, offset u_dirbuf + 2
 0BC3  BF 3025 R			mov	di, offset Boot_File_Name
 0BC6  B9 000E				mov	cx, 14  ; 04/12/2015 (8 -> 14)
 0BC9				@@:
 0BC9  AC				lodsb
 0BCA  22 C0				and	al, al
 0BCC  74 05				jz	short @f
 0BCE  AA				stosb
 0BCF  E2 F8				loop	@b
 0BD1  32 C0				xor	al, al ; 06/01/2013
 0BD3				@@:
 0BD3  88 05				mov	byte ptr [di], al ; 0

 0BD5  BE 2FEF R			mov	si, offset msg_remove_question1
 0BD8  E8 F909				call	PRINT_MSG
 0BDB  BE 3025 R			mov	si, Offset Boot_File_Name
 0BDE  E8 F903				call	PRINT_MSG
 0BE1  BE 3009 R			mov	si, offset msg_remove_question2
 0BE4  E8 F8FD				call	PRINT_MSG
 0BE7  BE 2C9E R			mov	si, offset msg_yes_no
 0BEA  E8 F8F7				call	PRINT_MSG
 0BED				rm_yn_input:	; ask for remove
 0BED  33 C0				xor	ax, ax
 0BEF  CD 16				int	16h		; wait for keyboard command
 0BF1  3C 03				cmp	al, 'C'-40h
 0BF3  74 1A				je	short @f	   
 0BF5  3C 1B				cmp	al, 27
 0BF7  74 16				je	short @f
 0BF9  24 DF				and	al, 0DFh
 0BFB  3C 59				cmp	al, 'Y'		; Yes?
 0BFD  74 11				je	short rm_a_yes	; overwrite
 0BFF  3C 4E				cmp	al, 'N'		; No?
 0C01  75 EA				jne	short rm_yn_input         
 0C03				rm_a_no:
 0C03  BE 2EC4 R			mov	si, offset msg_No
 0C06  E8 F8DB				call	PRINT_MSG
 0C09  BE 2EE3 R			mov	si, offset UNIX_CRLF
					;call	PRINT_MSG
					; 22/01/2020
 0C0C  E9 F8D5				jmp	PRINT_MSG
 0C0F				@@:
 0C0F  C3				retn
 0C10				rm_a_yes:
 0C10  BE 2EBF R			mov	si, offset msg_YES
 0C13  E8 F8CE				call	PRINT_MSG
 0C16  BE 2EE3 R			mov	si, offset UNIX_CRLF
 0C19  E8 F8C8				call	PRINT_MSG
 0C1C				rm_unlink:
 0C1C  BE 2E78 R			mov	si, offset Msg_removing_file
 0C1F  E8 F8C2				call	PRINT_MSG

 0C22  A1 3038 R			mov	ax, word ptr [uf_i_number]
 0C25  E8 0753				call	unlink
					;jc	ci_error
					; 27/03/2022
 0C28  72 93				jc	short rm_err
					
 0C2A  E9 01E1				jmp	ci_sync_exit

				; FS (Volume)  ; 16/02/2013   (File System / Volume Info)
 0C2D				loc_cmd_fs:
 0C2D  3D 7366				cmp	ax, 'sf'
 0C30  75 DD				jne	short @b
 0C32  AC				lodsb
 0C33  0A C0				or	al, al
 0C35  75 D8				jnz	short @b
 0C37				vol_infO_print:
 0C37				fs_info_print:
 0C37  E8 1B47				call	print_volume_info
 0C3A				@@:
 0C3A  C3				retn
 0C3B				cl6: ; 16/02/2013	
 0C3B  80 F9 06				cmp	cl, 6
 0C3E  75 FA				jne	short @b 

				; VOLUME (fs)  ; 16/02/2013
 0C40				loc_cmd_volume:
 0C40  3D 6F76				cmp	ax, 'ov'
 0C43  75 F5				jne	short @b
 0C45  AD				lodsw
 0C46  3D 756C				cmp	ax, 'ul'
 0C49  75 EF				jne	short @b
 0C4B  AD				lodsw
 0C4C  3D 656D				cmp	ax, 'em'
 0C4F  75 E9				jne	short @b
 0C51  AC				lodsb
 0C52  0A C0				or	al, al
 0C54  74 E1				jz	short vol_infO_print
 0C56				@@:
 0C56  C3				retn
				; 15/12/2012
 0C57				cl7:
 0C57  80 F9 07				cmp	cl, 7
					;jb	cl6 ; 16/02/2013
					;ja	cl8
					; 27/03/2022
 0C5A  74 05				je	short loc_cmd_fromdos
 0C5C  72 DD				jb	short cl6
 0C5E  E9 01BF				jmp	cl8
				; FROMDOS
 0C61				loc_cmd_fromdos:
 0C61  3D 7266				cmp	ax, 'rf'
 0C64  75 F0				jne	short @b
 0C66  AD				lodsw
 0C67  3D 6D6F				cmp	ax, 'mo'
 0C6A  75 EA				jne	short @b
 0C6C  AD				lodsw
 0C6D  3D 6F64				cmp	ax, 'od'
 0C70  75 E4				jne	short @b
 0C72  AC				lodsb	
 0C73  3C 73				cmp	al, 's'	
 0C75  75 DF				jne	short @b
 0C77  AC				lodsb
 0C78  0A C0				or	al, al
 0C7A  75 DA				jnz	short @b
 0C7C				fromdos_df1:
 0C7C  89 36 2C9A R			mov	word ptr [arg], si
 0C80  AC				lodsb
 0C81  3C 20				cmp	al, 20h
 0C83  74 F7				je	short fromdos_df1
 0C85  72 CF				jb	short @b
 0C87				fromdos_df2:
 0C87  AC				lodsb
 0C88  3C 20				cmp	al, 20h
 0C8A  77 FB				ja	short fromdos_df2
 0C8C  32 C0				xor	al, al
 0C8E  88 44 FF				mov	byte ptr [si]-1, al
 0C91				fromdos_uf1:
 0C91  89 36 3080 R			mov	word ptr [u_namep], si
 0C95  AC				lodsb
 0C96  3C 20				cmp	al, 20h
 0C98  74 F7				je	short fromdos_uf1
 0C9A  72 BA				jb	short @b
 0C9C				fromdos_uf2:
 0C9C  AC				lodsb
 0C9D  3C 20				cmp	al, 20h
 0C9F  77 FB				ja	short fromdos_uf2
 0CA1  4E				dec	si
 0CA2  32 C0				xor	al, al
 0CA4  88 04				mov	byte ptr [si], al
 0CA6				fromdos_fdf:
 0CA6  8B 16 2C9A R			mov	dx, word ptr [arg]
 0CAA  B9 0027				mov	cx, 27h ; File Attributes
 0CAD  B4 4E				mov	ah, 4Eh ; MS DOS Function = Find First File
 0CAF  CD 21				int	21h
					;jc	ci_error ; file not found
					; 27/03/2022
 0CB1  73 03				jnc	short fromdos_fuf
 0CB3				fromdos_err:
 0CB3  E9 FE4C				jmp	ci_error
 0CB6				fromdos_fuf:
 0CB6  E8 07E0				call	namei
 0CB9  73 0D				jnc	short @f

 0CBB  80 FC FF				cmp	ah, 0FFh
					;jne	ci_error
					; 27/03/2022
 0CBE  75 F3				jne	short fromdos_err
					
 0CC0  33 C0				xor	ax, ax
 0CC2  A3 3038 R			mov	word ptr [uf_i_number], ax ; 0
 0CC5  E9 0081				jmp	fromdos_s_fs_mdt
 0CC8				@@:
					;mov	word ptr [uf_i_number], ax
					; 29/12/2019
 0CC8  89 1E 3038 R			mov	word ptr [uf_i_number], bx

					; 30/09/2019
					; 05/01/2013
					;mov	dx, word ptr [ii]
					;mov	word ptr [pdir], dx
					; 26/12/2019
					;mov	bx, ax ; inode number
 0CCC  E8 091D				call	iget
					;jc	ci_error
					; 27/03/2022
 0CCF  72 E2				jc	short fromdos_err

 0CD1  A1 303C R			mov	ax, word ptr [inode_flgs]
					; 25/09/2019 - Retro UNIX 386 v2
					;	(modified unix v7 inode format)
 0CD4  F6 C4 80				test 	ah, 80h
					;jz	ci_error  ; not regular file or directory	
					; 27/03/2022
 0CD7  74 DA				jz	short fromdos_err

 0CD9  F6 C4 40				test 	ah, 40h ; 'directory' flag
					;jnz	ci_error
					; 27/03/2022
 0CDC  75 D5				jnz	short fromdos_err

 0CDE  A8 80				test 	al, 80h ; owner's write permission
					;jz	ci_error  ; read only file !
					; 27/03/2022
 0CE0  74 D1				jz	short fromdos_err

 0CE2				fromdos_afow:
 0CE2  BE 3088 R			mov	si, offset u_dirbuf + 2
 0CE5  BF 3025 R			mov	di, offset Boot_File_Name
 0CE8  B9 000E				mov	cx, 14 ; 04/12/2015 (8 -> 14)
 0CEB				@@:
 0CEB  AC				lodsb
 0CEC  22 C0				and	al, al
 0CEE  74 05				jz	short @f
 0CF0  AA				stosb
 0CF1  E2 F8				loop @b
 0CF3  32 C0				xor	al, al ; 01/03/2013
 0CF5				@@:
 0CF5  88 05				mov	byte ptr [di], al ; 0

 0CF7  BE 2FCA R			mov	si, offset msg_overwrite_question1
 0CFA  E8 F7E7				call	PRINT_MSG
 0CFD  BE 3025 R			mov	si, Offset Boot_File_Name
 0D00  E8 F7E1				call	PRINT_MSG
 0D03  BE 2FE7 R			mov	si, offset msg_overwrite_question2
 0D06  E8 F7DB				call	PRINT_MSG
 0D09  BE 2C9E R			mov	si, offset msg_yes_no
 0D0C  E8 F7D5				call	PRINT_MSG
 0D0F				fromdos_afow_input:  ; ask for overwrite
 0D0F  33 C0				xor	ax, ax
 0D11  CD 16				int	16h		; wait for keyboard command
 0D13  3C 03				cmp	al, 'C'-40h
 0D15  74 1A				je	short @f	   
 0D17  3C 1B				cmp	al, 27
 0D19  74 16				je	short @f
 0D1B  24 DF				and	al, 0DFh
 0D1D  3C 59				cmp	al, 'Y'		; Yes?
 0D1F  74 11				je	short fromdos_afow_yes    	; overwrite
 0D21  3C 4E				cmp	al, 'N'	     ; No?
 0D23  75 EA				jne	short fromdos_afow_input         
 0D25				fromdos_afow_no:
 0D25  BE 2EC4 R			mov	si, offset msg_No
 0D28  E8 F7B9				call	PRINT_MSG
 0D2B  BE 2EE3 R			mov	si, offset UNIX_CRLF
					;call	PRINT_MSG
					; 22/01/2020
 0D2E  E9 F7B3				jmp	PRINT_MSG	
 0D31				@@:
 0D31  C3				retn
 0D32				fromdos_afow_yes:
 0D32  BE 2EBF R			mov	si, offset msg_YES
 0D35  E8 F7AC				call	PRINT_MSG
 0D38  BE 2EE3 R			mov	si, offset UNIX_CRLF
 0D3B  E8 F7A6				call	PRINT_MSG
 0D3E				fromdos_uf_itrunc:
					; 30/09/2019
					; 05/01/2013
					;mov	bx, word ptr [pdir] ; 26/12/2019 (ax -> bx)
					;call	iget
					;jc	ci_error
					;
 0D3E  A1 3038 R			mov	ax, word ptr [uf_i_number]
 0D41  E8 172E				call	itrunc ; truncate file
					;jc	ci_error
					; 27/03/2022
 0D44  73 03				jnc	short fromdos_s_fs_mdt
 0D46  E9 FDB9				jmp	ci_error
 0D49				fromdos_s_fs_mdt:
					; 15/12/2012
					; Derived from UNIXBOOT.ASM (30/11/2012)

					; 14/01/2020 (32 bit file size permission)
					;;mov	si, DTA_FileSize
					;mov	si, DTA_FileSize+2
					;;mov	ax, word ptr [si]
					;;mov	dx, word ptr [si]+2
					;;or	ax, dx  ; 64KB file size limit
					;mov	ax, word ptr [si]
					;and	ax, ax
					;jnz	ci_error

					;mov	word ptr [file_Size], ax
					; 01/01/2020	
					;mov	word ptr [file_Size+2], dx

 0D49  BE 0098				mov	si, DTA_Date
 0D4C  8B 04				mov	ax, word ptr [si]
 0D4E  50				push	ax
 0D4F  83 E0 1F				and	ax, 00011111b	         ; Day Mask
 0D52  A3 309A R			mov	word ptr [day], ax
 0D55  58				pop	ax
 0D56  B1 05			     	mov	cl, 5
 0D58  D3 E8				shr     ax, cl	   ; shift right 5 times
 0D5A  50				push 	ax 
 0D5B  83 E0 0F				and	ax, 00001111b            ; Month Mask
 0D5E  A3 3098 R		  	mov	word ptr [month], ax
 0D61  58				pop	ax
 0D62  B1 04				mov	cl, 4
 0D64  D3 E8				shr	ax, cl
					;and    ax, 01111111b            ; Result = Year - 1980
 0D66  05 07BC				add	ax, 1980
 0D69  A3 3096 R			mov	word ptr [year], ax
				 		
 0D6C  BE 0096				mov	si, DTA_Time
 0D6F  8B 04				mov	ax, word ptr [si]
 0D71  50				push	ax
 0D72  83 E0 1F				and	ax, 0000011111b          ; Second Mask
 0D75  D0 E0				shl	al, 1	 
 0D77  A3 30A0 R			mov	word ptr [second], ax
 0D7A  58				pop	ax
 0D7B  B1 05				mov	cl, 5
 0D7D  D3 E8				shr     ax, cl	   ; shift right 5 times
 0D7F  50				push	ax
 0D80  83 E0 3F				and	ax, 0000111111b          ; Minute Mask
 0D83  A3 309E R			mov	word ptr [minute], ax
 0D86  58				pop	ax
 0D87  B1 06				mov	cl, 6	   ; shift right 6 times
 0D89  D3 E8				shr     ax, cl	   ; (6+5=11)
 0D8B  A3 309C R			mov	word ptr [hour], ax	 ; ax = hours	

 0D8E  E8 10FE				call	convert_to_epoch

 0D91  A3 3034 R			mov	word ptr [uf_make_datetime], ax
 0D94  89 16 3036 R			mov	word ptr [uf_make_datetime]+2, dx
 0D98				fromdos_odf:
 0D98  8B 16 2C9A R			mov	dx, word ptr [arg]
 0D9C  B4 3D				mov	ah, 3Dh ; MS DOS Function = Open File
 0D9E  32 C0				xor	al, al  
 0DA0  CD 21				int	21h
					;jc	ci_error
					; 27/03/2022
 0DA2  73 03				jnc	short @f
 0DA4				fromdos_of_err:
 0DA4				fromdos_cf_err:
 0DA4  E9 FD5B				jmp	ci_error
 0DA7				@@:
 0DA7  A3 2A73 R			mov	word ptr [FileHandle], ax
					
 0DAA  A1 3038 R			mov	ax, word ptr [uf_i_number]
					; 23/02/2013
 0DAD  23 C0				and	ax, ax
 0DAF  74 07				jz	short @f
					;jnz	short fromdos_wf_msg  ;@f
 0DB1  33 C0				xor	ax, ax
 0DB3  E8 04B2				call	fromdos_maknod
					; 27/03/2022
					; (As result of adding [uf_i_number] check code in maknod,
					;  increasing free inode count here is not needed.)
					; ((otherwise, free inode count would need to be increased
					;   again; because maknod was decreasing it
					;   -before this modification-))
					; 27/03/2022	
					;inc	word ptr [systm.sb_FreeInodes]  ; (bugfix)

 0DB6  EB 0B				jmp	short fromdos_wf_msg
 0DB8				@@: ; fromdos_mknod:
					;mov	ax, i_flags ; 1Eh (unix v1), 01EDh (Runix v2)
					; 25/09/2019 - Retro UNIX 386 v2
 0DB8  B8 81ED				mov	ax, 81EDh ; (1000000111101101b)	 
 0DBB  E8 0446				call	mak_nod
 0DBE  72 37				jc	short fromdos_cf
					; 04/01/2020
 0DC0  A3 3038 R			mov	word ptr [uf_i_number], ax
 0DC3				fromdos_wf_msg:
 0DC3  BE 2E66 R			mov	si, offset Msg_writing_file
 0DC6  E8 F71B				call	PRINT_MSG
 0DC9				@@:	; 16/12/2012
 0DC9  33 C0				xor	ax, ax 
 0DCB  A3 3A4C R			mov	word ptr [u_off], ax  ; 0
					; 14/01/2020
 0DCE  A3 3A4E R			mov	word ptr [u_off+2], ax ; 29/12/2019 
 0DD1				@@:
				;loc_read_dos_sf:	
 0DD1  B4 3F				mov	ah, 3Fh ; Read File
 0DD3  B9 0200				mov	cx, 512
 0DD6  BA 42B0 R			mov	dx, offset ReadBuffer
 0DD9  8B 1E 2A73 R			mov	bx, word ptr [FileHandle]
 0DDD  CD 21				int	21h
 0DDF  72 16				jc	short fromdos_cf

 0DE1  0B C0				or	ax, ax
 0DE3  74 12				jz	short fromdos_cf
					
 0DE5  A3 3A50 R			mov	word ptr [u_count], ax
 0DE8				ght:
 0DE8  C7 06 3A52 R 42B0 R		mov	word ptr [u_base], offset ReadBuffer

					;mov	ax, word ptr [uf_i_number] ; word ptr [u_dirbuf]
					; 29/12/2019
 0DEE  8B 1E 3038 R			mov	bx, word ptr [uf_i_number]

 0DF2  E8 0DF9				call	writei
 0DF5  73 DA				jnc	short short @b ; loc_read_dos_sf
 0DF7				fromdos_cf:
 0DF7  9C				pushf
 0DF8  B4 3E				mov	ah, 3Eh ; Close File
 0DFA  8B 1E 2A73 R			mov	bx, word ptr [FileHandle]
 0DFE  CD 21				int	21h
 0E00  9D				popf
					;jc	ci_error
					; 27/03/2022
 0E01  72 A1				jc	short fromdos_cf_err
 0E03				@@:
					; 23/02/2013
 0E03  33 C0				xor	ax, ax
 0E05  A3 3074 R			mov	word ptr [inode_mtim], ax
 0E08  A3 3076 R			mov	word ptr [inode_mtim]+2, ax
					
					; 20/09/2019 - Retro UNIX v2
					;mov	word ptr [inode_atim], ax
					;mov	word ptr [inode_atim]+2, ax

 0E0B  E8 0CEF				call	setimod
 0E0E				ci_sync_exit:
 0E0E  E8 1197				call	sync
					;jc	ci_error
					; 27/03/2022
 0E11  72 50				jc	short ci_sync_err
 0E13				fromdos_retn:
 0E13  BE 2EB8 R			mov	si, offset Msg_OK
 0E16  E8 F6CB				call	PRINT_MSG

 0E19  BE 2EE3 R			mov	si, offset UNIX_CRLF
					;call	PRINT_MSG
					; 22/01/2020
 0E1C  E9 F6C5				jmp	PRINT_MSG
 0E1F				@@:	
 0E1F  C3				retn
 0E20				cl8:
 0E20  80 F9 08				cmp	cl, 8
					;;jb	short @b
					;ja	cl10
					; 27/03/2022
 0E23  76 03				jna	short loc_cmd_bootfile
 0E25  E9 0081				jmp	cl10   
				; BOOTFILE
 0E28				loc_cmd_bootfile:
 0E28  3D 6F62				cmp	ax, 'ob'
 0E2B  75 F2				jne	short @b
 0E2D  AD				lodsw
 0E2E  3D 746F				cmp	ax, 'to'
 0E31  75 EC				jne	short @b
 0E33  AD				lodsw
 0E34  3D 6966				cmp	ax, 'if'
 0E37  75 E6				jne	short @b
 0E39  AD				lodsw	
 0E3A  3D 656C				cmp	ax, 'el'	
 0E3D  75 E0				jne	short @b
 0E3F  AC				lodsb
 0E40  0A C0				or	al, al
 0E42  75 DB				jnz	short @b
 0E44				@@:
 0E44  89 36 3080 R			mov	word ptr [u_namep], si
 0E48  AC				lodsb
 0E49  3C 20				cmp	al, 20h
 0E4B  74 F7				je	short @b
 0E4D  77 2D				ja	short ci_bf_namei

 0E4F  BE 3AC2 R			mov	si, offset BSBuffer.bs_BF_I_number
 0E52  8B 04				mov	ax, word ptr [SI]
 0E54  23 C0				and	ax, ax
 0E56  75 06				jnz	short @f
 0E58				ci_no_bootfile:	
 0E58  BE 2F4A R			mov	si, offset msg_Startup_File_Not_Exists
					;call	PRINT_MSG
					;retn
					; 20/09/2019
 0E5B  E9 F686				jmp	PRINT_MSG	
 0E5E				@@:
 0E5E  E8 13F6				call	find_bfn
					;jc	ci_error
					; 27/03/2022
 0E61  73 03				jnc	short ci_move_bfn_1
 0E63				ci_sync_err:
 0E63				find_bfn_err:
 0E63				new_bf_err:
 0E63  E9 FC9C				jmp	ci_error

 0E66				ci_move_bfn_1:
 0E66  BE 3088 R			mov	si, offset u_dirbuf + 2
 0E69  BF 3025 R			mov	di, offset Boot_File_Name
 0E6C  B9 000E				mov	cx, 14 ; ; 04/12/2015 (8 -> 14)
 0E6F				ci_move_bfn_2:
 0E6F  AC				lodsb
					; 04/12/2015
 0E70  22 C0				and	al, al
 0E72  74 03				jz	short ci_move_bfn_3
 0E74  AA				stosb
 0E75  E2 F8				loop ci_move_bfn_2
 0E77				ci_move_bfn_3:
 0E77  88 05				mov	byte ptr [di], al ; 0
					;
					;call	proc_display_startupfile_info
					;retn
					; 20/09/2019
 0E79  E9 141C				jmp	proc_display_startupfile_info	
 0E7C				ci_bf_namei:
 0E7C  E8 061A				call	namei
					;jc	ci_error
					; 27/03/2022
 0E7F  72 E2				jc	short new_bf_err

					; 29/12/2019
					; bx = inode number
					
 0E81  83 3E 3A5E R 01			cmp	word ptr [ii], ROOT_DIR_INODE_NUMBER
					;jne	ci_error
					; 27/03/2022
 0E86  75 DB				jne	short new_bf_err

					; 05/01/2013
					; ax = i-number of (new) boot file
					;mov	bx, ax ; 26/12/2019
 0E88  E8 0761				call	iget
					;jc	ci_error
					; 27/03/2022
 0E8B  72 D6				jc	short new_bf_err

					;test 	word ptr [inode_flgs], 4000h ; directory ?
 0E8D  F6 06 303D R 40			test 	byte ptr [inode_flgs+1], 40h ; 25/09/2019
					;jnz	ci_error
					; 27/03/2022
 0E92  75 CF				jnz	short new_bf_err

					;test 	byte ptr [inode_flgs+1], 80h ; 25/09/2019
					;jnz	ci_error
				;@@:
					;mov	si, offset BSBuffer.bs_BF_I_number
					;;mov	word ptr [si], ax
					;; 29/12/2019
					;mov	word ptr [si], bx
					; 22/01/2020
 0E94  89 1E 3AC2 R			mov	word ptr [BSBuffer.bs_BF_I_number], bx

					; 05/01/2020
 0E98  C6 06 3A58 R FF			mov	byte ptr [bmod], 0FFh ; boot sector modified!	 

 0E9D  E8 1108				call	sync
					;jc	ci_error
					; 27/03/2022
 0EA0  72 C1				jc	short ci_sync_err

 0EA2  BE 2F74 R			mov	si, offset msg_sf_configuration_set_ok
					;call	PRINT_MSG
				;@@:
					;retn
					; 20/09/2019
 0EA5  E9 F63C				jmp	PRINT_MSG
 0EA8				@@:
					; 22/01/2020
 0EA8  C3				retn 	
 0EA9				cl10:
 0EA9  80 F9 0A				cmp	cl, 10
					;jne	short @f ; retn
 0EAC  75 FA				jne	short @b ; 22/01/2020 
				; NOBOOTFILE
 0EAE				loc_cmd_nobootfile:
 0EAE  3D 6F6E				cmp	ax, 'on'
					;jne	short @f
 0EB1  75 F5				jne	short @b ; 22/01/2020 
 0EB3  AD				lodsw
 0EB4  3D 6F62				cmp	ax, 'ob'
					;jne	short @f
 0EB7  75 EF				jne	short @b ; 22/01/2020 
 0EB9  AD				lodsw
 0EBA  3D 746F				cmp	ax, 'to'
					;jne	short @f
 0EBD  75 E9				jne	short @b ; 22/01/2020 
 0EBF  AD				lodsw
 0EC0  3D 6966				cmp	ax, 'if'
					;jne	short @f
 0EC3  75 E3				jne	short @b ; 22/01/2020 
 0EC5  AD				lodsw	
 0EC6  3D 656C				cmp	ax, 'el'	
					;jne	short @f
 0EC9  75 DD				jne	short @b ; 22/01/2020 
 0ECB  AC				lodsb
 0ECC  0A C0				or	al, al
					;jnz	short @f
 0ECE  75 D8				jnz	short @b ; 22/01/2020 

 0ED0  BE 3AC2 R			mov	si, offset BSBuffer.bs_BF_I_number

					; 22/01/2020
 0ED3  8B 04				mov	ax, word ptr [si]

 0ED5  23 C0				and	ax, ax
					;jz	ci_no_bootfile
					; 27/03/2022
 0ED7  75 03				jnz	short @f
 0ED9  E9 FF7C				jmp	ci_no_bootfile
 0EDC				@@:
 0EDC  33 C0				xor	ax, ax
 0EDE  89 04				mov	word ptr [si], ax ; 0

					; 22/01/2020
 0EE0  C6 06 3A58 R FF			mov	byte ptr [bmod], 0FFh ; boot sector modified!

 0EE5  E8 10C0				call	sync
					;jc	ci_error
					; 27/03/2022
 0EE8  73 03				jnc	short @f
 0EEA  E9 FC15				jmp	ci_error
 0EED				@@:
 0EED  BE 2F9E R			mov	si, msg_sf_configuration_reset_ok

					; 22/01/2020
					;call	PRINT_MSG
				;@@:
					;retn
					; 22/01/2020
 0EF0  E9 F5F1				jmp	PRINT_MSG

 0EF3				command_interpreter endp

 0EF3				update_cdir_string proc near
					; 13/01/2013 bugfix
					; 10/12/2012
					; 09/12/2012
					; input -> SI= chdir argument
 0EF3				ucds_0:
 0EF3  BB 2C20 R			mov	bx, offset unix_cdir
 0EF6  43				inc	bx ; 13/01/2013
 0EF7  8B FB				mov	di, bx
 0EF9  AC				lodsb
 0EFA  3C 2F				cmp	al, '/'
 0EFC  75 08				jne	short @f
 0EFE  33 D2				xor	dx, dx
 0F00  89 16 2C46 R			mov	word ptr [CDirOffset], dx
 0F04  EB 11				jmp	short ucds_6
 0F06				@@:
 0F06  8B 16 2C46 R			mov	dx, word ptr [CDirOffset]
					; 13/01/2013
 0F0A  0B D2				or	dx, dx
 0F0C  74 0E				jz	short @f
 0F0E  03 FA				add	di, dx
 0F10  C6 05 2F				mov	byte ptr [DI], '/'
 0F13  47				inc	di
					;
 0F14  EB 06				jmp	short @f
 0F16				ucds_8:
 0F16  47				inc	di
 0F17				ucds_6:
 0F17  AC				lodsb
 0F18  3C 2F				cmp	al, '/'
 0F1A  74 FB				je	short ucds_6
 0F1C				@@:
 0F1C  0A C0				or	al, al
 0F1E  74 39				jz	short ucds_5
 0F20  3C 2E				cmp	al, '.'
 0F22  75 2B				jne	short ucds_3
 0F24  AC				lodsb
 0F25  3C 2E				cmp	al, '.'
 0F27  74 0F				je	short ucds_2 ; dotdot
 0F29				ucds_1: ;dot
 0F29  3C 2F				cmp	al, '/'
 0F2B  74 EA				je	short ucds_6
 0F2D  0A C0				or	al, al
 0F2F  74 28				jz	short ucds_5
 0F31  B4 2E				mov	ah, '.'
 0F33  86 E0				xchg	ah, al
 0F35  AB				stosw
 0F36  EB DF				jmp	short ucds_6
 0F38				ucds_2: ; dotdot
 0F38  3B FB				cmp	di, bx
 0F3A  77 06				ja	short @f
 0F3C  33 D2				xor	dx, dx
 0F3E  88 15				mov	byte ptr [DI], dl ; 0
 0F40  EB 28				jmp	short ucds_7
 0F42				@@: ; 13/01/2013
 0F42  4F				dec	di
 0F43				@@: ; move back
 0F43  4F				dec	di ; 13/01/2013
 0F44  8A 05				mov	al, byte ptr [DI]
 0F46  3C 2F			        cmp	al, '/'
 0F48  75 F9				jne	short @b ; 13/01/2013
 0F4A  EB CA				jmp	short ucds_8
 0F4C				ucds_4:
 0F4C  AA				stosb
 0F4D  EB C8				jmp	short ucds_6
 0F4F				ucds_3:
 0F4F  AA				stosb
 0F50  AC				lodsb
 0F51  3C 2F				cmp	al, '/'
 0F53  74 F7				je	short ucds_4
 0F55  22 C0				and	al, al
 0F57  75 F6				jnz	short ucds_3
 0F59				ucds_5: ; 13/01/2013
 0F59  3B FB				cmp	di, bx
 0F5B  76 07				jna	short ucds_9
 0F5D  4F				dec	di
 0F5E  80 3D 2F				cmp	byte ptr [DI], '/'
 0F61  74 01				je	short ucds_9
 0F63  47				inc	di
 0F64				ucds_9:
					; 13/01/2013
 0F64  88 05				mov	byte ptr [DI], al ; 0
 0F66  8B D7				mov	dx, di
 0F68  2B D3				sub	dx, bx
 0F6A				ucds_7:
 0F6A  89 16 2C46 R			mov	word ptr [CDirOffset], dx
					
 0F6E  C3				retn

 0F6F				update_cdir_string  endp

 0F6F				print_directory_list proc near
					; 18/01/2020
					; 17/01/2020
					; 16/01/2020
					; 15/01/2020
					; 29/12/2019
					; 25/09/2019
					; 24/09/2019
					; 20/09/2019 - Retro UNIX 386 v2 (modified unix v7 inode structure)
					; 04/12/2015 (14 byte file names)
					; 23/02/2013 long list printing (list_count)
					; 03/02/2013
					; 22/01/2013 ls -l command feature 
					; 21/01/2013 dir/ls options
					; 20/01/2013 directory sign ("/")
					; 30/12/2012

 0F6F  0B C0				or	ax, ax ; i-number of directory	
 0F71  75 03				jnz	short @f
					
					; 09/12/2012
 0F73				pdl_0:	
 0F73  A1 307E R			mov	ax, word ptr [u_cdir]
 0F76				@@:
					; 26/12/2019
 0F76  8B D8				mov	bx, ax
 0F78  E8 0671				call	iget
 0F7B  72 0F			        jc	short @f ; 20/01/2013 ; jc short pdl_9

					;test 	word ptr [inode_flgs], 4000h ; directory i-node ?
					;jnz	short pdl_2

					; 20/09/2019
 0F7D  8A 26 303D R			mov	ah, byte ptr [inode_flgs+1]
 0F81  80 E4 C0				and	ah, 0C0h ; regular + directory
 0F84  80 FC C0				cmp	ah, 0C0h ; 24/09/2019
 0F87  74 04				je	short pdl_2	
 0F89				pdl_1:
 0F89  B4 FF				mov	ah, 0FFh ; error number
 0F8B  F9				stc
 0F8C				@@: ; 20/01/2013
				       ;jmp	short pdl_9
 0F8C  C3			        retn
 0F8D				pdl_2:
					;mov	ax, word ptr [inode_size]
					;mov	dx, word ptr [inode_size+2] ; 01/01/2020
					;mov	word ptr [u_dirp], ax ; put size of directory in u.dirp
					;mov	word ptr [u_dirp+2], dx ; 01/01/2020
					
 0F8D  33 C0				xor	ax, ax ; 0
 0F8F  A3 3A4C R			mov	word ptr [u_off], ax ; u.off is file offset used by user
					; 15/01/2020
 0F92  A3 3A4E R			mov	word ptr [u_off+2], ax ; 29/12/2019

					;mov	word ptr [u_fofp], offset u.off
						       ; u.fofp is a pointer to the offset portion 
						       ; of fsp entry
 0F95  A2 3191 R			mov	byte ptr [list_count], al ; 0 ; 23/02/2013 
 0F98				pdl_3:
 0F98  C7 06 3A52 R 3086 R		mov	word ptr [u_base], offset u_dirbuf
						  ; u.dirbuf holds a file name copied from
						  ; a directory	
 0F9E  C7 06 3A50 R 0010		mov	word ptr [u_count], 16 ; 04/12/2015 (10 -> 16)
						  ; u.dirbuff holds a file name copied from
						  ; a directory	
					;mov	ax, word ptr [ii]

					; 26/12/2019
 0FA4  8B 1E 3A5E R			mov	bx, word ptr [ii]
					 	
 0FA8  E8 059D				call	readi ; read 16 bytes of file with i-number (R1)
						; i.e. read a directory entry
 0FAB  72 DF			        jc	short @b ; jc short pdl_9

 0FAD  8B 0E 3A54 R			mov	cx, word ptr [u_nread]
 0FB1  0B C9				or	cx, cx
 0FB3  76 D4				jna	short pdl_1 ; gives error return 

 0FB5  8B 1E 3086 R			mov	bx, word ptr [u_dirbuf]
 0FB9  23 DB				and	bx, bx       
					;jz	pdl_8
					; 27/03/2022
 0FBB  75 03				jnz	short pdl_4
 0FBD  E9 0197				jmp	pdl_8
 0FC0				pdl_4:
 0FC0  BE 3088 R			mov	si, offset u_dirbuf + 2 ; r3, points to file name of directory entry
 0FC3  B9 000E				mov	cx, 14 ; max. file name length (04/12/2015) 8 -> 14
 0FC6  BF 3025 R			mov	di, offset DirFileName + 1 ; boot_File_Name
 0FC9				pdl_5:
 0FC9  AC				lodsb	; mov al, byte ptr [si] ; inc si
 0FCA  0A C0			 	or	al, al
 0FCC  74 03				jz	short pdl_6 ; 3f. If char is nul, then the last char in string has
						 	    ; been compared
 0FCE  AA				stosb	; mov byte ptr [di], al ; inc di 
 0FCF  E2 F8				loop	pdl_5
 0FD1				pdl_6: 
					; 21/01/2013
 0FD1  BE 2EE3 R			mov	si, offset UNIX_CRLF
 0FD4  E8 F50D				call	PRINT_MSG
 0FD7  80 3E 3192 R 01			cmp	byte ptr [ls_option], 1
 0FDC  74 04				je	short pdl_7
					;mov	al, 0
 0FDE  88 05				mov	byte ptr [di], al
 0FE0  72 47				jb	short pdl_13
 0FE2				pdl_7:
					; 20/01/2013
 0FE2  57				push	di
 0FE3  A1 3A5E R			mov	ax, word ptr [ii]
 0FE6  A3 2C96 R			mov	word ptr [pdir], ax
					;mov	ax, word ptr [u_dirbuf]
					; 26/12/2019
 0FE9  8B 1E 3086 R			mov	bx, word ptr [u_dirbuf]
 0FED  E8 05FC				call	iget
 0FF0  5F				pop	di
					;jc	pdl_9
					; 27/03/2022
 0FF1  73 03				jnc	short @f
 0FF3  E9 0193				jmp	pdl_9
 0FF6				@@:
					; 22/01/2012
 0FF6  80 3E 3192 R 01			cmp	byte ptr [ls_option], 1
 0FFB  76 0B				jna	short @f
				        
 0FFD				pdl_11: ; 21/01/2013 ; Inode number
 0FFD  A1 3086 R			mov	ax, word ptr [u_dirbuf]
					;mov	cx, 3 ; 03/02/2013
					; 16/01/2020
 1000  B9 0006				mov	cx, 6 ; ' '+'65534' ; 1 space + 5 digits
 1003  E8 16D5				call	print_decimal_number
 1006  EB 1D			        jmp	short pdl_10
 1008				@@:
					;mov	ax, word ptr [inode_flgs]
					;test 	ah, 40h ; 'directory' flag
				        ;jz	short pdl_10

					; 20/09/2019
 1008  A0 303D R			mov	al, byte ptr [inode_flgs+1]
 100B  24 C0				and	al, 0C0h ; regular + directory
 100D  3C 80				cmp	al, 80h  ; regular (not directory, not device)
					;je	short pdl_10
					; 25/09/2019
 100F  76 14				jna	short pdl_10 ; not directory (file or device)	

 1011  BE 3088 R			mov	si, offset u_dirbuf + 2
 1014  AC				lodsb
 1015				@@:
 1015  3C 2E				cmp	al, '.'
 1017  75 07				jne	short @f
 1019  AC				lodsb
 101A  0A C0				or	al, al
					;jz	short pdl_10
 101C  74 09				jz	short pdl_14 ; 25/09/2019
 101E  EB F5				jmp	short @b
 1020				@@:	
 1020  B0 2F				mov	al, '/'
 1022  88 05				mov	byte ptr [di], al
 1024  47				inc	di
 1025				pdl_10:
					; 21/02/2013
 1025  32 C0				xor	al, al
 1027				pdl_14:
 1027  88 05				mov	byte ptr [di], al
 1029				pdl_13: ; File/Directory name
 1029  FE 06 3191 R			inc	byte ptr [list_count] ; 23/02/2013
 102D  BE 3024 R			mov	si, offset DirFileName
 1030  E8 F4B1				call	PRINT_MSG

					; 22/01/2013
 1033  80 3E 3192 R 01			cmp	byte ptr [ls_option], 1
					;je	pdl_12  ; 03/02/2013 short -> near
					;jb	pdl_8 ; 23/02/2013 
					; 27/03/2022
 1038  77 05				ja	short @f	
 103A  72 15				jb	short pdl_18
 103C  E9 010F				jmp	pdl_12

					; 03/02/2013
 103F				@@:	; Owner (uid)
				        ;xor	bh, bh ; mov	bh, 0
 103F  B4 03			        mov	ah, 03h ; get cursor position and size.
 1041  CD 10			        int 10h
 1043				@@:
					; 17/01/2020
					;cmp	dl, 19 ; 04/12/2015 (13 -> 19)
 1043  80 FA 16				cmp	dl, 22 ; 17/01/2020
 1046  73 0C				jnb	short @f
 1048  B0 20				mov	al, 20h
 104A  E8 013D				call	putc
 104D  FE C2				inc	dl
 104F  EB F2				jmp	short @b

 1051				pdl_18:	; 27/03/2022
 1051  E9 0103				jmp	pdl_8
 1054				@@:
					; 24/09/2019
 1054  A1 3040 R			mov	ax, word ptr [inode_uid]
					;mov	cx, 4 ; <= 9999 ?
 1057  B9 0003				mov	cx, 3 ; <= 999 ? ; 25/09/2019
 105A  E8 167E				call	print_decimal_number
					;mov	al,','
 105D  B0 20				mov	al,20h ; 25/09/2019 
 105F  E8 0128				call	putc
 1062  32 E4				xor	ah, ah
 1064  A0 3042 R			mov	al, byte ptr [inode_gid]
 1067  B9 0003				mov	cx, 3
 106A  E8 166E				call	print_decimal_number	
 106D				@@:
 106D  B0 20			  	mov	al, 20h
 106F  E8 0118				call	putc
					
 1072  B0 20			  	mov	al, 20h
 1074  E8 0113				call	putc

 1077				@@:	; Flags/Attributes

					; 25/09/2019
 1077  8B 16 303C R			mov	dx, word ptr [inode_flgs]
 107B  F6 C6 80				test 	dh, 80h
 107E  75 12				jnz	short regular
 1080  F6 C6 40				test 	dh, 40h
 1083  75 09				jnz	short blockdev
					; 18/01/2020
 1085  F6 C6 20				test 	dh, 20h
 1088  74 0F				jz	short regular_f
 108A				chardev:
 108A  B0 63				mov	al, 'c'
 108C  EB 0D				jmp	short @f
 108E				blockdev:	
 108E  B0 62				mov	al, 'b'
 1090  EB 09				jmp	short @f
 1092				regular:
 1092  B0 64				mov	al,'d'
 1094  F6 C6 40				test 	dh, 40h
 1097  75 02				jnz	short @f	
 1099				regular_f:		
 1099  B0 2D				mov	al, '-'
 109B				@@:
 109B  E8 00EC				call	putc

					; rwx permissions for owner,group,others

 109E  81 E2 01FF			and	dx, 1FFh ; 111111111b
					
					;mov	cx, 7
 10A2  B1 07				mov	cl, 7
 10A4  D3 E2				shl	dx, cl ; shift bit 8 to bit 15 position
 10A6  B1 03				mov	cl, 3
 10A8				rwxugo:
 10A8  B0 2D				mov	al, '-'
 10AA  D1 E2				shl	dx, 1
 10AC  73 02				jnc	short @f
 10AE  B0 72				mov	al, 'r'
 10B0				@@:
 10B0  E8 00D7				call	putc
 10B3  B0 2D				mov	al, '-'
 10B5  D1 E2				shl	dx, 1
 10B7  73 02				jnc	short @f
 10B9  B0 77				mov	al, 'w'
 10BB				@@:	
 10BB  E8 00CC				call	putc
 10BE  B0 2D				mov	al, '-'
 10C0  D1 E2				shl	dx, 1
 10C2  73 02				jnc	short @f
 10C4  B0 78				mov	al, 'x'
 10C6				@@:
 10C6  E8 00C1				call	putc
 10C9  E2 DD				loop	rwxugo

 10CB  B0 20				mov	al, 20h
 10CD  E8 00BA				call	putc

 10D0				@@: ; File Size ; 03/02/2013
					;mov	ax, word ptr [inode_size]
					;;;mov	cx, 5
					;;mov	cl, 5
					;mov	cl, 6 ; 25/09/2019
					;call	print_decimal_number

					; 15/01/2020
 10D0  E8 15FD				call	print_file_size
 10D3				@@:
 10D3  B0 20				mov	al, 20h
 10D5  E8 00B2				call	putc

 10D8  B0 20				mov	al, 20h
 10DA  E8 00AD				call	putc

 10DD				@@: ; 03/02/2013 ; File creation date & time	
					;mov	ax, word ptr [inode_ctim]
					;mov	dx, word ptr [inode_ctim]+2
					
					; 23/02/2013 ; File last modification date & time	
 10DD  A1 3074 R			mov	ax, word ptr [inode_mtim]
 10E0  8B 16 3076 R			mov	dx, word ptr [inode_mtim]+2
					
 10E4  E8 0E24				call	convert_from_epoch
					; cx = day

 10E7  8B C1				mov	ax, cx ; word ptr [day]
 10E9  BE 3193 R			mov	si, offset dec_num
 10EC  8B DE				mov	bx, si
 10EE  83 C3 02				add	bx, 2	
					; mov	cx, 2
 10F1  B1 02				mov	cl, 2
 10F3  E8 12E5				call	proc_bin_to_decimal
 10F6  C6 07 2F				mov	byte ptr [bx], '/'
 10F9  8B F3				mov	si, bx
 10FB  46				inc	si
 10FC  A1 3098 R			mov	ax, word ptr [month]
					; mov	cx, 2
 10FF  B1 02				mov	cl, 2
 1101  E8 12D7				call	proc_bin_to_decimal
 1104  83 C3 03				add	bx, 3
 1107  C6 07 2F				mov	byte ptr [bx], '/'
 110A  8B F3				mov	si, bx
 110C  46				inc	si
 110D  A1 3096 R			mov	ax, word ptr [year]
					;mov	cx, 4
 1110  B1 04				mov	cl, 4
 1112  E8 12C6				call	proc_bin_to_decimal

					; 16/01/2020
 1115  C6 04 00				mov	byte ptr [si], 0 ; 16/01/2020

 1118  BE 3193 R			mov	si, offset dec_num
 111B  E8 F3C6				call	PRINT_MSG

 111E  B0 20				mov	al, 20h
 1120  E8 0067				call	putc

 1123  BE 3193 R			mov	si, offset dec_num
 1126  8B DE				mov	bx, si
 1128  A1 309C R			mov	ax, word ptr [hour]
					; mov	cx, 2
 112B  B1 02				mov	cl, 2
 112D  E8 12AB				call	proc_bin_to_decimal
 1130  83 C3 02				add	bx, 2
 1133  C6 07 3A				mov	byte ptr [bx],':'

 1136  8B F3				mov	si, bx
 1138  46				inc	si
 1139  A1 309E R			mov	ax, word ptr [minute]
					; mov	cx, 2
 113C  B1 02				mov	cl, 2
 113E  E8 129A				call	proc_bin_to_decimal
 1141  83 C3 03				add	bx, 3
					;mov	byte ptr [bx], ':'
					;mov	si, bx
					;inc	si
					;mov	ax, word ptr [second]
					;;mov	cx, 2
					;mov	cl, 2
					;call	proc_bin_to_decimal
 1144  32 C0				xor	al, al
 1146  88 07			        mov	byte ptr [bx], al 

 1148  BE 3193 R			mov	si, offset dec_num
 114B  E8 F396				call	PRINT_MSG
 114E				pdl_12:
					;mov	ax, word ptr [pdir]
					; 26/12/2019
 114E  8B 1E 2C96 R			mov	bx, word ptr [pdir]
 1152  E8 0497				call	iget
 1155  72 32			        jc	short pdl_9
 1157				pdl_8:
					; 15/01/2020
					; 01/01/2020 (32 bit offset)
 1157  A1 3A4C R			mov	ax, word ptr [u_off]
 115A  8B 16 3A4E R			mov	dx, word ptr [u_off+2]
 115E  3B 16 3046 R			cmp	dx, word ptr [inode_size+2]
 1162  72 06			        jb	short pdl_15
 1164  3B 06 3044 R			cmp	ax, word ptr [inode_size]
 1168  73 19			        jnb	short @f

					; 30/12/2012
					;mov	ax, word ptr [u_off]
					;cmp	ax, word ptr [inode_size]
				        ;jnb	short @f ; 22/02/2013 ; jb pdl_3
 116A				pdl_15:
					; 23/02/2013
 116A  80 3E 3191 R 15			cmp	byte ptr [list_count], 21
					;jb	pdl_3
					; 01/01/2020
 116F  73 03				jnb	short pdl_16
 1171  E9 FE24				jmp	pdl_3	
 1174				pdl_16:
 1174  32 E4				xor	ah, ah
 1176  88 26 3191 R			mov	byte ptr [list_count], ah ; 0
 117A  CD 16				int	16h
 117C  3C 1B				cmp	al, 1Bh  ; ESC key
					;jne	pdl_3
					; 01/01/2020
 117E  74 03				je	short @f
 1180  E9 FE15				jmp	pdl_3	
 1183				@@:
 1183  BE 2EE3 R		        mov	si, offset UNIX_CRLF
					;call	PRINT_MSG
					; 22/01/2020
 1186  E9 F35B				jmp	PRINT_MSG
 1189				pdl_9:
 1189  C3				retn

 118A				putc:  ; 22/01/2013
 118A  B4 0E				mov	ah, 0Eh
					;mov	bx, 07h
 118C  CD 10				int	10h
 118E  32 C0				xor	al, al

 1190  C3				retn

 1191				print_directory_list endp

 1191				sys_chdir proc near
					; 01/01/2020
					; 29/12/2019
					; 24/09/2019
					; 20/09/2019 - Retro UNIX 386 v2 (modified unix v7 inode structure)
					; 09/12/2012 unixcopy.asm
					;       Retro UNIX v1 FS file import/export version
					;             of syschdir function  
					; Derived from (original) UNIX v1 source code
					; PRELIMINARY release of Unix Implementation Document, 
					; 20/6/1972
					;
					; RETRO UNIX v1 FS
					; syschdir:
					; makes the directory specified in the argument 
					; the current directory

					; mov	word ptr [u_namep], si

 1191				syschdir_0:
 1191  E8 0305				call	namei
 1194  72 19				jc	short syschdir_5

 1196				syschdir_1:
					; 26/12/2019
					;mov	bx, ax
 1196  E8 0453				call	iget
 1199  72 14				jc	short syschdir_5
 119B				syschdir_2:
					;test 	word ptr [inode_flgs], 4000h ; directory i-node ?
					;jnz	short syschdir_4
					; 20/09/2019
 119B  8A 16 303D R			mov	dl, byte ptr [inode_flgs+1]
 119F  80 E2 C0				and	dl, 0C0h
 11A2  80 FA C0				cmp	dl, 0C0h ; 24/09/2019
 11A5  74 04				je	short syschdir_4
 11A7				syschdir_3:
 11A7  B4 FF				mov	ah, 0FFh
 11A9  F9				stc
 11AA  C3				retn	
 11AB				syschdir_4:	
					;mov	word ptr [u_cdir], ax

					; 01/01/2020
 11AB  89 1E 307E R			mov	word ptr [u_cdir],bx

					;mov	dx, word ptr [cdev]
					;mov	word ptr [u_cdev], dx

 11AF				syschdir_5:
 11AF  C3				retn

 11B0				sys_chdir endp

 11B0				sys_mkdir proc near
					; 15/04/2022 ('number of links' bugfix)
					; 28/03/2022
					; 29/12/2019
					; 19/09/2019 - Retro UNIX 386 v2 (modified unix v7 inode structure)
					;
					; 05/01/2013 (bugfix)
					; 30/12/2012 unixcopy.asm
					;       Retro UNIX v1 FS file import/export version
					;             of sysmkdir function  
					; Derived from (original) UNIX v1 source code
					; PRELIMINARY release of Unix Implementation Document, 
					; 20/6/1972
					;
					; RETRO UNIX v1 FS
					; sysmkdir:
					; make a directory
					;
					;
					; return => if cf=1 error code in AH
					; If cf=0 -> AX = I-Number (also in u.dirbuff)

				 	;jsr    r0,arg2 / point u.namep to the file name
				        ;jsr    r0,namei / get the i-number
				        ;       br .+4 / if file not found branch around error
				        ;br     error2 / directory already exists (error)
				        ;tstb   u.uid / is user the super user
				        ;bne    error2 / no, not allowed
				        ;mov	   (sp)+,r1 / put the mode in r1
					;bic    $!317,r1 / all but su and ex
				        ;bis    $40000,r1 / directory flag
				        ;jsr    r0,maknod / make the i-node for the directory
				        ;br     sysret2 /

 11B0  8B 1E 3080 R			mov	bx, word ptr [u_namep]
 11B4  8B F3				mov	si, bx ; 05/01/2013

 11B6				makdir_1:
 11B6  AC				lodsb  
 11B7  0A C0				or	al, al
 11B9  74 08				jz	short makdir_2
 11BB  3C 2F				cmp	al, '/'
 11BD  75 F7				jne	short makdir_1
 11BF  8B DE				mov	bx, si	 	
 11C1  EB F3				jmp	short makdir_1

 11C3				makdir_2:
 11C3  3B 1E 3080 R			cmp	bx, word ptr [u_namep]
 11C7  74 0F				je	short makdir_3
 11C9  4E				dec	si
 11CA  4E				dec	si ; 05/01/2013
 11CB  80 3C 2F			        cmp	byte ptr [si], '/' ; is the last char '/'
 11CE  75 08				jne	short makdir_3

 11D0  3B 36 3080 R			cmp	si, word ptr [u_namep] ; 05/01/2013
 11D4  74 02				je	short makdir_3

 11D6  F9				stc
 11D7				@@:
 11D7  C3				retn

 11D8				makdir_3:
 11D8  89 1E 2C96 R			mov	word ptr [pdir], bx
 11DC				sysmkdir_0:
 11DC  E8 02BA				call	namei
 11DF  72 05				jc	short sysmkdir_1

					; bx = inode number

					; 29/12/2019
 11E1  B8 FFFF				mov	ax, 0FFFFh 

 11E4  F9				stc
 11E5				@:
 11E5  C3				retn

 11E6				sysmkdir_1:
 11E6  80 FC FF				cmp	ah, 0FFh
 11E9  75 EC			        jne	short @b

 11EB				makdir_4:
				       	; 15/04/2022
				        ;mov	ax, word ptr [ii]
 11EB  8B 1E 2C96 R			mov	bx, word ptr [pdir]
					;mov	word ptr [pdir], ax
 11EF  39 1E 3080 R			cmp	word ptr [u_namep], bx
 11F3  72 E2				jb	short @b ; parent dir of the new sub dir not found

				 	; 15/04/2022
 11F5  A1 3A5E R			mov	ax, word ptr [ii]
 11F8  A3 2C96 R			mov	word ptr [pdir], ax ; parent directory 
								    ; (of the new sub dir)
 11FB				sysmkdir_flags: ; ax = r1 = mode
					;mov	ax, 0C00Eh ; Flags (1100000000001110b)
					; 19/09/2019 - Retro UNIX 386 v2 (modified unix v7 inode structure) 
 11FB  B8 C1ED				mov	ax, 0C1EDh ; Flags (0100000111101101b)
 11FE				sysmkdir_maknod:
					; 28/03/2022
					; (clear/reset [uf_i_number] as new file/directory sign)
 11FE  C7 06 3038 R 0000		mov	word ptr [uf_i_number], 0

					;call	mak_nod	
					; ax = I-Number (also in u.dirbuff)
					;retn

					; 29/12/2019
					;jmp	short mak_nod ; 17/01/2020 (short jump)

 1204				sys_mkdir endp

 1204				mak_nod proc near
					; 28/03/2022
					; 27/03/2022
					; 18/01/2020
					; 03/01/2020
					; 01/01/2020
					; 26/12/2019
					; 25/09/2019
					; 19/09/2019 - Retro UNIX 386 v2 (modified unix v7 inode structure)	
					;
					; 01/03/2013
					; 23/02/2013
					; 15/12/2012 UNIXCOPY.ASM version of maknod
					; 02/12/2012 (maknod_imap -> call	imap)
					; 25/11/2012
					; 18/11/2012
					; 11/11/2012
					; unixboot.asm (boot file configuration)
					; version of 'maknod'
					;
					; 30/10/2012
					; AX = R1, mode
				     	; Derived from (original) UNIX v1 source code
					; PRELIMINARY release of Unix Implementation Document, 
					; 20/6/1972
					; RETRO UNIX v1 FS
					;
					; maknod : create an i-node and make a directory entry
					;
					; 8086 CPU & IBM PC architecture modifications by Erdogan Tan 
					;
					; return => if cf=1 error code in AH
					; If cf=0 -> AX = I-Number (also in u.dirbuff)

					;or	ah, 80h  ; 10000000b, allocate flag set  ;; unix v1
					; 25/09/2019
					;or	ah, 80h	 ; 11000000b, regular file (or dir) ;; runix v2	  
					
 1204  50				push	ax ; *	 ; put mode on stack
					
					;mov	ax, word ptr [ii] ; move current i-number to AX/r1
					;push 	ax
 1205  FF 36 3A5E R			push	word ptr [ii] ; **

					;mov	ax, 41	 ; r1 = 41 ; unix v1
 1209  B8 0001				mov	ax, 1	 ; check inodes after root directory, 19/09/2019
						 ; (root directory inode number = 1) ; runix v2
 120C				maknod_1: ; 1 	 ; scan for a free i-node
 120C  40				inc	ax 	 ; r1 = r1 + 1
					; 2/12/2012
 120D  E8 11EE				call	imap     ; get byte address and bit position in inode map in 
						; r2 (DX) & mq (BX)
						; DX (MQ) has a 1 in the calculated bit position
				        	; BX (R2) has byte address of the byte with allocation bit

 1210  84 17			        test	byte ptr [bx], dl ; bitb mq,(r2) / is the i-node active
 1212  75 F8				jnz	short maknod_1    ; bne	1b / yes, try the next one
 1214  08 17			        or	byte ptr [bx], dl ; bisb mq,(r2)
						; no, make it active (put a 1 in the bit map)
					; 01/01/2020
 1216  80 0E 3A59 R 02			or	byte ptr [smod], 2 ; inode map modified flag

					; ax = i-number

					; 26/12/2019
 121B  8B D8				mov	bx, ax

 121D  E8 03CC				call	iget      	  ; jsr	r0,iget / get i-node into core
					;jc	short maknod_3	
					; 01/01/2020
 1220  73 03				jnc	short @f

 1222				maknod_3:
					; 15/12/2012
 1222  58				pop	ax ; ** ; current i number
 1223				maknod_2:
 1223  58				pop	ax ; *  ; file mode (inode flags)
 1224  C3				retn
 1225				@@:	
					; 03/01/2020
 1225  8B C3				mov	ax, bx

					;test	word ptr [inode_flgs], 8000h  ; is i-node already allocated
 1227  F6 06 303D R 00			test	byte ptr [inode_flgs+1], 0 ; 19/09/2019 - Retro UNIX 386 v2
 122C  75 DE				jnz	short maknod_1	; 1b / yes, look for another one
					
 122E  A3 3086 R			mov	word ptr [u_dirbuf], ax ; mov	r1, u.dirbuf 
						        ; no, put i-number in u.dirbuf

					;pop 	ax ; 15/12/2012	; get current i-number back	
					; 26/12/2019
 1231  5B				pop	bx ; ** ; current i number
 1232  E8 03B7				call	iget	; jsr r0,iget / get i-node in core
 1235  72 EC				jc	short maknod_2

 1237  E8 096F				call	mk_dir	; jsr r0,mkdir 
						; make a directory entry in current directory
 123A  72 E7				jc	short maknod_2 ; 01/03/2013 

					;mov	ax, word ptr [u_dirbuf] ; mov	u.dirbuf,r1 
						; ax / r1 = new inode number
					; 26/12/2019
 123C  8B 1E 3086 R			mov	bx, word ptr [u_dirbuf]
 1240  E8 03A9				call	iget
 1243  72 DE				jc	short maknod_2

				        ; jsr r0,copyz; inode; inode+32. / 0 it out 
					;mov	cx, 16
 1245  B9 0020				mov	cx, 32 ; 19/09/2019 - Retro UNIX 386 v2
					;	       ;	     (inode size = 64 bytes)
 1248  33 C0				xor	ax, ax ; 0
 124A  BF 303C R			mov	di, offset inode 
 124D  F3/ AB				rep	stosw

 124F  8F 06 303C R			pop	word ptr [inode_flgs] ; * ; mov	(sp)+,i.flgs / fill flags

					; 19/09/2019 - Retro UNIX v2 (modified unix v7 inodes)
 1253  8A 0E 307D R			mov	cl, byte ptr [u_gid] ; user's group id
 1257  88 0E 3042 R			mov	byte ptr [inode_gid], cl	

 125B  8A 0E 307C R			mov	cl, byte ptr [u_uid] ; movb u.uid,i.uid / user id
 125F  88 0E 3040 R			mov	byte ptr [inode_uid], cl ; 23/02/2013 al -> cl
 1263  C6 06 303E R 01			mov	byte ptr [inode_nlks], 1 ; movb $1,i.nlks / 1 link
					
					;call	epoch

					;mov	word ptr [s_time], ax
					;mov	word ptr [s_time]+2, dx	

					;mov	word ptr [inode_ctim], ax ; mov	s.time,i.ctim / time created
					;mov	word ptr [inode_ctim]+2, dx ; mov	s.time+2,i.ctim+2

					; 25/11/2012
					; 23/02/2013
 1268				fromdos_maknod:
					;xor	ax, ax
 1268  33 D2				xor	dx, dx	
					; File/Directory data/content modification date&time
 126A  A3 3074 R			mov	word ptr [inode_mtim], ax  ; 0
 126D  89 16 3076 R			mov	word ptr [inode_mtim]+2, dx ; 0
					; 19/09/2019 - Retro UNIX 386 v2
					; Last access date&time or inode modification date&time
 1271  A3 3070 R			mov	word ptr [inode_atim], ax  ; 0
 1274  89 16 3072 R			mov	word ptr [inode_atim]+2, dx ; 0

					;test	word ptr [inode_flgs], 4000h  ; Directory
					; 19/09/2019
 1278  F6 06 303D R 40			test	byte ptr [inode_flgs+1], 40h  ; Directory
 127D  75 07				jnz	short maknod_4
 127F  A1 3034 R			mov	ax, word ptr [uf_make_datetime]
 1282  8B 16 3036 R			mov	dx, word ptr [uf_make_datetime]+2
 1286				maknod_4:
 1286  A3 3078 R			mov	word ptr [inode_ctim], ax  
 1289  89 16 307A R			mov	word ptr [inode_ctim]+2, dx

 128D  E8 086D				call	setimod

					; 28/03/2022
 1290  A1 3A5E R			mov	ax, word ptr [ii] ; inode number of current inode

					; 27/03/2022 (BugFix)
 1293  83 3E 3038 R 00			cmp	word ptr [uf_i_number], 0 ; existing file ?
 1298  77 12				ja	short @f  ; yes (do not decrease free inode count)
					; new file (decrease free inode count)

					; 29/09/2019
 129A  FF 0E 3CE0 R			dec	word ptr [systm.sb_FreeInodes]

					; 28/03/2022
					; (first free inode has been searched from inode 1;
					;  so, ax contains previous first free inode value and
					;  it is better if the new value is set one/just next to ax)
				  
 129E  8B D0				mov	dx, ax
 12A0  42				inc	dx ; next inode (next ffi search will be started from)
 12A1  89 16 3CE4 R			mov	word ptr [systm.sb_FirstFreeIno], dx
 12A5  2B D2				sub	dx, dx
 12A7  89 16 3CE6 R			mov	word ptr [systm.sb_FirstFreeIno+2], dx ; 0
 12AB  C3				retn

 12AC				@@:		; 27/03/2022
					; 28/03/2022
					;mov	ax, word ptr [ii] ; inode number of current inode
					; 18/01/2020
					;mov	ax, word ptr [u_dirbuf]
 12AC  3B 06 3CE4 R			cmp	ax, word ptr [systm.sb_FirstFreeIno]
 12B0  75 0C				jne	short @f
					;cmp	word ptr [systm.sb_FirstFreeIno+2], 0
					;jne	short @f
 12B2  C7 06 3CE4 R FFFF		mov	word ptr [systm.sb_FirstFreeIno], 0FFFFh ; invalidate
 12B8  C7 06 3CE6 R FFFF		mov	word ptr [systm.sb_FirstFreeIno+2], 0FFFFh
 12BE				@@:
 12BE  F8				clc
					;mov	ax, word ptr [u_dirbuf] ; 18/01/2020
 12BF  C3				retn

				;maknod_3:
				;	; 15/12/2012
				;	pop	ax
				;maknod_2:
				;	pop	ax
				;	retn

 12C0				mak_nod	endp

 12C0				remove_directory proc near
					; 15/04/2022 ('number of links' bugfix)
					; 17/01/2020
					; 15/01/2020
					; 29/12/2019
					; 01/10/2019
					; 20/09/2019 - Retro UNIX 386 v2 (modified unix v7 inode structure)
					; 04/12/2015 (14 byte directory names)
					; 05/01/2013
					;
					; mov	word ptr [u.namep], si

					;call	namei
				        ;jc	short @f

					;cmp	ax, ROOT_DIR_INODE_NUMBER
				        ;je	short rmdir_stc_retn

					;cmp	ax, word ptr [u_cdir]
				        ;je	short rmdir_stc_retn

				       ; INPUT ->
				       ; ax = i_number of directory (to be removed)
				       ; u_off = directory entry location + 16 (in parent dir)
				       ; [ii] = i_number of parent directory

 12C0  3B 06 3A5E R			cmp	ax, word ptr [ii]	; '.' entry
 12C4  74 31				je	short rmdir_stc_retn

 12C6  A3 3038 R			mov	word ptr [uf_i_number], ax  ; i_number of dir or file 

 12C9  8B 16 3A4C R			mov	dx, word ptr [u_off]
					; 01/01/2020
					;mov	word ptr [FileHandle], dx	
 12CD  89 16 3A78 R			mov	word ptr [d_off], dx ; directory entry location + 16 (+10) 
					; 15/01/2020
 12D1  8B 16 3A4E R			mov	dx, word ptr [u_off+2]
 12D5  89 16 3A7A R			mov	word ptr [d_off+2], dx

 12D9  8B 16 3A5E R			mov	dx, word ptr [ii] ; i-number of parent directory 
 12DD  89 16 2C96 R			mov	word ptr [pdir], dx

					; 26/12/2019
 12E1  8B D8				mov	bx, ax

 12E3  E8 0306				call	iget
 12E6  72 10				jc	short @f

					;mov	ax, word ptr [inode_flgs]
					;test 	ah, 40h ;'directory' flag
					;jz	short rmdir_stc_retn	
					;test 	al, 4h ; 'write' flag
					;jz	short rmdir_stc_retn

					; 20/09/2019 - Retro UNIX 386 v2
 12E8  A1 303C R			mov	ax, word ptr [inode_flgs]
					; 15/04/2022
					;and	al, 80h ; owner's write permission
					;jz	short rmdir_stc_retn
					;and	ah, 0C0h
					;cmp	ah, 0C0h ; 01/10/2019
					;je	short rmdir_1
				;rmdir_stc_retn:
				;	stc
				;@@:
				;	retn

					; 15/04/2022
 12EB  80 E4 C0				and	ah, 0C0h
 12EE  80 FC C0				cmp	ah, 0C0h
 12F1  75 05				jne	short @f ; (cf=1)
 12F3  24 80				and	al, 80h ; owner's write permission
 12F5  75 02				jnz	short rmdir_1
					
 12F7				rmdir_stc_retn:
 12F7  F9				stc
 12F8				@@:
 12F8  C3				retn

 12F9				rmdir_1:
 12F9  33 C0				xor	ax, ax 
 12FB  A3 3A4C R			mov	word ptr [u_off], ax 
					; 15/01/2020
 12FE  A3 3A4E R			mov	word ptr [u_off+2], ax ; 29/12/2019

					;mov	word ptr [u_fofp], offset u.off	

 1301				rmdir_readi_loop:
 1301  C7 06 3A52 R 3086 R		mov	word ptr [u_base], offset u_dirbuf
						  ; u.dirbuf holds a file name copied from
						  ; a directory	
 1307  C7 06 3A50 R 0010		mov	word ptr [u_count], 16 ; 04/12/2015 (10 -> 16) 	
				 	
					;mov	ax, word ptr [ii]
					; 26/12/2019
 130D  8B 1E 3A5E R			mov	bx, word ptr [ii]
					 	
 1311  E8 0234				call	readi ; read 16 bytes of file with i-number
						; i.e. read a directory entry
 1314  72 E2				jc	short @b ; 24/09/2019

 1316  8B 0E 3A54 R			mov	cx, word ptr [u_nread]

 131A  0B C9				or	cx, cx
					;;jna	short rmdir_stc_retn
					;jna	short @b
 131C  76 32				jna	short rmdir_unlink ; 01/10/2019	

					;cmp	cx, 16  ; 04/12/2015 (10 -> 16)
					;jb	short @b

 131E  8B 1E 3086 R			mov	bx, word ptr [u_dirbuf]
 1322  23 DB				and	bx, bx       
 1324  74 DB				jz	short rmdir_readi_loop

 1326  A1 3088 R			mov	ax, word ptr [u_dirbuf]+2
 1329  3C 2E				cmp	al, '.'
 132B  75 CA				jne	short rmdir_stc_retn

 132D  22 E4				and	ah, ah
 132F  74 D0				jz	short rmdir_readi_loop

 1331  80 FC 2E				cmp	ah, '.'	; ".."
 1334  75 C1				jne	short rmdir_stc_retn

 1336  8A 26 308A R			mov	ah, byte ptr [u_dirbuf]+4

 133A  0A E4				or	ah, ah
 133C  75 B9				jnz	short rmdir_stc_retn

					; 15/01/2020
					; 01/01/2020 (32 bit offset value and 32 bit directory size)
 133E  A1 3A4E R			mov	ax, word ptr [u_off+2]
 1341  3B 06 3046 R			cmp	ax, word ptr [inode_size+2]
 1345  72 BA				jb	short rmdir_readi_loop

 1347  A1 3A4C R			mov	ax, word ptr [u_off]

					; 01/10/2019 - Retro UNIX 386 v2 (the 1st entry is '.', not '..')
						; 04/12/2015 (10 -> 16)
					;cmp	ax, 16	; protection for removing default system directories
					;jna	short rmdir_stc_retn ; because, the 1st dir enty of them is ".."

 134A  3B 06 3044 R			cmp	ax, word ptr [inode_size]
 134E  72 B1				jb	short rmdir_readi_loop

					; 01/10/2019
					;cmp	word ptr [inode_size+2], 0
					;jna	short rmdir_unlink
					;cmp	ax, 65536-16
					;jb	short rmdir_readi_loop

 1350				rmdir_unlink:
					; 15/04/2022
					; unlink dot ('.')
					;mov	ax, word ptr [uf_i_number]
					;call	iget
 1350  FE 0E 303E R			dec	byte ptr [inode_nlks]
 1354  E8 07A6				call	setimod

 1357  A1 3038 R			mov	ax, word ptr [uf_i_number]
					; 01/01/2020
					;mov	dx, word ptr [FileHandle]
					; 15/01/2020
 135A  8B 16 3A7A R			mov	dx, word ptr [d_off+2]
 135E  89 16 3A4E R			mov	word ptr [u_off+2], dx
 1362  8B 16 3A78 R			mov	dx, word ptr [d_off]
 1366  89 16 3A4C R			mov	word ptr [u_off], dx

					; 15/04/2022
				;	; 20/09/2019
				;	;call	unlink
				;;@@:
				;	;retn
				;	; 20/01/2020
				;	;jmp	short unlink

				;rmdir_stc_retn:
				;	stc
				;	retn

					; 15/04/2022
					; unlink dotdot ('..')
 136A  E8 000E				call	unlink
					; decrease link count of the parent directory
 136D  8B 1E 2C96 R			mov	bx, word ptr [pdir] ; parent dir
 1371  E8 0278				call	iget
					;cmp	byte ptr [inode_nlks], 2
					;jna	short @f
 1374  FE 0E 303E R			dec	byte ptr [inode_nlks] ; must be >= 2 after this
					;call	setimod
 1378  E9 0782				jmp	setimod
				;@:
				;	;retn

 137B				remove_directory endp

 137B				unlink	proc near
					; 15/01/2020
					; 01/01/2020
					; 18/09/2019 - Retro UNIX 386 v2 (modified unix v7 inodes)
					;
					; 04/12/2015 (14 byte file names)
					; 05/01/2013 UNIXCOPY.ASM modification (pdir -> iget)
					; 16/12/2012 UNIXCOPY.ASM version
				        ; 02/12/2012
				        ; unix boot file configuration version
					; of "sysunlink" function of retro unix v1.0 by Erdogan Tan
					; Derived from (original) UNIX v1 source code
					; PRELIMINARY release of Unix Implementation Document, 
					; 20/6/1972 
					; ('sysunlink', unix kernel function)
					; 
					; INPUT -> AX (R1) = inode number
					;          [u_off] = Directory Entry Offset + 16 (+ 10)
					;          ;;; [ii] = i-number of current directory
					; Return -> CF = 0 -> Successed, CF = 1 -> failed
					;	               (error code in AX)

					;jsr r0,arg; u.namep / u.namep points to name
					;jsr r0,namei / find the i-number associated 
					;               with the path name
					;br error9 / not found

 137B  50				push	ax ;mov	r1,-(sp) / put its i-number on the stack
						;jsr r0,isdir / is it a directory
 137C  33 C0				xor	ax, ax
 137E  A3 3086 R			mov	word ptr [u_dirbuf], ax ; clr u.dirbuf / no, clear 
						 ;the location that will get written
						 ;/ into the i-number portion of the entry
 1381  83 2E 3A4C R 10			sub	word ptr [u_off], 16 ; 04/12/2015 (10 -> 16)
						 ; sub $10.,u.off 
						 ; / move u.off back 1 directory entry
					; 15/01/2020
					; 01/01/2020
 1386  19 06 3A4E R			sbb	word ptr [u_off+2], ax ; 0

					;;mov	ax, word ptr [ii] 
					;mov	ax, word ptr [pdir] ; 05/01/2013
					; 26/12/2019
 138A  8B 1E 2C96 R			mov	bx, word ptr [pdir]
 138E  E8 025B				call	iget
 1391  73 02				jnc	short @f
 1393  58				pop	ax
 1394  C3				retn
					;
 1395				@@:
 1395  E8 0846				call	wdir ;jsr r0,wdir / free the directory entry
					;pop	ax   ;mov (sp)+,r1 / get i-number back
					; 26/12/2019
 1398  5B				pop	bx
 1399  72 41				jc	short @f

 139B  E8 024E			        call	iget ;jsr r0,iget / get i-node
 139E  72 3C				jc	short @f
 13A0  E8 075A			        call	setimod  ;jsr r0,setimod / set modified flag
					;dec	word ptr [inode_nlks] ; Retro UNIX 386 v2 (word)
 13A3  FE 0E 303E R		        dec	byte ptr [inode_nlks] ;decb i.nlks 
						; / decrement the number of links
 13A7  75 33				jnz	short @f ;bgt sysret9 
						;/ if this was not the last link to file return

					; 19/09/2019

				;	call	anyi ;jsr r0,anyi / if it was, see if anyone has it open.
				;	             ;Then / free contents of file and destroy it.
				;	             ;br sysret9
				;@@:
				;	retn

					; 17/01/2020
					; jmp	short anyi ; 17/01/2020

 13A9				unlink	endp

 13A9				anyi	proc near
					; 28/03/2022
					; 17/01/2020
					; 11/01/2020
					; 01/01/2020
					; 18/09/2019 - Retro UNIX 386 v2 (modified unix v7 inodes)
					;
				        ; 02/12/2012
				        ; unix boot file configuration version
					; of "anyi" procedure of retro unix v1.0 by Erdogan Tan
					; Derived from (original) UNIX v1 source code
					; PRELIMINARY release of Unix Implementation Document, 
					; 20/6/1972 
					; ('anyi' procedure)
					; 
					; INPUT -> AX (R1) = inode number
					; Return -> CF = 0 -> Successed, CF = 1 -> failed
					;	               
					; mov $fsp,r2 / move start of fsp table to r2
 13A9				anyi_1: ;1
					; cmp r1,(r2) / do i-numbers match?
					; beq 1f / yes, 1f
					; neg r1 / no complement r1
					; cmp r1,(r2) / do they match now?
					; beq 1f / yes, transfer
					; / i-numbers do not match
					; add $8,r2 / no, bump to next entry in fsp table
					; cmp r2,$fsp+[nfiles*8] / are we at last entry in the table
					; blt 1b / no, check next entries i-number
					; tst r1 / yes, no match
					; bge .+4
					; neg r1 / make i-number positive

					; 11/01/2020
 13A9  A1 3A5E R			mov	ax, word ptr [ii]

 13AC  E8 104F				call	imap ; jsr r0,imap / get address of allocation bit 
								; in the i-map in r2
				        ; DX (MQ) has a 1 in the calculated bit position
				        ; BX (R2) has byte address of the byte with allocation bit
 13AF  53				push	bx ; retro unix modification (not as original unix code)
 13B0  52				push	dx ; retro unix modification (not as original unix code)
					; AX = i-number
 13B1  E8 10BE				call	itrunc ; jsr r0,itrunc / free all blocks related to i-node
					
 13B4  5A				pop	dx ; retro unix modification (not as original unix code)
 13B5  5B				pop	bx ; retro unix modification (not as original unix code)

 13B6  72 24				jc	short @f

				        ; (AX=0)
					; retro unix modification-> 'call itrunc' moved up for
					; keeping super block unmodified if itrunc return with an error

 13B8  F7 D2			        not	dx
 13BA  20 17			        and	byte ptr [bx],dl ; bicb mq,(r2) 
						      ; / clear bit for i-node in the imap
					; 01/01/2020
 13BC  80 0E 3A59 R 02			or	byte ptr [smod],2 ; inode map modified flag

					; 28/03/2022
 13C1  33 D2				xor	dx, dx
					; 29/09/2019
 13C3  FF 06 3CE0 R			inc	word ptr [systm.sb_FreeInodes]
 13C7  A1 3A5E R			mov	ax,word ptr [ii] ; inode number of current inode
 13CA  3B 06 3CE4 R			cmp	ax,word ptr [systm.sb_FirstFreeIno]
 13CE  73 08				jnb	short anyi_2
					;cmp	word ptr [systm.sb_FirstFreeIno+2], 0
					;jne	short anyi_2
 13D0  A3 3CE4 R			mov	word ptr [systm.sb_FirstFreeIno], ax
					; 17/01/2020
					;mov	word ptr [systm.sb_FirstFreeIno+2], 0 ; 0FFFFh -> 0
					;;clc
					; 28/03/2022
 13D3  89 16 3CE6 R			mov	word ptr [systm.sb_FirstFreeIno+2], dx ; 0
 13D7  F8				clc 
 13D8				anyi_2:
					; 28/03/2022
					; cf = 0
					;xor	ax,ax
					;mov	word ptr [inode_flgs], ax ; 0 ; clr i.flgs
							; / clear all flags in the i-node
					; 28/03/2022
 13D8  89 16 303C R			mov	word ptr [inode_flgs], dx ; 0
 13DC				@@:
 13DC  C3				retn	; rts r0 / return

				;anyi_2: ;1 / i-numbers match
				        ; incb 7(r2) / increment upper byte of the 4th word
					; rts r0 / in that fsp entry (deleted flag of fsp entry)

 13DD				anyi	endp

 13DD				show_file proc near
					; 12/01/2020
					; 29/12/2019
					; 20/09/2019 - Retro UNIX 386 v2 (modified unix v7 inode structure)	
					; 07/01/2013
					; 06/01/2013
					; derived from TRDOS command interpreter file (CMDINTR.ASM)
					; 'show' procedure (13/09/2011)

 13DD  E8 00B9				call	namei
 13E0  72 61			        jc	short suf_4

					; 29/12/2019
					; 26/12/2019
					;mov	bx, ax

 13E2  E8 0207			        call	iget
 13E5  72 5C				jc	short suf_4

					; 20/09/2019
					;;test 	word ptr [inode_flgs], 4000h  ; Directory
					;test 	byte ptr [inode_flgs+1], 40h
					;jnz	short suf_4

					; 20/09/2019
					;test 	byte ptr [inode_flgs+1], 80h ; Regular file
					;jz	short suf_4		

 13E7  A0 303D R			mov	al, byte ptr [inode_flgs+1]
 13EA  24 C0				and	al, 0C0h
 13EC  3C 80				cmp	al, 80h
 13EE  75 53				jne	short suf_4	

 13F0  BE 2EE3 R		        mov	si, offset UNIX_CRLF
 13F3  E8 F0EE			        call	PRINT_MSG

					; 12/01/2020
 13F6  A1 3046 R			mov	ax, word ptr [inode_size+2]
 13F9  BA 0200				mov	dx, 512
 13FC  0B C0				or	ax, ax
 13FE  75 07				jnz	short suf_0
 1400  A1 3044 R			mov	ax, word ptr [inode_size]
 1403  3B C2				cmp	ax, dx ; 512
 1405  76 02				jna	short suf_1
 1407				suf_0:
 1407  8B C2				mov	ax, dx ; 512
 1409				suf_1:
 1409  33 D2				xor	dx, dx ; 0
 140B  89 16 3A4C R		        mov	word ptr [u_off], dx
					; 12/01/2020
 140F  89 16 3A4E R			mov	word ptr [u_off+2], dx ; 29/12/2019 
 1413  B9 0016				mov	cx, 22
 1416				suf_2:	
 1416  51				push	cx	
 1417  A3 3A50 R			mov	word ptr [u_count], ax
 141A  C7 06 3A52 R 42B0 R		mov	word ptr [u_base], offset ReadBuffer
					;mov	ax, word ptr [ii] ; word ptr [u_dirbuf]
					; 26/12/2019
 1420  8B 1E 3A5E R			mov	bx, word ptr [ii] 
 1424  E8 0121				call	readi
 1427  59				pop	cx
 1428  72 19				jc	short suf_4

 142A  8B 3E 3A54 R			mov	di, word ptr [u_nread]

 142E  0B FF				or	di, di
 1430  74 11				jz	short suf_4

 1432  BE 42B0 R			mov	si, offset ReadBuffer

 1435  EB 15			        jmp	short suf_6
 1437				suf_3:
 1437  23 C9			        and	cx, cx
 1439  75 11			        jnz	short suf_6
 143B  32 E4				xor	ah, ah
 143D  CD 16				int	16h
 143F  3C 1B				cmp	al, 1Bh ; ESCAPE Key
 1441  75 06				jne	short suf_5
 1443				suf_4:
 1443  BE 2EE3 R			mov	si, offset UNIX_CRLF
				        ;call	PRINT_MSG
					;retn
					; 12/01/2020
 1446  E9 F09B				jmp	PRINT_MSG
 1449				suf_5:
 1449  B9 0014				mov	cx, 20
 144C				suf_6:
 144C  32 FF			        xor	bh, bh ; mov	bh, 0
 144E  B3 07			        mov	bl, 7

 1450  AC				lodsb
 1451  3C 0D				cmp	al, 0Dh ; ENTER/RETURN Char
 1453  75 03				jne	short suf_7
 1455  49				dec	cx
 1456  EB 04				jmp	short suf_8	
 1458				suf_7:
 1458  3C 09				cmp	al, 09h ; TAB Space Char
 145A  74 22			        je	short suf_10
 145C				suf_8:
 145C  B4 0E			        mov	ah, 0Eh
				        ;xor	bh, bh ; mov	bh, 0
				        ;mov	bl, 7
 145E  CD 10				int	10h
 1460				suf_9:
 1460  4F				dec	di
 1461  75 D4				jnz	short suf_3

					;mov	ax, word ptr [u_nread]

					; 12/01/2020
 1463  A1 3044 R		        mov	ax, word ptr [inode_size]
 1466  8B 16 3046 R			mov	dx, word ptr [inode_size+2] 
 146A  2B 06 3A4C R			sub	ax, word ptr [u_off]
 146E  1B 16 3A4E R			sbb	dx, word ptr [u_off+2] 
 1472  75 05				jnz	short suf_14 
 1474				suf_13:
 1474  3D 0200				cmp	ax, 512
 1477  76 9D				jna	short suf_2
 1479				suf_14:
 1479  B8 0200				mov	ax, 512
 147C  EB 98				jmp	short suf_2
 147E				suf_10:
 147E  51			        push	cx
				        ;xor	bh, bh ; mov	bh, 0
 147F  B4 03			        mov	ah, 03h ; get cursor position and size.
 1481  CD 10			        int	10h
 1483  8A C2				mov	al, dl
 1485  B9 0008				mov	cx, 8
				;suf_11a:
				;	cmp	al, cl
				;	jb	short suf_11b
				;	sub	al, cl
				;	jmp	short suf_11a
				;suf_11b:
				;	sub	cl, al
 1488				suf_11:
					; 07/01/2013
 1488  32 E4				xor	ah, ah
 148A  F6 F1				div	cl
 148C  2A CC				sub	cl, ah	
					;
 148E  B0 20			        mov	al, 20h
 1490  B4 0E			        mov	ah, 0Eh 
				        ;mov	bl, 7 ; char color attribute	
 1492				suf_12:
 1492  CD 10				int	10h
 1494  E2 FC			        loop	suf_12
 1496  59			        pop	cx
 1497  EB C7				jmp	short suf_9 

 1499				show_file endp

 1499				namei	proc near
					; 15/01/2020
					; 29/12/2019
					; 02/10/2019
					; 24/09/2019
					; 20/09/2019 - Retro UNIX 386 v2 (modified unix v7 inode structure)	
					; 04/12/2015 (14 byte file names)
					; 05/01/2013
					; 09/12/2012 unixcopy.asm
					;       Retro UNIX v1 FS file import/export version
					; 31/10/2012
					; 14/10/2012
				     	; 07/10/2012
					; Derived from (original) UNIX v1 source code
					; PRELIMINARY release of Unix Implementation Document, 
					; 20/6/1972
					;
					; RETRO UNIX v1 FS
					;
					; return i-number of file (in AX)
					;
					; input:
					; u_namep = pointer to file path name
					; u_cdir = i-number of users directory
					; ;;u_cdev = device number
					; output:
					; cf= 0 -> no error, i-number in AX (R1)
					; cf= 1 -> error code in AX
					;	

 1499  8B 36 3080 R			mov	si, word ptr [u_namep]
 149D				namei_x: ; 02/10/2019 {si = [u_namep]}
 149D  80 3C 2F				cmp	byte ptr [si], '/' ; is first char in file name a /
 14A0  75 0A				jne	short @f
					;mov	ax, ROOT_DIR_INODE_NUMBER ; = 41 ( = 1 for runix v2)
					; Put i-number of root directory in R1
					; 29/12/2019
 14A2  BB 0001				mov	bx, ROOT_DIR_INODE_NUMBER ; 1

					;xor	dx, dx
 14A5  46				inc	si  ; go to next char
 14A6  89 36 3080 R			mov	word ptr [u_namep], si
 14AA  EB 04				jmp	short namei_0
 14AC				@@:
					;mov	dx, word ptr [u_cdev]

					;mov	ax, word ptr [u_cdir] 
					; put i-number of current directory in R1
					; 29/12/2019
 14AC  8B 1E 307E R			mov	bx, word ptr [u_cdir]

 14B0				namei_0:
					;mov	word ptr [cdev], dx 
					; device file for users directory into cdev
				; 1
 14B0  80 3C 00				cmp	byte ptr [si], 0 ; is the character in file name a nul
 14B3  76 0F			        jna	short namei_7 ;nig

 14B5				namei_1: ; 1	
					; get i-node with i-number r1
					
					; 26/12/2019
					;mov	bx, ax

 14B5  E8 0134				call	iget
 14B8  72 0A				jc	short namei_7

					;test	word ptr [inode_flgs], 4000h ; directory i-node ?
				        ;jz	short namei_6 ; got an error
 14BA  F6 06 303D R 40			test	byte ptr [inode_flgs+1], 40h ; 24/09/2019
 14BF  75 04			        jnz	short @f
				;nib:
 14C1				namei_6:
 14C1  B4 FF				mov	ah, 0FFh ; Error code
 14C3  F9				stc
				;nig:
 14C4				namei_7:
 14C4  C3				retn
 14C5				@@:
					; 17/01/2020 (32 bit directory size)
 14C5  A1 3044 R			mov	ax, word ptr [inode_size]
 14C8  8B 16 3046 R			mov	dx, word ptr [inode_size+2] ; 01/01/2020
 14CC  A3 3082 R			mov	word ptr [u_dirp], ax ; put size of directory in u.dirp
 14CF  89 16 3084 R			mov	word ptr [u_dirp+2], dx ; 01/01/2020	
 14D3  33 C0				xor	ax, ax 
 14D5  A3 3A4C R			mov	word ptr [u_off], ax ; u.off is file offset used by user
					; 15/01/2020
 14D8  A3 3A4E R			mov	word ptr [u_off+2], ax ; 29/12/2019

					;mov	word ptr [u_fofp], offset u.off
						; u.fofp is a pointer to the offset portion 
						; of fsp entry
 14DB				namei_2: ; 2
 14DB  C7 06 3A52 R 3086 R		mov	word ptr [u_base], offset u_dirbuf
						; u.dirbuf holds a file name copied from
						; a directory	
 14E1  C7 06 3A50 R 0010		mov	word ptr [u_count], 16 ; 04/12/2015 (10 -> 16) 	
				 	
					;mov	ax, word ptr [ii]
					; 26/12/2019
 14E7  8B 1E 3A5E R			mov	bx, word ptr [ii]
					 	
 14EB  E8 005A				call	readi	; read 16 bytes of file with i-number (R1)
						; i.e. read a directory entry
 14EE  72 D4				jc	short namei_7
					
 14F0  8B 0E 3A54 R			mov	cx, word ptr [u_nread]

 14F4  0B C9				or	cx, cx
 14F6  76 C9				jna	short namei_6	; nib ; gives error return 
					
 14F8  8B 1E 3086 R			mov	bx, word ptr [u_dirbuf]
 14FC  23 DB				and	bx, bx       
 14FE  75 16				jnz	short namei_3	; 3f. branch when active directory entry
						; (i-node word in entry non zero)	
					; 15/01/2020
 1500  A1 3A4C R			mov	ax, word ptr [u_off]
 1503  8B 16 3A4E R			mov	dx, word ptr [u_off+2] ; 01/01/2020 (32 bit offset)	
 1507  83 E8 10				sub	ax, 16   ; 04/12/2015 (10 -> 16)
 150A  83 DA 00				sbb	dx, 0 ; 01/01/2020
 150D  A3 3082 R			mov	word ptr [u_dirp], ax
 1510  89 16 3084 R			mov	word ptr [u_dirp+2], dx ; 01/01/2020
 1514  EB C5				jmp	short namei_2 ; 2b

 1516				namei_3: ; 3
 1516  8B 36 3080 R			mov	si, word ptr [u_namep] ; r2, u.namep points into a file name string
 151A  BF 3088 R			mov	di, offset u_dirbuf + 2 ; r3, points to file name of directory entry
 151D  BA 3096 R			mov	dx, offset u_dirbuf + 16 ; 04/12/2015 (10 -> 16)
 1520				@@:	; 3
 1520  AC				lodsb  ; mov al, byte ptr [si] ; inc si ; (al = r4)
 1521  0A C0			 	or	al, al
 1523  74 0D				jz	short namei_4 ; 3f. If char is nul, then the last char in string has
								; been compared
 1525  3C 2F				cmp	al, "/"	; is char a "/"
 1527  74 09				je	short namei_4 ; 3f
 1529  3B FA				cmp	di, dx	; offset u_dirbuf + 16 ; 04/12/2015 (10 -> 16) ; r3, 
						; have i checked all 14 bytes of file name
 152B  74 F3				je	short @b ; 3b
 152D  AE				scasb	; cmpb (r3)+, r4 (DI=R3, AL=R4)
						; compare char in u.namep string to file name char
						; read from
 152E  74 F0				je	short @b ; directory; brach if chars match
					
 1530  EB A9				jmp	short namei_2 ; 2b
						; File names do not match, go to next directory entry 	
 1532				namei_4: ; 3
 1532  3B FA				cmp	di, dx	; offset u_dirbuf + 16 ; 04/12/2015 (10 -> 16) ; r3, 
						; if equal all 14 bytes were matched
 1534  74 06				je	short namei_5 ; 3f

 1536  8A 25				mov	ah, byte ptr [di]
					;inc	di  ; 05/01/2013
 1538  22 E4				and	ah, ah  ; tstb (r3)+, bne 2b
 153A  75 9F				jnz	short namei_2 ; 2b

 153C				namei_5: ; 3
 153C  89 36 3080 R			mov	word ptr [u_namep], si ; r2
						; u.namep points to char following a "/" or nul
					;mov	bx, word ptr [u_dirbuf] ; r1
					
 1540  22 C0				and	al, al	; r4. If r4=0 the end of file name reached,
							; if r4="/" then go to next directory
					; 29/12/2019
					;mov	ax, bx

				        ;jnz	namei_1 ; 1b
					; 27/03/2022
 1542  74 03				jz	short namei_8
 1544  E9 FF6E				jmp	namei_1
 1547				namei_8:
					; bx = inode number

 1547  C3				retn

 1548				namei	endp

 1548				readi	proc near
					; 16/01/2020
					; 29/12/2019
					; 26/12/2019 
					; 17/12/2019
					; 20/09/2019 - Retro UNIX 386 v2 (modified unix v7 inode structure)	
					; 01/03/2013
					; 14/10/2012
					; Boot sector version of "readi" procedure
				     	; Derived from (original) UNIX v1 source code
					; PRELIMINARY release of Unix Implementation Document, 
					; 20/6/1972
					;;AX (R1) = i-number 
					; RETRO UNIX v1 FS
					; Boot sector version
					;
					; read from an i-node
					;
					; 29/12/2019
					; INPUT:
					;	bx = inode number
					;	word [u_count] = count
					;	[u_fofp] = u_off
					;	dword ptr [u_off] = file pointer
					;	dword [inode_size] = file size
					;	
					; OUTPUT:
					;	bx = inode number
					;	cf = 0 -> reading ok, [Error] = 0
					;	cf = 1 -> error, error code in [Error] 
					; 	
					; Modified registers: ax,dx,cx,si,di
					
 1548  33 D2				xor	dx,dx ; 0
 154A  89 16 3A54 R			mov	word ptr [u_nread],dx ; accumulated number of bytes transmitted
 154E  39 16 3A50 R			cmp	word ptr [u_count],dx ; is number of byte to read greater than 0
 1552  76 18				jna	short readinode_retn

 1554				readinode_1:
					; BX = I-Number ; 26/12/2019
 1554  53				push	bx ; *

 1555  E8 0094				call	iget	; get i-node into i-node section of core
 1558  72 11				jc	short readinode_3 ; 01/03/2013

					; 17/12/2019
 155A  A0 303D R			mov	al,byte ptr [inode_flgs+1]
 155D  A8 80				test 	al,80h	; regular file ?
 155F  75 0C				jnz	short readinode_4	; yes
 1561  A8 20				test 	al,20h 	; device file ?
					;;jnz	short readinode_5 ; yes
					;jz	short readinode_4
					;;test	al,40h	; directory ?
					;;jnz	short readinode_4 ; yes
 1563  74 08				jz	short readinode_4

					; 29/12/2019
 1565  C6 06 3A56 R FF			mov	byte ptr [Error],0FFh ; invalid file

 156A				readinode_5:
 156A  F9				stc
 156B				readinode_3:
 156B  5B				pop	bx ; * ; i-number
 156C				readinode_retn:
 156C  C3				retn 

 156D				readinode_4:
					; 17/12/2019
					;mov	si,word ptr [u_fofp]

					; 29/12/2019
 156D  BE 3A4C R			mov	si,offset u_off

					; 32 bit file size & 32 bit file pointer (17/12/2019)

 1570  A1 3044 R			mov	ax,word ptr [inode_size]  ; file size lw
 1573  8B 16 3046 R			mov	dx,word ptr [inode_size+2] ; file size rw
					; Note: we don't regard 5th byte of file size (inode_size_h) for now!

 1577  2B 04				sub	ax,word ptr [si]
 1579  1B 54 02				sbb	dx,word ptr [si+2]
 157C  75 0D				jnz	short readinode_2 ; remain bytes more than requested count

					; 16/01/2020
 157E  0B C0				or	ax,ax
 1580  74 E9				jz	short readinode_3

 1582  3B 06 3A50 R			cmp	ax,word ptr [u_count] 
						; are enough bytes left in file to carry out read ?
 1586  73 03				jnb	short readinode_2 ; remain bytes more than requested count
 1588  A3 3A50 R			mov	word ptr [u_count],ax  ; fix read count to end of file

 158B				readinode_2:
 158B  E8 0100				call	mget	; returns physical block number of block in file 
							; where offset points
 158E  72 DB				jc	short readinode_3 ; 01/03/2013

					; 17/12/2019
					; DX:AX = Physical block number

					; Check current sector in the buffer

 1590  80 3E 3A4A R 01			cmp	byte ptr [buff_m],1
 1595  72 25				jb	short readinode_7

 1597  8B 0E 3A46 R			mov	cx,word ptr [buff_s]
 159B  8B 1E 3A48 R			mov	bx,word ptr [buff_s+2]
					;mov	si,cx
					;or	si,bx
					;jz	short readinode_sioreg ; buff_s = 0 is invalid	
					;cmp	si,0FFFFh	; buff_s = 0FFFFh is invalid
					;je	short readinode_sioreg

					; write buffer content if sector is not same

 159F  3B C8				cmp	cx,ax
 15A1  75 04				jne	short readinode_6
 15A3  3B DA				cmp	bx,dx
 15A5  74 30				je	short readinode_sioreg
 15A7				readinode_6:
 15A7  52				push	dx
 15A8  50				push	ax
					; 17/12/2019
					;mov	ax,word ptr [buff_s]
					;mov	dx,word ptr [buff_s+2]
 15A9  8B C1				mov	ax,cx
 15AB  8B D3				mov	dx,bx
 15AD  BB 3EB0 R			mov	bx,offset Buffer
 15B0  E8 0713				call	dskwr
 15B3  58				pop	ax
 15B4  5A				pop	dx
 15B5  72 B4				jc	short readinode_3
 15B7  C6 06 3A4A R 00			mov	byte ptr [buff_m],0
 15BC				readinode_7:	
					; 17/12/2019
 15BC  3B 06 3A46 R			cmp	ax,word ptr [buff_s]
 15C0  75 06				jne	short readinode_8
 15C2  3B 16 3A48 R			cmp	dx,word ptr [buff_s+2]
 15C6  74 0F				je	short readinode_sioreg
 15C8				readinode_8:
 15C8  BB 3EB0 R			mov	bx,offset Buffer ; 29/12/2019
 15CB  E8 06FF				call	dskrd	; read in block, BX points to 1st word of data in
						; buffer
 15CE  72 9B				jc	short readinode_3

					; 17/12/2019
 15D0  A3 3A46 R			mov	word ptr [buff_s],ax
 15D3  89 16 3A48 R			mov	word ptr [buff_s+2],dx
 15D7				readinode_sioreg:
				        ;mov	si,word ptr [u_off] ; R2
					;mov	cx,si ; cx = R3, si = R2
					
					; 17/12/2019
 15D7  E8 0810				call	sioreg

					; SI = file (user data) offset
					; DI = sector (I/O) buffer offset
					; CX = byte count

 15DA  87 F7				xchg	si,di ; 17/12/2019 

 15DC  F3/ A4			        rep	movsb

					;pop	ax ; * ; i-number

 15DE  83 3E 3A50 R 00			cmp	word ptr [u_count],0
					;;ja	short readinode_1
 15E3  77 88				ja	short readinode_4 ; 17/12/2019

 15E5  C6 06 3A56 R 00			mov	byte ptr [Error],0 ; 17/12/2019

					;retn

 15EA  5B				pop	bx ; * ; i-number ; 26/12/2019

 15EB  C3				retn 

 15EC				readi	endp

 15EC				iget 	proc near
					; 22/01/2020
					; 25/12/2019
					; 27/11/2019
					; 07/11/2019 - Retro UNIX 386 v2
					; 16/9/2012
				     	; 14/7/2012
				     	; Derived from (original) UNIX v1 source code
					; PRELIMINARY release of Unix Implementation Document, 
					; 20/6/1972
					;; AX=R0, BX=R1 
					; RETRO UNIX v1 FS
					; initialization/format version
					; (cdev, idev,mnt, mntd are excluded)
					;; return => if cf=1 error number in [Error] 

					; 27/11/2019
					; INPUT:
					; 	BX = inode number (0 if current inode)
					; OUTPUT:
					;	BX = inode number if cf = 0
					;	
					; Modified registers: ax,bx,cx,dx 

 15EC  3B 1E 3A5E R			cmp	bx,word ptr [ii] ; BX (R1) = i-number of current file
 15F0  74 2A				je	short iget_5
 15F2				iget_1:
					;push	ax ; **
 15F2  32 E4				xor	ah,ah ; mov	ah,0
 15F4  A0 3A5A R			mov	al,byte ptr [imod]
 15F7  22 C0				and	al,al ; has i-node of current file been modified ?	
 15F9  74 12				jz	short iget_2 ; no
					;xor	al,al ; mov	al,0
					;mov	byte ptr [imod],al 
 15FB  53				push	bx ; * inode number
 15FC  8B 1E 3A5E R			mov	bx,word ptr [ii]	
					;inc	al ; mov	al,1
 1600  B0 01				mov	al,1 ; 25/12/2019	
					; ax = 1 = write
 1602  E8 0018				call	icalc
 1605  5B				pop	bx ; *
 1606  72 14				jc	short iget_4
					; 27/11/2019
 1608  33 C0				xor	ax,ax
					; 25/12/2019
					;mov	byte ptr [imod],al ; 0
					; 22/01/2020
 160A  A3 3A5A R			mov	word ptr [imod],ax ; 0 ; reset [imod] & [imodx]
 160D				iget_2:
 160D  23 DB				and	bx,bx
 160F  74 07				jz	short iget_3 ; get current inode
 1611  89 1E 3A5E R			mov	word ptr [ii],bx	
					; ax = 0 = read
 1615  E8 0005				call	icalc
 1618				iget_3:
 1618  8B 1E 3A5E R			mov	bx,word ptr [ii]
 161C				iget_4:
					;pop	ax ; **
 161C				iget_5:
 161C  C3				retn

 161D				iget	endp

 161D				icalc 	proc near
					; 17/01/2020 
					; 26/12/2019
					; 14/12/2019
					; 12/12/2019
					; 09/11/2019
					; 07/11/2019 - Retro UNIX 386 v2 
					;	       (for hard disk file system)
					; 07/09/2019
					; 02/09/2019
					; 01/09/2019 - Retro UNIX 386 v2
					; 17/8/2012
					; 16/8/2012
					; 15/8/2012
					; 14/8/2012
					; 13/8/2012
				        ; 15/7/2012
				     	; 14/7/2012
				     	; Derived from (original) UNIX v1 source code
					; PRELIMINARY release of Unix Implementation Document, 
					; 20/6/1972
					;; AX=R0, BX=R1, CX=R3, DX=R5 
					; 0 = read, 1 = write
					; RETRO UNIX v1 FS
					; initialization/format version
					;
				        ; i-node is located in block (i+47)/16 and
					; begins 32*(i+47) mod 16 bytes from its start
					;; return => if cf=1 error number in [Error]
					;
					; input -> ax = 0 -> read, 1 = write
					;
					; 09/11/2019
					; modified registers: ax,dx,cx,bx

					;add	bx,47 ; add 47 to inode number, 15/8/2012
					;push	bx ; R1 -> -(SP)
					;shr	bx,1 ; divide by 16
					;shr	bx,1
					;shr	bx,1
					;shr	bx,1

					; 07/11/2019
					; inode 1 (1st inode) is on sector 4 
					; sector 0 : boot sector
					; sector 1 : super block
					; sector 2 : inodes map
					; sector 3 : free blocks map
					; sector 4 to 35 : inodes (32 sectors)

					; 08/09/2019
					;add	bx,31 ; add 31 to inode number
					;push	bx
					;shr	bx,1  ; divide by 8	
					;shr	bx,1
					;shr	bx,1
					; bx contains block number of block in which
					; inode exists

					; 07/11/2019 - Hard disk file system (RUFS v2)
					; inode table start sector: [systm.sb_InodeTblAddr]
					
 161D  4B				dec	bx ; 0 based inode number

					;mov	dx,bx ; 12/12/2012
 161E  8B CB				mov	cx,bx ; 26/12/2019

					; 17/01/2020
 1620  A2 3A6C R			mov	byte ptr [I_rw],al ; 0 = read, 1 = write

 1623  A1 3CD8 R			mov	ax,word ptr [systm.sb_InodeTblAddr]
 1626  8B 16 3CDA R			mov	dx,word ptr [systm.sb_InodeTblAddr+2] ; = 0

 162A  83 E1 F8				and	cx,0FFF8h
 162D  74 0B				jz	short @f ; [I_sector] = 0 for inodes 1 to 8

					; 26/12/2019 (bx -> cx)
 162F  D1 E9				shr	cx,1
 1631  D1 E9				shr	cx,1
 1633  D1 E9				shr	cx,1
					; cx = sector offset (8 inodes per sector)

					; 09/11/2019
					;mov	byte ptr [I_rw],al ; 0 = read, 1 = write

					; 26/12/2019
					;mov	ax,word ptr [systm.sb_InodeTblAddr]
					;mov	dx,word ptr [systm.sb_InodeTblAddr+2] ; = 0
					
 1635  03 C1				add	ax,cx ; cx = [I_sector] ?
 1637  83 D2 00				adc	dx,0
 163A				@@:
 163A  80 3E 3A6D R 00			cmp	byte ptr [I_valid],0
 163F  76 0B				jna	short icalc_0
					; 26/12/2019
 1641  3B 0E 3A6E R			cmp	cx,word ptr [I_sector]
 1645  74 18				je	short icalc_1
					
 1647  C6 06 3A6D R 00			mov	byte ptr [I_valid],0 ; inode sector validation, invalid
 164C				icalc_0:
					; 26/12/2019
 164C  89 0E 3A6E R			mov	word ptr [I_sector],cx
					
					;mov	ax,word ptr [systm.sb_InodeTblAddr]
					;mov	dx,word ptr [systm.sb_InodeTblAddr+2] ; = 0
					
					;add	ax,word ptr [I_sector]
					;adc	dx,0

 1650  53				push	bx ; inode number - 1 ; (root dir inode = 1)

 1651  BB 40B0 R			mov	bx,offset I_buffer
 1654  E8 0676				call	dskrd
					;pop	dx ; 14/8/2012
 1657  5B				pop	bx ; 26/12/2019
 1658  72 33				jc	short icalc_5

 165A  C6 06 3A6D R 01			mov	byte ptr [I_valid],1 ; inode sector validation, valid
 165F				icalc_1:
					; 26/12/2019
 165F  57				push	di
 1660  56				push	si

 1661  8B FB				mov	di,bx ; 26/12/2019

					;and	dx,0Fh	; (i+47) mod 16
					;shl	dx,1
					;shl	dx,1
					;shl	dx,1
					;shl	dx,1
					;shl	dx,1
					; DX = 32 * ((i+47) mod 16)	
					; DX (R5) points to first word in i-node i.

					;and	dx,07h	; (i+31) mod 8
 1663  83 E7 07				and	di,07h ; 26/12/2019
 1666  74 04				jz	short @f ; 29/09/2019 
					;shl	dx,1
					;shl	dx,1
					;shl	dx,1
					;shl	dx,1	
					;shl	dx,1
					;shl	dx,1
 1668  B1 06				mov	cl,6
					;shl	dx,cl	
					; DX = 64 * ((i+31) mod 8)
					; DX points to first word in i-node i.	
 166A  D3 E7				shl	di,cl ; 26/12/2019
 166C				@@:
					; 14/8/2012
					;push	di
					;push	si
					
 166C  BE 303C R			mov	si,offset inode ; 14/8/2012
					; inode is address of first word of current inode
					;mov	cx,16 ; CX = R3
					; 02/09/2019
 166F  B9 0020				mov	cx,32 ; inode size/2 for Retro UNIX 386 v2 (& UNIX v7)	

					; 09/09/2019
					;push	ax

					;mov	di,offset Buffer ; 16/8/2012
					;mov	di,word ptr [buff_o] ; 02/09/2019 - Retro UNIX 386 v2

					; 04/12/2019
					;mov	di,offset I_buffer

					;;add	di,dx ; 13/8/2012
					;add	di,bx ; 26/12/2019

					; 30/12/2019
 1672  81 C7 40B0 R			add	di,offset I_buffer

				 	;and	ax,ax
					;jz	short icalc_3 ; 0 = read (and copy i-node to memory) 

 1676  80 3E 3A6C R 00			cmp	byte ptr [I_rw],0
 167B  76 0A				jna	short icalc_3 ; read	
 167D				icalc_2:
					; 14/8/2012
					; overwrite old i-node (in buffer to be written)
 167D  F3/ A5				rep	movsw

					; 26/12/2019
					; 14/12/2019
					;mov	ax,word ptr [systm.sb_InodeTblAddr]
					;mov	dx,word ptr [systm.sb_InodeTblAddr+2] ; = 0
					
					;add	ax,word ptr [I_sector]
					;adc	dx,0

 167F  BB 40B0 R			mov	bx,offset I_buffer

					; 31/10/2012

 1682  E8 0641				call	dskwr
 1685  EB 04				jmp	short icalc_4
 1687				icalc_3:
 1687  87 F7				xchg	si,di ; 14/8/2012	
					; copy new i-node into inode area of (core) memory
 1689  F3/ A5				rep	movsw
 168B				icalc_4:
					;pop	ax ; 09/09/2019
					; 14/8/2012
 168B  5E				pop	si
 168C  5F				pop	di

					; OUTPUTS ->
					; inode 
					; DX/R5 (internal), BX/R1 (internal), CX/R3 (internal) 
 168D				icalc_5:	
 168D  C3				retn	 

 168E				icalc 	endp

 168E				mget 	proc near
					; 25/01/2020
					; 22/01/2020
					; 13/01/2020
					; 07/01/2020
					; 30/12/2019
					; 29/12/2019
					; 18/12/2019
					; 12/12/2019
					; 08/12/2019
					; 05/12/2019
					; get sector/block address for current file pointer
					; (if file pointer points a number greater than current file size, 
					; a new -empty- sector/block will be created/written) 
					; 04/12/2019
					; 01/12/2019
					; 27/11/2019
					; 13/11/2019
					; 09/11/2019 - Retro UNIX 386 v2 (32 bit sector/block numbers)
					; 15/09/2019
					; 04/09/2019 (simplified for initialization floppy disk)
					; 03/09/2019 - Retro UNIX 386 v2
					; 05/03/2013
					; 01/03/2013
					; 31/10/2012
					; 20/10/2012
					; 19/08/2012
					; 13/08/2012
					; 27/07/2012
				     	; 21/07/2012
				     	; Derived from (original) UNIX v1 source code
					; PRELIMINARY release of Unix Implementation Document, 
					; 20/6/1972
					;; return -> AX=R1
					; RETRO UNIX v1 FS
					; initialization/format version
					; cf -> 1 = error (no free block)

					; 01/12/2019
					; INPUT:
					;	[u_fofp] = pointer to file pointer
					; OUTPUT:
					;	dx:ax = sector/block address
					;
					; Modified registers: ax,dx,cx,bx,si,di

					;push	bx
					;push	cx
					;push	dx
					 ;; contents of bx,cx,dx will be destroyed 
 168E				mget_0:
					;mov	bx,word ptr [u_fofp]
					; 29/12/2019
 168E  BB 3A4C R			mov	bx,offset u_off
					; 13/11/2019
 1691  8B 07				mov	ax,word ptr [bx]
 1693  8B 57 02				mov	dx,word ptr [bx+2]
						
					; 31/10/2012
					;mov	bx,word ptr [u_fofp]
					;mov	ax,word ptr [bx]

					;mov	bl,ah  ; div ax by 256
					;xor	bh,bh

					; BX = R2
				        ;test 	word ptr [inode_flgs],4096 ; 1000h
						  	     ; is this a large or small file
					;jnz	short mget_8 ; 4f ; large file

 1696  F6 06 303D R 10			test 	byte ptr [inode_flgs+1],16 ; 10h
					;jnz	mget_8 ; not small file
					; 22/01/2020
 169B  74 03				jz	short @f
 169D  E9 00D2				jmp	mget_8	
 16A0				@@:	
				        ;test 	bl,0F0h ; !0Fh  ; branch if BX (R2) >= 16	    
					;jnz	short mget_3 ; 3f

					; 13/11/2019
					; small file size limit = 5120 bytes (1400h)

 16A0  0B D2				or	dx,dx
 16A2  75 68				jnz	short mget_3  ; requested file offset > 65535

					; 13/11/2019
					; Retro UNIX 386 v2 disk inode contains..
					; (if large file flag is clear -not set-)
					; 10 direct disk block/sector dword pointers

					; 15/09/2019
					;cmp	bl,14h
 16A4  80 FC 14				cmp	ah,14h
 16A7  73 63				jnb	short mget_3 ; 3f ; requested offset >= 5120

					; 01/12/2019
 16A9  8A DC				mov	bl,ah  ; div ax by 256
 16AB  32 FF				xor	bh,bh

					;and	bl,0Eh  ; clear all bits but bits 1,2,3
 16AD  80 E3 1E				and	bl,1Eh ; 15/09/2019 ; clear all bits but bits 1,2,3,4

 16B0  D0 E3				shl	bl,1 ; 03/09/2019 - Retro UNIX 386 v2
 16B2  8B 87 3048 R			mov	ax,word ptr [bx+inode_dskp] ; AX = R1, physical block number
					; 09/11/2019
 16B6  8B 97 304A R			mov	dx,word ptr [bx+inode_dskp+2] ; DX = hw of physical block number
 16BA  0B C0				or	ax,ax
 16BC  75 4D				jnz	short mget_2 ; if physical block number is zero
						 ; then we need a new block for file
					; 09/11/2019
 16BE  0B D2				or	dx,dx
 16C0  75 49				jnz	short mget_2

 16C2  E8 0202				call	alloc	 ; allocate a new block for this file	
						 ; AX (R1) = Block number
					;jc	short mget_6 ; cf -> 1 & ax = 0 -> no free block
					; 22/01/2020
 16C5  73 01				jnc	short @f

 16C7				mget_6: 
					;mov	word ptr [Error],err_NOFREEBLOCK
					
					;pop	dx
					;pop	cx
					;pop	bx
 16C7				mget_7:	
 16C7  C3				retn
 16C8				@@:
					; 09/11/2019
 16C8  89 87 3048 R			mov	word ptr [bx+inode_dskp],ax
 16CC  89 97 304A R			mov	word ptr [bx+inode_dskp+2],dx 

 16D0  E8 042A				call	setimod

					; 09/09/2019
					;mov	byte ptr [buff_c],1

					; 08/12/2019
 16D3  BB 3EB0 R			mov	bx,offset Buffer

					; 04/12/2019
 16D6  80 3E 3A4A R 00			cmp	byte ptr [buff_m],0 ; buffer modified ?
 16DB  76 15				jna	short mget_1

 16DD  52				push	dx
 16DE  50				push	ax
 16DF  A1 3A46 R			mov	ax,word ptr [buff_s]
 16E2  8B 16 3A48 R			mov	dx,word ptr [buff_s+2]
					;mov	bx,offset Buffer
 16E6  E8 05DD				call	dskwr
 16E9  58				pop	ax
 16EA  5A				pop	dx
 16EB  72 1E				jc	short mget_2
 16ED  C6 06 3A4A R 00			mov	byte ptr [buff_m],0 ; reset buffer modified sign

 16F2				mget_1:
 16F2  A3 3A46 R			mov	word ptr [buff_s],ax
 16F5  89 16 3A48 R			mov	word ptr [buff_s+2],dx

					; 05/12/2019
 16F9  C6 06 3A4A R 01			mov	byte ptr [buff_m],1 ; set buffer modified sign

 16FE  E8 044F				call	clear	; clear Buffer

					; BX = offset Buffer

 1701  E8 05C2				call	dskwr
 1704  72 05				jc	short mget_2

 1706  C6 06 3A4A R 00			mov	byte ptr [buff_m],0 ; reset buffer modified sign

 170B				mget_2: ; 2
					; AX (R1) = Physical block number
					; DX = High word of block/sector number ; 09/11/2019

					;pop	dx
					;pop	cx
					;pop	bx

 170B  C3				retn

 170C				mget_3: ; 3
					; adding on block which changes small file to large file
 170C  E8 01B8				call	alloc
 170F  72 B6				jc	short mget_6 ; 01/03/2013 
					; 22/01/2020
					;jnc	short @f

				;mget_6: 
				;	;mov	word ptr [Error],err_NOFREEBLOCK
				;	
				;	;pop	dx
				;	;pop	cx
				;	;pop	bx
				;mget_7:	
				;	retn
				;@@:	
					;call	wslot  ; setup I/O buffer for write
					;	   ; R5 points to the first data word in buffer

					;push	ds
					;pop	es

					; 07/01/2020
 1711  BB 3EB0 R			mov	bx,offset Buffer

					; 18/12/2019
 1714  80 3E 3A4A R 00			cmp	byte ptr [buff_m],0 ; buffer modified ?
 1719  76 15				jna	short mget_4

 171B  52				push	dx
 171C  50				push	ax
 171D  A1 3A46 R			mov	ax,word ptr [buff_s]
 1720  8B 16 3A48 R			mov	dx,word ptr [buff_s+2]
					;mov	bx,offset Buffer ; 07/01/2020
 1724  E8 059F				call	dskwr
 1727  58				pop	ax
 1728  5A				pop	dx
 1729  72 E0				jc	short mget_2
 172B  C6 06 3A4A R 00			mov	byte ptr [buff_m],0 ; reset buffer modified sign
 1730				mget_4:
					; 09/11/2019
 1730  A3 3A46 R			mov	word ptr [buff_s],ax  ; Block/Sector number
 1733  89 16 3A48 R			mov	word ptr [buff_s+2],dx

					; 13/01/2020 (si, di)
					;push	si
					;push	di
 1737  50				push	ax

					;mov	cx,8  ; R3, transfer old physical block pointers
						      ; into new indirect block area for the new
						      ; large file	
 1738  B9 000A				mov	cx,10 ; 15/09/2019	
					; 09/11/2019
					;mov	di,offset Buffer ; BX = R5 ; 07/01/2020
					;mov	di,word ptr [buff_o]  ; 03/09/2019
 173B  BE 3048 R			mov	si,offset inode_dskp
					; 07/01/2020
 173E  8B FB				mov	di,bx ; offset Buffer 

 1740  33 C0				xor	ax,ax ; mov	ax,0
 1742				mget_5: ; 1
 1742  A5				movsw
 1743  A5				movsw ; 07/09/2019
 1744  89 44 FE				mov	word ptr [si-2],ax ; 13/01/2020
 1747  89 44 FC				mov	word ptr [si-4],ax ; 07/09/2019
 174A  E2 F6				loop	mget_5
					
					;;mov	cl,256-8 ; clear rest of data buffer
					;mov	cl,256-16 ; 07/09/2019
 174C  B1 EC				mov	cl,256-20 ; 15/09/2019	

 174E  F3/ AB				rep	stosw  ; clear buffer offset 40 to 512 (472 bytes)

 1750  58				pop	ax
					;pop	di ; 13/01/2020
					;pop	si

 1751  C6 06 3A4A R 01			mov	byte ptr [buff_m],1 ; modified

 1756  E8 056D				call	dskwr
					;jc	short mget_7 ; 01/03/2013
					; 22/01/2020
 1759  72 B0				jc	short mget_2	

 175B  A3 3048 R			mov	word ptr [inode_dskp],ax
					; 09/11/2019
 175E  89 16 304A R			mov	word ptr [inode_dskp+2],dx
 1762  C6 06 3A4A R 00			mov	byte ptr [buff_m],0 ; reset modified sign
					
					;or	word ptr [inode_flgs],4096 ; 1000h

 1767  80 0E 303D R 10			or	byte ptr [inode_flgs+1],10000b ; 10h ; 16

 176C  E8 038E				call	setimod

					; 15/09/2019
 176F  E9 FF1C				jmp	mget_0

				;mget_6: 
				;	;mov	word ptr [Error],err_NOFREEBLOCK
				;	
				;	;pop	dx
				;	;pop	cx
				;	;pop	bx
				;mget_7:	
				;	retn

 1772				mget_8:	; 4 ; large file
					; 13/11/2019

					; Retro UNIX 386 v2 disk inode contains..
					; (if large file flag is set)
					; 8 indirect disk block/sector dword pointers
					; +1 double indirect disk block/sector dword pointers
					; +1 triple indirect disk block/sector dword pointers

					; check indirect pointers limit (as file offset)
					; 8*128 = 1024 blocks (or sectors) or 512 KB
					; check dx (file offset hw) value
					
 1772  83 FA 08				cmp	dx,08h ; 524288 = 080000h
 1775  73 20				jnb	short mget_9 ; check double indirect limit

 1777  C6 06 3A68 R 01			mov	byte ptr [level],1
 177C  B9 0009				mov	cx,9
 177F  E8 EDAA				call	shr32
					; ax = sector offset (flat)
					; dx = 0
 1782  8A C8				mov	cl,al
 1784  80 E1 7F				and	cl,127
 1787  88 0E 3A69 R			mov	byte ptr [level+1],cl
 178B  B1 07				mov	cl,7	
					;call	shr32
 178D  D3 E8				shr	ax,cl  ; 13/01/2020
					; ax = indirect pointer index (<= 7)
					; dx = 0
					;mov	byte ptr [level+2],al
					; 15/11/2019
 178F  D0 E0				shl	al,1
 1791  D0 E0				shl	al,1
 1793  8B F0				mov	si,ax

 1795  EB 5A				jmp	short mget_11
 1797				mget_9:
					; check double indirect pointers limit (as file offset)
					; (128*128)+1024 = 16384+1024 blocks or 8 MB + 512 KB
					; check dx (file offset hw) value
					
 1797  81 FA 0088			cmp	dx,88h ; 8912896 = 880000h	
 179B  73 24				jnb	short mget_10

 179D  C6 06 3A68 R 02			mov	byte ptr [level],2
 17A2  83 EA 08				sub	dx,08h
 17A5  B9 0009				mov	cx,9
 17A8  E8 ED81				call	shr32
					; dx:ax = sector offset (flat)
 17AB  8A C8				mov	cl,al
 17AD  80 E1 7F				and	cl,127
 17B0  88 0E 3A69 R			mov	byte ptr [level+1],cl
 17B4  B1 07				mov	cl,7	
 17B6  E8 ED73				call	shr32
					; ax = indirect pointer index (<= 127)
					; dx = 0
 17B9  A2 3A6A R			mov	byte ptr [level+2],al
 17BC  BE 0020				mov	si,8*4 ; 32
 17BF  EB 30				jmp	short mget_11
 17C1				mget_10:
					; 13/11/2019
					; triple indirect pointers ; 8912386 to 1082654210 bytes
 17C1  BE 0024				mov	si,9*4 ; 36

 17C4  C6 06 3A68 R 03			mov	byte ptr [level],3
 17C9  81 EA 0088			sub	dx,88h
 17CD  B9 0009				mov	cx,9
 17D0  E8 ED59				call	shr32
					; dx:ax = sector offset (flat)
 17D3  8A C8				mov	cl,al
 17D5  80 E1 7F				and	cl,127
 17D8  88 0E 3A69 R			mov	byte ptr [level+1],cl
 17DC  B1 07				mov	cl,7	
 17DE  E8 ED4B				call	shr32
					; ax = indirect pointer index (<= 127)
					; dx = 0
 17E1  8A D0				mov	dl,al
 17E3  80 E2 7F				and	dl,127
 17E6  88 16 3A6A R			mov	byte ptr [level+2],dl
 17EA  B1 07				mov	cl,7
 17EC  D3 E8				shr	ax,cl
 17EE  A2 3A6B R			mov	byte ptr [level+3],al
 17F1				mget_11:
 17F1  8B 84 3048 R			mov	ax,word ptr [si+inode_dskp]
 17F5  8B 94 304A R			mov	dx,word ptr [si+inode_dskp+2]

 17F9  BB 3EB0 R			mov	bx,offset Buffer  ; 01/12/2019
					
 17FC  0B C0				or	ax,ax
 17FE  75 4A				jnz	short mget_15 ; if physical block number is zero
						; then we need a new block for file
 1800  0B D2				or	dx,dx
 1802  75 46				jnz	short mget_15
 1804  E8 00C0				call	alloc	 ; allocate a new block for this file	
						; AX (R1) = Block number
					;jc	mget_6	 ; cf -> 1 & ax = 0 -> no free block
 1807  72 1F				jc	short mget_12 ; 30/12/2019
					
 1809  89 84 3048 R			mov	word ptr [si+inode_dskp],ax
 180D  89 94 304A R			mov	word ptr [si+inode_dskp+2],dx

					; 18/12/2019
 1811  80 3E 3A4A R 00			cmp	byte ptr [buff_m],0 ; buffer modified ?
 1816  76 11				jna	short mget_13

 1818				mget_20: ; 07/01/2020
 1818  52				push	dx
 1819  50				push	ax
 181A  A1 3A46 R			mov	ax,word ptr [buff_s]
 181D  8B 16 3A48 R			mov	dx,word ptr [buff_s+2]
					;mov	bx,offset Buffer
 1821  E8 04A2				call	dskwr
 1824  58				pop	ax
 1825  5A				pop	dx
					;jc	short mget_12
					;mov	byte ptr [buff_m],0 ; reset buffer modified sign
 1826  73 06				jnc	short mget_14
 1828				mget_12:
 1828  C3				retn
 1829				mget_13:
 1829  C6 06 3A4A R 01			mov	byte ptr [buff_m],1  ; buffer modified
 182E				mget_14:
 182E  E8 031F				call	clear ; clear buffer

 1831  E8 02C9				call	setimod

 1834  A3 3A46 R			mov	word ptr [buff_s],ax
 1837  89 16 3A48 R			mov	word ptr [buff_s+2],dx

					; 25/01/2020 ('setimod' modifies bx register)	
 183B  BB 3EB0 R			mov	bx,offset Buffer

 183E  E8 0485				call	dskwr
 1841  72 E5				jc	short mget_12

					; 01/12/2019
 1843  C6 06 3A4A R 00			mov	byte ptr [buff_m],0 ; reset buffer modified sign
 1848  EB 34				jmp	short mget_18
 184A				mget_15:
					; 13/11/2019
 184A  3B 06 3A46 R			cmp	ax,word ptr [buff_s]
 184E  75 06				jne	short mget_16	
 1850  3B 16 3A48 R			cmp	dx,word ptr [buff_s+2]
 1854  74 28				je	short mget_18
 1856				mget_16:	
 1856  80 3E 3A4A R 00			cmp	byte ptr [buff_m],0 ; buffer modified ?
 185B  76 15				jna	short mget_17

					; 01/12/2019	
 185D  52				push	dx
 185E  50				push	ax
 185F  A1 3A46 R			mov	ax,word ptr [buff_s]
 1862  8B 16 3A48 R			mov	dx,word ptr [buff_s+2]
					;mov	bx,offset Buffer
 1866  E8 045D				call	dskwr
 1869  58				pop	ax
 186A  5A				pop	dx
 186B  72 BB				jc	short mget_12
 186D  C6 06 3A4A R 00			mov	byte ptr [buff_m],0 ; reset buffer modified sign
 1872				mget_17:
					;mov	bx,offset Buffer	
 1872  E8 0458				call	dskrd
 1875  72 B1				jc	short mget_12

 1877  A3 3A46 R			mov	word ptr [buff_s],ax
 187A  89 16 3A48 R			mov	word ptr [buff_s+2],dx
 187E				mget_18:
					; 07/01/2020
 187E  80 3E 3A68 R 00			cmp	byte ptr [level],0
 1883  76 A3				jna	short mget_12
					
					;dec	byte ptr [level]
					;jz	short mget_12

 1885  8A 1E 3A68 R			mov	bl,byte ptr [level]
 1889  32 FF				xor	bh,bh
 188B  8A 9F 3A68 R			mov	bl,byte ptr [bx+level] ; sector pointer offset
 188F  D0 E3				shl	bl,1
 1891  D1 E3				shl	bx,1 ; 13/01/2020

					; 07/01/2020
 1893  FE 0E 3A68 R			dec	byte ptr [level]

					; 13/01/2020
 1897  BE 3EB0 R			mov	si,offset Buffer

					; 01/12/2019
 189A  03 DE				add	bx,si ; offset Buffer ; 13/01/2020

 189C  8B 07				mov	ax,word ptr [bx]
 189E  8B 57 02				mov	dx,word ptr [bx+2]

					; 01/12/2019
 18A1  0B C0				or	ax,ax
					;jnz	short mget_16 ; if physical block number is zero
						 ; then we need a new block for file
 18A3  75 04				jnz	short mget_21 ; 13/01/2020
 18A5  0B D2				or	dx,dx
					;jnz	short mget_16
 18A7  74 0A				jz	short mget_23 ; 13/01/2020
 18A9				mget_21:
					; 13/01/2020
 18A9  8B DE				mov	bx,si ; offset Buffer

 18AB  80 3E 3A68 R 00			cmp	byte ptr [level],0
					;ja	short mget_16
 18B0  77 C0				ja	short mget_17
 18B2				mget_22:
 18B2  C3				retn
 18B3				mget_23:
 18B3  E8 0011				call	alloc	; allocate a new block for this file	
						; AX (R1) = Block number
					;jc	mget_6	; cf -> 1 & ax = 0 -> no free block
					; 07/01/2020
					;jnc	short mget_19
					;
					;retn
 18B6  72 FA				jc	short mget_22	
 18B8				mget_19:	
					; 12/12/2019
 18B8  89 07				mov	word ptr [bx],ax
 18BA  89 57 02				mov	word ptr [bx+2],dx

					; 07/01/2020
					; 18/12/2019
 18BD  C6 06 3A4A R 01			mov	byte ptr [buff_m],1 ; set buffer modified sign
					;call	setimod
					;mov	bx,offset Buffer
 18C2  8B DE				mov	bx,si ; offset Buffer ; 13/01/2020
					;jmp	mget_13
					; 07/01/2020
 18C4  E9 FF51				jmp	mget_20
					
 18C7				mget	endp

 18C7				alloc 	proc near
					; 28/03/2022
					; 23/03/2022
					; 19/01/2020
					; 03/01/2020
					; 06/12/2019
					; 27/11/2019
					; 07/11/2019
					; 28/10/2019
					; 24/10/2019 - Retro UNIX 386 v2 (UNIXHDFS)
					; allocate disk sector
					;; input -> none
					;; output -> DX:AX = allocated sector/block number
					;; 	cf = 1 -> could not be allocated
					; Modified registers: none (except ax,dx)

 18C7  A1 3CE8 R			mov	ax,word ptr [systm.sb_FreeBlocks] 	
 18CA  8B 16 3CEA R			mov	dx,word ptr [systm.sb_FreeBlocks+2]
 18CE  0B C2				or	ax,dx
 18D0  75 02				jnz	short alloc_0
 18D2				alloc_err:
 18D2  F9				stc
 18D3  C3				retn
 18D4				alloc_0:
					; 06/12/2019
 18D4  A1 3CEC R			mov	ax,word ptr [systm.sb_FirstFreeBlk]
 18D7  8B 16 3CEE R			mov	dx,word ptr [systm.sb_FirstFreeBlk+2]

 18DB  51				push	cx ; *
 18DC  53				push	bx ; **

 18DD  8B CA				mov	cx,dx
 18DF  8B D8				mov	bx,ax
 18E1  83 F9 FF				cmp	cx,0FFFFh
 18E4  72 0D				jb	short alloc_1
 18E6  83 FB FF				cmp	bx,0FFFFh
 18E9  72 0C				jb	short alloc_2	
 18EB  33 C0				xor	ax,ax
 18ED  33 D2				xor	dx,dx
					; dx:ax = fbm sector index (as start sector) = 0
 18EF  33 DB				xor	bx,bx ; bit 0
 18F1  EB 15				jmp	short alloc_3	
 18F3				alloc_1:
 18F3  0B CB				or	cx,bx
 18F5  74 11				jz	short alloc_3
 18F7				alloc_2:	
					;mov	cx,12   ; 512 block alloc bytes per free block map sector
					;call	shr32	; (4096 block alloc bits per fm sector)	
					;and	bx,0Fh  ; start bit position of fbm buffer byte
					
					; 19/01/2020
 18F7  B9 0003				mov	cx,3	; 1 alloc byte (in fbm) is for 8 sectors 
 18FA  E8 EC2F				call	shr32
 18FD  8B D8				mov	bx,ax    	
 18FF  81 E3 01FF			and	bx,1FFh	; 511
 1903  B1 09				mov	cl,9
 1905  E8 EC24				call	shr32   ; 512 alloc bytes per fbm sector (4096 bits)
 1908				alloc_3:
					; free map sector (index) in dx:ax

					; 19/01/2020
 1908  81 C3 48B0 R			add	bx,offset fbm_buffer

					;push	bx ; *** ; byte offset in fbm sector (to search at first)
					; 23/03/2022
					;mov	word ptr [save_bx],bx ; *** ; 19/01/2020

 190C  3B 06 3A80 R			cmp	ax,word ptr [fm_sector]
 1910  75 06				jne	short alloc_4
 1912  3B 16 3A82 R			cmp	dx,word ptr [fm_sector+2]
					;je	short alloc_6
					; 23/03/2022
 1916  74 51				je	short alloc_7	
 1918				alloc_4:
					; 23/03/2022
 1918  89 1E 3A76 R			mov	word ptr [save_bx],bx ; ***
					; 12/12/2019
 191C  BB 48B0 R			mov	bx,offset fbm_buffer

 191F  F6 06 3A59 R 01			test 	byte ptr [smod],1 ; free map modified flag
 1924  74 1D				jz	short alloc_5

 1926  52				push	dx ; ****
 1927  50				push	ax ; *****

					;call	sync ; writes current free map sector/block
					;	     ; and updates super block

					; 12/12/2019
 1928  A1 3A80 R			mov	ax,word ptr [fm_sector]
 192B  8B 16 3A82 R			mov	dx,word ptr [fm_sector+2]
 192F  03 06 3CC8 R			add	ax,word ptr [systm.sb_FreeMapAddr]
 1933  13 16 3CCA R			adc	dx,word ptr [systm.sb_FreeMapAddr+2]
					;mov	bx,offset fbm_buffer
 1937  E8 038C				call	dskwr

 193A  58				pop	ax ; *****
 193B  5A				pop	dx ; ****	
 193C  72 69				jc	short alloc_9 ; 07/11/2019

					; 12/12/2019
 193E  80 26 3A59 R FE			and	byte ptr [smod],0FEh ; reset free map modified flag
 1943				alloc_5:
					; 07/11/2019
 1943  A3 3A70 R			mov	word ptr [save_ax],ax
 1946  89 16 3A72 R			mov	word ptr [save_dx],dx
 194A				alloc_17: ; 27/11/2019
 194A  03 06 3CC8 R			add	ax,word ptr [systm.sb_FreeMapAddr]
 194E  13 16 3CCA R			adc	dx,word ptr [systm.sb_FreeMapAddr+2]

					;mov	bx,offset fbm_buffer 	
 1952  E8 0378				call	dskrd
 1955  72 50				jc	short alloc_9 ; 07/11/2019

					; 07/11/2019	
 1957  A1 3A70 R			mov	ax,word ptr [save_ax]
 195A  8B 16 3A72 R			mov	dx,word ptr [save_dx]
 195E  A3 3A80 R			mov	word ptr [fm_sector],ax
 1961  89 16 3A82 R			mov	word ptr [fm_sector+2],dx
 1965				alloc_6:
					; 19/01/2020
					;mov	bx,offset fbm_buffer-2
 1965  8B 1E 3A76 R			mov	bx,word ptr [save_bx]

					; 28/10/2019
 1969				alloc_7: 
					; dx:ax = [fm_sector] ; 07/11/2019
					; 19/01/2020
					;inc	bx
					;inc	bx
					;mov	dx,word ptr [bx]
					;or	dx,dx
					; 07/11/2019
					;mov	cx,word ptr [bx]
					;or	cx,cx
					; 19/01/2020
 1969  8A 17				mov	dl,byte ptr [bx]
 196B  0A D2				or	dl,dl
 196D  75 4B				jnz	short alloc_10 ; branch if any free blocks in this word
					; 19/01/2020
 196F				alloc_20: 
 196F  43				inc	bx
					;cmp	bx,offset fbm_buffer+510 
 1970  81 FB 4AB0 R			cmp	bx,offset fbm_buffer+512 ; 19/01/2020 
 1974  72 F3				jb	short alloc_7
					;mov	ax,word ptr [fm_sector]
					;mov	dx,word ptr [fm_sector+2]
 1976  83 C0 01				add	ax,1
 1979  83 D2 00				adc	dx,0
 197C  A3 3A70 R			mov	word ptr [save_ax],ax
 197F  89 16 3A72 R			mov	word ptr [save_dx],dx

					;mov	cx,12  ; 512 block alloc bytes per free block map sector
					;call	shl32  ; (4096 block alloc bits per fm sector)
					;cmp	dx,word ptr [systm.sb_TotalSects+2]
					;jb	short alloc_8
					;ja	short alloc_3	
					;cmp	ax,word ptr [systm.sb_TotalSects]
				 	;jnb	short alloc_9

 1983  B9 0009				mov	cx,9  ; 512 block alloc bytes per free block map sector
 1986  E8 EB9A				call	shl32 ; (4096 block alloc bits per fm sector)
 1989  3B 16 3CCE R			cmp	dx,word ptr [systm.sb_FreeMapSize+2]
 198D  72 1B				jb	short alloc_8
					;ja	short alloc_3
 198F  77 06				ja	short alloc_19 ; 03/01/2020	
 1991  3B 06 3CCC R			cmp	ax,word ptr [systm.sb_FreeMapSize]
 1995  72 13			 	jb	short alloc_8
					; 03/01/2020
 1997				alloc_19:
					; 28/03/2022
					; (invalidate first free block value)
 1997  33 C0				xor	ax, ax
 1999  33 D2				xor	dx, dx
 199B  B9 FFFF				mov	cx, 0FFFFh
					;; 28/03/2022
					;;cmp	cx, word ptr [systm.sb_FirstFreeBlk+2]
					;;jne	short alloc_21
					;;cmp	cx, word ptr [systm.sb_FirstFreeBlk]
					;;je	short alloc_22
				;;alloc_21:
					;; 28/03/2022
					;; ((invalidate first free block value then..
					;; search a free block again from start of fbm))
 199E  89 0E 3CEC R			mov	word ptr [systm.sb_FirstFreeBlk], cx
 19A2  89 0E 3CEE R			mov	word ptr [systm.sb_FirstFreeBlk+2], cx
					;!(next time free block search will start from block 0)!
					;;sub	cx, cx
					;;sub	bx, bx
					;;jmp	alloc_3
				;;alloc_22:
					; (no free blocks !)
					;xor	ax,ax ; 07/11/2019
					;xor	dx,dx
 19A6  F9				stc	; cf=1 --> error: no free blocks/sectors
					;jmp	short alloc_9
					; 03/01/2020
 19A7				alloc_9:
					;pop bx ; *** ; 19/01/2020
 19A7  5B				pop	bx ; **
 19A8  59				pop	cx ; *
 19A9  C3				retn
 19AA				alloc_8:
 19AA  A1 3A70 R			mov	ax,word ptr [save_ax]
 19AD  8B 16 3A72 R			mov	dx,word ptr [save_dx]
					; 19/01/2020
 19B1  BB 48B0 R			mov	bx,offset fbm_buffer  ; 12/12/2019
 19B4  89 1E 3A76 R			mov	word ptr [save_bx],bx ; *** ; 19/01/2020
 19B8  EB 90				jmp	short alloc_17 ; 27/11/2019
 19BA				alloc_10:
					; 19/01/2020
					; 07/11/2019
					;mov	dx,cx

					; 28/10/2019	
					; dx = value of (current) fbm buffer word

					;pop cx ; ***

					;mov	ax,1
					; 19/01/2020
 19BA  B0 01				mov	al,1

					;and	cx,0Fh ; bit position
					;jz	short alloc_11
					;and	cx,cx
					;jz	short alloc_11
					;shr	dx,cl
					;shl	ax,cl ; 27/11/2019
					
					; 19/01/2020
 19BC  33 C9				xor	cx,cx
 19BE				alloc_11:
					; 08/12/2019
					;mov	byte ptr [bitpos],cl ; 0 to 15
					; BX = byte offset in fbm_buffer
					; AX = bit position to be reset
					;shr	dx,1
					; 19/01/2020
 19BE  D0 EA				shr	dl,1
 19C0  72 14				jc	short alloc_12
					; 08/12/2019
					;cmp	cl,0Fh ; 15
					;jnb	short alloc_18
					
					; 19/01/2020
 19C2  80 F9 07				cmp	cl,7
 19C5  73 06				jnb	short alloc_18

					;shl	ax,1
 19C7  FE C1				inc	cl
 19C9  D0 E0				shl	al,1
 19CB  EB F1				jmp	short alloc_11
 19CD				alloc_18:
					; 08/12/2019
 19CD  A1 3A80 R			mov	ax,word ptr [fm_sector]
 19D0  8B 16 3A82 R			mov	dx,word ptr [fm_sector+2]
					;jmp	short alloc_7
					; 19/01/2020
 19D4  EB 99				jmp	short alloc_20
 19D6				alloc_12:
					; 19/01/2020
 19D6  89 0E 3A74 R			mov	word ptr [save_cx],cx ; 0 to 7 - 19/01/2020

					;not ax ; requested bit is 0 (allocated), others are 1 (free)
					;and word ptr [bx],ax
					; 19/01/2020
 19DA  F6 D0				not	al
 19DC  20 07				and	byte ptr [bx],al

 19DE  A1 3A80 R			mov	ax,word ptr [fm_sector]
 19E1  8B 16 3A82 R			mov	dx,word ptr [fm_sector+2]
 19E5  8B C8				mov	cx,ax
 19E7  0B CA				or	cx,dx
 19E9  74 06				jz	short alloc_13
 19EB  B9 000C				mov	cx,12  ; convert fbm sector index number to bit offset
 19EE  E8 EB32				call	shl32
					; dx:ax = total bits number of sectors before current fbm sector
 19F1				alloc_13:	
					; 08/12/2019
 19F1  81 EB 48B0 R			sub	bx,offset fbm_buffer
				 	; bx = byte offset in fbm_buffer
 19F5  74 06				jz	short alloc_14 
 19F7  D1 E3				shl	bx,1
 19F9  D1 E3				shl	bx,1
 19FB  D1 E3				shl	bx,1
					; bx = bit offset (0 to 4080)
 19FD				alloc_14:
					; ch = 0
					;mov	cl,byte ptr [bitpos] ; 0 to 15
					;add	bx,cx
					; 19/01/2020
 19FD  03 1E 3A74 R			add	bx,word ptr [save_cx] ; 0 to 7
					;	
 1A01  03 C3				add	ax,bx
 1A03  83 D2 00				adc	dx,0
					; dx:ax = bit offset from start of fbm = allocated sector number

 1A06  80 0E 3A59 R 01			or	byte ptr [smod],1 ; set free map modified flag
						      		  ; in super block	

					; Do not change invalid count of free blocks
					; (0FFFFFFFFh) value here! -otherwise it may be a mistake!-
 1A0B  8B 0E 3CE8 R			mov	cx,word ptr [systm.sb_FreeBlocks] 	
 1A0F  23 0E 3CEA R			and	cx,word ptr [systm.sb_FreeBlocks+2]
 1A13  83 F9 FF				cmp	cx,0FFFFh 
 1A16  73 0A				jnb	short alloc_15

 1A18  83 2E 3CE8 R 01			sub	word ptr [systm.sb_FreeBlocks],1
 1A1D  83 1E 3CEA R 00			sbb	word ptr [systm.sb_FreeBlocks+2],0

					; 28/03/2022
					;or	byte ptr [smod],0F0h  ; set sb modified flag
 1A22				alloc_15:
					; 28/03/2022
					; (dx:ax contains previous first free block value and
					;  it is better if the new value is set one/just next to dx:ax)

 1A22  8B C8				mov	cx, ax
 1A24  8B DA				mov	bx, dx
 1A26  83 C1 01				add	cx, 1
 1A29  83 D3 00				adc	bx, 0
						   ; (next ffb search will be started from)
 1A2C  89 0E 3CEC R			mov	word ptr [systm.sb_FirstFreeBlk], cx
 1A30  89 1E 3CEE R			mov	word ptr [systm.sb_FirstFreeBlk+2], bx

					;cmp	ax,word ptr [systm.sb_FirstFreeBlk]
					;jne	short alloc_16
					;cmp	dx,word ptr [systm.sb_FirstFreeBlk+2]
					;jne	short alloc_16
					;
					;; set first free block to the next sector (in order)
					;add	word ptr [systm.sb_FirstFreeBlk],1
					;adc	word ptr [systm.sb_FirstFreeBlk+2],0

 1A34  80 0E 3A59 R F0			or	byte ptr [smod],0F0h  ; set sb modified flag
 1A39				alloc_16:
					; 06/12/2019
 1A39  F8				clc
 1A3A  5B				pop	bx ; **
 1A3B  59				pop	cx ; *
					; DX:AX = Block/Sector number
 1A3C  C3				retn

 1A3D				alloc   endp

 1A3D				free	proc near
					; 23/03/2022
					; 19/01/2020
					; 08/12/2019
					; 27/11/2019
					; 07/11/2019
					; 28/10/2019
					; 24/10/2019
					; release disk sector
					; 16/10/2019 - Retro UNIX 386 v2 (UNIXHDFS)
					; DX:AX = Sector to be freed/released
					; Modified registers: cx,bx ; 07/11/2019
					;	cf = 1 -> error

					; Calculate free map sector for requested sector in dx:ax

 1A3D  A3 3A70 R			mov	word ptr [save_ax],ax
 1A40  89 16 3A72 R			mov	word ptr [save_dx],dx

 1A44  8B D8				mov	bx,ax
 1A46  81 E3 0FFF			and	bx,4095 ; 1FFh ; 28/10/2019

					;mov	cx,4096
					;call	div32
 1A4A  B9 000C				mov	cx,12
 1A4D  E8 EADC				call	shr32

					; 23/03/2022 (BugFix)
					;mov	word ptr [save_bx],bx ; ***

 1A50  3B 06 3A80 R			cmp	ax,word ptr [fm_sector]
 1A54  75 06				jne	short free_1
 1A56  3B 16 3A82 R			cmp	dx,word ptr [fm_sector+2]
 1A5A  74 47				je	short free_3 ; (!*!)
 1A5C				free_1:
					; 27/11/2019
					;push	bx ; ***

					; 23/03/2022
					; 19/01/2020
 1A5C  89 1E 3A76 R			mov	word ptr [save_bx],bx ; ***

					; 10/12/2019
 1A60  BB 48B0 R			mov	bx,offset fbm_buffer  

 1A63  F6 06 3A59 R 01			test 	byte ptr [smod],1 ; free map modified flag
 1A68  74 1D				jz	short free_2

 1A6A  52				push	dx ; **
 1A6B  50				push	ax ; *

					;call	sync ; writes current free map sector/block
					;	   ; and updates super block

					; 10/12/2019
 1A6C  A1 3A80 R			mov	ax,word ptr [fm_sector]
 1A6F  8B 16 3A82 R			mov	dx,word ptr [fm_sector+2]

 1A73  03 06 3CC8 R			add	ax,word ptr [systm.sb_FreeMapAddr]
 1A77  13 16 3CCA R			adc	dx,word ptr [systm.sb_FreeMapAddr+2]

					;mov	bx,offset fbm_buffer 	
 1A7B  E8 0248				call	dskwr
					;jc	short free_9

					; 19/01/2020
				;free_9:
 1A7E  58				pop	ax ; *
 1A7F  5A				pop	dx ; **
 1A80  72 7A				jc	short free_7

					; 19/01/2020
 1A82  80 26 3A59 R FE			and	byte ptr [smod],0FEh ; reset bit 0
 1A87				free_2:
					; 07/11/2019
 1A87  52				push	dx ; **
 1A88  50				push	ax ; *

 1A89  03 06 3CC8 R			add	ax,word ptr [systm.sb_FreeMapAddr]
 1A8D  13 16 3CCA R			adc	dx,word ptr [systm.sb_FreeMapAddr+2]

					;mov	bx,offset fbm_buffer ; 10/12/2019	
 1A91  E8 0239				call	dskrd
					
 1A94  58				pop	ax ; *
 1A95  5A				pop	dx ; **
					;pop	bx ; *** ; 19/01/2020
					;jc	short free_8
 1A96  72 64				jc	short free_7 ; 19/01/2020

					; 07/11/2019
 1A98  A3 3A80 R			mov	word ptr [fm_sector],ax
 1A9B  89 16 3A82 R			mov	word ptr [fm_sector+2],dx
				;free_3:; 23/03/2022 (Bug! wrong jump location..) (!*!)	
					; 19/01/2020
 1A9F  8B 1E 3A76 R			mov	bx,word ptr [save_bx] ; *** ; 0 to 4095
 1AA3				free_3:	; 23/03/2022 (BugFix) (correct jump location) (!*!)
					;mov	cx,bx
 1AA3  8A CB				mov	cl,bl ; 19/01/2020
					;mov	ax,1
 1AA5  B0 01				mov	al,1 ; 19/01/2020	
					;and	cx,0Fh
 1AA7  80 E1 07				and	cl,7 ; 19/01/2020
 1AAA  74 02				jz	short free_4
					;shl	ax,cl
 1AAC  D2 E0				shl	al,cl ; 19/01/2020
 1AAE				free_4:
 1AAE  D1 EB				shr	bx,1
 1AB0  D1 EB				shr	bx,1
 1AB2  D1 EB				shr	bx,1
					; 19/01/2020 (bx = byte offset, 0 to 511)
					;shr	bx,1

					;shl	bx,1 ; byte offset with word boundary

 1AB4  81 C3 48B0 R			add	bx,offset fbm_buffer

					; BX = byte offset in fbm_buffer
					; DX = bit position to be set

					;or	word ptr [bx],ax
					; 19/01/2020
 1AB8  08 07				or	byte ptr [bx],al

 1ABA  80 0E 3A59 R 01			or	byte ptr [smod],1 ; set free map modified flag
								  ; in super block
					; 28/10/2019
					; Do not change invalid count of free blocks
					; (0FFFFFFFFh) value here! -otherwise it may be a mistake!-
 1ABF  8B 0E 3CE8 R			mov	cx,word ptr [systm.sb_FreeBlocks] 	
 1AC3  23 0E 3CEA R			and	cx,word ptr [systm.sb_FreeBlocks+2]
 1AC7  83 F9 FF				cmp	cx,0FFFFh 
 1ACA  73 0F				jnb	short free_5
					
 1ACC  83 06 3CE8 R 01			add	word ptr [systm.sb_FreeBlocks],1 	
 1AD1  83 16 3CEA R 00			adc	word ptr [systm.sb_FreeBlocks+2],0
					; 28/10/2019
 1AD6  80 0E 3A59 R F0			or	byte ptr [smod],0F0h  ; set sb modified flag
 1ADB				free_5:	
 1ADB  A1 3A70 R			mov	ax,word ptr [save_ax]
 1ADE  8B 16 3A72 R			mov	dx,word ptr [save_dx]	

 1AE2  3B 16 3CEE R			cmp	dx,word ptr [systm.sb_FirstFreeBlk+2]
					;ja	short free_8
 1AE6  77 14				ja	short free_7 ; 19/01/2020
 1AE8  72 06				jb	short free_6	

 1AEA  3B 06 3CEC R			cmp	ax,word ptr [systm.sb_FirstFreeBlk]
					;jnb	short free_8
 1AEE  73 0C				jnb	short free_7 ; 19/01/2020
 1AF0				free_6:
 1AF0  A3 3CEC R			mov	word ptr [systm.sb_FirstFreeBlk],ax
 1AF3  89 16 3CEE R			mov	word ptr [systm.sb_FirstFreeBlk+2],dx
					; 28/10/2019
 1AF7  80 0E 3A59 R F0			or	byte ptr [smod],0F0h  ; set sb modified flag
					;clc
					;retn	; 19/01/2020 (free_7 -> retn)
 1AFC				free_7:
					;pop	bx ; *** ; 19/01/2020
				;free_8:
 1AFC  C3				retn

 1AFD				free	endp

 1AFD				setimod proc near
					; 25/01/2020
					; 05/01/2020
					; 30/09/2019
					; 19/09/2019 - Retro UNIX 386 v2 (modified unix v7 inode structure)	
					;
					; 23/02/2013 (fromdos) file m. date&time modification
					; 14/11/2012 unix boot file configuration version
					; of "setimod" procedure
					; 13/8/2012
					; 21/7/2012
					; 14/7/2012
				     	; Derived from (original) UNIX v1 source code
					; PRELIMINARY release of Unix Implementation Document, 
					; 20/6/1972
					;; AX=R0, BX=R1, CX=R3, DX=R5 
					; [SP] = Argument 1, 0 = read, 1 = write
					; RETRO UNIX v1 FS
					; initialization/format version

					; 25/01/2020
					; Modified registers: bx (in 'epoch'), cx

 1AFD  52				push	dx ; 05/01/2020
 1AFE  50				push	ax
 1AFF  C6 06 3A5A R 01			mov	byte ptr [imod], 1
					; 23/02/2013
 1B04  A1 3078 R			mov	ax, word ptr [inode_ctim]
 1B07  8B 16 307A R			mov	dx, word ptr [inode_ctim]+2
 1B0B  23 C0				and	ax, ax
 1B0D  75 22				jnz	short setimod_3
 1B0F  23 D2				and	dx, dx
 1B11  75 1E				jnz	short setimod_3
 1B13				setimod_1:
					; Erdogan Tan 14-7-2012
 1B13  E8 030A				call	epoch
 1B16  A3 3078 R			mov	word ptr [inode_ctim], ax
 1B19  89 16 307A R			mov	word ptr [inode_ctim]+2, dx
					; 19/09/2019
 1B1D  EB 08				jmp	short setimod_5
 1B1F				setimod_6:
 1B1F  F8				clc
 1B20				setimod_2:
					; File/Directory data (file size or content) is changed
					; This is last modification date&time
 1B20  A3 3074 R			mov	word ptr [inode_mtim], ax
 1B23  89 16 3076 R			mov	word ptr [inode_mtim]+2, dx
 1B27				setimod_5:
					; 19/09/2019
					; This is last access or last changing date&time
					; of inode (chmod,chown,chrp,link)
					; parameters (without file/dir data changing)
 1B27  A3 3070 R			mov	word ptr [inode_atim], ax
 1B2A  89 16 3072 R			mov	word ptr [inode_atim]+2, dx
 1B2E				setimod_4:
 1B2E  58				pop	ax
 1B2F  5A			        pop	dx ; 05/01/2020
 1B30  C3				retn
 1B31				setimod_3:
				 	; 23/02/2013
 1B31  33 C9				xor	cx, cx
 1B33  39 0E 3074 R			cmp	word ptr [inode_mtim], cx
 1B37  76 E7				jna	short setimod_2
 1B39  39 0E 3076 R			cmp	word ptr [inode_mtim]+2, cx
 1B3D  76 E1				jna	short setimod_2

 1B3F  E8 02DE				call	epoch

					; 19/09/2019 - Retro UNIX 386 v2 by Erdogan Tan
 1B42  80 3E 3A5B R 01			cmp	byte ptr [imodx], 1 ; flag means "file/dir data is same but
					;jb	short setimod_2	    ; inode is changed"
 1B47  72 D6				jb	short setimod_6 ; 30/09/2019

					; 19/09/2019
					; File/Dir data (File size or content) is same but
					; inode's mode, link count, owner or group id is changed
					; (so, we do not change last modification date&time)
 1B49  C6 06 3A5B R 00			mov	byte ptr [imodx], 0 ; reset inode modified (extended) flag
 1B4E  EB D7				jmp	short setimod_5

 1B50				setimod endp

 1B50				clear	proc near
					; 13/11/2019 - Retro UNIX 386 v2
					; (Data) Buffer clearing
					
 1B50  57				push	di
 1B51  51				push	cx
 1B52  50				push	ax

 1B53  33 C0			 	xor	ax,ax

 1B55  BF 3EB0 R			mov	di,offset Buffer
 1B58  B9 0100				mov	cx,256 
 1B5B  F3/ AB				rep	stosw

 1B5D  58				pop	ax
 1B5E  59				pop	cx
 1B5F  5F				pop	di	
 1B60				@@:	
 1B60  C3				retn

 1B61				clear	endp

 1B61				make_directory proc near
					; 15/04/2022 ('number of links' bugfix)
					; 17/01/2020
					; 01/01/2020
					; 04/12/2015 (14 byte directory names)	
					; 30/12/2012
					;
					; mov	word ptr [u.namep], si

 1B61  E8 F64C				call	sys_mkdir
					;jc	short @f
 1B64  72 FA				jc 	short @b ; 15/04/2022
					
				        ;ax = i-number

					;bx = i_number ; 01/01/2020

					;mov	ax, word ptr [ii]
					;mov	word ptr [u_dirbuf], ax

 1B66  C7 06 3080 R 31A1 R		mov	word ptr [u_namep], offset dot ; ('.')
 1B6C  33 C0				xor	ax, ax
 1B6E  A3 3082 R			mov	word ptr [u_dirp], ax ; 0
					; 17/01/2020
 1B71  A3 3084 R			mov	word ptr [u_dirp+2], ax ; 0 ; 01/01/2020 	
 1B74  E8 0032				call	mk_dir 	; make a directory entry 
							; in current (ii) directory
					;jc	short @f
 1B77  72 E7				jc	short @b ; 15/04/2022

 1B79  C7 06 3082 R 0010		mov	word ptr [u_dirp], 16 ; 04/12/2015 (10 -> 16)
					; 17/01/2020
 1B7F  C7 06 3084 R 0000		mov	word ptr [u_dirp+2], 0 ; 01/01/2020 (32 bit value)
 1B85  A1 2C96 R			mov	ax, word ptr [pdir] 
 1B88  A3 3086 R			mov	word ptr [u_dirbuf], ax
 1B8B  C7 06 3080 R 31A0 R		mov	word ptr [u_namep], offset dotdot ; ('..')

					; 15/04/2022
				;	;call	mk_dir
				;	; 20/01/2020
				;	;jmp	short mk_dir
				;;@@:
				;	;retn

 1B91  E8 0015				call	mk_dir	; make a directory entry 
							; in current (ii) directory
					; 15/04/2022
					;jc	short @f
 1B94  72 CA				jc	short @b ; 15/04/2022
 1B96  E8 0009				call	mkdir_inc_nlinks	
 1B99  8B 1E 2C96 R			mov	bx, word ptr [pdir] ; parent dirs i-number
 1B9D  E8 FA4C				call	iget
				        ;jc	short @f
 1BA0  72 BE				jc	short @b
 1BA2				mkdir_inc_nlinks:
 1BA2  FE 06 303E R			inc	byte ptr [inode_nlks] ; increase link count
					;call	setimod
 1BA6  E9 FF54				jmp	setimod
				;@@:
				;	retn

 1BA9				make_directory endp

 1BA9				mk_dir proc near
					; 17/01/2020
					; 15/01/2020
					; 19/09/2019 - Retro UNIX 386 v2 (modified unix v7 inode structure)
					;
					; 04/12/2015 (14 byte directory names)
					; 11/11/2012
					; unixboot.asm (boot file configuration)
					; version of 'mkdir'
					;
					; 31/10/2012
				     	; Derived from (original) UNIX v1 source code
					; PRELIMINARY release of Unix Implementation Document, 
					; 20/6/1972
					; RETRO UNIX v1 FS
					;
					; mkdir : make a directory entry
					;
					; 8086 CPU & IBM PC architecture modifications by Erdogan Tan 
					;
					; return => if cf=1 error number in [Error], ax = mode
					; If cf=0 -> AX = I-Number (also in u.dirbuff)
					;
					; input:
					; 	u.namep = file name
					; 	ii = current directory's i-number
					; 	u.dirbuf = directory entry (source) location
					; output:
					; 	u.dirbuf+2 to u.dirbuf+16 (u.dirbuf+10) = file name
					; 	u.off = directory entry offset in current directory
					; 	u.base = start of u.dirbuf
					; ;;;r1 (AX) = i-number of current directory

 1BA9				mkdir_0:
					;jsr r0,copyz; u.dirbuf+2; u.dirbuf+10. / clear this
 1BA9  B9 0007				mov	cx, 7  ; ; 04/12/2015 (4 -> 7)
 1BAC  33 C0				xor	ax, ax
 1BAE  BF 3088 R			mov	di, offset u_dirbuf+2
 1BB1  F3/ AB				rep 	stosw	
				         
 1BB3  8B 36 3080 R		        mov	si, word ptr [u_namep] ; mov u.namep,r2 
							; r2 points to name of directory entry

 1BB7  BF 3088 R			mov	di, offset u_dirbuf+2 ; mov $u.dirbuf+2,r3
							; r3 points to u.dirbuf+2
 1BBA				mkdir_1: ;1 / put characters in the directory name in u.dirbuf+2 - u.dirbuf+16
 1BBA  AC				lodsb	;movb  (r2)+,r1 / move character in name to r1
 1BBB  22 C0				and	al, al
 1BBD  74 11				jz	short mkdir_2	; beq 1f / if null, done
 1BBF  3C 2F				cmp	al, '/'		; cmp	r1,$'/ / is it a "/"?
 1BC1  74 09				je	short mkdir_stc	; beq error9 / yes, error
					; 04/12/2015 (10 -> 16)
 1BC3  81 FF 3096 R			cmp	di, offset u_dirbuf+16 ; cmp r3,$u.dirbuf+10. 
						; have we reached the last slot for a char?
 1BC7  74 F1				je	short mkdir_1	; beq 1b / yes, go back
					
 1BC9  AA				stosb	; movb r1,(r3)+ 
						; no, put the char in the u.dirbuf
 1BCA  EB EE				jmp	short mkdir_1	; br 1b / get next char

					; 17/01/2020
 1BCC				mkdir_stc:
					; invalid file name, al="/", ah=0
 1BCC  B4 01				mov	ah, 1
 1BCE  F9				stc
 1BCF				@@:	; 17/01/2020
 1BCF  C3				retn

 1BD0				mkdir_2: ;1
 1BD0  A1 3082 R			mov	ax, word ptr [u_dirp] ; mov u.dirp,u.off
 1BD3  8B 16 3084 R			mov	dx, word ptr [u_dirp+2] ; 01/01/2020 (32 bit offset)
 1BD7  A3 3A4C R			mov	word ptr [u_off], ax  ; pointer to empty current directory
								      ; slot to u.off
					; 15/01/2020
 1BDA  89 16 3A4E R			mov	word ptr [u_off+2], dx ; 01/01/2020
 1BDE				wdir:
 1BDE  C7 06 3A52 R 3086 R		mov	word ptr [u_base], offset u_dirbuf
							; mov$u.dirbuf,u.base
								; u.base points to created file name
 1BE4  C7 06 3A50 R 0010		mov	word ptr [u_count], 16 ; 04/12/2015 (10 -> 16)
							; mov $10.,u.count
				 	;mov	ax, word ptr [ii]  ; mov ii,r1 
					; 29/12/2019 
 1BEA  8B 1E 3A5E R			mov	bx, word ptr [ii]
					
						; r1 has i-number of current directory
					;call	writei	; jsr r0,writei / write into directory
				;@@:	
					;retn	; rts r0
					
					; 17/01/2020
					;jmp	short writei 
					
 1BEE				mk_dir 	endp

 1BEE				writei	proc near
					; 15/01/2020
					; 01/01/2020
					; 17/12/2019
					; 09/11/2019
					; 07/11/2019
					; 03/09/2mmn019 - Retro UNIX 386 v2
					; 31/10/2012
					; 18/08/2012
					; 17/07/2012
					; BX = R1, i-number
				     	; Derived from (original) UNIX v1 source code
					; PRELIMINARY release of Unix Implementation Document, 
					; 20/6/1972
					;; AX=R0, BX=R1, i-number 
					; RETRO UNIX v1 FS
					; initialization/format version
					;
					; writei: write file
					;
					; 8086 CPU & IBM PC architecture modifications by Erdogan Tan 
					;; return => if cf=1 error number in [Error]

					; input:
					; BX = R1 = I-Number
					; u.count = byte count
					; u.base = user buffer (offset)
					; u.fofp = (pointer to) current file offset
				 
 1BEE  33 C0				xor	ax,ax ; 0	   ; clr u.nread	
 1BF0  A3 3A54 R			mov	word ptr [u_nread],ax  ; clear the number of bytes transmitted during
						   ; read or write calls 
						   ; tst u.count	
 1BF3  39 06 3A50 R			cmp	word ptr [u_count],ax ; test the byte count specified by the user
					;;ja	short write_1 ; 1f    ; bgt 1f / any bytes to output; yes, branch
					;;retn	   ; rts 0 / no, return - no writing to do
					;jna	short @f
 1BF7  76 D6				jna	short @b ; 03/09/2019

 1BF9				write_1:
					;cmp	bx, 40	; cmp	r1,$40.
						; does the i-node number indicate a special file?
					;ja	short dskw_0 ; bgt dskw / no, branch to standard file output
				;@@:
				;	retn

				;	shl	bx,1	; asl r1 
						; yes, calculate the index into the special file
				;	cmp	bx,offset write_3 - offset writei_2 + 2
				;	ja	short writei_error

				;	jmp	word ptr [write_2][BX]-2 ; *1f-2(r1)
						; jump table and jump to the appropriate routine
				;write_2: ;1
				;	dw offset wtty	; tty
				;	dw offset wmem	; mem
				;	dw offset wfd ; fd0
				;	dw offset wfd ; fd1
				;	dw offset whd ; hd0
				;	dw offset whd ; hd1
				;	dw offset whd ; hd2
				;	dw offset whd ; hd3
				;	dw offset xmtt ; tty0
				;	dw offset xmtt ; tty1
				;	dw offset xmtt ; tty2
				;	dw offset xmtt ; tty3
				;	dw offset xmtt ; tty4
				;	dw offset xmtt ; tty5
				;	dw offset xmtt ; tty6
				;	dw offset xmtt ; tty7
				;	dw offset w1pr ; lpr
				; writei_3:	
				;	dw offset writei_error

				;wtty: ; write to concole tty
				;	retn
				;wmem: ; transfer characters from a user area of core to memory
				;	retn

				;wfd:  ; write to floppy disk (drive)	
				;	retn

				;whd:  ; write to hard/fixed disk (drive)	
				;	retn
				;wlpr  ; write to printer
				;	retn
					
				;xmtt:
				;	retn

 1BF9				writei 	endp

 1BF9				dskw	proc near
					; 15/01/2020
					; 01/01/2020
					; 29/12/2019
					; 17/12/2019
					; 04/12/2019
					; 07/11/2019
					; 03/09/2019 - Retro UNIX 386 v2
					; 01/03/2013
					; 31/10/2012
					; 19/8/2012
					; 30/7/2012
				     	; 17/7/2012
				     	; Derived from (original) UNIX v1 source code
					; PRELIMINARY release of Unix Implementation Document, 
					; 20/6/1972
					; dskw: write routine for non-special files
					;
					; RETRO UNIX v1 FS
					; initialization/format version
					;
					; write data to a file
					;
					; BX (R1) = I-node number

 1BF9				dskw_0:
 1BF9  57				push	di
 1BFA  56				push	si

 1BFB  53				push	bx	; save i-number on stack

 1BFC  C6 06 3A56 R FF			mov	byte ptr [Error],0FFh ; 03/09/2019

 1C01  E8 F9E8				call	iget 	; jsr r0,iget
					  	; write i-node out (if modified), read i-node 'r1'
					        ; into i-node area of core
					;jc	dskw_5 ; 01/03/2013
 1C04  73 03				jnc	short @f
					; 27/03/2022
 1C06  E9 008E				jmp	dskw_5
 1C09				@@:
					; 03/09/2019 - Retro UNIX 386 v2
 1C09  A0 303D R			mov	al,byte ptr [inode_flgs+1]
 1C0C  A8 80				test 	al,80h	     ; regular file ?
 1C0E  75 04				jnz	short dskw_8 ; yes
 1C10  A8 20				test 	al,20h 	     ; device file ?
					;;jnz	short dskw_7 ; yes
					;jz	short dskw_8 ; 07/09/2019
					;;test 	al,40h	     ; directory ?
					;;jnz	short dskw_8 ; yes
 1C12  75 1D				jnz	short dskw_7 ; 04/12/2019	
 1C14				dskw_8:
					;mov	si,word ptr [u_fofp]
					; 29/12/2019
 1C14  BE 3A4C R			mov	si,offset u_off

					;mov	dx,word ptr [si] 
						; mov	*u.fofp,r2 
						; put the file offset [(u.off) or the offset in
					        ; the fsp entry for this file] in r2
					;add	dx,word ptr [u_count]
						; add u.count,r2 
						; no. of bytes to be written + file offset is
					        ; put in r2

					;cmp	dx,word ptr [inode_size] ; cmp	r2,i.size
						; is this greater than the present size of
						; the file?
					;jna	short dskw_1 ; blos 1f / no, branch

					;mov	word ptr [inode_size],dx ; mov	r2,i.size 
						; yes, increase the file size to file offset +
						; no. of data bytes

					; 09/11/2019 - 32 bit file size
 1C17  8B 04				mov	ax,word ptr [si]
 1C19  8B 54 02				mov	dx,word ptr [si+2]

					; 01/01/2020
 1C1C  03 06 3A50 R			add	ax,word ptr [u_count]
						; add u.count,r2 
						; no. of bytes to be written + file offset is
						; put in r2
 1C20  83 D2 00				adc	dx,0
					
 1C23  3B 16 3046 R			cmp	dx,word ptr [inode_size+2]
 1C27  74 0B				je	short dskw_9	
 1C29  72 15				jb	short dskw_1
 1C2B  89 16 3046 R			mov	word ptr [inode_size+2],dx 
 1C2F  EB 09				jmp	short dskw_10
 1C31				dskw_7:
 1C31  F9				stc
 1C32  EB 63				jmp	short dskw_5
 1C34				dskw_9:
 1C34  3B 06 3044 R			cmp	ax,word ptr [inode_size]
 1C38  76 06				jna	short dskw_1	
 1C3A				dskw_10:  
 1C3A  A3 3044 R			mov	word ptr [inode_size],ax

 1C3D  E8 FEBD				call	setimod	; jsr r0,setimod 
						; set imod=1 (i.e., core inode has been
						; modified), stuff time of modification into
						; core image of i-node
 1C40				dskw_1: ; 1
 1C40  E8 FA4B				call	mget	; jsr r0,mget 
						; get the block no. in which to write the next data
				  	        ; byte
						; AX = R1 = Block Number
 1C43  72 52				jc	short dskw_5 ; 01/03/2013

					; 09/11/2019
					; dx:ax = Block/Sector number

					; Check current sector in the buffer
					
 1C45  80 3E 3A4A R 01			cmp	byte ptr [buff_m],1
 1C4A  72 25				jb	short dskw_12

 1C4C  8B 0E 3A46 R			mov	cx,word ptr [buff_s]
 1C50  8B 1E 3A48 R			mov	bx,word ptr [buff_s+2]
					;mov	si,cx
					;or	si,bx
					;jz	short dskw_12 ; buff_s = 0 is invalid	
					;cmp	si,0FFFFh     ; buff_s = 0FFFFh is invalid
					;je	short dskw_12

					; write buffer content if sector is not same

 1C54  3B C8				cmp	cx,ax
 1C56  75 04				jne	short dskw_11
 1C58  3B DA				cmp	bx,dx
 1C5A  74 15				je	short dskw_12	
 1C5C				dskw_11:
 1C5C  52				push	dx
 1C5D  50				push	ax
					; 17/12/2019
					;mov	ax,word ptr [buff_s]
					;mov	dx,word ptr [buff_s+2]
 1C5E  8B C1				mov	ax,cx
 1C60  8B D3				mov	dx,bx
 1C62  BB 3EB0 R			mov	bx,offset Buffer
 1C65  E8 005E				call	dskwr
 1C68  58				pop	ax
 1C69  5A				pop	dx
 1C6A  72 2B				jc	short dskw_5
 1C6C  C6 06 3A4A R 00			mov	byte ptr [buff_m],0
 1C71				dskw_12:
					;mov	si,word ptr [u_fofp]

					; 29/12/2019
					;mov	si,offset u_off
					;mov	bx,word ptr [si]

 1C71  8B 1E 3A4C R			mov	bx,word ptr [u_off] ; 15/01/2020

 1C75  81 E3 01FF			and	bx,1FFh	; bit *u.fofp,$777
						; test the lower 9 bits of the file offset
 1C79  BB 3EB0 R			mov	bx,offset Buffer ; 04/12/2019
 1C7C  75 08				jnz	short dskw_2 ; bne 2f 
						; if its non-zero, branch; if zero, file offset = 0,
					   	; 512, 1024,...(i.e., start of new block)
 1C7E  81 3E 3A50 R 0200		cmp	word ptr [u_count],512 ; cmp u.count,$512.
						; if zero, is there enough data to fill an
					        ; entire block? (i.e., no. of
					;jnb	short dskw_6 ; bhis 3f
						; / bytes to be written greater than 512.? 
						; Yes, branch. / Don't have to read block
 1C84  73 15				jnb	short dskw_3 ; 09/11/2019
 1C86				dskw_2: ; 2
					; in as no past info. is to be saved (the entire block will be
				        ; overwritten).

					; 09/11/2019
					;mov	bx,offset Buffer ; 04/12/2019
 1C86  3B 06 3A46 R			cmp	ax,word ptr [buff_s]
					;jne	short dskw_13
 1C8A  75 06				jne	short dskw_6
 1C8C  3B 16 3A48 R			cmp	dx,word ptr [buff_s+2]
 1C90  74 09				je	short dskw_3
				;dskw_13:
 1C92				dskw_6:
					;mov	bx,ax	; R1 (block number)
 1C92  E8 0038				call	dskrd 	; jsr r0,dskrd 
						; no, must retain old info.. Hence, read block 'r1'
					        ; into an I/O buffer
					;jc	short dskw_5 ; 01/03/2013
					; 04/12/2019
 1C95  73 04				jnc	short dskw_3
 1C97				dskw_5:
 1C97  5B				pop	bx

 1C98  5E				pop	si
 1C99  5F				pop	di

 1C9A  C3				retn

 1C9B				dskw_3: ; 3
					;call	wslot

 1C9B  E8 014C				call	sioreg

					; SI = user data offset (r1)
					; DI = sector (I/O) buffer offset (r2)
					; CX = byte count (r3)

 1C9E				dskw_4: ; 2
 1C9E  F3/ A4				rep	movsb

 1CA0  C6 06 3A4A R 01			mov	byte ptr [buff_m],1
					; 09/11/2019
 1CA5  A3 3A46 R			mov	word ptr [buff_s],ax
 1CA8  89 16 3A48 R			mov	word ptr [buff_s+2],dx
					;mov	bx,offset Buffer ; offset sector_buffer	
 1CAC  E8 0017				call	dskwr ; jsr r0,dskwr / write the block and the i-node
 1CAF  72 E6			        jc	short dskw_5

 1CB1  C6 06 3A4A R 00			mov	byte ptr [buff_m],0
					
 1CB6  83 3E 3A50 R 00		        cmp	word ptr [u_count],0 ; any more data to write?
					;ja	dskw_1 ; 1b ; yes, branch
					; 01/01/2020
 1CBB  76 02				jna	short @f
 1CBD  EB 81				jmp	dskw_1
 1CBF				@@:
 1CBF  C6 06 3A56 R 00			mov	byte ptr [Error],0 ; 03/09/2019
					; 04/12/2019
 1CC4  EB D1				jmp	short dskw_5
				;dskw_5:
				;	pop	bx
				;
				;	pop	si
				;	pop	di
				;
				;	retn

				;dskw_6:
					;cmp	byte ptr [buff_m],1
					;jb	short dskw_3
					;mov	bx,offset Buffer ; 09/11/2019
					;call	dskwr
					;jc	short dskw_5
					;mov	word ptr [buff_s],ax ; block number from mget procedure
					;mov	word ptr [buff_s+2],dx 
					;cmp	byte ptr [buff_m],0
					;jmp	short dskw_3

 1CC6				dskw 	endp

 1CC6				dskwr	proc near
					; 14/01/2020
					; 18/12/2019
					; 27/11/2019
					; 07/11/2019 - Retro UNIX 386 v2
					;
					; Disk (Sector) Write
					;
					; INPUT: 
					;	DX:AX = Sector address/number (LBA)
					;	ES:BX = Buffer address
					; OUTPUT:
					;	CF = 0 -> succeeded
					;	CF = 1 -> Error, Error code in [Error]
					;
					; Modified registers: cx

 1CC6  C6 06 3A5C R 03			mov	byte ptr [rw],3 ; write
 1CCB  EB 05				jmp	short diskio

 1CCD				dskwr	endp
					
 1CCD				dskrd	proc near
					; 14/01/2020
					; 30/12/2019
					; 18/12/2019
					; 03/12/2019
					; 27/11/2019
					; 07/11/2019
					; 06/11/2019 - Retro UNIX 386 v2
					;
					; Disk (Sector) Read
					;
					; INPUT: 
					;	DX:AX = Sector address/number (LBA)
					;	ES:BX = Buffer address
					; OUTPUT:
					;	CF = 0 -> succeeded
					;	CF = 1 -> Error, Error code in [Error]
					;
					; Modified registers: cx

 1CCD  C6 06 3A5C R 02			mov	byte ptr [rw],2 ; read
 1CD2				diskio:
 1CD2  C7 06 3A56 R 0000		mov	word ptr [Error],0
 1CD8  C6 06 3012 R 04			mov	byte ptr [RetryCount],4

					; 07/11/2019
 1CDD  52				push	dx ; *
 1CDE  50				push	ax ; **

					; 30/12/2019 (dskrd is called before reading super block)
					;	  (so, it is better to use hidden_sectors directly)
					;	
					;add	ax,word ptr [systm.sb_HiddenSects]
					;adc	dx,word ptr [systm.sb_HiddenSects+2] 
 1CDF  03 06 3A8E R			add	ax,word ptr [hidden_sectors]   ; = [systm.sb_BootSectAddr]
 1CE3  13 16 3A90 R			adc	dx,word ptr [hidden_sectors+2] ; = [systm.sb_BootSectAddr+2]

 1CE7  80 3E 3A45 R 90			cmp	byte ptr [Drive],90h ; Hard disk image file sign
					;;je	short image_file_rw
					;jnb	image_file_rw
					; 27/03/2022
 1CEC  72 03				jb	short @f
 1CEE  E9 00AE				jmp	image_file_rw
 1CF1				@@:
					; 27/11/2019
 1CF1  23 D2				and	dx,dx
 1CF3  74 0E				jz	short chs_read_write

 1CF5  3B 16 3AA4 R			cmp	dx,word ptr [CHS_limit+2]
 1CF9  77 54				ja	short lba_read_write
 1CFB  72 06				jb	short chs_read_write

 1CFD  3B 06 3AA2 R			cmp	ax,word ptr [CHS_limit]
 1D01  77 4C				ja	short lba_read_write
 1D03				chs_read_write:
 1D03  52				push	dx ; ***
 1D04  50				push	ax ; ****

 1D05  53				push	bx ; *****
					
 1D06  8B 0E 3A8A R			mov	cx,word ptr [sectors] ; spt
 1D0A  E8 028E				call	div32	; Special 32 bit divide !!!
					        ; To fix large disk problem.
					        ; by Erdogan Tan
					        ; (October 20th, 1999)

 1D0D  8B CB				mov	cx,bx	;Sector (zero based)
 1D0F  41				inc	cx	; To make it 1 based
 1D10  51				push	cx ; ******
 1D11  8B 0E 3A88 R			mov	cx,word ptr [heads]
 1D15  E8 0283				call	div32
 1D18  8A F3				mov	dh,bl	; bx = head (max. 255)
 1D1A  59				pop	cx ; ****** ; ax=cylinder, dh=head, cx=sector

 1D1B  5B				pop	bx ; *****  ; es:bx = buffer address

 1D1C  8A 16 3A45 R			mov	dl,byte ptr [drive] ; physical drive number
 1D20  8A E8				mov	ch,al
 1D22  D0 CC				ror	ah,1
 1D24  D0 CC				ror	ah,1
					;and	cl,63
 1D26  0A CC				or	cl,ah

 1D28  8A 26 3A5C R			mov	ah,byte ptr [rw] ; 2 = read, 3 = write
 1D2C  B0 01			 	mov	al,1 ; 1 sector
 1D2E  CD 13				int	13h  ; ROM BIOS Service func (ah) = 2
						; Read disk sectors
						; AL-sec num CH-track CL-sec
				   		; DH-head DL-drive ES:BX-buffer
				 		; CF-flag AH-stat AL-sec read
						; If CF = 1 then (If AH > 0)

 1D30  73 18				jnc	short chs_rw_ok	
					
					; dl = physical drive number

 1D32  FE 0E 3012 R			dec	byte ptr [RetryCount]
 1D36  74 0D				jz	short chs_err_retn

 1D38  80 FC 09				cmp	ah,09h ; DMA crossed 64K segment boundary
 1D3B  74 08				je	short chs_err_retn

 1D3D  32 E4				xor	ah,ah ; reset
 1D3F  CD 13				int	13h

 1D41  58				pop	ax ; ****
 1D42  5A				pop	dx ; ***

 1D43  EB BE				jmp	short chs_read_write ; read (or write) again	

 1D45				chs_err_retn:
 1D45				lba_err_retn:
 1D45  F9				stc
 1D46  88 26 3A56 R			mov	byte ptr [Error],ah
 1D4A				chs_rw_ok:
					; 12/12/2019
 1D4A				lba_rw_ok: ; 03/12/2019
 1D4A  58				pop	ax ; ****
 1D4B  5A				pop	dx ; ***
 1D4C				@@:
 1D4C  58				pop	ax ; **
 1D4D  5A				pop	dx ; *
 1D4E  C3				retn

 1D4F				lba_read_write:
					; 20/07/2022
					; 08/01/2020
					; 18/12/2019
					; 12/12/2019
					; 07/11/2019
					; LBA read/write
 1D4F  80 0E 3A5C R 40			or	byte ptr [rw],40h ; 42h = read, 43h = write
					
					; 06/11/2019
					;cmp	byte ptr [systm.sb_LBA_rw],1
					;jnb	short lba_read_again
					; 20/07/2022
 1D54  80 3E 3AA0 R 01			cmp	byte ptr [LBA_rw],1
 1D59  73 07				jnb	short lba_read_again

 1D5B				lba_not_ready:
 1D5B  C6 06 3A56 R FF			mov	byte ptr [Error],0FFh
					;stc
					;retn
 1D60  EB EA				jmp	short @b ; 08/01/2020

 1D62				lba_read_again:
 1D62  52				push	dx ; ***
 1D63  50				push	ax ; ****

					; 18/12/2019
 1D64  56				push	si ; *****

					; 03/12/2019
 1D65  33 C9				xor	cx,cx
					;push 0
 1D67  51				push	cx ; 6*
					;push 0
 1D68  51				push	cx ; 7*

 1D69  52				push	dx ; 8*
 1D6A  50				push	ax ; 9*
 1D6B  06				push	es ; 10*
 1D6C  53				push	bx ; 11*

					;push 1
 1D6D  B1 01				mov	cl,1
 1D6F  51				push	cx ; 12*
					;push 16
 1D70  B1 10				mov	cl,16
 1D72  51				push	cx ; 13*
					
 1D73  8B F4				mov	si,sp
 1D75  8A 16 3A45 R			mov	dl,byte ptr [drive]
 1D79  8A 26 3A5C R			mov	ah,byte ptr [rw]
 1D7D  32 C0				xor	al,al ; verify off
 1D7F  CD 13				int	13h
 1D81  58				pop	ax ; 13*
 1D82  58				pop	ax ; 12*
 1D83  5B				pop	bx ; 11*
 1D84  07				pop	es ; 10*
 1D85  58				pop	ax ; 9*
 1D86  5A				pop	dx ; 8*
 1D87  59				pop	cx ; 7*
 1D88  59				pop	cx ; 6*
					; 18/12/2019
 1D89  5E				pop	si ; *****
 1D8A  73 BE				jnc	short lba_rw_ok	

					; dl = physical drive number

 1D8C  FE 0E 3012 R			dec	byte ptr [RetryCount]
 1D90  74 B3				jz	short lba_err_retn

 1D92  80 FC 09				cmp	ah,09h ; DMA crossed 64K segment boundary
 1D95  74 AE				je	short lba_err_retn

 1D97  32 E4				xor	ah,ah ; reset
 1D99  CD 13				int	13h

 1D9B  58				pop	ax ; ****
 1D9C  5A				pop	dx ; ***

 1D9D  EB C3				jmp	short lba_read_again ; read again

 1D9F				dskrd	endp
					
 1D9F				image_file_rw proc near
					; 07/11/2019 - Retro UNIX 386 v2 (hard disk images)
					; 09/09/2019 - Retro UNIX 386 v2 (floppy disk images)

					; reading/writing a block (sector) from/to disk image file

					; INPUT:
					; 	dx:ax = sector/block number (max. 4194303, 3FFFFFh)
				        ;	es:bx = buffer address (es = ds)
					;       [img_file_handle] = file handle
					;	number of bytes to be written = 512
					;
					; OUTPUT:
					;	CF = 0 -> succeeded
					;	CF = 1 -> Error, Error code in [Error]
					;
					; Modified registers: cx

 1D9F  83 FA 3F				cmp	dx,3Fh  ; Max. 2GB disk image file (32bit seek limit)
 1DA2  76 09				jna	short hd_img_file_rw

 1DA4				invalid_disk_image_sector:
 1DA4  F9				stc
 1DA5				image_file_rw_err:
 1DA5  C6 06 3A56 R FF			mov	byte ptr [Error],0FFh
 1DAA				image_file_rw_ok:
 1DAA  58				pop	ax ; **
 1DAB  5A				pop	dx ; *
 1DAC  C3				retn
					
 1DAD				hd_img_file_rw:
 1DAD  52				push	dx ; ***
 1DAE  50				push	ax ; ****
 1DAF  53				push	bx ; ***** ; buffer offset
 1DB0  53				push	bx ; ******
					; dx:ax = sector number 
 1DB1  B9 0200				mov	cx,512
 1DB4  E8 01D0				call	mul32
					; dx:ax = byte offset
 1DB7  8B CA				mov	cx,dx
 1DB9  8B D0				mov	dx,ax
 1DBB  2A C0				sub	al,al ; specified offset is from the beginning of the file
 1DBD  B4 42				mov	ah,42h ; seek (move file pointer)	
 1DBF  8B 1E 3022 R			mov	bx,word ptr [img_file_handle]
 1DC3  CD 21				int	21h
 1DC5  5A				pop	dx ; ****** ; buffer offset
 1DC6  72 18				jc	short hd_img_file_rw_err

					;mov	bx,word ptr [img_file_handle]
 1DC8  B9 0200				mov	cx,512
					; ds:dx = buffer offset
 1DCB  B4 3D				mov	ah,3Dh ; 3Fh = read from file, 40h = write to file
 1DCD  02 26 3A5C R			add	ah,byte ptr [rw] ; 2 = read, 3 = write 
 1DD1  CD 21				int	21h
 1DD3  72 0B				jc	short hd_img_file_rw_err
 1DD5  80 3E 3A5C R 02			cmp	byte ptr [rw],2  ; read ?
 1DDA  74 09				je	short hd_img_file_rw_ok
 1DDC  3B C1				cmp	ax,cx ; ax = actually written bytes
 1DDE  73 05				jnb	short hd_img_file_rw_ok

 1DE0				hd_img_file_rw_err:
					;pop bx ; *****
					;pop ax ; ****
					;pop dx ; ***
					;jmp	short image_file_rw_err

 1DE0  C6 06 3A56 R FF			mov	byte ptr [Error],0FFh

 1DE5				hd_img_file_rw_ok:
 1DE5  5B				pop	bx ; *****
 1DE6  58				pop	ax ; ****
 1DE7  5A				pop	dx ; ***
 1DE8  EB C0				jmp	short image_file_rw_ok

 1DEA				image_file_rw endp

				; 17/12/2019

 1DEA				sioreg proc near
					; 29/12/2019	
					; 09/11/2019 - Retro UNIX 386 v2 (for hard disk fs)
					; 04/09/2019 - RETRO UNIX v0.3 (Retro UNIX 386 v2)
					; 16/12/2012
					; 31/10/2012
					; 19/08/2012
					; 04/08/2012
					; Erdogan Tan - RETRO UNIX v0.1
					; input ->
					;	R5 (DX) = sector buffer (data) address
					;	*u.fofp = file offset, to start writing
					;	u.base  = address of 1st byte of user data
					;	u.count = byte count to be transferred
					;	u.nread = number of bytes written out
					;		  previously.
					; output ->
					;	*u.fofp = last (written) byte + 1
					;	u.count = number of bytes of data left
					;		  to be transferred.		
					;	u.nread = updated to include the count
					;		  of bytes to be transferred.
					;	R1 (SI) = address of 1st byte of data
					;	R2 (DI) = specifies the byte in IO 
					;		  sector (I/O) buffer. (Offset)	
					;	R3 (CX) = number of bytes of data to be
					;		  transferred to/from sector (I/O)
					;		  buffer.
					;
					; Modified registers: cx, si, di	

					;mov	dx,offset Buffer     ; R5
					; 31/10/2012	
				       ;mov	si,word ptr [u_fofp] ; mov *u.fofp,r2 
					; 29/12/2019
 1DEA  BE 3A4C R			mov	si,offset u_off

 1DED  8B 3C				mov	di,word ptr [si] ; file offset (in bytes) is moved to r2
 1DEF  8B CF				mov	cx,di	; mov r2,r3 / and also to r3

 1DF1  81 C9 FE00			or	cx,0FE00h ; set bits 9...15 of file offset in R3
 1DF5  81 E7 01FF			and	di,1FFh ; calculate file offset mod 512

					; 09/11/2019
					; 19/08/2012
 1DF9  81 C7 3EB0 R			add	di,offset Buffer ; DI/r2 now points to 1st byte in buffer
						     ; where data is to be placed
				        ;mov	si,word ptr [u_base] ; address of data is in r1
 1DFD  F7 D9				neg	cx ; 512 - file offset(mod512) in R3 (cx)
							; the number of free bytes in the file block
 1DFF  3B 0E 3A50 R		        cmp	cx,word ptr [u_count] ; compare this with the number of data bytes
								      ; to be written to the file
 1E03  76 04				jna	short @f ; 2f
						   ; if less than branch. Use the number of free bytes
					           ; in the file block as the number to be written
 1E05  8B 0E 3A50 R		        mov	cx,word ptr [u_count]
						   ; if greater than, use the number of data bytes
					           ; as the number to be written
 1E09				@@:	; 2
				;sioreg_1:	
 1E09  01 0E 3A54 R			add	word ptr [u_nread],cx ; r3 + number of bytes
						; xmitted during write is put into
					        ; u.nread

 1E0D  29 0E 3A50 R		        sub	word ptr [u_count],cx
						; u.count = no. of bytes that still must be
					        ; written or read
					; 30/12/2019
					;;mov	si,word ptr [u_fofp]
				        ;; 29/12/2019
					;mov	si,offset u_off

 1E11  01 0C				add	word ptr [si],cx ; new file offset = number 
						; of bytes done + old file offset
					; 09/11/2019
 1E13  83 54 02 00			adc	word ptr [si+2],0

					; Note: word ptr [u_base] + cx must not over 65535	

					; 16/12/2012 BugFix
 1E17  8B 36 3A52 R			mov	si,word ptr [u_base] ; address of data is in SI/r1

 1E1B  01 0E 3A52 R		        add	word ptr [u_base],cx ; u.base points to 1st of remaining
						; data bytes
 1E1F  C3				retn

 1E20				sioreg	endp 	

 1E20				epoch proc near
					; 25/01/2020
					; 29/12/2019
					; 14/11/2012
					; unixboot.asm (boot file configuration)
					; version of "epoch" procedure in "unixproc.asm"
					; 21/7/2012
					; 15/7/2012
					; 14/7/2012	
					; Erdogan Tan - RETRO UNIX v0.1
					; compute current date and time as UNIX Epoch/Time
					; UNIX Epoch: seconds since 1/1/1970 00:00:00

					; 25/01/2020
					; Modified registers: ax, bx, cx, dx

					; 21/7/2012
					;push	bx
					;push	cx

 1E20  B4 02				mov	ah, 02h	      ; Return Current Time
 1E22  CD 1A			        int	1Ah
 1E24  86 E9			        xchg	ch,cl
 1E26  89 0E 309C R		        mov	word ptr [hour], cx
 1E2A  86 F2			        xchg	dh,dl
 1E2C  89 16 30A0 R		        mov	word ptr [second], dx

 1E30  B4 04			        mov	ah, 04h	      ; Return Current Date
 1E32  CD 1A			        int	1Ah
 1E34  86 E9			        xchg	ch,cl
 1E36  89 0E 3096 R		        mov	word ptr [year], cx
 1E3A  86 F2			        xchg	dh,dl
 1E3C  89 16 3098 R		        mov	word ptr [month], dx

 1E40  B9 3030				mov	cx, 3030h

 1E43  A0 309C R			mov	al, byte ptr [hour] ; Hour
				           ; AL <= BCD number)
 1E46  D4 10			        db 0D4h,10h	; Undocumented inst. AAM
							; AH = AL / 10h
							; AL = AL MOD 10h
 1E48  D5 0A			        aad ; AX= AH*10+AL
					
 1E4A  A2 309C R			mov	byte ptr [hour], al

 1E4D  A0 309D R			mov	al, byte ptr [hour]+1 ; Minute
				           ; AL <= BCD number)
 1E50  D4 10			        db 0D4h,10h	; Undocumented inst. AAM
							; AH = AL / 10h
							; AL = AL MOD 10h
 1E52  D5 0A			        aad ; AX= AH*10+AL
					
 1E54  A2 309E R			mov	byte ptr [minute], al

 1E57  A0 30A0 R			mov	al, byte ptr [second] ; Second
				           ; AL <= BCD number)
 1E5A  D4 10			        db 0D4h,10h	; Undocumented inst. AAM
							; AH = AL / 10h
							; AL = AL MOD 10h
 1E5C  D5 0A			        aad ; AX= AH*10+AL
					
 1E5E  A2 30A0 R			mov	byte ptr [second], al

 1E61  A1 3096 R			mov	ax, word ptr [year] ; Year (century)
 1E64  50			        push	ax
					   ; AL <= BCD number)
 1E65  D4 10			        db 0D4h,10h	; Undocumented inst. AAM
							; AH = AL / 10h
							; AL = AL MOD 10h
 1E67  D5 0A			        aad ; AX= AH*10+AL
					
 1E69  B4 64				mov	ah, 100
 1E6B  F6 E4				mul	ah
 1E6D  A3 3096 R			mov	word ptr [year], ax

 1E70  58				pop	ax
 1E71  8A C4				mov	al, ah
				           ; AL <= BCD number)
 1E73  D4 10			        db 0D4h,10h	; Undocumented inst. AAM
							; AH = AL / 10h
							; AL = AL MOD 10h
 1E75  D5 0A			        aad ; AX= AH*10+AL
					
 1E77  01 06 3096 R			add	word ptr [year], ax

 1E7B  A0 3098 R			mov	al, byte ptr [month] ; Month
				           ; AL <= BCD number)
 1E7E  D4 10			        db 0D4h,10h	; Undocumented inst. AAM
							; AH = AL / 10h
							; AL = AL MOD 10h
 1E80  D5 0A			        aad ; AX= AH*10+AL
					
 1E82  A2 3098 R			mov	byte ptr [month], al	

 1E85  A0 3099 R			mov	al, byte ptr [month]+1 ; Day
				           ; AL <= BCD number)
 1E88  D4 10			        db 0D4h,10h	; Undocumented inst. AAM
							; AH = AL / 10h
							; AL = AL MOD 10h
 1E8A  D5 0A			        aad ; AX= AH*10+AL

 1E8C  A2 309A R			mov	byte ptr [Day], al
					
 1E8F				convert_to_epoch:
					; Derived from DALLAS Semiconductor
					; Application Note 31 (DS1602/DS1603)
	; 6 May 1998

 1E8F  8B 16 3096 R			mov	dx, word ptr [year]
 1E93  81 EA 07B2			sub	dx, 1970
 1E97  B8 016D				mov	ax, 365
 1E9A  F7 E2				mul	dx
 1E9C  32 FF				xor	bh, bh
 1E9E  8A 1E 3098 R			mov	bl, byte ptr [month]
 1EA2  FE CB				dec	bl
 1EA4  D0 E3				shl	bl, 1
 1EA6  8B 8F 30A2 R			mov	cx, word ptr DMonth[BX]
 1EAA  8A 1E 309A R			mov	bl, byte ptr [Day]
 1EAE  FE CB				dec	bl
					
 1EB0  03 C1				add	ax, cx
 1EB2  83 D2 00				adc	dx, 0
 1EB5  03 C3				add	ax, bx
 1EB7  83 D2 00				adc	dx, 0
						; DX:AX = days since 1/1/1970
 1EBA  8B 0E 3096 R			mov	cx, word ptr [year]
 1EBE  81 E9 07B1			sub	cx, 1969
 1EC2  D1 E9				shr	cx, 1
 1EC4  D1 E9				shr	cx, 1	
					; (year-1969)/4
 1EC6  03 C1				add	ax, cx
 1EC8  83 D2 00				adc	dx, 0
						; + leap days since 1/1/1970

 1ECB  80 3E 3098 R 02			cmp	byte ptr [month], 2  ; if past february
 1ED0  76 0F				jna	short @f
 1ED2  8B 0E 3096 R			mov	cx, word ptr [year]
 1ED6  83 E1 03				and	cx, 3 ; year mod 4
 1ED9  75 06				jnz	short @f	
						; and if leap year
 1EDB  83 C0 01				add	ax, 1 ; add this year's leap day (february 29)
 1EDE  83 D2 00				adc	dx, 0
 1EE1				@@: 		; compute seconds since 1/1/1970
 1EE1  B9 0018				mov	cx, 24 ; 29/12/2019
 1EE4  E8 00A0				call	mul32

 1EE7  8A 1E 309C R			mov	bl, byte ptr [hour]
 1EEB  03 C3				add	ax, bx
 1EED  83 D2 00				adc	dx, 0
					
					;mov	cx, 60 ; 29/12/2019
 1EF0  B1 3C				mov	cl, 60	
 1EF2  E8 0092				call	mul32

 1EF5  8A 1E 309E R			mov	bl, byte ptr [minute]
 1EF9  03 C3				add	ax, bx
 1EFB  83 D2 00				adc	dx, 0
					
					;;mov	cx, 60 ; 29/12/2019
					;mov	cl, 60	
 1EFE  E8 0086				call	mul32 ; 29/12/2019

 1F01  8A 1E 30A0 R			mov	bl, byte ptr [second]
 1F05  03 C3				add	ax, bx
 1F07  83 D2 00			 	adc	dx, 0

					; DX:AX -> seconds since 1/1/1970 00:00:00

					; 21/7/2012
					;pop	cx
					;pop	bx
					
 1F0A  C3				retn

 1F0B				epoch endp

 1F0B				convert_from_epoch proc near
					; 30/11/2012
					; Derived from DALLAS Semiconductor
					; Application Note 31 (DS1602/DS1603)
					; 6 May 1998
					;
					; INPUT:
					; DX:AX = Unix (Epoch) Time
 1F0B  B9 003C				mov	cx, 60
 1F0E  E8 008A				call	div32
					;mov	word ptr [imin], ax   ; whole minutes
					;mov	word ptr [imin]+2, dx ; since 1/1/1970
 1F11  89 1E 30A0 R			mov	word ptr [second], bx ; leftover seconds
					;mov	cx, 60
 1F15  E8 0083				call	div32
					;mov	word ptr [ihrs], ax   ; whole hours
					;mov	word ptr [ihrs]+2, dx ; since 1/1/1970
 1F18  89 1E 309E R			mov	word ptr [minute], bx ; leftover minutes
					;mov	cx, 24
 1F1C  B1 18				mov	cl, 24
 1F1E  E8 007A				call	div32
					;mov	word ptr [iday], ax   ; whole hours
						  		      ; since 1/1/1970
					;mov	word ptr [iday]+2, dx ; DX = 0
 1F21  89 1E 309C R			mov	word ptr [hour], bx   ; leftover hours
 1F25  05 02DB				add	ax, 365+366	  ; whole day since
						  		  ; 1/1/1968 	
					;adc	dx, 0	          ;  DX = 0
					;mov	word ptr [iday], ax
 1F28  50				push	ax
 1F29  B9 05B5				mov	cx, (4*365)+1	  ; 4 years = 1461 days
 1F2C  E8 006C				call	div32
 1F2F  59				pop	cx
					;mov	word ptr [lday], ax  ; count of quadyrs (4 years)
 1F30  53				push	bx
					;mov	word ptr [qday], bx  ; days since quadyr began
 1F31  83 FB 3C				cmp	bx, 31 + 29	     ; if past feb 29 then
 1F34  F5				cmc			; add this quadyr's leap day
 1F35  83 D0 00				adc	ax, 0		; to # of qadyrs (leap days)
					;mov	word ptr [lday], ax  ; since 1968		  
					;mov	cx, word ptr [iday]
 1F38  91				xchg	cx, ax	  	; CX = lday, AX = iday	  
 1F39  2B C1				sub	ax, cx	  	; iday - lday
 1F3B  B9 016D				mov	cx, 365
					;xor	dx, dx	  	; DX  = 0
					; AX = iday-lday, DX = 0
 1F3E  E8 005A				call	div32
					;mov	word ptr [iyrs], ax  ; whole years since 1968
					; jday = iday - (iyrs*365) - lday
					;mov	word ptr [jday], bx  ; days since 1/1 of current year
 1F41  05 07B0				add	ax, 1968	; compute year
 1F44  A3 3096 R			mov	word ptr [year], ax
 1F47  8B D0				mov	dx, ax	
					;mov	ax, word ptr [qday]
 1F49  58				pop	ax
 1F4A  3D 016D				cmp	ax, 365		; if qday <= 365 and qday >= 60	
 1F4D  77 07				ja	short @f	; jday = jday +1
 1F4F  83 F8 3C				cmp	ax, 60		; if past 2/29 and leap year then
 1F52  F5			        cmc			; add a leap day to the # of whole
 1F53  83 D3 00				adc	bx, 0		; days since 1/1 of current year
 1F56				@@:		
					;mov	word ptr [jday], bx
 1F56  B9 000C				mov	cx, 12		; estimate month
 1F59  87 CB				xchg	cx, bx		; CX = jday, BX = month 	
 1F5B  B8 016E				mov	ax, 366		; mday, max. days since 1/1 is 365
 1F5E  83 E2 03				and	dx, 11b		; year mod 4	(and dx, 3) 
 1F61				@@:	; Month calculation	  ; 0 to 11  (11 to 0)	
 1F61  3B C8				cmp	cx, ax		; mday = # of days passed from 1/1
 1F63  73 15				jnb	short @f
 1F65  4B				dec	bx		; month = month - 1
 1F66  D1 E3				shl	bx, 1 
 1F68  8B 87 30A2 R			mov	ax, word ptr DMonth[BX] ; # elapsed days at 1st of month
 1F6C  D1 EB				shr	bx, 1		; bx = month - 1 (0 to 11)
 1F6E  83 FB 01				cmp	bx, 1		; if month > 2 and year mod 4  = 0	
 1F71  76 EE				jna	short @b	; then mday = mday + 1
 1F73  0A D2				or	dl, dl		; if past 2/29 and leap year then
 1F75  75 EA				jnz	short @b	; add leap day (to mday)
 1F77  40				inc	ax		; mday = mday + 1
 1F78  EB E7				jmp	short @b
 1F7A				@@:
 1F7A  43				inc	bx		; -> bx = month, 1 to 12
 1F7B  89 1E 3098 R			mov	word ptr [month], bx
 1F7F  2B C8				sub	cx, ax		; day = jday - mday + 1	
 1F81  41				inc	cx 		  
 1F82  89 0E 309A R			mov	word ptr [day], cx
					
					; ax, bx, cx, dx is changed at return
					; output ->
					; [year], [month], [day], [hour], [minute], [second]
					; 

 1F86  C3				retn

 1F87				convert_from_epoch endp

 1F87				mul32 proc near
					; DX_AX*CX
					; Result: BX_DX_AX 

 1F87  51				push	cx

 1F88  8B DA				mov	bx,dx
 1F8A  F7 E1				mul	cx
 1F8C  93				xchg	ax,bx

 1F8D  52				push	dx
 1F8E  F7 E1				mul	cx 
 1F90  59				pop	cx 

 1F91  03 C1				add	ax,cx 
 1F93  83 D2 00				adc	dx,0
 1F96  93				xchg	bx,ax
 1F97  87 D3				xchg	dx,bx

 1F99  59				pop	cx

 1F9A  C3				retn

 1F9B				mul32 endp

 1F9B				div32 proc near
					; 1999
					; (Rx_Dos_Div32) 32 bit divide procedure 
					; by Erdogan Tan
					; Input ->
					;	DX_AX = 32 bit dividend
					;          CX = 16 bit divisor
					; output ->
					;	DX_AX = 32 bit quotient
					;          BX = 16 bit remainder
					;
 1F9B  8B DA				mov	bx, dx
 1F9D  93				xchg	ax, bx
 1F9E  33 D2				xor	dx, dx
 1FA0  F7 F1				div	cx	; at first, divide DX
 1FA2  93				xchg	ax, bx	; remainder is in DX
							; now, BX has quotient
							; save remainder
 1FA3  F7 F1				div	cx	; so, DX_AX divided and
							; AX has quotient
							; DX has remainder
 1FA5  87 D3				xchg	dx, bx	; finally, BX has remainder

				;sync_0: ; 19/09/2019
 1FA7  C3				retn

 1FA8				div32 endp

 1FA8				sync 	proc near
					; 05/01/2020
					; 02/01/2020
					; 01/01/2020
					; 30/12/2019
					; 26/12/2019
					; 28/09/2019
					; 18/09/2019 - Retro UNIX 386 v2 (RUNIX v2 file system)
					;
					; 14/07/2015
					; 07/07/2015
					; 18/11/2012 unix boot file configuration version
					; of "sync" procedure of retro unix v1.0 by Erdogan Tan
					; 12/8/2012
					; updates super block and the last i-node on disk 
					; if modified
					; e.g. smod = 1, imod = 1, buffer_m = 1
					;
					; RETRO UNIX v1 FS

					;xor	ax, ax ; mov ax, 0

					; 26/12/2019
 1FA8  33 DB				xor	bx, bx ; mov bx,0

 1FAA  E8 F63F				call	iget ; (write modified i-node)
					;;;jc	short sync_3
					;;jc	short sync_0 ; 19/09/2019
					;jc	short sync_18 ; 01/01/2020
 1FAD  73 03				jnc	short @f
 1FAF  E9 009B				jmp	sync_18
 1FB2				@@:
					; 01/01/2020
 1FB2  80 3E 3A4A R 00			cmp	byte ptr [buff_m],0
 1FB7  76 17				jna	short sync_0

 1FB9  A1 3A46 R			mov	ax,word ptr [buff_s]
 1FBC  8B 16 3A48 R			mov	dx,word ptr [buff_s+2]
 1FC0  BB 3EB0 R			mov	bx,offset Buffer
 1FC3  E8 FD00				call	dskwr
					;jc	short sync_18
 1FC6  73 03				jnc	short @f
 1FC8  E9 0082				jmp	sync_18
 1FCB				@@:
 1FCB  C6 06 3A4A R 00			mov	byte ptr [buff_m],0
 1FD0				sync_0:
 1FD0  80 3E 3A59 R 00			cmp	byte ptr [smod],0
					;jna	sync_17
					; 01/01/2020
 1FD5  77 03				ja	short @f
 1FD7  E9 0180				jmp	sync_17	
 1FDA				@@:
					; 29/09/2019
					; set super block modification time
 1FDA  E8 FE43				call	epoch
 1FDD  A3 3D0C R			mov	word ptr [systm.sb_ModifTime],ax
 1FE0  89 16 3D0E R			mov	word ptr [systm.sb_ModifTime+2],dx

 1FE4  F6 06 3A59 R 02			test 	byte ptr [smod],2 ; inode map modified 
 1FE9  74 7F				jz	short sync_7

 1FEB  33 D2				xor	dx,dx
 1FED  A1 3A84 R			mov	ax,word ptr [im_sector]
 1FF0  03 06 3CD0 R			add	ax,word ptr [systm.sb_InodeMapAddr]
 1FF4  13 16 3CD2 R			adc	dx,word ptr [systm.sb_InodeMapAddr+2]
 1FF8  BB 46B0 R			mov	bx,offset im_buffer

 1FFB  E8 FCC8				call	dskwr
					;jc	short sync_18
					; 01/01/2020
 1FFE  73 02				jnc	short @f
 2000  EB 4B				jmp	sync_18	
 2002				@@:
 2002  80 26 3A59 R FD			and	byte ptr [smod],0FDh ; reset bit 1

					; 01/01/2020
					; set free inodes number
					; if it is invalid (in sb)

 2007  83 3E 3CE0 R FF			cmp	word ptr [systm.sb_FreeInodes],0FFFFh ; invalid
 200C  72 5C				jb	short sync_7

 200E  8B 0E 3CC4 R			mov	cx,word ptr [systm.sb_InodeCount] ; <= 65534
 2012  89 0E 3A7C R			mov	word ptr [count],cx
 2016  A1 3CD0 R			mov	ax,word ptr [systm.sb_InodeMapAddr]
 2019  8B 16 3CD2 R			mov	dx,word ptr [systm.sb_InodeMapAddr+2]
 201D  33 ED				xor	bp,bp ; 0
 201F  89 2E 3A84 R			mov	word ptr [im_sector],bp ; 0
 2023				sync_1:
 2023  BB 46B0 R			mov	bx,offset im_buffer
 2026  A3 3A70 R			mov	word ptr [save_ax],ax
 2029  89 16 3A72 R			mov	word ptr [save_dx],dx
 202D  E8 FC9D				call	dskrd
 2030  72 38				jc	short sync_7
 2032				sync_2:
 2032  B9 0008				mov	cx,8
 2035  8A 07				mov	al,byte ptr [bx] ; 02/01/2020
 2037				sync_3:
 2037  D0 E8				shr	al,1	; 02/01/2020
 2039  72 01				jc	short sync_4 ; allocated inode
 203B  45				inc	bp	; free inode
 203C				sync_4:
 203C  FF 0E 3A7C R			dec	word ptr [count]
 2040  74 22				jz	short sync_6
 2042  E2 F3				loop	sync_3
 2044  81 FB 48AF R			cmp	bx,offset im_buffer+511
 2048  73 07				jnb	short sync_5
 204A  43				inc	bx
 204B  EB E5				jmp	short sync_2
 204D				sync_18:
 204D  A1 3A56 R			mov	ax,word ptr [Error]
 2050  C3				retn
 2051				sync_5: 
 2051  FF 06 3A84 R			inc	word ptr [im_sector]
 2055  A1 3A70 R			mov	ax,word ptr [save_ax]
 2058  8B 16 3A72 R			mov	dx,word ptr [save_dx]
 205C  83 C0 01				add	ax,1
 205F  83 D2 00				adc	dx,0
 2062  EB BF				jmp	short sync_1
 2064				sync_6:
 2064  89 2E 3CE0 R			mov	word ptr [systm.sb_FreeInodes],bp
					; ***
 2068  EB 0F				jmp	short sync_19 ; 01/01/2020
 206A				sync_7:
					; 01/01/2020
					; 29/09/2019
					; set first free inode number
					; if it is invalid (in sb)

 206A  BA FFFF				mov	dx,0FFFFh
 206D  39 16 3CE4 R			cmp	word ptr [systm.sb_FirstFreeIno],dx ; 0FFFFh
 2071  75 09				jne	short @f
 2073  39 16 3CE6 R			cmp	word ptr [systm.sb_FirstFreeIno+2],dx ; 0FFFFh	
 2077  75 03				jne	short @f
 2079				sync_19:
 2079  E8 00F5				call	set_firstfreeinode
 207C				@@:
 207C  F6 06 3A59 R 01			test 	byte ptr [smod],1 ; free map modified
					;jz	sync_15
					; 27/03/2022
 2081  75 03				jnz	short sync_22
 2083  E9 00AD				jmp	sync_15
 2086				sync_22:
 2086  A1 3A80 R			mov	ax,word ptr [fm_sector]
 2089  8B 16 3A82 R			mov	dx,word ptr [fm_sector+2]

 208D  03 06 3CC8 R			add	ax,word ptr [systm.sb_FreeMapAddr]
 2091  13 16 3CCA R			adc	dx,word ptr [systm.sb_FreeMapAddr+2]

 2095  BB 48B0 R			mov	bx,offset fbm_buffer 	
 2098  E8 FC2B				call	dskwr
 209B  72 B0				jc	short sync_18

 209D  80 26 3A59 R FE			and	byte ptr [smod],0FEh ; reset bit 0

					; 01/01/2020
					; set free blocks number
					; if it is invalid (in sb)

 20A2  A1 3CE8 R			mov	ax,word ptr [systm.sb_FreeBlocks] 	
 20A5  23 06 3CEA R			and	ax,word ptr [systm.sb_FreeBlocks+2]
 20A9  83 F8 FF				cmp	ax,0FFFFh 
					;jb	sync_15
					; 01/01/2020
 20AC  73 03				jnb	short @f
 20AE  E9 0082				jmp	sync_15
 20B1				@@:
 20B1  A1 3CB8 R			mov	ax,word ptr [systm.sb_VolumeSize]
 20B4  8B 16 3CBA R			mov	dx,word ptr [systm.sb_VolumeSize+2]	
 20B8  A3 3A7C R			mov	word ptr [count],ax
 20BB  89 16 3A7E R			mov	word ptr [count+2],dx

 20BF  A1 3CC8 R			mov	ax,word ptr [systm.sb_FreeMapAddr]
 20C2  8B 16 3CCA R			mov	dx,word ptr [systm.sb_FreeMapAddr+2]
 20C6  33 F6				xor	si,si
 20C8  33 FF				xor	di,di
 20CA  89 36 3A80 R			mov	word ptr [fm_sector],si ; 0
 20CE  89 3E 3A82 R			mov	word ptr [fm_sector+2],di
 20D2				sync_8:
 20D2  BB 48B0 R			mov	bx,offset fbm_buffer
 20D5  A3 3A70 R			mov	word ptr [save_ax],ax
 20D8  89 16 3A72 R			mov	word ptr [save_dx],dx
 20DC  E8 FBEE				call	dskrd
 20DF  72 52				jc	short sync_15
 20E1				sync_9:
 20E1  B9 0008				mov	cx,8
 20E4  8A 07				mov	al,byte ptr [bx] ; 02/01/2020
 20E6				sync_10:	 	
 20E6  D0 E8				shr	al,1	; 02/01/2020
 20E8  73 06				jnc	short sync_11 ; allocated block/sector
 20EA  83 C6 01				add	si,1	; free block/sector
 20ED  73 01				jnc	short sync_11
					;adc	di,0
 20EF  47				inc	di
 20F0				sync_11:
 20F0  83 2E 3A7C R 01			sub	word ptr [count],1
 20F5  77 0E				ja	short sync_12

					; 02/01/2020
 20F7  83 1E 3A7E R 00			sbb	word ptr [count+2],0
 20FC  EB 07				jmp	short sync_12
 20FE				sync_20:	
					; 01/01/2020
 20FE  83 3E 3A7E R 00			cmp	word ptr [count+2],0
 2103  76 24				jna	short sync_14
 2105				sync_12:
 2105  E2 DF				loop	sync_10
 2107  81 FB 4AAF R			cmp	bx,offset fbm_buffer+511
 210B  73 03				jnb	short sync_13
 210D  43				inc	bx
 210E  EB D1				jmp	short sync_9
 2110				sync_13: 
 2110  83 06 3A80 R 01			add	word ptr [fm_sector],1
 2115  83 16 3A82 R 00			adc	word ptr [fm_sector+2],0	
 211A  A1 3A70 R			mov	ax,word ptr [save_ax]
 211D  8B 16 3A72 R			mov	dx,word ptr [save_dx]
 2121  83 C0 01				add	ax,1
 2124  83 D2 00				adc	dx,0
 2127  EB A9				jmp	short sync_8
 2129				sync_14:
 2129  89 36 3CE8 R			mov	word ptr [systm.sb_FreeBlocks],si
 212D  89 3E 3CEA R			mov	word ptr [systm.sb_FreeBlocks+2],di
					; ***
 2131  EB 0F				jmp	short sync_16 ; 01/01/2020
 2133				sync_15:	
					; 01/01/2020
					; set first free block number
					; set free blocks number
					; if it is invalid (in sb)

 2133  BA FFFF				mov	dx,0FFFFh
 2136  39 16 3CEC R			cmp	word ptr [systm.sb_FirstFreeBlk],dx ; 0FFFFh
 213A  75 09				jne	short @f
 213C  39 16 3CEE R			cmp	word ptr [systm.sb_FirstFreeBlk+2],dx ; 0FFFFh	
 2140  75 03				jne	short @f
 2142				sync_16:
 2142  E8 0089				call	set_firstfreeblock
 2145				@@:
 2145  33 D2				xor	dx,dx
 2147  B8 0001				mov	ax,1 ; Super block address (in 71h/RUNIX partition)
 214A  BB 3CB0 R			mov	bx,offset systm 
 214D  E8 FB76				call	dskwr
					;jc	sync_18
 2150  73 03				jnc	short @f
 2152  E9 FEF8				jmp	sync_18
 2155				@@:
 2155  C6 06 3A59 R 00			mov	byte ptr [smod],0 ; reset
 215A				sync_17:
					; 05/01/2020
 215A  33 C0				xor	ax,ax
 215C  F6 06 3A58 R FF			test 	byte ptr [bmod], 0FFh ; boot sector modified ?
 2161  74 0D				jz	short sync_21
 2163  33 D2				xor	dx,dx
					;xor	ax,ax ; Boot sector/block address (in 71h/RUNIX partition)
 2165  BB 3AB0 R			mov	bx,offset BSBUFFER
 2168  E8 FB5B				call	dskwr
 216B  72 03				jc	short sync_21
 216D  A2 3A58 R			mov	byte ptr [bmod],al ; 0 ; reset
 2170				sync_21:
					;xor	ax,ax
 2170  C3				retn

 2171				sync	endp

 2171				set_firstfreeinode proc near
					; 17/01/2020
					; 01/01/2020 - (set first free inode for 71h hard disk partition)
					; 29/09/2019 - Retro UNIX 386 v2
					; set first free inode number in sb
					; Output:
					;   cf = 0 -> calculated
					;   cf = 1 = can not be calculated 

 2171  33 ED				xor	bp,bp
 2173  89 2E 3A84 R			mov	word ptr [im_sector],bp ; 0

 2177  8B 0E 3CC4 R			mov	cx,word ptr [systm.sb_InodeCount] ; <= 65534
 217B  89 0E 3A7C R			mov	word ptr [count],cx
 217F  A1 3CD0 R			mov	ax,word ptr [systm.sb_InodeMapAddr]
 2182  8B 16 3CD2 R			mov	dx,word ptr [systm.sb_InodeMapAddr+2]
 2186				sffi_1:
 2186  BB 46B0 R			mov	bx,offset im_buffer
 2189  A3 3A70 R			mov	word ptr [save_ax],ax
 218C  89 16 3A72 R			mov	word ptr [save_dx],dx
 2190  E8 FB3A				call	dskrd
 2193  72 14				jc	short sffi_4
 2195				sffi_2:
 2195  B9 0008				mov	cx,8
 2198  8A 07				mov	al,byte ptr [bx] ; 02/01/2020
 219A				sffi_3:
 219A  45				inc	bp
 219B  D0 E8				shr	al,1	; 02/01/2020
 219D  72 0B				jc	short sffi_5 ; allocated inode
 219F  89 2E 3CE4 R			mov	word ptr [systm.sb_FirstFreeIno],bp ; first free inode
					; 17/01/2020
 21A3  C7 06 3CE6 R 0000		mov	word ptr [systm.sb_FirstFreeIno+2],0 ; 0FFFFh -> 0
 21A9				sffi_4:
 21A9  C3				retn
 21AA				sffi_5:
 21AA  FF 0E 3A7C R			dec	word ptr [count]
 21AE  74 F9				jz	short sffi_4
 21B0  E2 E8				loop	sffi_3
 21B2  81 FB 48AF R			cmp	bx,offset im_buffer+511
 21B6  73 03				jnb	short sffi_6
 21B8  43				inc	bx
 21B9  EB DA				jmp	short sffi_2
 21BB				sffi_6: 
 21BB  FF 06 3A84 R			inc	word ptr [im_sector]
 21BF  A1 3A70 R			mov	ax,word ptr [save_ax]
 21C2  8B 16 3A72 R			mov	dx,word ptr [save_dx]
 21C6  83 C0 01				add	ax,1
 21C9  83 D2 00				adc	dx,0
 21CC  EB B8				jmp	short sffi_1

 21CE				set_firstfreeinode endp

 21CE				set_firstfreeblock proc near
					; 02/01/2020
					; 01/01/2020 - (set first free block for 71h hard disk partition)
					; 29/09/2019 - Retro UNIX 386 v2
					; set first free block number in sb
					; Output:
					;   cf = 0 -> calculated
					;   cf = 1 = can not be calculated 

 21CE  A1 3CB8 R			mov	ax,word ptr [systm.sb_VolumeSize]
 21D1  8B 16 3CBA R			mov	dx,word ptr [systm.sb_VolumeSize+2]	
 21D5  A3 3A7C R			mov	word ptr [count],ax
 21D8  89 16 3A7E R			mov	word ptr [count+2],dx

 21DC  A1 3CC8 R			mov	ax,word ptr [systm.sb_FreeMapAddr]
 21DF  8B 16 3CCA R			mov	dx,word ptr [systm.sb_FreeMapAddr+2]
 21E3  33 F6				xor	si,si
 21E5  33 FF				xor	di,di
 21E7  89 36 3A80 R			mov	word ptr [fm_sector],si ; 0
 21EB  89 3E 3A82 R			mov	word ptr [fm_sector+2],di

 21EF  4E				dec	si ; 0FFFFh
 21F0  4F				dec	di ; 0FFFFh
 21F1				sffb_1:
 21F1  BB 48B0 R			mov	bx,offset fbm_buffer
 21F4  A3 3A70 R			mov	word ptr [save_ax],ax
 21F7  89 16 3A72 R			mov	word ptr [save_dx],dx
 21FB  E8 FACF				call	dskrd
 21FE  72 19				jc	short sffb_5
 2200				sffb_2:
 2200  B9 0008				mov	cx,8
 2203  8A 07				mov	al,byte ptr [bx]
 2205				sffb_3:	 	
 2205  83 C6 01				add	si,1
 2208  73 03				jnc	short sffb_4
 220A  83 D7 00				adc	di,0
 220D				sffb_4:	
 220D  D0 E8				shr	al,1
 220F  73 09				jnc	short sffb_6 ; allocated block/sector
					; free block/sector
 2211  89 36 3CEC R			mov	word ptr [systm.sb_FirstFreeBlk],si
 2215  89 3E 3CEE R			mov	word ptr [systm.sb_FirstFreeBlk+2],di	
 2219				sffb_5:
 2219  C3				retn
 221A				sffb_6:
 221A  83 2E 3A7C R 01			sub	word ptr [count],1
 221F  77 12				ja	short sffb_8
 2221  74 07				jz	short sffb_7

 2223  83 1E 3A7E R 00			sbb	word ptr [count+2],0
 2228  EB 09				jmp	short sffb_8
 222A				sffb_7:	
 222A  83 3E 3A7E R 00			cmp	word ptr [count+2],0
 222F  77 02				ja	short sffb_8
 2231  F9				stc
 2232  C3				retn
 2233				sffb_8:
 2233  E2 D0				loop	sffb_3
 2235  81 FB 4AAF R			cmp	bx,offset fbm_buffer+511
 2239  73 03				jnb	short sffb_9
 223B  43				inc	bx
 223C  EB C2				jmp	short sffb_2
 223E				sffb_9: 
 223E  83 06 3A80 R 01			add	word ptr [fm_sector],1
 2243  83 16 3A82 R 00			adc	word ptr [fm_sector+2],0	
 2248  A1 3A70 R			mov	ax,word ptr [save_ax]
 224B  8B 16 3A72 R			mov	dx,word ptr [save_dx]
 224F  83 C0 01				add	ax,1
 2252  83 D2 00				adc	dx,0
 2255  EB 9A				jmp	short sffb_1

 2257				set_firstfreeblock endp

 2257				find_bfn proc near
					; 15/01/2020
					; 29/12/2019
					; 18/09/2019 - Retro UNIX 386 v2 (modified unix v7 inodes)
					;
					; 04/12/2015 (14 byte file names)
					; 26/11/2012
					; 25/11/2012
					;
					; find boot file name by i-number (ax)
					;
					; cf -> 1 means error, ax = 0 -> not found

 2257  A3 3038 R			mov	word ptr [uf_i_number], ax
 225A  56				push	si

					;mov	ax, ROOT_DIR_INODE_NUMBER ; 41 (unix v1), 1 (runix v2)
					; 26/12/2019
 225B  BB 0001				mov	bx, ROOT_DIR_INODE_NUMBER
 225E  E8 F38B				call	iget
 2261  72 30				jc	short loc_find_bfn_retn

					;test	word ptr [inode_flgs], 4000h ; directory i-node ?
					;jnz	short @f

					;mov	ah, 0FFh ; error number
					;stc
					;jmp	short loc_find_bfn_retn
				;;@@:
 2263  33 C0				xor	ax, ax 
 2265  A3 3A4C R			mov	word ptr [u_off], ax ; u_off is file offset used by user
					; 15/01/2020
 2268  A3 3A4E R			mov	word ptr [u_off+2], ax ; 29/12/2019 

 226B				loc_find_bfn_1:
 226B  C7 06 3A52 R 3086 R		mov	word ptr [u_base], offset u_dirbuf
						  ; u.dirbuff holds a file name copied from
						  ; a directory	
 2271  C7 06 3A50 R 0010		mov	word ptr [u_count], 16 ; 04/12/2015 (10 -> 16) 	
				 	
					;mov	ax, ROOT_DIR_INODE_NUMBER ; = 1 ; 18/09/2019
					; 26/12/2019
 2277  BB 0001				mov	bx, ROOT_DIR_INODE_NUMBER 

 227A  E8 F2CB				call	readi ; read 16 bytes of file with i-number
						; i.e. read a directory entry
 227D  72 14				jc	short loc_find_bfn_retn

 227F  A1 3A54 R			mov	ax, word ptr [u_nread]

 2282  0B C0				or	ax, ax
 2284  74 0F				jz	short loc_find_bfn_2 ; gives error return 

					; 29/12/2019
					;mov	ax, word ptr [u_dirbuf]
 2286  8B 1E 3086 R			mov	bx, word ptr [u_dirbuf]

					;cmp	ax, word ptr [uf_i_number] ; Check i-number of directory entry
 228A  3B 1E 3038 R			cmp	bx, word ptr [uf_i_number]
 228E  75 DB				jne	short loc_find_bfn_1	; if same with specified uf_i_number
									; it is the boot file 
 2290				loc_find_bfn_3:
					; 29/12/2019
					; 26/12/2019
					;mov	bx, ax
 2290  E8 F359				call	iget
 2293				loc_find_bfn_retn:
 2293  5E				pop	si
 2294  C3				retn

 2295				loc_find_bfn_2:
 2295  F9				stc
 2296  EB FB				jmp	short loc_find_bfn_retn
					
 2298				find_bfn endp

 2298				proc_display_startupfile_info proc near
					; 24/09/2019 - Retro UNIX 386 v2 (modified Unix v7 inode format)
					; 30/11/2012	
					; 29/11/2012 ; @@
					; 25/11/2012
				              
 2298  BE 2E9E R		 	mov	si, offset Msg_StartupFile_Name
 229B  E8 E246				call	PRINT_MSG

 229E  BE 3025 R			mov	si, offset Boot_File_Name
 22A1  E8 E240				call	PRINT_MSG

 22A4  BE 30BA R			mov	si, offset Str_Inode_Number
 22A7  E8 E23A				call	PRINT_MSG

 22AA  BE 3AB0 R			mov	si, offset BSBuffer
 22AD  8B 44 12				mov	ax, word ptr [SI]+bs_BF_I_number

 22B0  BE 30D4 R			mov	si, offset Decimal_i_no_str
 22B3  B9 0005				mov	cx, 5
 22B6  E8 0122				call	proc_bin_to_decimal

 22B9  BE 30D4 R			mov	si, offset Decimal_i_no_str 

 22BC  B9 0004				mov	cx, 4
 22BF				@@:
 22BF  80 3C 30				cmp	byte ptr [si], '0'
 22C2  77 03				ja	short @f
 22C4  46				inc	si
 22C5  E2 F8				loop	@b 
 22C7				@@:
 22C7  E8 E21A				call	PRINT_MSG

 22CA  BE 30DA R			mov	si, offset Str_startup_file_size
 22CD  E8 E214				call	PRINT_MSG

 22D0  A1 3044 R			mov	ax, word ptr [Inode_size]
 22D3  BE 30F8 R			mov	si, offset Decimal_size_str
					;mov	cx, 5
 22D6  B1 05				mov	cl, 5
 22D8  E8 0100				call	proc_bin_to_decimal

 22DB  BE 30F8 R			mov	si, offset Decimal_size_str

 22DE  B1 04				mov	cl, 4
 22E0				@@:
 22E0  80 3C 30				cmp	byte ptr [si], '0'
 22E3  77 03				ja	short @f
 22E5  46				inc	si
 22E6  E2 F8				loop	@b 
 22E8				@@:
 22E8  E8 E1F9				call	PRINT_MSG

 22EB  BE 30F1 R			mov	si, offset Str_Bytes
 22EE  E8 E1F3				call	PRINT_MSG

					; 24/09/2019
					
 22F1  A1 3070 R			mov	ax, word ptr [Inode_atim]
 22F4  8B 16 3072 R			mov	dx, word ptr [Inode_atim]+2

 22F8  E8 FC10				call	convert_from_epoch
					
 22FB  A1 3096 R			mov	ax, word ptr [year]
 22FE  BE 3180 R			mov	si, offset str_ayear
					;mov	cx, 4
 2301  B1 04				mov	cl, 4
 2303  E8 00D5				call	proc_bin_to_decimal
					
 2306  A1 3098 R			mov	ax, word ptr [month]
 2309  BE 317D R			mov	si, offset str_amonth
 230C  B1 02				mov	cl, 2
 230E  E8 00CA				call	proc_bin_to_decimal

 2311  A1 309A R			mov	ax, word ptr [day]
 2314  BE 317A R			mov	si, offset str_aday
 2317  B1 02				mov	cl, 2
 2319  E8 00BF				call	proc_bin_to_decimal

 231C  A1 309C R			mov	ax, word ptr [hour]
 231F  BE 3186 R			mov	si, offset str_ahour
 2322  B1 02				mov	cl, 2
 2324  E8 00B4				call	proc_bin_to_decimal

 2327  A1 309E R			mov	ax, word ptr [minute]
 232A  BE 3189 R			mov	si, offset str_aminute
 232D  B1 02				mov	cl, 2
 232F  E8 00A9				call	proc_bin_to_decimal

 2332  A1 30A0 R			mov	ax, word ptr [second]
 2335  BE 318C R			mov	si, offset str_asecond
 2338  B1 02				mov	cl, 2
 233A  E8 009E				call	proc_bin_to_decimal

 233D  A1 3074 R			mov	ax, word ptr [Inode_mtim]
 2340  8B 16 3076 R			mov	dx, word ptr [Inode_mtim]+2

 2344  E8 FBC4				call	convert_from_epoch
					
 2347  A1 3096 R			mov	ax, word ptr [year]
 234A  BE 3150 R			mov	si, offset str_myear
					;mov	cx, 4
 234D  B1 04				mov	cl, 4
 234F  E8 0089				call	proc_bin_to_decimal
					
 2352  A1 3098 R			mov	ax, word ptr [month]
 2355  BE 314D R			mov	si, offset str_mmonth
 2358  B1 02				mov	cl, 2
 235A  E8 007E				call	proc_bin_to_decimal

 235D  A1 309A R			mov	ax, word ptr [day]
 2360  BE 314A R			mov	si, offset str_mday
 2363  B1 02				mov	cl, 2
 2365  E8 0073				call	proc_bin_to_decimal

 2368  A1 309C R			mov	ax, word ptr [hour]
 236B  BE 3156 R			mov	si, offset str_mhour
 236E  B1 02				mov	cl, 2
 2370  E8 0068				call	proc_bin_to_decimal

 2373  A1 309E R			mov	ax, word ptr [minute]
 2376  BE 3159 R			mov	si, offset str_mminute
 2379  B1 02				mov	cl, 2
 237B  E8 005D				call	proc_bin_to_decimal

 237E  A1 30A0 R			mov	ax, word ptr [second]
 2381  BE 315C R			mov	si, offset str_msecond
 2384  B1 02				mov	cl, 2
 2386  E8 0052				call	proc_bin_to_decimal

					; 30/11/2012
					
 2389  A1 3078 R			mov	ax, word ptr [Inode_ctim]
 238C  8B 16 307A R			mov	dx, word ptr [Inode_ctim]+2

 2390  E8 FB78				call	convert_from_epoch
					
 2393  A1 3096 R			mov	ax, word ptr [year]
 2396  BE 3120 R			mov	si, offset str_cyear
					;mov	cx, 4
 2399  B1 04				mov	cl, 4
 239B  E8 003D				call	proc_bin_to_decimal
					
 239E  A1 3098 R			mov	ax, word ptr [month]
 23A1  BE 311D R			mov	si, offset str_cmonth
 23A4  B1 02				mov	cl, 2
 23A6  E8 0032				call	proc_bin_to_decimal

 23A9  A1 309A R			mov	ax, word ptr [day]
 23AC  BE 311A R			mov	si, offset str_cday
 23AF  B1 02				mov	cl, 2
 23B1  E8 0027				call	proc_bin_to_decimal

 23B4  A1 309C R			mov	ax, word ptr [hour]
 23B7  BE 3126 R			mov	si, offset str_chour
 23BA  B1 02				mov	cl, 2
 23BC  E8 001C				call	proc_bin_to_decimal

 23BF  A1 309E R			mov	ax, word ptr [minute]
 23C2  BE 3129 R			mov	si, offset str_cminute
 23C5  B1 02				mov	cl, 2
 23C7  E8 0011				call	proc_bin_to_decimal

 23CA  A1 30A0 R			mov	ax, word ptr [second]
 23CD  BE 312C R			mov	si, offset str_csecond
 23D0  B1 02				mov	cl, 2
 23D2  E8 0006				call	proc_bin_to_decimal

 23D5  BE 30FE R			mov	si, offset Str_SF_date_Time
					;call	PRINT_MSG
					;retn
					; 22/01/2020
 23D8  E9 E109				jmp	PRINT_MSG	  

 23DB				proc_display_startupfile_info endp

 23DB				proc_bin_to_decimal proc near
					; 30/11/2012 (CX input)	
					; 25/11/2012 unixboot.asm version	
					; 6-5-2009
					;  Erdogan Tan
					; INPUT: DS:SI = Target location
					;        AX = Binary Number
					;        CX = Number of digits	
					; OUTPUT: Decimal chars at DS:SI
					; CX, AX, DX will be changed.

					;push	bp
					;push	si
 23DB				loc_reset_str_NumberInput:
 23DB  C6 04 30				mov	byte ptr [si], "0"
 23DE  46				inc	si
 23DF  E2 FA				loop	loc_reset_str_NumberInput
 23E1  8B EC				mov	bp, sp
 23E3  33 D2				xor	dx, dx
 23E5  B9 000A				mov	cx, 10
 23E8				loc_rediv_NumberInput:
 23E8  F7 F1				div	cx
 23EA  80 C2 30				add	dl,'0'
 23ED  52				push	dx
 23EE  33 D2				xor	dx, dx
 23F0  4E				dec	si
 23F1  0B C0				or	ax, ax
 23F3  75 F3				jnz	short loc_rediv_NumberInput
 23F5				loop_popcx_NumberInput: 
 23F5  5A				pop	dx
 23F6  88 14				mov	byte ptr [si], dl
 23F8  46				inc	si
 23F9  3B EC				cmp	bp, sp
 23FB  75 F8				jne	short loop_popcx_NumberInput
					;pop	si
					;pop	bp  
				 
 23FD  C3				retn

 23FE				proc_bin_to_decimal endp

 23FE				imap	proc near
					; 22/01/2020
					; 03/01/2020
					; 02/01/2020 - Retro UNIX 386 v2 Hard Disk FS
					;	       (71h, Hard Disk Partitions)
					; 25/09/2019
					; 18/09/2019 - Retro UNIX 386 v2 (modified unix v7 inodes)
					; 	(only for floppy disks, without 'hidden sectors')  
				        ; 02/12/2012
				        ; unix boot file configuration version
					; of "imap" procedure of retro unix v1.0 by Erdogan Tan
					; Derived from (original) UNIX v1 source code
					; PRELIMINARY release of Unix Implementation Document, 
					; 20/6/1972 
					; ('imap' procedure)

					; get the byte that the allocation bit 
					; for the i-number contained in R1

					; INPUT: 
					;	ax = inode number
					;	(im_buffer)
					; OUTPUT:
					;	bx = address of the byte contains allocation bit
					;	dx has 1 at calculated bit position

					; 03/01/2020
					; Modified registers: bx, cx, dx, (si, di)
					
					; 02/01/2020
 23FE  50				push	ax ; *

					; 18/09/2019
 23FF  3B 06 3CC4 R			cmp	ax,word ptr [systm.sb_InodeCount]
 2403  76 03				jna	short @f
					; Temporary (set inode number to the last inode)
 2405  A1 3CC4 R			mov	ax,word ptr [systm.sb_InodeCount]
 2408				@@:
					; 02/01/2020
 2408  48				dec	ax ; zero based inode number

 2409  50				push	ax ; **

					; 11/11/2012 (maknod_imap location -> imap procedure)
				      	;sub	ax,41  ; AX has i-41
					; 02/09/2019 - Retro UNIX 386 v2
					;dec	ax ; zero based inode number

					; 02/01/2020
 240A  D1 E8				shr	ax,1
 240C  D1 E8				shr	ax,1
 240E  D1 E8				shr	ax,1 ; AX has byte offset of zero based inode number
					     ; from the start of the (inode) map

 2410  8A DC				mov	bl,ah ; <= 31
 2412  D0 EB				shr	bl,1 ; inode map sector (index/offset) number (<= 15)	
 2414  32 FF				xor	bh,bh

 2416  25 01FF				and	ax,511 ; now AX points to byte offset in im_buffer

					; 02/01/2020
 2419  3B 1E 3A84 R			cmp	bx,word ptr [im_sector]
 241D  74 41				je	short imap_3 ; current inode map sector is same sector

 241F  53				push	bx ; *** new inode map sector
 2420  50				push	ax ; **** byte offset in inode map sector buffer
 2421  53				push	bx ; ***** new inode map sector

 2422  BB 46B0 R			mov	bx,offset im_buffer	

 2425  F6 06 3A59 R 02			test	byte ptr [smod],2 ; inode map modified 
 242A  74 1E				jz	short imap_2 ; read inode map sector

 242C  A1 3CD0 R			mov	ax,word ptr [systm.sb_InodeMapAddr]
 242F  8B 16 3CD2 R			mov	dx,word ptr [systm.sb_InodeMapAddr+2]
 2433  03 06 3A84 R			add	ax,word ptr [im_sector]
 2437  83 D2 00				adc	dx,0
 243A  E8 F889				call	dskwr
 243D  73 06				jnc	short imap_1
 243F  5B				pop	bx ; *****
 2440  5A				pop	dx ; ****
 2441  5B				pop	bx ; ***
 2442				imap_0:
 2442  58				pop	ax ; **
 2443  58				pop	ax ; *
 2444  C3				retn
 2445				imap_1:
 2445  80 26 3A59 R FD			and	byte ptr [smod],0FDh ; reset bit 1
 244A				imap_2:
					; 02/01/2020
 244A  58				pop	ax ; *****
 244B  2B D2				sub	dx,dx
 244D  03 06 3CD0 R			add	ax,word ptr [systm.sb_InodeMapAddr]
 2451  13 16 3CD2 R			adc	dx,word ptr [systm.sb_InodeMapAddr+2]
 2455  E8 F875				call	dskrd
 2458  58				pop	ax ; **** byte offset
 2459  5B				pop	bx ; *** sector
 245A  72 E6				jc	short imap_0
 245C  89 1E 3A84 R			mov	word ptr [im_sector],bx ; ***
 2460				imap_3:
					; ax = byte offset in inode map sector buffer
					; bx = inode map sector (index/offset)
					
 2460  59				pop	cx ; ** ; inode number - 1 ; R3
					   
 2461  BA 0001				mov	dx,1
 2464  80 E1 07				and	cl,7    ; CX has (i-41) mod 8 to get the bit position 	 	
 2467  74 02				jz	short imap_4 ; 21/8/2012
				        ;shl	dx,cl   ; DX has 1 in the calculated bit position
					; 22/01/2020
 2469  D2 E2				shl	dl,cl
 246B				imap_4:
					;; 5/8/2012	
					;add	bx,word ptr [systm] ; superblock free map size + 4
					;; 21/8/2012
					;add	bx,offset systm+4 ; is inode map offset in superblock

					; 02/01/2020 - Retro UNIX 386 v2
 246B  BB 46B0 R			mov	bx,offset im_buffer
 246E  03 D8				add	bx,ax ; ****

					; CX (R3) used internally 	
					; DX (MQ) has a 1 in the calculated bit position
					; BX (R2) has byte address of the byte with allocation bit
 2470				imap_5:
 2470  58				pop	ax ; *
 2471  C3				retn

 2472				imap	endp

				; UNIX v7, x86 - iget.c (Robert Nordier, 1999)

 2472				itrunc proc near
					; 17/01/2020
					; 11/01/2020 - Retro UNIX 386 v2 hard disk FS
					; 26/12/2019
					; 30/09/2019
					; 18/09/2019
					; 17/09/2019 - Retro UNIX v2
					; * Free all the disk blocks associated
					; * with the specified inode structure.
					;
					; (Simplified for Retro UNIX v2 bootable floppy disk...)
					; (< 32MB disks)

					; INPUT: 
					;	AX = inode number
					; OUTPUT: 
					;	inode will be modified (file size = 0)

					; 26/12/2019
 2472  8B D8				mov	bx,ax

					; 30/09/2019
 2474  E8 F175				call	iget ; jsr r0,iget
 2477  72 0A				jc	short itrunc_9 ; 30/09/2019

 2479  F6 06 303D R 80			test	byte ptr [inode_flgs+1],80h ; regular file or directory	
 247E  75 04				jnz	short itrunc_1
 2480				itrunc_0:
 2480  B8 FFFF				mov	ax,0FFFFh
 2483				itrunc_9:
 2483  C3				retn
 2484				itrunc_1:
 2484  F6 06 303D R 10			test	byte ptr [inode_flgs+1],10h ; large file (indirect blocks)
 2489  75 32				jnz	short itrunc_4
 248B  BE 3048 R			mov	si,offset inode_dskp
 248E				itrunc_2:
 248E  AD				lodsw
					;and	ax,ax
					;jz	short itrunc_3
					; 11/01/2020
 248F  8B D0				mov	dx,ax
 2491  AD				lodsw	
 2492  23 C0				and	ax,ax
 2494  75 04				jnz	short @f
 2496  0B D2				or	dx,dx
 2498  74 14				jz	short itrunc_3
 249A				@@:
 249A  92				xchg	ax,dx ; 17/01/2020	
 249B  E8 F59F				call	free
					; 30/09/2019
 249E  33 C0				xor	ax,ax
 24A0  33 D2				xor	dx,dx ; 11/01/2020
 24A2  89 44 FE				mov	word ptr [si-2],ax ; 0
					; 11/01/2020
 24A5  89 54 FC				mov	word ptr [si-4],dx ; 0
					; 11/01/2020
					;inc	si
					;inc	si
 24A8  81 FE 3070 R			cmp	si,offset inode_dskp+40
 24AC  72 E0				jb	short itrunc_2
 24AE				itrunc_3:
					;xor	ax,ax
					;xor	dx,dx
 24AE  A3 3044 R			mov	word ptr [inode_size],ax ; 0
					; 11/01/2020
 24B1  89 16 3046 R			mov	word ptr [inode_size+2],dx ; 0
					
					; 30/09/2019
					; Clear inode block addresses
					;mov	cx,20
					;mov	di,offset inode_dskp
					;rep	stosw

					; 30/09/2019
					; clear large file flag
 24B5  80 26 303D R EF			and	byte ptr [inode_flgs+1],0EFh ; 11101111b ;  not 10h
					
					;call	setimod
					;retn
 24BA  E9 F640				jmp	setimod

 24BD				itrunc_4:
					; free disk blocks by using triple indirect blocks at first
					;mov	ax,word ptr [inode_dskp+36]
					; 30/09/2019
 24BD  BE 306C R			mov	si,offset inode_dskp+36
 24C0  8B 04				mov	ax,word ptr [si]
					; 11/01/2020
 24C2  8B 54 02				mov	dx,word ptr [si+2]
					;
					;and	ax,ax
					;jz	short itrunc_5 ; pass to double indirect blocks

					; 11/01/2020
 24C5  0B C0				or	ax,ax
 24C7  75 04				jnz	short @f	
 24C9  23 D2				and	dx,dx
 24CB  74 14				jz	short itrunc_5
 24CD				@@:	
 24CD  BB 0002				mov	bx,2 ; Triple indirect sign
 24D0  53				push	bx
 24D1  52				push	dx ; 11/01/2020
 24D2  50				push	ax
 24D3  E8 0062				call	tloop
 24D6  72 A8				jc	short itrunc_0
					; 30/09/2019
 24D8  C7 04 0000			mov	word ptr [si],0
					; 11/01/2020
 24DC  C7 44 02 0000			mov	word ptr [si+2],0 
 24E1				itrunc_5:
					; free disk blocks by using double indirect blocks at second
					;mov	ax,word ptr [inode_dskp+32]
					; 11/01/2020
					;mov	dx,word ptr [inode_dskp+34]
					; 30/09/2019
 24E1  BE 3068 R			mov	si,offset inode_dskp+32
 24E4  8B 04				mov	ax,word ptr [si]	; 11/01/2020
 24E6  8B 54 02				mov	dx,word ptr [si+2]
					; 17/01/2020
					;and	ax,ax
					;jz	short itrunc_6 ; pass to single indirect blocks
					; 11/01/2020
 24E9  0B C0				or	ax,ax 
 24EB  75 04				jnz	short @f
 24ED  23 D2				and	dx,dx
 24EF  74 14				jz	short itrunc_6
 24F1				@@:	
 24F1  BB 0001				mov	bx,1 ; Double indirect sign ; 17/01/2020
 24F4  53				push	bx
 24F5  52				push	dx ; 11/01/2020
 24F6  50				push	ax
 24F7  E8 003E				call	tloop
 24FA  72 84				jc	short itrunc_0
					; 30/09/2019
 24FC  C7 04 0000			mov	word ptr [si],0
					; 11/01/2020
 2500  C7 44 02 0000			mov	word ptr [si+2],0 
 2505				itrunc_6:
					; free disk blocks by using single indirect blocks at third
					;mov	si,offset inode_dskp+28
					; 30/09/2019
					; si = offset inode_dskp+32
					;mov	si,offset inode_dskp+32
 2505				itrunc_7:
 2505  83 EE 04				sub	si,4
 2508  8B 04				mov	ax,word ptr [si]
					; 11/01/2020
 250A  8B 54 02				mov	dx,word ptr [si+2]
 250D  23 C0				and	ax,ax
					;jz	short itrunc_8 ; skip
 250F  75 04				jnz	short @f
 2511  0B D2				or	dx,dx
 2513  74 16				jz	short itrunc_8
 2515				@@:
 2515  2B DB				sub	bx,bx ; 0  ; Single indirect sign
 2517  53				push	bx
 2518  52				push	dx ; 11/01/2020
 2519  50				push	ax
 251A  E8 001B				call	tloop
					;jc	short itrunc_0
					; 11/01/2020
 251D  73 03				jnc	short @f
 251F  E9 FF5E				jmp	itrunc_0
 2522				@@:
					; 30/09/2019
 2522  C7 04 0000			mov	word ptr [si],0
					; 11/01/2020
 2526  C7 44 02 0000			mov	word ptr [si+2],0
 252B				itrunc_8:
					;sub	si,4	
 252B  81 FE 3048 R			cmp	si,offset inode_dskp
					;jnb	short itrunc_7
 252F  77 D4				ja	short itrunc_7
					;xor	ax,ax
					; 11/01/2020
 2531  2B C0				sub	ax,ax ; 0
 2533  2B D2				sub	dx,dx ; 0
 2535  E9 FF76				jmp	itrunc_3
					
 2538				itrunc endp

 2538				tloop proc near
					; 23/03/2022
					; 17/01/2020
					; 11/01/2020 - Retro UNIX 386 v2 hard disk FS
					; 24/12/2019
					; 30/09/2019
					; 18/09/2019 - Retro UNIX v2
					; * Free all the disk blocks associated
					; * with the specified inode structure.
					;
					; (Simplified for Retro UNIX v2 bootable floppy disk...)

					; INPUT: 
					;	 sp+2 = ax, indirect block number (sector address)
					;	 sp+4 = dx, high word of indirect block number 
					;	 sp+6 = bx, levels 
					;	 (0 = indirect, 1 = double indr. 2 = triple indr.) 	
					
					; OUTPUT: indirect blocks will be released

 2538  59				pop	cx ; return address

 2539  58				pop	ax ; +++ indirect block number, lw 
 253A  5A				pop	dx ; ++ indirect block number, hw ; 11/01/2020	
 253B  5B				pop	bx ; + levels  ; 0 = single, 1 = double, 2 = triple 

 253C  51				push	cx ; near call	return address

 253D  57				push	di ; 30/09/2019
 253E  56				push	si ; 30/09/2019

					; 11/01/2020
 253F  52				push	dx ; **
 2540  50				push	ax ; *

					;call	bread
 2541  53				push	bx ; 30/09/2019
 2542  BB 44B0 R			mov	bx,offset WriteBuffer ; 24/12/2019
 2545  E8 F785				call	dskrd
 2548  5B				pop	bx ; 30/09/2019
 2549  72 3A				jc	short tloop_7
					; 11/01/2020
					; dx:ax = block/sector number/address
 254B  BE 44B0 R			mov	si,offset WriteBuffer ; 24/09/2019
 254E  83 FB 01				cmp	bx,1
 2551  72 37				jb	short tloop_4
 2553  74 05				je	short tloop_1
 2555  BF 4CB0 R			mov	di,offset trpi_buffer
 2558  EB 03				jmp	short tloop_2
 255A				tloop_1:
 255A  BF 4AB0 R			mov	di,offset dbli_buffer
 255D				tloop_2:	
 255D  B9 0100			 	mov	cx,256
					; 23/03/2022
					;push	di
 2560  F3/ A5				rep	movsw
 2562  B1 80				mov	cl,128
					;pop	si
 2564  4B				dec	bx ; 2 -> 1, 1 -> 0
					; 17/01/2020
 2565				tloop_3:
 2565  83 EF 04				sub	di,4
					;push	di
					;push	si
					;push	bx
					;push	cx	

 2568  8B 05				mov	ax,word ptr [di]
 256A  8B 55 02				mov	dx,word ptr [di+2] ; 11/01/2020

					; 17/01/2020
 256D  0B C0				or	ax,ax
					;jz	short tloop_10
 256F  75 04				jnz	short @f
 2571  23 D2				and	dx,dx
 2573  74 0C				jz	short tloop_10
 2575				@@:
					; 17/01/2020
 2575  53				push	bx
 2576  51				push	cx

 2577  53				push	bx ;+
 2578  52				push	dx ;++ ; 11/01/2020
 2579  50				push	ax ;+++
 257A  E8 FFBB				call	tloop
 257D  59				pop	cx
 257E  5B				pop	bx
					;pop	si
					;pop	di
 257F  72 04				jc	short tloop_7
 2581				tloop_10:
 2581  E2 E2				loop	tloop_3

					; 17/01/2020
 2583  EB 23				jmp	short tloop_9

					; 17/01/2020
 2585				tloop_7:
					; 11/01/2020
 2585  58				pop	ax ; *
 2586  5A				pop	dx ; **
 2587				tloop_8:
 2587  5E				pop	si ; 30/09/2019
 2588  5F				pop	di ; 30/09/2019
 2589  C3				retn
					
					; free blocks in current indirect block
 258A				tloop_4:
 258A  B9 0080				mov	cx,128
 258D  81 C6 01FC			add	si,508 ; 30/09/2019
 2591				tloop_5:
 2591  8B 04				mov	ax,word ptr [si]
					; 11/01/2020
 2593  8B 54 02				mov	dx,word ptr [si+2]  
 2596  0B C0				or	ax,ax
					;jz	short tloop_6
 2598  75 04				jnz	short @f
 259A  23 D2				and	dx,dx
 259C  74 05				jz	short tloop_6
 259E				@@:
 259E  51				push	cx ; 30/09/2019
 259F  E8 F49B				call	free
 25A2  59				pop	cx ; 30/09/2019
 25A3				tloop_6:
 25A3  83 EE 04				sub	si,4
 25A6  E2 E9				loop	tloop_5

					; 17/01/2020
 25A8				tloop_9:
					; 11/01/2020
 25A8  58				pop	ax ; * ; free indirect block's itself
 25A9  5A				pop	dx ; **
 25AA  E8 F490				call	free
 25AD  EB D8				jmp	short tloop_8 ; 11/01/2020

				;tloop_7:
				;	; 11/01/2020
				;	pop	ax ; *
				;	pop	dx ; **
				;tloop_8:
				;	pop	si ; 30/09/2019
				;	pop	di ; 30/09/2019
				;	retn

 25AF				tloop endp

 25AF				chmode  proc near
					; 02/10/2019
					; 01/10/2019
					; 10/09/2019 - Retro UNIX 386 v2
					; 13/01/2013
					; 'change mode' procedure
					; Format: chmod <octal number> <unix file name>
					;
					; output -> cf=1 -> error
					; 	 -> cf=0 -> word ptr [arg] > 0 -> mode (string, 2 chars)
					;	    word ptr [arg] = 0 -> ignored (none is done)	
				        
 25AF  33 C0				xor	ax, ax
 25B1  BF 2C9A R			mov	di, offset arg
 25B4  89 05				mov	word ptr [di], ax ; 0  ; reset
 25B6  88 45 02				mov	byte ptr [di+2], al ; 0 ; 01/10/2019
 25B9  33 D2				xor	dx, dx ; 0
 25BB				chmode_1:
 25BB  AC				lodsb
 25BC  3C 30				cmp	al, '0'
 25BE  72 13				jb	short chmode_3
 25C0  3C 37				cmp	al, '7'
 25C2  77 0C				ja	short chmode_stc_retn

					; 02/10/2019
 25C4  2C 30				sub	al,'0'
 25C6  AA				stosb	
 25C7  FE C2				inc	dl
 25C9  80 FA 03				cmp	dl, 3
 25CC  73 04				jnb	short chmode_2 ; 01/10/2019
 25CE  EB EB				jmp	short chmode_1

 25D0				chmode_stc_retn:
 25D0  F5				cmc
 25D1				chmode_retn:
 25D1  C3				retn

 25D2				chmode_2:
					; 01/10/2019
 25D2  AC				lodsb
 25D3				chmode_3:
 25D3  0A D2				or	dl, dl
 25D5  74 F9				jz	short chmode_stc_retn ; zero access rights or invalid !
 25D7  3C 20				cmp	al, 20h
 25D9  75 F5				jne	short chmode_stc_retn ; there is not a file name argument!
 25DB				chmode_4:
 25DB  38 04				cmp	byte ptr [si], al ; 20h
					; no error if the 4th character is a space
 25DD  77 05				ja	short chmode_5
 25DF  72 EF				jb	short chmode_stc_retn ; there is not a file name argument!
 25E1  46				inc	si
 25E2  EB F7				jmp	short chmode_4 
 25E4				chmode_5:
					; 02/10/2019
 25E4  B8 3030				mov	ax, '00'
 25E7  8A D8				mov	bl, al
 25E9  87 06 2C9A R			xchg	ax, word ptr [arg]
 25ED  86 1E 2C9C R			xchg	bl, byte ptr [arg+2]	
					; owner's permissions always must be more than group and others 
 25F1  0A E3				or	ah, bl ; group's permissions must be more than others
 25F3  0A C4			   	or	al, ah
 25F5  01 06 2C9A R			add	word ptr [arg], ax
 25F9  00 1E 2C9C R			add	byte ptr [arg+2], bl
 25FD  8A D0				mov	dl, al
 25FF  D0 E2				shl	dl, 1
 2601  D0 E2				shl	dl, 1
 2603  D0 E2				shl	dl, 1
 2605  0A D4				or	dl, ah
 2607  D0 E2				shl	dl, 1
 2609  D0 E2				shl	dl, 1
 260B  D1 E2				shl	dx, 1
 260D  0A D3				or	dl, bl
 260F  8B EA				mov	bp, dx  		
 2611				chmode_6:
 2611  89 36 3080 R			mov	word ptr [u_namep], si ; 02/10/2019
					;call	namei
 2615  E8 EE85				call	namei_x ; 02/10/2019	
 2618  72 B7				jc	short chmode_retn

					; ax = i-number

					; 29/12/2019
					; bx = inode number

 261A  E8 EFCF				call	iget
 261D  72 B2				jc	short chmode_retn

					; 02/10/2019
 261F  8B C5				mov	ax, bp
					;and	ax, 1FFh

 2621  BB 303C R			mov	bx, offset inode_flgs
					; 01/10/2019
 2624  8B 17				mov	dx, word ptr [bx]
 2626  81 E2 FE00			and	dx, 0FE00h ; clear permission bits

 262A  0B C2				or	ax, dx  ; combine other feature bits with permission bits 
 262C				chmode_7:
 262C  89 07				mov	word ptr [bx], ax
 262E  C6 06 3A5A R 01			mov	byte ptr [imod], 1
					; 19/09/2019
 2633  C6 06 3A5B R 01			mov	byte ptr [imodx], 1 ; 19/09/2019 - Retro UNIX 386 v2
						; (flag means file data is same
						;  but inode's itself is modified)
 2638  EB 97				jmp	short chmode_retn	

 263A				chmode  endp 

 263A				chgroup proc near
					; 10/09/2019 - Retro UNIX 386 v2
					; 'change group' procedure
					; Format: chgrp <decimal number> <unix file name>
					;
					; output -> cf=1 -> error
					; 	 -> cf=0 -> 
					; BX > 0 -> offset arg == group (decimal string, 3 chars)
					;	    BX = 0 -> ignored (none is done)

 263A  C6 06 2641 R 01			mov	byte ptr [chg], 1  ; change group sign ; 1 = change group
 263F  EB 06				jmp	short cg_og

 2641 FF			chg:	db 0FFh ; Change signature/flag

 2642				chgroup endp

 2642				chowner proc near
					; 01/10/2019
					; 10/09/2019 - Retro UNIX 386 v2
					; 13/01/2013
					; 'change owner' procedure
					; Format: chown <decimal number> <unix file name>
					;
					; output -> cf=1 -> error
					; 	 -> cf=0 -> 
					; BX > 0 -> offset arg == owner (decimal string, 3 chars)
					;	    BX = 0 -> ignored (none is done)	

 2642  C6 06 2641 R 00			mov	byte ptr [chg], 0  ; change group sign ; 0 = change owner
 2647				cg_og:
 2647  33 C0				xor	ax, ax
 2649  BF 2C9A R			mov	di, offset arg
 264C  89 05				mov	word ptr [di], ax ; 0
 264E  88 45 02				mov	byte ptr [di+2], al ; 0 ; 01/10/2019
 2651  33 DB				xor	bx, bx
					;mov	cx, 3
 2653  B9 3930				mov	cx, '90'
					;xor	dx, dx
 2656  32 D2				xor	dl, dl
 2658				chowner_1:
 2658  AC				lodsb
 2659  38 C8				cmp	al, cl ; '0'
 265B  72 24				jb	short chowner_5
 265D  38 E8				cmp	al, ch ; '9'
 265F  77 1E				ja	short chowner_stc_retn ; cmc
 2661  FE C2				inc	dl
 2663				chowner_2:
 2663  0A DB				or	bl, bl
 2665  75 06				jnz	short chowner_3

 2667  38 C8				cmp	al, cl ; '0'
 2669  74 ED				je	short chowner_1
 266B  EB 08				jmp	short chowner_4

 266D				chowner_3:
 266D  50				push	ax
 266E  B0 0A				mov	al, 10
 2670  F6 E3				mul	bl
 2672  8B D8				mov	bx, ax
 2674  58				pop	ax
 2675				chowner_4:
 2675  2A C1				sub	al, cl ; '0'
 2677  03 D8				add	bx, ax
 2679  0A FF				or	bh, bh
 267B  74 11				jz	short chowner_7
 267D  33 DB				xor	bx, bx

 267F				chowner_stc_retn:
 267F  F5				cmc
 2680  C3				retn	

 2681				chowner_5:
 2681  22 D2				and	dl, dl
 2683  74 4A				jz	short chowner_retn	
 2685  3C 20				cmp	al, 20h
 2687  74 0A				je	short chowner_8
 2689				chowner_6:
 2689  BB 0000				mov	bx, 0
 268C  EB F1				jmp	short chowner_stc_retn

 268E				chowner_7:
 268E  02 C1				add	al, cl ;'0'
 2690  AA				stosb
 2691  EB C5				jmp	short chowner_1
					;loop	chowner_1
					;cmp	byte ptr [SI], 20h
					;; no error if the 4th character is a carriage return
					;jne	short chowner_6

					;inc	si
 2693				chowner_8:
 2693  89 36 3080 R			mov	word ptr [u_namep], si
 2697  AC				lodsb
 2698  3C 20				cmp	al, 20h
 269A  74 F7				je	short chowner_8
 269C  72 EB				jb	short chowner_6 ; no error (carriage return)

					;mov	byte ptr [u_uid], bl
 269E  53				push	bx
 269F  E8 EDF7				call	namei
 26A2  72 03				jc	short chowner_9

					; ax = i-number

					; 29/12/2019
					; bx = inode number

 26A4  E8 EF45				call	iget

 26A7				chowner_9:
					;pushf
					;mov	bl, byte ptr [u_uid]
					;xor	bh, bh
					;mov	byte ptr [u_uid], bh ; 0
					;popf
 26A7  5B				pop	bx
 26A8  72 25				jc	short chowner_retn

					; 10/09/2019 - Retro UNIX 386 v2
					;mov	byte ptr [inode_uid], bl
 26AA  80 3E 2641 R 00			cmp	byte ptr [chg],0
 26AF  76 06				jna	short chowner_10 ; change user ID
					; change group ID	
 26B1  88 1E 3042 R			mov	byte ptr [inode_gid], bl
 26B5  EB 04				jmp	short chowner_11	
 26B7				chowner_10:
 26B7  88 1E 3040 R			mov	byte ptr [inode_uid], bl
 26BB				chowner_11:	;
 26BB  C6 06 3A5A R 01			mov	byte ptr [imod], 1
					; 19/09/2019
 26C0  C6 06 3A5B R 01			mov	byte ptr [imodx], 1 ; 19/09/2019 - Retro UNIX 386 v2
						; (flag means file data is same
						;  but inode's itself is modified)
 26C5  0A DB				or	bl, bl
 26C7  75 06				jnz	short chowner_retn

 26C9  B7 30				mov	bh, '0'
 26CB  88 3E 2C9A R			mov	byte ptr [arg], bh 

 26CF				chowner_retn:	
 26CF  C3				retn
						
 26D0				chowner endp

 26D0				print_file_size proc near
					; 15/01/2020
 26D0  A1 3044 R			mov	ax, word ptr [inode_size]
 26D3  8B 16 3046 R			mov	dx, word ptr [inode_size+2]
					;mov	cx, 11
 26D7  B1 0B				mov	cl, 11
 26D9  EB 02				jmp	short pdn0

 26DB				print_file_size endp

 26DB				print_decimal_number proc near
					; 15/01/2020
					; 10/01/2020
					; 29/12/2019
					; 03/02/2013
					; 21/01/2013 
					; print decimal number
					;
					; INPUT -> AX = Integer
					; 32/02/2013 CX = Number of decimal digits
					; OUTPUT -> decimal number as string

 26DB  33 D2				xor	dx, dx  ; High word of binary number is zero
 26DD				pdn0:
					; 15/01/2020
					;mov	si, offset dec_num
					;
					;mov	bx, si
					;dec	si ; 29/12/2019
					;add	si, cx ; 03/02/2013
					;mov	di, si
					;;mov	cx, 10
					;mov	cl, 10
					;mov	dl, '0'
				;@@: 
					;mov	byte ptr [bx], dl
					;inc	bx
					;loop	@b
					;
					;xor	dl, dl
					;mov	byte ptr [bx], dl

					; 15/01/2020
					;mov	bx, 10
					;xor	dx, dx
				;pdn_itoa:
					;div	bx
					; 03/02/2013
					;add	byte ptr [si], dl ; 03/02/2013
					;and	dl, dl
					;jnz	short @f
					;;and	al, al
					;; 10/01/2020
					;and	ax, ax
					;jz	short pdn_14
				;@@:	
					;dec	si
					;xor	dl, dl
					;jmp	short pdn_itoa

					; 15/01/2020
 26DD  BE 3193 R			mov	si, offset dec_num
					;
 26E0  8B DE				mov	bx, si
 26E2  4E				dec	si ; 29/12/2019 
 26E3  03 F1				add	si, cx ; 03/02/2013
 26E5  8B FE				mov	di, si
					;mov	cx, 11
 26E7  B1 0B				mov	cl, 11
 26E9  B5 30				mov	ch, '0'
 26EB				@@: 
 26EB  88 2F				mov	byte ptr [bx], ch
 26ED  43				inc	bx
 26EE  FE C9				dec	cl
 26F0  75 F9				jnz	short @b
					
					;xor	ch, ch
					;mov	byte ptr [bx], ch

					; 15/01/2020
 26F2  B9 000A				mov	cx, 10
 26F5  0B D2				or	dx, dx
 26F7  75 11				jnz	short pfn_itoa	
 26F9				pdn_itoa:
 26F9  F7 F1				div	cx
					; 03/02/2013
 26FB  00 14				add	byte ptr [si], dl
 26FD  22 D2				and	dl, dl
 26FF  75 04				jnz	short @f
					;and	al, al
					; 10/01/2020
 2701  23 C0				and	ax, ax
 2703  74 19				jz	short pdn_14 ; *
 2705				@@:	
 2705  4E				dec	si
					;xor	dx, dx
 2706  32 D2				xor	dl, dl
 2708  EB EF				jmp	short pdn_itoa
					
					; 15/01/2020
					;mov	cx, 10
 270A				pfn_itoa:
 270A  E8 F88E				call	div32
 270D  00 1C				add	byte ptr [si], bl
 270F  22 DB				and	bl, bl
 2711  75 08				jnz	short @f
 2713  23 C0				and	ax, ax
 2715  75 04				jnz	short @f
 2717  23 D2				and	dx, dx
 2719  74 03				jz	short pdn_14 ; *
 271B				@@:	
 271B  4E				dec	si
 271C  EB EC				jmp	short pfn_itoa

 271E				pdn_14: ; *
 271E  BE 3193 R			mov	si, offset dec_num
 2721  8B DE				mov	bx, si
 2723				@@:	; leading zeros will not be printed
 2723  8A 07			        mov	al, byte ptr [bx] ; 03/02/2013
 2725  3C 30				cmp	al, '0'
 2727  77 0B				ja	short @f
 2729  3B DF				cmp	bx, di
 272B  73 07				jnb	short @f
 272D  B0 20				mov	al, 20h
 272F  88 07				mov	byte ptr [bx], al 
 2731  43				inc	bx
 2732  EB EF				jmp	short @b

 2734				pddn_putc:
					; 29/12/2019
 2734				@@:
 2734				pdn_putc:
 2734  B4 0E				mov	ah, 0Eh
 2736  BB 0007				mov	bx, 07h
 2739				@@:
 2739  AC				lodsb
					
 273A  CD 10				int	10h

 273C  3B F7				cmp	si, di
 273E  76 F9				jna	short @b

					;mov	al, 20h
					;int	10h
					
 2740  C3				retn 
					
 2741				print_decimal_number endp

 2741				print_big_decimal_number proc near
					; 29/12/2019
					; print big decimal number
					;
					; INPUT -> DX:AX = Integer
					; 	   CX = Number of decimal digits
					; OUTPUT -> decimal number as string
 2741				pddn0:
 2741  BE 3193 R			mov	si, offset dec_num
					;
 2744  8B DE				mov	bx, si
 2746  4E				dec	si ; 29/12/2019 
 2747  03 F1				add	si, cx ; 03/02/2013
 2749  8B FE				mov	di, si
					;mov	cx, 10
 274B  B1 0A				mov	cl, 10
 274D  B5 30				mov	ch, '0'
 274F				@@: 
 274F  88 2F				mov	byte ptr [bx], ch
 2751  43				inc	bx
 2752  FE C9				dec	cl
 2754  75 F9				jnz	short @b
					
					;xor	ch, ch
					;mov	byte ptr [bx], ch

 2756  B9 000A				mov	cx, 10
 2759				pddn_itoa:
 2759  E8 F83F				call	div32
 275C  00 1C				add	byte ptr [si], bl
 275E  22 DB				and	bl, bl
 2760  75 08				jnz	short @f
 2762  23 C0				and	ax, ax
 2764  75 04				jnz	short @f
 2766  23 D2				and	dx, dx
 2768  74 03				jz	short pddn_14 ; *
 276A				@@:	
 276A  4E				dec	si
 276B  EB EC				jmp	short pddn_itoa

 276D				pddn_14: ; *
 276D  BE 3193 R			mov	si, offset dec_num
 2770				@@:	; leading zeros will not be printed
 2770  8A 04			        mov	al, byte ptr [si]
 2772  3C 30				cmp	al, '0'
					;ja	short @f
 2774  77 BE				ja	short pddn_putc
 2776  3B F7				cmp	si, di
					;jnb	short @f
 2778  73 BA				jnb	short pddn_putc
 277A  B0 20				mov	al, 20h
 277C  88 04				mov	byte ptr [si], al 
 277E  46				inc	si
 277F  EB EF				jmp	short @b
				;@@:
				;pddn_putc:
				;	mov	ah, 0Eh
				;	mov	bx, 07h
				;@@:
				;	lodsb
				;
				;	int	10h
				;
				;	cmp	si, di
				;	jna	short @b
				;
				;	;mov	al, 20h
				;	;int	10h
				;	
				;	retn 

 2781				print_big_decimal_number endp

 2781				print_volume_info proc near
					; 29/12/2019
					; 24/09/2019 - Retro UNIX 386 v2
					;	       (modified unix v7 inode format)
					; 16/02/2013

					;mov	bx, offset BSBuffer
					;add	bx, bsVolumeSerial+2
					; 29/12/2019
 2781  BB 3AB8 R			mov	bx, offset BSBuffer.bsVolumeSerial+2

 2784  B9 0002				mov	cx, 2
 2787  BF 31FB R			mov	di, offset msgVolume_Serial
 278A				@@:
 278A  8B 07				mov	ax, word ptr [bx]
 278C  E8 006B				call	proc_hex_double
 278F  AB				stosw
 2790  8B C2				mov	ax, dx
 2792  AB				stosw
 2793  49				dec	cx
 2794  74 06				jz	short @f
 2796  47				inc	di
 2797  83 EB 02				sub	bx, 2	
 279A  EB EE				jmp	short @b
 279C				@@:
 279C  BE 31A3 R			mov	si, offset msgVolume_Info
 279F  E8 DD42				call	PRINT_MSG

					; 24/09/2019
 27A2				@@:
 27A2  BE 3208 R			mov	si, offset msgVol_Size_Hdr
 27A5  E8 DD3C				call	PRINT_MSG
 27A8  A1 3CB8 R			mov	ax, word ptr [systm.sb_VolumeSize] ; total sectors
					; 29/12/2019
 27AB  8B 16 3CBA R			mov	dx, word ptr [systm.sb_VolumeSize+2] ; total sectors, hw
					
					;mov	cl, 4 ; mov	cx, 4
					;call	print_decimal_number

 27AF  B1 0A				mov	cl, 10 ; cx = 10  (<=4294967295)
 27B1  E8 FF8D				call	print_big_decimal_number

 27B4  BE 3217 R			mov	si, offset msgVolume_Size
 27B7  E8 DD2A				call	PRINT_MSG

 27BA  BE 3221 R			mov	si, offset msgVol_freeblocks_Hdr
 27BD  E8 DD24				call	PRINT_MSG

 27C0  A1 3CE8 R			mov	ax, word ptr [systm.sb_FreeBlocks] ; free sectors 
					; 29/12/2019
 27C3  8B 16 3CEA R			mov	dx, word ptr [systm.sb_FreeBlocks+2] ; free sectors, hw

					;mov	cx, 4	
					;call	print_decimal_number

 27C7  B1 0A				mov	cl, 10 ; cx = 10  (<=4294967295)
 27C9  E8 FF75				call	print_big_decimal_number

 27CC  BE 3230 R			mov	si, offset msgVolume_freeblocks
 27CF  E8 DD12				call	PRINT_MSG
 27D2				@@:
 27D2  BE 323A R			mov	si, offset msgVol_icount_Hdr
 27D5  E8 DD0C				call	PRINT_MSG
 27D8  A1 3CC4 R			mov	ax, word ptr [systm.sb_InodeCount] ; number of inodes
					;mov	cl, 4 ; mov	cx, 4
 27DB  B1 05				mov	cl, 5 ; 10/01/2020
 27DD  E8 FEFB				call	print_decimal_number
 27E0  BE 3249 R			mov	si, offset msgVolume_icount
 27E3  E8 DCFE				call	PRINT_MSG

 27E6  BE 324C R			mov	si, offset msgVol_free_icount_Hdr
 27E9  E8 DCF8				call	PRINT_MSG
 27EC  A1 3CE0 R			mov	ax, word ptr [systm.sb_FreeInodes] ; num of free inodes
					;;mov	cx, 4	
					;mov	cl, 4
 27EF  B1 05				mov	cl, 5 ; 10/01/2020
 27F1  E8 FEE7				call	print_decimal_number
 27F4  BE 325B R			mov	si, offset msgVolume_free_icount
					; 16/01/2020
					;call	PRINT_MSG
					;retn
 27F7  E9 DCEA				jmp	PRINT_MSG	
					
 27FA				print_volume_info endp

 27FA				proc_hex_double proc near
					; 24/12/2019 (phexdbl)	
					; 16/02/2013 (AX:DX)
					; 28/01/2002 (DX:AX)
					; From binary (word) to hexadecimal (character) converter
					;
					; input -> AX = word (binary number) to be converted
					; output -> AX = First 2 characters of hexadecimal number
					; output -> DX = Last 2 characters of hexadecimal number

 27FA  51				push	cx
 27FB  33 D2			        xor	dx, dx
 27FD  B9 0010			        mov	cx, 10h
 2800  F7 F1			        div	cx	; Q in AX, R in DX (DL)
 2802  52			        push	dx	; DH= 0, R in DL <- CX= 10h 
 2803  32 D2			        xor	dl, dl
 2805  F7 F1			        div	cx	; DH= 0, R in DL, AX <= FFh
 2807  F6 F1			        div	cl	; AL <= 0Fh
							; R in AH, Q in AL
 2809  59			        pop	cx	; R in CL
 280A  8A F1				mov	dh, cl
					
 280C  81 CA 3030		        or	dx,'00'

 2810  80 FA 39			        cmp	dl,'9'
 2813  76 03			        jna	short phexdbl_1
 2815  80 C2 07			        add	dl,7
 2818				phexdbl_1:
 2818  80 FE 39			        cmp	dh,'9'
 281B  76 03			        jna	short phexdbl_2
 281D  80 C6 07			        add	dh,7
 2820				phexdbl_2:
 2820  0D 3030			        or	ax, '00'

 2823  3C 39			        cmp	al,'9'
 2825  76 02			        jna	short phexdbl_3
 2827  04 07			        add	al,7
 2829				phexdbl_3:
 2829  80 FC 39			        cmp	ah,'9'
 282C  76 03			        jna	short phexdbl_4
 282E  80 C4 07			        add	ah,7
 2831				phexdbl_4:
 2831  59			        pop	cx

 2832  C3			        retn

 2833				proc_hex_double endp

 2833				show_inode proc near
					; 24/09/2019
					; 20/09/2019 - Retro UNIX 386 v2 (modified unix v7 inode format)
					; 17/02/2013
					; print inode details
					; Format: inode <decimal number>, iget <decimal number>
					; INPUT -> AX <> 0 -> Current Inode [ii]
					;	   AX = 0 -> use inode number input
					;
 2833  23 C0				and	ax, ax
 2835  75 4C				jnz	short show_inode_7
 2837  A3 2C9A R			mov	word ptr [arg], ax ; 0
 283A  33 D2				xor	dx, dx
 283C				show_inode_1:
 283C  AC				lodsb
 283D  3C 30				cmp	al, '0'
 283F  72 0E				jb	short show_inode_4
 2841  3C 39				cmp	al, '9'
 2843  77 12			        ja	short show_inode_stc_retn ; cmc
 2845  2C 30				sub	al, '0'
 2847				show_inode_2:
 2847  0B D2				or	dx, dx
 2849  75 0E				jnz	short show_inode_5
 284B				show_inode_3:
 284B  8B D0				mov	dx, ax
 284D  EB ED				jmp	short show_inode_1
 284F				show_inode_4:
 284F  0B D2				or	dx, dx
 2851  74 04				jz	short show_inode_stc_retn
 2853  3C 20				cmp	al, 20h
 2855  76 14				jna	short show_inode_6
 2857				show_inode_stc_retn:
 2857  F5				cmc
 2858				show_inode_retn:
 2858  C3				retn
 2859				show_inode_5:
 2859  81 FA 0100			cmp	dx, 256
 285D  73 F8				jnb	short show_inode_stc_retn
 285F  8A E2				mov	ah, dl
 2861  8A D0				mov	dl, al
 2863  B0 0A				mov	al, 10
 2865  F6 E4				mul	ah
 2867  03 D0				add	dx, ax 
 2869  EB D1				jmp	short show_inode_1
 286B				show_inode_6:
					;mov	bx, word ptr [systm]
					;add	bx, offset systm+2
					;mov	ax, word ptr [bx] ; inode map bytes
					
					; 20/09/2019 - Retro UNIX 386 v2
 286B  A1 3CD4 R			mov	ax, word ptr [systm.sb_InodeMapSize]

 286E  D1 E0				shl	ax, 1
 2870  D1 E0				shl	ax, 1
 2872  D1 E0				shl	ax, 1 ; inode count

					; 20/09/2019 - Retro UNIX 386 v2	
					;add	ax, 40 ; + device file inodes
					
 2874  3B C2				cmp	ax, dx
 2876  72 E0				jb	short show_inode_retn ; not a valid i-number
					;mov	ax, dx
					;mov	word ptr [arg], ax
					; ax = i-number
 2878  8B DA				mov	bx, dx
 287A  89 1E 2C9A R			mov	word ptr [arg], bx
 287E  E8 ED6B				call	iget
 2881  72 D5				jc	short show_inode_retn
 2883				show_inode_7:
					;mov	ax, word ptr [ii]
					; 26/12/2019
 2883  8B C3				mov	ax, bx 
 2885  E8 FF72				call	proc_hex_double
 2888  A3 32B2 R			mov	word ptr [txt_inode_number], ax
 288B  89 16 32B4 R			mov	word ptr [txt_inode_number+2], dx
 288F  A1 303C R			mov	ax, word ptr [inode_flgs]
 2892  50				push	ax
 2893  E8 FF64				call	proc_hex_double
 2896  A3 32C3 R			mov	word ptr [txt_inode_flags_h], ax
 2899  89 16 32C5 R			mov	word ptr [txt_inode_flags_h+2], dx
 289D  5A				pop	dx
 289E  BF 32CA R			mov	di, offset txt_inode_flags_b
 28A1  B9 0010				mov	cx, 16
 28A4				@@:
 28A4  32 C0				xor	al, al ; 0
 28A6  D1 E2				shl	dx, 1
 28A8  14 30				adc	al, '0'
 28AA  AA				stosb
 28AB  E2 F7				loop	@b

					; 24/09/2019

 28AD  A1 303E R			mov	ax, word ptr [inode_nlks]
 28B0  E8 FF47				call	proc_hex_double
 28B3  A3 32EB R			mov	word ptr [txt_inode_nlks], ax
 28B6  89 16 32ED R			mov	word ptr [txt_inode_nlks+2], dx

 28BA  A1 3040 R			mov	ax, word ptr [inode_uid]
 28BD  E8 FF3A				call	proc_hex_double
 28C0  A3 32FC R			mov	word ptr [txt_inode_uid], ax
 28C3  89 16 32FE R			mov	word ptr [txt_inode_uid+2], dx

 28C7  A1 3042 R			mov	ax, word ptr [inode_gid]  ; & size_h
 28CA  E8 FF2D				call	proc_hex_double
 28CD  89 16 330E R			mov	word ptr [txt_inode_gid], dx
 28D1  A3 331D R			mov	word ptr [txt_inode_size_h], ax

 28D4  A1 3046 R		        mov	ax, word ptr [inode_size+2]
 28D7  E8 FF20				call	proc_hex_double
 28DA  A3 3329 R			mov	word ptr [txt_inode_size], ax
 28DD  89 16 332B R			mov	word ptr [txt_inode_size+2], dx

 28E1  A1 3044 R		        mov	ax, word ptr [inode_size]
 28E4  E8 FF13				call	proc_hex_double
 28E7  A3 332D R			mov	word ptr [txt_inode_size+4], ax
 28EA  89 16 332F R			mov	word ptr [txt_inode_size+6], dx

 28EE  B1 08				mov	cl, 8
 28F0  BE 3048 R			mov	si, offset inode_dskp
 28F3  BF 3344 R			mov	di, offset txt_inode_dskp
 28F6				show_indir_bn:
 28F6				@@:
 28F6  AD				lodsw
 28F7  8B D0				mov	dx,ax
 28F9  AD				lodsw
 28FA  52				push	dx	
 28FB  E8 FEFC				call	proc_hex_double	
 28FE  AB				stosw
 28FF  8B C2				mov	ax, dx
 2901  AB				stosw
 2902  58				pop	ax
 2903  E8 FEF4				call	proc_hex_double	
 2906  AB				stosw
 2907  8B C2				mov	ax, dx
 2909  AB				stosw
 290A  FE C9				dec	cl
 290C  74 04				jz	short @f
 290E  47				inc	di
 290F  47				inc	di
 2910  EB E4				jmp	short @b
 2912				@@:
 2912  81 FE 3068 R			cmp	si, offset inode_dskp+32
 2916  77 07				ja	short @f	
 2918  B1 02				mov	cl,2
 291A  BF 3395 R			mov	di, offset txt_inode_dskp_i
 291D  EB D7				jmp	short show_indir_bn
 291F				@@:
					;mov	si, offset inode_atim
 291F  8B 04				mov	ax, word ptr [si]
 2921  8B 54 02				mov	dx, word ptr [si+2]
 2924  52				push	dx
 2925  50				push	ax
 2926  52				push	dx
 2927  E8 FED0				call	proc_hex_double
 292A  A3 33C4 R			mov	word ptr [txt_inode_atim_h+4], ax	
 292D  89 16 33C6 R			mov	word ptr [txt_inode_atim_h+6], dx
 2931  58				pop	ax
 2932  E8 FEC5				call	proc_hex_double
 2935  A3 33C0 R			mov	word ptr [txt_inode_atim_h], ax	
 2938  89 16 33C2 R			mov	word ptr [txt_inode_atim_h+2], dx
 293C  58				pop	ax
 293D  5A				pop	dx
 293E  E8 F5CA				call	convert_from_epoch
 2941  A1 3096 R			mov	ax, word ptr [year]
 2944  BE 33D2 R			mov	si, offset txt_inode_ayear
					;mov	cx, 4
 2947  B1 04				mov	cl, 4
 2949  E8 FA8F				call	proc_bin_to_decimal
 294C  A1 3098 R			mov	ax, word ptr [month]
 294F  BE 33CF R			mov	si, offset txt_inode_amonth
 2952  B1 02				mov	cl, 2
 2954  E8 FA84				call	proc_bin_to_decimal
 2957  A1 309A R			mov	ax, word ptr [day]
 295A  BE 33CC R			mov	si, offset txt_inode_aday
 295D  B1 02				mov	cl, 2
 295F  E8 FA79				call	proc_bin_to_decimal
 2962  A1 309C R			mov	ax, word ptr [hour]
 2965  BE 33D7 R			mov	si, offset txt_inode_ahour
 2968  B1 02				mov	cl, 2
 296A  E8 FA6E				call	proc_bin_to_decimal
 296D  A1 309E R			mov	ax, word ptr [minute]
 2970  BE 33DA R			mov	si, offset txt_inode_aminute
 2973  B1 02				mov	cl, 2
 2975  E8 FA63				call	proc_bin_to_decimal
 2978  A1 30A0 R			mov	ax, word ptr [second]
 297B  BE 33DD R			mov	si, offset txt_inode_asecond
 297E  B1 02				mov	cl, 2
 2980  E8 FA58				call	proc_bin_to_decimal
 2983  BE 3074 R			mov	si, offset inode_mtim
 2986  8B 04				mov	ax, word ptr [si]
 2988  8B 54 02				mov	dx, word ptr [si+2]
 298B  52				push	dx
 298C  50				push	ax
 298D  52				push	dx
 298E  E8 FE69				call	proc_hex_double
 2991  A3 33FA R			mov	word ptr [txt_inode_mtim_h+4], ax	
 2994  89 16 33FC R			mov	word ptr [txt_inode_mtim_h+6], dx
 2998  58				pop	ax
 2999  E8 FE5E				call	proc_hex_double
 299C  A3 33F6 R			mov	word ptr [txt_inode_mtim_h], ax	
 299F  89 16 33F8 R			mov	word ptr [txt_inode_mtim_h+2], dx
 29A3  58				pop	ax
 29A4  5A				pop	dx
 29A5  E8 F563				call	convert_from_epoch
 29A8  A1 3096 R			mov	ax, word ptr [year]
 29AB  BE 3408 R			mov	si, offset txt_inode_myear
					;mov	cx, 4
 29AE  B1 04				mov	cl, 4
 29B0  E8 FA28				call	proc_bin_to_decimal
 29B3  A1 3098 R			mov	ax, word ptr [month]
 29B6  BE 3405 R			mov	si, offset txt_inode_mmonth
 29B9  B1 02				mov	cl, 2
 29BB  E8 FA1D				call	proc_bin_to_decimal
 29BE  A1 309A R			mov	ax, word ptr [day]
 29C1  BE 3402 R			mov	si, offset txt_inode_mday
 29C4  B1 02				mov	cl, 2
 29C6  E8 FA12				call	proc_bin_to_decimal
 29C9  A1 309C R			mov	ax, word ptr [hour]
 29CC  BE 340D R			mov	si, offset txt_inode_mhour
 29CF  B1 02				mov	cl, 2
 29D1  E8 FA07				call	proc_bin_to_decimal
 29D4  A1 309E R			mov	ax, word ptr [minute]
 29D7  BE 3410 R			mov	si, offset txt_inode_mminute
 29DA  B1 02				mov	cl, 2
 29DC  E8 F9FC				call	proc_bin_to_decimal
 29DF  A1 30A0 R			mov	ax, word ptr [second]
 29E2  BE 3413 R			mov	si, offset txt_inode_msecond
 29E5  B1 02				mov	cl, 2
 29E7  E8 F9F1				call	proc_bin_to_decimal
 29EA  BE 3078 R			mov	si, offset inode_ctim
 29ED  8B 04				mov	ax, word ptr [si]
 29EF  8B 54 02				mov	dx, word ptr [si+2]
 29F2  52				push	dx
 29F3  50				push	ax
 29F4  52				push	dx
 29F5  E8 FE02				call	proc_hex_double
 29F8  A3 342C R			mov	word ptr [txt_inode_ctim_h+4], ax	
 29FB  89 16 342E R			mov	word ptr [txt_inode_ctim_h+6], dx
 29FF  58				pop	ax
 2A00  E8 FDF7				call	proc_hex_double
 2A03  A3 3428 R			mov	word ptr [txt_inode_ctim_h], ax	
 2A06  89 16 342A R			mov	word ptr [txt_inode_ctim_h+2], dx
 2A0A  58				pop	ax
 2A0B  5A				pop	dx
 2A0C  E8 F4FC				call	convert_from_epoch
 2A0F  A1 3096 R			mov	ax, word ptr [year]
 2A12  BE 343A R			mov	si, offset txt_inode_cyear
					;mov	cx, 4
 2A15  B1 04				mov	cl, 4
 2A17  E8 F9C1				call	proc_bin_to_decimal
 2A1A  A1 3098 R			mov	ax, word ptr [month]
 2A1D  BE 3437 R			mov	si, offset txt_inode_cmonth
 2A20  B1 02				mov	cl, 2
 2A22  E8 F9B6				call	proc_bin_to_decimal
 2A25  A1 309A R			mov	ax, word ptr [day]
 2A28  BE 3434 R			mov	si, offset txt_inode_cday
 2A2B  B1 02				mov	cl, 2
 2A2D  E8 F9AB				call	proc_bin_to_decimal
 2A30  A1 309C R			mov	ax, word ptr [hour]
 2A33  BE 343F R			mov	si, offset txt_inode_chour
 2A36  B1 02				mov	cl, 2
 2A38  E8 F9A0				call	proc_bin_to_decimal
 2A3B  A1 309E R			mov	ax, word ptr [minute]
 2A3E  BE 3442 R			mov	si, offset txt_inode_cminute
 2A41  B1 02				mov	cl, 2
 2A43  E8 F995				call	proc_bin_to_decimal
 2A46  A1 30A0 R			mov	ax, word ptr [second]
 2A49  BE 3445 R			mov	si, offset txt_inode_csecond
 2A4C  B1 02				mov	cl, 2
 2A4E  E8 F98A				call	proc_bin_to_decimal
 2A51				@@:
 2A51  BE 327F R			mov	si, offset msg_inode_details	
 2A54  E8 DA8D				call	PRINT_MSG

					; 25/09/2019 - Retro UNIX 386 v2 (device inodes)
 2A57  F6 06 303D R 80			test 	byte ptr [inode_flgs+1],80h
 2A5C  75 13				jnz	short @f
					
					; write device's major and minor number
 2A5E  A1 3048 R		        mov	ax, word ptr [inode_dskp]
 2A61  E8 FD96				call	proc_hex_double
 2A64  A3 3464 R			mov	word ptr [txt_major], ax
 2A67  89 16 3478 R			mov	word ptr [txt_minor], dx
 2A6B  BE 344B R			mov	si, offset txt_device
					;call	PRINT_MSG
 2A6E  E9 DA73				jmp	PRINT_MSG	
 2A71				@@:
 2A71  C3				retn

 2A72				show_inode endp

				; 01/01/2020

				align 2
 2A72  00				db 0
				;PhysicalDriveNumber: db 0 ; 01/01/2020
 2A73 0000			FileHandle: dw 0

				; 24/12/2019
 2A75				file_error_msg:
 2A75  0D 0A				db 0Dh, 0Ah
 2A77  46 69 6C 65 20 45		db 'File Error !'
       72 72 6F 72 20 21
 2A83				CRLF:
 2A83  0D 0A 00				db 0Dh, 0Ah, 0

				; 04/12/2015 (Retro UNIX 8086 v1 -> Retro UNIX 386 v1)

				;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
				;  messages
				;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

 2A86				UNIX_Welcome:	; 17/12/2019
 2A86  0D 0A				db 0Dh,0Ah
 2A88  52 65 74 72 6F 20		db 'Retro UNIX 386 v2 Hard Disk FS File Import/Export Utility'
       55 4E 49 58 20 33
       38 36 20 76 32 20
       48 61 72 64 20 44
       69 73 6B 20 46 53
       20 46 69 6C 65 20
       49 6D 70 6F 72 74
       2F 45 78 70 6F 72
       74 20 55 74 69 6C
       69 74 79
 2AC1  0D 0A				db 0Dh,0Ah
 2AC3  55 4E 49 58 48 44		db 'UNIXHDCP/UNIXCOPY by Erdogan TAN 2012 - [20/07/2022]'
       43 50 2F 55 4E 49
       58 43 4F 50 59 20
       62 79 20 45 72 64
       6F 67 61 6E 20 54
       41 4E 20 32 30 31
       32 20 2D 20 5B 32
       30 2F 30 37 2F 32
       30 32 32 5D
 2AF7  0D 0A 00				db 0Dh,0Ah,0
 2AFA				type_27h: ; 25/09/2019
 2AFA  28 54 79 70 65 20		db '(Type ', 27h,'?',27h,' to see valid commands)'
       27 3F 27 20 74 6F
       20 73 65 65 20 76
       61 6C 69 64 20 63
       6F 6D 6D 61 6E 64
       73 29
 2B1A  0D 0A				db 0Dh,0Ah
 2B1C  0D 0A 00				db 0Dh,0Ah,0
 2B1F				usage:
 2B1F  0D 0A				db 0Dh,0Ah
 2B21  55 73 61 67 65 3A		db 'Usage: unixhdcp [Drive] ', 0Dh,0Ah
       20 75 6E 69 78 68
       64 63 70 20 5B 44
       72 69 76 65 5D 20
       0D 0A
 2B3B  20 20 20 20 20 20		db '       unixhdcp -i [hard disk image file name] '
       20 75 6E 69 78 68
       64 63 70 20 2D 69
       20 5B 68 61 72 64
       20 64 69 73 6B 20
       69 6D 61 67 65 20
       66 69 6C 65 20 6E
       61 6D 65 5D 20
 2B6A  0D 0A				db 0Dh,0Ah
 2B6C  0D 0A				db 0Dh,0Ah
 2B6E  44 72 69 76 65 20		db "Drive names:"
       6E 61 6D 65 73 3A
 2B7A  0D 0A				db 0Dh,0Ah
 2B7C  0D 0A				db 0Dh,0Ah
 2B7E  68 64 30 20 20 20		db "hd0    (Hard Disk 1)", 0Dh,0Ah
       20 28 48 61 72 64
       20 44 69 73 6B 20
       31 29 0D 0A
 2B94  68 64 31 20 20 20		db "hd1    (Hard Disk 2)", 0Dh,0Ah
       20 28 48 61 72 64
       20 44 69 73 6B 20
       32 29 0D 0A
 2BAA  2E 2E 2E 0D 0A			db "...", 0Dh, 0Ah
 2BAF  43 3A 20 20 20 20		db "C:     (Hard Disk 1)", 0Dh,0Ah
       20 28 48 61 72 64
       20 44 69 73 6B 20
       31 29 0D 0A
 2BC5  44 3A 20 20 20 20		db "D:     (Hard Disk 2)", 0Dh,0Ah
       20 28 48 61 72 64
       20 44 69 73 6B 20
       32 29 0D 0A
 2BDB  0D 0A				db 0Dh,0Ah
 2BDD  0D 0A				db 0Dh,0Ah
 2BDF  45 78 61 6D 70 6C		db 'Example 1: unixhdcp C: ', 0Dh,0Ah
       65 20 31 3A 20 75
       6E 69 78 68 64 63
       70 20 43 3A 20 0D
       0A
 2BF8  45 78 61 6D 70 6C		db 'Example 2: unixhdcp -i hd0.img '
       65 20 32 3A 20 75
       6E 69 78 68 64 63
       70 20 2D 69 20 68
       64 30 2E 69 6D 67
       20
 2C17  0D 0A				db 0Dh,0Ah
 2C19  00				db 0
 2C1A				unix_cdrv:
 2C1A				UNIX_HD_Name:	; 17/12/2019
 2C1A  68 64				db 'hd'
 2C1C				UNIX_HD_Number:
 2C1C  30 3A 00				db '0:', 0
 2C1F 21			unix_img_cdir:	db '!'  ; 07/07/2015
 2C20 2F			unix_cdir:	db '/'
 2C21  0025 [					db 37 dup(0)
        00
       ]

 2C46 0000			CDirOffset:	dw 0

 2C48 3E			unix_prompt_char: db '>'

 2C49 0000			CursorColumn:	dw 0

 2C4B  004A [			CommandBuffer:	db 74 dup(0)
        00
       ]

 2C95 00			program_exit:	db 0

 2C96 0000			pdir: 	dw 0 

 2C98 0D 0A			msg_arg: db 0Dh, 0Ah ; 13/01/2012 (chmod)
 2C9A 0000			arg: 	dw 0
 2C9C  0000				dw 0 ; 13/01/2012  ; 01/10/2019

 2C9E				msg_yes_no:
 2C9E  28 59 65 73 2F 4E		db '(Yes/No)? ', 0
       6F 29 3F 20 00

 2CA9				msg_drive_not_ready: ; 24/12/2019
 2CA9				msg_unix_drv_read_error:
 2CA9  0D 0A				db 0Dh, 0Ah
 2CAB  44 72 69 76 65 20		db "Drive not ready or read error!"
       6E 6F 74 20 72 65
       61 64 79 20 6F 72
       20 72 65 61 64 20
       65 72 72 6F 72 21
 2CC9  0D 0A 00				db 0Dh, 0Ah, 0

 2CCC				msg_inv_file_name: ; 07/07/2015
 2CCC  0D 0A				db 0Dh, 0Ah
 2CCE  49 6E 76 61 6C 69		db "Invalid file name !", 0Dh, 0Ah
       64 20 66 69 6C 65
       20 6E 61 6D 65 20
       21 0D 0A
 2CE3  28 46 69 6C 65 20		db "(File name must fit for 8.3 DOS format) !"
       6E 61 6D 65 20 6D
       75 73 74 20 66 69
       74 20 66 6F 72 20
       38 2E 33 20 44 4F
       53 20 66 6F 72 6D
       61 74 29 20 21
 2D0C  0D 0A 00				db 0Dh, 0Ah, 0

 2D0F				msg_file_attr_error: ; 07/07/2015
 2D0F  0D 0A				db 0Dh, 0Ah
 2D11  46 69 6C 65 20 61		db "File attribute is not proper for hard disk image !", 0Dh, 0Ah
       74 74 72 69 62 75
       74 65 20 69 73 20
       6E 6F 74 20 70 72
       6F 70 65 72 20 66
       6F 72 20 68 61 72
       64 20 64 69 73 6B
       20 69 6D 61 67 65
       20 21 0D 0A
 2D45  28 44 69 72 65 63		db "(Directory or write protected file) !"
       74 6F 72 79 20 6F
       72 20 77 72 69 74
       65 20 70 72 6F 74
       65 63 74 65 64 20
       66 69 6C 65 29 20
       21
 2D6A  0D 0A 00				db 0Dh, 0Ah, 0    

 2D6D				msg_file_not_found: ; 07/07/2015
 2D6D  0D 0A				db 0Dh, 0Ah
 2D6F  46 69 6C 65 20 6E		db "File not found !", 0Dh, 0Ah
       6F 74 20 66 6F 75
       6E 64 20 21 0D 0A
 2D81  28 46 69 6C 65 20		db "(File must be in current directory) !"
       6D 75 73 74 20 62
       65 20 69 6E 20 63
       75 72 72 65 6E 74
       20 64 69 72 65 63
       74 6F 72 79 29 20
       21
 2DA6  0D 0A 00				db 0Dh, 0Ah, 0

					; 17/12/2019
 2DA9				msg_inv_image_file: ; 03/10/2019
 2DA9  0D 0A				db 0Dh, 0Ah
 2DAB  49 6E 76 61 6C 69		db "Invalid hard disk image file !", 0Dh, 0Ah
       64 20 68 61 72 64
       20 64 69 73 6B 20
       69 6D 61 67 65 20
       66 69 6C 65 20 21
       0D 0A
 2DCB  28 46 69 6C 65 20		db "(File size does not fit to possible CHS parameters) !"
       73 69 7A 65 20 64
       6F 65 73 20 6E 6F
       74 20 66 69 74 20
       74 6F 20 70 6F 73
       73 69 62 6C 65 20
       43 48 53 20 70 61
       72 61 6D 65 74 65
       72 73 29 20 21
 2E00  0D 0A 00				db 0Dh, 0Ah, 0

 2E03				msg_inv_partition: ; 03/10/2019
 2E03  0D 0A				db 0Dh, 0Ah
 2E05  52 65 74 72 6F 20		db "Retro UNIX (71h) disk partition not found !"
       55 4E 49 58 20 28
       37 31 68 29 20 64
       69 73 6B 20 70 61
       72 74 69 74 69 6F
       6E 20 6E 6F 74 20
       66 6F 75 6E 64 20
       21
 2E30  0D 0A 00				db 0Dh, 0Ah, 0

 2E33				msg_not_runix_fs:
 2E33  0D 0A				db 0Dh, 0Ah
 2E35  44 72 69 76 65 20		db "Drive has not got a (valid) Retro UNIX v2 FS !"
       68 61 73 20 6E 6F
       74 20 67 6F 74 20
       61 20 28 76 61 6C
       69 64 29 20 52 65
       74 72 6F 20 55 4E
       49 58 20 76 32 20
       46 53 20 21
 2E63  0D 0A 00				db 0Dh, 0Ah, 0

 2E66				Msg_writing_file:
 2E66  0D 0A				db 0Dh, 0Ah
 2E68  57 72 69 74 69 6E		db "Writing file..."
       67 20 66 69 6C 65
       2E 2E 2E
 2E77  00				db 0

 2E78				Msg_Removing_file:
 2E78  0D 0A				db 0Dh, 0Ah
 2E7A  44 65 6C 65 74 69		db "Deleting file..."
       6E 67 20 66 69 6C
       65 2E 2E 2E
 2E8A  00				db 0

 2E8B				Msg_DosFile_Name:
 2E8B  0D 0A				db 0Dh, 0Ah
 2E8D  44 4F 53 20 46 69		db "DOS File Name : ", 0
       6C 65 20 4E 61 6D
       65 20 3A 20 00

 2E9E				Msg_StartupFile_Name:
 2E9E  0D 0A				db 0Dh, 0Ah
 2EA0  53 74 61 72 74 75		db "Startup File Name : ", 0
       70 20 46 69 6C 65
       20 4E 61 6D 65 20
       3A 20 00

 2EB5 2E 2E 2E			Msg_3dot_OK:    db "..."
 2EB8				Msg_OK:
 2EB8  20 4F 4B 2E 0D 0A		db ' OK.', 0Dh, 0Ah, 0
       00

 2EBF 20 59 45 53		msg_YES:        db ' YES'
 2EC3  00				db 0
 2EC4 20 4E 4F			msg_NO:         db ' NO'
 2EC7  00				db 0 
				; 24/12/2019
				; 12/08/2012
 2EC8				msg_disk_rw_error:
 2EC8  0D 0A				db 0Dh, 0Ah
 2ECA  44 69 73 6B 20 72		db 'Disk r/w error!'
       2F 77 20 65 72 72
       6F 72 21
 2ED9  00				db 0

 2EDA				error_msg:
 2EDA  0D 0A				db 0Dh, 0Ah
 2EDC  45 72 72 6F 72 20		db 'Error !'
       21
 2EE3				UNIX_CRLF:
 2EE3  0D 0A 00				db 0Dh, 0Ah, 0

 2EE6				msg_error_Number:
 2EE6  0D 0A				db 0Dh, 0Ah
 2EE8  45 72 72 6F 72 20		db 'Error No: '
       4E 6F 3A 20
 2EF2 3030			str_err:        dw 3030h
 2EF4  68				db 'h'
 2EF5  0D 0A 00				db 0Dh, 0Ah, 0

 2EF8				msg_making_directory:
 2EF8  0D 0A				db 0Dh, 0Ah
 2EFA  4D 61 6B 69 6E 67		db "Making directory..."
       20 64 69 72 65 63
       74 6F 72 79 2E 2E
       2E
 2F0D  00				db 0

 2F0E				msg_removing_directory:
 2F0E  0D 0A				db 0Dh, 0Ah
 2F10  52 65 6D 6F 76 69		db "Removing directory..."
       6E 67 20 64 69 72
       65 63 74 6F 72 79
       2E 2E 2E
 2F25  00				db 0

 2F26				msg_unix_drv_write_error:
 2F26  0D 0A				db 0Dh, 0Ah
 2F28  44 72 69 76 65 20		db 'Drive not ready or write error!'
       6E 6F 74 20 72 65
       61 64 79 20 6F 72
       20 77 72 69 74 65
       20 65 72 72 6F 72
       21
 2F47  0D 0A				db 0Dh, 0Ah
 2F49  00				db 0
 2F4A				msg_Startup_File_Not_Exists:
 2F4A  0D 0A				db 0Dh, 0Ah
 2F4C  53 74 61 72 74 75		db 'Startup File is not configured yet ! '
       70 20 46 69 6C 65
       20 69 73 20 6E 6F
       74 20 63 6F 6E 66
       69 67 75 72 65 64
       20 79 65 74 20 21
       20
 2F71  0D 0A 00				db 0Dh, 0Ah, 0 

 2F74				msg_sf_configuration_set_ok:
 2F74  0D 0A				db 0Dh, 0Ah
 2F76  53 74 61 72 74 75		db "Startup file configuration SET is OK."
       70 20 66 69 6C 65
       20 63 6F 6E 66 69
       67 75 72 61 74 69
       6F 6E 20 53 45 54
       20 69 73 20 4F 4B
       2E
 2F9B  0D 0A 00				db 0Dh, 0Ah, 0

 2F9E				msg_sf_configuration_reset_ok:
 2F9E  0D 0A				db 0Dh, 0Ah
 2FA0  53 74 61 72 74 75		db "Startup file configuration RESET is OK."
       70 20 66 69 6C 65
       20 63 6F 6E 66 69
       67 75 72 61 74 69
       6F 6E 20 52 45 53
       45 54 20 69 73 20
       4F 4B 2E
 2FC7  0D 0A 00				db 0Dh, 0Ah, 0

 2FCA				msg_overwrite_question1:
					; 1/12/2012
 2FCA  0D 0A				db 0Dh, 0Ah
 2FCC  44 6F 20 79 6F 75		db 'Do you want to overwrite '
       20 77 61 6E 74 20
       74 6F 20 6F 76 65
       72 77 72 69 74 65
       20
 2FE5  27				db 27h
 2FE6  00				db 0

 2FE7				msg_overwrite_question2: 
 2FE7  27				db 27h
 2FE8  20 66 69 6C 65 20		db ' file '
 2FEE  00				db 0	

 2FEF				msg_remove_question1:
					; 1/12/2012
 2FEF  0D 0A				db 0Dh, 0Ah
 2FF1  44 6F 20 79 6F 75		db 'Do you want to delete '
       20 77 61 6E 74 20
       74 6F 20 64 65 6C
       65 74 65 20
 3007  27				db 27h
 3008  00				db 0

 3009				msg_remove_question2: 
 3009  27				db 27h
 300A  20 66 69 6C 65 20		db ' file '
 3010  00				db 0
				align 2

 3012 0000			RetryCount:     dw 0

				; 07/07/2015
 3014  000D [			img_file_name:  db 13 dup(0)
        00
       ]
 3021  00				        db 0
 3022 0000			img_file_handle: dw 0
				;img_file_pos:	dd 0 ; file (position) pointer
				;
 3024				DirFileName:
 3024  20				db 20h ; 06/01/2013
 3025  000E [			BOOT_FILE_NAME: db 14 dup(0) ; 04/12/2015 (9 -> 14+'?')
        00
       ]
 3033  3F				db '?' ; Here will be ZERO if name length is 14
					       ; (ci_move_bfn_3:)

 3034 00000000			uf_make_datetime: dd 0 ; 25/11/2012

 3038 0000			uf_i_number: dw 0 ; 25/11/2012

				align 4 ; 24/12/2019

				; 19/09/2019 - Retro UNIX 386 v2 inode format 
				;		(modified unix v7 inode format)
 303C				bootfile_inode: 
 303C				inode:
 303C 81B4			inode_flgs:	dw 81B4h ; Flags (1000000110110100b) (81B4h for UNIX v7)
 303E 0001			inode_nlks:	dw 1	; number of links 
 3040 0003			inode_uid:	dw 3	; user ID (3 = bin)
 3042 03			inode_gid:	db 3	; group ID (3 = bin)
 3043 00			inode_size_h:	db 0    ; file size bits 33-40 (=0)
 3044 00000000			inode_size:	dd 0	; file size
 3048  000A [			inode_dskp:	dd 10 dup (0) ; indirect or direct contents blocks
        00000000
       ]
 3070 00000000			inode_atim:	dd 0	; lass access -inode modif.- date & time
 3074 00000000			inode_mtim:	dd 0	; (file) modification date & time
 3078 00000000			inode_ctim:	dd 0	; (file) creation date & time

				;rw: db 0

				; 20/09/2019
				; NOTE: word ptr [imod] is used to check inode modification in iget 
				; 24/12/2019
				;imod: db 0
				;imodx: db  0 ; 19/09/2019 - Retro UNIX 386 v2 
				;		(extended flag for inode modification)	

				;U:
 307C 00			u_uid: db 0
 307D 00			u_gid: db 0 ; 19/09/2019 - Retro UNIX 386 v2
 307E 0001			u_cdir: dw ROOT_DIR_INODE_NUMBER
 3080 0000			u_namep: dw 0
 3082 0000			u_dirp: dw 0
 3084  0000				dw 0 ; 01/01/2020 (32 bit value for directory size)
				; 24/12/2019	
				;u_base: dw 0
				;u_off: dw 0
				;u_count: dw 0
				;u_nread: dw 0
 3086  0010 [			u_dirbuf: db 16 dup(0) ; 04/12/2015 (10 -> 16)
        00
       ]

				;ii: dw 0
				;buff_s: dw 0 ; 24/12/2019

 3096 07B2			year: dw 1970
 3098 0001			month: dw 1
 309A 0001			day: dw 1
 309C 0000			hour: dw 0
 309E 0000			minute: dw 0
 30A0 0000			second: dw 0

 30A2				DMonth:
 30A2  0000			dw 0
 30A4  001F			dw 31
 30A6  003B			dw 59
 30A8  005A			dw 90
 30AA  0078			dw 120
 30AC  0097			dw 151
 30AE  00B5			dw 181
 30B0  00D4			dw 212
 30B2  00F3			dw 243
 30B4  0111			dw 273
 30B6  0130			dw 304
 30B8  014E			dw 334

				; 30/11/2012
				;imin: dd 0
				;ihrs: dd 0
				;iday: dw 0
				;lday: dw 0
				;qday: dw 0
				;iyrs: dw 0
				;jday: dw 0
				;mday: dw 0


				; 25/11/2012
 30BA				str_inode_number:
 30BA  0D 0A				db 0Dh, 0Ah
 30BC  53 74 61 72 74 75		db 'Startup File I-Number: ', 0
       70 20 46 69 6C 65
       20 49 2D 4E 75 6D
       62 65 72 3A 20 00
 30D4				Decimal_i_no_str:	
 30D4  0006 [				db 6 dup (0)
        00
       ]

 30DA				Str_startup_file_size:
 30DA  0D 0A				db 0Dh, 0Ah
 30DC  53 74 61 72 74 75		db 'Startup File Size : ', 0
       70 20 46 69 6C 65
       20 53 69 7A 65 20
       3A 20 00
 30F1				Str_Bytes:
 30F1  20 62 79 74 65 73		db ' bytes', 0
       00

 30F8  0006 [			Decimal_size_str: db 6 dup (0)
        00
       ]

 30FE				Str_sf_date_time:
 30FE  0D 0A				db 0Dh, 0Ah
 3100  43 72 65 61 74 69		db 'Creating Date & Time    : '
       6E 67 20 44 61 74
       65 20 26 20 54 69
       6D 65 20 20 20 20
       3A 20
 311A 30 30			Str_cday:	db '00'
 311C  2F				db '/'
 311D 30 30			Str_cmonth:	db '00'
 311F  2F				db '/'
 3120 30 30 30 30		Str_cyear:	db '0000'
 3124  20 20				db 20h, 20h
 3126 30 30			Str_chour: 	db '00'
 3128  3A				db ':'
 3129 30 30			Str_cminute:  	db '00'
 312B  3A				db ':'
 312C 30 30			Str_csecond:  	db '00'
 312E  0D 0A				db 0Dh, 0Ah
 3130  4C 61 73 74 20 4D		db 'Last Modif. Date & Time : '
       6F 64 69 66 2E 20
       44 61 74 65 20 26
       20 54 69 6D 65 20
       3A 20
 314A 30 30			Str_mday:	db '00'
 314C  2F				db '/'
 314D 30 30			Str_mmonth:	db '00'
 314F  2F				db '/'
 3150 30 30 30 30		Str_myear:	db '0000'
 3154  20 20				db 20h, 20h
 3156 30 30			Str_mhour: 	db '00'
 3158  3A				db ':'
 3159 30 30			Str_mminute:  	db '00'
 315B  3A				db ':'
 315C 30 30			Str_msecond:  	db '00'
 315E  0D 0A				db 0Dh, 0Ah
 3160  4D 6F 64 65 20 43		db 'Mode Change Date & Time : '
       68 61 6E 67 65 20
       44 61 74 65 20 26
       20 54 69 6D 65 20
       3A 20
 317A 30 30			Str_aday:	db '00'
 317C  2F				db '/'
 317D 30 30			Str_amonth:	db '00'
 317F  2F				db '/'
 3180 30 30 30 30		Str_ayear:	db '0000'
 3184  20 20				db 20h, 20h
 3186 30 30			Str_ahour: 	db '00'
 3188  3A				db ':'
 3189 30 30			Str_aminute:  	db '00'
 318B  3A				db ':'
 318C 30 30			Str_asecond:  	db '00'
 318E  0D 0A 00				db 0Dh, 0Ah, 0

				;23/02/2013
 3191 FF			list_count: db 0FFh
				; 20/01/2013
 3192 00			ls_option: db 0
				; 21/01/2013
				;dec_num: db 10 dup(20h) ; 03/02/2013, 3 bytes -> 10 bytes
				; 15/01/2020
 3193  000B [			dec_num: db 11 dup(20h)
        20
       ]
 319E  0000			dw 0 ; 29/12/2019

				;30/12/2012
 31A0				DotDot:
 31A0  2E			db '.'
 31A1				Dot:
 31A1  2E			db '.'
 31A2  00			db 0

				;24/09/2019
				;16/02/2013
 31A3				msgVolume_Info:
 31A3  0D 0A				db 0Dh, 0Ah
 31A5  52 65 74 72 6F 20		db "Retro UNIX 386 v2 (RUFS) File System", 0Dh, 0Ah
       55 4E 49 58 20 33
       38 36 20 76 32 20
       28 52 55 46 53 29
       20 46 69 6C 65 20
       53 79 73 74 65 6D
       0D 0A
 31CB  62 79 20 45 72 64		db "by Erdogan Tan (2013-2022)"
       6F 67 61 6E 20 54
       61 6E 20 28 32 30
       31 33 2D 32 30 32
       32 29
 31E5  0D 0A 0D 0A			db 0Dh, 0Ah, 0Dh, 0Ah
 31E9  56 6F 6C 75 6D 65		db "Volume Serial No: "
       20 53 65 72 69 61
       6C 20 4E 6F 3A 20
 31FB				msgVolume_Serial:
 31FB  30 30 30 30 2D 30		db "0000-0000h"
       30 30 30 68
 3205  0D 0A 00				db 0Dh, 0Ah, 0
 3208 56 6F 6C 75 6D 65		msgVol_Size_Hdr:db "Volume Size : ", 0
       20 53 69 7A 65 20
       3A 20 00
 3217				msgVolume_Size:	; db "0000" 
 3217  20 62 6C 6F 63 6B		db " blocks", 0Dh, 0Ah, 0
       73 0D 0A 00
 3221 46 72 65 65 20 43		msgVol_freeblocks_Hdr:db "Free Count  : ", 0
       6F 75 6E 74 20 20
       3A 20 00
 3230				msgVolume_freeblocks: ;db "0000" 
 3230  20 62 6C 6F 63 6B		db " blocks", 0Dh, 0Ah, 0	 
       73 0D 0A 00
 323A				msgVol_icount_Hdr:
 323A  23 20 6F 66 20 49		db "# of Inodes : ", 0
       6E 6F 64 65 73 20
       3A 20 00
 3249				msgVolume_icount:  ;db "0000" 
 3249  0D 0A 00				db 0Dh, 0Ah, 0
 324C 46 72 65 65 20 49		msgVol_free_icount_Hdr:db 'Free Inodes : ', 0
       6E 6F 64 65 73 20
       3A 20 00
 325B				msgVolume_free_icount : ;db "0000" 
 325B  0D 0A 00				db 0Dh, 0Ah, 0

 325E				NotFound_msg:
 325E  0D 0A				db 0Dh, 0Ah
 3260  4E 6F 74 20 66 6F		db "Not found !"
       75 6E 64 20 21
 326B  0D 0A 00				db 0Dh, 0Ah, 0
 326E				msgINumber:
 326E  0D 0A				db 0Dh, 0Ah
 3270  49 6E 6F 64 65 20		db "Inode Number :", 0
       4E 75 6D 62 65 72
       20 3A 00

				; 21/09/2019
 327F				msg_inode_details:
 327F  0D 0A				db 0Dh, 0Ah
 3281  52 45 54 52 4F 20		db "RETRO UNIX V2 I-NODE STRUCTURE DETAILS OF I-NODE "
       55 4E 49 58 20 56
       32 20 49 2D 4E 4F
       44 45 20 53 54 52
       55 43 54 55 52 45
       20 44 45 54 41 49
       4C 53 20 4F 46 20
       49 2D 4E 4F 44 45
       20
 32B2				txt_inode_number:
 32B2  30 30 30 30 68			db "0000h"
 32B7  0D 0A 0D 0A			db 0Dh, 0Ah, 0Dh, 0Ah
 32BB  46 6C 61 67 73 20		db "Flags : "
       3A 20
 32C3				txt_inode_flags_h:
 32C3  30 30 30 30 68			db "0000h"
 32C8  20				db 20h
 32C9  5B				db "["
 32CA				txt_inode_flags_b:
 32CA  30 30 30 30 30 30		db "0000000000000000b"
       30 30 30 30 30 30
       30 30 30 30 62
 32DB  5D				db "]"
 32DC  0D 0A				db 0Dh, 0Ah
 32DE  23 20 6F 66 20 4C		db "# of Links : "
       69 6E 6B 73 20 3A
       20
 32EB				txt_inode_nlks:
 32EB  30 30 30 30 68			db "0000h"
 32F0  0D 0A				db 0Dh, 0Ah
 32F2  55 73 65 72 20 49		db "User ID : "
       44 20 3A 20
 32FC				txt_inode_uid:
 32FC  30 30 30 30 68			db "0000h"
 3301  0D 0A				db 0Dh, 0Ah
 3303  47 72 6F 75 70 20		db "Group ID : "
       49 44 20 3A 20
 330E				txt_inode_gid:
 330E  30 30 68				db "00h"
 3311  0D 0A				db 0Dh, 0Ah
 3313  53 69 7A 65 20 68		db "Size hb : "
       62 20 3A 20
 331D				txt_inode_size_h:
 331D  30 30 68				db "00h"
 3320  0D 0A				db 0Dh, 0Ah
 3322  53 69 7A 65 20 3A		db "Size : "
       20
 3329				txt_inode_size:
 3329  30 30 30 30 30 30		db "00000000h"
       30 30 68
 3332  0D 0A				db 0Dh, 0Ah
 3334  44 69 73 6B 20 42		db "Disk Blocks : "
       6C 6F 63 6B 73 20
       3A 20
 3342  0D 0A				db 0Dh,0Ah ; 24/09/2019
 3344				txt_inode_dskp:	
 3344  30 30 30 30 30 30		db "00000000h 00000000h 00000000h 00000000h "
       30 30 68 20 30 30
       30 30 30 30 30 30
       68 20 30 30 30 30
       30 30 30 30 68 20
       30 30 30 30 30 30
       30 30 68 20
 336C  30 30 30 30 30 30		db "00000000h 00000000h 00000000h 00000000h"
       30 30 68 20 30 30
       30 30 30 30 30 30
       68 20 30 30 30 30
       30 30 30 30 68 20
       30 30 30 30 30 30
       30 30 68
 3393  0D 0A				db 0Dh,0Ah
 3395				txt_inode_dskp_i:
 3395  30 30 30 30 30 30		db "00000000h 00000000h"
       30 30 68 20 30 30
       30 30 30 30 30 30
       68
 33A8  0D 0A				db 0Dh, 0Ah
 33AA  49 6E 6F 64 65 20		db "Inode Changing Time : "
       43 68 61 6E 67 69
       6E 67 20 54 69 6D
       65 20 3A 20
 33C0				txt_inode_atim_h:
 33C0  30 30 30 30 30 30		db "00000000h"
       30 30 68
 33C9  20 20				db 20h, 20h
 33CB  5B				db "["
 33CC				txt_inode_aday:	
 33CC  30 30				db "00"
 33CE  2F				db "/"
 33CF				txt_inode_amonth:
 33CF  30 30				db "00"
 33D1  2F				db "/"
 33D2				txt_inode_ayear:
 33D2  30 30 30 30			db "0000"
 33D6  2C				db ","
 33D7				txt_inode_ahour:
 33D7  30 30				db "00"
 33D9  3A				db ":"
 33DA				txt_inode_aminute:
 33DA  30 30				db "00"
 33DC  3A				db ":"
 33DD				txt_inode_asecond:	
 33DD  30 30				db "00"
 33DF  5D				db "]"
 33E0  0D 0A				db 0Dh, 0Ah
 33E2  4D 6F 64 69 66 69		db "Modification Time : "
       63 61 74 69 6F 6E
       20 54 69 6D 65 20
       3A 20
 33F6				txt_inode_mtim_h:
 33F6  30 30 30 30 30 30		db "00000000h"
       30 30 68
 33FF  20 20				db 20h, 20h
 3401  5B				db "["
 3402				txt_inode_mday:	
 3402  30 30				db "00"
 3404  2F				db "/"
 3405				txt_inode_mmonth:
 3405  30 30				db "00"
 3407  2F				db "/"
 3408				txt_inode_myear:
 3408  30 30 30 30			db "0000"
 340C  2C				db ","
 340D				txt_inode_mhour:
 340D  30 30				db "00"
 340F  3A				db ":"
 3410				txt_inode_mminute:
 3410  30 30				db "00"
 3412  3A				db ":"
 3413				txt_inode_msecond:	
 3413  30 30				db "00"
 3415  5D				db "]"
 3416  0D 0A				db 0Dh, 0Ah
 3418  43 72 65 61 74 69		db "Creation Time : "
       6F 6E 20 54 69 6D
       65 20 3A 20
 3428				txt_inode_ctim_h:
 3428  30 30 30 30 30 30		db "00000000h"
       30 30 68
 3431  20 20				db 20h, 20h
 3433  5B				db "["
 3434				txt_inode_cday:
 3434  30 30				db "00"
 3436  2F				db "/"
 3437				txt_inode_cmonth:
 3437  30 30				db "00"
 3439  2F				db "/"
 343A				txt_inode_cyear:
 343A  30 30 30 30			db "0000"
 343E  2C				db ","
 343F				txt_inode_chour:
 343F  30 30				db "00"
 3441  3A				db ":"
 3442				txt_inode_cminute:
 3442  30 30				db "00"
 3444  3A				db ":"
 3445				txt_inode_csecond:	
 3445  30 30				db "00"
 3447  5D				db "]"
 3448  0D 0A 00				db 0Dh, 0Ah, 0
				; 25/09/2019
 344B				txt_device: 
 344B  0D 0A				db 0Dh,0Ah	
 344D  44 45 56 49 43 45		db "DEVICE", 0Dh,0Ah 
       0D 0A
 3455  4D 61 6A 6F 72 20		db "Major Number : " 	
       4E 75 6D 62 65 72
       20 3A 20
 3464 30 30 68 0D 0A		txt_major: db "00h", 0Dh,0Ah
 3469  4D 69 6E 6F 72 20		db "Minor Number : "
       4E 75 6D 62 65 72
       20 3A 20
 3478 30 30 68 0D 0A 00		txt_minor: db "00h", 0Dh,0Ah, 0

 347E				UNIXCOPY_Commands: ; 23/02/2013
 347E  0D 0A			db 0Dh, 0Ah
 3480  55 4E 49 58 43 4F	db "UNIXCOPY COMMANDS      [", 27h, "/", 27h, " means alternative, ",  27h, "<...>", 27h, " means command argument]", 0Dh, 0Ah
       50 59 20 43 4F 4D
       4D 41 4E 44 53 20
       20 20 20 20 20 5B
       27 2F 27 20 6D 65
       61 6E 73 20 61 6C
       74 65 72 6E 61 74
       69 76 65 2C 20 27
       3C 2E 2E 2E 3E 27
       20 6D 65 61 6E 73
       20 63 6F 6D 6D 61
       6E 64 20 61 72 67
       75 6D 65 6E 74 5D
       0D 0A
 34D0  64 69 72 20 3C 64	db "dir <directory name>   : print directory entries without details", 0Dh, 0Ah 
       69 72 65 63 74 6F
       72 79 20 6E 61 6D
       65 3E 20 20 20 3A
       20 70 72 69 6E 74
       20 64 69 72 65 63
       74 6F 72 79 20 65
       6E 74 72 69 65 73
       20 77 69 74 68 6F
       75 74 20 64 65 74
       61 69 6C 73 0D 0A
 3512  6C 73 20 3C 64 69	db "ls <directory name>    : print directory entries, ", 27h, "/",  27h," means entry is directory", 0Dh, 0Ah
       72 65 63 74 6F 72
       79 20 6E 61 6D 65
       3E 20 20 20 20 3A
       20 70 72 69 6E 74
       20 64 69 72 65 63
       74 6F 72 79 20 65
       6E 74 72 69 65 73
       2C 20 27 2F 27 20
       6D 65 61 6E 73 20
       65 6E 74 72 79 20
       69 73 20 64 69 72
       65 63 74 6F 72 79
       0D 0A
 3562  6C 73 20 2D 6C 20	db "ls -l <directory name> : print directory entries with details", 0Dh, 0Ah
       3C 64 69 72 65 63
       74 6F 72 79 20 6E
       61 6D 65 3E 20 3A
       20 70 72 69 6E 74
       20 64 69 72 65 63
       74 6F 72 79 20 65
       6E 74 72 69 65 73
       20 77 69 74 68 20
       64 65 74 61 69 6C
       73 0D 0A
 35A1  63 68 64 69 72 2F	db "chdir/cd <directory name> : change directory", 0Dh, 0Ah
       63 64 20 3C 64 69
       72 65 63 74 6F 72
       79 20 6E 61 6D 65
       3E 20 3A 20 63 68
       61 6E 67 65 20 64
       69 72 65 63 74 6F
       72 79 0D 0A
 35CF  66 72 6F 6D 64 6F	db "fromdos <dos file name> <unix file name> : copy/import dos file to unix fs", 0Dh, 0Ah
       73 20 3C 64 6F 73
       20 66 69 6C 65 20
       6E 61 6D 65 3E 20
       3C 75 6E 69 78 20
       66 69 6C 65 20 6E
       61 6D 65 3E 20 3A
       20 63 6F 70 79 2F
       69 6D 70 6F 72 74
       20 64 6F 73 20 66
       69 6C 65 20 74 6F
       20 75 6E 69 78 20
       66 73 0D 0A
 361B  74 6F 64 6F 73 20	db "todos <unix file name> <dos file name>   : copy/export unix file to dos fs", 0Dh, 0Ah  
       3C 75 6E 69 78 20
       66 69 6C 65 20 6E
       61 6D 65 3E 20 3C
       64 6F 73 20 66 69
       6C 65 20 6E 61 6D
       65 3E 20 20 20 3A
       20 63 6F 70 79 2F
       65 78 70 6F 72 74
       20 75 6E 69 78 20
       66 69 6C 65 20 74
       6F 20 64 6F 73 20
       66 73 0D 0A
 3667  72 6D 20 3C 66 69	db "rm <file name>         : remove/delete/unlink file", 0Dh, 0Ah 
       6C 65 20 6E 61 6D
       65 3E 20 20 20 20
       20 20 20 20 20 3A
       20 72 65 6D 6F 76
       65 2F 64 65 6C 65
       74 65 2F 75 6E 6C
       69 6E 6B 20 66 69
       6C 65 0D 0A
 369B  6D 6B 64 69 72 20	db "mkdir <directory name> : make new sub directory", 0Dh, 0Ah
       3C 64 69 72 65 63
       74 6F 72 79 20 6E
       61 6D 65 3E 20 3A
       20 6D 61 6B 65 20
       6E 65 77 20 73 75
       62 20 64 69 72 65
       63 74 6F 72 79 0D
       0A
 36CC  72 6D 64 69 72 20	db "rmdir <directory name> : remove/delete sub directory", 0Dh, 0Ah
       3C 64 69 72 65 63
       74 6F 72 79 20 6E
       61 6D 65 3E 20 3A
       20 72 65 6D 6F 76
       65 2F 64 65 6C 65
       74 65 20 73 75 62
       20 64 69 72 65 63
       74 6F 72 79 0D 0A
 3702  6C 69 6E 6B 20 3C	db "link <source file name> <destination file name> : link file to file", 0Dh, 0Ah 
       73 6F 75 72 63 65
       20 66 69 6C 65 20
       6E 61 6D 65 3E 20
       3C 64 65 73 74 69
       6E 61 74 69 6F 6E
       20 66 69 6C 65 20
       6E 61 6D 65 3E 20
       3A 20 6C 69 6E 6B
       20 66 69 6C 65 20
       74 6F 20 66 69 6C
       65 0D 0A
 3747  65 78 69 74 20 20	db "exit                   : return to dos", 0Dh, 0Ah
       20 20 20 20 20 20
       20 20 20 20 20 20
       20 20 20 20 20 3A
       20 72 65 74 75 72
       6E 20 74 6F 20 64
       6F 73 0D 0A
 376F  73 68 6F 77 20 3C	db "show <file name>       : show file, print/display file contents", 0Dh, 0Ah
       66 69 6C 65 20 6E
       61 6D 65 3E 20 20
       20 20 20 20 20 3A
       20 73 68 6F 77 20
       66 69 6C 65 2C 20
       70 72 69 6E 74 2F
       64 69 73 70 6C 61
       79 20 66 69 6C 65
       20 63 6F 6E 74 65
       6E 74 73 0D 0A
 37B0  69 6E 6F 64 65 2F	db "inode/iget <inode number> : print inode details for (decimal) inode number", 0Dh, 0Ah
       69 67 65 74 20 3C
       69 6E 6F 64 65 20
       6E 75 6D 62 65 72
       3E 20 3A 20 70 72
       69 6E 74 20 69 6E
       6F 64 65 20 64 65
       74 61 69 6C 73 20
       66 6F 72 20 28 64
       65 63 69 6D 61 6C
       29 20 69 6E 6F 64
       65 20 6E 75 6D 62
       65 72 0D 0A
 37FC  63 68 6D 6F 64 20	db "chmod <mode> <file name>  : change file mode (according to octal number)", 0Dh, 0Ah
       3C 6D 6F 64 65 3E
       20 3C 66 69 6C 65
       20 6E 61 6D 65 3E
       20 20 3A 20 63 68
       61 6E 67 65 20 66
       69 6C 65 20 6D 6F
       64 65 20 28 61 63
       63 6F 72 64 69 6E
       67 20 74 6F 20 6F
       63 74 61 6C 20 6E
       75 6D 62 65 72 29
       0D 0A
 3846  63 68 6F 77 6E 20	db "chown <owner> <file name> : change file's owner (according to decimal number)", 0Dh, 0Ah
       3C 6F 77 6E 65 72
       3E 20 3C 66 69 6C
       65 20 6E 61 6D 65
       3E 20 3A 20 63 68
       61 6E 67 65 20 66
       69 6C 65 27 73 20
       6F 77 6E 65 72 20
       28 61 63 63 6F 72
       64 69 6E 67 20 74
       6F 20 64 65 63 69
       6D 61 6C 20 6E 75
       6D 62 65 72 29 0D
       0A
 3895  63 68 67 72 70 20	db "chgrp <group> <file name> : change file's group (according to decimal number)", 0Dh, 0Ah  ; Retro UNIX 386 v2
       3C 67 72 6F 75 70
       3E 20 3C 66 69 6C
       65 20 6E 61 6D 65
       3E 20 3A 20 63 68
       61 6E 67 65 20 66
       69 6C 65 27 73 20
       67 72 6F 75 70 20
       28 61 63 63 6F 72
       64 69 6E 67 20 74
       6F 20 64 65 63 69
       6D 61 6C 20 6E 75
       6D 62 65 72 29 0D
       0A
 38E4  6E 61 6D 65 69 20	db "namei <file name>      : return/print inode number of file (as decimal)", 0Dh, 0Ah 
       3C 66 69 6C 65 20
       6E 61 6D 65 3E 20
       20 20 20 20 20 3A
       20 72 65 74 75 72
       6E 2F 70 72 69 6E
       74 20 69 6E 6F 64
       65 20 6E 75 6D 62
       65 72 20 6F 66 20
       66 69 6C 65 20 28
       61 73 20 64 65 63
       69 6D 61 6C 29 0D
       0A
 392D  66 73 2F 76 6F 6C	db "fs/volume              : print (current) unix fs (super block) info", 0Dh, 0Ah
       75 6D 65 20 20 20
       20 20 20 20 20 20
       20 20 20 20 20 3A
       20 70 72 69 6E 74
       20 28 63 75 72 72
       65 6E 74 29 20 75
       6E 69 78 20 66 73
       20 28 73 75 70 65
       72 20 62 6C 6F 63
       6B 29 20 69 6E 66
       6F 0D 0A
 3972  62 6F 6F 74 66 69	db "bootfile <file name>   : select/configure file as startup/boot file", 0Dh, 0Ah
       6C 65 20 3C 66 69
       6C 65 20 6E 61 6D
       65 3E 20 20 20 3A
       20 73 65 6C 65 63
       74 2F 63 6F 6E 66
       69 67 75 72 65 20
       66 69 6C 65 20 61
       73 20 73 74 61 72
       74 75 70 2F 62 6F
       6F 74 20 66 69 6C
       65 0D 0A
 39B7  6E 6F 62 6F 6F 74	db "nobootfile             : reset/cancel bootfile configuration", 0Dh, 0Ah
       66 69 6C 65 20 20
       20 20 20 20 20 20
       20 20 20 20 20 3A
       20 72 65 73 65 74
       2F 63 61 6E 63 65
       6C 20 62 6F 6F 74
       66 69 6C 65 20 63
       6F 6E 66 69 67 75
       72 61 74 69 6F 6E
       0D 0A
 39F5  3F 2F 68 65 6C 70	db "?/help                 : print/display UNIXCOPY commands summary (as above)", 0Dh, 0Ah, 0
       20 20 20 20 20 20
       20 20 20 20 20 20
       20 20 20 20 20 3A
       20 70 72 69 6E 74
       2F 64 69 73 70 6C
       61 79 20 55 4E 49
       58 43 4F 50 59 20
       63 6F 6D 6D 61 6E
       64 73 20 73 75 6D
       6D 61 72 79 20 28
       61 73 20 61 62 6F
       76 65 29 0D 0A 00

				; 17/12/2019

				align 2

				; 01/12/2019
 3A44  00				db 0
				;PhysicalDriveNumber: ; 01/01/2020
 3A45				Drive:	; 03/12/2019
 3A45 00			buff_d: db 0
 3A46 FFFF			buff_s: dw 0FFFFh ; Buffer sector
 3A48  FFFF				dw 0FFFFh ; 19/10/2019 (32 bit sector address)
 3A4A 00			buff_m:	db 0 ; buffer changed/modified (dirty) flag
 3A4B 00			buff_w: db 0 ; read/write flag (write=1, read=0)
				;buff_c: dw 0 ; count ; 05/09/2019

				; 31/10/2012
 3A4C 0000			u_off:	dw 0
 3A4E  0000				dw 0 ; 08/12/2019  	
				; 12/08/2012
 3A50 0000			u_count: dw 0
 3A52 0000			u_base:	 dw 0
				;u_fofp: dw 0
 3A54 0000			u_nread: dw 0
					;dw 0 ; 01/01/2020

				; 01/09/2019
				;BLOCKDEV equ 61FFh ; 0110000111111111b
				;CHARDEV equ 21FFh  ; 0010000111111111b
				; 02/09/2019
				;REGULARDEF equ 81FFh ; 1000000111111111b

				; 15/09/2019	
				; 01/09/2019 - Retro UNIX v2 inode model (64 bytes)
				;	       (Modified UNIX v7 inode model)

				; 08/12/2019
				;bitpos: db 0

 3A56 00			Error: db 0 ; Hardware error
 3A57  00			       db 0 ; Software error

				; 05/01/2020
 3A58 00			bmod: db 0	  

 3A59 00			smod: db 0
 3A5A 00			imod: db 0
 3A5B 00			imodx: db 0 ; 24/12/2019

 3A5C 00			rw:   db 0 ; 24/12/2019

 3A5D  00			      db 0 ; 19/01/2020	 

 3A5E 0000			ii: dw 0

				; 07/11/2019
				;drive: db 0 ; 03/12/2019
				;rw: db 0

 3A60				dotodot:
 3A60  3030			dw 3030h
 3A62  68			db "h"
 3A63  0D 0A 00			db 0Dh, 0Ah, 0

				; 04/12/2019
				align 4
 3A68 00000000			level: dd 0  ; level, level+1, level+2, level+3 

				; 30/11/2019
 3A6C 00			I_rw: db 0     ; inode table read (0) or write (1)	
 3A6D 00			I_valid: db 0  ; inode table buffer is valid (1) or not (0)
 3A6E 0000			I_sector: dw 0 ; inode table sector index/offset

				align 4

				; 24/12/2019
				;inode:
				;inode_flgs: dw 0 ; file flag
				;i_nlks: dw 0 ; Number of links
				;i_uid:  dw 0 ; owner's user id 
				;i_gid:	db 0 ; owner's group id
				;inode_size_h: db 0 ; high byte of 5 bytes file size
				;inode_size: dd 0 ; file size
				;inode_dskp: dd 10 dup(0)  ; direct or indirect blocks
				;i_ltim: dd 0 ; last access time (or last inode modif. time)
				;i_mtim: dd 0 ; last (file) modification time 
				;i_ctim: dd 0 ; (file) creation time

				; 17/12/2019

 3A70 FFFF			save_ax:	dw 0FFFFh
 3A72 FFFF			save_dx:	dw 0FFFFh
				; 19/01/2020
 3A74 0000			save_cx:	dw 0
 3A76 0000			save_bx:	dw 0

				; 01/01/2020
 3A78 0000			d_off:	dw 0
 3A7A  0000				dw 0

				;data_start:	dd 0FFFFFFFFh
 3A7C 00000000			count:	dd 0	
 3A80 00000000			fm_sector:	dd 0
 3A84 0000			im_sector:	dw 0

				; 03/10/2019 - Retro UNIX 386 v2 - Hard Disk FS

 3A86  0000				dw 0 ; reserved (for alignment)

 3A88 0000			heads:	dw 0
 3A8A 0000			sectors:	dw 0 ; spt
 3A8C 0000			cylinders:	dw 0
 3A8E 00000000			hidden_sectors:	dd 0
 3A92 00000000			total_sectors:	dd 0
 3A96 00000000			file_size:	dd 0
 3A9A 00000000			pp_sectors:	dd 0
 3A9E 0000			min_sectors:	dw 0
 3AA0 00			lba_rw:	db 0
 3AA1  00				db 0 ; reserved (for alignment)

 3AA2 00000000			CHS_limit:	dd 0

				align 16

				;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
				;  buffers
				;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

 3AB0				boot_sector: ; 17/12/2019
 3AB0  0200 [			BSBUFFER:	db 512 dup(0)
        00
       ]
				; superblock
 3CB0				super_block: ; 17/12/2019
 3CB0  0200 [			systm: 	db 512 dup(0)
        00
       ]
					     ; 17/12/2019
 3EB0				Buffer:
 3EB0  0200 [			sector_buffer:	db 512 dup(0) ; Masterboot sector & common buffer
        00
       ]
					
					     ; 17/12/2019	
 40B0  0200 [			I_buffer:	db 512 dup(0) ; Inode table sector buffer
        00
       ]

 42B0  0200 [			ReadBuffer:     db 512 dup(0)
        00
       ]
 44B0  0200 [			WriteBuffer:    db 512 dup(0)
        00
       ]

				; 24/09/2019
 46B0  0200 [			im_buffer:	db 512 dup(0) ; Inode map sector buffer
        00
       ]
 48B0  0200 [			fbm_buffer:	db 512 dup(0) ; Free blocks map sector buffer
        00
       ]
 4AB0  0200 [			dbli_buffer:	db 512 dup(0)
        00
       ]
 4CB0  0200 [			trpi_buffer:	db 512 dup(0)
        00
       ]

 4EB0 = 00014E4C		SizeOfFile      equ $-100

 4EB0				UNIXCOPY  ends

				          end  START_CODE
Microsoft (R) Macro Assembler Version 6.14.8444		    07/20/22 01:12:18
unixhdcp.asm						     Symbols 2 - 1




Structures and Unions:

                N a m e                  Size
                                         Offset      Type

RUFS . . . . . . . . . . . . . .	 001A
  bsJumpCode . . . . . . . . . .	 0000	     Word
  bsFSystemID  . . . . . . . . .	 0002	     Byte
  bsVolumeSerial . . . . . . . .	 0006	     DWord
  bsDriveID  . . . . . . . . . .	 000A	     Word
  bsDriveNumber  . . . . . . . .	 000C	     Byte
  bsReserved . . . . . . . . . .	 000D	     Byte
  bsSecPerTrack  . . . . . . . .	 000E	     Byte
  bsHeads  . . . . . . . . . . .	 000F	     Byte
  bsCylinders  . . . . . . . . .	 0010	     Word
  bs_BF_I_number . . . . . . . .	 0012	     Word
  bsMagic  . . . . . . . . . . .	 0014	     Byte
  bsPartitionID  . . . . . . . .	 0015	     Byte
  bsHiddenSects  . . . . . . . .	 0016	     DWord
SuperBlock . . . . . . . . . . .	 0200
  sb_Header  . . . . . . . . . .	 0000	     DWord
  sb_BootSectAddr  . . . . . . .	 0004	     DWord
  sb_VolumeSize  . . . . . . . .	 0008	     DWord
  sb_Version . . . . . . . . . .	 000C	     DWord
  sb_BlockSize . . . . . . . . .	 0010	     DWord
  sb_InodeCount  . . . . . . . .	 0014	     DWord
  sb_FreeMapAddr . . . . . . . .	 0018	     DWord
  sb_FreeMapSize . . . . . . . .	 001C	     DWord
  sb_InodeMapAddr  . . . . . . .	 0020	     DWord
  sb_InodeMapSize  . . . . . . .	 0024	     DWord
  sb_InodeTblAddr  . . . . . . .	 0028	     DWord
  sb_InodeTblSize  . . . . . . .	 002C	     DWord
  sb_FreeInodes  . . . . . . . .	 0030	     DWord
  sb_FirstFreeIno  . . . . . . .	 0034	     DWord
  sb_FreeBlocks  . . . . . . . .	 0038	     DWord
  sb_FirstFreeBlk  . . . . . . .	 003C	     DWord
  sb_BootSecParms  . . . . . . .	 0040	     Byte
  sb_BSExtension . . . . . . . .	 0053	     Byte
  sb_Status  . . . . . . . . . .	 0058	     DWord
  sb_ModifTime . . . . . . . . .	 005C	     DWord
  sb_ExtdVolTbl  . . . . . . . .	 0060	     DWord
  sb_ExtdVolSize . . . . . . . .	 0064	     DWord
  sb_LBA_rw  . . . . . . . . . .	 0068	     Byte
  sb_ClusterSize . . . . . . . .	 0069	     Byte
  sb_ReadOnly  . . . . . . . . .	 006A	     Byte
  sb_Mounted . . . . . . . . . .	 006B	     Byte
  sb_MountInode  . . . . . . . .	 006C	     DWord
  sb_DevMajor  . . . . . . . . .	 0070	     Byte
  sb_DevMinor  . . . . . . . . .	 0071	     Byte
  sb_LongName  . . . . . . . . .	 0072	     Byte
  sb_Direntry32  . . . . . . . .	 0073	     Byte
  sb_Reserved  . . . . . . . . .	 0074	     Byte
  sb_Footer  . . . . . . . . . .	 01FC	     DWord
dinode . . . . . . . . . . . . .	 0040
  di_mode  . . . . . . . . . . .	 0000	     Word
  di_nlink . . . . . . . . . . .	 0002	     Word
  di_uid . . . . . . . . . . . .	 0004	     Word
  di_gid . . . . . . . . . . . .	 0006	     Byte
  dinode_size_h  . . . . . . . .	 0007	     Byte
  dinode_size  . . . . . . . . .	 0008	     DWord
  di_addr  . . . . . . . . . . .	 000C	     DWord
  di_atime . . . . . . . . . . .	 0034	     DWord
  di_mtime . . . . . . . . . . .	 0038	     DWord
  di_ctime . . . . . . . . . . .	 003C	     DWord


Segments and Groups:

                N a m e                 Size     Length   Align   Combine Class

UNIXCOPY . . . . . . . . . . . .	16 Bit	 4EB0	  Para	  Public  'CODE'	


Procedures,  parameters and locals:

                N a m e                 Type     Value    Attr

PRINT_MSG  . . . . . . . . . . .	P Near	 04E4	  UNIXCOPY	Length= 000F Private
alloc  . . . . . . . . . . . . .	P Near	 18C7	  UNIXCOPY	Length= 0176 Private
anyi . . . . . . . . . . . . . .	P Near	 13A9	  UNIXCOPY	Length= 0034 Private
check_hd_image_size  . . . . . .	P Near	 03CC	  UNIXCOPY	Length= 0118 Private
chgroup  . . . . . . . . . . . .	P Near	 263A	  UNIXCOPY	Length= 0008 Private
chmode . . . . . . . . . . . . .	P Near	 25AF	  UNIXCOPY	Length= 008B Private
chowner  . . . . . . . . . . . .	P Near	 2642	  UNIXCOPY	Length= 008E Private
clear  . . . . . . . . . . . . .	P Near	 1B50	  UNIXCOPY	Length= 0011 Private
command_interpreter  . . . . . .	P Near	 065A	  UNIXCOPY	Length= 0899 Private
convert_from_epoch . . . . . . .	P Near	 1F0B	  UNIXCOPY	Length= 007C Private
div32  . . . . . . . . . . . . .	P Near	 1F9B	  UNIXCOPY	Length= 000D Private
dskrd  . . . . . . . . . . . . .	P Near	 1CCD	  UNIXCOPY	Length= 00D2 Private
dskwr  . . . . . . . . . . . . .	P Near	 1CC6	  UNIXCOPY	Length= 0007 Private
dskw . . . . . . . . . . . . . .	P Near	 1BF9	  UNIXCOPY	Length= 00CD Private
epoch  . . . . . . . . . . . . .	P Near	 1E20	  UNIXCOPY	Length= 00EB Private
find_bfn . . . . . . . . . . . .	P Near	 2257	  UNIXCOPY	Length= 0041 Private
free . . . . . . . . . . . . . .	P Near	 1A3D	  UNIXCOPY	Length= 00C0 Private
get_runix_partition  . . . . . .	P Near	 0360	  UNIXCOPY	Length= 006C Private
icalc  . . . . . . . . . . . . .	P Near	 161D	  UNIXCOPY	Length= 0071 Private
iget . . . . . . . . . . . . . .	P Near	 15EC	  UNIXCOPY	Length= 0031 Private
image_file_rw  . . . . . . . . .	P Near	 1D9F	  UNIXCOPY	Length= 004B Private
imap . . . . . . . . . . . . . .	P Near	 23FE	  UNIXCOPY	Length= 0074 Private
itrunc . . . . . . . . . . . . .	P Near	 2472	  UNIXCOPY	Length= 00C6 Private
mak_nod  . . . . . . . . . . . .	P Near	 1204	  UNIXCOPY	Length= 00BC Private
make_directory . . . . . . . . .	P Near	 1B61	  UNIXCOPY	Length= 0048 Private
mget . . . . . . . . . . . . . .	P Near	 168E	  UNIXCOPY	Length= 0239 Private
mk_dir . . . . . . . . . . . . .	P Near	 1BA9	  UNIXCOPY	Length= 0045 Private
mul32  . . . . . . . . . . . . .	P Near	 1F87	  UNIXCOPY	Length= 0014 Private
namei  . . . . . . . . . . . . .	P Near	 1499	  UNIXCOPY	Length= 00AF Private
print_big_decimal_number . . . .	P Near	 2741	  UNIXCOPY	Length= 0040 Private
print_decimal_number . . . . . .	P Near	 26DB	  UNIXCOPY	Length= 0066 Private
print_directory_list . . . . . .	P Near	 0F6F	  UNIXCOPY	Length= 0222 Private
print_file_size  . . . . . . . .	P Near	 26D0	  UNIXCOPY	Length= 000B Private
print_volume_info  . . . . . . .	P Near	 2781	  UNIXCOPY	Length= 0079 Private
proc_bin_to_decimal  . . . . . .	P Near	 23DB	  UNIXCOPY	Length= 0023 Private
proc_display_startupfile_info  .	P Near	 2298	  UNIXCOPY	Length= 0143 Private
proc_hex_double  . . . . . . . .	P Near	 27FA	  UNIXCOPY	Length= 0039 Private
proc_hex . . . . . . . . . . . .	P Near	 04F3	  UNIXCOPY	Length= 0016 Private
proc_rw_char . . . . . . . . . .	P Near	 05D3	  UNIXCOPY	Length= 0087 Private
proc_start . . . . . . . . . . .	P Near	 0100	  UNIXCOPY	Length= 0241 Private
readi  . . . . . . . . . . . . .	P Near	 1548	  UNIXCOPY	Length= 00A4 Private
remove_directory . . . . . . . .	P Near	 12C0	  UNIXCOPY	Length= 00BB Private
set_firstfreeblock . . . . . . .	P Near	 21CE	  UNIXCOPY	Length= 0089 Private
set_firstfreeinode . . . . . . .	P Near	 2171	  UNIXCOPY	Length= 005D Private
set_hd_parms . . . . . . . . . .	P Near	 0341	  UNIXCOPY	Length= 001F Private
setimod  . . . . . . . . . . . .	P Near	 1AFD	  UNIXCOPY	Length= 0053 Private
show_file  . . . . . . . . . . .	P Near	 13DD	  UNIXCOPY	Length= 00BC Private
show_inode . . . . . . . . . . .	P Near	 2833	  UNIXCOPY	Length= 023F Private
sioreg . . . . . . . . . . . . .	P Near	 1DEA	  UNIXCOPY	Length= 0036 Private
sync . . . . . . . . . . . . . .	P Near	 1FA8	  UNIXCOPY	Length= 01C9 Private
sys_chdir  . . . . . . . . . . .	P Near	 1191	  UNIXCOPY	Length= 001F Private
sys_mkdir  . . . . . . . . . . .	P Near	 11B0	  UNIXCOPY	Length= 0054 Private
tloop  . . . . . . . . . . . . .	P Near	 2538	  UNIXCOPY	Length= 0077 Private
unix_prompt  . . . . . . . . . .	P Near	 0535	  UNIXCOPY	Length= 009E Private
unlink . . . . . . . . . . . . .	P Near	 137B	  UNIXCOPY	Length= 002E Private
update_cdir_string . . . . . . .	P Near	 0EF3	  UNIXCOPY	Length= 007C Private
writei . . . . . . . . . . . . .	P Near	 1BEE	  UNIXCOPY	Length= 000B Private


Symbols:

                N a m e                 Type     Value    Attr

@  . . . . . . . . . . . . . . .	L Near	 11E5	  UNIXCOPY	
A_15 . . . . . . . . . . . . . .	L Near	 0423	  UNIXCOPY	
A_16 . . . . . . . . . . . . . .	L Near	 0431	  UNIXCOPY	
A_17 . . . . . . . . . . . . . .	L Near	 043E	  UNIXCOPY	
A_18 . . . . . . . . . . . . . .	L Near	 045B	  UNIXCOPY	
A_19 . . . . . . . . . . . . . .	L Near	 0462	  UNIXCOPY	
A_20 . . . . . . . . . . . . . .	L Near	 04CD	  UNIXCOPY	
A_21 . . . . . . . . . . . . . .	L Near	 0474	  UNIXCOPY	
A_22 . . . . . . . . . . . . . .	L Near	 048B	  UNIXCOPY	
A_23 . . . . . . . . . . . . . .	L Near	 049C	  UNIXCOPY	
A_24 . . . . . . . . . . . . . .	L Near	 04A5	  UNIXCOPY	
A_25 . . . . . . . . . . . . . .	L Near	 04AB	  UNIXCOPY	
A_26 . . . . . . . . . . . . . .	L Near	 04B4	  UNIXCOPY	
A_27 . . . . . . . . . . . . . .	L Near	 0480	  UNIXCOPY	
A_28 . . . . . . . . . . . . . .	L Near	 0483	  UNIXCOPY	
BOOT_FILE_NAME . . . . . . . . .	L Near	 3025	  UNIXCOPY	
BSBUFFER . . . . . . . . . . . .	L Near	 3AB0	  UNIXCOPY	
B_04 . . . . . . . . . . . . . .	L Near	 043C	  UNIXCOPY	
Buffer . . . . . . . . . . . . .	L Near	 3EB0	  UNIXCOPY	
CDirOffset . . . . . . . . . . .	L Near	 2C46	  UNIXCOPY	
CHS_limit  . . . . . . . . . . .	L Near	 3AA2	  UNIXCOPY	
CRLF . . . . . . . . . . . . . .	L Near	 2A83	  UNIXCOPY	
CommandBuffer  . . . . . . . . .	L Near	 2C4B	  UNIXCOPY	
CursorColumn . . . . . . . . . .	L Near	 2C49	  UNIXCOPY	
DMonth . . . . . . . . . . . . .	L Near	 30A2	  UNIXCOPY	
DTA_Attrib . . . . . . . . . . .	Number	 0095h	 
DTA_Date . . . . . . . . . . . .	Number	 0098h	 
DTA_FileName . . . . . . . . . .	Number	 009Eh	 
DTA_FileSize . . . . . . . . . .	Number	 009Ah	 
DTA_Time . . . . . . . . . . . .	Number	 0096h	 
Decimal_i_no_str . . . . . . . .	L Near	 30D4	  UNIXCOPY	
Decimal_size_str . . . . . . . .	L Near	 30F8	  UNIXCOPY	
DirFileName  . . . . . . . . . .	L Near	 3024	  UNIXCOPY	
DotDot . . . . . . . . . . . . .	L Near	 31A0	  UNIXCOPY	
Dot  . . . . . . . . . . . . . .	L Near	 31A1	  UNIXCOPY	
Drive  . . . . . . . . . . . . .	L Near	 3A45	  UNIXCOPY	
Error  . . . . . . . . . . . . .	L Near	 3A56	  UNIXCOPY	
FileHandle . . . . . . . . . . .	L Near	 2A73	  UNIXCOPY	
I_buffer . . . . . . . . . . . .	L Near	 40B0	  UNIXCOPY	
I_rw . . . . . . . . . . . . . .	L Near	 3A6C	  UNIXCOPY	
I_sector . . . . . . . . . . . .	L Near	 3A6E	  UNIXCOPY	
I_valid  . . . . . . . . . . . .	L Near	 3A6D	  UNIXCOPY	
Msg_3dot_OK  . . . . . . . . . .	L Near	 2EB5	  UNIXCOPY	
Msg_DosFile_Name . . . . . . . .	L Near	 2E8B	  UNIXCOPY	
Msg_OK . . . . . . . . . . . . .	L Near	 2EB8	  UNIXCOPY	
Msg_Removing_file  . . . . . . .	L Near	 2E78	  UNIXCOPY	
Msg_StartupFile_Name . . . . . .	L Near	 2E9E	  UNIXCOPY	
Msg_writing_file . . . . . . . .	L Near	 2E66	  UNIXCOPY	
NotFound_msg . . . . . . . . . .	L Near	 325E	  UNIXCOPY	
PRINT_MSG_LOOP . . . . . . . . .	L Near	 04E9	  UNIXCOPY	
PRINT_MSG_OK . . . . . . . . . .	L Near	 04F2	  UNIXCOPY	
ROOT_DIR_INODE_NUMBER  . . . . .	Number	 0001h	 
ReadBuffer . . . . . . . . . . .	L Near	 42B0	  UNIXCOPY	
RetryCount . . . . . . . . . . .	L Near	 3012	  UNIXCOPY	
START_CODE . . . . . . . . . . .	L Near	 0100	  UNIXCOPY	
SizeOfFile . . . . . . . . . . .	Number	 00014E4Ch   
Str_Bytes  . . . . . . . . . . .	L Near	 30F1	  UNIXCOPY	
Str_aday . . . . . . . . . . . .	L Near	 317A	  UNIXCOPY	
Str_ahour  . . . . . . . . . . .	L Near	 3186	  UNIXCOPY	
Str_aminute  . . . . . . . . . .	L Near	 3189	  UNIXCOPY	
Str_amonth . . . . . . . . . . .	L Near	 317D	  UNIXCOPY	
Str_asecond  . . . . . . . . . .	L Near	 318C	  UNIXCOPY	
Str_ayear  . . . . . . . . . . .	L Near	 3180	  UNIXCOPY	
Str_cday . . . . . . . . . . . .	L Near	 311A	  UNIXCOPY	
Str_chour  . . . . . . . . . . .	L Near	 3126	  UNIXCOPY	
Str_cminute  . . . . . . . . . .	L Near	 3129	  UNIXCOPY	
Str_cmonth . . . . . . . . . . .	L Near	 311D	  UNIXCOPY	
Str_csecond  . . . . . . . . . .	L Near	 312C	  UNIXCOPY	
Str_cyear  . . . . . . . . . . .	L Near	 3120	  UNIXCOPY	
Str_mday . . . . . . . . . . . .	L Near	 314A	  UNIXCOPY	
Str_mhour  . . . . . . . . . . .	L Near	 3156	  UNIXCOPY	
Str_mminute  . . . . . . . . . .	L Near	 3159	  UNIXCOPY	
Str_mmonth . . . . . . . . . . .	L Near	 314D	  UNIXCOPY	
Str_msecond  . . . . . . . . . .	L Near	 315C	  UNIXCOPY	
Str_myear  . . . . . . . . . . .	L Near	 3150	  UNIXCOPY	
Str_sf_date_time . . . . . . . .	L Near	 30FE	  UNIXCOPY	
Str_startup_file_size  . . . . .	L Near	 30DA	  UNIXCOPY	
UNIXCOPY_Commands  . . . . . . .	L Near	 347E	  UNIXCOPY	
UNIX_CRLF  . . . . . . . . . . .	L Near	 2EE3	  UNIXCOPY	
UNIX_HD_Name . . . . . . . . . .	L Near	 2C1A	  UNIXCOPY	
UNIX_HD_Number . . . . . . . . .	L Near	 2C1C	  UNIXCOPY	
UNIX_Welcome . . . . . . . . . .	L Near	 2A86	  UNIXCOPY	
WriteBuffer  . . . . . . . . . .	L Near	 44B0	  UNIXCOPY	
alloc_0  . . . . . . . . . . . .	L Near	 18D4	  UNIXCOPY	
alloc_10 . . . . . . . . . . . .	L Near	 19BA	  UNIXCOPY	
alloc_11 . . . . . . . . . . . .	L Near	 19BE	  UNIXCOPY	
alloc_12 . . . . . . . . . . . .	L Near	 19D6	  UNIXCOPY	
alloc_13 . . . . . . . . . . . .	L Near	 19F1	  UNIXCOPY	
alloc_14 . . . . . . . . . . . .	L Near	 19FD	  UNIXCOPY	
alloc_15 . . . . . . . . . . . .	L Near	 1A22	  UNIXCOPY	
alloc_16 . . . . . . . . . . . .	L Near	 1A39	  UNIXCOPY	
alloc_17 . . . . . . . . . . . .	L Near	 194A	  UNIXCOPY	
alloc_18 . . . . . . . . . . . .	L Near	 19CD	  UNIXCOPY	
alloc_19 . . . . . . . . . . . .	L Near	 1997	  UNIXCOPY	
alloc_1  . . . . . . . . . . . .	L Near	 18F3	  UNIXCOPY	
alloc_20 . . . . . . . . . . . .	L Near	 196F	  UNIXCOPY	
alloc_2  . . . . . . . . . . . .	L Near	 18F7	  UNIXCOPY	
alloc_3  . . . . . . . . . . . .	L Near	 1908	  UNIXCOPY	
alloc_4  . . . . . . . . . . . .	L Near	 1918	  UNIXCOPY	
alloc_5  . . . . . . . . . . . .	L Near	 1943	  UNIXCOPY	
alloc_6  . . . . . . . . . . . .	L Near	 1965	  UNIXCOPY	
alloc_7  . . . . . . . . . . . .	L Near	 1969	  UNIXCOPY	
alloc_8  . . . . . . . . . . . .	L Near	 19AA	  UNIXCOPY	
alloc_9  . . . . . . . . . . . .	L Near	 19A7	  UNIXCOPY	
alloc_err  . . . . . . . . . . .	L Near	 18D2	  UNIXCOPY	
anyi_1 . . . . . . . . . . . . .	L Near	 13A9	  UNIXCOPY	
anyi_2 . . . . . . . . . . . . .	L Near	 13D8	  UNIXCOPY	
arg  . . . . . . . . . . . . . .	L Near	 2C9A	  UNIXCOPY	
blockdev . . . . . . . . . . . .	L Near	 108E	  UNIXCOPY	
bmod . . . . . . . . . . . . . .	L Near	 3A58	  UNIXCOPY	
boot_sector  . . . . . . . . . .	L Near	 3AB0	  UNIXCOPY	
bootfile_inode . . . . . . . . .	L Near	 303C	  UNIXCOPY	
buff_d . . . . . . . . . . . . .	L Near	 3A45	  UNIXCOPY	
buff_m . . . . . . . . . . . . .	L Near	 3A4A	  UNIXCOPY	
buff_s . . . . . . . . . . . . .	L Near	 3A46	  UNIXCOPY	
buff_w . . . . . . . . . . . . .	L Near	 3A4B	  UNIXCOPY	
cap_file_name0 . . . . . . . . .	L Near	 01FD	  UNIXCOPY	
cap_file_name1 . . . . . . . . .	L Near	 020C	  UNIXCOPY	
cap_file_name2 . . . . . . . . .	L Near	 020F	  UNIXCOPY	
cap_file_name3 . . . . . . . . .	L Near	 0218	  UNIXCOPY	
cap_file_name4 . . . . . . . . .	L Near	 0235	  UNIXCOPY	
cap_file_name  . . . . . . . . .	L Near	 01F6	  UNIXCOPY	
cg_og  . . . . . . . . . . . . .	L Near	 2647	  UNIXCOPY	
char_return  . . . . . . . . . .	L Near	 0622	  UNIXCOPY	
chardev  . . . . . . . . . . . .	L Near	 108A	  UNIXCOPY	
chdir_err  . . . . . . . . . . .	L Near	 07C5	  UNIXCOPY	
check_hdi_opt_loop . . . . . . .	L Near	 0198	  UNIXCOPY	
check_hdi_option . . . . . . . .	L Near	 0186	  UNIXCOPY	
check_runix_partition  . . . . .	L Near	 036D	  UNIXCOPY	
chgrp_err  . . . . . . . . . . .	L Near	 07C5	  UNIXCOPY	
chg  . . . . . . . . . . . . . .	L Near	 2641	  UNIXCOPY	
chk_image_file_features  . . . .	L Near	 0246	  UNIXCOPY	
chmod_err  . . . . . . . . . . .	L Near	 07C5	  UNIXCOPY	
chmode_1 . . . . . . . . . . . .	L Near	 25BB	  UNIXCOPY	
chmode_2 . . . . . . . . . . . .	L Near	 25D2	  UNIXCOPY	
chmode_3 . . . . . . . . . . . .	L Near	 25D3	  UNIXCOPY	
chmode_4 . . . . . . . . . . . .	L Near	 25DB	  UNIXCOPY	
chmode_5 . . . . . . . . . . . .	L Near	 25E4	  UNIXCOPY	
chmode_6 . . . . . . . . . . . .	L Near	 2611	  UNIXCOPY	
chmode_7 . . . . . . . . . . . .	L Near	 262C	  UNIXCOPY	
chmode_retn  . . . . . . . . . .	L Near	 25D1	  UNIXCOPY	
chmode_stc_retn  . . . . . . . .	L Near	 25D0	  UNIXCOPY	
chown_err  . . . . . . . . . . .	L Near	 07C5	  UNIXCOPY	
chowner_10 . . . . . . . . . . .	L Near	 26B7	  UNIXCOPY	
chowner_11 . . . . . . . . . . .	L Near	 26BB	  UNIXCOPY	
chowner_1  . . . . . . . . . . .	L Near	 2658	  UNIXCOPY	
chowner_2  . . . . . . . . . . .	L Near	 2663	  UNIXCOPY	
chowner_3  . . . . . . . . . . .	L Near	 266D	  UNIXCOPY	
chowner_4  . . . . . . . . . . .	L Near	 2675	  UNIXCOPY	
chowner_5  . . . . . . . . . . .	L Near	 2681	  UNIXCOPY	
chowner_6  . . . . . . . . . . .	L Near	 2689	  UNIXCOPY	
chowner_7  . . . . . . . . . . .	L Near	 268E	  UNIXCOPY	
chowner_8  . . . . . . . . . . .	L Near	 2693	  UNIXCOPY	
chowner_9  . . . . . . . . . . .	L Near	 26A7	  UNIXCOPY	
chowner_retn . . . . . . . . . .	L Near	 26CF	  UNIXCOPY	
chowner_stc_retn . . . . . . . .	L Near	 267F	  UNIXCOPY	
chs_err_retn . . . . . . . . . .	L Near	 1D45	  UNIXCOPY	
chs_ok . . . . . . . . . . . . .	L Near	 03CB	  UNIXCOPY	
chs_read_write . . . . . . . . .	L Near	 1D03	  UNIXCOPY	
chs_rw_ok  . . . . . . . . . . .	L Near	 1D4A	  UNIXCOPY	
ci_? . . . . . . . . . . . . . .	L Near	 0765	  UNIXCOPY	
ci_bf_namei  . . . . . . . . . .	L Near	 0E7C	  UNIXCOPY	
ci_cd_getarg . . . . . . . . . .	L Near	 078B	  UNIXCOPY	
ci_chdir_chk . . . . . . . . . .	L Near	 077B	  UNIXCOPY	
ci_chgrp_getarg  . . . . . . . .	L Near	 0801	  UNIXCOPY	
ci_chgrp_print . . . . . . . . .	L Near	 07C8	  UNIXCOPY	
ci_chmod_getarg  . . . . . . . .	L Near	 07B8	  UNIXCOPY	
ci_chmod_print . . . . . . . . .	L Near	 07C8	  UNIXCOPY	
ci_chown_getarg  . . . . . . . .	L Near	 07E0	  UNIXCOPY	
ci_chown_print . . . . . . . . .	L Near	 07C8	  UNIXCOPY	
ci_error . . . . . . . . . . . .	L Near	 0B02	  UNIXCOPY	
ci_iget_getarg . . . . . . . . .	L Near	 0749	  UNIXCOPY	
ci_mkdir_err . . . . . . . . . .	L Near	 0A1F	  UNIXCOPY	
ci_mkdir_getarg1 . . . . . . . .	L Near	 09B9	  UNIXCOPY	
ci_mkdir_getarg2 . . . . . . . .	L Near	 09C4	  UNIXCOPY	
ci_move_bfn_1  . . . . . . . . .	L Near	 0E66	  UNIXCOPY	
ci_move_bfn_2  . . . . . . . . .	L Near	 0E6F	  UNIXCOPY	
ci_move_bfn_3  . . . . . . . . .	L Near	 0E77	  UNIXCOPY	
ci_no_bootfile . . . . . . . . .	L Near	 0E58	  UNIXCOPY	
ci_rmdir_err . . . . . . . . . .	L Near	 0A1F	  UNIXCOPY	
ci_rmdir_getarg1 . . . . . . . .	L Near	 09F1	  UNIXCOPY	
ci_rmdir_getarg2 . . . . . . . .	L Near	 09FE	  UNIXCOPY	
ci_sync_err  . . . . . . . . . .	L Near	 0E63	  UNIXCOPY	
ci_sync_exit . . . . . . . . . .	L Near	 0E0E	  UNIXCOPY	
cl10 . . . . . . . . . . . . . .	L Near	 0EA9	  UNIXCOPY	
cl1  . . . . . . . . . . . . . .	L Near	 0B09	  UNIXCOPY	
cl2  . . . . . . . . . . . . . .	L Near	 0B2A	  UNIXCOPY	
cl3  . . . . . . . . . . . . . .	L Near	 0ACF	  UNIXCOPY	
cl4  . . . . . . . . . . . . . .	L Near	 065B	  UNIXCOPY	
cl5_or_above . . . . . . . . . .	L Near	 067B	  UNIXCOPY	
cl5  . . . . . . . . . . . . . .	L Near	 076B	  UNIXCOPY	
cl6  . . . . . . . . . . . . . .	L Near	 0C3B	  UNIXCOPY	
cl7  . . . . . . . . . . . . . .	L Near	 0C57	  UNIXCOPY	
cl8  . . . . . . . . . . . . . .	L Near	 0E20	  UNIXCOPY	
close_file_then_terminate  . . .	L Near	 01D5	  UNIXCOPY	
close_img_file . . . . . . . . .	L Near	 01DD	  UNIXCOPY	
cls  . . . . . . . . . . . . . .	L Near	 0B15	  UNIXCOPY	
convert_to_epoch . . . . . . . .	L Near	 1E8F	  UNIXCOPY	
count  . . . . . . . . . . . . .	L Near	 3A7C	  UNIXCOPY	
cylinders  . . . . . . . . . . .	L Near	 3A8C	  UNIXCOPY	
d_off  . . . . . . . . . . . . .	L Near	 3A78	  UNIXCOPY	
day  . . . . . . . . . . . . . .	L Near	 309A	  UNIXCOPY	
dbli_buffer  . . . . . . . . . .	L Near	 4AB0	  UNIXCOPY	
dec_num  . . . . . . . . . . . .	L Near	 3193	  UNIXCOPY	
dir_getarg . . . . . . . . . . .	L Near	 0AE6	  UNIXCOPY	
dir_namei  . . . . . . . . . . .	L Near	 0AF1	  UNIXCOPY	
dir_print  . . . . . . . . . . .	L Near	 0AFD	  UNIXCOPY	
diskio . . . . . . . . . . . . .	L Near	 1CD2	  UNIXCOPY	
dotodot  . . . . . . . . . . . .	L Near	 3A60	  UNIXCOPY	
drive_check_ok . . . . . . . . .	L Near	 0522	  UNIXCOPY	
drive_check  . . . . . . . . . .	L Near	 0509	  UNIXCOPY	
drive_not_ready  . . . . . . . .	L Near	 0518	  UNIXCOPY	
dskw_0 . . . . . . . . . . . . .	L Near	 1BF9	  UNIXCOPY	
dskw_10  . . . . . . . . . . . .	L Near	 1C3A	  UNIXCOPY	
dskw_11  . . . . . . . . . . . .	L Near	 1C5C	  UNIXCOPY	
dskw_12  . . . . . . . . . . . .	L Near	 1C71	  UNIXCOPY	
dskw_1 . . . . . . . . . . . . .	L Near	 1C40	  UNIXCOPY	
dskw_2 . . . . . . . . . . . . .	L Near	 1C86	  UNIXCOPY	
dskw_3 . . . . . . . . . . . . .	L Near	 1C9B	  UNIXCOPY	
dskw_4 . . . . . . . . . . . . .	L Near	 1C9E	  UNIXCOPY	
dskw_5 . . . . . . . . . . . . .	L Near	 1C97	  UNIXCOPY	
dskw_6 . . . . . . . . . . . . .	L Near	 1C92	  UNIXCOPY	
dskw_7 . . . . . . . . . . . . .	L Near	 1C31	  UNIXCOPY	
dskw_8 . . . . . . . . . . . . .	L Near	 1C14	  UNIXCOPY	
dskw_9 . . . . . . . . . . . . .	L Near	 1C34	  UNIXCOPY	
error_msg  . . . . . . . . . . .	L Near	 2EDA	  UNIXCOPY	
fbm_buffer . . . . . . . . . . .	L Near	 48B0	  UNIXCOPY	
file_attr_error  . . . . . . . .	L Near	 0290	  UNIXCOPY	
file_error_msg . . . . . . . . .	L Near	 2A75	  UNIXCOPY	
file_error . . . . . . . . . . .	L Near	 0230	  UNIXCOPY	
file_not_found_error . . . . . .	L Near	 028B	  UNIXCOPY	
file_size  . . . . . . . . . . .	L Near	 3A96	  UNIXCOPY	
find_bfn_err . . . . . . . . . .	L Near	 0E63	  UNIXCOPY	
fm_sector  . . . . . . . . . . .	L Near	 3A80	  UNIXCOPY	
free_1 . . . . . . . . . . . . .	L Near	 1A5C	  UNIXCOPY	
free_2 . . . . . . . . . . . . .	L Near	 1A87	  UNIXCOPY	
free_3 . . . . . . . . . . . . .	L Near	 1AA3	  UNIXCOPY	
free_4 . . . . . . . . . . . . .	L Near	 1AAE	  UNIXCOPY	
free_5 . . . . . . . . . . . . .	L Near	 1ADB	  UNIXCOPY	
free_6 . . . . . . . . . . . . .	L Near	 1AF0	  UNIXCOPY	
free_7 . . . . . . . . . . . . .	L Near	 1AFC	  UNIXCOPY	
fromdos_afow_input . . . . . . .	L Near	 0D0F	  UNIXCOPY	
fromdos_afow_no  . . . . . . . .	L Near	 0D25	  UNIXCOPY	
fromdos_afow_yes . . . . . . . .	L Near	 0D32	  UNIXCOPY	
fromdos_afow . . . . . . . . . .	L Near	 0CE2	  UNIXCOPY	
fromdos_cf_err . . . . . . . . .	L Near	 0DA4	  UNIXCOPY	
fromdos_cf . . . . . . . . . . .	L Near	 0DF7	  UNIXCOPY	
fromdos_df1  . . . . . . . . . .	L Near	 0C7C	  UNIXCOPY	
fromdos_df2  . . . . . . . . . .	L Near	 0C87	  UNIXCOPY	
fromdos_err  . . . . . . . . . .	L Near	 0CB3	  UNIXCOPY	
fromdos_fdf  . . . . . . . . . .	L Near	 0CA6	  UNIXCOPY	
fromdos_fuf  . . . . . . . . . .	L Near	 0CB6	  UNIXCOPY	
fromdos_maknod . . . . . . . . .	L Near	 1268	  UNIXCOPY	
fromdos_odf  . . . . . . . . . .	L Near	 0D98	  UNIXCOPY	
fromdos_of_err . . . . . . . . .	L Near	 0DA4	  UNIXCOPY	
fromdos_retn . . . . . . . . . .	L Near	 0E13	  UNIXCOPY	
fromdos_s_fs_mdt . . . . . . . .	L Near	 0D49	  UNIXCOPY	
fromdos_uf1  . . . . . . . . . .	L Near	 0C91	  UNIXCOPY	
fromdos_uf2  . . . . . . . . . .	L Near	 0C9C	  UNIXCOPY	
fromdos_uf_itrunc  . . . . . . .	L Near	 0D3E	  UNIXCOPY	
fromdos_wf_msg . . . . . . . . .	L Near	 0DC3	  UNIXCOPY	
fs_info_print  . . . . . . . . .	L Near	 0C37	  UNIXCOPY	
get_hdi_name_nxt_chr . . . . . .	L Near	 01A8	  UNIXCOPY	
get_hdi_name_ok  . . . . . . . .	L Near	 01BB	  UNIXCOPY	
get_hdi_name . . . . . . . . . .	L Near	 01A5	  UNIXCOPY	
ght  . . . . . . . . . . . . . .	L Near	 0DE8	  UNIXCOPY	
hd_img_file_rw_err . . . . . . .	L Near	 1DE0	  UNIXCOPY	
hd_img_file_rw_ok  . . . . . . .	L Near	 1DE5	  UNIXCOPY	
hd_img_file_rw . . . . . . . . .	L Near	 1DAD	  UNIXCOPY	
heads  . . . . . . . . . . . . .	L Near	 3A88	  UNIXCOPY	
hidden_sectors . . . . . . . . .	L Near	 3A8E	  UNIXCOPY	
hour . . . . . . . . . . . . . .	L Near	 309C	  UNIXCOPY	
icalc_0  . . . . . . . . . . . .	L Near	 164C	  UNIXCOPY	
icalc_1  . . . . . . . . . . . .	L Near	 165F	  UNIXCOPY	
icalc_2  . . . . . . . . . . . .	L Near	 167D	  UNIXCOPY	
icalc_3  . . . . . . . . . . . .	L Near	 1687	  UNIXCOPY	
icalc_4  . . . . . . . . . . . .	L Near	 168B	  UNIXCOPY	
icalc_5  . . . . . . . . . . . .	L Near	 168D	  UNIXCOPY	
iget_1 . . . . . . . . . . . . .	L Near	 15F2	  UNIXCOPY	
iget_2 . . . . . . . . . . . . .	L Near	 160D	  UNIXCOPY	
iget_3 . . . . . . . . . . . . .	L Near	 1618	  UNIXCOPY	
iget_4 . . . . . . . . . . . . .	L Near	 161C	  UNIXCOPY	
iget_5 . . . . . . . . . . . . .	L Near	 161C	  UNIXCOPY	
ii . . . . . . . . . . . . . . .	L Near	 3A5E	  UNIXCOPY	
im_buffer  . . . . . . . . . . .	L Near	 46B0	  UNIXCOPY	
im_sector  . . . . . . . . . . .	L Near	 3A84	  UNIXCOPY	
image_file_rw_err  . . . . . . .	L Near	 1DA5	  UNIXCOPY	
image_file_rw_ok . . . . . . . .	L Near	 1DAA	  UNIXCOPY	
imap_0 . . . . . . . . . . . . .	L Near	 2442	  UNIXCOPY	
imap_1 . . . . . . . . . . . . .	L Near	 2445	  UNIXCOPY	
imap_2 . . . . . . . . . . . . .	L Near	 244A	  UNIXCOPY	
imap_3 . . . . . . . . . . . . .	L Near	 2460	  UNIXCOPY	
imap_4 . . . . . . . . . . . . .	L Near	 246B	  UNIXCOPY	
imap_5 . . . . . . . . . . . . .	L Near	 2470	  UNIXCOPY	
img_file_handle  . . . . . . . .	L Near	 3022	  UNIXCOPY	
img_file_name  . . . . . . . . .	L Near	 3014	  UNIXCOPY	
imodx  . . . . . . . . . . . . .	L Near	 3A5B	  UNIXCOPY	
imod . . . . . . . . . . . . . .	L Near	 3A5A	  UNIXCOPY	
infinive_loop  . . . . . . . . .	L Near	 01E9	  UNIXCOPY	
inode_atim . . . . . . . . . . .	L Near	 3070	  UNIXCOPY	
inode_ctim . . . . . . . . . . .	L Near	 3078	  UNIXCOPY	
inode_dskp . . . . . . . . . . .	L Near	 3048	  UNIXCOPY	
inode_err  . . . . . . . . . . .	L Near	 0ACC	  UNIXCOPY	
inode_flgs . . . . . . . . . . .	L Near	 303C	  UNIXCOPY	
inode_getarg1  . . . . . . . . .	L Near	 0AAD	  UNIXCOPY	
inode_getarg2  . . . . . . . . .	L Near	 0ABB	  UNIXCOPY	
inode_gid  . . . . . . . . . . .	L Near	 3042	  UNIXCOPY	
inode_mtim . . . . . . . . . . .	L Near	 3074	  UNIXCOPY	
inode_nlks . . . . . . . . . . .	L Near	 303E	  UNIXCOPY	
inode_size_h . . . . . . . . . .	L Near	 3043	  UNIXCOPY	
inode_size . . . . . . . . . . .	L Near	 3044	  UNIXCOPY	
inode_uid  . . . . . . . . . . .	L Near	 3040	  UNIXCOPY	
inode  . . . . . . . . . . . . .	L Near	 303C	  UNIXCOPY	
invalid_disk_image_sector  . . .	L Near	 1DA4	  UNIXCOPY	
invalid_file_name  . . . . . . .	L Near	 0295	  UNIXCOPY	
invalid_image_file . . . . . . .	L Near	 0286	  UNIXCOPY	
itrunc_0 . . . . . . . . . . . .	L Near	 2480	  UNIXCOPY	
itrunc_1 . . . . . . . . . . . .	L Near	 2484	  UNIXCOPY	
itrunc_2 . . . . . . . . . . . .	L Near	 248E	  UNIXCOPY	
itrunc_3 . . . . . . . . . . . .	L Near	 24AE	  UNIXCOPY	
itrunc_4 . . . . . . . . . . . .	L Near	 24BD	  UNIXCOPY	
itrunc_5 . . . . . . . . . . . .	L Near	 24E1	  UNIXCOPY	
itrunc_6 . . . . . . . . . . . .	L Near	 2505	  UNIXCOPY	
itrunc_7 . . . . . . . . . . . .	L Near	 2505	  UNIXCOPY	
itrunc_8 . . . . . . . . . . . .	L Near	 252B	  UNIXCOPY	
itrunc_9 . . . . . . . . . . . .	L Near	 2483	  UNIXCOPY	
jump_back  . . . . . . . . . . .	L Near	 0233	  UNIXCOPY	
lba_err_retn . . . . . . . . . .	L Near	 1D45	  UNIXCOPY	
lba_not_ready  . . . . . . . . .	L Near	 1D5B	  UNIXCOPY	
lba_ok . . . . . . . . . . . . .	L Near	 03C5	  UNIXCOPY	
lba_read_again . . . . . . . . .	L Near	 1D62	  UNIXCOPY	
lba_read_write . . . . . . . . .	L Near	 1D4F	  UNIXCOPY	
lba_rw_ok  . . . . . . . . . . .	L Near	 1D4A	  UNIXCOPY	
lba_rw . . . . . . . . . . . . .	L Near	 3AA0	  UNIXCOPY	
level  . . . . . . . . . . . . .	L Near	 3A68	  UNIXCOPY	
link_df1 . . . . . . . . . . . .	L Near	 06D4	  UNIXCOPY	
link_df2 . . . . . . . . . . . .	L Near	 06DF	  UNIXCOPY	
link_err . . . . . . . . . . . .	L Near	 06EE	  UNIXCOPY	
link_fdf . . . . . . . . . . . .	L Near	 06F5	  UNIXCOPY	
link_fsf . . . . . . . . . . . .	L Near	 06E9	  UNIXCOPY	
link_sf0 . . . . . . . . . . . .	L Near	 06B4	  UNIXCOPY	
link_sf1 . . . . . . . . . . . .	L Near	 06BF	  UNIXCOPY	
link_sf2 . . . . . . . . . . . .	L Near	 06CA	  UNIXCOPY	
list_count . . . . . . . . . . .	L Near	 3191	  UNIXCOPY	
loc_arrow  . . . . . . . . . . .	L Near	 0616	  UNIXCOPY	
loc_back . . . . . . . . . . . .	L Near	 05E3	  UNIXCOPY	
loc_beep . . . . . . . . . . . .	L Near	 05EF	  UNIXCOPY	
loc_call_unix_prompt . . . . . .	L Near	 0335	  UNIXCOPY	
loc_cmd_bootfile . . . . . . . .	L Near	 0E28	  UNIXCOPY	
loc_cmd_cd . . . . . . . . . . .	L Near	 0B2F	  UNIXCOPY	
loc_cmd_chdir  . . . . . . . . .	L Near	 0773	  UNIXCOPY	
loc_cmd_chgrp  . . . . . . . . .	L Near	 07F2	  UNIXCOPY	
loc_cmd_chmod  . . . . . . . . .	L Near	 07A9	  UNIXCOPY	
loc_cmd_chown  . . . . . . . . .	L Near	 07D1	  UNIXCOPY	
loc_cmd_dir  . . . . . . . . . .	L Near	 0AD4	  UNIXCOPY	
loc_cmd_exit . . . . . . . . . .	L Near	 0665	  UNIXCOPY	
loc_cmd_fromdos  . . . . . . . .	L Near	 0C61	  UNIXCOPY	
loc_cmd_fs . . . . . . . . . . .	L Near	 0C2D	  UNIXCOPY	
loc_cmd_help . . . . . . . . . .	L Near	 0755	  UNIXCOPY	
loc_cmd_iget . . . . . . . . . .	L Near	 0739	  UNIXCOPY	
loc_cmd_inode  . . . . . . . . .	L Near	 0A98	  UNIXCOPY	
loc_cmd_link . . . . . . . . . .	L Near	 06AC	  UNIXCOPY	
loc_cmd_ls . . . . . . . . . . .	L Near	 0B3C	  UNIXCOPY	
loc_cmd_mkdir  . . . . . . . . .	L Near	 09A4	  UNIXCOPY	
loc_cmd_namei  . . . . . . . . .	L Near	 0A42	  UNIXCOPY	
loc_cmd_nobootfile . . . . . . .	L Near	 0EAE	  UNIXCOPY	
loc_cmd_rmdir  . . . . . . . . .	L Near	 09DC	  UNIXCOPY	
loc_cmd_rm . . . . . . . . . . .	L Near	 0B6C	  UNIXCOPY	
loc_cmd_show . . . . . . . . . .	L Near	 067E	  UNIXCOPY	
loc_cmd_todos  . . . . . . . . .	L Near	 0813	  UNIXCOPY	
loc_cmd_volume . . . . . . . . .	L Near	 0C40	  UNIXCOPY	
loc_escape . . . . . . . . . . .	L Near	 0654	  UNIXCOPY	
loc_find_bfn_1 . . . . . . . . .	L Near	 226B	  UNIXCOPY	
loc_find_bfn_2 . . . . . . . . .	L Near	 2295	  UNIXCOPY	
loc_find_bfn_3 . . . . . . . . .	L Near	 2290	  UNIXCOPY	
loc_find_bfn_retn  . . . . . . .	L Near	 2293	  UNIXCOPY	
loc_get_args . . . . . . . . . .	L Near	 0120	  UNIXCOPY	
loc_hd_copy_10 . . . . . . . . .	L Near	 02FD	  UNIXCOPY	
loc_hd_copy_11 . . . . . . . . .	L Near	 0303	  UNIXCOPY	
loc_hd_copy_12 . . . . . . . . .	L Near	 02A7	  UNIXCOPY	
loc_hd_copy_14 . . . . . . . . .	L Near	 02DE	  UNIXCOPY	
loc_hd_copy_1  . . . . . . . . .	L Near	 0127	  UNIXCOPY	
loc_hd_copy_2  . . . . . . . . .	L Near	 012D	  UNIXCOPY	
loc_hd_copy_3  . . . . . . . . .	L Near	 0148	  UNIXCOPY	
loc_hd_copy_4  . . . . . . . . .	L Near	 0165	  UNIXCOPY	
loc_hd_copy_5  . . . . . . . . .	L Near	 0167	  UNIXCOPY	
loc_hd_copy_6  . . . . . . . . .	L Near	 01C0	  UNIXCOPY	
loc_hd_copy_7  . . . . . . . . .	L Near	 017F	  UNIXCOPY	
loc_hd_copy_8  . . . . . . . . .	L Near	 01E4	  UNIXCOPY	
loc_hd_copy_9  . . . . . . . . .	L Near	 029F	  UNIXCOPY	
loc_hd_copy_err  . . . . . . . .	L Near	 02DB	  UNIXCOPY	
loc_rediv_NumberInput  . . . . .	L Near	 23E8	  UNIXCOPY	
loc_reset_str_NumberInput  . . .	L Near	 23DB	  UNIXCOPY	
loc_unix_welcome . . . . . . . .	L Near	 01EB	  UNIXCOPY	
loc_writeit  . . . . . . . . . .	L Near	 060C	  UNIXCOPY	
loop_popcx_NumberInput . . . . .	L Near	 23F5	  UNIXCOPY	
ls_getarg1 . . . . . . . . . . .	L Near	 0B4B	  UNIXCOPY	
ls_getarg2 . . . . . . . . . . .	L Near	 0B52	  UNIXCOPY	
ls_getarg3 . . . . . . . . . . .	L Near	 0AED	  UNIXCOPY	
ls_getarg4 . . . . . . . . . . .	L Near	 0B5B	  UNIXCOPY	
ls_option  . . . . . . . . . . .	L Near	 3192	  UNIXCOPY	
makdir_1 . . . . . . . . . . . .	L Near	 11B6	  UNIXCOPY	
makdir_2 . . . . . . . . . . . .	L Near	 11C3	  UNIXCOPY	
makdir_3 . . . . . . . . . . . .	L Near	 11D8	  UNIXCOPY	
makdir_4 . . . . . . . . . . . .	L Near	 11EB	  UNIXCOPY	
maknod_1 . . . . . . . . . . . .	L Near	 120C	  UNIXCOPY	
maknod_2 . . . . . . . . . . . .	L Near	 1223	  UNIXCOPY	
maknod_3 . . . . . . . . . . . .	L Near	 1222	  UNIXCOPY	
maknod_4 . . . . . . . . . . . .	L Near	 1286	  UNIXCOPY	
mget_0 . . . . . . . . . . . . .	L Near	 168E	  UNIXCOPY	
mget_10  . . . . . . . . . . . .	L Near	 17C1	  UNIXCOPY	
mget_11  . . . . . . . . . . . .	L Near	 17F1	  UNIXCOPY	
mget_12  . . . . . . . . . . . .	L Near	 1828	  UNIXCOPY	
mget_13  . . . . . . . . . . . .	L Near	 1829	  UNIXCOPY	
mget_14  . . . . . . . . . . . .	L Near	 182E	  UNIXCOPY	
mget_15  . . . . . . . . . . . .	L Near	 184A	  UNIXCOPY	
mget_16  . . . . . . . . . . . .	L Near	 1856	  UNIXCOPY	
mget_17  . . . . . . . . . . . .	L Near	 1872	  UNIXCOPY	
mget_18  . . . . . . . . . . . .	L Near	 187E	  UNIXCOPY	
mget_19  . . . . . . . . . . . .	L Near	 18B8	  UNIXCOPY	
mget_1 . . . . . . . . . . . . .	L Near	 16F2	  UNIXCOPY	
mget_20  . . . . . . . . . . . .	L Near	 1818	  UNIXCOPY	
mget_21  . . . . . . . . . . . .	L Near	 18A9	  UNIXCOPY	
mget_22  . . . . . . . . . . . .	L Near	 18B2	  UNIXCOPY	
mget_23  . . . . . . . . . . . .	L Near	 18B3	  UNIXCOPY	
mget_2 . . . . . . . . . . . . .	L Near	 170B	  UNIXCOPY	
mget_3 . . . . . . . . . . . . .	L Near	 170C	  UNIXCOPY	
mget_4 . . . . . . . . . . . . .	L Near	 1730	  UNIXCOPY	
mget_5 . . . . . . . . . . . . .	L Near	 1742	  UNIXCOPY	
mget_6 . . . . . . . . . . . . .	L Near	 16C7	  UNIXCOPY	
mget_7 . . . . . . . . . . . . .	L Near	 16C7	  UNIXCOPY	
mget_8 . . . . . . . . . . . . .	L Near	 1772	  UNIXCOPY	
mget_9 . . . . . . . . . . . . .	L Near	 1797	  UNIXCOPY	
min_sectors  . . . . . . . . . .	L Near	 3A9E	  UNIXCOPY	
minute . . . . . . . . . . . . .	L Near	 309E	  UNIXCOPY	
mkdir_0  . . . . . . . . . . . .	L Near	 1BA9	  UNIXCOPY	
mkdir_1  . . . . . . . . . . . .	L Near	 1BBA	  UNIXCOPY	
mkdir_2  . . . . . . . . . . . .	L Near	 1BD0	  UNIXCOPY	
mkdir_inc_nlinks . . . . . . . .	L Near	 1BA2	  UNIXCOPY	
mkdir_stc  . . . . . . . . . . .	L Near	 1BCC	  UNIXCOPY	
month  . . . . . . . . . . . . .	L Near	 3098	  UNIXCOPY	
msgINumber . . . . . . . . . . .	L Near	 326E	  UNIXCOPY	
msgVol_Size_Hdr  . . . . . . . .	L Near	 3208	  UNIXCOPY	
msgVol_free_icount_Hdr . . . . .	L Near	 324C	  UNIXCOPY	
msgVol_freeblocks_Hdr  . . . . .	L Near	 3221	  UNIXCOPY	
msgVol_icount_Hdr  . . . . . . .	L Near	 323A	  UNIXCOPY	
msgVolume_Info . . . . . . . . .	L Near	 31A3	  UNIXCOPY	
msgVolume_Serial . . . . . . . .	L Near	 31FB	  UNIXCOPY	
msgVolume_Size . . . . . . . . .	L Near	 3217	  UNIXCOPY	
msgVolume_free_icount  . . . . .	L Near	 325B	  UNIXCOPY	
msgVolume_freeblocks . . . . . .	L Near	 3230	  UNIXCOPY	
msgVolume_icount . . . . . . . .	L Near	 3249	  UNIXCOPY	
msg_NO . . . . . . . . . . . . .	L Near	 2EC4	  UNIXCOPY	
msg_Startup_File_Not_Exists  . .	L Near	 2F4A	  UNIXCOPY	
msg_YES  . . . . . . . . . . . .	L Near	 2EBF	  UNIXCOPY	
msg_arg  . . . . . . . . . . . .	L Near	 2C98	  UNIXCOPY	
msg_disk_rw_error  . . . . . . .	L Near	 2EC8	  UNIXCOPY	
msg_drive_not_ready  . . . . . .	L Near	 2CA9	  UNIXCOPY	
msg_error_Number . . . . . . . .	L Near	 2EE6	  UNIXCOPY	
msg_file_attr_error  . . . . . .	L Near	 2D0F	  UNIXCOPY	
msg_file_not_found . . . . . . .	L Near	 2D6D	  UNIXCOPY	
msg_inode_details  . . . . . . .	L Near	 327F	  UNIXCOPY	
msg_inv_file_name  . . . . . . .	L Near	 2CCC	  UNIXCOPY	
msg_inv_image_file . . . . . . .	L Near	 2DA9	  UNIXCOPY	
msg_inv_partition  . . . . . . .	L Near	 2E03	  UNIXCOPY	
msg_making_directory . . . . . .	L Near	 2EF8	  UNIXCOPY	
msg_not_runix_fs . . . . . . . .	L Near	 2E33	  UNIXCOPY	
msg_overwrite_question1  . . . .	L Near	 2FCA	  UNIXCOPY	
msg_overwrite_question2  . . . .	L Near	 2FE7	  UNIXCOPY	
msg_remove_question1 . . . . . .	L Near	 2FEF	  UNIXCOPY	
msg_remove_question2 . . . . . .	L Near	 3009	  UNIXCOPY	
msg_removing_directory . . . . .	L Near	 2F0E	  UNIXCOPY	
msg_sf_configuration_reset_ok  .	L Near	 2F9E	  UNIXCOPY	
msg_sf_configuration_set_ok  . .	L Near	 2F74	  UNIXCOPY	
msg_unix_drv_read_error  . . . .	L Near	 2CA9	  UNIXCOPY	
msg_unix_drv_write_error . . . .	L Near	 2F26	  UNIXCOPY	
msg_yes_no . . . . . . . . . . .	L Near	 2C9E	  UNIXCOPY	
namei_0  . . . . . . . . . . . .	L Near	 14B0	  UNIXCOPY	
namei_1  . . . . . . . . . . . .	L Near	 14B5	  UNIXCOPY	
namei_2  . . . . . . . . . . . .	L Near	 14DB	  UNIXCOPY	
namei_3  . . . . . . . . . . . .	L Near	 1516	  UNIXCOPY	
namei_4  . . . . . . . . . . . .	L Near	 1532	  UNIXCOPY	
namei_5  . . . . . . . . . . . .	L Near	 153C	  UNIXCOPY	
namei_6  . . . . . . . . . . . .	L Near	 14C1	  UNIXCOPY	
namei_7  . . . . . . . . . . . .	L Near	 14C4	  UNIXCOPY	
namei_8  . . . . . . . . . . . .	L Near	 1547	  UNIXCOPY	
namei_err  . . . . . . . . . . .	L Near	 0A1F	  UNIXCOPY	
namei_fsf  . . . . . . . . . . .	L Near	 0A6C	  UNIXCOPY	
namei_iget . . . . . . . . . . .	L Near	 0A7D	  UNIXCOPY	
namei_print_inum . . . . . . . .	L Near	 0A80	  UNIXCOPY	
namei_sf1  . . . . . . . . . . .	L Near	 0A57	  UNIXCOPY	
namei_sf2  . . . . . . . . . . .	L Near	 0A62	  UNIXCOPY	
namei_x  . . . . . . . . . . . .	L Near	 149D	  UNIXCOPY	
new_bf_err . . . . . . . . . . .	L Near	 0E63	  UNIXCOPY	
norotal  . . . . . . . . . . . .	L Near	 052B	  UNIXCOPY	
norotar  . . . . . . . . . . . .	L Near	 0534	  UNIXCOPY	
not_masterboot . . . . . . . . .	L Near	 0368	  UNIXCOPY	
not_runix_partition  . . . . . .	L Near	 037D	  UNIXCOPY	
open_image_file  . . . . . . . .	L Near	 023A	  UNIXCOPY	
pass_cc_ah . . . . . . . . . . .	L Near	 0508	  UNIXCOPY	
pass_cc_al . . . . . . . . . . .	L Near	 0500	  UNIXCOPY	
pass_escape  . . . . . . . . . .	L Near	 0645	  UNIXCOPY	
pddn0  . . . . . . . . . . . . .	L Near	 2741	  UNIXCOPY	
pddn_14  . . . . . . . . . . . .	L Near	 276D	  UNIXCOPY	
pddn_itoa  . . . . . . . . . . .	L Near	 2759	  UNIXCOPY	
pddn_putc  . . . . . . . . . . .	L Near	 2734	  UNIXCOPY	
pdir . . . . . . . . . . . . . .	L Near	 2C96	  UNIXCOPY	
pdl_0  . . . . . . . . . . . . .	L Near	 0F73	  UNIXCOPY	
pdl_10 . . . . . . . . . . . . .	L Near	 1025	  UNIXCOPY	
pdl_11 . . . . . . . . . . . . .	L Near	 0FFD	  UNIXCOPY	
pdl_12 . . . . . . . . . . . . .	L Near	 114E	  UNIXCOPY	
pdl_13 . . . . . . . . . . . . .	L Near	 1029	  UNIXCOPY	
pdl_14 . . . . . . . . . . . . .	L Near	 1027	  UNIXCOPY	
pdl_15 . . . . . . . . . . . . .	L Near	 116A	  UNIXCOPY	
pdl_16 . . . . . . . . . . . . .	L Near	 1174	  UNIXCOPY	
pdl_18 . . . . . . . . . . . . .	L Near	 1051	  UNIXCOPY	
pdl_1  . . . . . . . . . . . . .	L Near	 0F89	  UNIXCOPY	
pdl_2  . . . . . . . . . . . . .	L Near	 0F8D	  UNIXCOPY	
pdl_3  . . . . . . . . . . . . .	L Near	 0F98	  UNIXCOPY	
pdl_4  . . . . . . . . . . . . .	L Near	 0FC0	  UNIXCOPY	
pdl_5  . . . . . . . . . . . . .	L Near	 0FC9	  UNIXCOPY	
pdl_6  . . . . . . . . . . . . .	L Near	 0FD1	  UNIXCOPY	
pdl_7  . . . . . . . . . . . . .	L Near	 0FE2	  UNIXCOPY	
pdl_8  . . . . . . . . . . . . .	L Near	 1157	  UNIXCOPY	
pdl_9  . . . . . . . . . . . . .	L Near	 1189	  UNIXCOPY	
pdn0 . . . . . . . . . . . . . .	L Near	 26DD	  UNIXCOPY	
pdn_14 . . . . . . . . . . . . .	L Near	 271E	  UNIXCOPY	
pdn_itoa . . . . . . . . . . . .	L Near	 26F9	  UNIXCOPY	
pdn_putc . . . . . . . . . . . .	L Near	 2734	  UNIXCOPY	
pfn_itoa . . . . . . . . . . . .	L Near	 270A	  UNIXCOPY	
phexdbl_1  . . . . . . . . . . .	L Near	 2818	  UNIXCOPY	
phexdbl_2  . . . . . . . . . . .	L Near	 2820	  UNIXCOPY	
phexdbl_3  . . . . . . . . . . .	L Near	 2829	  UNIXCOPY	
phexdbl_4  . . . . . . . . . . .	L Near	 2831	  UNIXCOPY	
pp_sectors . . . . . . . . . . .	L Near	 3A9A	  UNIXCOPY	
prev_column  . . . . . . . . . .	L Near	 05F7	  UNIXCOPY	
program_exit . . . . . . . . . .	L Near	 2C95	  UNIXCOPY	
putc . . . . . . . . . . . . . .	L Near	 118A	  UNIXCOPY	
read_next_char . . . . . . . . .	L Near	 05D3	  UNIXCOPY	
readinode_1  . . . . . . . . . .	L Near	 1554	  UNIXCOPY	
readinode_2  . . . . . . . . . .	L Near	 158B	  UNIXCOPY	
readinode_3  . . . . . . . . . .	L Near	 156B	  UNIXCOPY	
readinode_4  . . . . . . . . . .	L Near	 156D	  UNIXCOPY	
readinode_5  . . . . . . . . . .	L Near	 156A	  UNIXCOPY	
readinode_6  . . . . . . . . . .	L Near	 15A7	  UNIXCOPY	
readinode_7  . . . . . . . . . .	L Near	 15BC	  UNIXCOPY	
readinode_8  . . . . . . . . . .	L Near	 15C8	  UNIXCOPY	
readinode_retn . . . . . . . . .	L Near	 156C	  UNIXCOPY	
readinode_sioreg . . . . . . . .	L Near	 15D7	  UNIXCOPY	
regular_f  . . . . . . . . . . .	L Near	 1099	  UNIXCOPY	
regular  . . . . . . . . . . . .	L Near	 1092	  UNIXCOPY	
reset_ok . . . . . . . . . . . .	L Near	 0509	  UNIXCOPY	
rm_a_no  . . . . . . . . . . . .	L Near	 0C03	  UNIXCOPY	
rm_a_yes . . . . . . . . . . . .	L Near	 0C10	  UNIXCOPY	
rm_chr3  . . . . . . . . . . . .	L Near	 0B74	  UNIXCOPY	
rm_err . . . . . . . . . . . . .	L Near	 0BBD	  UNIXCOPY	
rm_getarg  . . . . . . . . . . .	L Near	 0B79	  UNIXCOPY	
rm_move_fn . . . . . . . . . . .	L Near	 0BC0	  UNIXCOPY	
rm_namei . . . . . . . . . . . .	L Near	 0B84	  UNIXCOPY	
rm_unlink  . . . . . . . . . . .	L Near	 0C1C	  UNIXCOPY	
rm_yn_input  . . . . . . . . . .	L Near	 0BED	  UNIXCOPY	
rmdir_1  . . . . . . . . . . . .	L Near	 12F9	  UNIXCOPY	
rmdir_readi_loop . . . . . . . .	L Near	 1301	  UNIXCOPY	
rmdir_stc_retn . . . . . . . . .	L Near	 12F7	  UNIXCOPY	
rmdir_unlink . . . . . . . . . .	L Near	 1350	  UNIXCOPY	
rotashftl  . . . . . . . . . . .	L Near	 0525	  UNIXCOPY	
rotashftr  . . . . . . . . . . .	L Near	 052E	  UNIXCOPY	
runix_partition_error  . . . . .	L Near	 0181	  UNIXCOPY	
runix_partition_ok . . . . . . .	L Near	 037F	  UNIXCOPY	
rwxugo . . . . . . . . . . . . .	L Near	 10A8	  UNIXCOPY	
rw . . . . . . . . . . . . . . .	L Near	 3A5C	  UNIXCOPY	
save_ax  . . . . . . . . . . . .	L Near	 3A70	  UNIXCOPY	
save_bx  . . . . . . . . . . . .	L Near	 3A76	  UNIXCOPY	
save_cx  . . . . . . . . . . . .	L Near	 3A74	  UNIXCOPY	
save_dx  . . . . . . . . . . . .	L Near	 3A72	  UNIXCOPY	
sb_HiddenSects . . . . . . . . .	Text   	 sb_BootSecAddr
sb_TotalSects  . . . . . . . . .	Text   	 sb_VolumeSize
second . . . . . . . . . . . . .	L Near	 30A0	  UNIXCOPY	
sector_buffer  . . . . . . . . .	L Near	 3EB0	  UNIXCOPY	
sectors  . . . . . . . . . . . .	L Near	 3A8A	  UNIXCOPY	
set_cursor_pos . . . . . . . . .	L Near	 05F9	  UNIXCOPY	
setimod_1  . . . . . . . . . . .	L Near	 1B13	  UNIXCOPY	
setimod_2  . . . . . . . . . . .	L Near	 1B20	  UNIXCOPY	
setimod_3  . . . . . . . . . . .	L Near	 1B31	  UNIXCOPY	
setimod_4  . . . . . . . . . . .	L Near	 1B2E	  UNIXCOPY	
setimod_5  . . . . . . . . . . .	L Near	 1B27	  UNIXCOPY	
setimod_6  . . . . . . . . . . .	L Near	 1B1F	  UNIXCOPY	
sffb_1 . . . . . . . . . . . . .	L Near	 21F1	  UNIXCOPY	
sffb_2 . . . . . . . . . . . . .	L Near	 2200	  UNIXCOPY	
sffb_3 . . . . . . . . . . . . .	L Near	 2205	  UNIXCOPY	
sffb_4 . . . . . . . . . . . . .	L Near	 220D	  UNIXCOPY	
sffb_5 . . . . . . . . . . . . .	L Near	 2219	  UNIXCOPY	
sffb_6 . . . . . . . . . . . . .	L Near	 221A	  UNIXCOPY	
sffb_7 . . . . . . . . . . . . .	L Near	 222A	  UNIXCOPY	
sffb_8 . . . . . . . . . . . . .	L Near	 2233	  UNIXCOPY	
sffb_9 . . . . . . . . . . . . .	L Near	 223E	  UNIXCOPY	
sffi_1 . . . . . . . . . . . . .	L Near	 2186	  UNIXCOPY	
sffi_2 . . . . . . . . . . . . .	L Near	 2195	  UNIXCOPY	
sffi_3 . . . . . . . . . . . . .	L Near	 219A	  UNIXCOPY	
sffi_4 . . . . . . . . . . . . .	L Near	 21A9	  UNIXCOPY	
sffi_5 . . . . . . . . . . . . .	L Near	 21AA	  UNIXCOPY	
sffi_6 . . . . . . . . . . . . .	L Near	 21BB	  UNIXCOPY	
shl32  . . . . . . . . . . . . .	L Near	 0523	  UNIXCOPY	
show_indir_bn  . . . . . . . . .	L Near	 28F6	  UNIXCOPY	
show_inode_1 . . . . . . . . . .	L Near	 283C	  UNIXCOPY	
show_inode_2 . . . . . . . . . .	L Near	 2847	  UNIXCOPY	
show_inode_3 . . . . . . . . . .	L Near	 284B	  UNIXCOPY	
show_inode_4 . . . . . . . . . .	L Near	 284F	  UNIXCOPY	
show_inode_5 . . . . . . . . . .	L Near	 2859	  UNIXCOPY	
show_inode_6 . . . . . . . . . .	L Near	 286B	  UNIXCOPY	
show_inode_7 . . . . . . . . . .	L Near	 2883	  UNIXCOPY	
show_inode_retn  . . . . . . . .	L Near	 2858	  UNIXCOPY	
show_inode_stc_retn  . . . . . .	L Near	 2857	  UNIXCOPY	
show_uf1 . . . . . . . . . . . .	L Near	 068E	  UNIXCOPY	
show_uf2 . . . . . . . . . . . .	L Near	 0699	  UNIXCOPY	
show_uf3 . . . . . . . . . . . .	L Near	 06A3	  UNIXCOPY	
show_uf_err  . . . . . . . . . .	L Near	 06A8	  UNIXCOPY	
shr32  . . . . . . . . . . . . .	L Near	 052C	  UNIXCOPY	
smod . . . . . . . . . . . . . .	L Near	 3A59	  UNIXCOPY	
str_err  . . . . . . . . . . . .	L Near	 2EF2	  UNIXCOPY	
str_inode_number . . . . . . . .	L Near	 30BA	  UNIXCOPY	
suf_0  . . . . . . . . . . . . .	L Near	 1407	  UNIXCOPY	
suf_10 . . . . . . . . . . . . .	L Near	 147E	  UNIXCOPY	
suf_11 . . . . . . . . . . . . .	L Near	 1488	  UNIXCOPY	
suf_12 . . . . . . . . . . . . .	L Near	 1492	  UNIXCOPY	
suf_13 . . . . . . . . . . . . .	L Near	 1474	  UNIXCOPY	
suf_14 . . . . . . . . . . . . .	L Near	 1479	  UNIXCOPY	
suf_1  . . . . . . . . . . . . .	L Near	 1409	  UNIXCOPY	
suf_2  . . . . . . . . . . . . .	L Near	 1416	  UNIXCOPY	
suf_3  . . . . . . . . . . . . .	L Near	 1437	  UNIXCOPY	
suf_4  . . . . . . . . . . . . .	L Near	 1443	  UNIXCOPY	
suf_5  . . . . . . . . . . . . .	L Near	 1449	  UNIXCOPY	
suf_6  . . . . . . . . . . . . .	L Near	 144C	  UNIXCOPY	
suf_7  . . . . . . . . . . . . .	L Near	 1458	  UNIXCOPY	
suf_8  . . . . . . . . . . . . .	L Near	 145C	  UNIXCOPY	
suf_9  . . . . . . . . . . . . .	L Near	 1460	  UNIXCOPY	
super_block  . . . . . . . . . .	L Near	 3CB0	  UNIXCOPY	
sync_0 . . . . . . . . . . . . .	L Near	 1FD0	  UNIXCOPY	
sync_10  . . . . . . . . . . . .	L Near	 20E6	  UNIXCOPY	
sync_11  . . . . . . . . . . . .	L Near	 20F0	  UNIXCOPY	
sync_12  . . . . . . . . . . . .	L Near	 2105	  UNIXCOPY	
sync_13  . . . . . . . . . . . .	L Near	 2110	  UNIXCOPY	
sync_14  . . . . . . . . . . . .	L Near	 2129	  UNIXCOPY	
sync_15  . . . . . . . . . . . .	L Near	 2133	  UNIXCOPY	
sync_16  . . . . . . . . . . . .	L Near	 2142	  UNIXCOPY	
sync_17  . . . . . . . . . . . .	L Near	 215A	  UNIXCOPY	
sync_18  . . . . . . . . . . . .	L Near	 204D	  UNIXCOPY	
sync_19  . . . . . . . . . . . .	L Near	 2079	  UNIXCOPY	
sync_1 . . . . . . . . . . . . .	L Near	 2023	  UNIXCOPY	
sync_20  . . . . . . . . . . . .	L Near	 20FE	  UNIXCOPY	
sync_21  . . . . . . . . . . . .	L Near	 2170	  UNIXCOPY	
sync_22  . . . . . . . . . . . .	L Near	 2086	  UNIXCOPY	
sync_2 . . . . . . . . . . . . .	L Near	 2032	  UNIXCOPY	
sync_3 . . . . . . . . . . . . .	L Near	 2037	  UNIXCOPY	
sync_4 . . . . . . . . . . . . .	L Near	 203C	  UNIXCOPY	
sync_5 . . . . . . . . . . . . .	L Near	 2051	  UNIXCOPY	
sync_6 . . . . . . . . . . . . .	L Near	 2064	  UNIXCOPY	
sync_7 . . . . . . . . . . . . .	L Near	 206A	  UNIXCOPY	
sync_8 . . . . . . . . . . . . .	L Near	 20D2	  UNIXCOPY	
sync_9 . . . . . . . . . . . . .	L Near	 20E1	  UNIXCOPY	
syschdir_0 . . . . . . . . . . .	L Near	 1191	  UNIXCOPY	
syschdir_1 . . . . . . . . . . .	L Near	 1196	  UNIXCOPY	
syschdir_2 . . . . . . . . . . .	L Near	 119B	  UNIXCOPY	
syschdir_3 . . . . . . . . . . .	L Near	 11A7	  UNIXCOPY	
syschdir_4 . . . . . . . . . . .	L Near	 11AB	  UNIXCOPY	
syschdir_5 . . . . . . . . . . .	L Near	 11AF	  UNIXCOPY	
sysmkdir_0 . . . . . . . . . . .	L Near	 11DC	  UNIXCOPY	
sysmkdir_1 . . . . . . . . . . .	L Near	 11E6	  UNIXCOPY	
sysmkdir_flags . . . . . . . . .	L Near	 11FB	  UNIXCOPY	
sysmkdir_maknod  . . . . . . . .	L Near	 11FE	  UNIXCOPY	
systm  . . . . . . . . . . . . .	L Near	 3CB0	  UNIXCOPY	
terminate  . . . . . . . . . . .	L Near	 01E1	  UNIXCOPY	
tloop_10 . . . . . . . . . . . .	L Near	 2581	  UNIXCOPY	
tloop_1  . . . . . . . . . . . .	L Near	 255A	  UNIXCOPY	
tloop_2  . . . . . . . . . . . .	L Near	 255D	  UNIXCOPY	
tloop_3  . . . . . . . . . . . .	L Near	 2565	  UNIXCOPY	
tloop_4  . . . . . . . . . . . .	L Near	 258A	  UNIXCOPY	
tloop_5  . . . . . . . . . . . .	L Near	 2591	  UNIXCOPY	
tloop_6  . . . . . . . . . . . .	L Near	 25A3	  UNIXCOPY	
tloop_7  . . . . . . . . . . . .	L Near	 2585	  UNIXCOPY	
tloop_8  . . . . . . . . . . . .	L Near	 2587	  UNIXCOPY	
tloop_9  . . . . . . . . . . . .	L Near	 25A8	  UNIXCOPY	
todos_afow_input . . . . . . . .	L Near	 0896	  UNIXCOPY	
todos_afow_no  . . . . . . . . .	L Near	 08AC	  UNIXCOPY	
todos_afow_yes . . . . . . . . .	L Near	 08B9	  UNIXCOPY	
todos_afow . . . . . . . . . . .	L Near	 087E	  UNIXCOPY	
todos_cdf  . . . . . . . . . . .	L Near	 093F	  UNIXCOPY	
todos_chk_err  . . . . . . . . .	L Near	 086E	  UNIXCOPY	
todos_crdf . . . . . . . . . . .	L Near	 08C5	  UNIXCOPY	
todos_df1  . . . . . . . . . . .	L Near	 0840	  UNIXCOPY	
todos_df2  . . . . . . . . . . .	L Near	 084B	  UNIXCOPY	
todos_err1 . . . . . . . . . . .	L Near	 085A	  UNIXCOPY	
todos_err2 . . . . . . . . . . .	L Near	 08DC	  UNIXCOPY	
todos_fdf  . . . . . . . . . . .	L Near	 0861	  UNIXCOPY	
todos_fuf  . . . . . . . . . . .	L Near	 0855	  UNIXCOPY	
todos_iget . . . . . . . . . . .	L Near	 08ED	  UNIXCOPY	
todos_odf  . . . . . . . . . . .	L Near	 08D0	  UNIXCOPY	
todos_read_unix_sf_1 . . . . . .	L Near	 08F9	  UNIXCOPY	
todos_read_unix_sf_2 . . . . . .	L Near	 0914	  UNIXCOPY	
todos_retn . . . . . . . . . . .	L Near	 0997	  UNIXCOPY	
todos_ruf_wdf  . . . . . . . . .	L Near	 08DF	  UNIXCOPY	
todos_set_dfdt . . . . . . . . .	L Near	 0942	  UNIXCOPY	
todos_uf0  . . . . . . . . . . .	L Near	 081B	  UNIXCOPY	
todos_uf1  . . . . . . . . . . .	L Near	 082B	  UNIXCOPY	
todos_uf2  . . . . . . . . . . .	L Near	 0836	  UNIXCOPY	
todos_wf_msg . . . . . . . . . .	L Near	 08E7	  UNIXCOPY	
total_sectors  . . . . . . . . .	L Near	 3A92	  UNIXCOPY	
trpi_buffer  . . . . . . . . . .	L Near	 4CB0	  UNIXCOPY	
txt_device . . . . . . . . . . .	L Near	 344B	  UNIXCOPY	
txt_inode_aday . . . . . . . . .	L Near	 33CC	  UNIXCOPY	
txt_inode_ahour  . . . . . . . .	L Near	 33D7	  UNIXCOPY	
txt_inode_aminute  . . . . . . .	L Near	 33DA	  UNIXCOPY	
txt_inode_amonth . . . . . . . .	L Near	 33CF	  UNIXCOPY	
txt_inode_asecond  . . . . . . .	L Near	 33DD	  UNIXCOPY	
txt_inode_atim_h . . . . . . . .	L Near	 33C0	  UNIXCOPY	
txt_inode_ayear  . . . . . . . .	L Near	 33D2	  UNIXCOPY	
txt_inode_cday . . . . . . . . .	L Near	 3434	  UNIXCOPY	
txt_inode_chour  . . . . . . . .	L Near	 343F	  UNIXCOPY	
txt_inode_cminute  . . . . . . .	L Near	 3442	  UNIXCOPY	
txt_inode_cmonth . . . . . . . .	L Near	 3437	  UNIXCOPY	
txt_inode_csecond  . . . . . . .	L Near	 3445	  UNIXCOPY	
txt_inode_ctim_h . . . . . . . .	L Near	 3428	  UNIXCOPY	
txt_inode_cyear  . . . . . . . .	L Near	 343A	  UNIXCOPY	
txt_inode_dskp_i . . . . . . . .	L Near	 3395	  UNIXCOPY	
txt_inode_dskp . . . . . . . . .	L Near	 3344	  UNIXCOPY	
txt_inode_flags_b  . . . . . . .	L Near	 32CA	  UNIXCOPY	
txt_inode_flags_h  . . . . . . .	L Near	 32C3	  UNIXCOPY	
txt_inode_gid  . . . . . . . . .	L Near	 330E	  UNIXCOPY	
txt_inode_mday . . . . . . . . .	L Near	 3402	  UNIXCOPY	
txt_inode_mhour  . . . . . . . .	L Near	 340D	  UNIXCOPY	
txt_inode_mminute  . . . . . . .	L Near	 3410	  UNIXCOPY	
txt_inode_mmonth . . . . . . . .	L Near	 3405	  UNIXCOPY	
txt_inode_msecond  . . . . . . .	L Near	 3413	  UNIXCOPY	
txt_inode_mtim_h . . . . . . . .	L Near	 33F6	  UNIXCOPY	
txt_inode_myear  . . . . . . . .	L Near	 3408	  UNIXCOPY	
txt_inode_nlks . . . . . . . . .	L Near	 32EB	  UNIXCOPY	
txt_inode_number . . . . . . . .	L Near	 32B2	  UNIXCOPY	
txt_inode_size_h . . . . . . . .	L Near	 331D	  UNIXCOPY	
txt_inode_size . . . . . . . . .	L Near	 3329	  UNIXCOPY	
txt_inode_uid  . . . . . . . . .	L Near	 32FC	  UNIXCOPY	
txt_major  . . . . . . . . . . .	L Near	 3464	  UNIXCOPY	
txt_minor  . . . . . . . . . . .	L Near	 3478	  UNIXCOPY	
type_27h . . . . . . . . . . . .	L Near	 2AFA	  UNIXCOPY	
u_base . . . . . . . . . . . . .	L Near	 3A52	  UNIXCOPY	
u_cdir . . . . . . . . . . . . .	L Near	 307E	  UNIXCOPY	
u_count  . . . . . . . . . . . .	L Near	 3A50	  UNIXCOPY	
u_dirbuf . . . . . . . . . . . .	L Near	 3086	  UNIXCOPY	
u_dirp . . . . . . . . . . . . .	L Near	 3082	  UNIXCOPY	
u_gid  . . . . . . . . . . . . .	L Near	 307D	  UNIXCOPY	
u_namep  . . . . . . . . . . . .	L Near	 3080	  UNIXCOPY	
u_nread  . . . . . . . . . . . .	L Near	 3A54	  UNIXCOPY	
u_off  . . . . . . . . . . . . .	L Near	 3A4C	  UNIXCOPY	
u_uid  . . . . . . . . . . . . .	L Near	 307C	  UNIXCOPY	
ucds_0 . . . . . . . . . . . . .	L Near	 0EF3	  UNIXCOPY	
ucds_1 . . . . . . . . . . . . .	L Near	 0F29	  UNIXCOPY	
ucds_2 . . . . . . . . . . . . .	L Near	 0F38	  UNIXCOPY	
ucds_3 . . . . . . . . . . . . .	L Near	 0F4F	  UNIXCOPY	
ucds_4 . . . . . . . . . . . . .	L Near	 0F4C	  UNIXCOPY	
ucds_5 . . . . . . . . . . . . .	L Near	 0F59	  UNIXCOPY	
ucds_6 . . . . . . . . . . . . .	L Near	 0F17	  UNIXCOPY	
ucds_7 . . . . . . . . . . . . .	L Near	 0F6A	  UNIXCOPY	
ucds_8 . . . . . . . . . . . . .	L Near	 0F16	  UNIXCOPY	
ucds_9 . . . . . . . . . . . . .	L Near	 0F64	  UNIXCOPY	
uf_i_number  . . . . . . . . . .	L Near	 3038	  UNIXCOPY	
uf_make_datetime . . . . . . . .	L Near	 3034	  UNIXCOPY	
unix_cdir  . . . . . . . . . . .	L Near	 2C20	  UNIXCOPY	
unix_cdrv  . . . . . . . . . . .	L Near	 2C1A	  UNIXCOPY	
unix_img_cdir  . . . . . . . . .	L Near	 2C1F	  UNIXCOPY	
unix_prompt_0  . . . . . . . . .	L Near	 0535	  UNIXCOPY	
unix_prompt_10 . . . . . . . . .	L Near	 059B	  UNIXCOPY	
unix_prompt_11 . . . . . . . . .	L Near	 05AB	  UNIXCOPY	
unix_prompt_12 . . . . . . . . .	L Near	 05AE	  UNIXCOPY	
unix_prompt_13 . . . . . . . . .	L Near	 05C2	  UNIXCOPY	
unix_prompt_14 . . . . . . . . .	L Near	 05D2	  UNIXCOPY	
unix_prompt_15 . . . . . . . . .	L Near	 055C	  UNIXCOPY	
unix_prompt_1  . . . . . . . . .	L Near	 0553	  UNIXCOPY	
unix_prompt_2  . . . . . . . . .	L Near	 0559	  UNIXCOPY	
unix_prompt_3  . . . . . . . . .	L Near	 055F	  UNIXCOPY	
unix_prompt_4  . . . . . . . . .	L Near	 0564	  UNIXCOPY	
unix_prompt_5  . . . . . . . . .	L Near	 056C	  UNIXCOPY	
unix_prompt_6  . . . . . . . . .	L Near	 0578	  UNIXCOPY	
unix_prompt_7  . . . . . . . . .	L Near	 0589	  UNIXCOPY	
unix_prompt_8  . . . . . . . . .	L Near	 0591	  UNIXCOPY	
unix_prompt_9  . . . . . . . . .	L Near	 0599	  UNIXCOPY	
unix_prompt_char . . . . . . . .	L Near	 2C48	  UNIXCOPY	
usage  . . . . . . . . . . . . .	L Near	 2B1F	  UNIXCOPY	
valid_hd_image . . . . . . . . .	L Near	 029A	  UNIXCOPY	
valid_masterboot . . . . . . . .	L Near	 036A	  UNIXCOPY	
vol_infO_print . . . . . . . . .	L Near	 0C37	  UNIXCOPY	
wdir . . . . . . . . . . . . . .	L Near	 1BDE	  UNIXCOPY	
write_1  . . . . . . . . . . . .	L Near	 1BF9	  UNIXCOPY	
year . . . . . . . . . . . . . .	L Near	 3096	  UNIXCOPY	

	   0 Warnings
	   0 Errors
