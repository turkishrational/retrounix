Microsoft (R) Macro Assembler Version 6.14.8444		    07/20/22 00:25:48
unixhdfs.asm						     Page 1 - 1


				; ****************************************************************************
				; UNIXHDFS.ASM
				; ----------------------------------------------------------------------------
				; RETRO UNIX v0.3 - Modified UNIX v7 inode model - 02/10/2019
				;
				; RETRO UNIX 8086 (Retro Unix == Turkish Rational Unix)
				; Operating System Project (v0.1) by ERDOGAN TAN (Beginning: 11/07/2012) 
				; 1.44 MB Floppy Disk 
				; Bootable Unix (RUFS) File System Installation/Formatting Code 
				;
				; Derived from UNIXFDFS.ASM (for 1.44MB floppies) - 30/09/2019 (Retro UNIX v2)
				;
				; Last Modification: 20/07/2022 (Retro UNIX 386 v2)
				; UNIXFDFS.ASM -> Last Modification: 04/12/2015 (Retro UNIX 386 v1)
				;
				; Derivation from UNIX Operating System (v1.0 for PDP-11) 
				; (Original) Source Code by Ken Thompson (1971-1972)
				; <Bell Laboratories (17/3/1972)>
				; <Preliminary Release of UNIX Implementation Document>
				;
				; ----------------------------------------------------------------------------
				; masm unixhdfs.asm unixhdfs.obj unixhdfs.lst
				; link /t unixfdfs
				; ****************************************************************************

				; 20/07/2022
				; 13/04/2022
				; 05/04/2022
				; 23/01/2020
				; 03/10/2019
				; 05/09/2019 Retro UNIX 386 v2 (Modified UNIX v7 inode model)

				; 04/12/2015 Retro UNIX 386 v1 (14 byte file names)
				; 21/04/2014 (tty8=COM1, tty9=COM2)
				; 22/12/2013
				; 09/07/2013

				; (Retro Unix File System) Hard Disk Boot Sector Parameters (03/10/2019)
				;
				;jmp short @f 	       ; db EBh, 13h ; db 0EBh, 18h ; 19/12/2019
				; 03/12/2019
				;bsFSystemID	equ 2  ; db 'RUFS'
				;bsVolumeSerial	equ 6  ; dd 0
				;		       ; db 'hd'
				;bsDriveNumber	equ 12 ; db 0
				;bsReserved	equ 13 ; db 0  ; 512 bytes per sector
				;bsSecPerTrack	equ 14 ; db 63 (17)
				;bsHeads	equ 15 ; db 16 (2,4,8,16,32,64,128,255)
				;bsTracks	equ 16 ; dw 1023 (1 to 1023) ; bsCylinders
				;bs_BF_I_number	equ 18 ; dw 0
				;bsMagic	equ 20 ; db '@'
				;bsPartitionID  equ 21 ; db 71h
				;bsHiddenSects  equ 22 ; dd 0 ; Hidden sectors (Boot Sector LBA)
				; @@:	 		

				; 19/12/2019 - Retro UNIX 386 v2 HD (071h) partition boot sector
				; 04/12/2019
 001A				RUFS struc
				;bsJumpCode    dw ? ; 0EB, 13h ; jmp short @f
 0000  0000			bsJumpCode     dw ? ; 0EB, 18h ; 19/12/2019  	
 0002  0004 [			bsFSystemID    db 4 dup(?)  ;'RUFS'
        00
       ]
 0006  00000000			bsVolumeSerial dd ?
 000A  0000			bsDriveID      dw ? ; 'hd'
 000C  00			bsDriveNumber  db ? ; 80h
 000D  00			bsReserved     db ? ; 0 = 512 bytes/sector CHS, 1 = LBA
 000E  00			bsSecPerTrack  db ? ; 63,17
 000F  00			bsHeads        db ? ; 8 to 255 (may be 2 to 255) 
 0010  0000			bsCylinders    dw ? ; 1 to 1024 (bsTracks)
 0012  0000			bs_BF_I_number dw 0 ; startup (boot) file inode number
 0014  00			bsMagic        db ? ; '@' ; magic byte !
 0015  00			bsPartitionID  db ? ; 71h, Retro UNIX 386 partition/volume ; 19/12/2019
 0016  00000000			bsHiddenSects  dd 0 ; Hidden sectors (Boot Sector LBA) ; 19/12/2019
				;;@@:
				RUFS ends ; 26 bytes of boot sector parms with short jmp code (19/12/2019)

				; 03/10/2019
				;NOTE: If byte [bsReserved] = 1, it means LBA read/write is needed..
				;			(bytes per sector is still 512)
				;      If byte [bsReserved] = 2 -may be in future- bytes per sector is 2048
				;			(LBA r/w is certainly needed for 2048 bytes/sector)

				; 14/01/2020 - Super Block modification :
				;	     - Extended sections/divisions (consequental sectors)
				;	     - (for swapping, configuration, boot space etc.)	
				; 21/12/2019
				; 19/12/2019 (UNIXHDFS.COM, RUFSHDI.ASM)
				; 01/09/2019 - Retro UNIX 386 v2 SuperBlock

 0200				SuperBlock struc

 0000  00000000			sb_Header	dd ?
 0004  00000000			sb_BootSectAddr dd ?  ; Hidden Sectors
 0008  00000000			sb_VolumeSize	dd ?  ; Entire Volume/Partition Size (includes ext. volume)	
 000C  00000000			sb_Version	dd ?
 0010  00000000			sb_BlockSize	dd ?
 0014  00000000			sb_InodeCount	dd ? 	
 0018  00000000			sb_FreeMapAddr	dd ?
 001C  00000000			sb_FreeMapSize  dd ?
 0020  00000000			sb_InodeMapAddr	dd ?
 0024  00000000			sb_InodeMapSize dd ?
 0028  00000000			sb_InodeTblAddr dd ?
 002C  00000000			sb_InodeTblSize dd ?
 0030  00000000			sb_FreeInodes	dd ?
 0034  00000000			sb_FirstFreeIno dd ?
 0038  00000000			sb_FreeBlocks	dd ?
 003C  00000000			sb_FirstFreeBlk dd ?
 0040  0013 [			sb_BootSecParms db 19 dup(?) ; v1 ; 19/12/2019
        00
       ]
 0053  0005 [			sb_BSExtension	db 5 dup(?) ; v2 HDFS ; 19/12/2019
        00
       ]
 0058  00000000			sb_Status	dd ? ; 19/12/2019
 005C  00000000			sb_ModifTime	dd ?
 0060  00000000			sb_ExtdVolTbl	dd 0 ; 14/01/2020 ; Extended Volume Start/Table Address
 0064  00000000			sb_ExtdVolSize	dd 0 ; 14/01/2020 ; Extended Volume (swap section etc.) Size	
 0068  00			sb_LBA_rw	db 0 ; 03/10/2019
 0069  00			sb_ClusterSize	db 0 ; 03/10/2019
 006A  00			sb_ReadOnly	db 0 ; 03/10/2019
 006B  00			sb_Mounted	db 0 ; 03/10/2019
 006C  00000000			sb_MountInode	dd 0 ; 03/10/2019
 0070  00			sb_DevMajor	db 0 ; 03/10/2019
 0071  00			sb_DevMinor	db 0 ; 03/10/2019
 0072  00			sb_LongName	db 0 ; 03/10/2019
 0073  00			sb_Direntry32	db 0 ; 03/10/2019
 0074  0188 [			sb_Reserved	db 508-116 dup(?) ; Must be 0 for current RUFS version
        00
       ]
 01FC  00000000			sb_Footer	dd ?

				SuperBlock ends

				; 14/01/2020
 = sb_BootSecAddr		sb_HiddenSects equ sb_BootSecAddr
 = sb_VolumeSize		sb_TotalSects equ sb_VolumeSize

 0000				RUFS_INSTL      SEGMENT PUBLIC 'CODE'
						assume cs:RUFS_INSTL,ds:RUFS_INSTL,es:RUFS_INSTL,ss:RUFS_INSTL

 0000				rufs_hd_format proc near
						; 04/12/2019
						; 04/12/2015
						; 28/10/2012
						; 19/09/2012
						; 14/08/2012
						; 13/08/2012
						; 12/08/2012

						org 100h
 0100				INSTALL:
						; 05/09/2019
 0100  BB 30EE R			        mov bx, SizeOfFile+100
 0103  83 C3 0F			                add bx, 15
 0106  D1 EB			                shr bx, 1
 0108  D1 EB			        	shr bx, 1
 010A  D1 EB					shr bx, 1
 010C  D1 EB					shr bx, 1
 010E  B4 4A			                mov ah, 4Ah ; modify memory allocation
				               ;push cs
				               ;pop es
 0110  CD 21			                int 21h 

				;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
				; see if drive specified
				;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

 0112  BE 0080					mov si, offset 80h		; PSP command tail
						;mov cl, byte ptr [SI]
 0115  AC					lodsb
 0116  8A C8					mov cl, al
 0118  0A C9					or cl, cl                               
						;jz rufs_hd_format_7		; jump if zero
						; 05/04/2022
 011A  75 03					jnz short @f
 011C  E9 0084					jmp rufs_hd_format_7
 011F				@@:
						; 05/09/2019

						;inc si
 011F				get_args:
 011F  AC					lodsb
 0120  3C 20					cmp al, ' '
 0122  77 06					ja short rufs_hd_format_1
 0124  FE C9					dec cl
 0126  75 F7					jnz short get_args
 0128  EB 79					jmp short rufs_hd_format_7

 012A				rufs_hd_format_1:
 012A  3C 2D					cmp al, '-'
 012C  75 03					jne short rufs_hd_format_2
 012E  E9 0087					jmp check_hdi_option ; 04/12/2019
					
 0131				rufs_hd_format_2:
 0131  3C 68					cmp al, 'h'
 0133  75 1A					jne short rufs_hd_format_3
						;inc si
						;mov al, byte ptr [SI]
 0135  AC					lodsb
 0136  3C 64					cmp al, 'd'
 0138  75 69					jne short rufs_hd_format_7
						;inc si
						;mov ax, word ptr [SI]
 013A  AD					lodsw
 013B  3C 30					cmp al, '0'                            
 013D  72 64					jb short rufs_hd_format_7
 013F  3C 33					cmp al, '3'
 0141  77 60					ja short rufs_hd_format_7
 0143  80 FC 20					cmp ah, 20h
 0146  77 5B					ja short rufs_hd_format_7
 0148  A2 29FC R				mov byte ptr [RUFS_DRIVE], al
 014B  2C 30					sub al, '0'
 014D  EB 17					jmp short rufs_hd_format_5

 014F				rufs_hd_format_3:
 014F  3C 43					cmp al, 'C'
 0151  72 50					jb short rufs_hd_format_7
 0153  3C 46					cmp al, 'F'                             ; A - Z
 0155  76 0A					jna short rufs_hd_format_4                    
 0157  3C 63					cmp al, 'c'                             ; a - z 
 0159  72 48					jb short rufs_hd_format_7                 
 015B  3C 66					cmp al, 'f'                           
 015D  77 44					ja short rufs_hd_format_7                 

 015F  2C 20					sub al, 'a'-'A'                         ; to upper case

				;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
				; Write message
				;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

 0161				rufs_hd_format_4:
 0161  A2 29FC R				mov byte ptr [RUFS_DRIVE], al
 0164  2C 43					sub al, 'C'                             ; make it zero based 

 0166				rufs_hd_format_5:
 0166  04 80					add al, 80h ; 02/10/2019
 0168  8A D0					mov dl, al
 016A  88 16 2B44 R				mov byte ptr [boot_sector.bsDriveNumber], dl ; 04/12/2019
						; 06/09/2019
 016E  A2 09FF R				mov byte ptr [buff_d], al
						;mov byte ptr [drive], al ; 03/12/2019

						; 09/09/2019
						; Read boot sector to understand drive is ready or not?
 0171  E8 0367					call drive_check
						; (we will not return here if cf = 1)
						; If cf = 0, we will return here

						;mov dl, byte ptr [buff_d]
 0174  B4 08					mov ah, 08h
 0176  CD 13					int 13h                                 ; return disk parameters
 0178  0E					push cs
 0179  07					pop es                                  ; restore es
						;;jc rufs_hd_format_17
						;jc rufs_hd_format_13 ; 06/09/2019
						; 05/04/2022
 017A  73 03					jnc short @f
 017C  E9 009B					jmp rufs_hd_format_13	
 017F				@@:
						; 02/10/2019
 017F  E8 018A					call set_hd_parms

						; 03/10/2019
 0182				rufs_hd_format_img:
 0182  E8 01A6					call get_runix_partition
 0185  72 2C					jc short runix_partition_error

						;;	

 0187  BE 2988 R				mov si, offset Msg_DoYouWantToFormat
 018A  E8 0329					call PRINT_MSG
 018D				rufs_hd_format_6:
 018D  33 C0					xor ax, ax
 018F  CD 16					int 16h                                 ; wait for keyboard command
 0191  3C 03					cmp al, 'C'-40h
 0193  74 14					je short rufs_hd_format_8              
 0195  3C 1B					cmp al, 27
 0197  74 10					je short rufs_hd_format_8
 0199  24 DF					and al, 0DFh
 019B  3C 59					cmp al, 'Y'                             ; Yes?
 019D  74 5A					je short rufs_hd_format_10             ; write
 019F  3C 4E					cmp al, 'N'                             ; No?
 01A1  74 34					je short rufs_hd_format_9              ; no write (exit)
 01A3				rufs_hd_format_7:
 01A3  BE 2838 R				mov si, offset UNIX_Welcome
 01A6  E8 030D					call PRINT_MSG
 01A9				rufs_hd_format_8:
 01A9  BE 2AAE R				mov si, offset UNIX_CRLF
 01AC  E8 0307					call PRINT_MSG

 01AF  CD 20					int 20h

 01B1  EB FE			infinive_loop:  jmp short infinive_loop

 01B3				runix_partition_error:
						; 03/10/2019
 01B3  BE 3090 R				mov si, offset msg_inv_partition
 01B6  EB 73					jmp short @f

 01B8				check_hdi_option:
 01B8  AC					lodsb
 01B9  3C 69					cmp al, 'i'
 01BB  75 E6					jne short rufs_hd_format_7
 01BD  FE C9					dec cl
 01BF  74 E2					jz short rufs_hd_format_7
 01C1  AC					lodsb
 01C2  3C 20					cmp al, ' '
 01C4  75 DD					jne short rufs_hd_format_7
 01C6  FE C9					dec cl
 01C8  74 D9					jz short rufs_hd_format_7
 01CA				check_hdi_opt_loop:
 01CA  AC					lodsb
 01CB  3C 20					cmp al, 20h
 01CD  77 10					ja short get_hdi_name ; 04/12/2019
 01CF  72 D2					jb short rufs_hd_format_7
 01D1  FE C9					dec cl
 01D3  74 CE					jz short rufs_hd_format_7
 01D5  EB F3					jmp short check_hdi_opt_loop

 01D7				rufs_hd_format_9:
 01D7  BE 2A76 R				mov si, offset msg_NO
 01DA  E8 02D9					call PRINT_MSG

 01DD  EB CA					jmp short rufs_hd_format_8

 01DF				get_hdi_name:
 01DF  BF 2F38 R				mov di, offset img_file_name
 01E2				get_hdi_name_nxt_chr:
 01E2  AA					stosb
 01E3  FE C9					dec cl
 01E5  74 0D					jz short get_hdi_name_ok		
 01E7  AC					lodsb
 01E8  3C 20					cmp al, 20h
 01EA  76 08					jna short get_hdi_name_ok		
 01EC  81 FF 2F44 R				cmp di, offset img_file_name + 12	
 01F0  72 F0					jb short get_hdi_name_nxt_chr

 01F2  EB 49					jmp short invalid_file_name

 01F4				get_hdi_name_ok:
 01F4  2A C0					sub al, al
 01F6  AA					stosb 

						; 03/10/2019	
 01F7  EB 69					jmp short cap_file_name
						
				;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
				; get drive parameters
				;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

 01F9				rufs_hd_format_10:
 01F9  BE 2A71 R				mov si, offset msg_YES
 01FC  E8 02B7					call PRINT_MSG

						; 04/12/2019
						; 06/09/2019
						;mov dl, byte ptr [boot_sector.bsDriveNumber]
						;mov byte ptr [buff_d], dl
						;mov byte ptr [drive], dl ; 03/12/2019

 01FF				rufs_hd_format_11:
 01FF  33 C0					xor ax, ax
 0201  CD 1A					int 1Ah                 ; get time of day
				  					; set unique volume ID
						; 29/12/2019
						;mov word ptr [boot_sector.bsVolumeSerial], dx
						;mov word ptr [boot_sector.bsVolumeSerial+2], cx 
 0203  89 16 2B34 R				mov word ptr [VolumeSerial], dx
 0207  89 0E 2B36 R				mov word ptr [VolumeSerial+2], cx 

 020B				rufs_hd_format_12:
 020B  BE 2A0A R				mov si, offset Msg_installing_file_system
 020E  E8 02A5					call PRINT_MSG

 0211  E8 0333					call unix_fs_install
 0214  73 2C					jnc short rufs_hd_format_14

 0216  8A 26 2629 R				mov ah, byte ptr [Error]

 021A				rufs_hd_format_13: ; loc_rw_error
						; 06/09/2019
 021A  8A C4					mov al, ah
 021C  E8 02A6					call proc_hex
 021F  A3 2AAB R				mov word ptr [Str_Err], ax
 0222  BE 2A7A R				mov si, offset Msg_Disk_RW_Error
 0225  E8 028E					call PRINT_MSG
 0228  BE 2A9F R				mov si, Offset Msg_Error_Number
 022B				@@:
 022B  E8 0288					call PRINT_MSG

 022E				close_file_then_terminate:		
						; 07/07/2015
 022E  8B 1E 2F46 R				mov bx, word ptr [img_file_handle]
 0232  23 DB					and bx, bx
 0234  74 04					jz  short terminate
 0236				close_img_file:
 0236  B4 3E					mov ah, 3Eh ; close (floppy disk image) file
 0238  CD 21					int 21h		 
 023A				terminate:
 023A  E9 FF6C					jmp rufs_hd_format_8 ; 06/09/2019

				;		int 20h
				;
				;		; 06/09/2019
				;hang:
				;		jmp short hang

 023D				invalid_file_name:
 023D  BE 2F49 R				mov si, offset msg_inv_file_name
 0240  EB E9			                jmp short @b

 0242				rufs_hd_format_14:
 0242  BE 2A6C R				mov  si, offset Msg_OK
 0245  E8 026E					call PRINT_MSG

 0248				rufs_hd_format_15:
 0248  BE 2A33 R				mov si, offset Msg_writing_boot_sector
 024B  E8 0268					call PRINT_MSG

						;mov byte ptr [RetryCount], 4

 024E				rufs_hd_format_16:
						; 03/12/2019 - Retro UNIX 386 v2 
						;	  (RUNIX file system for hard disks)
						; 06/09/2019 - Retro UNIX 386 v2
 024E  33 C0					xor ax, ax
 0250  33 D2					xor dx, dx
 0252  BB 2B38 R				mov bx, offset boot_sector
 0255  E8 1B64					call dskwr
 0258  72 C0					jc short rufs_hd_format_13	
						;jmp short rufs_hd_format_17

						;mov ax, 0301h				; write to disk
						;mov bx, offset boot_sector		; location of boot code
						;mov cx, 1				; cylinder = 0
						;					; sector = 1
						;mov dh, 0				; head = 0
						;
						;mov dl, byte ptr [boot_sector.bsDriveNumber] ; 04/12/2019
						;int 13h
						;jnc short rufs_hd_format_17
						;dec byte ptr [RetryCount]
						;jnz short rufs_hd_format_16
						;
						;jmp short rufs_hd_format_13

 025A				rufs_hd_format_17:
 025A  BE 2A6C R				mov  si, offset Msg_OK
 025D  E8 0256					call PRINT_MSG

						;int 20h
						; 06/09/2019
						;jmp rufs_hd_format_8
 0260  EB CC					jmp short close_file_then_terminate

 0262				cap_file_name:
						; file name capitalization
 0262  BE 2F38 R				mov si, offset img_file_name
 0265  8B FE					mov di, si
 0267  8B DE					mov bx, si
 0269				cap_file_name0:
 0269  AC					lodsb
 026A  3C 61					cmp al, 'a'
 026C  73 0D					jnb short cap_file_name2
 026E  22 C0					and al, al
 0270  74 12					jz short cap_file_name3
 0272  3C 2E					cmp al, '.'
 0274  75 02					jne short cap_file_name1
 0276  8B DF					mov bx, di ; dot position	
 0278				cap_file_name1:
						;stosd
 0278  47					inc di ; 06/09/2019
 0279  EB EE					jmp short cap_file_name0 
 027B				cap_file_name2:
 027B  3C 7A					cmp al, 'z'
 027D  77 F9					ja short cap_file_name1
 027F  24 DF			                and al, 0DFh ; NOT 32
 0281  AA					stosb
 0282  EB E5					jmp short cap_file_name0
 0284				cap_file_name3:
 0284  88 05					mov [di], al
 0286  4F					dec di
 0287  3B DF					cmp bx, di
 0289  73 B2					jnb short invalid_file_name
 028B  2B FB					sub di, bx
 028D  81 EB 2F38 R				sub bx, offset img_file_name
 0291  83 FF 03					cmp di, 3
 0294  76 0B					jna short cap_file_name4
 0296  23 DB					and bx, bx
 0298  75 A3					jnz short invalid_file_name
 029A  EB 0A					jmp short open_image_file ; 03/10/2019		

 029C				file_error:
 029C  BE 0529 R				mov si, offset file_error_msg
 029F  EB 8A					jmp short @b

 02A1				cap_file_name4:
 02A1  83 FB 08					cmp bx, 8
 02A4  77 97					ja short invalid_file_name

						; 03/10/2019
 02A6				open_image_file:
						; 05/09/2019 - Retro UNIX 386 v2
						; 07/07/2015 (UNIXCOPY.ASM)
 02A6  BA 2F38 R				mov dx, offset img_file_name
 02A9  B9 003F					mov cx, 3Fh ; File Attributes
				                ;xor cx, cx ; 06/09/2019
 02AC  B4 4E					mov ah, 4Eh ; MS Dos Function = Find First File
 02AE  CD 21			                int 21h
 02B0  72 46					jc short file_not_found_error

				; DTA (PSP+80h= Offset 128)
 = 0095				DTA_Attrib equ 149 ; PDP+21 ;05/01/2013	
 = 0096				DTA_Time equ 150 ; PSP+22
 = 0098				DTA_Date equ 152 ; PSP 24
 = 009A				DTA_FileSize equ 154 ; PSP + 26
 = 009E				DTA_FileName equ 158 ; PSP + 30

 02B2				chk_image_file_features:
 02B2  BE 0095					mov si, DTA_Attrib
 02B5  8A 04			                mov al, byte ptr [si]
 02B7  24 1F			                and al, 1Fh ; directory, volume label, system, hidden, read only
 02B9  75 43			                jnz short file_attr_error       
 02BB  BE 009A					mov si, DTA_FileSize
						; 03/10/2019
 02BE  AD					lodsw
 02BF  8B D0					mov dx, ax
 02C1  AD					lodsw
 02C2  92					xchg ax, dx

						; 19/12/2019
 02C3  A9 01FF					test ax, 511
 02C6  75 2A					jnz short invalid_image_file
							 ; end of file is not on sector boundary!

 02C8  A3 2AD0 R				mov word ptr [file_size], ax
 02CB  89 16 2AD2 R				mov word ptr [file_size+2], dx

 02CF  B0 02					mov al, 2 ; open for reading and writing
 02D1  BA 2F38 R				mov dx, offset img_file_name
 02D4  B4 3D					mov ah, 3Dh ; open file
 02D6  CD 21					int 21h
 02D8  72 1E					jc short file_not_found_error

 02DA  A3 2F46 R				mov word ptr [img_file_handle], ax

 02DD  B4 3F					mov ah, 3Fh ; read file
 02DF  8B 1E 2F46 R				mov bx, word ptr [img_file_handle]
 02E3  B9 0200					mov cx, 512
 02E6  BA 1910 R				mov dx, offset Buffer
 02E9  CD 21					int 21h
 02EB  72 AF					jc short file_error

 02ED  E8 00AE					call check_hd_image_size
 02F0  73 12					jnc short valid_hd_image	
 02F2				invalid_image_file:
 02F2  BE 3036 R				mov si, offset msg_inv_image_file
 02F5  E9 FF33					jmp @b

 02F8				file_not_found_error:
 02F8  BE 2FEA R				mov si, offset msg_file_not_found
 02FB  E9 FF2D					jmp @b
 02FE				file_attr_error:
 02FE  BE 2F8C R				mov si, offset msg_file_attr_error
 0301  E9 FF27					jmp @b

 0304				valid_hd_image:
						; 19/12/2019
						; 06/09/2019
						; set (buffer) disk drive number for image file
						;mov byte ptr [buff_d], 90h ; floppy disk image sign
						; 03/12/2019
 0304  C6 06 09FF R 90				mov byte ptr [drive], 90h ; hard disk image sign

						; 03/10/2019
 0309  E9 FE76					jmp rufs_hd_format_img

 030C				rufs_hd_format  endp

 030C				set_hd_parms	proc near
						; 18/12/2019
						; 02/10/2019 - Retro UNIX 386 v2
						; Input:
						;  (output of INT 13h, AH=08h Read Drive Parameters)
						;   DL = number of hard disk drives 
						;   DH = logical last index of heads
						;      = number_of - 1 (because index starts with 0)
						;   CX = [7:6] [15:8][7] = logical last index of cylinders
						;                        = number_of - 1 
						;			   (because index starts with 0)
						;        [5:0][7] = logical last index of sectors per track
						;		  = number_of (because index starts with 1)
						; Output:
						;	CHS parameters are set
						;
						; Modified registers: ax,(bx),cx,dx,(es),(di)

 030C  32 E4					xor ah,ah
 030E  8A C6					mov al,dh
 0310  40					inc ax
 0311  A3 2AC2 R				mov word ptr [heads],ax
 0314  8B C1					mov ax,cx
 0316  83 E1 3F					and cx,63
 0319  89 0E 2AC4 R				mov word ptr [sectors],cx		
 031D  86 E0					xchg ah,al
 031F  80 E4 C0					and ah,0C0h
 0322  D0 C4			 		rol ah,1 	
 0324  D0 C4					rol ah,1
 0326  40					inc ax
 0327  A3 2AC6 R				mov word ptr [cylinders],ax	

						; 18/12/2019
						;push ds
						;pop es

 032A  C3					retn

 032B				set_hd_parms	endp

 032B				get_runix_partition proc near
						; 01/12/2019
						; 03/10/2019
						; 02/10/2019 - Retro UNIX 386 v2
						; Check Retro UNIX v2 (71h) partition on MasterBoot
						; sector if it is valid, set 'hidden sectors',
						; and 'total sectors'
						
						; DL = Drive number (80h .. 83h)

						; Modified registers: ax,(bx),cx,dx,(es),(di)

						;mov dl,byte ptr [buff_d]

						;xor ah,ah
				                ;int 13h
						;jnc short reset_ok
				;harddisk_error:
						;retn
				;reset_ok:
						;mov bx,offset Buffer
				                ;mov ax,0201h
				                ;mov cx,1
						;;mov dl,byte ptr [buff_d]
						;;mov dl,byte ptr [drive] ; 03/12/2019
				                ;xor dh,dh
				                ;;push ds
				                ;;pop es
				                ;int 13h
				                ;jc short harddisk_error

				; Here is the entry point for hard disk image (no int13h!)

 032B  81 3E 1B0E R AA55	                cmp word ptr [Buffer+510],0AA55h
 0331  74 02			                je short valid_masterboot
 0333				not_masterboot:
 0333  F9			                stc
 0334  C3			                retn
 0335				valid_masterboot:
						; 03/10/2019
 0335  BE 1AD2 R				mov si,offset Buffer+01BEh+4 
							; partition type byte in partition table
 0338				check_runix_partition:
 0338  80 3C 71					cmp byte ptr [si],71h
 033B  74 0D					je short runix_partition_ok
 033D  81 FE 1B02 R				cmp si,offset Buffer+01BEh+48+4
 0341  73 05					jnb short not_runix_partition
 0343  83 C6 10					add si,16
 0346  EB F0					jmp short check_runix_partition
 0348				not_runix_partition:
 0348  F9					stc
 0349  C3					retn		
 034A				runix_partition_ok:
 034A  83 C6 04					add si,4
						
						;mov ax,word ptr [si] ; start sector (of the runix partition)
						;mov word ptr [hidden_Sectors],ax
						;mov dx,word ptr [si+2]
						;mov word ptr [hidden_Sectors+2],dx
						;add si,4
						
 034D  AD					lodsw
 034E  8B D0					mov dx,ax
 0350  AD					lodsw
 0351  92					xchg ax,dx
 0352  A3 2AC8 R				mov word ptr [hidden_Sectors],ax
 0355  89 16 2ACA R				mov word ptr [hidden_Sectors+2],dx
					  	
						; 19/12/2019	  
 0359  8B 0C					mov cx,word ptr [si] ; total sectors (volume size)
 035B  89 0E 2ACC R				mov word ptr [total_Sectors],cx
 035F  8B 5C 02					mov bx,word ptr [si+2]
 0362  89 1E 2ACE R				mov word ptr [total_Sectors+2],bx

 0366  80 3E 09FF R 90				cmp byte ptr [drive], 90h ; hd image file ?
 036B  74 2A					je short lba_ok ; lets use LBA boot sector & LBA r/w	

						; 03/10/2019
 036D  03 C8					add cx,ax
 036F  13 DA					adc bx,dx
								
 0371  A1 2AC4 R				mov ax, word ptr [sectors]
 0374  8B 16 2AC2 R				mov dx, word ptr [heads]
 0378  F7 E2					mul dx  ; max. possible value 255*63 = 16065
							; dx = 0
 037A  8B 16 2AC6 R				mov dx, word ptr [cylinders]
 037E  F7 E2					mul dx
 0380  83 E8 01					sub ax, 1
 0383  83 DA 00					sbb dx, 0
						     ; dx:ax = CHS limit (max. = 16065*1024-1 = 16450559)

						; 01/12/2019
 0386  A3 2B30 R				mov word ptr [CHS_limit], ax
 0389  89 16 2B32 R				mov word ptr [CHS_limit+2], dx
					
 038D  3B D3					cmp dx, bx
 038F  77 0C					ja short chs_ok
 0391  72 04					jb short lba_ok
 0393  3B C1					cmp ax, cx
 0395  73 06					jnb short chs_ok
 0397				lba_ok:
 0397  C6 06 2ADA R 01				mov byte ptr [lba_rw], 1
 039C  F8					clc		
 039D				chs_ok:
 039D  C3					retn

 039E				get_runix_partition endp

 039E				check_hd_image_size proc near
						; 19/12/2019
						; 03/10/2019 - Retro UNIX 386 v2
						; DX:AX = image file size (in bytes)

						; Source code (derived) from
						; hdimage.s - 06/03/2019
						; (TRDOS 386 Hard Disk Image Formatting Utility)

						;test ax, 511
						;jnz short B_04 ; end of file is not on sector boundary!

						;mov word ptr [file_size], ax
						;mov word ptr [file_size+2], dx

						; 19/12/2019
 039E  A1 2AD0 R				mov ax, word ptr [file_size]
 03A1  8B 16 2AD2 R				mov dx, word ptr [file_size+2]

						; Check for Singlix Master Boot code
 03A5  81 3E 1ACC R 07BE			cmp word ptr [Buffer+444], 7BEh
 03AB  75 48					jne short A_15 ; no ..

						; It is seen as singlix MBR
						; Let's check for disk size words (CHS record)

						; convert (disk image) file size to sector count (disk size)
						; (dx:ax)/512
					
 03AD  B9 0200					mov cx, 512
 03B0  E8 0142					call div32

						; 12/02/2019
 03B3  A3 2ACC R				mov word ptr [total_sectors], ax
 03B6  89 16 2ACE R				mov word ptr [total_sectors+2], dx

 03BA  8B 0E 1AB4 R				mov cx, word ptr [Buffer+420] ; cylinders
 03BE  83 F9 10					cmp cx, 16
 03C1  72 32					jb short A_15 ; invalid
 03C3  A1 1AB6 R				mov ax, word ptr [Buffer+422] ; heads
 03C6  83 F8 02					cmp ax, 2
 03C9  72 2A					jb short A_15 ; invalid
 03CB  8B 16 1AB8 R				mov dx, word ptr [Buffer+424] ; sectors
 03CF  83 FA 11					cmp dx, 17
 03D2  72 21					jb short A_15 ; invalid
 03D4  89 0E 2AC6 R				mov word ptr [cylinders], cx
 03D8  A3 2AC2 R				mov word ptr [heads], ax
 03DB  89 16 2AC4 R				mov word ptr [sectors], dx
 03DF  F7 E2					mul dx
 03E1  E8 011F					call mul32
 03E4  0B DB					or bx, bx
 03E6  75 0D					jnz short A_15 ; invalid
 03E8  3B 16 2ACE R				cmp dx, word ptr [total_sectors+2]
 03EC  75 07					jne short A_15
 03EE  3B 06 2ACC R				cmp ax, word ptr [total_sectors]
 03F2  75 01					jne short A_15 ; invalid 

						; valid singlix MBR & disk image file

 03F4  C3					retn
 03F5				A_15:
						; cylinders*63sectors*16heads (<=528MB)
 03F5  81 FA 1F80				cmp dx, 1F80h ; 1024*16*63 (1F800000h)
 03F9  77 4B					ja short A_21
 03FB  72 06					jb short A_16
 03FD  23 C0					and ax, ax
 03FF  75 5C					jnz short A_22

						; = 528MB (1024*16*63*512)
						;mov word ptr [heads], 16
						;mov ax, 1024
						;jmp short A_25
						; 04/12/2019
 0401  EB 4F					jmp short A_27
 0403				A_16:
						; < 528MB
 0403  B9 03F0					mov cx, 63*16 ; 1008
 0406  F7 F1					div cx
 0408  23 D2					and dx, dx
 040A  75 04					jnz short A_17 ; 17 spt disk image check
						;mov word ptr [heads], 16
						;jmp short A_25
 040C  EB 47					jmp short A_28 ; 04/12/2019
 040E				B_04:
 040E  F9					stc
 040F  C3					retn
 0410				A_17:
						; 12/02/2019
 0410  A1 2AD0 R				mov ax, word ptr [file_size]
 0413  8B 16 2AD2 R				mov dx, word ptr [file_size+2]

						;; 10/02/2019
						;; Check 17 spt disk image
						;mov si, DTA_FileSize
						;lodsw
						;; max. size of hard disk image = 17sectors*16heads*1024cylinders
						;mov dx, [si]
					
						; 04/12/2019
 0417  81 FA 0880				cmp dx, 880h ; 136MB upper limit (8800000h) for 17spt
 041B  77 F1					ja short B_04

 041D  B9 0200					mov cx, 512
 0420  E8 00D2					call div32

 0423  A3 2AD4 R				mov word ptr [pp_Sectors], ax
 0426  89 16 2AD6 R				mov word ptr [pp_Sectors+2], dx
					
						; Calculate with increased heads (count) order
						; (For example cyls = 1024 & heads = 8 is better than
						;      cyls = 512 & heads = 16, for 17 SPT.v)

 042A  B9 0022					mov cx, 17*2 ; 34 ; heads = 2
 042D				A_18:
 042D  E8 00C5					call div32
							; Ýf remainder = 0 it is 17spt hard disk image file
 0430  23 DB					and bx, bx
 0432  74 6B					jz short A_20
 0434				A_19:	
 0434  83 C1 11					add cx, 17
 0437  81 F9 0110				cmp cx, 17*16 ; 272 ; heads = 16
 043B  77 D1					ja short B_04 ; invalid image file !

 043D  A1 2AD4 R				mov ax, word ptr [pp_Sectors]
 0440  8B 16 2AD6 R				mov dx, word ptr [pp_Sectors+2]
					 	
 0444  EB E7					jmp short A_18
 0446				A_21:
						; cylinders*63sectors*32heads (>528MB, <=1GB)
 0446  81 FA 3F00				cmp dx, 3F00h ; 1024*32*63 (3F000000h)
 044A  77 22					ja short A_23
 044C  72 0F					jb short A_22
 044E  23 C0					and ax, ax
 0450  75 1C					jnz short A_23
						; = 1GB (1024*32*63*512)
 0452				A_27:
 0452  B8 0400					mov ax, 1024
 0455				A_28:
 0455  C7 06 2AC2 R 0010			mov word ptr [heads], 16
 045B  EB 20					jmp short A_25	
 045D				A_22:
 045D  B9 07E0					mov cx, 63*32
 0460  F7 F1					div cx
 0462  23 D2					and dx, dx
 0464  75 A8					jnz short B_04
 0466  C7 06 2AC2 R 0020			mov word ptr [heads], 32
 046C  EB 0F					jmp short A_25
 046E				A_23:
						; cylinders*63sectors*64heads (>1GB, <=2GB)
 046E  B9 0FC0					mov cx, 63*64
 0471  F7 F1					div cx
 0473  23 D2					and dx, dx
 0475  75 97					jnz short B_04
 0477				A_24:
 0477  C7 06 2AC2 R 0040			mov word ptr [heads], 64
 047D				A_25:
 047D  C7 06 2AC4 R 003F			mov word ptr [sectors], 63
 0483  A3 2AC6 R				mov word ptr [cylinders], ax
 0486				A_26:
						; 08/02/2019

						; calculate total sectors (by using CHS values)
 0486  A1 2AC4 R				mov ax, word ptr [sectors]
 0489  F7 26 2AC2 R				mul word ptr [heads]
 048D  A3 2AD8 R				mov word ptr [min_sectors], ax ; Minimum sectors
 0490  8B 16 2AC6 R				mov dx, word ptr [cylinders]
 0494  F7 E2					mul dx
 0496  A3 2ACC R				mov word ptr [total_sectors], ax
 0499  89 16 2ACE R				mov word ptr [total_sectors+2], dx
						
 049D  F8					clc
 049E  C3					retn
 049F				A_20:
 049F  3D 0400					cmp ax, 1024
 04A2  77 90					ja short A_19

 04A4  B3 11					mov bl, 17
 04A6  88 1E 2AC4 R				mov byte ptr [sectors], bl ; 17
 04AA  A3 2AC6 R				mov word ptr [cylinders], ax

 04AD  8B C1					mov ax, cx
 04AF  F6 F3					div bl
						;xor ah, ah
 04B1  A3 2AC2 R				mov word ptr [heads], ax

 04B4  EB D0					jmp short A_26

 04B6				check_hd_image_size endp

 04B6				PRINT_MSG	proc near
 04B6  BB 0007					mov BX,07h  
 04B9  B4 0E					mov AH,0Eh  

 04BB				PRINT_MSG_LOOP:
 04BB  AC					lodsb				; Load byte at DS:SI to AL
 04BC  22 C0					and AL,AL            
 04BE  74 04					jz short PRINT_MSG_OK       
					
 04C0  CD 10					int 10h				; BIOS Service func ( ah ) = 0Eh
										; Write char as TTY
										;AL-char BH-page BL-color
 04C2  EB F7					jmp short PRINT_MSG_LOOP           

 04C4				PRINT_MSG_OK:
 04C4  C3					retn

 04C5				PRINT_MSG	endp

 04C5				proc_hex	proc near

 04C5  D4 10					db 0D4h,10h                     ; Undocumented inst. AAM
										; AH = AL / 10h
										; AL = AL MOD 10h
 04C7  0D 3030					or AX,'00'                      ; Make it ZERO (ASCII) based

 04CA  86 E0					xchg AH,AL 

				; 1999
 04CC  3C 39					cmp AL,'9'
 04CE  76 02					jna short pass_cc_al
 04D0  04 07					add AL,7
 04D2				pass_cc_al:
 04D2  80 FC 39					cmp AH,'9'
 04D5  76 03					jna short pass_cc_ah
 04D7  80 C4 07					add AH,7
 04DA				pass_cc_ah:

				; 1998
 04DA  C3					retn

 04DB				proc_hex	endp

 04DB				drive_check:
						; 03/12/2019
						; 03/10/2019
						; 09/09/2019 - Retro UNIX 386 v2
						
						; DL = Hard disk drive number 
						
						;;xor bx, bx ; sector 0
						;;mov word ptr [buff_s], bx
						;;mov word ptr [buff_o], offset Buffer
						;;call dskrd

						; 03/10/2019

						;xor ah,ah
						;int 13h
						;jc short drive_not_ready
 04DB				reset_ok:
 04DB  BB 1910 R				mov bx,offset Buffer
 04DE  B8 0201					mov ax,0201h
 04E1  B9 0001					mov cx,1
						;mov dl,byte ptr [buff_d]
						;mov dl,byte ptr [drive] ; 03/12/2019
 04E4  32 F6					xor dh,dh
						;push ds
						;pop es
 04E6  CD 13					int 13h
 04E8  73 0A					jnc short drive_check_ok
 04EA				drive_not_ready:
						; 09/09/2019
 04EA  58					pop ax ; near call return address
 04EB  BE 2A8C R				mov si, offset msg_drive_not_ready
 04EE  E8 FFC5					call PRINT_MSG
 04F1  E9 FCB5					jmp rufs_hd_format_8
 04F4				drive_check_ok:
 04F4  C3					retn

 04F5				div32:
						; DX_AX/CX
						; Result: DX_AX, BX (remainder) 
 04F5  8B D8					mov bx, ax
						;or dx, ax ; * DX_AX = 0 ?       
						;jz short div32_retn ; yes, do not divide! 
 04F7  8B C2					mov ax, dx
 04F9  33 D2			  		xor dx, dx
 04FB  F7 F1			  		div cx	; at first, divide DX
							; remainder is in DX 
 04FD  93					xchg ax, bx ; now quotient is in BX
				  			; and initial AX value is in AX
 04FE  F7 F1					div cx	; now, DX_AX has been divided and
							; AX has quotient
							; DX has remainder
 0500  87 D3					xchg dx, bx	; finally, BX has remainder
				;div32_retn:
 0502  C3			 		retn

 0503				mul32:
						; DX_AX*CX
						; Result: BX_DX_AX 
 0503  51					push cx
 0504  8B DA					mov bx,dx
 0506  F7 E1					mul cx
 0508  93			 		xchg ax,bx
 0509  52					push dx
 050A  F7 E1					mul cx 
 050C  59					pop cx 
 050D  03 C1					add ax,cx 
 050F  83 D2 00					adc dx,0
 0512  93					xchg bx,ax
 0513  87 D3					xchg dx,bx
 0515  59					pop cx
 0516  C3					retn

 0517				shl32:
						; 23/01/2020
						; 16/10/2019
						; 18/09/2019 (UNIXCOPY.ASM)
						; INPUT:
						;   CL = shift count
						;xor ch,ch
 0517  E3 06					jcxz norotal
 0519				rotashftl:
						; 23/01/2020
 0519  D1 E0					shl ax,1
 051B  D1 D2					rcl dx,1
 051D  E2 FA					loop rotashftl
 051F				norotal:
 051F  C3					retn

 0520				shr32:
						; 16/10/2019
						; INPUT:
						;   CL = shift count
						;xor ch,ch
 0520  E3 06					jcxz norotar
 0522				rotashftr:
 0522  D1 EA					shr dx,1
 0524  D1 D8					rcr ax,1
 0526  E2 FA					loop rotashftr
 0528				norotar:
 0528  C3					retn

				; ***

 0529				file_error_msg:
 0529  0D 0A					db 0Dh, 0Ah
 052B  46 69 6C 65 20 28			db 'File (Read/Write) Error !'
       52 65 61 64 2F 57
       72 69 74 65 29 20
       45 72 72 6F 72 20
       21
 0544				CRLF:
 0544  0D 0A 00			                db 0Dh, 0Ah, 0
				;;;;;
				;include	uinstall.asm
				include		rufshdi.asm ; installation code for hard disk fs (71h)
			      C ; RUFSHDI.ASM
			      C ; --------------------------------------------------------------
			      C ; RETRO UNIX v0.3 - Modified UNIX v7 inode model - 01/09/2019
			      C ;
			      C ; RETRO UNIX v0.2 - 14 byte file name modifications (04/12/2015)
			      C ; RETRO UNIX v0.1 'fd0' formatting procedures
			      C ;
			      C ; Derived from UINSTALL.ASM (for 1.44MB floppies) - 30/09/2019
			      C ;
			      C ; Last Update: 20/07/2022 (Retro UNIX 386 v2) ;*****************
			      C ;
			      C ; 04/12/2015 (new /dev directory format 
			      C ; 	      according to Retro UNIX 8086 v1 kernel)
			      C ; 21/04/2014 (tty8, tty9)
			      C ; 05/03/2013 (ALIGN) 
			      C ; 31/10/2012, 16/12/2012 (unixproc.asm -> sioreg) 
			      C ; ERDOGAN TAN [ 14-15-16-21-27/7/2012, 4-5-12-13-14-15-21/8/2012 ]
			      C ; These procedures will be located in UNIXFDFS.ASM file 
			      C ; when they are completed.
			      C ; (NOTE: only for (R)UFS initialization of FD0 1.44MB floppy disk
			      C 
			      C ;SIZE_FREE_MAP equ 360
			      C ;SIZE_INODE_MAP equ 32
			      C 
 = 0B40			      C DISK_SIZE equ 2880 ; in blocks
 = SIZE_INODE_MAP * 8	      C INODE_COUNT equ SIZE_INODE_MAP * 8
			      C ;INODE_LIST_BLOCKS equ (INODE_COUNT / 16)
 = (INODE_COUNT / 8)	      C INODE_LIST_BLOCKS equ (INODE_COUNT / 8) ; 01/09/2019
			      C 
			      C ;ROOT_DIR_INODE equ 41
			      C ;ROOT_DIR_INODE equ 1; 07/09/2019 - Retro UNIX 386 v2
			      C 
			      C ;SIZE_Reserved1 equ 512 - (2+SIZE_FREE_MAP+2+SIZE_INODE_MAP) 
			      C 
			      C ;SuperBlock struc
			      C ;
			      C ;sb_FreeMapSize dw ?
			      C ;sb_FreeMap	db SIZE_FREE_MAP dup(?)
			      C ;sb_InodeMapSize dw ?
			      C ;sb_InodeMap	db SIZE_INODE_MAP dup(?)
			      C ;sb_Reserved1	db SIZE_Reserved1 dup(?)
			      C ;sb_Reserved2	db 512 dup(?)
			      C ;
			      C ;SuperBlock ends
			      C 
			      C ; 14/01/2020 - Super Block modification :
			      C ;	     - Extended sections/divisions (consequental sectors)
			      C ;	     - (for swapping, configuration, boot space etc.)	
			      C ; 21/12/2019
			      C ; 19/12/2019 (UNIXHDFS.COM, RUFSHDI.ASM)
			      C ; 01/09/2019 - Retro UNIX 386 v2 SuperBlock
			      C 
			      C ;SuperBlock struc
			      C ;
			      C ;sb_Header	dd ?
			      C ;sb_BootSectAddr dd ?  ; Hidden Sectors
			      C ;sb_VolumeSize	dd ?  ; Entire Volume/Partition Size (includes ext. volume)	
			      C ;sb_Version	dd ?
			      C ;sb_BlockSize	dd ?
			      C ;sb_InodeCount	dd ? 	
			      C ;sb_FreeMapAddr	dd ?
			      C ;sb_FreeMapSize  dd ?
			      C ;sb_InodeMapAddr dd ?
			      C ;sb_InodeMapSize dd ?
			      C ;sb_InodeTblAddr dd ?
			      C ;sb_InodeTblSize dd ?
			      C ;sb_FreeInodes	dd ?
			      C ;sb_FirstFreeIno dd ?
			      C ;sb_FreeBlocks	dd ?
			      C ;sb_FirstFreeBlk dd ?
			      C ;sb_BootSecParms db 19 dup(?) ; v1 ; 19/12/2019
			      C ;sb_BSExtension	db 5 dup(?) ; v2 HDFS ; 19/12/2019
			      C ;sb_Status	dd ? ; 19/12/2019
			      C ;sb_ModifTime	dd ?
			      C ;sb_ExtdVolTbl	dd 0 ; 14/01/2020 ; Extended Volume Start/Table Address
			      C ;sb_ExtdVolSize	dd 0 ; 14/01/2020 ; Extended Volume (swap section etc.) Size	
			      C ;sb_LBA_rw	db 0 ; 03/10/2019
			      C ;sb_ClusterSize	db 0 ; 03/10/2019
			      C ;sb_ReadOnly	db 0 ; 03/10/2019
			      C ;sb_Mounted	db 0 ; 03/10/2019
			      C ;sb_MountInode	dd 0 ; 03/10/2019
			      C ;sb_DevMajor	db 0 ; 03/10/2019
			      C ;sb_DevMinor	db 0 ; 03/10/2019
			      C ;sb_LongName	db 0 ; 03/10/2019
			      C ;sb_Direntry32	db 0 ; 03/10/2019
			      C ;sb_Reserved	db 508-116 dup(?) ; Must be 0 for current RUFS version
			      C ;sb_Footer	dd ?
			      C ;
			      C ;SuperBlock ends
			      C 
			      C ; 14/01/2020
			      C ;sb_HiddenSects equ sb_BootSecAddr
			      C ;sb_TotalSects equ sb_VolumeSize
			      C 
			      C ; 19/12/2019 - Retro UNIX 386 v2 HD (071h) partition boot sector
			      C ; 04/12/2019
			      C ; 03/10/2019 - Retro UNIX 386 v2 
			      C ; Hard Disk Partition (71h) Boot Sector Parameters
			      C 
			      C ;RUFS struc
			      C ;bsJumpCode     dw ? ; 0EB, 13h ; jmp short @f  	
			      C ;bsFSystemID    db 4 dup(?)  ;'RUFS'
			      C ;bsVolumeSerial dd ?
			      C ;bsDriveID      dw ? ; 'hd'
			      C ;bsDriveNumber  db ? ; 80h
			      C ;bsReserved     db ? ; 0 = 512 bytes/sector CHS, 1 = LBA
			      C ;bsSecPerTrack  db ? ; 63,17
			      C ;bsHeads        db ? ; 8 to 255 (may be 2 to 255) 
			      C ;bsCylinders    dw ? ; 1 to 1024 (bsTracks)
			      C ;bs_BF_I_number dw 0 ; startup (boot) file inode number
			      C ;bsMagic	db 0 ; '@' ; magic byte !
			      C ;bsPartitionID: db 71h ; Retro UNIX 386 partition/volume ; 19/12/2019
			      C ;bsHiddenSects: dd 0 ; Hidden sectors (Boot Sector LBA)	; 19/12/2019
			      C ;;@@:
			      C ;RUFS ends
			      C 
 = 0013			      C RUFS_BSP_SIZE equ 19 ; 21-2
			      C 
			      C ; UNIX v1 I-node Flags: 
			      C ; 1000000000000000b 	i-node is allocated (8000h)
			      C ; 0100000000000000b	directory (4000h)
			      C ; 0010000000000000b	file has been modified (2000h)		 	
			      C ; 0001000000000000b	large file (1000h)
			      C ; 0000000000100000b	set user id on execution (20h)
			      C ; 0000000000010000b	executable (10h)
			      C ; 0000000000001000b	read, owner (8)
			      C ; 0000000000000100b	write, owner (4)
			      C ; 0000000000000010b	read, non-owner (2)
			      C ; 0000000000000001b	write, non-owner (1)
			      C 
			      C ; UNIX v7 I-node Flags: 
			      C ; 1000000000000000b 	IFREG - regular file (8000h)
			      C ; 0100000000000000b	IFDIR - directory (4000h)
			      C ; 0010000000000000b	IFCHR - character special (2000h)
			      C ; 0001000000000000b	reserved (1000h)
			      C ; 0000100000000000b	ISUID - set user id on exec (800h)		 	
			      C ; 0000010000000000b	ISGID - set group id on exec (400h)
			      C ; 0000001000000000b	ISVTX - save swapped text (200h)
			      C ; 0000000100000000b	IREAD - read, owner (100h)
			      C ; 0000000010000000b	IWRITE - write,owner (80h)
			      C ; 0000000001000000b	IEXEC - execute, owner (40h)
			      C ; 0000000000100000b	read, group (20h)
			      C ; 0000000000010000b	write, group (10h)
			      C ; 0000000000001000b	execute, group (08h)
			      C ; 0000000000000100b	read, others (04h)
			      C ; 0000000000000010b	write, others (02h)
			      C ; 0000000000000001b	execute, others (01h)
			      C 
			      C ; UNIX SysV I-node Flags: (di_mode)
			      C ; 1000000000000000b 	IFREG - regular file (8000h)
			      C ; 0100000000000000b	IFDIR - directory (4000h)
			      C ; 0010000000000000b	IFCHR - character special (2000h)
			      C ; 0001000000000000b	IFIFO - fifo special (1000h)
			      C ; 0000100000000000b	ISUID - set user id on exec (800h)		 	
			      C ; 0000010000000000b	ISGID - set group id on exec (400h)
			      C ; 0000001000000000b	ISVTX - save swapped text (200h)
			      C ; 0000000100000000b	IREAD - read, owner (100h)
			      C ; 0000000010000000b	IWRITE - write,owner (80h)
			      C ; 0000000001000000b	IEXEC - execute, owner (40h)
			      C ; 0000000000100000b	read, group (20h)
			      C ; 0000000000010000b	write, group (10h)
			      C ; 0000000000001000b	execute, group (08h)
			      C ; 0000000000000100b	read, others (04h)
			      C ; 0000000000000010b	write, others (02h)
			      C ; 0000000000000001b	execute, others (01h)
			      C 
			      C ; IFREG	equ 8000h	; /* regular */
			      C ; IFMPB	equ 7000h	; /* multiplexed block special */
			      C ; IFBLK	equ 6000h	; /* block special */
			      C ; IFNAM	equ 5000h	; /* special named file - subtype in r_dev *
			      C ; IFDIR	equ 4000h	; /* directory */
			      C ; IFMPC	equ 3000h	; /* multiplexed char special */
			      C ; IFCHR	equ 2000h	; /* character special */
			      C ; IFIFO	equ 1000h	; /* fifo special */
			      C ; ISUID	equ 0800h	; /* set user id on execution */
			      C ; ISGID	equ 0400h	; /* set group id on execution */
			      C ; ISVTX	equ 0200h	; /* save swapped text even after use */
			      C ; IREAD equ 0100h	; /* read permission */
			      C ; IWRITE equ 0080h	; /* write permission */
			      C ; IEXEC	equ 0040h	; /* execute permission */
			      C 
			      C ; Retro UNIX 386 v2 I-node Flags: (di_mode) ;; FIRST DRAFT - 01/09/2019
			      C ; 1000000000000000b 	IFREG - regular file (8000h)
			      C ; 0100000000000000b	IFDIR - directory (4000h)
			      C ; 0010000000000000b	IFCHR - character special (2000h)
			      C ; 0001000000000000b	IFIFO - fifo special (1000h)
			      C ; 0000100000000000b	ISUID - set user id on exec (800h)		 	
			      C ; 0000010000000000b	ISGID - set group id on exec (400h)
			      C ; 0000001000000000b	IEXTD - use extents (200h)
			      C ; 0000000100000000b	IREAD - read, owner (100h)
			      C ; 0000000010000000b	IWRITE - write,owner (80h)
			      C ; 0000000001000000b	IEXEC - execute, owner (40h)
			      C ; 0000000000100000b	read, group (20h)
			      C ; 0000000000010000b	write, group (10h)
			      C ; 0000000000001000b	execute, group (08h)
			      C ; 0000000000000100b	read, others (04hq	)
			      C ; 0000000000000010b	write, others (02h)
			      C ; 0000000000000001b	execute, others (01h)
			      C 
			      C ;; SECOND DRAFT - 03/09/2019
			      C 
			      C ; Retro UNIX 386 v2 I-node Flags: (di_mode) for files
			      C ; 1000000000000000b 	IFREG - 1 = regular file (8000h)
			      C ; 0100000000000000b	IFDIR - 1 = directory (4000h)
			      C ; 0010000000000000b	ISIZ2 - sizing higher bit (2000h)
			      C ; 0001000000000000b	ISIZ1 - sizing lower bit (1000h)
			      C ; 0000100000000000b	ISUID - set user id on exec (800h)		 	
			      C ; 0000010000000000b	ISGID - set group id on exec (400h)
			      C ; 0000001000000000b	IEXTT - 1 = use extents (200h)
			      C ; 0000000100000000b	IREAD - read, owner (100h)
			      C ; 0000000010000000b	IWRITE - write,owner (80h)
			      C ; 0000000001000000b	IEXEC - execute, owner (40h)
			      C ; 0000000000100000b	read, group (20h)
			      C ; 0000000000010000b	write, group (10h)
			      C ; 0000000000001000b	execute, group (08h)
			      C ; 0000000000000100b	read, others (04h)
			      C ; 0000000000000010b	write, others (02h)
			      C ; 0000000000000001b	execute, others (01h)
			      C 
			      C ;; THIRD DRAFT - 15/09/2019
			      C ; 18/12/2019 - Mounted flag - IFMNT (2000h)
			      C 
			      C ; Retro UNIX 386 v2 I-node Flags: (di_mode) for files
			      C ; 1000000000000000b 	IFREG - 1 = regular file (8000h)
			      C ; 0100000000000000b	IFDIR - 1 = directory (4000h)
			      C ; 0010000000000000b	IRSVD - 0 = reserved bit (2000h) ; Mounted flag
			      C ; 0001000000000000b	ILARG - Large file addressing bit (1000h)
			      C ; 0000100000000000b	ISUID - set user id on exec (800h)
			      C ; 0000010000000000b	ISGID - set group id on exec (400h)
			      C ; 0000001000000000b	IEXTT - 1 = use extents (200h)
			      C ; 0000000100000000b	IREAD - read, owner (100h)
			      C ; 0000000010000000b	IWRITE - write, owner (80h)
			      C ; 0000000001000000b	IEXEC - execute, owner (40h)
			      C ; 0000000000100000b	read, group (20h)
			      C ; 0000000000010000b	write, group (10h)
			      C ; 0000000000001000b	execute, group (08h)
			      C ; 0000000000000100b	read, others (04h)
			      C ; 0000000000000010b	write, others (02h)
			      C ; 0000000000000001b	execute, others (01h)
			      C 
			      C ; Retro UNIX 386 v2 I-node Flags: (di_mode) for devices
			      C ; 1000000000000000b 	IFREG - 0 = device file (8000h)
			      C ; 0100000000000000b	IFBLK - 1 = block device (4000h)
			      C ; 0010000000000000b	IFCHR - character special (2000h) -always 1-
			      C ; 0001000000000000b	IFIFO - fifo special (1000h)
			      C ; 0000100000000000b	ISUID - set user id on exec (800h)		 	
			      C ; 0000010000000000b	ISGID - set group id on exec (400h)
			      C ; 0000001000000000b	IEXTR - 1 = external device driver (200h)
			      C ; 0000000100000000b	IREAD - read, owner (100h)
			      C ; 0000000010000000b	IWRITE - write, owner (80h)
			      C ; 0000000001000000b	IEXEC - execute, owner (40h) 
			      C ; 0000000000100000b	read, group (20h)
			      C ; 0000000000010000b	write, group (10h)
			      C ; 0000000000001000b	execute, group (08h)
			      C ; 0000000000000100b	read, others (04h)
			      C ; 0000000000000010b	write, others (02h)
			      C ; 0000000000000001b	execute, others (01h)
			      C 
			      C ; 15/09/2019
			      C ; Flag bit 12 - 0 small file addressing
			      C ; -------------------------------------
			      C ; Disk Block Pointers
			      C ;
			      C ; di_addr[0] = direct block 0 address
			      C ; di_addr[4] = direct block 1 address
			      C ; di_addr[8] = direct block 2 address
			      C ; di_addr[12] = direct block 3 address
			      C ; di_addr[16] = direct block 4 address
			      C ; di_addr[20] = direct block 5 address
			      C ; di_addr[24] = direct block 6 address
			      C ; di_addr[28] = direct block 7 address
			      C ; di_addr[32] = direct block 8 address
			      C ; di_addr[36] = direct block 9 address
			      C 
			      C ; Flag bit 12 - 1 large file addresdsing
			      C ; -------------------------------------
			      C ; Disk Block Pointers
			      C ;
			      C ; di_addr[0] = indirect block 0 address
			      C ; di_addr[4] = indirect block 1 address
			      C ; di_addr[8] = indirect block 2 address
			      C ; di_addr[12] = indirect block 3 address
			      C ; di_addr[16] = indirect block 4 address
			      C ; di_addr[20] = indirect block 5 address
			      C ; di_addr[24] = indirect block 6 address
			      C ; di_addr[28] = indirect block 7 address
			      C ; di_addr[32] = double indirect block (0) address
			      C ; di_addr[36] = triple indirect block (0) address
			      C 
			      C ; 15/09/2019
			      C ; Flag bit 8 (if it is set)
			      C ; -----------------------------------
			      C ; Use extents (contigous blocks)
			      C ;
			      C ; di_addr[0] = extent 0 start address (or indirect 0)
			      C ; di_addr[4] = extent 0 block count (or indirect 0 bc)
			      C ; di_addr[8] = extent 1 start address (or indirect 1)
			      C ; di_addr[12] = extent 1 block count (or indirect 1 bc)
			      C ; di_addr[16] = extent 2 start address (or indirect 2)
			      C ; di_addr[20] = extent 2 block count (or indirect 2 bc)
			      C ; di_addr[24] = extent 3 start address (or double indirect)
			      C ; di_addr[28] = extent 3 block count (or double indirect bc)
			      C ; di_addr[32] = extent 4 start address (or triple indirect)
			      C ; di_addr[36] = extent 4 block count (or triple indirect bc)
			      C 
			      C ; UNIX v7 I-node (on disk) : 
			      C ;
			      C ;struc dinode
			      C ;  .di_mode:  resw 1	; /* mode and type of file */
			      C ;  .di_nlink: resw 1	; /* number of links to file */
			      C ;  .di_uid:   resw 1 	; /* owner's user id */
			      C ;  .di_gid:   resw 1	; /* owner's group id */
			      C ;  .di_size:  resd 1	; /* number of bytes in file */
			      C ;  .di_addr:  resb 40 ; (3*13)+1 ; /* disk block addresses */
			      C ;  .di_atime: resd 1	; /* time last accessed */
			      C ;  .di_mtime: resd 1	; /* time last modified */
			      C ;  .di_ctime: resd 1	; /* time created */
			      C ;endstruc
			      C 
			      C ; (first draft)
			      C ; Retro UNIX 386 v2 I-node (on disk) : 
			      C ;
			      C ;struc dinode
			      C ;  .di_mode:  resw 1	; /* mode and type of file */
			      C ;  .di_nlink: resw 1	; /* number of links to file */
			      C ;  .di_uid:   resw 1	; /* owner's user id */
			      C ;  .di_gid:   resw 1	; /* owner's group id */
			      C ;  .di_size:  resd 1	; /* number of bytes in file */
			      C ;  .di_size_h: resw 1	; /* number of bytes in file */
			      C ;  .di_cssc: resb 1	; Cluster/Block size shift count - 1 ; 04/09/2019	
			      C ;  .di_bssc: resb 1	; Block/Sector size shift count - 1 ; 04/09/2019		
			      C ;  .di_addr:  resd 8 ; resb 32 ; /* disk block addresses */
			      C ;  .di_atime: resd 1	; /* time last accessed */
			      C ;  .di_mtime: resd 1	; /* time last modified */
			      C ;  .di_ctime: resd 1	; /* time created */
			      C ;  .di_reserved2: resd 1 ; reserved (zero)
			      C ;endstruc
			      C 
			      C ; 18/12/2019
			      C ; 15/09/2019 (second draft)
			      C ; Retro UNIX 386 v2 I-node (on disk) : 
			      C ;
			      C ;struc dinode
			      C ;  .di_mode:  resw 1	; /* mode and type of file */
			      C ;  .di_nlink: resw 1	; /* number of links to file */
			      C ;  .di_uid:   resw 1	; /* owner's user id */  - 0 to 655535 -
			      C ;  .di_gid:   resb 1	; /* owner's group id */ - o to 255 -
			      C ;  .di_size_h: resb 1	; /* number of bytes in file */ ; - byte 5 -
			      C ;  .di_size:  resd 1	; /* number of bytes in file */
			      C ;  .di_addr:  resd 10 ; resb 40 ; /* disk block addresses */
			      C ;  .di_atime: resd 1	; /* time last accessed */
			      C ;  .di_mtime: resd 1	; /* time last modified */
			      C ;  .di_ctime: resd 1	; /* time created */
			      C ;endstruc
			      C 
			      C ; 04/09/2019 - Retro UNIX 386 v2
			      C 
			      C ;BLOCK SIZE SHIFT COUNTS or STORAGE/DISK (SECTOR SIZE) TYPE
			      C ;----------------------------------------------------------
			      C ;0 = 512 bytes per sector floppy drive or hard disk
			      C ;1 = 1024 bytes per sector, tape drive
			      C ;2 = 2048 bytes per sector DVD, CDROM, new (2TB) hard disks
			      C 
			      C ;CLUSTER SIZE SHIFT COUNTS or FILE SYSTEM BLOCK SIZE
			      C ;----------------------------------------------------------
			      C ;0 = 1 block (1 sector)
			      C ;1 = 2 blocks
			      C ;2 = 4 blocks
			      C ;3 = 8 blocks
			      C ;4 = 16 blocks
			      C ;5 = 32 blocks
			      C ;6 = 64 blocks
			      C ;7 = 128 blocks
			      C ;8 = 256 blocks
			      C 
			      C ;SIZING LIMITS (as CLUSTER/BLOCK size) - cluster size = 1
			      C ;----------------------------------------------------------
			      C ; small - direct block addresses - 10 blocks (5120 bytes) 
			      C ; normal - indirect block addresses - 8*128 blocks (512KB) 
			      C ; large - double indirect blocks - 128*128 blks + norm (8MB+512KB)
			      C ; huge - triple indirect blocks - 128*128*128 blks (1GB+8MB+512KB)
			      C 
			      C ;SIZING LIMITS (as CLUSTER/BLOCK size) - cluster size = 8
			      C ;----------------------------------------------------------
			      C ; small - direct block addresses - 10*8 blocks (40960 bytes)  
			      C ; normal - indirect block addresses - 8*1024 blocks (4MB) 
			      C ; large - double indirect blocks - 1024*1024 blks + norm (512MB+4MB)
			      C ; huge - triple indirect blocks - 1024*1024*1024 blks (512GB+516MB)
			      C 
			      C ;15/09/2019
			      C ;NOTE: Addresses are in sector unit (512 bytes or 2048 bytes).
			      C ;      But, block (cluster) size is 1 or 8 sectors, default is 1 sector 	
			      C ;      (Cluster size for 2048 bytes/sector disks may be 2,4,8 sectors)
			      C  
			      C ;DISK ADDR AND FILE SIZE LIMITS FOR EXTENTS !!! LIMITS !!!
			      C ;----------------------------------------------------------
			      C ; (depending on free contiguous blocks/sectors on disk fs)
			      C ; direct - 5 extents - 2 tera bytes (avr. 400GB per extent)  
			      C ; indirect - 4*64 extents - 2TB (average 8GB per extent)
			      C ; double ind. - 4*64*64 extents - 2TB (avr. 128MB per ext.)
			      C ; triple ind. - 1048576 extents - 2TB (avr. 2MB per extent)
			      C 
			      C ; EXTENT SIZING FOR 8GB FILE !!! SAMPLE !!!
			      C ;----------------------------------------------------------
			      C ; direct - 4 extents - 8GB (average 2GB per extent)  
			      C ; indirect - 256 extents - 8GB (average 32MB per extent)
			      C ; double ind. - 16384 extents - 8GB (avr. 512KB per extent)
			      C ; triple ind. - 1048576 extents - 8GB (avr. 8KB per extent)
			      C 
 0547			      C unix_fs_install proc near
			      C 	; 20/07/2022
			      C 	; 05/04/2022
			      C 	; 02/01/2020
			      C 	; 30/12/2019
			      C 	; 19/12/2019 - LBA/CHS type RUNIX HD partition boot sectors
			      C 	; 12/12/2019
			      C 	; 10/12/2019
			      C 	; 05/12/2019
			      C 	; 04/12/2019
			      C 	; 01/12/2019
			      C 	; 03/10/2019 - Retro UNIX 386 v2 (Hard Disk FS, 71h) 
			      C 	; 04/09/2019
			      C 	; 01/09/2019 - Retro UNIX 386 v2
			      C 	; 8086 code by Erdogan Tan
			      C 	; 31/10/2012
			      C 	; 21/08/2012
			      C 	; 15/08/2012
			      C 	; 14/08/2012
			      C 	; 13/08/2012
			      C 	; 05/08/2012
			      C 	; 04/08/2012
			      C 	; Derived from (original) UNIX v1 source code
			      C 	; PRELIMINARY release of Unix Implementation Document, 
			      C 	; 20/6/1972
			      C 	; RETRO UNIX v1 FS
			      C 	; initialization/format version
			      C 	; NOTE: 
			      C 	; The "cold" unix (u0, PDP-11) code is modified for fd0 
			      C 	;  -> 1.44 MB floppy disk (Retro UNIX v1, 8086) fs
			      C 
			      C 	; 19/12/2019
			      C 	; If [lba_rw]>0, change boot sector to LBA read type boot sector
 0547  80 3E 2ADA R 00	      C 	cmp	byte ptr [lba_rw], 0
 054C  76 0B		      C 	jna	short set_boot_sector_parms
			      C 
 054E  BE 2D38 R	      C 	mov	si, offset lba_boot_sector
 0551  BF 2B38 R	      C 	mov	di, offset boot_sector
 0554  B9 0100		      C 	mov	cx, 256
 0557  F3/ A5		      C 	rep	movsw
			      C 
 0559			      C set_boot_sector_parms:
			      C 	; 20/07/2022
			      C 	; 19/12/2019
			      C 	; 03/10/2019
			      C 	; Set Retro UNIX volume/partition Boot Sector Parameters
			      C 
			      C 	;mov	word ptr [boot_sector.bsFSystemID], 'UR'
			      C 	;mov	word ptr [boot_sector.bsFSystemID+2], 'SF'
			      C 	;mov	word ptr [boot_sector.bsDriveID], 'dh'
			      C 	;mov	byte ptr [boot_sector.bsDriveNumber], 80h
			      C 	
			      C 	; 19/12/2019 (heads and SPT values are single byte values)
 0559  A0 2AC2 R	      C 	mov	al, byte ptr [heads]
 055C  A2 2B47 R	      C 	mov	byte ptr [boot_sector.bsHeads], al
 055F  A0 2AC4 R	      C 	mov	al, byte ptr [sectors]
 0562  A2 2B46 R	      C 	mov	byte ptr [boot_sector.bsSecPerTrack], al
			      C 	
 0565  A1 2AC6 R	      C 	mov	ax, word ptr [cylinders]
 0568  A3 2B48 R	      C 	mov	word ptr [boot_sector.bsCylinders], ax
			      C 
			      C 	;xor 	ax, ax
			      C 	;mov	word ptr [boot_sector.bs_BF_I_number], ax
			      C 	;mov	word ptr [boot_sector.bsVolumeSerial], ax	
			      C 	;mov	word ptr [boot_sector.bsVolumeSerial+2], ax
			      C 	;mov	byte ptr [boot_sector.bsMagic], '@'
			      C 
			      C 	; 29/12/2019
 056B  A1 2B34 R	      C 	mov	ax, word ptr [VolumeSerial]
 056E  8B 16 2B36 R	      C 	mov	dx, word ptr [VolumeSerial+2]
 0572  A3 2B3E R	      C 	mov	word ptr [boot_sector.bsVolumeSerial], ax	
 0575  89 16 2B40 R	      C 	mov	word ptr [boot_sector.bsVolumeSerial+2], dx	
			      C 
 0579  A0 2ADA R	      C 	mov	al, byte ptr [lba_rw]
 057C  A2 2B45 R	      C 	mov	byte ptr [boot_sector.bsReserved], al ; 0 or 1
			      C 	; 20/07/2022
 057F  A2 0A78 R	      C 	mov	byte ptr [systm.sb_LBA_rw], al ; 0 or 1
			      C 
			      C 	; 19/12/2019
 0582  A1 2AC8 R	      C 	mov	ax, word ptr [hidden_sectors]
 0585  8B 16 2ACA R	      C 	mov	dx, word ptr [hidden_sectors+2]
 0589  A3 2B4E R	      C 	mov	word ptr [boot_sector.bsHiddenSects], ax
 058C  89 16 2B50 R	      C 	mov	word ptr [boot_sector.bsHiddenSects+2], dx	
			      C 
 0590  BE 2B3A R	      C 	mov	si, offset boot_sector.bsFSystemID
 0593  BF 0A50 R	      C 	mov	di, offset systm.sb_BootSecParms
			      C 	;mov	cx, 19
			      C 	;rep	movsb
			      C 	; 19/12/2019
 0596  B9 000C		      C 	mov	cx, 12 
 0599  F3/ A5		      C 	rep	movsw
			      C 
			      C 	; 01/09/2019
 059B  C7 06 0A10 R 0171      C 	mov word ptr [systm.sb_Header], 0171h
 05A1  C6 06 0A12 R A1	      C 	mov byte ptr [systm.sb_Header+2], 0A1h
			      C 
			      C 	; 10/10/2019
			      C 	;mov ax,word ptr [hidden_sectors]
			      C 	;mov dx,word ptr [hidden_sectors+2]
 05A6  A3 0A14 R	      C 	mov word ptr [systm.sb_BootSectAddr], ax
 05A9  89 16 0A16 R	      C 	mov word ptr [systm.sb_BootSectAddr+2], dx
			      C 	; 14/01/2020
			      C 	; 04/12/2019
			      C 	;mov word ptr [systm.sb_HiddenSects], ax
			      C 	;mov word ptr [systm.sb_HiddenSects+2], dx
			      C 	; 10/10/2019
 05AD  A1 2ACC R	      C 	mov ax,word ptr [total_sectors]
 05B0  8B 16 2ACE R	      C 	mov dx,word ptr [total_sectors+2]
 05B4  A3 0A18 R	      C 	mov word ptr [systm.sb_VolumeSize], ax
 05B7  89 16 0A1A R	      C 	mov word ptr [systm.sb_VolumeSize+2], dx
			      C 	; 14/01/2020
			      C 	;mov word ptr [systm.sb_TotalSects], ax
			      C 	;mov word ptr [systm.sb_TotalSects+2], dx
			      C 
 05BB  C6 06 0A1C R 01	      C 	mov byte ptr [systm.sb_Version], 1
			      C 	;mov dword ptr [systm.sb_BlockSize], 0
			      C 
			      C 	; 10/10/2019 - Retro UNIX 386 v2 - Default inode count calculation
			      C 	; inode count =
			      C 	;	256 up to 2MB file system
			      C 	;	512 up to 4MB file system
			      C 	;      1024 up to 8MB file system
			      C 	;      2048 up to 16MB file system
			      C 	;      4096 up to 32MB file system
			      C 	;      8192 up to 64MB file system
			      C 	;     16384 up to 128MB file system
			      C 	;     32768 up to 256MB file system
			      C 	;     65534 for 512MB to 2TB file system
			      C 	;
			      C 	; Formula:
			      C 	;	if dx >= 16, inode count = 65534
			      C 	;       if dx > 0, inode count 4096*dx
			      C 	;	if dx = 0, inode count ax/16
			      C 	;	(minimum file system size is 512KB) 				 		   
			      C 
 05C0  0B D2		      C 	or dx,dx
 05C2  75 0C		      C 	jnz short large_fs
 05C4  8B C8		      C 	mov cx,ax
 05C6  D1 E9		      C 	shr cx,1
 05C8  D1 E9		      C 	shr cx,1
 05CA  D1 E9		      C 	shr cx,1
 05CC  D1 E9		      C 	shr cx,1
 05CE  EB 14		      C 	jmp short big_fs
 05D0			      C large_fs:
 05D0  B9 FFFE		      C 	mov cx,65534	; 0FFFFh is reserved for long file names 
			      C 	;		; (or another extension)
 05D3  83 FA 10		      C 	cmp dx,16
 05D6  73 0C		      C 	jnb short big_fs
 05D8  8A EA		      C 	mov ch,dl
 05DA  D0 E5		      C 	shl ch,1
 05DC  D0 E5		      C 	shl ch,1
 05DE  D0 E5		      C 	shl ch,1
 05E0  D0 E5		      C 	shl ch,1
			      C 	     ; cx <= 61440	
 05E2  32 C9		      C 	xor cl,cl	
 05E4			      C big_fs:	
 05E4  89 0E 0A24 R	      C 	mov word ptr [systm.sb_InodeCount], cx
 05E8  C6 06 0A30 R 02	      C 	mov byte ptr [systm.sb_InodeMapAddr], 2
 05ED  8B D9		      C 	mov bx, cx
 05EF  D1 E9		      C 	shr cx,1
 05F1  D1 E9		      C 	shr cx,1
 05F3  D1 E9		      C 	shr cx,1
 05F5  83 E3 07		      C 	and bx,7
 05F8  74 01		      C 	jz short ufsi_1
 05FA  41		      C 	inc cx
 05FB			      C ufsi_1:	
 05FB  89 0E 0A34 R	      C 	mov word ptr [systm.sb_InodeMapSize],cx ; SIZE_INODE_MAP ; bytes
			      C 	;add cx,255 ; 05/12/2019
 05FF  81 C1 01FF	      C 	add cx,511 ; 05/04/2022 (sector count round up)
 0603  8A CD		      C 	mov cl,ch
 0605  32 ED		      C 	xor ch,ch
 0607  D0 E9		      C 	shr cl,1
 0609  80 C1 02		      C 	add cl,2 ; inode map address + inode map sectors
			      C 	;mov word ptr [systm.sb_FreeMapAddr],cx
 060C  88 0E 0A28 R	      C 	mov byte ptr [systm.sb_FreeMapAddr],cl ; 10/12/2019
 0610  83 C0 07		      C 	add ax,7 ; 05/12/2019
 0613  83 D2 00		      C 	adc dx,0
			      C 	;mov cl,8
			      C 	;call div32
			      C 	; 16/10/2019
 0616  B1 03		      C 	mov cl,3 ; /8
 0618  E8 FF05		      C 	call shr32
 061B  A3 0A2C R	      C 	mov word ptr [systm.sb_FreemapSize],ax ; SIZE_FREE_MAP lw ; bytes
 061E  89 16 0A2E R	      C 	mov word ptr [systm.sb_FreemapSize+2],dx ; SIZE_FREE_MAP hw ; bytes
			      C 
			      C 	; 05/12/2019
 0622  05 01FF		      C 	add ax,511
 0625  83 D2 00		      C 	adc dx,0
			      C 	
			      C 	; 16/10/2019
			      C 	; mov cx,9
 0628  B1 09		      C 	mov cl,9
 062A  E8 FEF3		      C 	call shr32	
			      C 
 062D  03 06 0A28 R	      C 	add ax,word ptr [systm.sb_FreeMapAddr]
 0631  13 16 0A2A R	      C 	adc dx,word ptr [systm.sb_FreeMapAddr+2]		
 0635  A3 0A38 R	      C 	mov word ptr [systm.sb_InodeTblAddr],ax
 0638  89 16 0A3A R	      C 	mov word ptr [systm.sb_InodeTblAddr+2],dx
			      C 
 063C  8B 0E 0A24 R	      C 	mov cx,word ptr [systm.sb_InodeCount]
			      C 
			      C 	; 05/12/2019
 0640  83 C1 07		      C 	add cx,7 ; round up
			      C 
 0643  D1 E9		      C 	shr cx,1
 0645  D1 E9		      C 	shr cx,1
 0647  D1 E9		      C 	shr cx,1 ; 8 inodes per sector
 0649  89 0E 0A3C R	      C 	mov word ptr [systm.sb_InodeTblSize],cx ; sectors
			      C 
 064D  03 C1		      C 	add ax,cx
 064F  83 D2 00		      C 	adc dx,0
 0652  A3 1700 R	      C 	mov word ptr [data_start],ax
 0655  89 16 1702 R	      C 	mov word ptr [data_start+2],dx
			      C 
			      C 	; 05/12/2019
 0659  B8 FFFF		      C 	mov ax,0FFFFh
			      C 				
			      C 	;mov word ptr [systm.sb_FreeInodes],0
			      C 	;mov word ptr [systm.sb_FreeInodes+2],0
			      C 	
			      C 	;mov word ptr [systm.sb_FirstFreeIno],ax ; 0FFFFh
			      C 	;mov word ptr [systm.sb_FirstFreeIno+2],ax ; 0FFFFh
			      C 
 065C  A3 0A48 R	      C 	mov word ptr [systm.sb_FreeBlocks],ax ; 0FFFFh
 065F  A3 0A4A R	      C 	mov word ptr [systm.sb_FreeBlocks+2],ax ; 0FFFFh
			      C 	
			      C 	;mov word ptr [systm.sb_FirstFreeBlk],ax ; 0FFFFh
			      C 	;mov word ptr [systm.sb_FirstFreeBlk+2],ax ;0FFFFh
			      C 
			      C 	;mov byte ptr [systm.sb_Status],0
			      C 	
			      C 	;mov word ptr [systm.sb_ModifTime],ax ; 0FFFFh
			      C 	;mov word ptr [systm.sb_ModifTime+2],ax ; 0FFFFh
			      C 
			      C 	; 08/09/2019 (UNIXFDFS) - 16/10/2019 (UNIXHDFS)
 0662  C7 06 0C0C R A100      C 	mov word ptr [systm.sb_Footer],0A100h
 0668  C7 06 0C0E R 7101      C 	mov word ptr [systm.sb_Footer+2],7101h
			      C 
			      C 	; 05/04/2022
			      C 	;mov ax,word ptr [systm.sb_FreeMapAddr]
			      C 	;mov dx,word ptr [systm.sb_FreeMapAddr+2]
			      C 	
 066E  BB 1B10 R	      C 	mov bx,offset fbm_buffer  ; fbm buffer is clear here
			      C 
			      C ; 05/04/2022
			      C ;
			      C ;	; 10/12/2019
			      C ;	; (Clear free map sectors on disk)
			      C ;ufsi_15:
			      C ;	or byte ptr [smod],1 ; free map modified flag
			      C ;	call dskwr
			      C ;	;jc short ufsi_8 ; error, exit
			      C ;	jc short ufsi_18 ; 10/12/2019
			      C ;	and byte ptr [smod],0FEh ; reset free map modified flag
			      C ;
			      C ;	cmp dx,word ptr [systm.sb_InodeTblAddr+2]
			      C ;	jb short ufsi_16
			      C ;	cmp ax,word ptr [systm.sb_InodeTblAddr]
			      C ;	jnb short ufsi_17	
			      C ;ufsi_16:
			      C ;	add ax,1
			      C ;	adc dx,0
			      C ;	add word ptr [fm_sector],1
			      C ;	adc word ptr [fm_sector+2],0
			      C ;	jmp short ufsi_15
			      C ;ufsi_18:
			      C ;	; 10/12/2019
			      C ;	retn
			      C 
			      C 	; 05/04/2022
			      C 	; (clear inode map, free blocks map and inode table sectors)
			      C 
 0671  B8 0002		      C 	mov ax,2 ; inode map address
 0674  33 D2		      C 	xor dx,dx
 0676			      C ufsi_15:
			      C 	;or byte ptr [smod],3 
			      C 			; set inode map & free map modified flags
 0676  E8 1743		      C 	call dskwr
 0679  72 1F		      C 	jc short ufsi_18
			      C 	;and byte ptr [smod],0FCh 
			      C 			; clear inode map, free map modified flags		
			      C 	
 067B  40		      C 	inc ax	; add ax,1
 067C  75 07		      C 	jnz short ufsi_16
 067E  3B 16 1702 R	      C 	cmp dx,word ptr [data_start+2]
 0682  74 0D		      C 	je short ufsi_17
 0684  42		      C 	inc dx	; adc dx,0		
 0685			      C ufsi_16:
 0685  3B 06 1700 R	      C 	cmp ax,word ptr [data_start]
 0689  72 EB		      C 	jb short ufsi_15
			      C 	;if ax >= [data_start], dx should be < [data_start+2]
 068B  3B 16 1702 R	      C 	cmp dx,word ptr [data_start+2]
 068F  72 E5		      C 	jb short ufsi_15	
			      C 
			      C 	; clearing finished...
 0691			      C ufsi_17:
			      C 	; 16/10/2019
 0691  A1 2ACC R	      C 	mov ax,word ptr [total_sectors]
 0694  8B 16 2ACE R	      C 	mov dx,word ptr [total_sectors+2]
			      C 
			      C 	; 05/04/2022
 0698  EB 01		      C 	jmp short @f
 069A			      C ufsi_18:
 069A  C3		      C 	retn
 069B			      C @@:
			      C 	; 05/04/2022
			      C 	; here..
			      C 	; dword ptr [fm_sector] = 0
			      C 	; byte ptr [smod] = 0
			      C 	; fm_buffer is clear (full zero)
 069B			      C ufsi_2:
			      C ;set bit DX:AX in free storage map in core/memory
 069B  83 E8 01		      C 	sub ax,1
 069E  83 DA 00		      C 	sbb dx,0
			      C 
 06A1  E8 1D65		      C 	call free
			      C 	;jc short ufsi_8 ; error, exit ; 07/11/2019
 06A4  72 F4		      C 	jc short ufsi_18 ; 30/12/2019
			      C 
			      C 	; dx:ax = current sector has been freed/released
			      C 
 06A6  3B 16 1702 R	      C 	cmp dx,word ptr [data_start+2]
 06AA  77 EF		      C         ja short ufsi_2
			      C 	;jb short @f ; 05/12/2019 	
			      C 
 06AC  3B 06 1700 R	      C 	cmp ax,word ptr [data_start]
 06B0  77 E9		      C         ja short ufsi_2 ; 05/12/2019
 06B2			      C @@:
			      C 	; 04/12/2019
			      C 	;mov word ptr [buff_c], 1 ; count
 06B2			      C ufsi_3:
			      C ; zero i-list	
			      C 	; set superblock (m) and inode (a/m/c) times
			      C 
 06B2  E8 1E5F		      C 	call epoch
 06B5  A3 0A6C R	      C 	mov word ptr [systm.sb_ModifTime],ax
 06B8  89 16 0A6E R	      C 	mov word ptr [systm.sb_ModifTime+2],dx
			      C 	
 06BC  80 0E 262B R F0	      C 	or byte ptr [smod],0F0h ; super block modified flag 
			      C 
 06C1  BF 0F2E R	      C 	mov di,offset inodes+52 ; 15/09/2019	
 06C4  B9 001A		      C 	mov cx,26
 06C7			      C ufsi_4:
 06C7  AB		      C 	stosw ; mov [di],ax   ; access (inode modification) time
 06C8  92		      C 	xchg ax,dx
 06C9  AB		      C 	stosw ; mov [di+2],dx
 06CA  92		      C 	xchg ax,dx
 06CB  AB		      C 	stosw ; mov [di+4],ax ; (file) modification time
 06CC  92		      C 	xchg ax,dx
 06CD  AB		      C 	stosw ; mov [di+6],dx
 06CE  92		      C 	xchg ax,dx
 06CF  AB		      C 	stosw ; mov [di+8],ax ; (file & inode) creation time
 06D0  92		      C 	xchg ax,dx
 06D1  AB		      C 	stosw ; mov [di+10],dx		
 06D2  92		      C 	xchg ax,dx	
 06D3  83 C7 34		      C 	add di,64-12 ; next inode
 06D6  E2 EF		      C 	loop ufsi_4
			      C 
			      C 	; 19/10/2019
 06D8  A1 0A38 R	      C 	mov ax,word ptr [systm.sb_InodeTblAddr]
 06DB  8B 16 0A3A R	      C 	mov dx,word ptr [systm.sb_InodeTblAddr+2]
			      C 
			      C 	; write default/initial inodes - Retro UNIX 386 v2
 06DF  BB 0EFA R	      C 	mov bx,offset inodes ; 07/11/2019
			      C 	; 04/12/2019
 06E2  C6 06 0A06 R 04	      C 	mov byte ptr [buff_c],32/8 ; 4 sectors for 32 inodes
 06E7			      C ufsi_5:	
			      C 	; 01/12/2019
 06E7  A3 0A00 R	      C 	mov word ptr [buff_s],ax ; Start sector of inode table
 06EA  89 16 0A02 R	      C 	mov word ptr [buff_s+2],dx
			      C 
 06EE  C6 06 0A04 R 01	      C 	mov byte ptr [buff_m],1 ; modified
 06F3  E8 16C6		      C 	call dskwr
 06F6  72 3E		      C 	jc short ufsi_8 ; rw_error
 06F8  C6 06 0A04 R 00	      C 	mov byte ptr [buff_m],0 ; reset ; 07/11/2019
			      C 	; 04/12/2019
			      C 	;dec word ptr [buff_c]
 06FD  FE 0E 0A06 R	      C 	dec byte ptr [buff_c]
 0701  74 0B		      C 	jz short ufsi_6
			      C 	; 07/11/2019
			      C 	;mov ax,word ptr [buff_s]
			      C 	;mov dx,word ptr [buff_s+2]
 0703  83 C0 01		      C 	add ax,1	; next sector
 0706  83 D2 00		      C 	adc dx,0
			      C 	;;mov bx,word ptr [buff_o]
			      C 	;add bx,512	; next 8 inodes
 0709  80 C7 02		      C 	add bh,2 ; 04/12/2019
 070C  EB D9		      C 	jmp short ufsi_5 ; loop
 070E			      C ufsi_6:
			      C 	; 23/10/2019
 070E  B8 001B		      C 	mov ax,27  ; First free inode
 0711  A3 0A44 R	      C 	mov word ptr [systm.sb_FirstFreeIno],ax
			      C 	;mov word ptr [systm.sb_FirstFreeIno+2],0
 0714  8B 1E 0A24 R	      C 	mov bx,word ptr [systm.sb_InodeCount]
			      C 
			      C ; 05/04/2022
			      C ;	; 04/12/2019
			      C ;	mov dx,bx
			      C ;	mov cl,12 ; inodes/4096
			      C ;	shr dx,cl ; 4096 inode allocation bits per sector
			      C ;
			      C ;	test bx,4095 ; +1 inode map sector ?
			      C ;	jz short ufsi_12
			      C ;	inc dx
			      C ;ufsi_12:
			      C ;	; 05/04/2022 
			      C ;	;mov word ptr [im_scount],dx ; inode map sector count
			      C 
 0718  2B D8		      C 	sub bx,ax
 071A  43		      C 	inc bx
 071B  89 1E 0A40 R	      C 	mov word ptr [systm.sb_FreeInodes],bx	
			      C 
			      C 	; 01/12/2019
			      C 	;mov bx,1  ; start from root directory inode number
			      C 	; 07/11/2019
 071F  BA 0001		      C 	mov dx,1
			      C 
			      C 	;; 05/04/2022
			      C 	;; clear inode map buffer (im_buffer = fbm_buffer)
			      C 	;xor ax,ax
			      C 	;mov di,offset im_buffer ; fbm_buffer
			      C 	;mov cx,256
			      C 	;rep stosw
			      C 
			      C 	; 05/04/2022
			      C 	; here..
			      C 	; dword ptr [im_sector] = 0
			      C 	; byte ptr [smod] = 0F0h
			      C 	; im_buffer is clear (full zero)
			      C 
 0722			      C ufsi_7:
 0722  E8 17EB		      C 	call imap
 0725  72 0F		      C 	jc short ufsi_8 ; 02/01/2020
			      C 	
			      C 	;xchg bx,dx
 0727  08 07		      C 	or byte ptr [bx],al ; set the bit to indicate the i-node
			      C 			    ; is not available/free
			      C 
 0729  80 0E 262B R 02	      C 	or byte ptr [smod],2 ; 02/01/2020
			      C 
			      C 	;xchg bx,dx
			      C 	;cmp bx,26
 072E  83 FA 1A		      C 	cmp dx,26
 0731  73 04		      C 	jnb short ufsi_9
			      C 	;inc bx
 0733  42		      C 	inc dx
 0734  EB EC		      C 	jmp short ufsi_7
			      C 	; 30/12/2019
 0736			      C ufsi_8: 
			      C 	; 06/09/2019
 0736  C3		      C 	retn
 0737			      C ufsi_9:
			      C ; 05/04/2022
			      C ;	; 04/12/2019
			      C ;	;mov ax,word ptr [systm.sb_InodeMapAddr]
			      C ;	;mov dx,word ptr [systm.sb_InodeMapAddr+2]
			      C ;	mov ax,2
			      C ;	xor dx,dx ; 0
			      C ;	;add ax,word ptr [im_sector] ; Inode map sector (index)
			      C ;	;adc dx,0
			      C ;
			      C ;	; 04/12/2019
			      C ;	mov bx,offset im_buffer
			      C ;	;or byte ptr [smod],2 ; inode map modified
			      C ;	or byte ptr [smod],al ; 2 ; 12/12/2019
			      C ;	call dskwr
			      C ;	jc short ufsi_8 ; rw_error
			      C ;
			      C ;	and byte ptr [smod],0FDh ; not 2 ; reset
			      C ;
			      C ;	cmp word ptr [im_scount],1 ; inode map sector count
			      C ;	jna short ufsi_14
			      C ;
			      C ;	; clear inode map buffer
			      C ;	xor ax,ax
			      C ;	mov di,offset im_buffer
			      C ;	mov cx,256
			      C ;	rep stosw
			      C ;
			      C ;	;mov ax,word ptr [im_sector]
			      C ;	inc ax
			      C ;	;mov ax,1
			      C ;ufsi_13:
			      C ;	mov word ptr [im_sector],ax
			      C ;
			      C ;	;mov dx,word ptr [systm.sb_InodeMapAddr+2]
			      C ;	;add ax,word ptr [systm.sb_InodeMapAddr]
			      C ;	;adc dx,0
			      C ;	
			      C ;	;xor dx,dx ; 0
			      C ;	add ax,2 ; inode map start address (offset from boot sector)
			      C ;	;adc dx,0
			      C ;
			      C ;	;mov bx,offset im_buffer
			      C ;	or byte ptr [smod],2 ; inode map modified
			      C ;	call dskwr
			      C ;	jc short ufsi_8 ; rw_error
			      C ;
			      C ;	and byte ptr [smod],0FDh ; not 2 ; reset
			      C ;
			      C ;	mov ax,word ptr [im_sector]
			      C ;	inc ax
			      C ;	cmp ax,word ptr [im_scount] ; inode map sector count
			      C ;	jb short ufsi_13
 0737			      C ufsi_14:
			      C 	; 14/12/2019
 0737  E8 002C		      C 	call sync
			      C 
			      C 	; 02/09/2019 - Retro UNIX 386 v2
			      C 	; make & write directories
 073A  BF 0C10 R	      C 	mov di,offset dirs
 073D  BB 0001		      C 	mov bx,1 ; start from inode number of root directory
			      C 	;mov si,offset inodes  ; root_inode
			      C 	;add si,8 ; si points to directory size in root inode
			      C 	; 09/09/2019
 0740  BE 0EEC R	      C 	mov si,offset i_dir_sizes
 0743			      C ufsi_10:
			      C 	;mov ax,[si]
 0743  AD		      C 	lodsw ; 09/09/2019
 0744  A3 0EA4 R	      C 	mov word ptr [u_count],ax
			      C 	
 0747  89 3E 0EA6 R	      C         mov word ptr [u_base],di
 074B  03 F8		      C 	add di,ax
			      C 
 074D  C7 06 0EA8 R 0EA0 R    C 	mov word ptr [u_fofp],offset u_off ; 31/10/2012
 0753  C7 06 0EA0 R 0000      C         mov word ptr [u_off],0
			      C         ;mov word ptr [u_off+2],0
			      C 
 0759  E8 1820		      C 	call writei
 075C  72 D8		      C 	jc short ufsi_8 ; rw_error ; 30/12/2019 (short jump)
			      C 
			      C 	; 14/12/2019
			      C 	;push bx
			      C 	;call sync
			      C 	;pop bx
			      C 
 075E  83 FB 07		      C 	cmp bx,7 ; inode number of mnt directory
 0761  73 03		      C 	jnb short ufsi_11
			      C 
			      C 	;add si,64 ; now, si points to dir size word of next inode
			      C 
 0763  43		      C 	inc bx
 0764  EB DD		      C 	jmp short ufsi_10
			      C 
 0766			      C ufsi_11:	
			      C 	; 19/10/2019
			      C 	;jmp short sync
			      C 
 0766			      C unix_fs_install endp
			      C 
 0766			      C sync 	proc near
			      C 	; 05/04/2022
			      C 	; 02/01/2020
			      C 	; 01/12/2019
			      C 	; 05/11/2019
			      C 	; 21/10/2019 - Retro UNIX 386 v2 - Hard Disk File System
			      C 	; 05/09/2019
			      C 	; 02/09/2019 - Retro UNIX 386 v2
			      C 	; 12/8/2012
			      C 	; updates super block and the last i-node on disk 
			      C 	; if modified
			      C 	; e.g. smod = 1, imod = 1, buffer_m = 1
			      C 	;
			      C 	; RETRO UNIX v1 FS
			      C 	; initialization/format version
			      C 
 0766  33 DB		      C 	xor bx, bx ; mov bx,0
 0768  E8 15A5		      C 	call iget ; (write modified i-node)
			      C 	;jc short sync_18 ; 02/01/2020
 076B  73 03		      C 	jnc short @f
 076D  E9 009B		      C 	jmp sync_18
 0770			      C @@:
			      C 	; 02/01/2020
 0770  80 3E 0A04 R 00	      C 	cmp byte ptr [buff_m],0
 0775  76 17		      C 	jna short sync_0
			      C 
 0777  A1 0A00 R	      C 	mov ax,word ptr [buff_s]
 077A  8B 16 0A02 R	      C 	mov dx,word ptr [buff_s+2]
 077E  BB 1910 R	      C 	mov bx,offset Buffer
 0781  E8 1638		      C 	call dskwr
			      C 	;jc short sync_18
 0784  73 03		      C 	jnc short @f
 0786  E9 0082		      C 	jmp sync_18
 0789			      C @@:
 0789  C6 06 0A04 R 00	      C 	mov byte ptr [buff_m],0
 078E			      C sync_0:
 078E  80 3E 262B R 00	      C 	cmp byte ptr [smod],0
			      C 	;jna sync_17
			      C 	; 02/01/2020
 0793  77 03		      C 	ja short @f
 0795  E9 0182		      C 	jmp sync_17	
 0798			      C @@:
			      C 	; 02/01/2020
			      C 	; set super block modification time
 0798  E8 1D79		      C 	call epoch
 079B  A3 0A6C R	      C 	mov word ptr [systm.sb_ModifTime],ax
 079E  89 16 0A6E R	      C 	mov word ptr [systm.sb_ModifTime+2],dx
			      C 
 07A2  F6 06 262B R 02	      C 	test byte ptr [smod],2 ; inode map modified 
 07A7  74 7F		      C 	jz short sync_7
			      C 
 07A9  33 D2		      C 	xor dx,dx
 07AB  A1 170C R	      C 	mov ax,word ptr [im_sector]
 07AE  03 06 0A30 R	      C 	add ax,word ptr [systm.sb_InodeMapAddr]
 07B2  13 16 0A32 R	      C 	adc dx,word ptr [systm.sb_InodeMapAddr+2]
 07B6  BB 1710 R	      C 	mov bx,offset im_buffer
			      C 
 07B9  E8 1600		      C 	call dskwr
			      C 	;jc short sync_18
			      C 	; 02/01/2020
 07BC  73 02		      C 	jnc short @f
 07BE  EB 4B		      C 	jmp sync_18	
 07C0			      C @@:
 07C0  80 26 262B R FD	      C 	and byte ptr [smod],0FDh ; reset bit 1
			      C 
			      C 	; 02/01/2020
			      C 	; set free inodes number
			      C 	; if it is invalid (in sb)
			      C 
 07C5  83 3E 0A40 R FF	      C 	cmp word ptr [systm.sb_FreeInodes],0FFFFh ; invalid
 07CA  72 5C		      C 	jb short sync_7
			      C 
 07CC  8B 0E 0A24 R	      C 	mov cx,word ptr [systm.sb_InodeCount] ; <= 65534
 07D0  89 0E 1704 R	      C 	mov word ptr [count],cx
 07D4  A1 0A30 R	      C 	mov ax,word ptr [systm.sb_InodeMapAddr]
 07D7  8B 16 0A32 R	      C 	mov dx,word ptr [systm.sb_InodeMapAddr+2]
 07DB  33 ED		      C 	xor bp,bp ; 0
 07DD  89 2E 170C R	      C 	mov word ptr [im_sector],bp ; 0
 07E1			      C sync_1:
 07E1  BB 1710 R	      C 	mov bx,offset im_buffer
 07E4  A3 30EA R	      C 	mov word ptr [save_ax],ax
 07E7  89 16 30EC R	      C 	mov word ptr [save_dx],dx
 07EB  E8 15D5		      C 	call dskrd
 07EE  72 38		      C 	jc short sync_7
 07F0			      C sync_2:
 07F0  B9 0008		      C 	mov cx,8
 07F3  8A 07		      C 	mov al,byte ptr [bx] ; 02/01/2020
 07F5			      C sync_3:
 07F5  D0 E8		      C 	shr al,1 ; 02/01/2020
 07F7  72 01		      C 	jc short sync_4 ; allocated inode
 07F9  45		      C 	inc bp		; free inode
 07FA			      C sync_4:
 07FA  FF 0E 1704 R	      C 	dec word ptr [count]
 07FE  74 22		      C 	jz short sync_6
 0800  E2 F3		      C 	loop sync_3
 0802  81 FB 190F R	      C 	cmp bx,offset im_buffer+511
 0806  73 07		      C 	jnb short sync_5
 0808  43		      C 	inc bx
 0809  EB E5		      C 	jmp short sync_2
 080B			      C sync_18:
 080B  A1 2629 R	      C 	mov ax,word ptr [Error]
 080E  C3		      C 	retn
 080F			      C sync_5: 
 080F  FF 06 170C R	      C 	inc word ptr [im_sector]
 0813  A1 30EA R	      C 	mov ax,word ptr [save_ax]
 0816  8B 16 30EC R	      C 	mov dx,word ptr [save_dx]
 081A  83 C0 01		      C 	add ax,1
 081D  83 D2 00		      C 	adc dx,0
 0820  EB BF		      C 	jmp short sync_1
 0822			      C sync_6:
 0822  89 2E 0A40 R	      C 	mov word ptr [systm.sb_FreeInodes],bp
			      C 	; ***
 0826  EB 0F		      C 	jmp short sync_19 ; 02/01/2020
 0828			      C sync_7:
			      C 	; 02/01/2020
			      C 	; set first free inode number
			      C 	; if it is invalid (in sb)
			      C 
 0828  BA FFFF		      C 	mov dx,0FFFFh
 082B  39 16 0A44 R	      C 	cmp word ptr [systm.sb_FirstFreeIno],dx ; 0FFFFh
 082F  75 09		      C 	jne short @f
 0831  39 16 0A46 R	      C 	cmp word ptr [systm.sb_FirstFreeIno+2],dx ; 0FFFFh		
 0835  75 03		      C 	jne short @f
 0837			      C sync_19:
 0837  E8 00E3		      C 	call set_firstfreeinode
 083A			      C @@:
 083A  F6 06 262B R 01	      C 	test byte ptr [smod],1 ; free map modified
			      C 	;jz sync_15
			      C 	; 05/04/2022
 083F  75 03		      C 	jnz short @f
 0841  E9 00AF		      C 	jmp sync_15	
 0844			      C @@:	
 0844  A1 1708 R	      C 	mov ax,word ptr [fm_sector]
 0847  8B 16 170A R	      C 	mov dx,word ptr [fm_sector+2]
			      C 
 084B  03 06 0A28 R	      C 	add ax,word ptr [systm.sb_FreeMapAddr]
 084F  13 16 0A2A R	      C 	adc dx,word ptr [systm.sb_FreeMapAddr+2]
			      C 
 0853  BB 1B10 R	      C 	mov bx,offset fbm_buffer 	
 0856  E8 1563		      C 	call dskwr
 0859  72 B0		      C 	jc short sync_18
			      C 
 085B  80 26 262B R FE	      C 	and byte ptr [smod],0FEh ; reset bit 0
			      C 
			      C 	; 02/01/2020
			      C 	; set free blocks number
			      C 	; if it is invalid (in sb)
			      C 
 0860  A1 0A48 R	      C 	mov ax,word ptr [systm.sb_FreeBlocks] 	
 0863  23 06 0A4A R	      C 	and ax,word ptr [systm.sb_FreeBlocks+2]
 0867  83 F8 FF		      C 	cmp ax,0FFFFh 
			      C 	;jb sync_15
			      C 	; 02/01/2020
 086A  73 03		      C 	jnb short @f
 086C  E9 0084		      C 	jmp sync_15
 086F			      C @@:
 086F  A1 0A18 R	      C 	mov ax,word ptr [systm.sb_VolumeSize]
 0872  8B 16 0A1A R	      C 	mov dx,word ptr [systm.sb_VolumeSize+2]	
 0876  A3 1704 R	      C 	mov word ptr [count],ax
 0879  89 16 1706 R	      C 	mov word ptr [count+2],dx
			      C 
 087D  A1 0A28 R	      C 	mov ax,word ptr [systm.sb_FreeMapAddr]
 0880  8B 16 0A2A R	      C 	mov dx,word ptr [systm.sb_FreeMapAddr+2]
 0884  33 F6		      C 	xor si,si
 0886  33 FF		      C 	xor di,di
 0888  89 36 1708 R	      C 	mov word ptr [fm_sector],si ; 0
 088C  89 3E 170A R	      C 	mov word ptr [fm_sector+2],di
 0890			      C sync_8:
 0890  BB 1B10 R	      C 	mov bx,offset fbm_buffer
 0893  A3 30EA R	      C 	mov word ptr [save_ax],ax
 0896  89 16 30EC R	      C 	mov word ptr [save_dx],dx
 089A  E8 1526		      C 	call dskrd
 089D  72 54		      C 	jc short sync_15
 089F			      C sync_9:
 089F  B9 0008		      C 	mov cx,8
 08A2  8A 07		      C 	mov al,byte ptr [bx] ; 02/01/2020
 08A4			      C sync_10:	 	
 08A4  D0 E8		      C 	shr al,1	; 02/01/2020
 08A6  73 06		      C 	jnc short sync_11 ; allocated block/sector
 08A8  83 C6 01		      C 	add si,1	  ; free block/sector
 08AB  73 01		      C 	jnc short sync_11
			      C 	;adc di,0
 08AD  47		      C 	inc di
 08AE			      C sync_11:
 08AE  83 2E 1704 R 01	      C 	sub word ptr [count],1
 08B3  77 10		      C 	ja short sync_12
 08B5  74 07		      C 	jz short sync_20 ; 02/01/2020
			      C 
			      C 	; 02/01/2020
 08B7  83 1E 1706 R 00	      C 	sbb word ptr [count+2],0
 08BC  EB 07		      C 	jmp short sync_12
 08BE			      C sync_20:
			      C 	; 02/01/2020
 08BE  83 3E 1706 R 00	      C 	cmp word ptr [count+2],0
 08C3  76 24		      C 	jna short sync_14
 08C5			      C sync_12:
 08C5  E2 DD		      C 	loop sync_10
 08C7  81 FB 1D0F R	      C 	cmp bx,offset fbm_buffer+511
 08CB  73 03		      C 	jnb short sync_13
 08CD  43		      C 	inc bx
 08CE  EB CF		      C 	jmp short sync_9
 08D0			      C sync_13: 
 08D0  83 06 1708 R 01	      C 	add word ptr [fm_sector],1
 08D5  83 16 170A R 00	      C 	adc word ptr [fm_sector+2],0	
 08DA  A1 30EA R	      C 	mov ax,word ptr [save_ax]
 08DD  8B 16 30EC R	      C 	mov dx,word ptr [save_dx]
 08E1  83 C0 01		      C 	add ax,1
 08E4  83 D2 00		      C 	adc dx,0
 08E7  EB A7		      C 	jmp short sync_8
 08E9			      C sync_14:
 08E9  89 36 0A48 R	      C 	mov word ptr [systm.sb_FreeBlocks],si
 08ED  89 3E 0A4A R	      C 	mov word ptr [systm.sb_FreeBlocks+2],di
			      C 	; ***
 08F1  EB 0F		      C 	jmp short sync_16 ; 02/01/2020
 08F3			      C sync_15:	
			      C 	; 02/01/2020
			      C 	; set first free block number
			      C 	; set free blocks number
			      C 	; if it is invalid (in sb)
			      C 
 08F3  BA FFFF		      C 	mov dx,0FFFFh
 08F6  39 16 0A4C R	      C 	cmp word ptr [systm.sb_FirstFreeBlk], dx ; 0FFFFh
 08FA  75 09		      C 	jne short @f
 08FC  39 16 0A4E R	      C 	cmp word ptr [systm.sb_FirstFreeBlk+2], dx ; 0FFFFh		
 0900  75 03		      C 	jne short @f
 0902			      C sync_16:
 0902  E8 006F		      C 	call set_firstfreeblock
 0905			      C @@:		
 0905  33 D2		      C  	xor dx,dx
 0907  B8 0001		      C 	mov ax,1 ; Super block address (in 71h/RUNIX partition)
 090A  BB 0A10 R	      C 	mov bx,offset systm 
 090D  E8 14AC		      C 	call dskwr
			      C 	;jc sync_18
 0910  73 03		      C 	jnc short @f
 0912  E9 FEF6		      C 	jmp sync_18
 0915			      C @@:
 0915  C6 06 262B R 00	      C 	mov byte ptr [smod],0 ; reset
 091A			      C sync_17:
 091A  33 C0		      C 	xor ax,ax
 091C  C3		      C 	retn
			      C 
 091D			      C sync	endp
			      C 
 091D			      C set_firstfreeinode proc near
			      C 	; 02/01/2020 Retro UNIX 386 v2
			      C 	; 	     (Hard Disk FS, 71h partition)
			      C 	; set first free inode number in sb
			      C 	; Output:
			      C 	;   cf = 0 -> calculated
			      C 	;   cf = 1 = can not be calculated 
			      C 
 091D  33 ED		      C 	xor bp,bp
 091F  89 2E 170C R	      C 	mov word ptr [im_sector],bp ; 0
			      C 
 0923  8B 0E 0A24 R	      C 	mov cx,word ptr [systm.sb_InodeCount] ; <= 65534
 0927  89 0E 1704 R	      C 	mov word ptr [count],cx
 092B  A1 0A30 R	      C 	mov ax,word ptr [systm.sb_InodeMapAddr]
 092E  8B 16 0A32 R	      C 	mov dx,word ptr [systm.sb_InodeMapAddr+2]
 0932			      C sffi_1:
 0932  BB 1710 R	      C 	mov bx,offset im_buffer
 0935  A3 30EA R	      C 	mov word ptr [save_ax],ax
 0938  89 16 30EC R	      C 	mov word ptr [save_dx],dx
 093C  E8 1484		      C 	call dskrd
 093F  72 0E		      C 	jc short sffi_4
 0941			      C sffi_2:
 0941  B9 0008		      C 	mov cx,8
 0944  8A 07		      C 	mov al,byte ptr [bx]
 0946			      C sffi_3:
 0946  45		      C 	inc bp
 0947  D0 E8		      C 	shr al,1
 0949  72 05		      C 	jc short sffi_5 ; allocated inode
 094B  89 2E 0A44 R	      C 	mov word ptr [systm.sb_FirstFreeIno],bp	; first free inode
 094F			      C sffi_4:
 094F  C3		      C 	retn
 0950			      C sffi_5:
 0950  FF 0E 1704 R	      C 	dec word ptr [count]
 0954  74 F9		      C 	jz short sffi_4
 0956  E2 EE		      C 	loop sffi_3
 0958  81 FB 190F R	      C 	cmp bx,offset im_buffer+511
 095C  73 03		      C 	jnb short sffi_6
 095E  43		      C 	inc bx
 095F  EB E0		      C 	jmp short sffi_2
 0961			      C sffi_6: 
 0961  FF 06 170C R	      C 	inc word ptr [im_sector]
 0965  A1 30EA R	      C 	mov ax,word ptr [save_ax]
 0968  8B 16 30EC R	      C 	mov dx,word ptr [save_dx]
 096C  83 C0 01		      C 	add ax,1
 096F  83 D2 00		      C 	adc dx,0
 0972  EB BE		      C 	jmp short sffi_1
			      C 
 0974			      C set_firstfreeinode endp
			      C 
 0974			      C set_firstfreeblock proc near
			      C 	; 02/01/2020 Retro UNIX 386 v2
			      C 	; 	     (Hard Disk FS, 71h partition)
			      C 	; set first free block number in sb
			      C 	; Output:
			      C 	;   cf = 0 -> calculated
			      C 	;   cf = 1 = can not be calculated 
			      C 
 0974  A1 0A18 R	      C 	mov ax,word ptr [systm.sb_VolumeSize]
 0977  8B 16 0A1A R	      C 	mov dx,word ptr [systm.sb_VolumeSize+2]	
 097B  A3 1704 R	      C 	mov word ptr [count],ax
 097E  89 16 1706 R	      C 	mov word ptr [count+2],dx
			      C 
 0982  A1 0A28 R	      C 	mov ax,word ptr [systm.sb_FreeMapAddr]
 0985  8B 16 0A2A R	      C 	mov dx,word ptr [systm.sb_FreeMapAddr+2]
 0989  33 F6		      C 	xor si,si
 098B  33 FF		      C 	xor di,di
 098D  89 36 1708 R	      C 	mov word ptr [fm_sector],si ; 0
 0991  89 3E 170A R	      C 	mov word ptr [fm_sector+2],di
			      C 
 0995  4E		      C 	dec si ; 0FFFFh
 0996  4F		      C 	dec di ; 0FFFFh
 0997			      C sffb_1:
 0997  BB 1B10 R	      C 	mov bx,offset fbm_buffer
 099A  A3 30EA R	      C 	mov word ptr [save_ax],ax
 099D  89 16 30EC R	      C 	mov word ptr [save_dx],dx
 09A1  E8 141F		      C 	call dskrd
 09A4  72 19		      C 	jc short sffb_5
 09A6			      C sffb_2:
 09A6  B9 0008		      C 	mov cx,8
 09A9  8A 07		      C 	mov al,byte ptr [bx]
 09AB			      C sffb_3:	 	
 09AB  83 C6 01		      C 	add si,1
 09AE  73 03		      C 	jnc short sffb_4
 09B0  83 D7 00		      C 	adc di,0
 09B3			      C sffb_4:	
 09B3  D0 E8		      C 	shr al,1
 09B5  73 09		      C 	jnc short sffb_6 ; allocated block/sector
			      C 	; free block/sector
 09B7  89 36 0A4C R	      C 	mov word ptr [systm.sb_FirstFreeBlk],si
 09BB  89 3E 0A4E R	      C 	mov word ptr [systm.sb_FirstFreeBlk+2],di	
 09BF			      C sffb_5:
 09BF  C3		      C 	retn
 09C0			      C sffb_6:
 09C0  83 2E 1704 R 01	      C 	sub word ptr [count],1
 09C5  77 12		      C 	ja short sffb_8
 09C7  74 07		      C 	jz short sffb_7
			      C 
 09C9  83 1E 1706 R 00	      C 	sbb word ptr [count+2],0
 09CE  EB 09		      C 	jmp short sffb_8
 09D0			      C sffb_7:	
 09D0  83 3E 1706 R 00	      C 	cmp word ptr [count+2],0
 09D5  77 02		      C 	ja short sffb_8
 09D7  F9		      C 	stc
 09D8  C3		      C 	retn
 09D9			      C sffb_8:
 09D9  E2 D0		      C 	loop sffb_3
 09DB  81 FB 1D0F R	      C 	cmp bx,offset fbm_buffer+511
 09DF  73 03		      C 	jnb short sffb_9
 09E1  43		      C 	inc bx
 09E2  EB C2		      C 	jmp short sffb_2
 09E4			      C sffb_9: 
 09E4  83 06 1708 R 01	      C 	add word ptr [fm_sector],1
 09E9  83 16 170A R 00	      C 	adc word ptr [fm_sector+2],0	
 09EE  A1 30EA R	      C 	mov ax,word ptr [save_ax]
 09F1  8B 16 30EC R	      C 	mov dx,word ptr [save_dx]
 09F5  83 C0 01		      C 	add ax,1
 09F8  83 D2 00		      C 	adc dx,0
 09FB  EB 9A		      C 	jmp short sffb_1
			      C 
 09FD			      C set_firstfreeblock endp
			      C 
			      C align 2
			      C ; 01/12/2019
 09FE  00		      C 	db 0
 09FF			      C drive:	; 03/12/2019
 09FF 00		      C buff_d: db 0
 0A00 FFFF		      C buff_s: dw 0FFFFh ; Buffer sector
 0A02  FFFF		      C 	dw 0FFFFh ; 19/10/2019 (32 bit sector address)
 0A04 00		      C buff_m:	db 0 ; buffer changed/modified (dirty) flag
 0A05 00		      C buff_w: db 0 ; read/write flag (write=1, read=0)
 0A06 0000		      C buff_c: dw 0 ; count ; 05/09/2019
			      C 
			      C align 16
			      C 
 0A10			      C systm: ; superblock
 0A10  0200 [		      C 	db 512 dup(0)
        00
       ]
			      C 
			      C ; 01/09/2019 - Retro UNIX 386 v2
 0C10			      C dirs:
 0C10			      C root_dir: ; root directory
 0C10  0001		      C 		dw 1
 0C12  2E		      C 		db "."
 0C13  000D [		      C 		db 13 dup(0)
        00
       ]
 0C20  0001		      C 		dw 1
 0C22  2E 2E		      C 		db ".."
 0C24  000C [		      C 		db 12 dup(0)
        00
       ]
 0C30  0002		      C 		dw 2
 0C32  64 65 76		      C 		db "dev"
 0C35  000B [		      C 		db 11 dup(0)
        00
       ]
 0C40  0003		      C 		dw 3
 0C42  62 69 6E		      C 		db "bin"
 0C45  000B [		      C 		db 11 dup(0)
        00
       ]
 0C50  0004		      C 		dw 4
 0C52  65 74 63		      C 		db "etc"
 0C55  000B [		      C 		db 11 dup(0)
        00
       ]
 0C60  0005		      C 		dw 5
 0C62  75 73 72		      C 		db "usr"
 0C65  000B [		      C 		db 11 dup(0)
        00
       ]
 0C70  0006		      C 		dw 6
 0C72  74 6D 70		      C 		db "tmp"
 0C75  000B [		      C 		db 11 dup(0)
        00
       ]
 0C80  0007		      C 		dw 7
 0C82  6D 6E 74		      C 		db "mnt"
 0C85  000B [		      C 		db 11 dup(0)
        00
       ]
			      C 
			      C ; 04/12/2015 (14 byte file name modifications)
			      C ; 5/8/2012
			      C ; 14/7/2012
			      C ;dirs:
			      C ;root_dir: ; root directory
			      C ;		dw 41
			      C ;		db ".."
			      C ;		db 12 dup(0)
			      C ;		dw 41
			      C ;		db "."
			      C ;		db 13 dup(0)
			      C ;		dw 42
			      C ;		db "dev"
			      C ;		db 11 dup(0)
			      C ;		dw 43
			      C ;		db "bin"
			      C ;		db 11 dup(0)
			      C ;		dw 44
			      C ;		db "etc"
			      C ;		db 11 dup(0)
			      C ;		dw 45
			      C ;		db "usr"
			      C ;		db 11 dup(0)
			      C ;		dw 46
			      C ;		db "tmp"
			      C ;		db 11 dup(0)
			      C 
 0C90 = 0080		      C size_root_dir equ $ - offset root_dir
			      C 
 0C90			      C dev_dir: ; device directory
 0C90  0002		      C 		dw 2
 0C92  2E		      C 		db "."
 0C93  000D [		      C 		db 13 dup(0)		
        00
       ]
 0CA0  0001		      C 		dw 1
 0CA2  2E 2E		      C 		db ".."
 0CA4  000C [		      C 		db 12 dup(0)		
        00
       ]
 0CB0  0008		      C 		dw 8
 0CB2  74 74 79		      C 		db "tty"
 0CB5  000B [		      C 		db 11 dup(0)		
        00
       ]
 0CC0  0009		      C 		dw 9
 0CC2  6D 65 6D		      C 		db "mem"
 0CC5  000B [		      C 		db 11 dup(0)		
        00
       ]
 0CD0  000A		      C 		dw 10
 0CD2  66 64 30		      C 		db "fd0"
 0CD5  000B [		      C 		db 11 dup(0)		
        00
       ]
 0CE0  000B		      C 		dw 11
 0CE2  66 64 31		      C 		db "fd1"
 0CE5  000B [		      C 		db 11 dup(0)		
        00
       ]
 0CF0  000C		      C 		dw 12
 0CF2  68 64 30		      C 		db "hd0"
 0CF5  000B [		      C 		db 11 dup(0)		
        00
       ]
 0D00  000D		      C 		dw 13
 0D02  68 64 31		      C 		db "hd1"
 0D05  000B [		      C 		db 11 dup(0)		
        00
       ]
 0D10  000E		      C 		dw 14
 0D12  68 64 32		      C 		db "hd2"
 0D15  000B [		      C 		db 11 dup(0)		
        00
       ]
 0D20  000F		      C 		dw 15
 0D22  68 64 33		      C 		db "hd3"
 0D25  000B [		      C 		db 11 dup(0)		
        00
       ]
 0D30  0010		      C 		dw 16
 0D32  6C 70 72		      C 		db "lpr"
 0D35  000B [		      C 		db 11 dup(0)		
        00
       ]
 0D40  0011		      C 		dw 17
 0D42  74 74 79 30	      C                 db "tty0"
 0D46  000A [		      C 		db 10 dup(0)		
        00
       ]
 0D50  0012		      C 		dw 18
 0D52  74 74 79 31	      C                 db "tty1"
 0D56  000A [		      C 		db 10 dup(0)	
        00
       ]
 0D60  0013		      C 		dw 19
 0D62  74 74 79 32	      C                 db "tty2"
 0D66  000A [		      C 		db 10 dup(0)	
        00
       ]
 0D70  0014		      C 		dw 20
 0D72  74 74 79 33	      C                 db "tty3"
 0D76  000A [		      C 		db 10 dup(0)		
        00
       ]
 0D80  0015		      C 		dw 21
 0D82  74 74 79 34	      C                 db "tty4"
 0D86  000A [		      C 		db 10 dup(0)		
        00
       ]
 0D90  0016		      C 		dw 22
 0D92  74 74 79 35	      C                 db "tty5"
 0D96  000A [		      C  		db 10 dup(0)		
        00
       ]
 0DA0  0017		      C 		dw 23
 0DA2  74 74 79 36	      C                 db "tty6"
 0DA6  000A [		      C 		db 10 dup(0)		
        00
       ]
 0DB0  0018		      C 		dw 24
 0DB2  74 74 79 37	      C                 db "tty7"
 0DB6  000A [		      C 		db 10 dup(0)		
        00
       ]
 0DC0  0019		      C 		dw 25
 0DC2  43 4F 4D 31	      C                 db "COM1" ; 09/07/2013
 0DC6  000A [		      C 		db 10 dup(0)		
        00
       ]
 0DD0  001A		      C 		dw 26
 0DD2  43 4F 4D 32	      C                 db "COM2" ; 09/07/2013
 0DD6  000A [		      C 		db 10 dup(0)		
        00
       ]
 0DE0  0019		      C 		dw 25
 0DE2  74 74 79 38	      C 		db "tty8" ; 21/04/2014
 0DE6  000A [		      C 		db 10 dup(0)		
        00
       ]
 0DF0  001A		      C 		dw 26
 0DF2  74 74 79 39	      C                 db "tty9" ; 21/04/2014  
 0DF6  000A [		      C 		db 10 dup(0)
        00
       ]
			      C 
			      C ;dev_dir: ; device directory
			      C ;		dw 41
			      C ;		db ".."
			      C ;		db 12 dup(0)		
			      C ;		dw 42
			      C ;		db "."
			      C ;		db 13 dup(0)		
			      C ;		dw 1
			      C ;		db "tty"
			      C ;		db 11 dup(0)		
			      C ;		dw 2
			      C ;		db "mem"
			      C ;		db 11 dup(0)		
			      C ;		dw 3
			      C ;		db "fd0"
			      C ;		db 11 dup(0)		
			      C ;		dw 4
			      C ;		db "fd1"
			      C ;		db 11 dup(0)		
			      C ;		dw 5
			      C ;		db "hd0"
			      C ;		db 11 dup(0)		
			      C ;		dw 6
			      C ;		db "hd1"
			      C ;		db 11 dup(0)		
			      C ;		dw 7
			      C ;		db "hd2"
			      C ;		db 11 dup(0)		
			      C ;		dw 8
			      C ;		db "hd3"
			      C ;		db 11 dup(0)		
			      C ;		dw 9
			      C ;		db "lpr"
			      C ;		db 11 dup(0)		
			      C ;		dw 10
			      C ;               db "tty0"
			      C ;		db 10 dup(0)		
			      C ;		dw 11
			      C ;               db "tty1"
			      C ;		db 10 dup(0)	
			      C ;		dw 12
			      C ;               db "tty2"
			      C ;		db 10 dup(0)	
			      C ;		dw 13
			      C ;               db "tty3"
			      C ;		db 10 dup(0)		
			      C ;		dw 14
			      C ;               db "tty4"
			      C ;		db 10 dup(0)		
			      C ;		dw 15
			      C ;               db "tty5"
			      C ; 		db 10 dup(0)		
			      C ;		dw 16
			      C ;               db "tty6"
			      C ;		db 10 dup(0)		
			      C ;		dw 17
			      C ;               db "tty7"
			      C ;		db 10 dup(0)		
			      C ;		dw 18
			      C ;               db "COM1" ; 09/07/2013
			      C ;		db 10 dup(0)		
			      C ;		dw 19
			      C ;               db "COM2" ; 09/07/2013
			      C ;		db 10 dup(0)		
			      C ;		dw 18
			      C ;		db "tty8" ; 21/04/2014
			      C ;		db 10 dup(0)		
			      C ;		dw 19
			      C ;               db "tty9" ; 21/04/2014  
			      C ;		db 10 dup(0)
			      C 
 0E00 = 0170		      C size_dev_dir equ $ - offset dev_dir
			      C 
 0E00			      C bin_dir:  ; binary directory
 0E00  0003		      C 		dw 3
 0E02  2E		      C 		db "."
 0E03  000D [		      C 		db 13 dup(0)
        00
       ]
 0E10  0001		      C 		dw 1
 0E12  2E 2E		      C 		db ".."
 0E14  000C [		      C 		db 12 dup(0)
        00
       ]
			      C 
			      C ;bin_dir:  ; binary directory
			      C ;		dw 41
			      C ;		db ".."
			      C ;		db 12 dup(0)
			      C ;		dw 43
			      C ;		db "."
			      C ;		db 13 dup(0)
			      C 		
 0E20 = 0020		      C size_bin_dir equ $ - offset bin_dir
			      C 
 0E20			      C etc_dir:  ; etcetra directory
 0E20  0004		      C 		dw 4
 0E22  2E		      C 		db "."
 0E23  000D [		      C 		db 13 dup(0)	
        00
       ]
 0E30  0001		      C 		dw 1
 0E32  2E 2E		      C 		db ".."
 0E34  000C [		      C 		db 12 dup(0)
        00
       ]
			      C 
			      C ;etc_dir:  ; etcetra directory
			      C ;		dw 41
			      C ;		db ".."
			      C ;		db 12 dup(0)	
			      C ;		dw 44
			      C ;		db "."
			      C ;		db 13 dup(0)
			      C 			
 0E40 = 0020		      C size_etc_dir equ $ - offset etc_dir
			      C 
 0E40			      C usr_dir:  ; user directory
 0E40  0005		      C 		dw 5
 0E42  2E		      C 		db "."
 0E43  000D [		      C 		db 13 dup(0)	
        00
       ]
 0E50  0001		      C 		dw 1
 0E52  2E 2E		      C 		db ".."
 0E54  000C [		      C 		db 12 dup(0)
        00
       ]
			      C 
			      C ;usr_dir:  ; user directory
			      C ;		dw 41
			      C ;		db ".."
			      C ;		db 12 dup(0)	
			      C ;		dw 45
			      C ;		db "."
			      C ;		db 13 dup(0)
			      C 		
 0E60 = 0020		      C size_usr_dir equ $ - offset usr_dir
			      C 
 0E60			      C tmp_dir:  ; temporary directory
 0E60  0006		      C 		dw 6
 0E62  2E		      C 		db "."
 0E63  000D [		      C 		db 13 dup(0)	
        00
       ]
 0E70  0001		      C 		dw 1
 0E72  2E 2E		      C 		db ".."
 0E74  000C [		      C 		db 12 dup(0)
        00
       ]
			      C 
			      C ;tmp_dir:  ; temporary directory
			      C ;		dw 41
			      C ;		db ".."
			      C ;		db 12 dup(0)	
			      C ;		dw 46
			      C ;		db "."
			      C ;		db 13 dup(0)
			      C 		
 0E80 = 0020		      C size_tmp_dir equ $ - offset tmp_dir
			      C 
 0E80			      C mnt_dir:  ; temporary directory
 0E80  0007		      C 		dw 7
 0E82  2E		      C 		db "."
 0E83  000D [		      C 		db 13 dup(0)	
        00
       ]
 0E90  0001		      C 		dw 1
 0E92  2E 2E		      C 		db ".."
 0E94  000C [		      C 		db 12 dup(0)
        00
       ]
			      C 
 0EA0 = 0020		      C size_mnt_dir equ $ - offset mnt_dir
			      C 
			      C align 2
			      C 
			      C ;dw 0
			      C 
			      C ; 31/10/2012
 0EA0 0000		      C u_off: dw 0
 0EA2  0000		      C        dw 0 ; 08/12/2019  		
			      C ; 12/08/2012
 0EA4 0000		      C u_count: dw 0
 0EA6 0000		      C u_base: dw 0
 0EA8 0000		      C u_fofp: dw 0
 0EAA 0000		      C u_nread: dw 0
			      C 
			      C ; 01/09/2019
 = 61FF			      C BLOCKDEV equ 61FFh ; 0110000111111111b
 = 21FF			      C CHARDEV equ 21FFh  ; 0010000111111111b
			      C ; 02/09/2019
 = 81FF			      C REGULARDEF equ 81FFh ; 1000000111111111b
			      C 
			      C ; 15/09/2019	
			      C ; 01/09/2019 - Retro UNIX v2 inode model (64 bytes)
			      C ;	       (Modified UNIX v7 inode model)
			      C 
 0EAC			      C inode:
 0EAC 81FF		      C i_flgs: dw 81FFh ; default regular file flag ; 02/09/2019
 0EAE 0001		      C i_nlks: dw 1 ; Number of links
 0EB0 0000		      C i_uid:  dw 0 ; owner's user id 
 0EB2 00		      C i_gid:	db 0 ; owner's group id
 0EB3 00		      C i_size_h: db 0 ; high byte of 5 bytes file size
 0EB4 00000000		      C i_size: dd 0 ; file size
 0EB8  000A [		      C i_dskp: dd 10 dup(0)  ; direct or indirect blocks
        00000000
       ]
 0EE0 00000000		      C i_ltim: dd 0 ; last access time (or last inode modif. time)
 0EE4 00000000		      C i_mtim: dd 0 ; last (file) modification time 
 0EE8 00000000		      C i_ctim: dd 0 ; (file) creation time
			      C 
			      C ; 17/08/2012
			      C ; 05/08/2012
			      C ; 14/07/2012
			      C ;inode:
			      C ;i_flgs: dw 800Fh ; special (device) files flags
			      C ;i_nlks: db 1 ; Number of links
			      C ;i_uid: db 0  ; user id 
			      C ;i_size: dw 0 ; file size
			      C ;i_dskp: dw 8 dup(0)  ; direct or indirect blocks
			      C ;i_ctim: dd 0 ; creation time
			      C ;i_mtim: dd 0 ; last modification time 
			      C ;i_reserved: dw 0 ; reserved (not in use)
			      C 
			      C ; 09/09/2019
			      C ; size table for directory inodes (1 to 7)
 0EEC			      C i_dir_sizes:
 0EEC  0080		      C 	dw size_root_dir ; 128	; 1
 0EEE  0170		      C 	dw size_dev_dir	; 368	; 2
 0EF0  0020		      C 	dw size_bin_dir	; 32	; 3
 0EF2  0020		      C 	dw size_etc_dir	; 32	; 4
 0EF4  0020		      C 	dw size_usr_dir	; 32	; 5
 0EF6  0020		      C 	dw size_tmp_dir	; 32	; 6
 0EF8  0020		      C 	dw size_mnt_dir	; 32	; 7
			      C 
			      C ; 05/08/2012
			      C ; 14/07/2012
 0EFA			      C idata:
 0EFA			      C inodes:
			      C 
			      C ; 13/04/2022
			      C ; 25/09/2019
			      C ; 15/09/2019
			      C ; 01/09/2019 - Retro UNIX 386 v2 (UNIX v7 modified) inodes
			      C 
 0EFA			      C root_inode: ; 1
 0EFA  C1FF		      C 		dw 0C1FFh ; Flags (1100000111111111b)
 0EFC  0008		      C 		dw 8	; number of links ; 13/04/2022
 0EFE  0000		      C 		dw 0	; user ID (0 = root)
 0F00  00		      C 		db 0	; group ID (0 = root)
 0F01  00		      C 		db 0	; size_h (5th byte of file size)
			      C 		;dd size_root_dir ; initial size = 128 bytes
 0F02  00000000		      C 		dd 0
 0F06  000A [		      C 		dd 10 dup (0) ; indirect or contents blocks
        00000000
       ]
 0F2E  00000000		      C 		dd 0	; last access date & time
 0F32  00000000		      C 		dd 0	; modification date & time
 0F36  00000000		      C 		dd 0	; creation date & time
 0F3A			      C dev_inode: ; 2
 0F3A  C1FF		      C 		dw 0C1FFh ; Flags (1100000111111111b)
 0F3C  0002		      C 		dw 2	; number of links
 0F3E  0000		      C 		dw 0	; user ID (0 = root)
 0F40  00		      C 		db 0	; group ID (0 = root)
 0F41  00		      C 		db 0	; size_h (5th byte of file size)
			      C 		;dd size_dev_dir ; initial size = 128 bytes
 0F42  00000000		      C 		dd 0
 0F46  000A [		      C 		dd 10 dup (0) ; indirect or contents blocks
        00000000
       ]
 0F6E  00000000		      C 		dd 0	; last access date & time
 0F72  00000000		      C 		dd 0	; modification date & time
 0F76  00000000		      C 		dd 0	; creation date & time
 0F7A			      C bin_inode: ; 3
 0F7A  C1ED		      C 		dw 0C1EDh ; Flags  (1100000111101101b)
 0F7C  0002		      C 		dw 2	; number of links
 0F7E  0000		      C 		dw 0	; user ID (0 = root)
 0F80  00		      C 		db 0	; group ID (0 = root)
 0F81  00		      C 		db 0	; size_h (5th byte of file size)
			      C 		;dd size_bin_dir ; 32 bytes
 0F82  00000000		      C 		dd 0
 0F86  000A [		      C 		dd 10 dup (0) ; indirect or contents blocks
        00000000
       ]
 0FAE  00000000		      C 		dd 0	; last access date & time
 0FB2  00000000		      C 		dd 0	; modification date & time
 0FB6  00000000		      C 		dd 0	; creation date & time
 0FBA			      C etc_inode: ; 4
 0FBA  C1ED		      C 		dw 0C1EDh ; Flags  (1100000111101101b)
 0FBC  0002		      C 		dw 2	; number of links
 0FBE  0000		      C 		dw 0	; user ID (0 = root)
 0FC0  00		      C 		db 0	; group ID (0 = root)
 0FC1  00		      C 		db 0	; size_h (5th byte of file size)
			      C 		;dd size_etc_dir ; 32 bytes
 0FC2  00000000		      C 		dd 0
 0FC6  000A [		      C 		dd 10 dup (0) ; indirect or contents blocks
        00000000
       ]
 0FEE  00000000		      C 		dd 0	; last access date & time
 0FF2  00000000		      C 		dd 0	; modification date & time
 0FF6  00000000		      C 		dd 0	; creation date & time
 0FFA			      C usr_inode: ; 5
 0FFA  C1ED		      C 		dw 0C1EDh ; Flags  (1100000111101101b)
 0FFC  0002		      C 		dw 2	; number of links ; 13/04/2022
 0FFE  0000		      C 		dw 0	; user ID (0 = root)
 1000  00		      C 		db 0	; group ID (0 = root)
 1001  00		      C 		db 0	; size_h (5th byte of file size)
			      C 		;dd size_usr_dir ; 32 bytes
 1002  00000000		      C 		dd 0
 1006  000A [		      C 		dd 10 dup (0) ; indirect or contents blocks
        00000000
       ]
 102E  00000000		      C 		dd 0	; last access date & time
 1032  00000000		      C 		dd 0	; modification date & time
 1036  00000000		      C 		dd 0	; creation date & time
 103A			      C tmp_inode: ; 6
 103A  C1FF		      C 		dw 0C1FFh ; Flags (1100000111111111b)
 103C  0002		      C 		dw 2	; number of links
 103E  0000		      C 		dw 0	; user ID (0 = root)
 1040  00		      C 		db 0	; group ID (0 = root)
 1041  00		      C 		db 0	; size_h (5th byte of file size)
			      C 		;dd size_tmp_dir ; 32 bytes
 1042  00000000		      C 		dd 0
 1046  000A [		      C 		dd 10 dup (0) ; indirect or contents blocks
        00000000
       ]
 106E  00000000		      C 		dd 0	; last access date & time
 1072  00000000		      C 		dd 0	; modification date & time
 1076  00000000		      C 		dd 0	; creation date & time
 107A			      C mnt_inode: ; 7
 107A  C1FF		      C 		dw 0C1FFh ; Flags (1100000111111111b)
 107C  0002		      C 		dw 2	; number of links
 107E  0000		      C 		dw 0	; user ID (0 = root)
 1080  00		      C 		db 0	; group ID (0 = root)
 1081  00		      C 		db 0	; size_h (5th byte of file size)
			      C 		;dd size_mnt_dir ; 32 bytes
 1082  00000000		      C 		dd 0
 1086  000A [		      C 		dd 10 dup (0) ; indirect or contents blocks
        00000000
       ]
 10AE  00000000		      C 		dd 0	; last access date & time
 10B2  00000000		      C 		dd 0	; modification date & time
 10B6  00000000		      C 		dd 0	; creation date & time
 10BA			      C tty_inode: ; 8
 10BA  21FF		      C 		dw 21FFh ; Flags (0010000111111111b) ; CHARDEV
 10BC  0001		      C 		dw 1	; number of links
 10BE  0003		      C 		dw 3	; user ID (3 = bin)
 10C0  03		      C 		db 3	; group ID (3 = bin)
 10C1  00		      C 		db 0	; size_h = 0
 10C2  00000000		      C 		dd 0	; size = 0
 10C6  0200		      C 		dw 0200h ; major = 2, minor = 0 
 10C8  0013 [		      C 		dw 19 dup (0) ; not used, must be 0
        0000
       ]
 10EE  00000000		      C 		dd 0	; last access date & time
 10F2  00000000		      C 		dd 0	; modification date & time
 10F6  00000000		      C 		dd 0	; creation date & time
 10FA			      C mem_inode: ; 9
 10FA  21FF		      C 		dw 21FFh ; Flags (0010000111111111b) ; CHARDEV
 10FC  0001		      C 		dw 1	; number of links
 10FE  0003		      C 		dw 3	; user ID (3 = bin)
 1100  03		      C 		db 3	; group ID (3 = bin)
 1101  00		      C 		db 0	; size_h = 0
 1102  00000000		      C 		dd 0	; size = 0
 1106  0100		      C 		dw 0100h ; major = 1, minor = 0 	
 1108  0013 [		      C 		dw 19 dup (0) ; not used, must be 0
        0000
       ]
 112E  00000000		      C 		dd 0	; last access date & time
 1132  00000000		      C 		dd 0	; modification date & time
 1136  00000000		      C 		dd 0	; creation date & time
 113A			      C fd0_inode: ; 10
 113A  61FF		      C 		dw 61FFh ; Flags (0110000111111111b) ; BLOCKDEV
 113C  0001		      C 		dw 1	; number of links
 113E  0003		      C 		dw 3	; user ID (3 = bin)
 1140  03		      C 		db 3	; group ID (3 = bin)
 1141  00		      C 		db 0	; size_h = 0
 1142  00000000		      C 		dd 0	; size = 0
 1146  0100		      C 		dw 0100h ; major = 1, minor = 0 	
 1148  0013 [		      C 		dw 19 dup (0) ; not used, must be 0
        0000
       ]
 116E  00000000		      C 		dd 0	; last access date & time
 1172  00000000		      C 		dd 0	; modification date & time
 1176  00000000		      C 		dd 0	; creation date & time
 117A			      C fd1_inode: ; 11
 117A  61FF		      C 		dw 61FFh ; Flags (0110000111111111b) ; BLOCKDEV
 117C  0001		      C 		dw 1	; number of links
 117E  0003		      C 		dw 3	; user ID (3 = bin)
 1180  03		      C 		db 3	; group ID (3 = bin)
 1181  00		      C 		db 0	; size_h = 0
 1182  00000000		      C 		dd 0	; size = 0
 1186  0101		      C 		dw 0101h ; major = 1, minor = 1 	
 1188  0013 [		      C 		dw 19 dup (0) ; not used, must be 0
        0000
       ]
 11AE  00000000		      C 		dd 0	; last access date & time
 11B2  00000000		      C 		dd 0	; modification date & time
 11B6  00000000		      C 		dd 0	; creation date & time
 11BA			      C hd0_inode: ; 12
 11BA  61FF		      C 		dw 61FFh ; Flags (0110000111111111b) ; BLOCKDEV
 11BC  0001		      C 		dw 1	; number of links
 11BE  0003		      C 		dw 3	; user ID (3 = bin)
 11C0  03		      C 		db 3	; group ID (3 = bin)
 11C1  00		      C 		db 0	; size_h = 0
 11C2  00000000		      C 		dd 0	; size = 0
 11C6  0000		      C 		dw 0000h ; major = 0, minor = 0 	
 11C8  0013 [		      C 		dw 19 dup (0) ; not used, must be 0
        0000
       ]
 11EE  00000000		      C 		dd 0	; last access date & time
 11F2  00000000		      C 		dd 0	; modification date & time
 11F6  00000000		      C 		dd 0	; creation date & time
 11FA			      C hd1_inode: ; 13
 11FA  61FF		      C 		dw 61FFh ; Flags (0110000111111111b) ; BLOCKDEV
 11FC  0001		      C 		dw 1	; number of links
 11FE  0003		      C 		dw 3	; user ID (3 = bin)
 1200  03		      C 		db 3	; group ID (3 = bin)
 1201  00		      C 		db 0	; size_h = 0
 1202  00000000		      C 		dd 0	; size = 0
 1206  0001		      C 		dw 0001h ; major = 0, minor = 1 	
 1208  0013 [		      C 		dw 19 dup (0) ; not used, must be 0
        0000
       ]
 122E  00000000		      C 		dd 0	; last access date & time
 1232  00000000		      C 		dd 0	; modification date & time
 1236  00000000		      C 		dd 0	; creation date & time
 123A			      C hd2_inode: ; 14
 123A  61FF		      C 		dw 61FFh ; Flags (0110000111111111b) ; BLOCKDEV
 123C  0001		      C 		dw 1	; number of links
 123E  0003		      C 		dw 3	; user ID (3 = bin)
 1240  03		      C 		db 3	; group ID (3 = bin)
 1241  00		      C 		db 0	; size_h = 0
 1242  00000000		      C 		dd 0	; size = 0
 1246  0002		      C 		dw 0002h ; major = 0, minor = 2 	
 1248  0013 [		      C 		dw 19 dup (0) ; not used, must be 0
        0000
       ]
 126E  00000000		      C 		dd 0	; last access date & time
 1272  00000000		      C 		dd 0	; modification date & time
 1276  00000000		      C 		dd 0	; creation date & time
 127A			      C hd3_inode: ; 15
 127A  61FF		      C 		dw 61FFh ; Flags (0110000111111111b) ; BLOCKDEV
 127C  0001		      C 		dw 1	; number of links
 127E  0003		      C 		dw 3	; user ID (3 = bin)
 1280  03		      C 		db 3	; group ID (3 = bin)
 1281  00		      C 		db 0	; size_h = 0
 1282  00000000		      C 		dd 0	; size = 0
 1286  0003		      C 		dw 0003h ; major = 0, minor = 3 	
 1288  0013 [		      C 		dw 19 dup (0) ; not used, must be 0
        0000
       ]
 12AE  00000000		      C 		dd 0	; last access date & time
 12B2  00000000		      C 		dd 0	; modification date & time
 12B6  00000000		      C 		dd 0	; creation date & time
 12BA			      C lpr_inode: ; 16
 12BA  21FF		      C 		dw 21FFh ; Flags (0010000111111111b) ; CHARDEV
 12BC  0001		      C 		dw 1	; number of links
 12BE  0003		      C 		dw 3	; user ID (3 = bin)
 12C0  03		      C 		db 3	; group ID (3 = bin)
 12C1  00		      C 		db 0	; size_h = 0
 12C2  00000000		      C 		dd 0	; size = 0
 12C6  0400		      C 		dw 0400h ; major = 4, minor = 0 	
 12C8  0013 [		      C 		dw 19 dup (0) ; not used, must be 0
        0000
       ]
 12EE  00000000		      C 		dd 0	; last access date & time
 12F2  00000000		      C 		dd 0	; modification date & time
 12F6  00000000		      C 		dd 0	; creation date & time	
 12FA			      C tty0_inode: ; 17
 12FA  21FF		      C 		dw 21FFh ; Flags (0010000111111111b) ; CHARDEV
 12FC  0001		      C 		dw 1	; number of links
 12FE  0003		      C 		dw 3	; user ID (3 = bin)
 1300  03		      C 		db 3	; group ID (3 = bin)
 1301  00		      C 		db 0	; size_h = 0
 1302  00000000		      C 		dd 0	; size = 0
 1306  0201		      C 		dw 0201h ; major = 2, minor = 1
 1308  0013 [		      C 		dw 19 dup (0) ; not used, must be 0
        0000
       ]
 132E  00000000		      C 		dd 0	; last access date & time
 1332  00000000		      C 		dd 0	; modification date & time
 1336  00000000		      C 		dd 0	; creation date & time
 133A			      C tty1_inode: ; 18
 133A  21FF		      C 		dw 21FFh ; Flags (0010000111111111b) ; CHARDEV
 133C  0001		      C 		dw 1	; number of links
 133E  0003		      C 		dw 3	; user ID (3 = bin)
 1340  03		      C 		db 3	; group ID (3 = bin)
 1341  00		      C 		db 0	; size_h = 0
 1342  00000000		      C 		dd 0	; size = 0
 1346  0202		      C 		dw 0202h ; major = 2, minor = 2
 1348  0013 [		      C 		dw 19 dup (0) ; not used, must be 0
        0000
       ]
 136E  00000000		      C 		dd 0	; last access date & time
 1372  00000000		      C 		dd 0	; modification date & time
 1376  00000000		      C 		dd 0	; creation date & time
 137A			      C tty2_inode: ; 19
 137A  21FF		      C 		dw 21FFh ; Flags (0010000111111111b) ; CHARDEV
 137C  0001		      C 		dw 1	; number of links
 137E  0003		      C 		dw 3	; user ID (3 = bin)
 1380  03		      C 		db 3	; group ID (3 = bin)
 1381  00		      C 		db 0	; size_h = 0
 1382  00000000		      C 		dd 0	; size = 0
 1386  0203		      C 		dw 0203h ; major = 2, minor = 3
 1388  0013 [		      C 		dw 19 dup (0) ; not used, must be 0
        0000
       ]
 13AE  00000000		      C 		dd 0	; last access date & time
 13B2  00000000		      C 		dd 0	; modification date & time
 13B6  00000000		      C 		dd 0	; creation date & time
 13BA			      C tty3_inode: ; 20
 13BA  21FF		      C 		dw 21FFh ; Flags (0010000111111111b) ; CHARDEV
 13BC  0001		      C 		dw 1	; number of links
 13BE  0003		      C 		dw 3	; user ID (3 = bin)
 13C0  03		      C 		db 3	; group ID (3 = bin)
 13C1  00		      C 		db 0	; size_h = 0
 13C2  00000000		      C 		dd 0	; size = 0
 13C6  0204		      C 		dw 0204h ; major = 2, minor = 4
 13C8  0013 [		      C 		dw 19 dup (0) ; not used, must be 0
        0000
       ]
 13EE  00000000		      C 		dd 0	; last access date & time
 13F2  00000000		      C 		dd 0	; modification date & time
 13F6  00000000		      C 		dd 0	; creation date & time
 13FA			      C tty4_inode: ; 21
 13FA  21FF		      C 		dw 21FFh ; Flags (0010000111111111b) ; CHARDEV
 13FC  0001		      C 		dw 1	; number of links
 13FE  0003		      C 		dw 3	; user ID (3 = bin)
 1400  03		      C 		db 3	; group ID (3 = bin)
 1401  00		      C 		db 0	; size_h = 0
 1402  00000000		      C 		dd 0	; size = 0
 1406  0205		      C 		dw 0205h ; major = 2, minor = 5
 1408  0013 [		      C 		dw 19 dup (0) ; not used, must be 0
        0000
       ]
 142E  00000000		      C 		dd 0	; last access date & time
 1432  00000000		      C 		dd 0	; modification date & time
 1436  00000000		      C 		dd 0	; creation date & time
 143A			      C tty5_inode: ; 22
 143A  21FF		      C 		dw 21FFh ; Flags (0010000111111111b) ; CHARDEV
 143C  0001		      C 		dw 1	; number of links
 143E  0003		      C 		dw 3	; user ID (3 = bin)
 1440  03		      C 		db 3	; group ID (3 = bin)
 1441  00		      C 		db 0	; size_h = 0
 1442  00000000		      C 		dd 0	; size = 0
 1446  0206		      C 		dw 0206h ; major = 2, minor = 6
 1448  0013 [		      C 		dw 19 dup (0) ; not used, must be 0
        0000
       ]
 146E  00000000		      C 		dd 0	; last access date & time
 1472  00000000		      C 		dd 0	; modification date & time
 1476  00000000		      C 		dd 0	; creation date & time
 147A			      C tty6_inode: ; 23
 147A  21FF		      C 		dw 21FFh ; Flags (0010000111111111b) ; CHARDEV
 147C  0001		      C 		dw 1	; number of links
 147E  0003		      C 		dw 3	; user ID (3 = bin)
 1480  03		      C 		db 3	; group ID (3 = bin)
 1481  00		      C 		db 0	; size_h = 0
 1482  00000000		      C 		dd 0	; size = 0
 1486  0207		      C 		dw 0207h ; major = 2, minor = 7
 1488  0013 [		      C 		dw 19 dup (0) ; not used, must be 0
        0000
       ]
 14AE  00000000		      C 		dd 0	; last access date & time
 14B2  00000000		      C 		dd 0	; modification date & time
 14B6  00000000		      C 		dd 0	; creation date & time
 14BA			      C tty7_inode: ; 24
 14BA  21FF		      C 		dw 21FFh ; Flags (0010000111111111b) ; CHARDEV
 14BC  0001		      C 		dw 1	; number of links
 14BE  0003		      C 		dw 3	; user ID (3 = bin)
 14C0  03		      C 		db 3	; group ID (3 = bin)
 14C1  00		      C 		db 0	; size = 0
 14C2  00000000		      C 		dd 0	; size_h = 0
 14C6  0208		      C 		dw 0208h ; major = 2, minor = 8
 14C8  0013 [		      C 		dw 19 dup (0) ; not used, must be 0
        0000
       ]
 14EE  00000000		      C 		dd 0	; last access date & time
 14F2  00000000		      C 		dd 0	; modification date & time
 14F6  00000000		      C 		dd 0	; creation date & time
 14FA			      C com1_inode: ; 25
 14FA  21FF		      C 		dw 21FFh ; Flags (0010000111111111b) ; CHARDEV
			      C 		;dw 1	; number of links
 14FC  0002		      C 		dw 2	; 30/09/2019
 14FE  0003		      C 		dw 3	; user ID (3 = bin)
 1500  03		      C 		db 3	; group ID (3 = bin)
 1501  00		      C 		db 0	; size_h = 0
 1502  00000000		      C 		dd 0	; size = 0
 1506  0300		      C 		dw 0300h ; major = 3, minor = 0
 1508  0013 [		      C 		dw 19 dup (0) ; not used, must be 0
        0000
       ]
 152E  00000000		      C 		dd 0	; last access date & time
 1532  00000000		      C 		dd 0	; modification date & time
 1536  00000000		      C 		dd 0	; creation date & time
 153A			      C com2_inode: ; 26
 153A  21FF		      C 		dw 21FFh ; Flags (0010000111111111b) ; CHARDEV
			      C 		;dw 1	; number of links
 153C  0002		      C 		dw 2	; 30/09/2019
 153E  0003		      C 		dw 3	; user ID (3 = bin)
 1540  03		      C 		db 3	; group ID (3 = bin)
 1541  00		      C 		db 0	; size_h = 0
 1542  00000000		      C 		dd 0	; size = 0
 1546  0301		      C 		dw 0301h ; major = 3, minor = 1
 1548  0013 [		      C 		dw 19 dup (0) ; not used, must be 0
        0000
       ]
 156E  00000000		      C 		dd 0	; last access date & time
 1572  00000000		      C 		dd 0	; modification date & time
 1576  00000000		      C 		dd 0	; creation date & time
			      C 
			      C 		; 18/12/2019
			      C 		; 02/09/2019
 157A			      C unused_inodes: ; 27 to 32
 157A  0180 [		      C 		db (32-26)*64 dup(0)	
        00
       ]
			      C 	
			      C ; Retro UNIX v1 (UNIX v1) inodes
			      C ;
			      C ;root_inode: ; 41
			      C ;		dw 0C00Eh ; Flags (1100000000001110b)
			      C ;		db 7	; number of links 
			      C ;		db 0	; user ID (0 = root)
			      C ;		dw size_root_dir ; initial size = 70 bytes 
			      C ;		dw 8 dup (0) ; indirect or contents blocks
			      C ;		dd 0	; creation date & time
			      C ;		dd 0	; modification date & time
			      C ;		dw 0	; unused
			      C ;dev_inode: ; 42
			      C ;		dw 0C00Eh ; Flags (1100000000001110b)
			      C ;		db 2	; number of links 
			      C ;		db 0	; user ID (0 = root)
			      C ;		dw size_dev_dir ; 200
			      C ;		dw 8 dup (0) ; indirect or contents blocks
			      C ;		dd 0	; creation date & time
			      C ;		dd 0	; modification date & time
			      C ;		dw 0	; unused	
			      C ;bin_inode: ; 43
			      C ;		dw 0C00Eh ; Flags (1100000000001110b)
			      C ;		db 2	; number of links 
			      C ;		db 0	; user ID (0 = root)
			      C ;		dw size_bin_dir ; 20
			      C ;		dw 8 dup (0) ; indirect or contents blocks
			      C ;		dd 0	; creation date & time
			      C ;		dd 0	; modification date & time
			      C ;		dw 0	; unused
			      C ;etc_inode: ; 44
			      C ;		dw 0C00Eh ; Flags (1100000000001110b)
			      C ;		db 2	; number of links 
			      C ;		db 0	; user ID (0 = root)
			      C ;		dw size_etc_dir ; 20
			      C ;		dw 8 dup (0) ; indirect or contents blocks
			      C ;		dd 0	; creation date & time
			      C ;		dd 0	; modification date & time
			      C ;		dw 0	; unused				
			      C ;usr_inode: ; 45
			      C ;		dw 0C00Eh ; Flags (1100000000001110b)
			      C ;		db 2	; number of links 
			      C ;		db 0	; user ID (0 = root)
			      C ;		dw size_usr_dir ; 20
			      C ;		dw 8 dup (0) ; indirect or contents blocks
			      C ;		dd 0	; creation date & time
			      C ;		dd 0	; modification date & time
			      C ;		dw 0	; unused
			      C ;tmp_inode: ; 46
			      C ;		dw 0C00Fh ; Flags (1100000000001111b)
			      C ;		db 2	; number of links 
			      C ;		db 0	; user ID (0 = root)
			      C ;		dw size_tmp_dir ; 20
			      C ;		dw 8 dup (0) ; indirect or contents blocks
			      C ;		dd 0	; creation date & time
			      C ;		dd 0	; modification date & time
			      C ;		dw 0	; unused
			      C 
			      C ; 04/12/2019
			      C ; 03/12/2019
			      C align 16
			      C 
 1700 FFFFFFFF		      C data_start: dd 0FFFFFFFFh
 1704 00000000		      C count: dd 0	
 1708 00000000		      C fm_sector: dd 0
 170C 0000		      C im_sector: dw 0
 170E 0000		      C im_scount: dw 0 ; 04/12/2019
			      C 
			      C ;align 16
			      C 
			      C ; 05/04/2022
 1710			      C im_buffer: ; 02/09/2019 - Retro UNIX386 v2 (inode map buffer)
 1710  0200 [		      C 	db 512 dup (0) ; 07/11/2019
        00
       ]
			      C 
 1910			      C Buffer:
 1910			      C sector_buffer:
 1910  0200 [		      C 	db 512 dup (0)
        00
       ]
			      C 
			      C ; 05/04/2022
			      C ;im_buffer:
			      C ; 01/09/2019
 1B10			      C fbm_buffer:  ; Free Blocks Map buffer
 1B10  0200 [		      C 	db 512 dup (0)
        00
       ]
			      C 
				;include        unixproc.asm 
				include		rufshdp.asm ; runix v2 procedures for hard disk fs (71h)
			      C ; RUFSHDP.ASM
			      C ;----------------------------------------------------------------
			      C ; RETRO UNIX v0.3 - Modified UNIX v7 inode & devices - 01/09/2019
			      C ; RETRO UNIX v0.2 - 14 byte file name modifications (04/12/2015)
			      C ; RETRO UNIX v0.1 'fd0' formatting procedures
			      C ;
			      C ; Derived from UNIXPROC.ASM (for 1.44MB floppies) - 29/09/2019
			      C ;
			      C ; Last Update: 05/04/2022 - Retro UNIX 386 v2 ;******************
			      C ;
			      C ; 14/01/2020 - Retro UNIX 386 v2
			      C ; 09/07/2013 - Retro UNIX v1
			      C ; ERDOGAN TAN
			      C ; 01/03/2013, 03/03/2013, 05/03/2013
			      C ; 16/12/2012 -> sioreg (bugfix)
			      C ; [ 14-27/7/2012, 4-21/8/2012, 16/9/2012, 20/10/2012, 31/10/2012 ]
			      C ; These procedures will be located in UNIXFDFS.ASM file 
			      C ; when they are completed.
			      C ; (NOTE: only for (R)UFS initialization of FD0 1.44MB floppy disk
			      C 
 = 0100			      C err_INVALIDDATA equ 100h
 = 0200			      C err_NOFREEBLOCK equ 200h
			      C 
 1D10			      C iget 	proc near
			      C 	; 27/11/2019
			      C 	; 07/11/2019 - Retro UNIX 386 v2
			      C 	; 16/09/2012
			      C      	; 14/07/2012
			      C      	; Derived from (original) UNIX v1 source code
			      C 	; PRELIMINARY release of Unix Implementation Document, 
			      C 	; 20/06/1972
			      C 	;; AX=R0, BX=R1 
			      C 	; RETRO UNIX v1 FS
			      C 	; initialization/format version
			      C 	; (cdev, idev,mnt, mntd are excluded)
			      C 	;; return => if cf=1 error number in [Error] 
			      C 
			      C 	; 27/11/2019
			      C 	; INPUT:
			      C 	; 	BX = inode number (0 if current inode)
			      C 	; OUTPUT:
			      C 	;	BX = inode number if cf = 0
			      C 	;	
			      C 	; Modified registers: ax,bx,cx,dx 
			      C 
 1D10  3B 1E 262D R	      C 	cmp bx,word ptr [ii] ; BX (R1) = i-number of current file
 1D14  74 2C		      C 	je short iget_5
 1D16			      C iget_1:
			      C 	;push ax ; **
 1D16  32 E4		      C 	xor ah,ah ; mov ah,0
 1D18  A0 262C R	      C 	mov al,byte ptr [imod]
 1D1B  22 C0		      C 	and al,al ; has i-node of current file been modified ?	
 1D1D  74 14		      C 	jz short iget_2 ; no
 1D1F  32 C0		      C 	xor al,al ; mov al,0
 1D21  A2 262C R	      C 	mov byte ptr [imod],al 
 1D24  53		      C 	push bx ; * inode number
 1D25  8B 1E 262D R	      C 	mov bx,word ptr [ii]	
 1D29  FE C0		      C 	inc al ; mov al,1
			      C 	; ax = 1 = write
 1D2B  E8 0015		      C 	call icalc
 1D2E  5B		      C 	pop bx ; *
 1D2F  72 11		      C 	jc short iget_4
			      C 	; 27/11/2019
 1D31  33 C0		      C 	xor ax,ax
 1D33			      C iget_2:
 1D33  23 DB		      C 	and bx,bx
 1D35  74 07		      C 	jz short iget_3 ; get current inode
 1D37  89 1E 262D R	      C 	mov word ptr [ii],bx		
			      C 	; ax = 0 = read
 1D3B  E8 0005		      C 	call icalc
 1D3E			      C iget_3:
 1D3E  8B 1E 262D R	      C 	mov bx,word ptr [ii]
 1D42			      C iget_4:
			      C 	;pop ax ; **
 1D42			      C iget_5:
 1D42  C3		      C 	retn
			      C 
 1D43			      C iget	endp
			      C 
 1D43			      C icalc 	proc near
			      C 	; 14/12/2019
			      C 	; 12/12/2019
			      C 	; 09/11/2019
			      C 	; 07/11/2019 - Retro UNIX 386 v2 
			      C 	;	       (for hard disk file system)
			      C 	; 07/09/2019
			      C 	; 02/09/2019
			      C 	; 01/09/2019 - Retro UNIX 386 v2
			      C 	; 17/08/2012
			      C 	; 16/08/2012
			      C 	; 15/08/2012
			      C 	; 14/08/2012
			      C 	; 13/08/2012
			      C         ; 15/07/2012
			      C      	; 14/07/2012
			      C      	; Derived from (original) UNIX v1 source code
			      C 	; PRELIMINARY release of Unix Implementation Document, 
			      C 	; 20/06/1972
			      C 	;; AX=R0, BX=R1, CX=R3, DX=R5 
			      C 	; 0 = read, 1 = write
			      C 	; RETRO UNIX v1 FS
			      C 	; initialization/format version
			      C 	;
			      C         ; i-node is located in block (i+47)/16 and
			      C 	; begins 32*(i+47) mod 16 bytes from its start
			      C 	;; return => if cf=1 error number in [Error]
			      C 
			      C 	; input -> ax = 0 -> read, 1 = write
			      C 
			      C 	; 09/11/2019
			      C 	; modified registers: ax,dx,cx,bx
			      C 
			      C 	;add bx,47 ; add 47 to inode number, 15/8/2012
			      C 	;push bx ; R1 -> -(SP)
			      C 	;shr bx,1 ; divide by 16
			      C 	;shr bx,1
			      C 	;shr bx,1
			      C 	;shr bx,1
			      C 
			      C 	; 07/11/2019
			      C 	; inode 1 (1st inode) is on sector 4 
			      C 	; sector 0 : boot sector
			      C 	; sector 1 : super block
			      C 	; sector 2 : inodes map
			      C 	; sector 3 : free blocks map
			      C 	; sector 4 to 35 : inodes (32 sectors)
			      C 
			      C 	; 08/09/2019
			      C 	;add bx,31 ; add 31 to inode number
			      C 	;push bx
			      C 	;shr bx,1  ; divide by 8	
			      C 	;shr bx,1
			      C 	;shr bx,1
			      C 		; bx contains block number of block in which
			      C 		; inode exists
			      C 
			      C 	; 07/11/2019 - Hard disk file system (RUFS v2)
			      C 	; inode table start sector: [systm.sb_InodeTblAddr]
			      C 	
 1D43  4B		      C 	dec bx ; 0 based inode number
			      C 
 1D44  8B D3		      C 	mov dx,bx ; 12/12/2012
			      C 
 1D46  D1 EB		      C 	shr bx,1
 1D48  D1 EB		      C 	shr bx,1
 1D4A  D1 EB		      C 	shr bx,1
			      C 		; bx = sector offset (8 inodes per sector)
			      C 
			      C 	; 09/11/2019
 1D4C  A2 2634 R	      C 	mov byte ptr [I_rw],al ; 0 = read, 1 = write
			      C 
 1D4F  80 3E 2635 R 00	      C 	cmp byte ptr [I_valid],0
 1D54  76 0B		      C 	jna short icalc_0
 1D56  3B 1E 2636 R	      C 	cmp bx,word ptr [I_sector]
 1D5A  74 24		      C 	je short icalc_1
			      C 	
 1D5C  C6 06 2635 R 00	      C 	mov byte ptr [I_valid],0 ; inode sector validation, invalid
 1D61			      C icalc_0:
			      C 	; 12/12/2019
 1D61  52		      C 	push dx ; inode number - 1 ; (root dir inode = 1)
			      C 
 1D62  89 1E 2636 R	      C 	mov word ptr [I_sector],bx
 1D66  A1 0A38 R	      C 	mov ax,word ptr [systm.sb_InodeTblAddr]
 1D69  8B 16 0A3A R	      C 	mov dx,word ptr [systm.sb_InodeTblAddr+2] ; = 0
			      C 	
 1D6D  03 C3		      C 	add ax,bx
 1D6F  83 D2 00		      C 	adc dx,0
			      C 
 1D72  BB 2638 R	      C 	mov bx,offset I_buffer
 1D75  E8 004B		      C 	call dskrd
 1D78  5A		      C 	pop dx ; 14/8/2012
 1D79  72 40		      C 	jc short icalc_5
			      C 
 1D7B  C6 06 2635 R 01	      C 	mov byte ptr [I_valid],1 ; inode sector validation, valid
 1D80			      C icalc_1:
			      C 	;and dx,0Fh	; (i+47) mod 16
			      C 	;shl dx,1
			      C 	;shl dx,1
			      C 	;shl dx,1
			      C 	;shl dx,1
			      C 	;shl dx,1
			      C 		; DX = 32 * ((i+47) mod 16)	
			      C 		; DX (R5) points to first word in i-node i.
			      C 
 1D80  83 E2 07		      C 	and dx,07h	; (i+31) mod 8
 1D83  74 04		      C 	jz short @f ; 29/09/2019 
			      C 	;shl dx,1
			      C 	;shl dx,1
			      C 	;shl dx,1
			      C 	;shl dx,1	
			      C 	;shl dx,1
			      C 	;shl dx,1
 1D85  B1 06		      C 	mov cl,6
 1D87  D3 E2		      C 	shl dx,cl	
			      C 		; DX = 64 * ((i+31) mod 8)
			      C 		; DX points to first word in i-node i.	
 1D89			      C @@:
			      C 	; 14/8/2012
 1D89  57		      C 	push di
 1D8A  56		      C 	push si
			      C 	
 1D8B  BE 0EAC R	      C 	mov si,offset inode ; 14/8/2012
			      C 		; inode is address of first word of current inode
			      C 	;mov cx,16 ; CX = R3
			      C 	; 02/09/2019
 1D8E  B9 0020		      C 	mov cx,32 ; inode size/2 for Retro UNIX 386 v2 (& UNIX v7)	
			      C 
			      C 	; 09/09/2019
			      C 	;push ax
			      C 
			      C 	;mov di,offset Buffer ; 16/8/2012
			      C 	;mov di,word ptr [buff_o] ; 02/09/2019 - Retro UNIX 386 v2
			      C 
			      C 	; 04/12/2019
 1D91  BF 2638 R	      C 	mov di,offset I_buffer
			      C 
 1D94  03 FA		      C 	add di,dx ; 13/8/2012
			      C 
			      C  	;and ax,ax
			      C 	;jz short icalc_3 ; 0 = read (and copy i-node to memory) 
			      C 
 1D96  80 3E 2634 R 00	      C 	cmp byte ptr [I_rw],0
 1D9B  76 18		      C 	jna short icalc_3 ; read	
 1D9D			      C icalc_2:
			      C 	; 14/8/2012
			      C 	; overwrite old i-node (in buffer to be written)
 1D9D  F3/ A5		      C 	rep movsw
			      C 
			      C 	; 14/12/2019
 1D9F  A1 0A38 R	      C 	mov ax,word ptr [systm.sb_InodeTblAddr]
 1DA2  8B 16 0A3A R	      C 	mov dx,word ptr [systm.sb_InodeTblAddr+2] ; = 0
			      C 	
 1DA6  03 06 2636 R	      C 	add ax,word ptr [I_sector]
 1DAA  83 D2 00		      C 	adc dx,0
			      C 
 1DAD  BB 2638 R	      C 	mov bx,offset I_buffer
			      C 
			      C 	; 31/10/2012
			      C 
 1DB0  E8 0009		      C 	call dskwr
 1DB3  EB 04		      C 	jmp short icalc_4
 1DB5			      C icalc_3:
 1DB5  87 F7		      C 	xchg si,di ; 14/8/2012		
			      C 	; copy new i-node into inode area of (core) memory
 1DB7  F3/ A5		      C 	rep movsw
 1DB9			      C icalc_4:
			      C 	;pop ax ; 09/09/2019
			      C 	; 14/8/2012
 1DB9  5E		      C 	pop si
 1DBA  5F		      C 	pop di
			      C 
			      C 	; OUTPUTS ->
			      C 	; inode 
			      C 	; DX/R5 (internal), BX/R1 (internal), CX/R3 (internal) 
 1DBB			      C icalc_5:	
 1DBB  C3		      C 	retn		 
			      C 
 1DBC			      C icalc 	endp
			      C 
 1DBC			      C dskwr	proc near
			      C 	; 14/01/2020
			      C 	; 08/01/2020
			      C 	; 18/12/2019
			      C 	; 27/11/2019
			      C 	; 07/11/2019 - Retro UNIX 386 v2
			      C 	;
			      C 	; Disk (Sector) Write
			      C 	;
			      C 	; INPUT: 
			      C 	;	DX:AX = Sector address/number (LBA)
			      C 	;	ES:BX = Buffer address
			      C 	; OUTPUT:
			      C 	;	CF = 0 -> succeeded
			      C 	;	CF = 1 -> Error, Error code in [Error]
			      C 	;
			      C 	; Modified registers: cx, (si)
			      C 
 1DBC  C6 06 262F R 03	      C 	mov byte ptr [rw],3 ; write
 1DC1  EB 05		      C 	jmp short diskio
			      C 
 1DC3			      C dskwr	endp
			      C 	
 1DC3			      C dskrd	proc near
			      C 	; 14/01/2020
			      C 	; 08/01/2020
			      C 	; 18/12/2019
			      C 	; 03/12/2019
			      C 	; 27/11/2019
			      C 	; 07/11/2019
			      C 	; 06/11/2019 - Retro UNIX 386 v2
			      C 	;
			      C 	; Disk (Sector) Read
			      C 	;
			      C 	; INPUT: 
			      C 	;	DX:AX = Sector address/number (LBA)
			      C 	;	ES:BX = Buffer address
			      C 	; OUTPUT:
			      C 	;	CF = 0 -> succeeded
			      C 	;	CF = 1 -> Error, Error code in [Error]
			      C 	;
			      C 	; Modified registers: cx
			      C 
 1DC3  C6 06 262F R 02	      C 	mov byte ptr [rw],2 ; read
 1DC8			      C diskio:
 1DC8  C7 06 2629 R 0000      C 	mov word ptr [Error],0
 1DCE  C6 06 2AB1 R 04	      C 	mov byte ptr [RetryCount],4
			      C 
			      C 	; 07/11/2019
 1DD3  52		      C 	push dx ; *
 1DD4  50		      C 	push ax ; **
			      C 
			      C 	;add ax,word ptr [systm.sb_HiddenSects]
			      C 	;adc dx,word ptr [systm.sb_HiddenSects+2] 
			      C 	; 14/01/2020
 1DD5  03 06 0A14 R	      C 	add ax,word ptr [systm.sb_BootSectAddr]	  ; Hidden Sectors, lw
 1DD9  13 16 0A16 R	      C 	adc dx,word ptr [systm.sb_BootSectAddr+2] ; Hidden Sectors, hw
			      C 
 1DDD  80 3E 09FF R 90	      C 	cmp byte ptr [drive],90h ; Hard disk image file sign
			      C 	;je short image_file_rw
 1DE2  72 03 E9 00AE	      C 	jnb image_file_rw
			      C 
			      C 	; 27/11/2019
 1DE7  23 D2		      C 	and dx,dx
 1DE9  74 0E		      C 	jz short chs_read_write
			      C 
 1DEB  3B 16 2B32 R	      C 	cmp dx,word ptr [CHS_limit+2]
 1DEF  77 54		      C 	ja short lba_read_write
 1DF1  72 06		      C 	jb short chs_read_write
			      C 
 1DF3  3B 06 2B30 R	      C 	cmp ax,word ptr [CHS_limit]
 1DF7  77 4C		      C 	ja short lba_read_write
 1DF9			      C chs_read_write:
 1DF9  52		      C 	push dx ; ***
 1DFA  50		      C 	push ax ; ****
			      C 
 1DFB  53		      C 	push bx ; *****
			      C 	
 1DFC  8B 0E 2AC4 R	      C 	mov cx,word ptr [sectors] ; spt
 1E00  E8 E6F2		      C 	call div32	; Special 32 bit divide !!!
			      C                         ; To fix large disk problem.
			      C                         ; by Erdogan Tan
			      C                         ; (October 20th, 1999)
			      C 
 1E03  8B CB		      C 	mov cx,bx	;Sector (zero based)
 1E05  41		      C 	inc cx		; To make it 1 based
 1E06  51		      C 	push cx ; ******
 1E07  8B 0E 2AC2 R	      C 	mov cx,word ptr [heads]
 1E0B  E8 E6E7		      C 	call div32
 1E0E  8A F3		      C 	mov dh,bl	; bx = head (max. 255)
 1E10  59		      C 	pop cx ; ******	; ax=cylinder, dh=head, cx=sector
			      C 
 1E11  5B		      C 	pop bx ; *****	; es:bx = buffer address
			      C 
 1E12  8A 16 09FF R	      C 	mov dl,byte ptr [drive]	; physical drive number
 1E16  8A E8		      C 	mov ch,al
 1E18  D0 CC		      C 	ror ah,1
 1E1A  D0 CC		      C 	ror ah,1
			      C 	;and cl,63
 1E1C  0A CC		      C 	or cl,ah
			      C 
 1E1E  8A 26 262F R	      C 	mov ah,byte ptr [rw] ; 2 = read, 3 = write
 1E22  B0 01		      C  	mov al,1 ; 1 sector
 1E24  CD 13		      C 	int 13h		; ROM BIOS Service func ( ah ) = 2
			      C 			; Read disk sectors
			      C 			; AL-sec num CH-track CL-sec
			      C    			; DH-head DL-drive ES:BX-buffer
			      C  			; CF-flag AH-stat AL-sec read
			      C 			; If CF = 1 then (If AH > 0)
			      C 
 1E26  73 18		      C 	jnc short chs_rw_ok	
			      C 	
			      C 	; dl = physical drive number
			      C 
 1E28  FE 0E 2AB1 R	      C 	dec byte ptr [RetryCount]
 1E2C  74 0D		      C 	jz short chs_err_retn
			      C 
 1E2E  80 FC 09		      C 	cmp ah,09h ; DMA crossed 64K segment boundary
 1E31  74 08		      C 	je short chs_err_retn
			      C 
 1E33  32 E4		      C 	xor ah,ah ; reset
 1E35  CD 13		      C 	int 13h
			      C 
 1E37  58		      C 	pop ax ; ****
 1E38  5A		      C 	pop dx ; ***
			      C 
 1E39  EB BE		      C 	jmp short chs_read_write ; read (or write) again	
			      C 
 1E3B			      C chs_err_retn:
 1E3B			      C lba_err_retn:
 1E3B  F9		      C 	stc
 1E3C  88 26 2629 R	      C 	mov byte ptr [Error],ah
 1E40			      C chs_rw_ok:
			      C 	; 12/12/2019
 1E40			      C lba_rw_ok: ; 03/12/2019
 1E40  58		      C 	pop ax ; ****
 1E41  5A		      C 	pop dx ; ***
 1E42			      C @@:
 1E42  58		      C 	pop ax ; **
 1E43  5A		      C 	pop dx ; *
 1E44  C3		      C 	retn
			      C 
 1E45			      C lba_read_write:
			      C 	; 08/01/2020
			      C 	; 18/12/2019
			      C 	; 12/12/2019
			      C 	; 07/11/2019
			      C 	; LBA read/write
 1E45  80 0E 262F R 40	      C 	or byte ptr [rw],40h ; 42h = read, 43h = write
			      C 	; 06/11/2019
 1E4A  80 3E 0A78 R 01	      C 	cmp byte ptr [systm.sb_LBA_rw],1
 1E4F  73 07		      C 	jnb short lba_read_again
			      C 
 1E51			      C lba_not_ready:
 1E51  C6 06 2629 R FF	      C 	mov byte ptr [Error],0FFh
			      C 	;stc
			      C 	;retn
 1E56  EB EA		      C 	jmp short @b ; 08/01/2020
			      C 
 1E58			      C lba_read_again:
 1E58  52		      C 	push dx ; ***
 1E59  50		      C 	push ax ; ****
			      C 
			      C 	; 18/12/2019
 1E5A  56		      C 	push si ; *****
			      C 
			      C 	; 03/12/2019
 1E5B  33 C9		      C 	xor cx,cx
			      C 	;push 0
 1E5D  51		      C 	push cx ; 6*
			      C 	;push 0
 1E5E  51		      C 	push cx ; 7*
			      C 
 1E5F  52		      C 	push dx ; 8*
 1E60  50		      C 	push ax ; 9*
 1E61  06		      C 	push es ; 10*
 1E62  53		      C 	push bx ; 11*
			      C 
			      C 	;push 1
 1E63  B1 01		      C 	mov cl,1
 1E65  51		      C 	push cx ; 12*
			      C 	;push 16
 1E66  B1 10		      C 	mov cl,16
 1E68  51		      C 	push cx ; 13*
			      C 	
 1E69  8B F4		      C 	mov si,sp
 1E6B  8A 16 09FF R	      C 	mov dl,byte ptr [drive]
 1E6F  8A 26 262F R	      C 	mov ah,byte ptr [rw]
 1E73  32 C0		      C 	xor al,al ; verify off
 1E75  CD 13		      C 	int 13h
 1E77  58		      C 	pop ax ; 13*
 1E78  58		      C 	pop ax ; 12*
 1E79  5B		      C 	pop bx ; 11*
 1E7A  07		      C 	pop es ; 10*
 1E7B  58		      C 	pop ax ; 9*
 1E7C  5A		      C 	pop dx ; 8*
 1E7D  59		      C 	pop cx ; 7*
 1E7E  59		      C 	pop cx ; 6*
			      C 	; 18/12/2019*
 1E7F  5E		      C 	pop si ; *****
 1E80  73 BE		      C 	jnc short lba_rw_ok	
			      C 
			      C 	; dl = physical drive number
			      C 
 1E82  FE 0E 2AB1 R	      C 	dec byte ptr [RetryCount]
 1E86  74 B3		      C 	jz short lba_err_retn
			      C 
 1E88  80 FC 09		      C 	cmp ah,09h ; DMA crossed 64K segment boundary
 1E8B  74 AE		      C 	je short lba_err_retn
			      C 
 1E8D  32 E4		      C 	xor ah,ah ; reset
 1E8F  CD 13		      C 	int 13h
			      C 
 1E91  58		      C 	pop ax ; ****
 1E92  5A		      C 	pop dx ; ***
			      C 
 1E93  EB C3		      C 	jmp short lba_read_again ; read again
			      C 
 1E95			      C dskrd	endp	
			      C 	
 1E95			      C image_file_rw proc near
			      C 	; 07/11/2019 - Retro UNIX 386 v2 (hard disk images)
			      C 	; 09/09/2019 - Retro UNIX 386 v2 (floppy disk images)
			      C 
			      C 	; reading/writing a block (sector) from/to disk image file
			      C 
			      C 	; INPUT:
			      C 	; 	dx:ax = sector/block number (max. 4194303, 3FFFFFh)
			      C         ;	es:bx = buffer address (es = ds)
			      C 	;       [img_file_handle] = file handle
			      C 	;	number of bytes to be written = 512
			      C 	;
			      C 	; OUTPUT:
			      C 	;	CF = 0 -> succeeded
			      C 	;	CF = 1 -> Error, Error code in [Error]
			      C 	;
			      C 	; Modified registers: cx
			      C 
 1E95  83 FA 3F		      C 	cmp dx,3Fh  ; Max. 2GB disk image file (32bit seek limit)
 1E98  76 09		      C 	jna short hd_img_file_rw
			      C 
 1E9A			      C invalid_disk_image_sector:
 1E9A  F9		      C 	stc
 1E9B			      C image_file_rw_err:
 1E9B  C6 06 2629 R FF	      C 	mov byte ptr [Error],0FFh
 1EA0			      C image_file_rw_ok:
 1EA0  58		      C 	pop ax ; **
 1EA1  5A		      C 	pop dx ; *
 1EA2  C3		      C 	retn
			      C 	
 1EA3			      C hd_img_file_rw:
 1EA3  52		      C 	push dx ; ***
 1EA4  50		      C 	push ax ; ****
 1EA5  53		      C 	push bx ; ***** ; buffer offset
 1EA6  53		      C 	push bx ; ******
			      C 	; dx:ax = sector number 
 1EA7  B9 0200		      C 	mov cx,512
 1EAA  E8 E656		      C 	call mul32
			      C 	; dx:ax = byte offset
 1EAD  8B CA		      C 	mov cx,dx
 1EAF  8B D0		      C 	mov dx,ax
 1EB1  2A C0		      C 	sub al,al ; specified offset is from the beginning of the file
 1EB3  B4 42		      C 	mov ah,42h ; seek (move file pointer)	
 1EB5  8B 1E 2F46 R	      C 	mov bx,word ptr [img_file_handle]
 1EB9  CD 21		      C 	int 21h
 1EBB  5A		      C 	pop dx ; ****** ; buffer offset
 1EBC  72 18		      C 	jc short hd_img_file_rw_err
			      C 
			      C 	;mov bx,word ptr [img_file_handle]
 1EBE  B9 0200		      C 	mov cx,512
			      C 	; ds:dx = buffer offset
 1EC1  B4 3D		      C 	mov ah,3Dh ; 3Fh = read from file, 40h = write to file
 1EC3  02 26 262F R	      C 	add ah,byte ptr [rw] ; 2 = read, 3 = write 
 1EC7  CD 21		      C 	int 21h
 1EC9  72 0B		      C 	jc short hd_img_file_rw_err
 1ECB  80 3E 262F R 02	      C 	cmp byte ptr [rw],2  ; read ?
 1ED0  74 09		      C 	je short hd_img_file_rw_ok
 1ED2  3B C1		      C 	cmp ax,cx ; ax = actually written bytes
 1ED4  73 05		      C 	jnb short hd_img_file_rw_ok
			      C 
 1ED6			      C hd_img_file_rw_err:
			      C 	;pop bx ; *****
			      C 	;pop ax ; ****
			      C 	;pop dx ; ***
			      C 	;jmp short image_file_rw_err
			      C 
 1ED6  C6 06 2629 R FF	      C 	mov byte ptr [Error],0FFh
			      C 
 1EDB			      C hd_img_file_rw_ok:
 1EDB  5B		      C 	pop bx ; *****
 1EDC  58		      C 	pop ax ; ****
 1EDD  5A		      C 	pop dx ; ***
 1EDE  EB C0		      C 	jmp short image_file_rw_ok
			      C 
 1EE0			      C image_file_rw endp
			      C 
 1EE0			      C setimod proc near
			      C 	; 18/12/2019 - Retro DOS 386 v2 
			      C 	; 13/08/2012
			      C 	; 21/07/2012
			      C 	; 14/07/2012
			      C      	; Derived from (original) UNIX v1 source code
			      C 	; PRELIMINARY release of Unix Implementation Document, 
			      C 	; 20/06/1972
			      C 	;; AX=R0, BX=R1, CX=R3, DX=R5 
			      C 	; [SP] = Argument 1, 0 = read, 1 = write
			      C 	; RETRO UNIX v1 FS
			      C 	; initialization/format version
			      C 
			      C 	; 21/7/2012
 1EE0  52		      C 	push dx
 1EE1  50		      C 	push ax
			      C 
 1EE2  C6 06 262C R 01	      C 	mov byte ptr [imod],1
			      C 
			      C 	; Erdogan Tan 14-7-2012
 1EE7  E8 062A		      C 	call epoch
			      C 	
 1EEA  A3 0EE4 R	      C 	mov word ptr [i_mtim],ax  ; file modif. time
 1EED  89 16 0EE6 R	      C 	mov word ptr [i_mtim]+2,dx
			      C 
			      C 	; 18/12/2019 - Last access (inode modif.) time 
 1EF1  A3 0EE0 R	      C 	mov word ptr [i_ltim],ax
 1EF4  89 16 0EE2 R	      C 	mov word ptr [i_ltim]+2,dx
			      C 
			      C 	; 21/7/2012
 1EF8  83 3E 0EE8 R 00	      C 	cmp word ptr [i_ctim],0
 1EFD  77 0E		      C 	ja short @f
 1EFF  83 3E 0EEA R 00	      C 	cmp word ptr [i_ctim]+2,0
 1F04  77 07		      C 	ja short @f
			      C 
 1F06  A3 0EE8 R	      C 	mov word ptr [i_ctim],ax
 1F09  89 16 0EEA R	      C 	mov word ptr [i_ctim]+2,dx
 1F0D			      C @@:
			      C 	; 21/7/2012
 1F0D  58		      C 	pop ax
 1F0E  5A		      C 	pop dx
			      C 
 1F0F  C3		      C 	retn
			      C 
 1F10			      C setimod endp
			      C 
 1F10			      C imap	proc near
			      C 	; 02/01/2020
			      C 	; 07/11/2019 (dx <-> bx)
			      C 	; 02/09/2019 - Retro UNIX 386 v2
			      C 	; 21/08/2012
			      C 	; 05/08/2012
			      C      	; 16/07/2012
			      C      	; Derived from (original) UNIX v1 source code
			      C 	; PRELIMINARY release of Unix Implementation Document, 
			      C 	; 20/06/1972
			      C 	; RETRO UNIX v1 FS
			      C 	; initialization/format version
			      C 	;
			      C 	; get the byte that the allocation bit 
			      C 	; for the i-number contained in R1
			      C 
			      C 	; INPUT: 
			      C 	;	dx = inode number
			      C 	;	(im_buffer)
			      C 	; OUTPUT:
			      C 	;	bx = address of the byte contains allocation bit
			      C 	;	ax has 1 at calculated bit position
			      C 
			      C 	; Modified registers: ax,bx,cx, (si, di)
			      C 	
			      C 	; 02/01/2020
 1F10  52		      C 	push dx ; *
			      C 	
 1F11  4A		      C 	dec dx	; zero based inode number
			      C 
 1F12  52		      C 	push dx ; **
			      C 
			      C 	;mov bx,dx   ; DX = R2, BX = R1 (input, i-number)
			      C 	;sub bx,41  ; DX has i-41
			      C 	; 02/09/2019 - Retro UNIX 386 v2
			      C 	;dec bx ; zero based inode number
			      C 
			      C 	; 02/01/2020
			      C 	
 1F13  D1 EA		      C 	shr dx,1
 1F15  D1 EA		      C 	shr dx,1
 1F17  D1 EA		      C 	shr dx,1    ; DX has byte offset of zero based inode number
			      C 		    ; from the start of the (inode) map
			      C 
 1F19  8A DE		      C 	mov bl,dh ; <= 31
 1F1B  D0 EB		      C 	shr bl,1 ; inode map sector (index/offset) number (<= 15)	
 1F1D  32 FF		      C 	xor bh,bh
			      C 
 1F1F  81 E2 01FF	      C 	and dx,511 ; now DX points to byte offset in im_buffer
			      C 
			      C 	; 02/01/2020
 1F23  3B 1E 170C R	      C 	cmp bx,word ptr [im_sector]
 1F27  74 41		      C 	je short imap_3 ; current inode map sector is same sector
			      C 
 1F29  53		      C 	push bx ; *** new inode map sector
 1F2A  52		      C 	push dx ; **** byte offset in inode map sector buffer
 1F2B  53		      C 	push bx ; ***** new inode map sector
			      C 
 1F2C  BB 1710 R	      C 	mov bx,offset im_buffer		
			      C 
 1F2F  F6 06 262B R 02	      C 	test byte ptr [smod],2 ; inode map modified 
 1F34  74 1E		      C 	jz short imap_2 ; read inode map sector
			      C 
 1F36  A1 0A30 R	      C 	mov ax,word ptr [systm.sb_InodeMapAddr]
 1F39  8B 16 0A32 R	      C 	mov dx,word ptr [systm.sb_InodeMapAddr+2]
 1F3D  03 06 170C R	      C 	add ax,word ptr [im_sector]
 1F41  83 D2 00		      C 	adc dx,0
 1F44  E8 FE75		      C 	call dskwr
 1F47  73 06		      C 	jnc short imap_1
 1F49  5B		      C 	pop bx ; *****
 1F4A  5B		      C 	pop bx ; ****
 1F4B  5A		      C 	pop dx ; ***
 1F4C			      C imap_0:
 1F4C  5A		      C 	pop dx ; **
 1F4D  5A		      C 	pop dx ; *
 1F4E  C3		      C 	retn
 1F4F			      C imap_1:
 1F4F  80 26 262B R FD	      C 	and byte ptr [smod],0FDh ; reset bit 1
 1F54			      C imap_2:
			      C 	; 02/01/2020
 1F54  58		      C 	pop ax ; *****
 1F55  2B D2		      C 	sub dx,dx
 1F57  03 06 0A30 R	      C 	add ax,word ptr [systm.sb_InodeMapAddr]
 1F5B  13 16 0A32 R	      C 	adc dx,word ptr [systm.sb_InodeMapAddr+2]
 1F5F  E8 FE61		      C 	call dskrd
 1F62  5A		      C 	pop dx ; **** byte offset
 1F63  5B		      C 	pop bx ; *** sector
 1F64  72 E6		      C 	jc short imap_0
 1F66  89 1E 170C R	      C 	mov word ptr [im_sector],bx ; ***
 1F6A			      C imap_3:
			      C 	; dx = byte offset in inode map sector buffer
			      C 	; bx = inode map sector (index/offset)
			      C 	
 1F6A  59		      C 	pop cx ; ** ; inode number - 1
			      C 
 1F6B  B8 0001		      C 	mov ax,1    ;	
 1F6E  80 E1 07		      C 	and cl,7    ; CX has zero based inode number mod 8
			      C 		    ;	  to get the bit position	 		 	
 1F71  74 02		      C 	jz short imap_4 ; 21/8/2012
 1F73  D3 E0		      C 	shl ax,cl   ; AX has 1 in the calculated bit position
 1F75			      C imap_4:
			      C 	;; 5/8/2012		
			      C 	;add bx,word ptr [systm] ; superblock free map size + 4
			      C 	;; 21/8/2012
			      C 	;add bx,offset systm+4 ; is inode map offset in superblock
			      C 
			      C 	; 02/01/2020 - Retro UNIX 386 v2
 1F75  BB 1710 R	      C 	mov bx,offset im_buffer
 1F78  03 DA		      C 	add bx,dx
			      C 
			      C 	; CX (R3) used internally 	
			      C 	; AX (MQ) has a 1 in the calculated bit position
			      C 	; BX (R2) has byte address of the byte with allocation bit
 1F7A			      C imap_5:
 1F7A  5A		      C 	pop dx ; *
 1F7B			      C @@:	; 05/04/2022
 1F7B  C3		      C 	retn
			      C 
 1F7C			      C imap	endp
			      C 	
 1F7C			      C writei	proc near
			      C 	; 05/04/2022
			      C 	; 30/12/2019
			      C 	; 18/12/2019
			      C 	; 09/11/2019
			      C 	; 07/11/2019
			      C 	; 03/09/2019 - Retro UNIX 386 v2
			      C 	; 31/10/2012
			      C 	; 18/08/2012
			      C 	; 17/07/2012
			      C 	; BX = R1, i-number
			      C      	; Derived from (original) UNIX v1 source code
			      C 	; PRELIMINARY release of Unix Implementation Document, 
			      C 	; 20/06/1972
			      C 	;; AX=R0, BX=R1, i-number 
			      C 	; RETRO UNIX v1 FS
			      C 	; initialization/format version
			      C 	;
			      C 	; writei: write file
			      C 	;
			      C 	; 8086 CPU & IBM PC architecture modifications by Erdogan Tan 
			      C 	;; return => if cf=1 error number in [Error]
			      C 
			      C 	; input:
			      C 	; BX = R1 = I-Number
			      C 	; u.count = byte count
			      C 	; u.base = user buffer (offset)
			      C 	; u.fofp = (pointer to) current file offset
			      C  
 1F7C  33 C0		      C 	xor ax,ax ; 0		   ; clr u.nread	
 1F7E  A3 0EAA R	      C 	mov word ptr [u_nread],ax  ; clear the number of bytes transmitted during
			      C 				   ; read or write calls 
			      C 				   ; tst u.count		
 1F81  39 06 0EA4 R	      C 	cmp word ptr [u_count],ax  ; test the byte count specified by the user
			      C 	;;ja short write_1 ; 1f	   ; bgt 1f / any bytes to output; yes, branch
			      C 	;;retn			   ; rts 0 / no, return - no writing to do
			      C 	;jna short @f
 1F85  76 F4		      C 	jna short @b ; 03/09/2019
			      C 
 1F87			      C write_1:
			      C 	;cmp bx,40		; cmp r1,$40.
			      C 				; does the i-node number indicate a special file?
			      C 	;ja  short dskw_0	; bgt dskw / no, branch to standard file output
			      C ;@@:
			      C ;	retn
			      C 
			      C ;	shl	bx,1		; asl r1 
			      C 				; yes, calculate the index into the special file
			      C 
			      C ;	cmp bx,offset write_3 - offset writei_2 + 2
			      C ;	ja short writei_error
			      C 
			      C ;	jmp word ptr [write_2][BX]-2 ; *1f-2(r1)
			      C 				; jump table and jump to the appropriate routine
			      C ;write_2: ;1
			      C ;	dw offset wtty	; tty
			      C ;	dw offset wmem	; mem
			      C ;	dw offset wfd ; fd0
			      C ;	dw offset wfd ; fd1
			      C ;	dw offset whd ; hd0
			      C ;	dw offset whd ; hd1
			      C ;	dw offset whd ; hd2
			      C ;	dw offset whd ; hd3
			      C ;	dw offset xmtt ; tty0
			      C ;	dw offset xmtt ; tty1
			      C ;	dw offset xmtt ; tty2
			      C ;	dw offset xmtt ; tty3
			      C ;	dw offset xmtt ; tty4
			      C ;	dw offset xmtt ; tty5
			      C ;	dw offset xmtt ; tty6
			      C ;	dw offset xmtt ; tty7
			      C ;	dw offset w1pr ; lpr
			      C ; writei_3:	
			      C ;	dw offset writei_error
			      C 
			      C ;wtty: ; write to concole tty
			      C ;	retn
			      C ;wmem: ; transfer characters from a user area of core to memory
			      C ;	retn
			      C 
			      C ;wfd:  ; write to floppy disk (drive)	
			      C ;	retn
			      C 
			      C ;whd:  ; write to hard/fixed disk (drive)	
			      C ;	retn
			      C ;wlpr  ; write to printer
			      C ;	retn
			      C 	
			      C ;xmtt:
			      C ;	retn
			      C 
 1F87			      C writei 	endp
			      C 
 1F87			      C dskw	proc near
			      C 	; 05/04/2022
			      C 	; 30/12/2019
			      C 	; 18/12/2019
			      C 	; 04/12/2019
			      C 	; 07/11/2019
			      C 	; 03/09/2019 - Retro UNIX 386 v2
			      C 	; 01/03/2013
			      C 	; 31/10/2012
			      C 	; 19/08/2012
			      C 	; 30/07/2012
			      C      	; 17/07/2012
			      C      	; Derived from (original) UNIX v1 source code
			      C 	; PRELIMINARY release of Unix Implementation Document, 
			      C 	; 20/06/1972
			      C 	; dskw: write routine for non-special files
			      C 	;
			      C 	; RETRO UNIX v1 FS
			      C 	; initialization/format version
			      C 	;
			      C 	; write data to a file
			      C 	;
			      C 	; BX (R1) = I-node number
			      C 
 1F87			      C dskw_0:
 1F87  57		      C 	push di
 1F88  56		      C 	push si
			      C 
 1F89  53		      C 	push bx	; save i-number on stack
			      C 
 1F8A  C6 06 2629 R FF	      C 	mov byte ptr [Error],0FFh ; 03/09/2019
			      C 
 1F8F  E8 FD7E		      C 	call iget 	; jsr	r0,iget
			      C 		  	; write i-node out (if modified), read i-node 'r1'
			      C 		        ; into i-node area of core
			      C 	;jc dskw_5 ; 01/03/2013
			      C 	; 05/04/2022
 1F92  73 03		      C 	jnc short @f
 1F94  E9 0091		      C 	jmp dskw_5
 1F97			      C @@:
			      C 	; 03/09/2019 - Retro UNIX 386 v2
 1F97  A0 0EAD R	      C 	mov al,byte ptr [i_flgs+1]
 1F9A  A8 80		      C 	test al,80h		; regular file ?
 1F9C  75 04		      C 	jnz short dskw_8	; yes
 1F9E  A8 20		      C 	test al,20h 		; device file ?
			      C 	;;jnz short dskw_7	; yes
			      C 	;jz short dskw_8 ; 07/09/2019
			      C 	;;test al,40h		; directory ?
			      C 	;;jnz short dskw_8	; yes
 1FA0  75 1E		      C 	jnz short dskw_7 ; 04/12/2019	
 1FA2			      C dskw_8:
 1FA2  8B 36 0EA8 R	      C 	mov si,word ptr [u_fofp]
			      C 	;mov dx,word ptr [si] 
			      C 			; mov *u.fofp,r2 
			      C 			; put the file offset [(u.off) or the offset in
			      C 		        ; the fsp entry for this file] in r2
			      C 	;add dx,word ptr [u_count]
			      C 			; add u.count,r2 
			      C 			; no. of bytes to be written + file offset is
			      C 		        ; put in r2
			      C 
			      C 	;cmp dx,word ptr [i_size] ; cmp r2,i.size
			      C 			; is this greater than the present size of
			      C 			; the file?
			      C 	;jna short dskw_1 ; blos 1f / no, branch
			      C 
			      C 	;mov word ptr [i_size],dx ; mov	r2,i.size 
			      C 			; yes, increase the file size to file offset +
			      C 			; no. of data bytes
			      C 
			      C 	; 09/11/2019 - 32 bit file size
 1FA6  8B 04		      C 	mov ax,word ptr [si]
 1FA8  8B 54 02		      C 	mov dx,word ptr [si+2]
			      C 
			      C 	; 30/12/2019
 1FAB  03 06 0EA4 R	      C 	add ax,word ptr [u_count]
 1FAF  83 D2 00		      C 	adc dx,0
			      C 	
 1FB2  3B 16 0EB6 R	      C 	cmp dx,word ptr [i_size+2]
 1FB6  74 0B		      C 	je short dskw_9	
 1FB8  72 15		      C 	jb short dskw_1
 1FBA  89 16 0EB6 R	      C 	mov word ptr [i_size+2],dx 
 1FBE  EB 09		      C 	jmp short dskw_10
 1FC0			      C dskw_7:
 1FC0  F9		      C 	stc
 1FC1  EB 65		      C 	jmp short dskw_5
 1FC3			      C dskw_9:
 1FC3  3B 06 0EB4 R	      C 	cmp ax,word ptr [i_size]
 1FC7  76 06		      C 	jna short dskw_1	
 1FC9			      C dskw_10:  
 1FC9  A3 0EB4 R	      C 	mov word ptr [i_size],ax
			      C 
 1FCC  E8 FF11		      C 	call setimod	; jsr r0,setimod 
			      C 			; set imod=1 (i.e., core inode has been
			      C 			; modified), stuff time of modification into
			      C 			; core image of i-node
 1FCF			      C dskw_1: ; 1
 1FCF  E8 0086		      C 	call mget	; jsr r0,mget 
			      C 			; get the block no. in which to write the next data
			      C   		        ; byte
			      C 			; AX = R1 = Block Number
 1FD2  72 54		      C 	jc short dskw_5 ; 01/03/2013
			      C 	; 09/11/2019
			      C 	; dx:ax = Block/Sector number
			      C 
			      C 	; Check current sector in the buffer
			      C 	
 1FD4  80 3E 0A04 R 01	      C 	cmp byte ptr [buff_m],1
 1FD9  72 25		      C 	jb short dskw_12
			      C 
 1FDB  8B 0E 0A00 R	      C 	mov cx,word ptr [buff_s]
 1FDF  8B 1E 0A02 R	      C 	mov bx,word ptr [buff_s+2]
			      C 	;mov si,cx
			      C 	;or si,bx
			      C 	;jz short dskw_12 ; buff_s = 0 is invalid	
			      C 	;cmp si,0FFFFh	; buff_s = 0FFFFh is invalid
			      C 	;je short dskw_12
			      C 
			      C 	; write buffer content if sector is not same
			      C 
 1FE3  3B C8		      C 	cmp cx,ax
 1FE5  75 04		      C 	jne short dskw_11
 1FE7  3B DA		      C 	cmp bx,dx
 1FE9  74 15		      C 	je short dskw_12	
 1FEB			      C dskw_11:
 1FEB  52		      C 	push dx
 1FEC  50		      C 	push ax
			      C 	;mov ax,word ptr [buff_s]
			      C 	;mov dx,word ptr [buff_s+2]
			      C 	; 18/12/2019
 1FED  8B C1		      C 	mov ax,cx
 1FEF  8B D3		      C 	mov dx,bx
 1FF1  BB 1910 R	      C 	mov bx,offset Buffer
 1FF4  E8 FDC5		      C 	call dskwr
 1FF7  58		      C 	pop ax
 1FF8  5A		      C 	pop dx
 1FF9  72 2D		      C 	jc short dskw_5
 1FFB  C6 06 0A04 R 00	      C 	mov byte ptr [buff_m],0
 2000			      C dskw_12:
 2000  8B 36 0EA8 R	      C 	mov si,word ptr [u_fofp]
 2004  8B 1C		      C 	mov bx,word ptr [si]
 2006  81 E3 01FF	      C 	and bx,1FFh  	; bit	*u.fofp,$777
			      C 			; test the lower 9 bits of the file offset
 200A  BB 1910 R	      C 	mov bx,offset Buffer ; 04/12/2019
 200D  75 08		      C 	jnz short dskw_2 ; bne 2f 
			      C 			; if its non-zero, branch; if zero, file offset = 0,
			      C 		   	; 512, 1024,...(i.e., start of new block)
 200F  81 3E 0EA4 R 0200      C 	cmp word ptr [u_count],512 ; cmp u.count,$512.
			      C 			; if zero, is there enough data to fill an
			      C 		        ; entire block? (i.e., no. of
			      C 	;jnb short dskw_6 ; bhis 3f / bytes to be written greater than 512.? 
			      C 			; Yes, branch. / Don't have to read block
 2015  73 15		      C 	jnb short dskw_3 ; 09/11/2019
 2017			      C dskw_2: ; 2
			      C 	; in as no past info. is to be saved (the entire block will be
			      C         ; overwritten).
			      C 
			      C 	; 09/11/2019
			      C 	;mov bx,offset Buffer ; 04/12/2019
 2017  3B 06 0A00 R	      C 	cmp ax,word ptr [buff_s]
			      C 	;jne short dskw_13
 201B  75 06		      C 	jne short dskw_6
 201D  3B 16 0A02 R	      C 	cmp dx,word ptr [buff_s+2]
 2021  74 09		      C 	je short dskw_3
			      C ;dskw_13:
 2023			      C dskw_6:
			      C 	;mov bx,ax	; R1 (block number)
 2023  E8 FD9D		      C 	call dskrd 	; jsr r0,dskrd 
			      C 			; no, must retain old info.. Hence, read block 'r1'
			      C 		        ; into an I/O buffer
			      C 	;jc short dskw_5 ; 01/03/2013
			      C 	; 04/12/2019
 2026  73 04		      C 	jnc short dskw_3
 2028			      C dskw_5:
 2028  5B		      C 	pop bx
			      C 
 2029  5E		      C 	pop si
 202A  5F		      C 	pop di
			      C 
 202B  C3		      C 	retn
			      C 
 202C			      C dskw_3: ; 3
			      C 	;call wslot
			      C 
 202C  E8 04AE		      C 	call sioreg
			      C 
			      C 	; SI = user data offset (r1)
			      C 	; DI = sector (I/O) buffer offset (r2)
			      C 	; CX = byte count (r3)
			      C 
 202F			      C dskw_4: ; 2
 202F  F3/ A4		      C 	rep movsb
			      C 
 2031  C6 06 0A04 R 01	      C 	mov byte ptr [buff_m],1
			      C 	; 09/11/2019
 2036  A3 0A00 R	      C 	mov word ptr [buff_s],ax
 2039  89 16 0A02 R	      C 	mov word ptr [buff_s+2],dx
			      C 	;mov bx,offset Buffer ; offset sector_buffer	
 203D  E8 FD7C		      C 	call dskwr ; jsr r0,dskwr / write the block and the i-node
 2040  72 E6		      C         jc short dskw_5
			      C 
 2042  C6 06 0A04 R 00	      C 	mov byte ptr [buff_m],0
			      C 	
 2047  83 3E 0EA4 R 00	      C         cmp word ptr [u_count],0 ; any more data to write?
			      C 	;ja dskw_1 ; 1b 	 ; yes, branch
			      C 	; 05/04/2022
 204C  76 03		      C 	jna short @f
 204E  E9 FF7E		      C 	jmp dskw_1
 2051			      C @@:
 2051  C6 06 2629 R 00	      C 	mov byte ptr [Error],0 ; 03/09/2019
			      C 	; 04/12/2019
 2056  EB D0		      C 	jmp short dskw_5
			      C ;dskw_5:
			      C ;	pop bx
			      C ;
			      C ;	pop si
			      C ;	pop di
			      C ;
			      C ;	retn
			      C 
			      C ;dskw_6:
			      C 	;cmp byte ptr [buff_m],1
			      C 	;jb short dskw_3
			      C 	;mov bx,offset Buffer ; 09/11/2019
			      C 	;call dskwr
			      C 	;jc short dskw_5
			      C 	;mov word ptr [buff_s],ax ; block number from mget procedure
			      C 	;mov word ptr [buff_s+2],dx 
			      C 	;cmp byte ptr [buff_m],0
			      C 	;jmp short dskw_3
			      C 
 2058			      C dskw 	endp
			      C 
			      C ; 04/09/2019 - Retro UNIX 386 v2
			      C ;sizing: db 0FFh ; (initial value is not important!)
			      C 
 2058			      C mget 	proc near
			      C 	; 05/04/2022
			      C 	; 13/01/2020
			      C 	; 18/12/2019
			      C 	; 12/12/2019
			      C 	; 08/12/2019
			      C 	; 05/12/2019
			      C 	; get sector/block address for current file pointer
			      C 	; (if file pointer points a number greater than current file size, 
			      C 	; a new -empty- sector/block will be created/written) 
			      C 	; 04/12/2019
			      C 	; 01/12/2019
			      C 	; 27/11/2019
			      C 	; 13/11/2019
			      C 	; 09/11/2019 - Retro UNIX 386 v2 (32 bit sector/block numbers)
			      C 	; 15/09/2019
			      C 	; 04/09/2019 (simplified for initialization floppy disk)
			      C 	; 03/09/2019 - Retro UNIX 386 v2
			      C 	; 05/03/2013
			      C 	; 01/03/2013
			      C 	; 31/10/2012
			      C 	; 20/10/2012
			      C 	; 19/08/2012
			      C 	; 13/08/2012
			      C 	; 27/07/2012
			      C      	; 21/07/2012
			      C      	; Derived from (original) UNIX v1 source code
			      C 	; PRELIMINARY release of Unix Implementation Document, 
			      C 	; 20/06/1972
			      C 	;; return -> AX=R1
			      C 	; RETRO UNIX v1 FS
			      C 	; initialization/format version
			      C 	; cf -> 1 = error (no free block)
			      C 
			      C 	; 01/12/2019
			      C 	; INPUT:
			      C 	;	[u_fofp] = pointer to file pointer
			      C 	; OUTPUT:
			      C 	;	dx:ax = sector/block address
			      C 	;
			      C 	; Modified registers: ax,dx,cx,bx
			      C 
			      C 	;push bx
			      C 	;push cx
			      C 	;push dx
			      C 	 ;; contents of bx,cx,dx will be destroyed 
 2058			      C mget_0:
 2058  8B 1E 0EA8 R	      C 	mov bx,word ptr [u_fofp]
			      C 	; 13/11/2019
 205C  8B 07		      C 	mov ax,word ptr [bx]
 205E  8B 57 02		      C 	mov dx,word ptr [bx+2]
			      C 			
			      C 	; 31/10/2012
			      C 	;mov bx,word ptr [u_fofp]
			      C 	;mov ax,word ptr [bx]
			      C 
			      C 	;mov bl,ah  ; div ax by 256
			      C 	;xor bh,bh
			      C 
			      C 	; BX = R2
			      C         ;test word ptr [i_flgs],4096 ; 1000h
			      C 			  	     ; is this a large or small file
			      C 	;jnz short mget_8 ; 4f ; large file
			      C 
 2061  F6 06 0EAD R 10	      C 	test byte ptr [i_flgs+1],16 ; 10h
			      C 	;jnz mget_8 ; not small file
			      C 	; 05/04/2022
 2066  74 03		      C 	jz short @f
 2068  E9 00DB		      C 	jmp mget_8
 206B			      C @@:
			      C         ;test bl,0F0h ; !0Fh  ; branch if BX (R2) >= 16                    
			      C 	;jnz short mget_3 ; 3f
			      C 
			      C 	; 13/11/2019
			      C 	; small file size limit = 5120 bytes (1400h)
			      C 
 206B  0B D2		      C 	or dx,dx
 206D  75 6A		      C 	jnz short mget_3  ; requested file offset > 65535
			      C 
			      C 	; 13/11/2019
			      C 	; Retro UNIX 386 v2 disk inode contains..
			      C 	; (if large file flag is clear -not set-)
			      C 	; 10 direct disk block/sector dword pointers
			      C 
			      C 	; 15/09/2019
			      C 	;cmp bl,14h
 206F  80 FC 14		      C 	cmp ah,14h
 2072  73 65		      C 	jnb short mget_3 ; 3f ; requested offset >= 5120
			      C 
			      C 	; 01/12/2019
 2074  8A DC		      C 	mov bl,ah  ; div ax by 256
 2076  32 FF		      C 	xor bh,bh
			      C 
			      C 	;and bl,0Eh  ; clear all bits but bits 1,2,3
 2078  80 E3 1E		      C 	and bl,1Eh ; 15/09/2019 ; clear all bits but bits 1,2,3,4
			      C 
 207B  D0 E3		      C 	shl bl,1 ; 03/09/2019 - Retro UNIX 386 v2
 207D  8B 87 0EB8 R	      C 	mov ax,word ptr [bx+i_dskp] ; AX = R1, physical block number
			      C 	; 09/11/2019
 2081  8B 97 0EBA R	      C 	mov dx,word ptr [bx+i_dskp+2] ; DX = hw of physical block number
 2085  0B C0		      C 	or ax,ax
 2087  75 4F		      C 	jnz short mget_2 ; if physical block number is zero
			      C 			 ; then we need a new block for file
			      C 	; 09/11/2019
 2089  0B D2		      C 	or dx,dx
 208B  75 4B		      C 	jnz short mget_2
 208D  E8 020B		      C 	call alloc	 ; allocate a new block for this file	
			      C 			 ; AX (R1) = Block number
			      C 	;jc mget_6	 ; cf -> 1 & ax = 0 -> no free block
			      C 	; 05/04/2022
 2090  73 03		      C 	jnc short @f
 2092  E9 00AA		      C 	jmp mget_6
 2095			      C @@:
			      C 	; 09/11/2019
 2095  89 87 0EB8 R	      C 	mov word ptr [bx+i_dskp],ax
 2099  89 97 0EBA R	      C 	mov word ptr [bx+i_dskp+2],dx 
			      C 
 209D  E8 FE40		      C 	call setimod
			      C 
			      C 	; 09/09/2019
			      C 	;mov byte ptr [buff_c],1
			      C 
			      C 	; 08/12/2019
 20A0  BB 1910 R	      C 	mov bx,offset Buffer
			      C 
			      C 	; 04/12/2019
 20A3  80 3E 0A04 R 00	      C 	cmp byte ptr [buff_m],0 ; buffer modified ?
 20A8  76 15		      C 	jna short mget_1
			      C 
 20AA  52		      C 	push dx
 20AB  50		      C 	push ax
 20AC  A1 0A00 R	      C 	mov ax,word ptr [buff_s]
 20AF  8B 16 0A02 R	      C 	mov dx,word ptr [buff_s+2]
			      C 	;mov bx,offset Buffer
 20B3  E8 FD06		      C 	call dskwr
 20B6  58		      C 	pop ax
 20B7  5A		      C 	pop dx
 20B8  72 1E		      C 	jc short mget_2
 20BA  C6 06 0A04 R 00	      C 	mov byte ptr [buff_m],0 ; reset buffer modified sign
 20BF			      C mget_1:
 20BF  A3 0A00 R	      C 	mov word ptr [buff_s],ax
 20C2  89 16 0A02 R	      C 	mov word ptr [buff_s+2],dx
			      C 
			      C 	; 05/12/2019
 20C6  C6 06 0A04 R 01	      C 	mov byte ptr [buff_m],1 ; set buffer modified sign
			      C 
 20CB  E8 03FE		      C 	call clear	; clear Buffer
			      C 
			      C 	; BX = offset Buffer
			      C 
 20CE  E8 FCEB		      C 	call dskwr
 20D1  72 05		      C 	jc short mget_2
			      C 
 20D3  C6 06 0A04 R 00	      C 	mov byte ptr [buff_m],0 ; reset buffer modified sign
			      C 
 20D8			      C mget_2: ; 2
			      C 	; AX (R1) = Physical block number
			      C 	; DX = high word of block/sector number ; 09/11/2019
			      C 
			      C 	;pop dx
			      C 	;pop cx
			      C 	;pop bx
			      C 
 20D8  C3		      C 	retn
			      C 
 20D9			      C mget_3: ; 3
			      C 	; adding on block which changes small file to large file
 20D9  E8 01BF		      C 	call alloc
 20DC  72 61		      C 	jc short mget_6 ; 01/03/2013 
			      C 	; call wslot  ; setup I/O buffer for write
			      C 	;	   ; R5 points to the first data word in buffer
			      C 
			      C 	; push ds
			      C 	; pop es
			      C 
			      C 	; 13/01/2020
 20DE  BB 1910 R	      C 	mov bx,offset Buffer
			      C 
			      C 	; 18/12/2019
 20E1  80 3E 0A04 R 00	      C 	cmp byte ptr [buff_m],0 ; buffer modified ?
 20E6  76 15		      C 	jna short mget_4
			      C 
 20E8  52		      C 	push dx
 20E9  50		      C 	push ax
 20EA  A1 0A00 R	      C 	mov ax,word ptr [buff_s]
 20ED  8B 16 0A02 R	      C 	mov dx,word ptr [buff_s+2]
			      C 	;mov bx,offset Buffer ; 13/01/2020
 20F1  E8 FCC8		      C 	call dskwr
 20F4  58		      C 	pop ax
 20F5  5A		      C 	pop dx
 20F6  72 E0		      C 	jc short mget_2
 20F8  C6 06 0A04 R 00	      C 	mov byte ptr [buff_m],0 ; reset buffer modified sign
 20FD			      C mget_4:
			      C 	; 09/11/2019
 20FD  A3 0A00 R	      C 	mov word ptr [buff_s],ax  ; Block/Sector number
 2100  89 16 0A02 R	      C 	mov word ptr [buff_s+2],dx
			      C 
			      C 	; 13/01/2020 (si, di)
			      C 	;push si
			      C 	;push di
 2104  50		      C 	push ax
			      C 
			      C 	;mov cx,8  ; R3, transfer old physical block pointers
			      C 		   ; into new indirect block area for the new
			      C 		   ; large file	
 2105  B9 000A		      C 	mov cx,10 ; 15/09/2019	
			      C 	;mov di,word ptr [buff_o]  ; 03/09/2019
			      C 	; 09/11/2019
			      C 	;mov di,offset Buffer ; BX = R5
 2108  BE 0EB8 R	      C 	mov si,offset i_dskp 
			      C 
 210B  8B FB		      C 	mov di,bx ; 13/01/2020
			      C 	
 210D  33 C0		      C 	xor ax,ax ; mov ax,0
 210F			      C mget_5: ; 1
 210F  A5		      C 	movsw
 2110  A5		      C 	movsw ; 07/09/2019
 2111  89 44 FE		      C 	mov word ptr [si-2],ax ; 13/01/2020
 2114  89 44 FC		      C 	mov word ptr [si-4],ax ; 07/09/2019
 2117  E2 F6		      C 	loop mget_5
			      C 	
			      C 	;;mov cl,256-8 ; clear rest of data buffer
			      C 	;mov cl,256-16 ; 07/09/2019
 2119  B1 EC		      C 	mov cl,256-20 ; 15/09/2019	
			      C 
 211B  F3/ AB		      C 	rep stosw
			      C 
 211D  58		      C 	pop ax
			      C 	;pop di ; 13/01/2020
			      C 	;pop si
			      C 
 211E  C6 06 0A04 R 01	      C 	mov byte ptr [buff_m],1 ; modified
			      C 
 2123  E8 FC96		      C 	call dskwr
 2126  72 1D		      C 	jc short mget_7 ; 01/03/2013	
			      C 
 2128  A3 0EB8 R	      C 	mov word ptr [i_dskp],ax
			      C 	; 09/11/2019
 212B  89 16 0EBA R	      C 	mov word ptr [i_dskp+2],dx
 212F  C6 06 0A04 R 00	      C 	mov byte ptr [buff_m],0 ; reset modified sign
			      C 	
			      C 	;or word ptr [i_flgs],4096 ; 1000h
			      C 
 2134  80 0E 0EAD R 10	      C 	or byte ptr [i_flgs+1],10000b ; 10h ; 16
			      C 
 2139  E8 FDA4		      C 	call setimod
			      C 
			      C 	; 15/09/2019
 213C  E9 FF19		      C 	jmp mget_0
			      C 
 213F			      C mget_6: 
 213F  C7 06 2629 R 0200      C 	mov word ptr [Error],err_NOFREEBLOCK
			      C 	
			      C 	;pop dx
			      C 	;pop cx
			      C 	;pop bx
 2145			      C mget_7:	
 2145  C3		      C 	retn
			      C 
 2146			      C mget_8:	; 4 ; large file
			      C 	
			      C 	; 13/11/2019
			      C 
			      C 	; Retro UNIX 386 v2 disk inode contains..
			      C 	; (if large file flag is set)
			      C 	; 8 indirect disk block/sector dword pointers
			      C 	; +1 double indirect disk block/sector dword pointers
			      C 	; +1 triple indirect disk block/sector dword pointers
			      C 
			      C 	; check indirect pointers limit (as file offset)
			      C 	; 8*128 = 1024 blocks (or sectors) or 512 KB
			      C 	; check dx (file offset hw) value
			      C 	
 2146  83 FA 08		      C 	cmp dx,08h ; 524288 = 080000h
 2149  73 20		      C 	jnb short mget_9 ; check double indirect limit
			      C 
 214B  C6 06 2630 R 01	      C 	mov byte ptr [level],1
 2150  B9 0009		      C 	mov cx,9
 2153  E8 E3CA		      C 	call shr32
			      C 	; ax = sector offset (flat)
			      C 	; dx = 0
 2156  8A C8		      C 	mov cl,al
 2158  80 E1 7F		      C 	and cl,127
 215B  88 0E 2631 R	      C 	mov byte ptr [level+1],cl
 215F  B1 07		      C 	mov cl,7	
			      C 	;call shr32
 2161  D3 E8		      C 	shr ax,cl  ; 13/01/2020
			      C 	; ax = indirect pointer index (<= 7)
			      C 	; dx = 0
			      C 	;mov byte ptr [level+2],al
			      C 	; 15/11/2019
 2163  D0 E0		      C 	shl al,1
 2165  D0 E0		      C 	shl al,1
 2167  8B F0		      C 	mov si,ax
 2169  EB 5A		      C 	jmp short mget_11
 216B			      C mget_9:
			      C 	; check double indirect pointers limit (as file offset)
			      C 	; (128*128)+1024 = 16384+1024 blocks or 8 MB + 512 KB
			      C 	; check dx (file offset hw) value
			      C 	
 216B  81 FA 0088	      C 	cmp dx,88h ; 8912896 = 880000h	
 216F  73 24		      C 	jnb short mget_10
			      C 
 2171  C6 06 2630 R 02	      C 	mov byte ptr [level],2
 2176  83 EA 08		      C 	sub dx,08h
 2179  B9 0009		      C 	mov cx,9
 217C  E8 E3A1		      C 	call shr32
			      C 	; dx:ax = sector offset (flat)
 217F  8A C8		      C 	mov cl,al
 2181  80 E1 7F		      C 	and cl,127
 2184  88 0E 2631 R	      C 	mov byte ptr [level+1],cl
 2188  B1 07		      C 	mov cl,7	
 218A  E8 E393		      C 	call shr32
			      C 	; ax = indirect pointer index (<= 127)
			      C 	; dx = 0
 218D  A2 2632 R	      C 	mov byte ptr [level+2],al
 2190  BE 0020		      C 	mov si,8*4 ; 32
 2193  EB 30		      C 	jmp short mget_11
 2195			      C mget_10:
			      C 	; 13/11/2019
			      C 	; triple indirect pointers ; 8912386 to 1082654210 bytes
 2195  BE 0024		      C 	mov si,9*4 ; 36
			      C 
 2198  C6 06 2630 R 03	      C 	mov byte ptr [level],3
 219D  81 EA 0088	      C 	sub dx,88h
 21A1  B9 0009		      C 	mov cx,9
 21A4  E8 E379		      C 	call shr32
			      C 	; dx:ax = sector offset (flat)
 21A7  8A C8		      C 	mov cl,al
 21A9  80 E1 7F		      C 	and cl,127
 21AC  88 0E 2631 R	      C 	mov byte ptr [level+1],cl
 21B0  B1 07		      C 	mov cl,7	
 21B2  E8 E36B		      C 	call shr32
			      C 	; ax = indirect pointer index (<= 127)
			      C 	; dx = 0
 21B5  8A D0		      C 	mov dl,al
 21B7  80 E2 7F		      C 	and dl,127
 21BA  88 16 2632 R	      C 	mov byte ptr [level+2],dl
 21BE  B1 07		      C 	mov cl,7
 21C0  D3 E8		      C 	shr ax,cl
 21C2  A2 2633 R	      C 	mov byte ptr [level+3],al
 21C5			      C mget_11:
 21C5  8B 84 0EB8 R	      C 	mov ax,word ptr [si+i_dskp]
 21C9  8B 94 0EBA R	      C 	mov dx,word ptr [si+i_dskp+2]
			      C 
 21CD  BB 1910 R	      C 	mov bx,offset Buffer  ; 01/12/2019
			      C 	
 21D0  0B C0		      C 	or ax,ax
 21D2  75 4A		      C 	jnz short mget_15 ; if physical block number is zero
			      C 			 ; then we need a new block for file
 21D4  0B D2		      C 	or dx,dx
 21D6  75 46		      C 	jnz short mget_15
			      C 
 21D8  E8 00C0		      C 	call alloc	 ; allocate a new block for this file	
			      C 			 ; AX (R1) = Block number
			      C 	;jc mget_6	 ; cf -> 1 & ax = 0 -> no free block
			      C 	;;jc short mget_12 ; 30/12/2019
			      C 	; 05/04/2022
 21DB  73 03		      C 	jnc short @f
 21DD  E9 FF5F		      C 	jmp mget_6	
 21E0			      C @@:
 21E0  89 84 0EB8 R	      C 	mov word ptr [si+i_dskp],ax
 21E4  89 94 0EBA R	      C 	mov word ptr [si+i_dskp+2],dx
			      C 
			      C 	; 18/12/2019
 21E8  80 3E 0A04 R 00	      C 	cmp byte ptr [buff_m],0 ; buffer modified ?
 21ED  76 11		      C 	jna short mget_13
			      C 
 21EF			      C mget_20: ; 13/01/2020
 21EF  52		      C 	push dx
 21F0  50		      C 	push ax
 21F1  A1 0A00 R	      C 	mov ax,word ptr [buff_s]
 21F4  8B 16 0A02 R	      C 	mov dx,word ptr [buff_s+2]
			      C 	;mov bx,offset Buffer
 21F8  E8 FBC1		      C 	call dskwr
 21FB  58		      C 	pop ax
 21FC  5A		      C 	pop dx
			      C 	;jc short mget_12
			      C 	;mov byte ptr [buff_m],0 ; reset buffer modified sign
 21FD  73 06		      C 	jnc short mget_14
 21FF			      C mget_12:
 21FF  C3		      C 	retn
 2200			      C mget_13:
 2200  C6 06 0A04 R 01	      C 	mov byte ptr [buff_m],1  ; buffer modified
 2205			      C mget_14:
 2205  E8 02C4		      C 	call clear ; clear buffer
			      C 
 2208  E8 FCD5		      C 	call setimod
			      C 
 220B  A3 0A00 R	      C 	mov word ptr [buff_s],ax
 220E  89 16 0A02 R	      C 	mov word ptr [buff_s+2],dx
			      C 	;mov bx,offset Buffer
 2212  E8 FBA7		      C 	call dskwr
 2215  72 E8		      C 	jc short mget_12
			      C 	; 01/12/2019
 2217  C6 06 0A04 R 00	      C 	mov byte ptr [buff_m],0 ; reset buffer modified sign
 221C  EB 34		      C 	jmp short mget_18
 221E			      C mget_15:
			      C 	; 13/11/2019
 221E  3B 06 0A00 R	      C 	cmp ax,word ptr [buff_s]
 2222  75 06		      C 	jne short mget_16	
 2224  3B 16 0A02 R	      C 	cmp dx,word ptr [buff_s+2]
 2228  74 28		      C 	je short mget_18
 222A			      C mget_16:	
 222A  80 3E 0A04 R 00	      C 	cmp byte ptr [buff_m],0 ; buffer modified ?
 222F  76 15		      C 	jna short mget_17
			      C 
			      C 	; 01/12/2019		
 2231  52		      C 	push dx
 2232  50		      C 	push ax
 2233  A1 0A00 R	      C 	mov ax,word ptr [buff_s]
 2236  8B 16 0A02 R	      C 	mov dx,word ptr [buff_s+2]
			      C 	;mov bx,offset Buffer
 223A  E8 FB7F		      C 	call dskwr
 223D  58		      C 	pop ax
 223E  5A		      C 	pop dx
 223F  72 BE		      C 	jc short mget_12
 2241  C6 06 0A04 R 00	      C 	mov byte ptr [buff_m],0 ; reset buffer modified sign
 2246			      C mget_17:
			      C 	;mov bx,offset Buffer	
 2246  E8 FB7A		      C 	call dskrd
 2249  72 B4		      C 	jc short mget_12
			      C 
 224B  A3 0A00 R	      C 	mov word ptr [buff_s],ax
 224E  89 16 0A02 R	      C 	mov word ptr [buff_s+2],dx
 2252			      C mget_18:
			      C 	; 13/01/2020
 2252  80 3E 2630 R 00	      C 	cmp byte ptr [level],0
 2257  76 A6		      C 	jna short mget_12
			      C 	
			      C 	;dec byte ptr [level]
			      C 	;jz short mget_12
			      C 
 2259  8A 1E 2630 R	      C 	mov bl,byte ptr [level]
 225D  32 FF		      C 	xor bh,bh
 225F  8A 9F 2630 R	      C 	mov bl,byte ptr [bx+level] ; sector pointer offset
 2263  D0 E3		      C 	shl bl,1
 2265  D1 E3		      C 	shl bx,1 ; 13/01/2020
			      C 
			      C 	; 13/01/2020
 2267  FE 0E 2630 R	      C 	dec byte ptr [level]
			      C 	
			      C 	; 13/01/2020
 226B  BE 1910 R	      C 	mov si,offset Buffer
			      C 
			      C 	; 01/12/2019
 226E  03 DE		      C 	add bx,si ; offset Buffer ; 13/01/2020
			      C 
 2270  8B 07		      C 	mov ax,word ptr [bx]
 2272  8B 57 02		      C 	mov dx,word ptr [bx+2]
			      C 
			      C 	; 01/12/2019
 2275  0B C0		      C 	or ax,ax
			      C 	;jnz short mget_16 ; if physical block number is zero
			      C 			 ; then we need a new block for file
 2277  75 04		      C 	jnz short mget_21 ; 13/01/2020
 2279  0B D2		      C 	or dx,dx
			      C 	;jnz short mget_16
 227B  74 0A		      C 	jz short mget_23 ; 13/01/2020
 227D			      C mget_21:
			      C 	; 13/01/2020
 227D  8B DE		      C 	mov bx,si ; offset Buffer
			      C 
 227F  80 3E 2630 R 00	      C 	cmp byte ptr [level],0
			      C 	;ja short mget_16
 2284  77 C0		      C 	ja short mget_17
 2286			      C mget_22:
 2286  C3		      C 	retn
 2287			      C mget_23:
 2287  E8 0011		      C 	call alloc	 ; allocate a new block for this file	
			      C 			 ; AX (R1) = Block number
			      C 	;jc mget_6	; cf -> 1 & ax = 0 -> no free block
			      C 	; 13/01/2020
			      C 	;jnc short mget_19
			      C 	;
			      C 	;retn
 228A  72 FA		      C 	jc short mget_22	
 228C			      C mget_19:
			      C 	; 12/12/2019
 228C  89 07		      C 	mov word ptr [bx],ax
 228E  89 57 02		      C 	mov word ptr [bx+2],dx
			      C 
			      C 	; 13/01/2020
			      C 	; 18/12/2019
 2291  C6 06 0A04 R 01	      C 	mov byte ptr [buff_m],1 ; set buffer modified sign
			      C 	;call setimod
			      C 	;mov bx,offset Buffer
 2296  8B DE		      C 	mov bx,si ; offset Buffer ; 13/01/2020
			      C 	;jmp mget_13
			      C 	; 13/01/2020
 2298  E9 FF54		      C 	jmp mget_20
			      C 	
 229B			      C mget	endp
			      C 
 229B			      C alloc 	proc near
			      C 	; 03/01/2020
			      C 	; 06/12/2019
			      C 	; 27/11/2019
			      C 	; 07/11/2019
			      C 	; 28/10/2019
			      C 	; 24/10/2019 - Retro UNIX 386 v2 (UNIXHDFS)
			      C 	; allocate disk sector
			      C 	;; input -> none
			      C 	;; output -> DX:AX = allocated sector/block number
			      C 	;; 	cf = 1 -> could not be allocated
			      C 	; Modified registers: none (except ax,dx)
			      C 
 229B  A1 0A48 R	      C 	mov ax,word ptr [systm.sb_FreeBlocks] 	
 229E  8B 16 0A4A R	      C 	mov dx,word ptr [systm.sb_FreeBlocks+2]
 22A2  0B C2		      C 	or ax,dx
 22A4  75 02		      C 	jnz short alloc_0
 22A6			      C alloc_err:
 22A6  F9		      C 	stc
 22A7  C3		      C 	retn
 22A8			      C alloc_0:
			      C 	; 06/12/2019
 22A8  A1 0A4C R	      C 	mov ax,word ptr [systm.sb_FirstFreeBlk]
 22AB  8B 16 0A4E R	      C 	mov dx,word ptr [systm.sb_FirstFreeBlk+2]
			      C 
 22AF  51		      C 	push cx ; *
 22B0  53		      C 	push bx ; **
			      C 
 22B1  8B CA		      C 	mov cx,dx
 22B3  8B D8		      C 	mov bx,ax
 22B5  83 F9 FF		      C 	cmp cx,0FFFFh
 22B8  72 0D		      C 	jb short alloc_1
 22BA  83 FB FF		      C 	cmp bx,0FFFFh
 22BD  72 0C		      C 	jb short alloc_2	
 22BF  33 C0		      C 	xor ax,ax
 22C1  33 D2		      C 	xor dx,dx
			      C 	; dx:ax = fbm sector index (as start sector) = 0
 22C3  33 DB		      C 	xor bx,bx ; bit 0
 22C5  EB 0D		      C 	jmp short alloc_3	
 22C7			      C alloc_1:
 22C7  0B CB		      C 	or cx,bx
 22C9  74 09		      C 	jz short alloc_3
 22CB			      C alloc_2:		
 22CB  B9 000C		      C 	mov cx,12   ; 512 block alloc bytes per free block map sector
 22CE  E8 E24F		      C 	call shr32  ; (4096 block alloc bits per fm sector)	
 22D1  83 E3 0F		      C 	and bx,0Fh  ; start bit position of fbm buffer byte
 22D4			      C alloc_3:
			      C 	; free map sector (index) in dx:ax
			      C 
 22D4  53		      C 	push bx ; ***
			      C 
 22D5  3B 06 1708 R	      C 	cmp ax,word ptr [fm_sector]
 22D9  75 06		      C 	jne short alloc_4
 22DB  3B 16 170A R	      C 	cmp dx,word ptr [fm_sector+2]
 22DF  74 49		      C 	je short alloc_6	
 22E1			      C alloc_4:
			      C 	; 12/12/2019
 22E1  BB 1B10 R	      C 	mov bx,offset fbm_buffer
			      C 
 22E4  F6 06 262B R 01	      C 	test byte ptr [smod],1 ; free map modified flag
 22E9  74 1D		      C 	jz short alloc_5
			      C 
 22EB  52		      C 	push dx ; ****
 22EC  50		      C 	push ax ; *****
			      C 
			      C 	;call sync ; writes current free map sector/block
			      C 	;	  ; and updates super block
			      C 
			      C 	; 12/12/2019
 22ED  A1 1708 R	      C 	mov ax,word ptr [fm_sector]
 22F0  8B 16 170A R	      C 	mov dx,word ptr [fm_sector+2]
 22F4  03 06 0A28 R	      C 	add ax,word ptr [systm.sb_FreeMapAddr]
 22F8  13 16 0A2A R	      C 	adc dx,word ptr [systm.sb_FreeMapAddr+2]
			      C 	;mov bx,offset fbm_buffer
 22FC  E8 FABD		      C 	call dskwr
			      C 
 22FF  58		      C 	pop ax ; *****
 2300  5A		      C 	pop dx ; ****	
 2301  72 5E		      C 	jc short alloc_9 ; 07/11/2019
			      C 
			      C 	; 12/12/2019
 2303  80 26 262B R FE	      C 	and byte ptr [smod],0FEh ; reset free map modified flag
 2308			      C alloc_5:
			      C 	; 07/11/2019
 2308  A3 30EA R	      C 	mov word ptr [save_ax],ax
 230B  89 16 30EC R	      C 	mov word ptr [save_dx],dx
 230F			      C alloc_17: ; 27/11/2019
 230F  03 06 0A28 R	      C 	add ax,word ptr [systm.sb_FreeMapAddr]
 2313  13 16 0A2A R	      C 	adc dx,word ptr [systm.sb_FreeMapAddr+2]
			      C 
			      C 	;mov bx,offset fbm_buffer 	
 2317  E8 FAA9		      C 	call dskrd
 231A  72 45		      C 	jc short alloc_9 ; 07/11/2019
			      C 
			      C 	; 07/11/2019	
 231C  A1 30EA R	      C 	mov ax,word ptr [save_ax]
 231F  8B 16 30EC R	      C 	mov dx,word ptr [save_dx]
 2323  A3 1708 R	      C 	mov word ptr [fm_sector],ax
 2326  89 16 170A R	      C 	mov word ptr [fm_sector+2],dx
 232A			      C alloc_6:	
 232A  BB 1B0E R	      C 	mov bx,offset fbm_buffer-2
			      C 	; 28/10/2019
 232D			      C alloc_7: 
			      C 	; dx:ax = [fm_sector] ; 07/11/2019
 232D  43		      C 	inc bx
 232E  43		      C 	inc bx 
			      C 	;mov dx,word ptr [bx]
			      C 	;or dx,dx
			      C 	; 07/11/2019
 232F  8B 0F		      C 	mov cx,word ptr [bx]
 2331  0B C9		      C 	or cx,cx
 2333  75 3C		      C 	jnz short alloc_10 ; branch if any free blocks in this word	
 2335  81 FB 1D0E R	      C 	cmp bx,offset fbm_buffer+510 
 2339  72 F2		      C 	jb short alloc_7
			      C 	;mov ax,word ptr [fm_sector]
			      C 	;mov dx,word ptr [fm_sector+2]
 233B  83 C0 01		      C 	add ax,1
 233E  83 D2 00		      C 	adc dx,0
 2341  A3 30EA R	      C 	mov word ptr [save_ax],ax
 2344  89 16 30EC R	      C 	mov word ptr [save_dx],dx
			      C 
			      C 	;mov cx,12  ; 512 block alloc bytes per free block map sector
			      C 	;call shl32 ; (4096 block alloc bits per fm sector)
			      C 	;cmp dx,word ptr [systm.sb_TotalSects+2]
			      C 	;jb short alloc_8
			      C 	;ja short alloc_3	
			      C 	;cmp ax,word ptr [systm.sb_TotalSects]
			      C  	;jnb short alloc_9
			      C 
 2348  B9 0009		      C 	mov cx,9  ; 512 block alloc bytes per free block map sector
 234B  E8 E1C9		      C 	call shl32 ; (4096 block alloc bits per fm sector)
 234E  3B 16 0A2E R	      C 	cmp dx,word ptr [systm.sb_FreeMapSize+2]
 2352  72 11		      C 	jb short alloc_8
			      C 	;ja short alloc_3
 2354  77 06		      C 	ja alloc_19 ; 03/01/2020		
 2356  3B 06 0A2C R	      C 	cmp ax,word ptr [systm.sb_FreeMapSize]
 235A  72 09		      C  	jb short alloc_8
			      C 	; 03/01/2020
 235C			      C alloc_19:
 235C  33 C0		      C 	xor ax,ax ; 07/11/2019
 235E  33 D2		      C 	xor dx,dx
 2360  F9		      C 	stc	; cf=1 --> error: no free blocks/sectors
			      C 	;jmp short alloc_9
			      C 	; 03/01/2020
 2361			      C alloc_9:
 2361  5B		      C 	pop bx ; ***
 2362  5B		      C 	pop bx ; **
 2363  59		      C 	pop cx ; *
 2364  C3		      C 	retn
			      C 
 2365			      C alloc_8:
 2365  A1 30EA R	      C 	mov ax,word ptr [save_ax]
 2368  8B 16 30EC R	      C 	mov dx,word ptr [save_dx]
 236C  BB 1B10 R	      C 	mov bx,offset fbm_buffer  ; 12/12/2019
 236F  EB 9E		      C 	jmp short alloc_17 ; 27/11/2019
			      C 
 2371			      C alloc_10:
			      C 	; 07/11/2019
 2371  8B D1		      C 	mov dx,cx
			      C 
			      C 	; 28/10/2019	
			      C 	; dx = value of (current) fbm buffer byte
			      C 
 2373  59		      C 	pop cx ; ***
 2374  B8 0001		      C 	mov ax,1
			      C 	;and cx,0Fh ; bit position
			      C 	;jz short alloc_11
 2377  23 C9		      C 	and cx,cx
 2379  74 04		      C 	jz short alloc_11
 237B  D3 EA		      C 	shr dx,cl
 237D  D3 E0		      C 	shl ax,cl ; 27/11/2019
 237F			      C alloc_11:
			      C 	; 08/12/2019
 237F  88 0E 2628 R	      C 	mov byte ptr [bitpos],cl ; 0 to 15
			      C 
			      C 	; BX = byte offset in fbm_buffer
			      C 	; AX = bit position to be reset
 2383  D1 EA		      C 	shr dx,1
 2385  72 14		      C 	jc short alloc_12
			      C 	; 08/12/2019
 2387  80 F9 0F		      C 	cmp cl,0Fh ; 15
 238A  73 06		      C 	jnb short alloc_18
 238C  D1 E0		      C 	shl ax,1
 238E  FE C1		      C 	inc cl
 2390  EB ED		      C 	jmp short alloc_11
 2392			      C alloc_18:
			      C 	; 08/12/2019
 2392  A1 1708 R	      C 	mov ax,word ptr [fm_sector]
 2395  8B 16 170A R	      C 	mov dx,word ptr [fm_sector+2]
 2399  EB 92		      C 	jmp short alloc_7
 239B			      C alloc_12:
 239B  F7 D0		      C 	not ax ; requested bit is 0 (allocated), others are 1 (free)
 239D  21 07		      C 	and word ptr [bx],ax
			      C 
 239F  A1 1708 R	      C 	mov ax,word ptr [fm_sector]
 23A2  8B 16 170A R	      C 	mov dx,word ptr [fm_sector+2]
 23A6  8B C8		      C 	mov cx,ax
 23A8  0B CA		      C 	or cx,dx
 23AA  74 06		      C 	jz short alloc_13
 23AC  B9 000C		      C 	mov cx,12  ; convert fbm sector index number to bit offset
 23AF  E8 E165		      C 	call shl32
			      C 	; dx:ax = total bits number of sectors before current fbm sector
 23B2			      C alloc_13:	
			      C 	; 08/12/2019
 23B2  81 EB 1B10 R	      C 	sub bx,offset fbm_buffer
			      C  	; bx = byte offset in fbm_buffer
 23B6  74 06		      C 	jz short alloc_14 
 23B8  D1 E3		      C 	shl bx,1
 23BA  D1 E3		      C 	shl bx,1
 23BC  D1 E3		      C 	shl bx,1
			      C 	; bx = bit offset (0 to 4080)
 23BE			      C alloc_14:
			      C 	; ch = 0
 23BE  8A 0E 2628 R	      C 	mov cl,byte ptr [bitpos] ; 0 to 15
 23C2  03 D9		      C 	add bx,cx
			      C 	;	
 23C4  03 C3		      C 	add ax,bx
 23C6  83 D2 00		      C 	adc dx,0
			      C 	; dx:ax = bit offset from start of fbm = allocated sector number 
			      C 
 23C9  80 0E 262B R 01	      C 	or byte ptr [smod],1  ; set free map modified flag
			      C 			      ; in super block	
			      C 
			      C 	; Do not change invalid count of free blocks
			      C 	; (0FFFFFFFFh) value here! -otherwise it may be a mistake!-
 23CE  8B 0E 0A48 R	      C 	mov cx,word ptr [systm.sb_FreeBlocks] 	
 23D2  23 0E 0A4A R	      C 	and cx,word ptr [systm.sb_FreeBlocks+2]
 23D6  83 F9 FF		      C 	cmp cx,0FFFFh 
 23D9  73 0F		      C 	jnb short alloc_15
			      C 
 23DB  83 2E 0A48 R 01	      C 	sub word ptr [systm.sb_FreeBlocks],1 	
 23E0  83 1E 0A4A R 00	      C 	sbb word ptr [systm.sb_FreeBlocks+2],0
			      C 
 23E5  80 0E 262B R F0	      C 	or byte ptr [smod],0F0h  ; set sb modified flag
 23EA			      C alloc_15:
 23EA  3B 06 0A4C R	      C 	cmp ax,word ptr [systm.sb_FirstFreeBlk]
 23EE  75 15		      C 	jne short alloc_16
 23F0  3B 16 0A4E R	      C 	cmp dx,word ptr [systm.sb_FirstFreeBlk+2]
 23F4  75 0F		      C 	jne short alloc_16
			      C 
			      C 	; set first free block to the next sector (in order)
 23F6  83 06 0A4C R 01	      C 	add word ptr [systm.sb_FirstFreeBlk],1
 23FB  83 16 0A4E R 00	      C 	adc word ptr [systm.sb_FirstFreeBlk+2],0
			      C 
 2400  80 0E 262B R F0	      C 	or byte ptr [smod],0F0h  ; set sb modified flag
 2405			      C alloc_16:
			      C 	; 06/12/2019
 2405  F8		      C 	clc
 2406  5B		      C 	pop bx ; **
 2407  59		      C 	pop cx ; *
			      C 	; DX:AX = Block/Sector number
 2408  C3		      C 	retn
			      C 
 2409			      C alloc   endp
			      C 
			      C ; 16/10/2019 - Retro UNIX 386 v2 (UNIXHDFS.COM for v2, initial workings)
			      C 
 2409			      C free	proc near
			      C 	; 08/12/2019
			      C 	; 27/11/2019
			      C 	; 07/11/2019
			      C 	; 28/10/2019
			      C 	; 24/10/2019
			      C 	; release disk sector
			      C 	; 16/10/2019 - Retro UNIX 386 v2 (UNIXHDFS)
			      C 	; DX:AX = Sector to be freed/released
			      C 	; Modified registers: cx,bx ; 07/11/2019
			      C 	;		cf = 1 -> error
			      C 
			      C 	; Calculate free map sector for requested sector in dx:ax
			      C 
 2409  A3 30EA R	      C 	mov word ptr [save_ax],ax
 240C  89 16 30EC R	      C 	mov word ptr [save_dx],dx
			      C 
 2410  8B D8		      C 	mov bx,ax
 2412  81 E3 0FFF	      C 	and bx,4095 ; 28/10/2019
			      C 
			      C 	;mov cx,4096
			      C 	;call div32
 2416  B9 000C		      C 	mov cx,12
 2419  E8 E104		      C 	call shr32
			      C 
 241C  3B 06 1708 R	      C 	cmp ax,word ptr [fm_sector]
 2420  75 06		      C 	jne short free_1
 2422  3B 16 170A R	      C 	cmp dx,word ptr [fm_sector+2]
 2426  74 43		      C 	je short free_3
 2428			      C free_1:
			      C 	; 27/11/2019
 2428  53		      C 	push bx ; ***
			      C 
			      C 	; 10/12/2019
 2429  BB 1B10 R	      C 	mov bx,offset fbm_buffer  
			      C 
 242C  F6 06 262B R 01	      C 	test byte ptr [smod],1 ; free map modified flag
 2431  74 1F		      C 	jz short free_2
			      C 
 2433  52		      C 	push dx ; **
 2434  50		      C 	push ax ; *
			      C 
			      C 	;call sync ; writes current free map sector/block
			      C 	;	   ; and updates super block
			      C 
			      C 	; 10/12/2019
 2435  A1 1708 R	      C 	mov ax,word ptr [fm_sector]
 2438  8B 16 170A R	      C 	mov dx,word ptr [fm_sector+2]
			      C 
 243C  03 06 0A28 R	      C 	add ax,word ptr [systm.sb_FreeMapAddr]
 2440  13 16 0A2A R	      C 	adc dx,word ptr [systm.sb_FreeMapAddr+2]
			      C 
			      C 	;mov bx,offset fbm_buffer 	
 2444  E8 F975		      C 	call dskwr
 2447  72 05		      C 	jc short free_9
			      C 
 2449  80 26 262B R FE	      C 	and byte ptr [smod],0FEh ; reset bit 0
 244E			      C free_9:
 244E  58		      C 	pop ax ; *
 244F  5A		      C 	pop dx ; **
 2450  72 78		      C 	jc short free_7
 2452			      C free_2:
			      C 	; 07/11/2019
 2452  52		      C 	push dx ; **
 2453  50		      C 	push ax ; *
			      C 
 2454  03 06 0A28 R	      C 	add ax,word ptr [systm.sb_FreeMapAddr]
 2458  13 16 0A2A R	      C 	adc dx,word ptr [systm.sb_FreeMapAddr+2]
			      C 
			      C 	;mov bx,offset fbm_buffer ; 10/12/2019	
 245C  E8 F964		      C 	call dskrd
			      C 	
 245F  58		      C 	pop ax ; *
 2460  5A		      C 	pop dx ; **
 2461  5B		      C 	pop bx ; ***
 2462  72 67		      C 	jc short free_8
			      C 
			      C 	; 07/11/2019
 2464  A3 1708 R	      C 	mov word ptr [fm_sector],ax
 2467  89 16 170A R	      C 	mov word ptr [fm_sector+2],dx
 246B			      C free_3:	
 246B  8B CB		      C 	mov cx,bx
 246D  B8 0001		      C 	mov ax,1	
 2470  83 E1 0F		      C 	and cx,0Fh
 2473  74 02		      C 	jz short free_4
 2475  D3 E0		      C 	shl ax,cl
 2477			      C free_4:
 2477  D1 EB		      C 	shr bx,1
 2479  D1 EB		      C 	shr bx,1
 247B  D1 EB		      C 	shr bx,1
 247D  D1 EB		      C 	shr bx,1
			      C 
 247F  D1 E3		      C 	shl bx,1 ; byte ofset with word boundary
 2481  81 C3 1B10 R	      C 	add bx,offset fbm_buffer
			      C 
			      C 	; BX = byte offset in fbm_buffer
			      C 	; DX = bit position to be set
			      C 
 2485  09 07		      C 	or word ptr [bx],ax
			      C 
 2487  80 0E 262B R 01	      C 	or byte ptr [smod],1  ; set free map modified flag
			      C 			      ; in super block
			      C 	; 28/10/2019
			      C 	; Do not change invalid count of free blocks
			      C 	; (0FFFFFFFFh) value here! -otherwise it may be a mistake!-
 248C  8B 0E 0A48 R	      C 	mov cx,word ptr [systm.sb_FreeBlocks] 	
 2490  23 0E 0A4A R	      C 	and cx,word ptr [systm.sb_FreeBlocks+2]
 2494  83 F9 FF		      C 	cmp cx,0FFFFh 
 2497  73 0F		      C 	jnb short free_5
			      C 	
 2499  83 06 0A48 R 01	      C 	add word ptr [systm.sb_FreeBlocks],1 	
 249E  83 16 0A4A R 00	      C 	adc word ptr [systm.sb_FreeBlocks+2],0
			      C 	; 28/10/2019
 24A3  80 0E 262B R F0	      C 	or byte ptr [smod],0F0h  ; set sb modified flag
 24A8			      C free_5:	
 24A8  A1 30EA R	      C 	mov ax,word ptr [save_ax]
 24AB  8B 16 30EC R	      C 	mov dx,word ptr [save_dx]		
			      C 
 24AF  3B 16 0A4E R	      C 	cmp dx,word ptr [systm.sb_FirstFreeBlk+2]
 24B3  77 16		      C 	ja short free_8
 24B5  72 06		      C 	jb short free_6	
			      C 
 24B7  3B 06 0A4C R	      C 	cmp ax,word ptr [systm.sb_FirstFreeBlk]
 24BB  73 0E		      C 	jnb short free_8
 24BD			      C free_6:
 24BD  A3 0A4C R	      C 	mov word ptr [systm.sb_FirstFreeBlk],ax
 24C0  89 16 0A4E R	      C 	mov word ptr [systm.sb_FirstFreeBlk+2],dx
			      C 	; 28/10/2019
 24C4  80 0E 262B R F0	      C 	or byte ptr [smod],0F0h  ; set sb modified flag
			      C 	;clc
 24C9  C3		      C 	retn
 24CA			      C free_7:
 24CA  5B		      C 	pop bx ; ***
 24CB			      C free_8:
 24CB  C3		      C 	retn
			      C 
 24CC			      C free	endp
			      C 
			      C ; 04/12/2019
			      C 
			      C ;alloc_inode proc near
			      C ;	; 29/10/2019
			      C ;	; 24/10/2019
			      C ;	; 23/10/2019 - Retro UNIX 386 v2 (UNIXHDFS)
			      C ;	; allocate inode
			      C ;	;; input -> none
			      C ;	;; output -> AX = inode number (which is allocated)
			      C ;	;; 	cf = 1 -> could not be allocated
			      C ;	; Modified registers: ax,dx,cx,bx
			      C ;	
			      C ;	mov ax,word ptr [systm.sb_FirstFreeIno]
			      C ;	inc ax ; 0FFFFh -> 0
			      C ;	jz short alloci_0
			      C ;	dec ax
			      C ;	jz short alloci_0
			      C ;	dec ax
			      C ;	; 24/10/2019
			      C ;	mov cl,12 
			      C ;	shr ax,cl  ; 4096 inodes per inode map sector
			      C ;		   ; (8 inodes per byte)	
			      C ;alloci_0:
			      C ;	cmp ax,word ptr [im_sector] ; zero based im sector index
			      C ;	je short alloci_2
			      C ;alloci_12:
			      C ;	test byte ptr [smod],2 ; inode map modified flag
			      C ;	jz short alloci_1
			      C ;
			      C ;	mov word ptr [save_ax],ax
			      C ;
			      C ;	call sync ; writes current inode map sector/block
			      C ;		  ; and updates super block
			      C ;	jc short alloci_6
			      C ;
			      C ;	mov ax,word ptr [save_ax]
			      C ;alloci_1:
			      C ;	xor dx,dx
			      C ;	add ax,word ptr [systm.sb_InodeMapAddr]	 
			      C ;	adc dx,word ptr [systm.sb_InodeMapAddr+2]
			      C ;	mov bx,offset im_buffer
			      C ;	call dskrd
			      C ;	jc short alloci_6
			      C ;	
			      C ;	mov ax,word ptr [save_ax]
			      C ;	mov word ptr [im_sector],ax	
			      C ;alloci_2:	
			      C ;	mov bx,offset im_buffer-2
			      C ;	xor ax,ax ; 0
			      C ;alloci_3: 
			      C ;	inc bx
			      C ;	inc bx 
			      C ;	mov dx,word ptr [bx]
			      C ;	cmp dx,0FFFFh
			      C ;	jb short alloci_7 ; branch if any free inodes in this word	
			      C ;	; 29/10/2019
			      C ;	cmp bx,offset im_buffer+510
			      C ;	jb short alloci_3
			      C ;	mov ax,word ptr [im_sector]
			      C ;	; 24/10/2019
			      C ;	push ax
			      C ;	or ax,ax
			      C ;	jz short alloci_13
			      C ;	mov cl,12 
			      C ;	shl ax,cl  ; 4096 inodes per inode map sector
			      C ;		   ; (8 inodes per byte)	
			      C ;alloci_13:
			      C ;	inc ax
			      C ;	mov word ptr [save_dx],ax
			      C ;	cmp ax,word ptr [systm.sb_InodeCount]
			      C ;	pop ax
			      C ;	jnb short alloci_14
			      C ;	inc ax
			      C ;	;jmp short alloci_0
			      C ;	jmp short alloci_12 ; 24/10/2019 
			      C ;	
			      C ;alloci_14:
			      C ;	;jmp short panic ; no free inodes
			      C ;
			      C ;	xor ax,ax
			      C ;	stc		; cf=1 --> error: no free inodes
			      C ;alloci_6:
			      C ;	retn	
			      C ;alloci_7:
			      C ;	mov ax,1	; bit 0
			      C ;	mov cx,ax
			      C ;alloci_8:
			      C ;	shr dx,1	; Branch when a free inode found,
			      C ;			; bit for inode k is in byte k/8 
			      C ;			; in bit k (mod 8) 	
			      C ;	jnc short alloci_9
			      C ;	shl ax,1	; set bir position number (for next)    
			      C ;	inc cx
			      C ;	jmp short alloci_8
			      C ;	
			      C ;alloci_9:
			      C ;	; ax : masking bit is '1' and others are '0'
			      C ;	or word ptr [bx],ax
			      C ;	; 1 -> allocated
			      C ;	mov ax,word ptr [im_sector]
			      C ;	or ax,ax
			      C ;	jz short alloci_10
			      C ;	push cx
			      C ;	mov cl,12 
			      C ;	shl ax,cl  ; 4096 inodes per inode map sector
			      C ;		   ; (8 inodes per byte)	
			      C ;	pop cx
			      C ;alloci_10:
			      C ;	add ax,cx
			      C ;	; ax = inode number
			      C ;
			      C ;	; 24/10/2019
			      C ;	; set first free inode search value
			      C ;	inc ax
			      C ;	mov word ptr [systm.sb_FirstFreeIno],ax
			      C ;	dec ax
			      C ;
			      C ;	cmp word ptr [systm.sb_FreeInodes],0FFFFh ; invalid	
			      C ;	jnb short alloci_11
			      C ;
			      C ;	dec word ptr [systm.sb_FreeInodes]	 
			      C ;alloci_11:
			      C ;freei_4:
			      C ;	or byte ptr [smod],0F2h ; inode map & sb modified sign
			      C ;freei_0: 
			      C ;	retn
			      C ;
			      C ;alloc_inode endp
			      C 
			      C ;free_inode proc near
			      C ;	; 24/10/2019 - Retro UNIX 386 v2 (UNIXHDFS)
			      C ;	; deallocate inode
			      C ;	;; input ->
			      C ;	; AX = Inode number to be freed/released/deallocated
			      C ;	;; output ->
			      C ;	;	cf = 1 -> error
			      C ;	; Modified registers: ax,dx,cx,bx
			      C ;	
			      C ;	; check valid inode number
			      C ;	cmp ax,1
			      C ;	jb short freei_0
			      C ;	cmp word ptr [systm.sb_InodeCount],ax
			      C ;	jb short freei_0
			      C ;
			      C ;	; calculate inode map sector for this inode
			      C ;
			      C ;	dec ax  ; zero based inode number
			      C ;
			      C ;	mov word ptr [save_dx],ax
			      C ;
			      C ;	mov cl,12 
			      C ;	shr ax,cl  ; 4096 inodes per inode map sector
			      C ;		   ; (8 inodes per byte)	
			      C ;
			      C ;	cmp ax,word ptr [im_sector] ; zero based im sector index
			      C ;	je short freei_2
			      C ;	test byte ptr [smod],2 ; inode map modified flag
			      C ;	jz short freei_1
			      C ;
			      C ;	mov word ptr [save_ax],ax
			      C ;
			      C ;	call sync ; writes current inode map sector/block
			      C ;		  ; and updates super block
			      C ;	jc short freei_0
			      C ;
			      C ;	mov ax,word ptr [save_ax]
			      C ;freei_1:
			      C ;	xor dx,dx
			      C ;	add ax,word ptr [systm.sb_InodeMapAddr]	 
			      C ;	adc dx,word ptr [systm.sb_InodeMapAddr+2]
			      C ;	mov bx,offset im_buffer
			      C ;	call dskrd
			      C ;	jc short freei_0
			      C ; 	
			      C ;	mov ax,word ptr [save_ax]
			      C ;	mov word ptr [im_sector],ax	
			      C ;freei_2:	
			      C ;	mov bx,offset im_buffer
			      C ;	; get offset of the inode in the inode map buffer
			      C ;	mov dx,word ptr [save_dx]
			      C ;	mov cx,dx
			      C ;	and dx,4095
			      C ;	shr dx,1
			      C ;	shr dx,1
			      C ;	shr dx,1
			      C ;	shr dx,1 ; offset in words
			      C ;	shl dx,1 ; offset in bytes (word boundary)
			      C ;	mov ax,1
			      C ;	and cx,0Fh
			      C ;	shl ax,cl
			      C ;	not ax ; only selected bit position is 0, others are 1
			      C ;	add bx,dx
			      C ;	and word ptr [bx],ax ; reset bit position of the inode 
			      C ;	
			      C ;	mov ax,word ptr [save_dx]
			      C ;	inc ax ; 1 based inode number
			      C ;	
			      C ;	cmp word ptr [systm.sb_FirstFreeIno],ax
			      C ;	jna short freei_3
			      C ;
			      C ;	mov word ptr [systm.sb_FirstFreeIno],ax
			      C ;freei_3:
			      C ;	cmp word ptr [systm.sb_FreeInodes],0FFFFh ; invalid	
			      C ;	jnb freei_4
			      C ;
			      C ;	inc word ptr [systm.sb_FreeInodes]
			      C ;
			      C ;	jmp freei_4	 
			      C ;;freei_4:
			      C ;;	or byte ptr [smod],0F2h ; inode map & sb modified sign 
			      C ;;	retn
			      C ;
			      C ;free_inode endp  
			      C 
 24CC			      C clear	proc near
			      C 	; 13/11/2019 - Retro UNIX 386 v2
			      C 	; (Data) Buffer clearing
			      C 	
 24CC  57		      C 	push di
 24CD  51		      C 	push cx
 24CE  50		      C 	push ax
			      C 
 24CF  33 C0		      C  	xor ax,ax
			      C 
 24D1  BF 1910 R	      C 	mov di,offset Buffer
 24D4  B9 0100		      C 	mov cx,256 
 24D7  F3/ AB		      C 	rep stosw
			      C 
 24D9  58		      C 	pop ax
 24DA  59		      C 	pop cx
 24DB  5F		      C 	pop di	
			      C 	
 24DC  C3		      C 	retn
			      C 
 24DD			      C clear	endp
			      C 
 24DD			      C sioreg proc near
			      C 	; 30/12/2019
			      C 	; 09/11/2019 - Retro UNIX 386 v2 (for hard disk fs)
			      C 	; 04/09/2019 - RETRO UNIX v0.3 (Retro UNIX 386 v2)
			      C 	; 16/12/2012
			      C 	; 31/10/2012
			      C 	; 19/08/2012
			      C 	; 04/08/2012
			      C 	; Erdogan Tan - RETRO UNIX v0.1
			      C 	; input -> R5 (DX) = sector buffer (data) address
			      C 	;	   *u.fofp = file offset, to start writing
			      C 	;	   u.base = address of 1st byte of user data
			      C 	;	   u.count = byte count to be transferred
			      C 	;	   u.nread = number of bytes written out
			      C 	;		     previously.
			      C 	; output -> *u.fofp = last (written) byte + 1
			      C 	;	   u.count = number of bytes of data left
			      C 	;		     to be transferred.			
			      C 	;	   u.nread = updated to include the count
			      C 	;		    of bytes to be transferred.
			      C 	;	   R1 (SI) = address of 1st byte of data
			      C 	;	   R2 (DI) = specifies the byte in IO 
			      C 	;	            sector (I/O) buffer. (Offset)	
			      C 	;	   R3 (CX) = number of bytes of data to be
			      C 	;		    transferred to/from sector (I/O)
			      C 	;		    buffer.		
			      C 
			      C 	;mov dx,offset Buffer	; R5
			      C 	; 31/10/2012	
 24DD  8B 36 0EA8 R	      C         mov si,word ptr [u_fofp] ; mov	*u.fofp,r2 
 24E1  8B 3C		      C 	mov di,word ptr [si]	; file offset (in bytes) is moved to r2
 24E3  8B CF		      C 	mov cx,di		; mov	r2,r3 / and also to r3
			      C 
 24E5  81 C9 FE00	      C 	or cx,0FE00h ; set bits 9...15 of file offset in R3
 24E9  81 E7 01FF	      C 	and di,1FFh ; calculate file offset mod 512
			      C 
			      C 	; 09/11/2019
			      C 	; 19/08/2012
 24ED  81 C7 1910 R	      C 	add di,offset Buffer ; DI/r2 now points to 1st byte in buffer
			      C 			     ; where data is to be placed
			      C         
			      C 	;mov si,word ptr [u_base] ; address of data is in r1
 24F1  F7 D9		      C 	neg cx ; 512 - file offset(mod512) in R3 (cx)
			      C 			; the number of free bytes in the file block
 24F3  3B 0E 0EA4 R	      C         cmp cx,word ptr [u_count] ; compare this with the number of data bytes
			      C 				  ; to be written to the file
 24F7  76 04		      C 	jna short @f ; 2f
			      C 			   ; if less than branch. Use the number of free bytes
			      C 		           ; in the file block as the number to be written
 24F9  8B 0E 0EA4 R	      C         mov cx,word ptr [u_count]
			      C 			   ; if greater than, use the number of data bytes
			      C 		           ; as the number to be written
 24FD			      C @@:	; 2
			      C ;sioreg_1:		
 24FD  01 0E 0EAA R	      C 	add word ptr [u_nread],cx ; r3 + number of bytes
			      C 			; xmitted during write is put into
			      C                         ; u.nread
 2501  29 0E 0EA4 R	      C         sub word ptr [u_count],cx
			      C 			; u.count = no. of bytes that still must be
			      C 		        ; written or read
			      C 	; 30/12/2019
			      C 	;mov si,word ptr [u_fofp]
 2505  01 0C		      C         add word ptr [si],cx ; new file offset = number 
			      C 			; of bytes done + old file offset
			      C 	; 09/11/2019
 2507  83 54 02 00	      C 	adc word ptr [si+2],0
			      C 	; Note: word ptr [u_base] + cx must not over 65535	
			      C 
			      C 	; 16/12/2012 BugFix
 250B  8B 36 0EA6 R	      C 	mov si,word ptr [u_base] ; address of data is in SI/r1
			      C 
 250F  01 0E 0EA6 R	      C         add word ptr [u_base],cx ; u.base points to 1st of remaining
			      C 			; data bytes
 2513  C3		      C 	retn
			      C 
 2514			      C sioreg	endp
			      C 
 2514			      C epoch proc near
			      C 	; 07/11/2019 - Retro UNIX 386 v2 (mul32, bx->cx)
			      C 	; 21/07/2012
			      C 	; 15/07/2012
			      C 	; 14/07/2012		
			      C 	; Erdogan Tan - RETRO UNIX v0.1
			      C 	; compute current date and time as UNIX Epoch/Time
			      C 	; UNIX Epoch: seconds since 1/1/1970 00:00:00
			      C 
			      C 	; 21/7/2012
 2514  53		      C 	push bx
 2515  51		      C 	push cx
			      C 
 2516  B4 02		      C 	mov ah,02h                      ; Return Current Time
 2518  CD 1A		      C         int 1Ah
 251A  86 E9		      C         xchg ch,cl
 251C  89 0E 260A R	      C         mov word ptr [hour],cx
 2520  86 F2		      C         xchg dh,dl
 2522  89 16 260E R	      C         mov word ptr [second],dx
			      C 
 2526  B4 04		      C         mov ah,04h                      ; Return Current Date
 2528  CD 1A		      C         int 1Ah
 252A  86 E9		      C         xchg ch,cl
 252C  89 0E 2604 R	      C         mov word ptr [year],cx
 2530  86 F2		      C         xchg dh,dl
 2532  89 16 2606 R	      C         mov word ptr [month],dx
			      C 
 2536  B9 3030		      C 	mov cx,3030h
			      C 
 2539  A0 260A R	      C 	mov al,byte ptr [hour] ; Hour
			      C            ; AL <= BCD number)
 253C  D4 10		      C         db 0D4h,10h                     ; Undocumented inst. AAM
			      C 					; AH = AL / 10h
			      C 					; AL = AL MOD 10h
 253E  D5 0A		      C         aad ; AX= AH*10+AL
			      C 		
 2540  A2 260A R	      C 	mov byte ptr [hour],al
			      C 
 2543  A0 260B R	      C 	mov al,byte ptr [hour]+1 ; Minute
			      C            ; AL <= BCD number)
 2546  D4 10		      C         db 0D4h,10h                     ; Undocumented inst. AAM
			      C 					; AH = AL / 10h
			      C 					; AL = AL MOD 10h
 2548  D5 0A		      C         aad ; AX= AH*10+AL
			      C 		
 254A  A2 260C R	      C 	mov byte ptr [minute],al
			      C 
 254D  A0 260E R	      C 	mov al,byte ptr [second] ; Second
			      C            ; AL <= BCD number)
 2550  D4 10		      C         db 0D4h,10h                     ; Undocumented inst. AAM
			      C 					; AH = AL / 10h
			      C 					; AL = AL MOD 10h
 2552  D5 0A		      C         aad ; AX= AH*10+AL
			      C 		
 2554  A2 260E R	      C 	mov byte ptr [second],al
			      C 
			      C 	
 2557  A1 2604 R	      C 	mov ax,word ptr [year] ; Year (century)
 255A  50		      C         push ax
			      C 	   ; AL <= BCD number)
 255B  D4 10		      C         db 0D4h,10h                     ; Undocumented inst. AAM
			      C 					; AH = AL / 10h
			      C 					; AL = AL MOD 10h
 255D  D5 0A		      C         aad ; AX= AH*10+AL
			      C 		
 255F  B4 64		      C 	mov ah,100
 2561  F6 E4		      C 	mul ah
 2563  A3 2604 R	      C 	mov word ptr [year],ax
			      C 
 2566  58		      C 	pop ax
 2567  8A C4		      C 	mov al,ah
			      C            ; AL <= BCD number)
 2569  D4 10		      C         db 0D4h,10h                     ; Undocumented inst. AAM
			      C 					; AH = AL / 10h
			      C 					; AL = AL MOD 10h
 256B  D5 0A		      C         aad ; AX= AH*10+AL
			      C 		
 256D  01 06 2604 R	      C 	add word ptr [year],ax
			      C 
			      C 
 2571  A0 2606 R	      C 	mov al,byte ptr [month] ; Month
			      C            ; AL <= BCD number)
 2574  D4 10		      C         db 0D4h,10h                     ; Undocumented inst. AAM
			      C 					; AH = AL / 10h
			      C 					; AL = AL MOD 10h
 2576  D5 0A		      C         aad ; AX= AH*10+AL
			      C 	
 2578  A2 2606 R	      C 	mov byte ptr [month],al	
			      C 
			      C 
 257B  A0 2607 R	      C 	mov al,byte ptr [month]+1 ; Day
			      C            ; AL <= BCD number)
 257E  D4 10		      C         db 0D4h,10h                     ; Undocumented inst. AAM
			      C 					; AH = AL / 10h
			      C 					; AL = AL MOD 10h
 2580  D5 0A		      C         aad ; AX= AH*10+AL
			      C 
 2582  A2 2608 R	      C 	mov byte ptr [Day],al
			      C 	
 2585			      C convert_to_epoch:
			      C 
 2585  8B 16 2604 R	      C 	mov dx,word ptr [year]
 2589  81 EA 07B2	      C 	sub dx,1970
 258D  B8 016D		      C 	mov ax,365
 2590  F7 E2		      C 	mul dx
 2592  32 FF		      C 	xor bh,bh
 2594  8A 1E 2606 R	      C 	mov bl,byte ptr [month]
 2598  FE CB		      C 	dec bl
 259A  D0 E3		      C 	shl bl,1
 259C  8B 8F 2610 R	      C 	mov cx,word ptr DMonth[BX]
 25A0  8A 1E 2608 R	      C 	mov bl,byte ptr [Day]
 25A4  FE CB		      C 	dec bl
			      C 	
 25A6  03 C1		      C 	add ax,cx
 25A8  83 D2 00		      C 	adc dx,0
 25AB  03 C3		      C 	add ax,bx
 25AD  83 D2 00		      C 	adc dx,0
			      C 				; DX:AX = days since 1/1/1970
 25B0  8B 0E 2604 R	      C 	mov cx,word ptr [year]
 25B4  81 E9 07B1	      C 	sub cx,1969
 25B8  D1 E9		      C 	shr cx,1
 25BA  D1 E9		      C 	shr cx,1		
			      C 		; (year-1969)/4
 25BC  03 C1		      C 	add ax,cx
 25BE  83 D2 00		      C 	adc dx,0
			      C 				; + leap days since 1/1/1970
			      C 
 25C1  80 3E 2606 R 02	      C 	cmp byte ptr [month],2  ; if past february
 25C6  76 0F		      C 	jna short @f
 25C8  8B 0E 2604 R	      C 	mov cx,word ptr [year]
 25CC  83 E1 03		      C 	and cx,3 ; year mod 4
 25CF  75 06		      C 	jnz short @f		
			      C 				; and if leap year
 25D1  83 C0 01		      C 	add ax,1 ; add this year's leap day (february 29)
 25D4  83 D2 00		      C 	adc dx,0
 25D7			      C @@: 			; compute seconds since 1/1/1970
			      C 	;mov bx,24
			      C 	;call proc_mul32
			      C 	; 07/11/2019
 25D7  B9 0018		      C 	mov cx,24
 25DA  E8 DF26		      C 	call mul32
			      C 		
 25DD  8A 1E 260A R	      C 	mov bl,byte ptr [hour]
 25E1  03 C3		      C 	add ax,bx
 25E3  83 D2 00		      C 	adc dx,0
			      C 	
			      C 	;mov bx,60
			      C 	;call proc_mul32
			      C 	; 07/11/2019
 25E6  B9 003C		      C 	mov cx,60
 25E9  E8 DF17		      C 	call mul32
			      C 
 25EC  8A 1E 260C R	      C 	mov bl,byte ptr [minute]
 25F0  03 C3		      C 	add ax,bx
 25F2  83 D2 00		      C 	adc dx,0
			      C 	
			      C 	;mov bx,60
			      C 	;call proc_mul32
			      C 	; 07/11/2019
			      C 	;mov cx,60
 25F5  E8 DF0B		      C 	call mul32
			      C 
 25F8  8A 1E 260E R	      C 	mov bl,byte ptr [second]
 25FC  03 C3		      C 	add ax,bx
 25FE  83 D2 00		      C  	adc dx,0
			      C 
			      C 	; DX:AX -> seconds since 1/1/1970 00:00:00
			      C 
			      C 	; 21/7/2012
 2601  59		      C 	pop cx
 2602  5B		      C 	pop bx
			      C 	
 2603  C3		      C 	retn
			      C 
 2604			      C epoch endp
			      C 
 2604 07B2		      C year:   dw 1970
 2606 0001		      C month:  dw 1
 2608 0001		      C day:    dw 1
 260A 0000		      C hour:   dw 0
 260C 0000		      C minute: dw 0
 260E 0000		      C second: dw 0
			      C 
 2610			      C DMonth:
 2610  0000		      C dw 0
 2612  001F		      C dw 31
 2614  003B		      C dw 59
 2616  005A		      C dw 90
 2618  0078		      C dw 120
 261A  0097		      C dw 151
 261C  00B5		      C dw 181
 261E  00D4		      C dw 212
 2620  00F3		      C dw 243
 2622  0111		      C dw 273
 2624  0130		      C dw 304
 2626  014E		      C dw 334
			      C ;dw 365
			      C 
			      C ; 08/12/2019
 2628 00		      C bitpos: db 0
			      C 
 2629 00		      C Error: db 0 ; Hardware error
 262A  00		      C        db 0 ; Software error	  
			      C 
 262B 00		      C smod: db 0
 262C 00		      C imod: db 0
			      C 
 262D 0000		      C ii: dw 0
			      C 
			      C ; 07/11/2019
			      C ;drive: db 0 ; 03/12/2019
 262F 00		      C rw: db 0
			      C 
			      C ; 19/12/2019
			      C ;dotodot:
			      C ;dw 3030h
			      C ;db "h"
			      C ;db 0Dh,0Ah,0
			      C 
			      C ; 04/12/2019
			      C align 4
 2630 00000000		      C level: dd 0  ; level, level+1, level+2, level+3 
			      C 
			      C ; 30/11/2019
 2634 00		      C I_rw: db 0     ; inode table read (0) or write (1)	
 2635 00		      C I_valid: db 0  ; inode table buffer is valid (1) or not (0)
 2636 0000		      C I_sector: dw 0 ; inode table sector index/offset
 2638  0200 [		      C I_buffer: db 512 dup(0) ; inode table sector buffer
        00
       ]
			      C 
				;;;;;   

				;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
				;  messages
				;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

 2838				UNIX_Welcome:
 2838  0D 0A					db 0Dh,0Ah
 283A  52 45 54 52 4F 20			db 'RETRO UNIX 386 v2 Hard Disk FS (RUFS) Format Utility'
       55 4E 49 58 20 33
       38 36 20 76 32 20
       48 61 72 64 20 44
       69 73 6B 20 46 53
       20 28 52 55 46 53
       29 20 46 6F 72 6D
       61 74 20 55 74 69
       6C 69 74 79
 286E  0D 0A					db 0Dh, 0Ah
 2870  62 79 20 45 72 64			db 'by Erdogan TAN [20/07/2022]'
       6F 67 61 6E 20 54
       41 4E 20 5B 32 30
       2F 30 37 2F 32 30
       32 32 5D
 288B  0D 0A					db 0Dh,0Ah
 288D  0D 0A					db 0Dh,0Ah
 288F  55 73 61 67 65 3A			db 'Usage: unixhdfs [Drive] ', 0Dh,0Ah
       20 75 6E 69 78 68
       64 66 73 20 5B 44
       72 69 76 65 5D 20
       0D 0A
 28A9  20 20 20 20 20 20			db '       unixhdfs -i [hard disk image file name] '
       20 75 6E 69 78 68
       64 66 73 20 2D 69
       20 5B 68 61 72 64
       20 64 69 73 6B 20
       69 6D 61 67 65 20
       66 69 6C 65 20 6E
       61 6D 65 5D 20
 28D8  0D 0A					db 0Dh,0Ah
 28DA  0D 0A					db 0Dh,0Ah
 28DC  44 72 69 76 65 20			db "Drive names:"
       6E 61 6D 65 73 3A
 28E8  0D 0A					db 0Dh,0Ah
 28EA  0D 0A					db 0Dh,0Ah
 28EC  68 64 30 20 20 20			db "hd0    (Hard Disk 1)", 0Dh,0Ah
       20 28 48 61 72 64
       20 44 69 73 6B 20
       31 29 0D 0A
 2902  68 64 31 20 20 20			db "hd1    (Hard Disk 2)", 0Dh,0Ah
       20 28 48 61 72 64
       20 44 69 73 6B 20
       32 29 0D 0A
 2918  2E 2E 2E 0D 0A				db "...", 0Dh,0Ah
 291D  43 3A 20 20 20 20			db "C:     (Hard Disk 1)", 0Dh,0Ah
       20 28 48 61 72 64
       20 44 69 73 6B 20
       31 29 0D 0A
 2933  44 3A 20 20 20 20			db "D:     (Hard Disk 2)", 0Dh,0Ah
       20 28 48 61 72 64
       20 44 69 73 6B 20
       32 29 0D 0A
 2949  0D 0A					db 0Dh,0Ah
 294B  0D 0A					db 0Dh,0Ah
 294D  45 78 61 6D 70 6C			db 'Example 1: unixhdfs C: ', 0Dh,0Ah
       65 20 31 3A 20 75
       6E 69 78 68 64 66
       73 20 43 3A 20 0D
       0A
 2966  45 78 61 6D 70 6C			db 'Example 2: unixhdfs -i hd0.img '
       65 20 32 3A 20 75
       6E 69 78 68 64 66
       73 20 2D 69 20 68
       64 30 2E 69 6D 67
       20
 2985  0D 0A					db 0Dh,0Ah
 2987  00					db 0

 2988				Msg_DoYouWantToFormat:
 2988  07					db 07h
 2989  0D 0A					db 0Dh, 0Ah
 298B  57 41 52 4E 49 4E			db 'WARNING!'
       47 21
 2993  0D 0A					db 0Dh, 0Ah
						; 04/12/2019
 2995  41 6C 6C 20 64 61			db 'All data on the RUNIX partition will be erased.'
       74 61 20 6F 6E 20
       74 68 65 20 52 55
       4E 49 58 20 70 61
       72 74 69 74 69 6F
       6E 20 77 69 6C 6C
       20 62 65 20 65 72
       61 73 65 64 2E
 29C4  0D 0A					db 0Dh, 0Ah
 29C6  0D 0A					db 0Dh, 0Ah
 29C8  44 6F 20 79 6F 75			db 'Do you want to format Retro UNIX Partition on Drive '
       20 77 61 6E 74 20
       74 6F 20 66 6F 72
       6D 61 74 20 52 65
       74 72 6F 20 55 4E
       49 58 20 50 61 72
       74 69 74 69 6F 6E
       20 6F 6E 20 44 72
       69 76 65 20
 29FC				RUFS_DRIVE:
 29FC  43 3A 20 28 59 65			db 'C: (Yes/No)? ', 0
       73 2F 4E 6F 29 3F
       20 00

 2A0A				Msg_Installing_File_System:
 2A0A  0D 0A					db 0Dh, 0Ah
 2A0C  49 6E 73 74 61 6C			db "Installing Retro UNIX v2 File Sytem...", 0
       6C 69 6E 67 20 52
       65 74 72 6F 20 55
       4E 49 58 20 76 32
       20 46 69 6C 65 20
       53 79 74 65 6D 2E
       2E 2E 00

 2A33				Msg_Writing_Boot_Sector:
 2A33  0D 0A					db 0Dh, 0Ah
						;db "Writing UNIX boot sector...", 0
						; 05/04/2022
 2A35  57 72 69 74 69 6E			db "Writing Retro UNIX v2 boot sector...", 0
       67 20 52 65 74 72
       6F 20 55 4E 49 58
       20 76 32 20 62 6F
       6F 74 20 73 65 63
       74 6F 72 2E 2E 2E
       00

 2A5A 0000			Cursor_Pos:     dw 0

 2A5C				Msg_Volume_Name:
 2A5C  0D 0A					db 0Dh, 0Ah
 2A5E  56 6F 6C 75 6D 65			db "Volume Name: ", 0
       20 4E 61 6D 65 3A
       20 00
 2A6C				Msg_OK:
 2A6C  20 4F 4B 2E 00				db ' OK.', 0

 2A71 20 59 45 53		msg_YES:        db ' YES'
 2A75  00					db 0
 2A76 20 4E 4F			msg_NO:         db ' NO'
 2A79  00					db 0   

				; 12/8/2012
 2A7A				msg_disk_rw_error:
 2A7A  0D 0A					db 0Dh, 0Ah
 2A7C  44 69 73 6B 20 72			db 'Disk r/w error!'
       2F 77 20 65 72 72
       6F 72 21
 2A8B  00					db 0

				; 09/09/2019
 2A8C				msg_drive_not_ready:
 2A8C  0D 0A					db 0Dh, 0Ah
 2A8E  44 72 69 76 65 20			db 'Drive not ready!'
       6E 6F 74 20 72 65
       61 64 79 21
 2A9E  00					db 0

 2A9F				msg_error_Number:
 2A9F  0D 0A					db 0Dh, 0Ah
 2AA1  45 72 72 6F 72 20			db 'Error No: '
       4E 6F 3A 20
 2AAB 3030			str_err:        dw 3030h
 2AAD  68					db 'h'
 2AAE				UNIX_CRLF:
 2AAE  0D 0A 00					db 0Dh, 0Ah, 0

				;Error_Code:	db 0

 2AB1 04			RetryCount:     db 4 ; 09/09/2019

 2AB2				str_volume_name:
 2AB2  000F [					db 15 dup (0)
        00
       ]

				even

				; 03/10/2019 - Retro UNIX 386 v2 - Hard Disk FS

 2AC2 0000			heads:		dw 0
 2AC4 0000			sectors:	dw 0 ; spt
 2AC6 0000			cylinders:	dw 0
 2AC8 00000000			hidden_sectors:	dd 0
 2ACC 00000000			total_sectors:	dd 0
 2AD0 00000000			file_size:	dd 0
 2AD4 00000000			pp_sectors:	dd 0
 2AD8 0000			min_sectors:	dw 0
 2ADA 00			lba_rw:		db 0

 2ADB  54 75 72 6B 69 73			db  'Turkish Rational UNIX', 0
       68 20 52 61 74 69
       6F 6E 61 6C 20 55
       4E 49 58 00
 2AF1  52 45 54 52 4F 20			db  'RETRO UNIX 386 v2.0 HDFS by Erdogan TAN', 0
       55 4E 49 58 20 33
       38 36 20 76 32 2E
       30 20 48 44 46 53
       20 62 79 20 45 72
       64 6F 67 61 6E 20
       54 41 4E 00
 2B19  31 31 2F 30 37 2F			db  '11/07/2012', 0, '20/07/2022', 0 
       32 30 31 32 00 32
       30 2F 30 37 2F 32
       30 32 32 00
				even

				; 01/12/2019
 2B30 00000000			CHS_limit:	dd 0
				; 29/12/2019
 2B34 00000000			VolumeSerial:	dd 0

				; 23/12/2019
 2B38				boot_sector:
				; 09/01/2020
				; 07/01/2020
				; 19/12/2019
				; 03/10/2019
				; Retro UNIX 386 v2 Hard Disk Boot Sector Image
				include         rubs3chs.txt ; rubs3chs.bin (bin2db) file ; 09/01/2020
			      C ; C:\runix2\rubs3chs.bin (file size is 512 bytes)
			      C ; Retro UNIX 386 v2 boot sector (71h hd partitions, CHS read)
			      C ; 09/01/2020 (Erdogan Tan)
			      C 
 2B38  EB 18 52 55 46 53      C db 0EBh, 018h, 052h, 055h, 046h, 053h, 000h, 000h, 000h, 000h, 068h, 064h, 080h, 000h, 03Fh, 0FFh
       00 00 00 00 68 64
       80 00 3F FF
 2B48  FF 03 00 00 40 71      C db 0FFh, 003h, 000h, 000h, 040h, 071h, 000h, 000h, 000h, 000h, 08Ch, 0C8h, 08Eh, 0D8h, 08Eh, 0C0h
       00 00 00 00 8C C8
       8E D8 8E C0
 2B58  FA 8E D0 BC FE FF      C db 0FAh, 08Eh, 0D0h, 0BCh, 0FEh, 0FFh, 0FBh, 039h, 006h, 012h, 07Ch, 077h, 00Ch, 0BEh, 0E0h, 07Dh
       FB 39 06 12 7C 77
       0C BE E0 7D
 2B68  E8 8A 01 33 C0 CD      C db 0E8h, 08Ah, 001h, 033h, 0C0h, 0CDh, 016h, 0CDh, 019h, 088h, 016h, 00Ch, 07Ch, 040h, 033h, 0D2h
       16 CD 19 88 16 0C
       7C 40 33 D2
 2B78  BB 00 7E E8 20 01      C db 0BBh, 000h, 07Eh, 0E8h, 020h, 001h, 072h, 04Ch, 0A1h, 012h, 07Ch, 0D1h, 0E8h, 0D1h, 0E8h, 0D1h
       72 4C A1 12 7C D1
       E8 D1 E8 D1
 2B88  E8 33 D2 03 47 28      C db 0E8h, 033h, 0D2h, 003h, 047h, 028h, 013h, 057h, 02Ah, 0BBh, 000h, 009h, 0E8h, 007h, 001h, 072h
       13 57 2A BB 00 09
       E8 07 01 72
 2B98  73 A0 12 7C FE C8      C db 073h, 0A0h, 012h, 07Ch, 0FEh, 0C8h, 083h, 0E0h, 007h, 0B9h, 040h, 000h, 0F6h, 0E1h, 08Bh, 0F3h
       83 E0 07 B9 40 00
       F6 E1 8B F3
 2BA8  03 F0 BF 00 06 F3      C db 003h, 0F0h, 0BFh, 000h, 006h, 0F3h, 0A4h, 0BBh, 000h, 006h, 08Bh, 007h, 025h, 040h, 0E0h, 03Dh
       A4 BB 00 06 8B 07
       25 40 E0 3D
 2BB8  40 80 75 50 BB 08      C db 040h, 080h, 075h, 050h, 0BBh, 008h, 006h, 08Bh, 007h, 08Bh, 057h, 002h, 023h, 0C0h, 074h, 044h
       06 8B 07 8B 57 02
       23 C0 74 44
 2BC8  0B D2 74 02 EB 3E      C db 00Bh, 0D2h, 074h, 002h, 0EBh, 03Eh, 02Bh, 006h, 0CEh, 07Dh, 077h, 003h, 0E9h, 0AFh, 000h, 03Bh
       2B 06 CE 7D 77 03
       E9 AF 00 3B
 2BD8  06 F8 7D 73 03 A3      C db 006h, 0F8h, 07Dh, 073h, 003h, 0A3h, 0F8h, 07Dh, 08Ah, 01Eh, 0CFh, 07Dh, 032h, 0FFh, 0BEh, 001h
       F8 7D 8A 1E CF 7D
       32 FF BE 01
 2BE8  06 F6 04 10 75 27      C db 006h, 0F6h, 004h, 010h, 075h, 027h, 080h, 0FBh, 014h, 073h, 022h, 080h, 0E3h, 01Eh, 0D0h, 0E3h
       80 FB 14 73 22 80
       E3 1E D0 E3
 2BF8  81 C3 0C 06 EB 3D      C db 081h, 0C3h, 00Ch, 006h, 0EBh, 03Dh, 08Bh, 007h, 08Bh, 057h, 002h, 023h, 0C0h, 075h, 00Dh, 00Bh
       8B 07 8B 57 02 23
       C0 75 0D 0B
 2C08  D2 75 09 58 BE D0      C db 0D2h, 075h, 009h, 058h, 0BEh, 0D0h, 07Dh, 0E8h, 0E3h, 000h, 0EBh, 0FEh, 0C3h, 080h, 0E3h, 0FEh
       7D E8 E3 00 EB FE
       C3 80 E3 FE
 2C18  D1 E3 8B FB 81 C7      C db 0D1h, 0E3h, 08Bh, 0FBh, 081h, 0C7h, 000h, 009h, 080h, 03Eh, 0CBh, 07Dh, 000h, 077h, 012h, 0BBh
       00 09 80 3E CB 7D
       00 77 12 BB
 2C28  0C 06 E8 D1 FF BB      C db 00Ch, 006h, 0E8h, 0D1h, 0FFh, 0BBh, 000h, 009h, 0E8h, 06Bh, 000h, 072h, 0D7h, 0FEh, 006h, 0CBh
       00 09 E8 6B 00 72
       D7 FE 06 CB
 2C38  7D 8B DF E8 C0 FF      C db 07Dh, 08Bh, 0DFh, 0E8h, 0C0h, 0FFh, 0BBh, 000h, 007h, 0E8h, 05Ah, 000h, 072h, 086h, 08Bh, 036h
       BB 00 07 E8 5A 00
       72 86 8B 36
 2C48  CE 7D 8B CE 81 C9      C db 0CEh, 07Dh, 08Bh, 0CEh, 081h, 0C9h, 000h, 0FEh, 081h, 0E6h, 0FFh, 001h, 003h, 0F3h, 08Bh, 03Eh
       00 FE 81 E6 FF 01
       03 F3 8B 3E
 2C58  CC 7D F7 D9 3B 0E      C db 0CCh, 07Dh, 0F7h, 0D9h, 03Bh, 00Eh, 0F8h, 07Dh, 076h, 004h, 08Bh, 00Eh, 0F8h, 07Dh, 001h, 00Eh
       F8 7D 76 04 8B 0E
       F8 7D 01 0E
 2C68  FA 7D 29 0E F8 7D      C db 0FAh, 07Dh, 029h, 00Eh, 0F8h, 07Dh, 001h, 00Eh, 0CCh, 07Dh, 001h, 00Eh, 0CEh, 07Dh, 0F3h, 0A4h
       01 0E CC 7D 01 0E
       CE 7D F3 A4
 2C78  39 0E F8 7D 76 08      C db 039h, 00Eh, 0F8h, 07Dh, 076h, 008h, 0BBh, 008h, 006h, 08Bh, 007h, 0E9h, 048h, 0FFh, 0BEh, 0DCh
       BB 08 06 8B 07 E9
       48 FF BE DC
 2C88  7D E8 69 00 8A 16      C db 07Dh, 0E8h, 069h, 000h, 08Ah, 016h, 00Ch, 07Ch, 0B8h, 000h, 008h, 08Eh, 0D8h, 08Eh, 0C0h, 0FAh
       0C 7C B8 00 08 8E
       D8 8E C0 FA
 2C98  8E D0 FB 06 51 CB      C db 08Eh, 0D0h, 0FBh, 006h, 051h, 0CBh, 0BEh, 004h, 000h, 003h, 006h, 016h, 07Ch, 013h, 016h, 018h
       BE 04 00 03 06 16
       7C 13 16 18
 2CA8  7C 52 50 53 8A 0E      C db 07Ch, 052h, 050h, 053h, 08Ah, 00Eh, 00Eh, 07Ch, 032h, 0EDh, 0E8h, 032h, 000h, 08Ah, 0CBh, 0FEh
       0E 7C 32 ED E8 32
       00 8A CB FE
 2CB8  C1 51 8A 0E 0F 7C      C db 0C1h, 051h, 08Ah, 00Eh, 00Fh, 07Ch, 0E8h, 026h, 000h, 08Ah, 0F3h, 059h, 05Bh, 08Ah, 016h, 00Ch
       E8 26 00 8A F3 59
       5B 8A 16 0C
 2CC8  7C 8A E8 D0 CC D0      C db 07Ch, 08Ah, 0E8h, 0D0h, 0CCh, 0D0h, 0CCh, 00Ah, 0CCh, 0B4h, 002h, 0B0h, 001h, 0CDh, 013h, 073h
       CC 0A CC B4 02 B0
       01 CD 13 73
 2CD8  0B 4E 74 08 32 E4      C db 00Bh, 04Eh, 074h, 008h, 032h, 0E4h, 0CDh, 013h, 058h, 05Ah, 0EBh, 0C5h, 058h, 05Ah, 0C3h, 08Bh
       CD 13 58 5A EB C5
       58 5A C3 8B
 2CE8  D8 8B C2 33 D2 F7      C db 0D8h, 08Bh, 0C2h, 033h, 0D2h, 0F7h, 0F1h, 093h, 0F7h, 0F1h, 087h, 0D3h, 0C3h, 0BBh, 007h, 000h
       F1 93 F7 F1 87 D3
       C3 BB 07 00
 2CF8  B4 0E AC 22 C0 74      C db 0B4h, 00Eh, 0ACh, 022h, 0C0h, 074h, 0F5h, 0CDh, 010h, 0EBh, 0F7h, 000h, 000h, 080h, 000h, 000h
       F5 CD 10 EB F7 00
       00 80 00 00
 2D08  07 42 6F 6F 74 20      C db 007h, 042h, 06Fh, 06Fh, 074h, 020h, 065h, 072h, 072h, 06Fh, 072h, 021h, 00Dh, 00Ah, 000h, 000h
       65 72 72 6F 72 21
       0D 0A 00 00
 2D18  07 4E 6F 74 20 61      C db 007h, 04Eh, 06Fh, 074h, 020h, 061h, 020h, 062h, 06Fh, 06Fh, 074h, 061h, 062h, 06Ch, 065h, 020h
       20 62 6F 6F 74 61
       62 6C 65 20
 2D28  64 69 73 6B 21 0D      C db 064h, 069h, 073h, 06Bh, 021h, 00Dh, 00Ah, 000h, 0C0h, 07Fh, 000h, 000h, 0E4h, 007h, 055h, 0AAh
       0A 00 C0 7F 00 00
       E4 07 55 AA
			      C 
 2D38				lba_boot_sector:
				include         rubs3lba.txt ; rubs3lba.bin (bin2db) file ; 09/01/2020
			      C ; C:\runix2\rubs3lba.bin (file size is 512 bytes)
			      C ; Retro UNIX 386 v2 boot sector (71h hd partitions, LBA read)
			      C ; 09/01/2020 (Erdogan Tan)
			      C 
 2D38  EB 18 52 55 46 53      C db 0EBh, 018h, 052h, 055h, 046h, 053h, 000h, 000h, 000h, 000h, 068h, 064h, 080h, 001h, 03Fh, 0FFh
       00 00 00 00 68 64
       80 01 3F FF
 2D48  FF 03 00 00 40 71      C db 0FFh, 003h, 000h, 000h, 040h, 071h, 000h, 000h, 000h, 000h, 08Ch, 0C8h, 08Eh, 0D8h, 08Eh, 0C0h
       00 00 00 00 8C C8
       8E D8 8E C0
 2D58  FA 8E D0 BC FE FF      C db 0FAh, 08Eh, 0D0h, 0BCh, 0FEh, 0FFh, 0FBh, 039h, 006h, 012h, 07Ch, 077h, 00Ch, 0BEh, 0DBh, 07Dh
       FB 39 06 12 7C 77
       0C BE DB 7D
 2D68  E8 6B 01 33 C0 CD      C db 0E8h, 06Bh, 001h, 033h, 0C0h, 0CDh, 016h, 0CDh, 019h, 088h, 016h, 00Ch, 07Ch, 040h, 033h, 0D2h
       16 CD 19 88 16 0C
       7C 40 33 D2
 2D78  BB 00 7E E8 20 01      C db 0BBh, 000h, 07Eh, 0E8h, 020h, 001h, 072h, 04Ch, 0A1h, 012h, 07Ch, 0D1h, 0E8h, 0D1h, 0E8h, 0D1h
       72 4C A1 12 7C D1
       E8 D1 E8 D1
 2D88  E8 33 D2 03 47 28      C db 0E8h, 033h, 0D2h, 003h, 047h, 028h, 013h, 057h, 02Ah, 0BBh, 000h, 009h, 0E8h, 007h, 001h, 072h
       13 57 2A BB 00 09
       E8 07 01 72
 2D98  73 A0 12 7C FE C8      C db 073h, 0A0h, 012h, 07Ch, 0FEh, 0C8h, 083h, 0E0h, 007h, 0B9h, 040h, 000h, 0F6h, 0E1h, 08Bh, 0F3h
       83 E0 07 B9 40 00
       F6 E1 8B F3
 2DA8  03 F0 BF 00 06 F3      C db 003h, 0F0h, 0BFh, 000h, 006h, 0F3h, 0A4h, 0BBh, 000h, 006h, 08Bh, 007h, 025h, 040h, 0E0h, 03Dh
       A4 BB 00 06 8B 07
       25 40 E0 3D
 2DB8  40 80 75 50 BB 08      C db 040h, 080h, 075h, 050h, 0BBh, 008h, 006h, 08Bh, 007h, 08Bh, 057h, 002h, 023h, 0C0h, 074h, 044h
       06 8B 07 8B 57 02
       23 C0 74 44
 2DC8  0B D2 74 02 EB 3E      C db 00Bh, 0D2h, 074h, 002h, 0EBh, 03Eh, 02Bh, 006h, 0D8h, 07Dh, 077h, 003h, 0E9h, 0AFh, 000h, 03Bh
       2B 06 D8 7D 77 03
       E9 AF 00 3B
 2DD8  06 D4 7D 73 03 A3      C db 006h, 0D4h, 07Dh, 073h, 003h, 0A3h, 0D4h, 07Dh, 08Ah, 01Eh, 0D9h, 07Dh, 032h, 0FFh, 0BEh, 001h
       D4 7D 8A 1E D9 7D
       32 FF BE 01
 2DE8  06 F6 04 10 75 27      C db 006h, 0F6h, 004h, 010h, 075h, 027h, 080h, 0FBh, 014h, 073h, 022h, 080h, 0E3h, 01Eh, 0D0h, 0E3h
       80 FB 14 73 22 80
       E3 1E D0 E3
 2DF8  81 C3 0C 06 EB 3D      C db 081h, 0C3h, 00Ch, 006h, 0EBh, 03Dh, 08Bh, 007h, 08Bh, 057h, 002h, 023h, 0C0h, 075h, 00Dh, 00Bh
       8B 07 8B 57 02 23
       C0 75 0D 0B
 2E08  D2 75 09 58 BE BF      C db 0D2h, 075h, 009h, 058h, 0BEh, 0BFh, 07Dh, 0E8h, 0C4h, 000h, 0EBh, 0FEh, 0C3h, 080h, 0E3h, 0FEh
       7D E8 C4 00 EB FE
       C3 80 E3 FE
 2E18  D1 E3 8B FB 81 C7      C db 0D1h, 0E3h, 08Bh, 0FBh, 081h, 0C7h, 000h, 009h, 080h, 03Eh, 0DAh, 07Dh, 000h, 077h, 012h, 0BBh
       00 09 80 3E DA 7D
       00 77 12 BB
 2E28  0C 06 E8 D1 FF BB      C db 00Ch, 006h, 0E8h, 0D1h, 0FFh, 0BBh, 000h, 009h, 0E8h, 06Bh, 000h, 072h, 097h, 0FEh, 006h, 0DAh
       00 09 E8 6B 00 72
       97 FE 06 DA
 2E38  7D 8B DF E8 C0 FF      C db 07Dh, 08Bh, 0DFh, 0E8h, 0C0h, 0FFh, 0BBh, 000h, 007h, 0E8h, 05Ah, 000h, 072h, 086h, 08Bh, 036h
       BB 00 07 E8 5A 00
       72 86 8B 36
 2E48  D8 7D 8B CE 81 C9      C db 0D8h, 07Dh, 08Bh, 0CEh, 081h, 0C9h, 000h, 0FEh, 081h, 0E6h, 0FFh, 001h, 003h, 0F3h, 08Bh, 03Eh
       00 FE 81 E6 FF 01
       03 F3 8B 3E
 2E58  D6 7D F7 D9 3B 0E      C db 0D6h, 07Dh, 0F7h, 0D9h, 03Bh, 00Eh, 0D4h, 07Dh, 076h, 004h, 08Bh, 00Eh, 0D4h, 07Dh, 001h, 00Eh
       D4 7D 76 04 8B 0E
       D4 7D 01 0E
 2E68  FA 7D 29 0E D4 7D      C db 0FAh, 07Dh, 029h, 00Eh, 0D4h, 07Dh, 001h, 00Eh, 0D6h, 07Dh, 001h, 00Eh, 0D8h, 07Dh, 0F3h, 0A4h
       01 0E D6 7D 01 0E
       D8 7D F3 A4
 2E78  39 0E D4 7D 76 08      C db 039h, 00Eh, 0D4h, 07Dh, 076h, 008h, 0BBh, 008h, 006h, 08Bh, 007h, 0E9h, 048h, 0FFh, 0BEh, 0D1h
       BB 08 06 8B 07 E9
       48 FF BE D1
 2E88  7D E8 4A 00 8A 16      C db 07Dh, 0E8h, 04Ah, 000h, 08Ah, 016h, 00Ch, 07Ch, 0B8h, 000h, 008h, 08Eh, 0D8h, 08Eh, 0C0h, 0FAh
       0C 7C B8 00 08 8E
       D8 8E C0 FA
 2E98  8E D0 FB 06 51 CB      C db 08Eh, 0D0h, 0FBh, 006h, 051h, 0CBh, 0C6h, 006h, 0F2h, 07Dh, 004h, 003h, 006h, 016h, 07Ch, 013h
       C6 06 F2 7D 04 03
       06 16 7C 13
 2EA8  16 18 7C BE AD 7D      C db 016h, 018h, 07Ch, 0BEh, 0ADh, 07Dh, 089h, 05Ch, 004h, 08Ch, 044h, 006h, 089h, 044h, 008h, 089h
       89 5C 04 8C 44 06
       89 44 08 89
 2EB8  54 0A 8A 16 0C 7C      C db 054h, 00Ah, 08Ah, 016h, 00Ch, 07Ch, 0C6h, 044h, 002h, 001h, 0B8h, 000h, 042h, 0CDh, 013h, 073h
       C6 44 02 01 B8 00
       42 CD 13 73
 2EC8  0C FE 0E F2 7D 74      C db 00Ch, 0FEh, 00Eh, 0F2h, 07Dh, 074h, 006h, 032h, 0E4h, 0CDh, 013h, 0EBh, 0E9h, 0C3h, 0BBh, 007h
       06 32 E4 CD 13 EB
       E9 C3 BB 07
 2ED8  00 B4 0E AC 22 C0      C db 000h, 0B4h, 00Eh, 0ACh, 022h, 0C0h, 074h, 004h, 0CDh, 010h, 0EBh, 0F7h, 0C3h, 010h, 000h, 000h
       74 04 CD 10 EB F7
       C3 10 00 00
 2EE8  00 00 00 00 00 00      C db 000h, 000h, 000h, 000h, 000h, 000h, 000h, 000h, 000h, 000h, 000h, 000h, 000h, 000h, 000h, 007h
       00 00 00 00 00 00
       00 00 00 07
 2EF8  52 55 4E 49 58 20      C db 052h, 055h, 04Eh, 049h, 058h, 020h, 062h, 06Fh, 06Fh, 074h, 020h, 065h, 072h, 072h, 06Fh, 072h
       62 6F 6F 74 20 65
       72 72 6F 72
 2F08  21 0D 0A 00 C0 7F      C db 021h, 00Dh, 00Ah, 000h, 0C0h, 07Fh, 000h, 080h, 000h, 000h, 000h, 007h, 04Eh, 06Fh, 074h, 020h
       00 80 00 00 00 07
       4E 6F 74 20
 2F18  61 20 62 6F 6F 74      C db 061h, 020h, 062h, 06Fh, 06Fh, 074h, 061h, 062h, 06Ch, 065h, 020h, 064h, 069h, 073h, 06Bh, 021h
       61 62 6C 65 20 64
       69 73 6B 21
 2F28  0D 0A 00 76 32 20      C db 00Dh, 00Ah, 000h, 076h, 032h, 020h, 04Ch, 042h, 041h, 000h, 000h, 000h, 0E4h, 007h, 055h, 0AAh
       4C 42 41 00 00 00
       E4 07 55 AA
			      C 

				; 05/09/2019

 2F38  000D [			img_file_name:  db 13 dup(0)
        00
       ]
 2F45  00				        db 0
 2F46				img_file_handle:
 2F46  0000					dw 0

 2F48 00			new_file:	db 0

 2F49				msg_inv_file_name: ; 07/07/2015
 2F49  0D 0A					db 0Dh, 0Ah
 2F4B  49 6E 76 61 6C 69	                db "Invalid file name !", 0Dh, 0Ah
       64 20 66 69 6C 65
       20 6E 61 6D 65 20
       21 0D 0A
 2F60  28 46 69 6C 65 20	                db "(File name must fit for 8.3 DOS format) !"
       6E 61 6D 65 20 6D
       75 73 74 20 66 69
       74 20 66 6F 72 20
       38 2E 33 20 44 4F
       53 20 66 6F 72 6D
       61 74 29 20 21
 2F89  0D 0A 00			                db 0Dh, 0Ah, 0

 2F8C				msg_file_attr_error: ; 07/07/2015
 2F8C  0D 0A					db 0Dh, 0Ah
 2F8E  46 69 6C 65 20 61	                db "File attribute is not proper for hard disk image !", 0Dh, 0Ah
       74 74 72 69 62 75
       74 65 20 69 73 20
       6E 6F 74 20 70 72
       6F 70 65 72 20 66
       6F 72 20 68 61 72
       64 20 64 69 73 6B
       20 69 6D 61 67 65
       20 21 0D 0A
 2FC2  28 44 69 72 65 63	                db "(Directory or write protected file) !"
       74 6F 72 79 20 6F
       72 20 77 72 69 74
       65 20 70 72 6F 74
       65 63 74 65 64 20
       66 69 6C 65 29 20
       21
 2FE7  0D 0A 00			                db 0Dh, 0Ah, 0    

 2FEA				msg_file_not_found: ; 03/10/2019
 2FEA  0D 0A					db 0Dh, 0Ah
 2FEC  46 69 6C 65 20 6E	                db "File not found !", 0Dh, 0Ah
       6F 74 20 66 6F 75
       6E 64 20 21 0D 0A
 2FFE  28 48 61 72 64 20	                db "(Hard disk image file must be in working directory) !"
       64 69 73 6B 20 69
       6D 61 67 65 20 66
       69 6C 65 20 6D 75
       73 74 20 62 65 20
       69 6E 20 77 6F 72
       6B 69 6E 67 20 64
       69 72 65 63 74 6F
       72 79 29 20 21
 3033  0D 0A 00			                db 0Dh, 0Ah, 0  

 3036				msg_inv_image_file: ; 03/10/2019
 3036  0D 0A					db 0Dh, 0Ah
 3038  49 6E 76 61 6C 69			db "Invalid hard disk image file !", 0Dh, 0Ah
       64 20 68 61 72 64
       20 64 69 73 6B 20
       69 6D 61 67 65 20
       66 69 6C 65 20 21
       0D 0A
 3058  28 46 69 6C 65 20			db "(File size does not fit to possible CHS parameters) !"
       73 69 7A 65 20 64
       6F 65 73 20 6E 6F
       74 20 66 69 74 20
       74 6F 20 70 6F 73
       73 69 62 6C 65 20
       43 48 53 20 70 61
       72 61 6D 65 74 65
       72 73 29 20 21
 308D  0D 0A 00					db 0Dh, 0Ah, 0

 3090				msg_inv_partition: ; 03/10/2019
 3090  0D 0A					db 0Dh, 0Ah
 3092  52 65 74 72 6F 20			db "Retro UNIX (71h) disk partition not found !"
       55 4E 49 58 20 28
       37 31 68 29 20 64
       69 73 6B 20 70 61
       72 74 69 74 69 6F
       6E 20 6E 6F 74 20
       66 6F 75 6E 64 20
       21
 30BD  0D 0A 00					db 0Dh, 0Ah, 0

 30C0				msg_init_img_file:
 30C0  0D 0A					db 0Dh, 0Ah
 30C2  49 6E 69 74 69 61			db "Initializing disk image file sectors...", 0
       6C 69 7A 69 6E 67
       20 64 69 73 6B 20
       69 6D 61 67 65 20
       66 69 6C 65 20 73
       65 63 74 6F 72 73
       2E 2E 2E 00

				; 03/12/2019
 30EA FFFF			save_ax:	dw 0FFFFh
 30EC FFFF			save_dx:	dw 0FFFFh	

 30EE = 0001308A		SizeOfFile	equ $-100

 30EE				RUFS_INSTL	ends

						end  INSTALL
Microsoft (R) Macro Assembler Version 6.14.8444		    07/20/22 00:25:48
unixhdfs.asm						     Symbols 2 - 1




Structures and Unions:

                N a m e                  Size
                                         Offset      Type

RUFS . . . . . . . . . . . . . .	 001A
  bsJumpCode . . . . . . . . . .	 0000	     Word
  bsFSystemID  . . . . . . . . .	 0002	     Byte
  bsVolumeSerial . . . . . . . .	 0006	     DWord
  bsDriveID  . . . . . . . . . .	 000A	     Word
  bsDriveNumber  . . . . . . . .	 000C	     Byte
  bsReserved . . . . . . . . . .	 000D	     Byte
  bsSecPerTrack  . . . . . . . .	 000E	     Byte
  bsHeads  . . . . . . . . . . .	 000F	     Byte
  bsCylinders  . . . . . . . . .	 0010	     Word
  bs_BF_I_number . . . . . . . .	 0012	     Word
  bsMagic  . . . . . . . . . . .	 0014	     Byte
  bsPartitionID  . . . . . . . .	 0015	     Byte
  bsHiddenSects  . . . . . . . .	 0016	     DWord
SuperBlock . . . . . . . . . . .	 0200
  sb_Header  . . . . . . . . . .	 0000	     DWord
  sb_BootSectAddr  . . . . . . .	 0004	     DWord
  sb_VolumeSize  . . . . . . . .	 0008	     DWord
  sb_Version . . . . . . . . . .	 000C	     DWord
  sb_BlockSize . . . . . . . . .	 0010	     DWord
  sb_InodeCount  . . . . . . . .	 0014	     DWord
  sb_FreeMapAddr . . . . . . . .	 0018	     DWord
  sb_FreeMapSize . . . . . . . .	 001C	     DWord
  sb_InodeMapAddr  . . . . . . .	 0020	     DWord
  sb_InodeMapSize  . . . . . . .	 0024	     DWord
  sb_InodeTblAddr  . . . . . . .	 0028	     DWord
  sb_InodeTblSize  . . . . . . .	 002C	     DWord
  sb_FreeInodes  . . . . . . . .	 0030	     DWord
  sb_FirstFreeIno  . . . . . . .	 0034	     DWord
  sb_FreeBlocks  . . . . . . . .	 0038	     DWord
  sb_FirstFreeBlk  . . . . . . .	 003C	     DWord
  sb_BootSecParms  . . . . . . .	 0040	     Byte
  sb_BSExtension . . . . . . . .	 0053	     Byte
  sb_Status  . . . . . . . . . .	 0058	     DWord
  sb_ModifTime . . . . . . . . .	 005C	     DWord
  sb_ExtdVolTbl  . . . . . . . .	 0060	     DWord
  sb_ExtdVolSize . . . . . . . .	 0064	     DWord
  sb_LBA_rw  . . . . . . . . . .	 0068	     Byte
  sb_ClusterSize . . . . . . . .	 0069	     Byte
  sb_ReadOnly  . . . . . . . . .	 006A	     Byte
  sb_Mounted . . . . . . . . . .	 006B	     Byte
  sb_MountInode  . . . . . . . .	 006C	     DWord
  sb_DevMajor  . . . . . . . . .	 0070	     Byte
  sb_DevMinor  . . . . . . . . .	 0071	     Byte
  sb_LongName  . . . . . . . . .	 0072	     Byte
  sb_Direntry32  . . . . . . . .	 0073	     Byte
  sb_Reserved  . . . . . . . . .	 0074	     Byte
  sb_Footer  . . . . . . . . . .	 01FC	     DWord


Segments and Groups:

                N a m e                 Size     Length   Align   Combine Class

RUFS_INSTL . . . . . . . . . . .	16 Bit	 30EE	  Para	  Public  'CODE'	


Procedures,  parameters and locals:

                N a m e                 Type     Value    Attr

PRINT_MSG  . . . . . . . . . . .	P Near	 04B6	  RUFS_INSTL	Length= 000F Private
alloc  . . . . . . . . . . . . .	P Near	 229B	  RUFS_INSTL	Length= 016E Private
check_hd_image_size  . . . . . .	P Near	 039E	  RUFS_INSTL	Length= 0118 Private
clear  . . . . . . . . . . . . .	P Near	 24CC	  RUFS_INSTL	Length= 0011 Private
dskrd  . . . . . . . . . . . . .	P Near	 1DC3	  RUFS_INSTL	Length= 00D2 Private
dskwr  . . . . . . . . . . . . .	P Near	 1DBC	  RUFS_INSTL	Length= 0007 Private
dskw . . . . . . . . . . . . . .	P Near	 1F87	  RUFS_INSTL	Length= 00D1 Private
epoch  . . . . . . . . . . . . .	P Near	 2514	  RUFS_INSTL	Length= 00F0 Private
free . . . . . . . . . . . . . .	P Near	 2409	  RUFS_INSTL	Length= 00C3 Private
get_runix_partition  . . . . . .	P Near	 032B	  RUFS_INSTL	Length= 0073 Private
icalc  . . . . . . . . . . . . .	P Near	 1D43	  RUFS_INSTL	Length= 0079 Private
iget . . . . . . . . . . . . . .	P Near	 1D10	  RUFS_INSTL	Length= 0033 Private
image_file_rw  . . . . . . . . .	P Near	 1E95	  RUFS_INSTL	Length= 004B Private
imap . . . . . . . . . . . . . .	P Near	 1F10	  RUFS_INSTL	Length= 006C Private
mget . . . . . . . . . . . . . .	P Near	 2058	  RUFS_INSTL	Length= 0243 Private
proc_hex . . . . . . . . . . . .	P Near	 04C5	  RUFS_INSTL	Length= 0016 Private
rufs_hd_format . . . . . . . . .	P Near	 0000	  RUFS_INSTL	Length= 030C Private
set_firstfreeblock . . . . . . .	P Near	 0974	  RUFS_INSTL	Length= 0089 Private
set_firstfreeinode . . . . . . .	P Near	 091D	  RUFS_INSTL	Length= 0057 Private
set_hd_parms . . . . . . . . . .	P Near	 030C	  RUFS_INSTL	Length= 001F Private
setimod  . . . . . . . . . . . .	P Near	 1EE0	  RUFS_INSTL	Length= 0030 Private
sioreg . . . . . . . . . . . . .	P Near	 24DD	  RUFS_INSTL	Length= 0037 Private
sync . . . . . . . . . . . . . .	P Near	 0766	  RUFS_INSTL	Length= 01B7 Private
unix_fs_install  . . . . . . . .	P Near	 0547	  RUFS_INSTL	Length= 021F Private
writei . . . . . . . . . . . . .	P Near	 1F7C	  RUFS_INSTL	Length= 000B Private


Symbols:

                N a m e                 Type     Value    Attr

A_15 . . . . . . . . . . . . . .	L Near	 03F5	  RUFS_INSTL	
A_16 . . . . . . . . . . . . . .	L Near	 0403	  RUFS_INSTL	
A_17 . . . . . . . . . . . . . .	L Near	 0410	  RUFS_INSTL	
A_18 . . . . . . . . . . . . . .	L Near	 042D	  RUFS_INSTL	
A_19 . . . . . . . . . . . . . .	L Near	 0434	  RUFS_INSTL	
A_20 . . . . . . . . . . . . . .	L Near	 049F	  RUFS_INSTL	
A_21 . . . . . . . . . . . . . .	L Near	 0446	  RUFS_INSTL	
A_22 . . . . . . . . . . . . . .	L Near	 045D	  RUFS_INSTL	
A_23 . . . . . . . . . . . . . .	L Near	 046E	  RUFS_INSTL	
A_24 . . . . . . . . . . . . . .	L Near	 0477	  RUFS_INSTL	
A_25 . . . . . . . . . . . . . .	L Near	 047D	  RUFS_INSTL	
A_26 . . . . . . . . . . . . . .	L Near	 0486	  RUFS_INSTL	
A_27 . . . . . . . . . . . . . .	L Near	 0452	  RUFS_INSTL	
A_28 . . . . . . . . . . . . . .	L Near	 0455	  RUFS_INSTL	
BLOCKDEV . . . . . . . . . . . .	Number	 61FFh	 
B_04 . . . . . . . . . . . . . .	L Near	 040E	  RUFS_INSTL	
Buffer . . . . . . . . . . . . .	L Near	 1910	  RUFS_INSTL	
CHARDEV  . . . . . . . . . . . .	Number	 21FFh	 
CHS_limit  . . . . . . . . . . .	L Near	 2B30	  RUFS_INSTL	
CRLF . . . . . . . . . . . . . .	L Near	 0544	  RUFS_INSTL	
Cursor_Pos . . . . . . . . . . .	L Near	 2A5A	  RUFS_INSTL	
DISK_SIZE  . . . . . . . . . . .	Number	 0B40h	 
DMonth . . . . . . . . . . . . .	L Near	 2610	  RUFS_INSTL	
DTA_Attrib . . . . . . . . . . .	Number	 0095h	 
DTA_Date . . . . . . . . . . . .	Number	 0098h	 
DTA_FileName . . . . . . . . . .	Number	 009Eh	 
DTA_FileSize . . . . . . . . . .	Number	 009Ah	 
DTA_Time . . . . . . . . . . . .	Number	 0096h	 
Error  . . . . . . . . . . . . .	L Near	 2629	  RUFS_INSTL	
INODE_COUNT  . . . . . . . . . .	Text   	 SIZE_INODE_MAP * 8
INODE_LIST_BLOCKS  . . . . . . .	Text   	 (INODE_COUNT / 8)
INSTALL  . . . . . . . . . . . .	L Near	 0100	  RUFS_INSTL	
I_buffer . . . . . . . . . . . .	L Near	 2638	  RUFS_INSTL	
I_rw . . . . . . . . . . . . . .	L Near	 2634	  RUFS_INSTL	
I_sector . . . . . . . . . . . .	L Near	 2636	  RUFS_INSTL	
I_valid  . . . . . . . . . . . .	L Near	 2635	  RUFS_INSTL	
Msg_DoYouWantToFormat  . . . . .	L Near	 2988	  RUFS_INSTL	
Msg_Installing_File_System . . .	L Near	 2A0A	  RUFS_INSTL	
Msg_OK . . . . . . . . . . . . .	L Near	 2A6C	  RUFS_INSTL	
Msg_Volume_Name  . . . . . . . .	L Near	 2A5C	  RUFS_INSTL	
Msg_Writing_Boot_Sector  . . . .	L Near	 2A33	  RUFS_INSTL	
PRINT_MSG_LOOP . . . . . . . . .	L Near	 04BB	  RUFS_INSTL	
PRINT_MSG_OK . . . . . . . . . .	L Near	 04C4	  RUFS_INSTL	
REGULARDEF . . . . . . . . . . .	Number	 81FFh	 
RUFS_BSP_SIZE  . . . . . . . . .	Number	 0013h	 
RUFS_DRIVE . . . . . . . . . . .	L Near	 29FC	  RUFS_INSTL	
RetryCount . . . . . . . . . . .	L Near	 2AB1	  RUFS_INSTL	
SizeOfFile . . . . . . . . . . .	Number	 0001308Ah   
UNIX_CRLF  . . . . . . . . . . .	L Near	 2AAE	  RUFS_INSTL	
UNIX_Welcome . . . . . . . . . .	L Near	 2838	  RUFS_INSTL	
VolumeSerial . . . . . . . . . .	L Near	 2B34	  RUFS_INSTL	
alloc_0  . . . . . . . . . . . .	L Near	 22A8	  RUFS_INSTL	
alloc_10 . . . . . . . . . . . .	L Near	 2371	  RUFS_INSTL	
alloc_11 . . . . . . . . . . . .	L Near	 237F	  RUFS_INSTL	
alloc_12 . . . . . . . . . . . .	L Near	 239B	  RUFS_INSTL	
alloc_13 . . . . . . . . . . . .	L Near	 23B2	  RUFS_INSTL	
alloc_14 . . . . . . . . . . . .	L Near	 23BE	  RUFS_INSTL	
alloc_15 . . . . . . . . . . . .	L Near	 23EA	  RUFS_INSTL	
alloc_16 . . . . . . . . . . . .	L Near	 2405	  RUFS_INSTL	
alloc_17 . . . . . . . . . . . .	L Near	 230F	  RUFS_INSTL	
alloc_18 . . . . . . . . . . . .	L Near	 2392	  RUFS_INSTL	
alloc_19 . . . . . . . . . . . .	L Near	 235C	  RUFS_INSTL	
alloc_1  . . . . . . . . . . . .	L Near	 22C7	  RUFS_INSTL	
alloc_2  . . . . . . . . . . . .	L Near	 22CB	  RUFS_INSTL	
alloc_3  . . . . . . . . . . . .	L Near	 22D4	  RUFS_INSTL	
alloc_4  . . . . . . . . . . . .	L Near	 22E1	  RUFS_INSTL	
alloc_5  . . . . . . . . . . . .	L Near	 2308	  RUFS_INSTL	
alloc_6  . . . . . . . . . . . .	L Near	 232A	  RUFS_INSTL	
alloc_7  . . . . . . . . . . . .	L Near	 232D	  RUFS_INSTL	
alloc_8  . . . . . . . . . . . .	L Near	 2365	  RUFS_INSTL	
alloc_9  . . . . . . . . . . . .	L Near	 2361	  RUFS_INSTL	
alloc_err  . . . . . . . . . . .	L Near	 22A6	  RUFS_INSTL	
big_fs . . . . . . . . . . . . .	L Near	 05E4	  RUFS_INSTL	
bin_dir  . . . . . . . . . . . .	L Near	 0E00	  RUFS_INSTL	
bin_inode  . . . . . . . . . . .	L Near	 0F7A	  RUFS_INSTL	
bitpos . . . . . . . . . . . . .	L Near	 2628	  RUFS_INSTL	
boot_sector  . . . . . . . . . .	L Near	 2B38	  RUFS_INSTL	
buff_c . . . . . . . . . . . . .	L Near	 0A06	  RUFS_INSTL	
buff_d . . . . . . . . . . . . .	L Near	 09FF	  RUFS_INSTL	
buff_m . . . . . . . . . . . . .	L Near	 0A04	  RUFS_INSTL	
buff_s . . . . . . . . . . . . .	L Near	 0A00	  RUFS_INSTL	
buff_w . . . . . . . . . . . . .	L Near	 0A05	  RUFS_INSTL	
cap_file_name0 . . . . . . . . .	L Near	 0269	  RUFS_INSTL	
cap_file_name1 . . . . . . . . .	L Near	 0278	  RUFS_INSTL	
cap_file_name2 . . . . . . . . .	L Near	 027B	  RUFS_INSTL	
cap_file_name3 . . . . . . . . .	L Near	 0284	  RUFS_INSTL	
cap_file_name4 . . . . . . . . .	L Near	 02A1	  RUFS_INSTL	
cap_file_name  . . . . . . . . .	L Near	 0262	  RUFS_INSTL	
check_hdi_opt_loop . . . . . . .	L Near	 01CA	  RUFS_INSTL	
check_hdi_option . . . . . . . .	L Near	 01B8	  RUFS_INSTL	
check_runix_partition  . . . . .	L Near	 0338	  RUFS_INSTL	
chk_image_file_features  . . . .	L Near	 02B2	  RUFS_INSTL	
chs_err_retn . . . . . . . . . .	L Near	 1E3B	  RUFS_INSTL	
chs_ok . . . . . . . . . . . . .	L Near	 039D	  RUFS_INSTL	
chs_read_write . . . . . . . . .	L Near	 1DF9	  RUFS_INSTL	
chs_rw_ok  . . . . . . . . . . .	L Near	 1E40	  RUFS_INSTL	
close_file_then_terminate  . . .	L Near	 022E	  RUFS_INSTL	
close_img_file . . . . . . . . .	L Near	 0236	  RUFS_INSTL	
com1_inode . . . . . . . . . . .	L Near	 14FA	  RUFS_INSTL	
com2_inode . . . . . . . . . . .	L Near	 153A	  RUFS_INSTL	
convert_to_epoch . . . . . . . .	L Near	 2585	  RUFS_INSTL	
count  . . . . . . . . . . . . .	L Near	 1704	  RUFS_INSTL	
cylinders  . . . . . . . . . . .	L Near	 2AC6	  RUFS_INSTL	
data_start . . . . . . . . . . .	L Near	 1700	  RUFS_INSTL	
day  . . . . . . . . . . . . . .	L Near	 2608	  RUFS_INSTL	
dev_dir  . . . . . . . . . . . .	L Near	 0C90	  RUFS_INSTL	
dev_inode  . . . . . . . . . . .	L Near	 0F3A	  RUFS_INSTL	
dirs . . . . . . . . . . . . . .	L Near	 0C10	  RUFS_INSTL	
diskio . . . . . . . . . . . . .	L Near	 1DC8	  RUFS_INSTL	
div32  . . . . . . . . . . . . .	L Near	 04F5	  RUFS_INSTL	
drive_check_ok . . . . . . . . .	L Near	 04F4	  RUFS_INSTL	
drive_check  . . . . . . . . . .	L Near	 04DB	  RUFS_INSTL	
drive_not_ready  . . . . . . . .	L Near	 04EA	  RUFS_INSTL	
drive  . . . . . . . . . . . . .	L Near	 09FF	  RUFS_INSTL	
dskw_0 . . . . . . . . . . . . .	L Near	 1F87	  RUFS_INSTL	
dskw_10  . . . . . . . . . . . .	L Near	 1FC9	  RUFS_INSTL	
dskw_11  . . . . . . . . . . . .	L Near	 1FEB	  RUFS_INSTL	
dskw_12  . . . . . . . . . . . .	L Near	 2000	  RUFS_INSTL	
dskw_1 . . . . . . . . . . . . .	L Near	 1FCF	  RUFS_INSTL	
dskw_2 . . . . . . . . . . . . .	L Near	 2017	  RUFS_INSTL	
dskw_3 . . . . . . . . . . . . .	L Near	 202C	  RUFS_INSTL	
dskw_4 . . . . . . . . . . . . .	L Near	 202F	  RUFS_INSTL	
dskw_5 . . . . . . . . . . . . .	L Near	 2028	  RUFS_INSTL	
dskw_6 . . . . . . . . . . . . .	L Near	 2023	  RUFS_INSTL	
dskw_7 . . . . . . . . . . . . .	L Near	 1FC0	  RUFS_INSTL	
dskw_8 . . . . . . . . . . . . .	L Near	 1FA2	  RUFS_INSTL	
dskw_9 . . . . . . . . . . . . .	L Near	 1FC3	  RUFS_INSTL	
err_INVALIDDATA  . . . . . . . .	Number	 0100h	 
err_NOFREEBLOCK  . . . . . . . .	Number	 0200h	 
etc_dir  . . . . . . . . . . . .	L Near	 0E20	  RUFS_INSTL	
etc_inode  . . . . . . . . . . .	L Near	 0FBA	  RUFS_INSTL	
fbm_buffer . . . . . . . . . . .	L Near	 1B10	  RUFS_INSTL	
fd0_inode  . . . . . . . . . . .	L Near	 113A	  RUFS_INSTL	
fd1_inode  . . . . . . . . . . .	L Near	 117A	  RUFS_INSTL	
file_attr_error  . . . . . . . .	L Near	 02FE	  RUFS_INSTL	
file_error_msg . . . . . . . . .	L Near	 0529	  RUFS_INSTL	
file_error . . . . . . . . . . .	L Near	 029C	  RUFS_INSTL	
file_not_found_error . . . . . .	L Near	 02F8	  RUFS_INSTL	
file_size  . . . . . . . . . . .	L Near	 2AD0	  RUFS_INSTL	
fm_sector  . . . . . . . . . . .	L Near	 1708	  RUFS_INSTL	
free_1 . . . . . . . . . . . . .	L Near	 2428	  RUFS_INSTL	
free_2 . . . . . . . . . . . . .	L Near	 2452	  RUFS_INSTL	
free_3 . . . . . . . . . . . . .	L Near	 246B	  RUFS_INSTL	
free_4 . . . . . . . . . . . . .	L Near	 2477	  RUFS_INSTL	
free_5 . . . . . . . . . . . . .	L Near	 24A8	  RUFS_INSTL	
free_6 . . . . . . . . . . . . .	L Near	 24BD	  RUFS_INSTL	
free_7 . . . . . . . . . . . . .	L Near	 24CA	  RUFS_INSTL	
free_8 . . . . . . . . . . . . .	L Near	 24CB	  RUFS_INSTL	
free_9 . . . . . . . . . . . . .	L Near	 244E	  RUFS_INSTL	
get_args . . . . . . . . . . . .	L Near	 011F	  RUFS_INSTL	
get_hdi_name_nxt_chr . . . . . .	L Near	 01E2	  RUFS_INSTL	
get_hdi_name_ok  . . . . . . . .	L Near	 01F4	  RUFS_INSTL	
get_hdi_name . . . . . . . . . .	L Near	 01DF	  RUFS_INSTL	
hd0_inode  . . . . . . . . . . .	L Near	 11BA	  RUFS_INSTL	
hd1_inode  . . . . . . . . . . .	L Near	 11FA	  RUFS_INSTL	
hd2_inode  . . . . . . . . . . .	L Near	 123A	  RUFS_INSTL	
hd3_inode  . . . . . . . . . . .	L Near	 127A	  RUFS_INSTL	
hd_img_file_rw_err . . . . . . .	L Near	 1ED6	  RUFS_INSTL	
hd_img_file_rw_ok  . . . . . . .	L Near	 1EDB	  RUFS_INSTL	
hd_img_file_rw . . . . . . . . .	L Near	 1EA3	  RUFS_INSTL	
heads  . . . . . . . . . . . . .	L Near	 2AC2	  RUFS_INSTL	
hidden_sectors . . . . . . . . .	L Near	 2AC8	  RUFS_INSTL	
hour . . . . . . . . . . . . . .	L Near	 260A	  RUFS_INSTL	
i_ctim . . . . . . . . . . . . .	L Near	 0EE8	  RUFS_INSTL	
i_dir_sizes  . . . . . . . . . .	L Near	 0EEC	  RUFS_INSTL	
i_dskp . . . . . . . . . . . . .	L Near	 0EB8	  RUFS_INSTL	
i_flgs . . . . . . . . . . . . .	L Near	 0EAC	  RUFS_INSTL	
i_gid  . . . . . . . . . . . . .	L Near	 0EB2	  RUFS_INSTL	
i_ltim . . . . . . . . . . . . .	L Near	 0EE0	  RUFS_INSTL	
i_mtim . . . . . . . . . . . . .	L Near	 0EE4	  RUFS_INSTL	
i_nlks . . . . . . . . . . . . .	L Near	 0EAE	  RUFS_INSTL	
i_size_h . . . . . . . . . . . .	L Near	 0EB3	  RUFS_INSTL	
i_size . . . . . . . . . . . . .	L Near	 0EB4	  RUFS_INSTL	
i_uid  . . . . . . . . . . . . .	L Near	 0EB0	  RUFS_INSTL	
icalc_0  . . . . . . . . . . . .	L Near	 1D61	  RUFS_INSTL	
icalc_1  . . . . . . . . . . . .	L Near	 1D80	  RUFS_INSTL	
icalc_2  . . . . . . . . . . . .	L Near	 1D9D	  RUFS_INSTL	
icalc_3  . . . . . . . . . . . .	L Near	 1DB5	  RUFS_INSTL	
icalc_4  . . . . . . . . . . . .	L Near	 1DB9	  RUFS_INSTL	
icalc_5  . . . . . . . . . . . .	L Near	 1DBB	  RUFS_INSTL	
idata  . . . . . . . . . . . . .	L Near	 0EFA	  RUFS_INSTL	
iget_1 . . . . . . . . . . . . .	L Near	 1D16	  RUFS_INSTL	
iget_2 . . . . . . . . . . . . .	L Near	 1D33	  RUFS_INSTL	
iget_3 . . . . . . . . . . . . .	L Near	 1D3E	  RUFS_INSTL	
iget_4 . . . . . . . . . . . . .	L Near	 1D42	  RUFS_INSTL	
iget_5 . . . . . . . . . . . . .	L Near	 1D42	  RUFS_INSTL	
ii . . . . . . . . . . . . . . .	L Near	 262D	  RUFS_INSTL	
im_buffer  . . . . . . . . . . .	L Near	 1710	  RUFS_INSTL	
im_scount  . . . . . . . . . . .	L Near	 170E	  RUFS_INSTL	
im_sector  . . . . . . . . . . .	L Near	 170C	  RUFS_INSTL	
image_file_rw_err  . . . . . . .	L Near	 1E9B	  RUFS_INSTL	
image_file_rw_ok . . . . . . . .	L Near	 1EA0	  RUFS_INSTL	
imap_0 . . . . . . . . . . . . .	L Near	 1F4C	  RUFS_INSTL	
imap_1 . . . . . . . . . . . . .	L Near	 1F4F	  RUFS_INSTL	
imap_2 . . . . . . . . . . . . .	L Near	 1F54	  RUFS_INSTL	
imap_3 . . . . . . . . . . . . .	L Near	 1F6A	  RUFS_INSTL	
imap_4 . . . . . . . . . . . . .	L Near	 1F75	  RUFS_INSTL	
imap_5 . . . . . . . . . . . . .	L Near	 1F7A	  RUFS_INSTL	
img_file_handle  . . . . . . . .	L Near	 2F46	  RUFS_INSTL	
img_file_name  . . . . . . . . .	L Near	 2F38	  RUFS_INSTL	
imod . . . . . . . . . . . . . .	L Near	 262C	  RUFS_INSTL	
infinive_loop  . . . . . . . . .	L Near	 01B1	  RUFS_INSTL	
inodes . . . . . . . . . . . . .	L Near	 0EFA	  RUFS_INSTL	
inode  . . . . . . . . . . . . .	L Near	 0EAC	  RUFS_INSTL	
invalid_disk_image_sector  . . .	L Near	 1E9A	  RUFS_INSTL	
invalid_file_name  . . . . . . .	L Near	 023D	  RUFS_INSTL	
invalid_image_file . . . . . . .	L Near	 02F2	  RUFS_INSTL	
large_fs . . . . . . . . . . . .	L Near	 05D0	  RUFS_INSTL	
lba_boot_sector  . . . . . . . .	L Near	 2D38	  RUFS_INSTL	
lba_err_retn . . . . . . . . . .	L Near	 1E3B	  RUFS_INSTL	
lba_not_ready  . . . . . . . . .	L Near	 1E51	  RUFS_INSTL	
lba_ok . . . . . . . . . . . . .	L Near	 0397	  RUFS_INSTL	
lba_read_again . . . . . . . . .	L Near	 1E58	  RUFS_INSTL	
lba_read_write . . . . . . . . .	L Near	 1E45	  RUFS_INSTL	
lba_rw_ok  . . . . . . . . . . .	L Near	 1E40	  RUFS_INSTL	
lba_rw . . . . . . . . . . . . .	L Near	 2ADA	  RUFS_INSTL	
level  . . . . . . . . . . . . .	L Near	 2630	  RUFS_INSTL	
lpr_inode  . . . . . . . . . . .	L Near	 12BA	  RUFS_INSTL	
mem_inode  . . . . . . . . . . .	L Near	 10FA	  RUFS_INSTL	
mget_0 . . . . . . . . . . . . .	L Near	 2058	  RUFS_INSTL	
mget_10  . . . . . . . . . . . .	L Near	 2195	  RUFS_INSTL	
mget_11  . . . . . . . . . . . .	L Near	 21C5	  RUFS_INSTL	
mget_12  . . . . . . . . . . . .	L Near	 21FF	  RUFS_INSTL	
mget_13  . . . . . . . . . . . .	L Near	 2200	  RUFS_INSTL	
mget_14  . . . . . . . . . . . .	L Near	 2205	  RUFS_INSTL	
mget_15  . . . . . . . . . . . .	L Near	 221E	  RUFS_INSTL	
mget_16  . . . . . . . . . . . .	L Near	 222A	  RUFS_INSTL	
mget_17  . . . . . . . . . . . .	L Near	 2246	  RUFS_INSTL	
mget_18  . . . . . . . . . . . .	L Near	 2252	  RUFS_INSTL	
mget_19  . . . . . . . . . . . .	L Near	 228C	  RUFS_INSTL	
mget_1 . . . . . . . . . . . . .	L Near	 20BF	  RUFS_INSTL	
mget_20  . . . . . . . . . . . .	L Near	 21EF	  RUFS_INSTL	
mget_21  . . . . . . . . . . . .	L Near	 227D	  RUFS_INSTL	
mget_22  . . . . . . . . . . . .	L Near	 2286	  RUFS_INSTL	
mget_23  . . . . . . . . . . . .	L Near	 2287	  RUFS_INSTL	
mget_2 . . . . . . . . . . . . .	L Near	 20D8	  RUFS_INSTL	
mget_3 . . . . . . . . . . . . .	L Near	 20D9	  RUFS_INSTL	
mget_4 . . . . . . . . . . . . .	L Near	 20FD	  RUFS_INSTL	
mget_5 . . . . . . . . . . . . .	L Near	 210F	  RUFS_INSTL	
mget_6 . . . . . . . . . . . . .	L Near	 213F	  RUFS_INSTL	
mget_7 . . . . . . . . . . . . .	L Near	 2145	  RUFS_INSTL	
mget_8 . . . . . . . . . . . . .	L Near	 2146	  RUFS_INSTL	
mget_9 . . . . . . . . . . . . .	L Near	 216B	  RUFS_INSTL	
min_sectors  . . . . . . . . . .	L Near	 2AD8	  RUFS_INSTL	
minute . . . . . . . . . . . . .	L Near	 260C	  RUFS_INSTL	
mnt_dir  . . . . . . . . . . . .	L Near	 0E80	  RUFS_INSTL	
mnt_inode  . . . . . . . . . . .	L Near	 107A	  RUFS_INSTL	
month  . . . . . . . . . . . . .	L Near	 2606	  RUFS_INSTL	
msg_NO . . . . . . . . . . . . .	L Near	 2A76	  RUFS_INSTL	
msg_YES  . . . . . . . . . . . .	L Near	 2A71	  RUFS_INSTL	
msg_disk_rw_error  . . . . . . .	L Near	 2A7A	  RUFS_INSTL	
msg_drive_not_ready  . . . . . .	L Near	 2A8C	  RUFS_INSTL	
msg_error_Number . . . . . . . .	L Near	 2A9F	  RUFS_INSTL	
msg_file_attr_error  . . . . . .	L Near	 2F8C	  RUFS_INSTL	
msg_file_not_found . . . . . . .	L Near	 2FEA	  RUFS_INSTL	
msg_init_img_file  . . . . . . .	L Near	 30C0	  RUFS_INSTL	
msg_inv_file_name  . . . . . . .	L Near	 2F49	  RUFS_INSTL	
msg_inv_image_file . . . . . . .	L Near	 3036	  RUFS_INSTL	
msg_inv_partition  . . . . . . .	L Near	 3090	  RUFS_INSTL	
mul32  . . . . . . . . . . . . .	L Near	 0503	  RUFS_INSTL	
new_file . . . . . . . . . . . .	L Near	 2F48	  RUFS_INSTL	
norotal  . . . . . . . . . . . .	L Near	 051F	  RUFS_INSTL	
norotar  . . . . . . . . . . . .	L Near	 0528	  RUFS_INSTL	
not_masterboot . . . . . . . . .	L Near	 0333	  RUFS_INSTL	
not_runix_partition  . . . . . .	L Near	 0348	  RUFS_INSTL	
open_image_file  . . . . . . . .	L Near	 02A6	  RUFS_INSTL	
pass_cc_ah . . . . . . . . . . .	L Near	 04DA	  RUFS_INSTL	
pass_cc_al . . . . . . . . . . .	L Near	 04D2	  RUFS_INSTL	
pp_sectors . . . . . . . . . . .	L Near	 2AD4	  RUFS_INSTL	
reset_ok . . . . . . . . . . . .	L Near	 04DB	  RUFS_INSTL	
root_dir . . . . . . . . . . . .	L Near	 0C10	  RUFS_INSTL	
root_inode . . . . . . . . . . .	L Near	 0EFA	  RUFS_INSTL	
rotashftl  . . . . . . . . . . .	L Near	 0519	  RUFS_INSTL	
rotashftr  . . . . . . . . . . .	L Near	 0522	  RUFS_INSTL	
rufs_hd_format_10  . . . . . . .	L Near	 01F9	  RUFS_INSTL	
rufs_hd_format_11  . . . . . . .	L Near	 01FF	  RUFS_INSTL	
rufs_hd_format_12  . . . . . . .	L Near	 020B	  RUFS_INSTL	
rufs_hd_format_13  . . . . . . .	L Near	 021A	  RUFS_INSTL	
rufs_hd_format_14  . . . . . . .	L Near	 0242	  RUFS_INSTL	
rufs_hd_format_15  . . . . . . .	L Near	 0248	  RUFS_INSTL	
rufs_hd_format_16  . . . . . . .	L Near	 024E	  RUFS_INSTL	
rufs_hd_format_17  . . . . . . .	L Near	 025A	  RUFS_INSTL	
rufs_hd_format_1 . . . . . . . .	L Near	 012A	  RUFS_INSTL	
rufs_hd_format_2 . . . . . . . .	L Near	 0131	  RUFS_INSTL	
rufs_hd_format_3 . . . . . . . .	L Near	 014F	  RUFS_INSTL	
rufs_hd_format_4 . . . . . . . .	L Near	 0161	  RUFS_INSTL	
rufs_hd_format_5 . . . . . . . .	L Near	 0166	  RUFS_INSTL	
rufs_hd_format_6 . . . . . . . .	L Near	 018D	  RUFS_INSTL	
rufs_hd_format_7 . . . . . . . .	L Near	 01A3	  RUFS_INSTL	
rufs_hd_format_8 . . . . . . . .	L Near	 01A9	  RUFS_INSTL	
rufs_hd_format_9 . . . . . . . .	L Near	 01D7	  RUFS_INSTL	
rufs_hd_format_img . . . . . . .	L Near	 0182	  RUFS_INSTL	
runix_partition_error  . . . . .	L Near	 01B3	  RUFS_INSTL	
runix_partition_ok . . . . . . .	L Near	 034A	  RUFS_INSTL	
rw . . . . . . . . . . . . . . .	L Near	 262F	  RUFS_INSTL	
save_ax  . . . . . . . . . . . .	L Near	 30EA	  RUFS_INSTL	
save_dx  . . . . . . . . . . . .	L Near	 30EC	  RUFS_INSTL	
sb_HiddenSects . . . . . . . . .	Text   	 sb_BootSecAddr
sb_TotalSects  . . . . . . . . .	Text   	 sb_VolumeSize
second . . . . . . . . . . . . .	L Near	 260E	  RUFS_INSTL	
sector_buffer  . . . . . . . . .	L Near	 1910	  RUFS_INSTL	
sectors  . . . . . . . . . . . .	L Near	 2AC4	  RUFS_INSTL	
set_boot_sector_parms  . . . . .	L Near	 0559	  RUFS_INSTL	
sffb_1 . . . . . . . . . . . . .	L Near	 0997	  RUFS_INSTL	
sffb_2 . . . . . . . . . . . . .	L Near	 09A6	  RUFS_INSTL	
sffb_3 . . . . . . . . . . . . .	L Near	 09AB	  RUFS_INSTL	
sffb_4 . . . . . . . . . . . . .	L Near	 09B3	  RUFS_INSTL	
sffb_5 . . . . . . . . . . . . .	L Near	 09BF	  RUFS_INSTL	
sffb_6 . . . . . . . . . . . . .	L Near	 09C0	  RUFS_INSTL	
sffb_7 . . . . . . . . . . . . .	L Near	 09D0	  RUFS_INSTL	
sffb_8 . . . . . . . . . . . . .	L Near	 09D9	  RUFS_INSTL	
sffb_9 . . . . . . . . . . . . .	L Near	 09E4	  RUFS_INSTL	
sffi_1 . . . . . . . . . . . . .	L Near	 0932	  RUFS_INSTL	
sffi_2 . . . . . . . . . . . . .	L Near	 0941	  RUFS_INSTL	
sffi_3 . . . . . . . . . . . . .	L Near	 0946	  RUFS_INSTL	
sffi_4 . . . . . . . . . . . . .	L Near	 094F	  RUFS_INSTL	
sffi_5 . . . . . . . . . . . . .	L Near	 0950	  RUFS_INSTL	
sffi_6 . . . . . . . . . . . . .	L Near	 0961	  RUFS_INSTL	
shl32  . . . . . . . . . . . . .	L Near	 0517	  RUFS_INSTL	
shr32  . . . . . . . . . . . . .	L Near	 0520	  RUFS_INSTL	
size_bin_dir . . . . . . . . . .	Number	 0020h	 
size_dev_dir . . . . . . . . . .	Number	 0170h	 
size_etc_dir . . . . . . . . . .	Number	 0020h	 
size_mnt_dir . . . . . . . . . .	Number	 0020h	 
size_root_dir  . . . . . . . . .	Number	 0080h	 
size_tmp_dir . . . . . . . . . .	Number	 0020h	 
size_usr_dir . . . . . . . . . .	Number	 0020h	 
smod . . . . . . . . . . . . . .	L Near	 262B	  RUFS_INSTL	
str_err  . . . . . . . . . . . .	L Near	 2AAB	  RUFS_INSTL	
str_volume_name  . . . . . . . .	L Near	 2AB2	  RUFS_INSTL	
sync_0 . . . . . . . . . . . . .	L Near	 078E	  RUFS_INSTL	
sync_10  . . . . . . . . . . . .	L Near	 08A4	  RUFS_INSTL	
sync_11  . . . . . . . . . . . .	L Near	 08AE	  RUFS_INSTL	
sync_12  . . . . . . . . . . . .	L Near	 08C5	  RUFS_INSTL	
sync_13  . . . . . . . . . . . .	L Near	 08D0	  RUFS_INSTL	
sync_14  . . . . . . . . . . . .	L Near	 08E9	  RUFS_INSTL	
sync_15  . . . . . . . . . . . .	L Near	 08F3	  RUFS_INSTL	
sync_16  . . . . . . . . . . . .	L Near	 0902	  RUFS_INSTL	
sync_17  . . . . . . . . . . . .	L Near	 091A	  RUFS_INSTL	
sync_18  . . . . . . . . . . . .	L Near	 080B	  RUFS_INSTL	
sync_19  . . . . . . . . . . . .	L Near	 0837	  RUFS_INSTL	
sync_1 . . . . . . . . . . . . .	L Near	 07E1	  RUFS_INSTL	
sync_20  . . . . . . . . . . . .	L Near	 08BE	  RUFS_INSTL	
sync_2 . . . . . . . . . . . . .	L Near	 07F0	  RUFS_INSTL	
sync_3 . . . . . . . . . . . . .	L Near	 07F5	  RUFS_INSTL	
sync_4 . . . . . . . . . . . . .	L Near	 07FA	  RUFS_INSTL	
sync_5 . . . . . . . . . . . . .	L Near	 080F	  RUFS_INSTL	
sync_6 . . . . . . . . . . . . .	L Near	 0822	  RUFS_INSTL	
sync_7 . . . . . . . . . . . . .	L Near	 0828	  RUFS_INSTL	
sync_8 . . . . . . . . . . . . .	L Near	 0890	  RUFS_INSTL	
sync_9 . . . . . . . . . . . . .	L Near	 089F	  RUFS_INSTL	
systm  . . . . . . . . . . . . .	L Near	 0A10	  RUFS_INSTL	
terminate  . . . . . . . . . . .	L Near	 023A	  RUFS_INSTL	
tmp_dir  . . . . . . . . . . . .	L Near	 0E60	  RUFS_INSTL	
tmp_inode  . . . . . . . . . . .	L Near	 103A	  RUFS_INSTL	
total_sectors  . . . . . . . . .	L Near	 2ACC	  RUFS_INSTL	
tty0_inode . . . . . . . . . . .	L Near	 12FA	  RUFS_INSTL	
tty1_inode . . . . . . . . . . .	L Near	 133A	  RUFS_INSTL	
tty2_inode . . . . . . . . . . .	L Near	 137A	  RUFS_INSTL	
tty3_inode . . . . . . . . . . .	L Near	 13BA	  RUFS_INSTL	
tty4_inode . . . . . . . . . . .	L Near	 13FA	  RUFS_INSTL	
tty5_inode . . . . . . . . . . .	L Near	 143A	  RUFS_INSTL	
tty6_inode . . . . . . . . . . .	L Near	 147A	  RUFS_INSTL	
tty7_inode . . . . . . . . . . .	L Near	 14BA	  RUFS_INSTL	
tty_inode  . . . . . . . . . . .	L Near	 10BA	  RUFS_INSTL	
u_base . . . . . . . . . . . . .	L Near	 0EA6	  RUFS_INSTL	
u_count  . . . . . . . . . . . .	L Near	 0EA4	  RUFS_INSTL	
u_fofp . . . . . . . . . . . . .	L Near	 0EA8	  RUFS_INSTL	
u_nread  . . . . . . . . . . . .	L Near	 0EAA	  RUFS_INSTL	
u_off  . . . . . . . . . . . . .	L Near	 0EA0	  RUFS_INSTL	
ufsi_10  . . . . . . . . . . . .	L Near	 0743	  RUFS_INSTL	
ufsi_11  . . . . . . . . . . . .	L Near	 0766	  RUFS_INSTL	
ufsi_14  . . . . . . . . . . . .	L Near	 0737	  RUFS_INSTL	
ufsi_15  . . . . . . . . . . . .	L Near	 0676	  RUFS_INSTL	
ufsi_16  . . . . . . . . . . . .	L Near	 0685	  RUFS_INSTL	
ufsi_17  . . . . . . . . . . . .	L Near	 0691	  RUFS_INSTL	
ufsi_18  . . . . . . . . . . . .	L Near	 069A	  RUFS_INSTL	
ufsi_1 . . . . . . . . . . . . .	L Near	 05FB	  RUFS_INSTL	
ufsi_2 . . . . . . . . . . . . .	L Near	 069B	  RUFS_INSTL	
ufsi_3 . . . . . . . . . . . . .	L Near	 06B2	  RUFS_INSTL	
ufsi_4 . . . . . . . . . . . . .	L Near	 06C7	  RUFS_INSTL	
ufsi_5 . . . . . . . . . . . . .	L Near	 06E7	  RUFS_INSTL	
ufsi_6 . . . . . . . . . . . . .	L Near	 070E	  RUFS_INSTL	
ufsi_7 . . . . . . . . . . . . .	L Near	 0722	  RUFS_INSTL	
ufsi_8 . . . . . . . . . . . . .	L Near	 0736	  RUFS_INSTL	
ufsi_9 . . . . . . . . . . . . .	L Near	 0737	  RUFS_INSTL	
unused_inodes  . . . . . . . . .	L Near	 157A	  RUFS_INSTL	
usr_dir  . . . . . . . . . . . .	L Near	 0E40	  RUFS_INSTL	
usr_inode  . . . . . . . . . . .	L Near	 0FFA	  RUFS_INSTL	
valid_hd_image . . . . . . . . .	L Near	 0304	  RUFS_INSTL	
valid_masterboot . . . . . . . .	L Near	 0335	  RUFS_INSTL	
write_1  . . . . . . . . . . . .	L Near	 1F87	  RUFS_INSTL	
year . . . . . . . . . . . . . .	L Near	 2604	  RUFS_INSTL	

	   0 Warnings
	   0 Errors
